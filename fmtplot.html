<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="lehmann7" />
  <meta name="dcterms.date" content="2021-09-07" />
  <title>fmtplot: Format Code for Plots in pdf and html Output</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 11pt;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuOC4zCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiBUdWUgTm92IDEzIDIwMTIgMDg6MjA6MzMgR01ULTA1MDAgKEVhc3Rlcm4gU3RhbmRhcmQgVGltZSkKICovCi8qIGVzbGludC1kaXNhYmxlICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7CnZhcgoJLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCglyb290alF1ZXJ5LAoKCS8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQoJcmVhZHlMaXN0LAoKCS8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKCWRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50LAoJbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgluYXZpZ2F0b3IgPSB3aW5kb3cubmF2aWdhdG9yLAoKCS8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgoJLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV8kID0gd2luZG93LiQsCgoJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byBzb21lIGNvcmUgbWV0aG9kcwoJY29yZV9wdXNoID0gQXJyYXkucHJvdG90eXBlLnB1c2gsCgljb3JlX3NsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJY29yZV9pbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YsCgljb3JlX3RvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKCWNvcmVfaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKCWNvcmVfdHJpbSA9IFN0cmluZy5wcm90b3R5cGUudHJpbSwKCgkvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0LCByb290alF1ZXJ5ICk7Cgl9LAoKCS8vIFVzZWQgZm9yIG1hdGNoaW5nIG51bWJlcnMKCWNvcmVfcG51bSA9IC9bXC0rXT8oPzpcZCpcLnwpXGQrKD86W2VFXVtcLStdP1xkK3wpLy5zb3VyY2UsCgoJLy8gVXNlZCBmb3IgZGV0ZWN0aW5nIGFuZCB0cmltbWluZyB3aGl0ZXNwYWNlCgljb3JlX3Jub3R3aGl0ZSA9IC9cUy8sCgljb3JlX3JzcGFjZSA9IC9ccysvLAoKCS8vIE1ha2Ugc3VyZSB3ZSB0cmltIEJPTSBhbmQgTkJTUCAoaGVyZSdzIGxvb2tpbmcgYXQgeW91LCBTYWZhcmkgNS4wIGFuZCBJRSkKCXJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAoKCS8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzCgkvLyBQcmlvcml0aXplICNpZCBvdmVyIDx0YWc+IHRvIGF2b2lkIFhTUyB2aWEgbG9jYXRpb24uaGFzaCAoIzk1MjEpCglycXVpY2tFeHByID0gL14oPzpbXiM8XSooPFtcd1xXXSs+KVtePl0qJHwjKFtcd1wtXSopJCkvLAoKCS8vIE1hdGNoIGEgc3RhbmRhbG9uZSB0YWcKCXJzaW5nbGVUYWcgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvLAoKCS8vIEpTT04gUmVnRXhwCglydmFsaWRjaGFycyA9IC9eW1xdLDp7fVxzXSokLywKCXJ2YWxpZGJyYWNlcyA9IC8oPzpefDp8LCkoPzpccypcWykrL2csCglydmFsaWRlc2NhcGUgPSAvXFwoPzpbIlxcXC9iZm5ydF18dVtcZGEtZkEtRl17NH0pL2csCglydmFsaWR0b2tlbnMgPSAvIlteIlxcXHJcbl0qInx0cnVlfGZhbHNlfG51bGx8LT8oPzpcZFxkKlwufClcZCsoPzpbZUVdW1wtK10/XGQrfCkvZywKCgkvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKCXJtc1ByZWZpeCA9IC9eLW1zLS8sCglyZGFzaEFscGhhID0gLy0oW1xkYS16XSkvZ2ksCgoJLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQoJZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uKCBhbGwsIGxldHRlciApIHsKCQlyZXR1cm4gKCBsZXR0ZXIgKyAiIiApLnRvVXBwZXJDYXNlKCk7Cgl9LAoKCS8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCglET01Db250ZW50TG9hZGVkID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICkgewoJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgkJCWpRdWVyeS5yZWFkeSgpOwoJCX0gZWxzZSBpZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7CgkJCS8vIHdlJ3JlIGhlcmUgYmVjYXVzZSByZWFkeVN0YXRlID09PSAiY29tcGxldGUiIGluIG9sZElFCgkJCS8vIHdoaWNoIGlzIGdvb2QgZW5vdWdoIGZvciB1cyB0byBjYWxsIHRoZSBkb20gcmVhZHkhCgkJCWRvY3VtZW50LmRldGFjaEV2ZW50KCAib25yZWFkeXN0YXRlY2hhbmdlIiwgRE9NQ29udGVudExvYWRlZCApOwoJCQlqUXVlcnkucmVhZHkoKTsKCQl9Cgl9LAoKCS8vIFtbQ2xhc3NdXSAtPiB0eXBlIHBhaXJzCgljbGFzczJ0eXBlID0ge307CgpqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IGpRdWVyeSwKCWluaXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApIHsKCQl2YXIgbWF0Y2gsIGVsZW0sIHJldCwgZG9jOwoKCQkvLyBIYW5kbGUgJCgiIiksICQobnVsbCksICQodW5kZWZpbmVkKSwgJChmYWxzZSkKCQlpZiAoICFzZWxlY3RvciApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBIYW5kbGUgJChET01FbGVtZW50KQoJCWlmICggc2VsZWN0b3Iubm9kZVR5cGUgKSB7CgkJCXRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKCQkJdGhpcy5sZW5ndGggPSAxOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKCQlpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCWlmICggc2VsZWN0b3IuY2hhckF0KDApID09PSAiPCIgJiYgc2VsZWN0b3IuY2hhckF0KCBzZWxlY3Rvci5sZW5ndGggLSAxICkgPT09ICI+IiAmJiBzZWxlY3Rvci5sZW5ndGggPj0gMyApIHsKCQkJCS8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrCgkJCQltYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCgkJCX0gZWxzZSB7CgkJCQltYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKTsKCQkJfQoKCQkJLy8gTWF0Y2ggaHRtbCBvciBtYWtlIHN1cmUgbm8gY29udGV4dCBpcyBzcGVjaWZpZWQgZm9yICNpZAoJCQlpZiAoIG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkgKSB7CgoJCQkJLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCgkJCQlpZiAoIG1hdGNoWzFdICkgewoJCQkJCWNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7CgkJCQkJZG9jID0gKCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IGRvY3VtZW50ICk7CgoJCQkJCS8vIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQKCQkJCQlzZWxlY3RvciA9IGpRdWVyeS5wYXJzZUhUTUwoIG1hdGNoWzFdLCBkb2MsIHRydWUgKTsKCQkJCQlpZiAoIHJzaW5nbGVUYWcudGVzdCggbWF0Y2hbMV0gKSAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdCggY29udGV4dCApICkgewoJCQkJCQl0aGlzLmF0dHIuY2FsbCggc2VsZWN0b3IsIGNvbnRleHQsIHRydWUgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBqUXVlcnkubWVyZ2UoIHRoaXMsIHNlbGVjdG9yICk7CgoJCQkJLy8gSEFORExFOiAkKCNpZCkKCQkJCX0gZWxzZSB7CgkJCQkJZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUgYW5kIE9wZXJhIHJldHVybiBpdGVtcwoJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJaWYgKCBlbGVtLmlkICE9PSBtYXRjaFsyXSApIHsKCQkJCQkJCXJldHVybiByb290alF1ZXJ5LmZpbmQoIHNlbGVjdG9yICk7CgkJCQkJCX0KCgkJCQkJCS8vIE90aGVyd2lzZSwgd2UgaW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QKCQkJCQkJdGhpcy5sZW5ndGggPSAxOwoJCQkJCQl0aGlzWzBdID0gZWxlbTsKCQkJCQl9CgoJCQkJCXRoaXMuY29udGV4dCA9IGRvY3VtZW50OwoJCQkJCXRoaXMuc2VsZWN0b3IgPSBzZWxlY3RvcjsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCgkJCS8vIEhBTkRMRTogJChleHByLCAkKC4uLikpCgkJCX0gZWxzZSBpZiAoICFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5ICkgewoJCQkJcmV0dXJuICggY29udGV4dCB8fCByb290alF1ZXJ5ICkuZmluZCggc2VsZWN0b3IgKTsKCgkJCS8vIEhBTkRMRTogJChleHByLCBjb250ZXh0KQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKCQkJfSBlbHNlIHsKCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKTsKCQkJfQoKCQkvLyBIQU5ETEU6ICQoZnVuY3Rpb24pCgkJLy8gU2hvcnRjdXQgZm9yIGRvY3VtZW50IHJlYWR5CgkJfSBlbHNlIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHNlbGVjdG9yICkgKSB7CgkJCXJldHVybiByb290alF1ZXJ5LnJlYWR5KCBzZWxlY3RvciApOwoJCX0KCgkJaWYgKCBzZWxlY3Rvci5zZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CgkJCXRoaXMuY29udGV4dCA9IHNlbGVjdG9yLmNvbnRleHQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IsIHRoaXMgKTsKCX0sCgoJLy8gU3RhcnQgd2l0aCBhbiBlbXB0eSBzZWxlY3RvcgoJc2VsZWN0b3I6ICIiLAoKCS8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKCWpxdWVyeTogIjEuOC4zIiwKCgkvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKCWxlbmd0aDogMCwKCgkvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAoJc2l6ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubGVuZ3RoOwoJfSwKCgl0b0FycmF5OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gY29yZV9zbGljZS5jYWxsKCB0aGlzICk7Cgl9LAoKCS8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKCS8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7CgkJcmV0dXJuIG51bSA9PSBudWxsID8KCgkJCS8vIFJldHVybiBhICdjbGVhbicgYXJyYXkKCQkJdGhpcy50b0FycmF5KCkgOgoKCQkJLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdAoJCQkoIG51bSA8IDAgPyB0aGlzWyB0aGlzLmxlbmd0aCArIG51bSBdIDogdGhpc1sgbnVtIF0gKTsKCX0sCgoJLy8gVGFrZSBhbiBhcnJheSBvZiBlbGVtZW50cyBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGFjawoJLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCglwdXNoU3RhY2s6IGZ1bmN0aW9uKCBlbGVtcywgbmFtZSwgc2VsZWN0b3IgKSB7CgoJCS8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CgkJdmFyIHJldCA9IGpRdWVyeS5tZXJnZSggdGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCgkJcmV0LmNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CgoJCWlmICggbmFtZSA9PT0gImZpbmQiICkgewoJCQlyZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yICsgKCB0aGlzLnNlbGVjdG9yID8gIiAiIDogIiIgKSArIHNlbGVjdG9yOwoJCX0gZWxzZSBpZiAoIG5hbWUgKSB7CgkJCXJldC5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgKyAiLiIgKyBuYW1lICsgIigiICsgc2VsZWN0b3IgKyAiKSI7CgkJfQoKCQkvLyBSZXR1cm4gdGhlIG5ld2x5LWZvcm1lZCBlbGVtZW50IHNldAoJCXJldHVybiByZXQ7Cgl9LAoKCS8vIEV4ZWN1dGUgYSBjYWxsYmFjayBmb3IgZXZlcnkgZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBzZXQuCgkvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwoJLy8gb25seSB1c2VkIGludGVybmFsbHkuKQoJZWFjaDogZnVuY3Rpb24oIGNhbGxiYWNrLCBhcmdzICkgewoJCXJldHVybiBqUXVlcnkuZWFjaCggdGhpcywgY2FsbGJhY2ssIGFyZ3MgKTsKCX0sCgoJcmVhZHk6IGZ1bmN0aW9uKCBmbiApIHsKCQkvLyBBZGQgdGhlIGNhbGxiYWNrCgkJalF1ZXJ5LnJlYWR5LnByb21pc2UoKS5kb25lKCBmbiApOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCWkgPSAraTsKCQlyZXR1cm4gaSA9PT0gLTEgPwoJCQl0aGlzLnNsaWNlKCBpICkgOgoJCQl0aGlzLnNsaWNlKCBpLCBpICsgMSApOwoJfSwKCglmaXJzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsKCX0sCgoJbGFzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGNvcmVfc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLAoJCQkic2xpY2UiLCBjb3JlX3NsaWNlLmNhbGwoYXJndW1lbnRzKS5qb2luKCIsIikgKTsKCX0sCgoJbWFwOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubWFwKHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQlyZXR1cm4gY2FsbGJhY2suY2FsbCggZWxlbSwgaSwgZWxlbSApOwoJCX0pKTsKCX0sCgoJZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IHRoaXMuY29uc3RydWN0b3IobnVsbCk7Cgl9LAoKCS8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KCS8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLgoJcHVzaDogY29yZV9wdXNoLAoJc29ydDogW10uc29ydCwKCXNwbGljZTogW10uc3BsaWNlCn07CgovLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uCmpRdWVyeS5mbi5pbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7Cgl2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCgkJdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAoJCWkgPSAxLAoJCWxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCgkJZGVlcCA9IGZhbHNlOwoKCS8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KCWlmICggdHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iICkgewoJCWRlZXAgPSB0YXJnZXQ7CgkJdGFyZ2V0ID0gYXJndW1lbnRzWzFdIHx8IHt9OwoJCS8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKCQlpID0gMjsKCX0KCgkvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKCWlmICggdHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKHRhcmdldCkgKSB7CgkJdGFyZ2V0ID0ge307Cgl9CgoJLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCglpZiAoIGxlbmd0aCA9PT0gaSApIHsKCQl0YXJnZXQgPSB0aGlzOwoJCS0taTsKCX0KCglmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCgkJaWYgKCAob3B0aW9ucyA9IGFyZ3VtZW50c1sgaSBdKSAhPSBudWxsICkgewoJCQkvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CgkJCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKCQkJCXNyYyA9IHRhcmdldFsgbmFtZSBdOwoJCQkJY29weSA9IG9wdGlvbnNbIG5hbWUgXTsKCgkJCQkvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCgkJCQlpZiAoIHRhcmdldCA9PT0gY29weSApIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQkvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKCQkJCWlmICggZGVlcCAmJiBjb3B5ICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpICkgKSB7CgkJCQkJaWYgKCBjb3B5SXNBcnJheSApIHsKCQkJCQkJY29weUlzQXJyYXkgPSBmYWxzZTsKCQkJCQkJY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzQXJyYXkoc3JjKSA/IHNyYyA6IFtdOwoKCQkJCQl9IGVsc2UgewoJCQkJCQljbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpID8gc3JjIDoge307CgkJCQkJfQoKCQkJCQkvLyBOZXZlciBtb3ZlIG9yaWdpbmFsIG9iamVjdHMsIGNsb25lIHRoZW0KCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGRlZXAsIGNsb25lLCBjb3B5ICk7CgoJCQkJLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwoJCQkJfSBlbHNlIGlmICggY29weSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRhcmdldFsgbmFtZSBdID0gY29weTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAoJcmV0dXJuIHRhcmdldDsKfTsKCmpRdWVyeS5leHRlbmQoewoJbm9Db25mbGljdDogZnVuY3Rpb24oIGRlZXAgKSB7CgkJaWYgKCB3aW5kb3cuJCA9PT0galF1ZXJ5ICkgewoJCQl3aW5kb3cuJCA9IF8kOwoJCX0KCgkJaWYgKCBkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSApIHsKCQkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CgkJfQoKCQlyZXR1cm4galF1ZXJ5OwoJfSwKCgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgoJaXNSZWFkeTogZmFsc2UsCgoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKCXJlYWR5V2FpdDogMSwKCgkvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKCWhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CgkJaWYgKCBob2xkICkgewoJCQlqUXVlcnkucmVhZHlXYWl0Kys7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7CgkJfQoJfSwKCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CglyZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKCQlpZiAoIHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gTWFrZSBzdXJlIGJvZHkgZXhpc3RzLCBhdCBsZWFzdCwgaW4gY2FzZSBJRSBnZXRzIGEgbGl0dGxlIG92ZXJ6ZWFsb3VzICh0aWNrZXQgIzU0NDMpLgoJCWlmICggIWRvY3VtZW50LmJvZHkgKSB7CgkJCXJldHVybiBzZXRUaW1lb3V0KCBqUXVlcnkucmVhZHksIDEgKTsKCQl9CgoJCS8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQoJCWpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsKCgkJLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKCQlpZiAoIHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQoJCXJlYWR5TGlzdC5yZXNvbHZlV2l0aCggZG9jdW1lbnQsIFsgalF1ZXJ5IF0gKTsKCgkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCgkJaWYgKCBqUXVlcnkuZm4udHJpZ2dlciApIHsKCQkJalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXIoInJlYWR5Iikub2ZmKCJyZWFkeSIpOwoJCX0KCX0sCgoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4KCS8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKCS8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCglpc0Z1bmN0aW9uOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiZnVuY3Rpb24iOwoJfSwKCglpc0FycmF5OiBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICJhcnJheSI7Cgl9LAoKCWlzV2luZG93OiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT0gb2JqLndpbmRvdzsKCX0sCgoJaXNOdW1lcmljOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiAhaXNOYU4oIHBhcnNlRmxvYXQob2JqKSApICYmIGlzRmluaXRlKCBvYmogKTsKCX0sCgoJdHlwZTogZnVuY3Rpb24oIG9iaiApIHsKCQlyZXR1cm4gb2JqID09IG51bGwgPwoJCQlTdHJpbmcoIG9iaiApIDoKCQkJY2xhc3MydHlwZVsgY29yZV90b1N0cmluZy5jYWxsKG9iaikgXSB8fCAib2JqZWN0IjsKCX0sCgoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQkvLyBNdXN0IGJlIGFuIE9iamVjdC4KCQkvLyBCZWNhdXNlIG9mIElFLCB3ZSBhbHNvIGhhdmUgdG8gY2hlY2sgdGhlIHByZXNlbmNlIG9mIHRoZSBjb25zdHJ1Y3RvciBwcm9wZXJ0eS4KCQkvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbAoJCWlmICggIW9iaiB8fCBqUXVlcnkudHlwZShvYmopICE9PSAib2JqZWN0IiB8fCBvYmoubm9kZVR5cGUgfHwgalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdHJ5IHsKCQkJLy8gTm90IG93biBjb25zdHJ1Y3RvciBwcm9wZXJ0eSBtdXN0IGJlIE9iamVjdAoJCQlpZiAoIG9iai5jb25zdHJ1Y3RvciAmJgoJCQkJIWNvcmVfaGFzT3duLmNhbGwob2JqLCAiY29uc3RydWN0b3IiKSAmJgoJCQkJIWNvcmVfaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gY2F0Y2ggKCBlICkgewoJCQkvLyBJRTgsOSBXaWxsIHRocm93IGV4Y2VwdGlvbnMgb24gY2VydGFpbiBob3N0IG9iamVjdHMgIzk4OTcKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gT3duIHByb3BlcnRpZXMgYXJlIGVudW1lcmF0ZWQgZmlyc3RseSwgc28gdG8gc3BlZWQgdXAsCgkJLy8gaWYgbGFzdCBvbmUgaXMgb3duLCB0aGVuIGFsbCBwcm9wZXJ0aWVzIGFyZSBvd24uCgoJCXZhciBrZXk7CgkJZm9yICgga2V5IGluIG9iaiApIHt9CgoJCXJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBjb3JlX2hhc093bi5jYWxsKCBvYmosIGtleSApOwoJfSwKCglpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiggb2JqICkgewoJCXZhciBuYW1lOwoJCWZvciAoIG5hbWUgaW4gb2JqICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCgllcnJvcjogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyBuZXcgRXJyb3IoIG1zZyApOwoJfSwKCgkvLyBkYXRhOiBzdHJpbmcgb2YgaHRtbAoJLy8gY29udGV4dCAob3B0aW9uYWwpOiBJZiBzcGVjaWZpZWQsIHRoZSBmcmFnbWVudCB3aWxsIGJlIGNyZWF0ZWQgaW4gdGhpcyBjb250ZXh0LCBkZWZhdWx0cyB0byBkb2N1bWVudAoJLy8gc2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nCglwYXJzZUhUTUw6IGZ1bmN0aW9uKCBkYXRhLCBjb250ZXh0LCBzY3JpcHRzICkgewoJCXZhciBwYXJzZWQ7CgkJaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCQlpZiAoIHR5cGVvZiBjb250ZXh0ID09PSAiYm9vbGVhbiIgKSB7CgkJCXNjcmlwdHMgPSBjb250ZXh0OwoJCQljb250ZXh0ID0gMDsKCQl9CgkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJCS8vIFNpbmdsZSB0YWcKCQlpZiAoIChwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKSkgKSB7CgkJCXJldHVybiBbIGNvbnRleHQuY3JlYXRlRWxlbWVudCggcGFyc2VkWzFdICkgXTsKCQl9CgoJCXBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBbIGRhdGEgXSwgY29udGV4dCwgc2NyaXB0cyA/IG51bGwgOiBbXSApOwoJCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLAoJCQkocGFyc2VkLmNhY2hlYWJsZSA/IGpRdWVyeS5jbG9uZSggcGFyc2VkLmZyYWdtZW50ICkgOiBwYXJzZWQuZnJhZ21lbnQpLmNoaWxkTm9kZXMgKTsKCX0sCgoJcGFyc2VKU09OOiBmdW5jdGlvbiggZGF0YSApIHsKCQlpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCS8vIE1ha2Ugc3VyZSBsZWFkaW5nL3RyYWlsaW5nIHdoaXRlc3BhY2UgaXMgcmVtb3ZlZCAoSUUgY2FuJ3QgaGFuZGxlIGl0KQoJCWRhdGEgPSBqUXVlcnkudHJpbSggZGF0YSApOwoKCQkvLyBBdHRlbXB0IHRvIHBhcnNlIHVzaW5nIHRoZSBuYXRpdmUgSlNPTiBwYXJzZXIgZmlyc3QKCQlpZiAoIHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlICkgewoJCQlyZXR1cm4gd2luZG93LkpTT04ucGFyc2UoIGRhdGEgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGUgaW5jb21pbmcgZGF0YSBpcyBhY3R1YWwgSlNPTgoJCS8vIExvZ2ljIGJvcnJvd2VkIGZyb20gaHR0cDovL2pzb24ub3JnL2pzb24yLmpzCgkJaWYgKCBydmFsaWRjaGFycy50ZXN0KCBkYXRhLnJlcGxhY2UoIHJ2YWxpZGVzY2FwZSwgIkAiICkKCQkJLnJlcGxhY2UoIHJ2YWxpZHRva2VucywgIl0iICkKCQkJLnJlcGxhY2UoIHJ2YWxpZGJyYWNlcywgIiIpKSApIHsKCgkJCXJldHVybiAoIG5ldyBGdW5jdGlvbiggInJldHVybiAiICsgZGF0YSApICkoKTsKCgkJfQoJCWpRdWVyeS5lcnJvciggIkludmFsaWQgSlNPTjogIiArIGRhdGEgKTsKCX0sCgoJLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwoJcGFyc2VYTUw6IGZ1bmN0aW9uKCBkYXRhICkgewoJCXZhciB4bWwsIHRtcDsKCQlpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCXRyeSB7CgkJCWlmICggd2luZG93LkRPTVBhcnNlciApIHsgLy8gU3RhbmRhcmQKCQkJCXRtcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJCXhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoIGRhdGEgLCAidGV4dC94bWwiICk7CgkJCX0gZWxzZSB7IC8vIElFCgkJCQl4bWwgPSBuZXcgQWN0aXZlWE9iamVjdCggIk1pY3Jvc29mdC5YTUxET00iICk7CgkJCQl4bWwuYXN5bmMgPSAiZmFsc2UiOwoJCQkJeG1sLmxvYWRYTUwoIGRhdGEgKTsKCQkJfQoJCX0gY2F0Y2goIGUgKSB7CgkJCXhtbCA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCAheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSggInBhcnNlcmVycm9yIiApLmxlbmd0aCApIHsKCQkJalF1ZXJ5LmVycm9yKCAiSW52YWxpZCBYTUw6ICIgKyBkYXRhICk7CgkJfQoJCXJldHVybiB4bWw7Cgl9LAoKCW5vb3A6IGZ1bmN0aW9uKCkge30sCgoJLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKCS8vIFdvcmthcm91bmRzIGJhc2VkIG9uIGZpbmRpbmdzIGJ5IEppbSBEcmlzY29sbAoJLy8gaHR0cDovL3dlYmxvZ3MuamF2YS5uZXQvYmxvZy9kcmlzY29sbC9hcmNoaXZlLzIwMDkvMDkvMDgvZXZhbC1qYXZhc2NyaXB0LWdsb2JhbC1jb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggZGF0YSApIHsKCQlpZiAoIGRhdGEgJiYgY29yZV9ybm90d2hpdGUudGVzdCggZGF0YSApICkgewoJCQkvLyBXZSB1c2UgZXhlY1NjcmlwdCBvbiBJbnRlcm5ldCBFeHBsb3JlcgoJCQkvLyBXZSB1c2UgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgY29udGV4dCBpcyB3aW5kb3cKCQkJLy8gcmF0aGVyIHRoYW4galF1ZXJ5IGluIEZpcmVmb3gKCQkJKCB3aW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbiggZGF0YSApIHsKCQkJCXdpbmRvd1sgImV2YWwiIF0uY2FsbCggd2luZG93LCBkYXRhICk7CgkJCX0gKSggZGF0YSApOwoJCX0KCX0sCgoJLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwoJLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQoJY2FtZWxDYXNlOiBmdW5jdGlvbiggc3RyaW5nICkgewoJCXJldHVybiBzdHJpbmcucmVwbGFjZSggcm1zUHJlZml4LCAibXMtIiApLnJlcGxhY2UoIHJkYXNoQWxwaGEsIGZjYW1lbENhc2UgKTsKCX0sCgoJbm9kZU5hbWU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJfSwKCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgllYWNoOiBmdW5jdGlvbiggb2JqLCBjYWxsYmFjaywgYXJncyApIHsKCQl2YXIgbmFtZSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IG9iai5sZW5ndGgsCgkJCWlzT2JqID0gbGVuZ3RoID09PSB1bmRlZmluZWQgfHwgalF1ZXJ5LmlzRnVuY3Rpb24oIG9iaiApOwoKCQlpZiAoIGFyZ3MgKSB7CgkJCWlmICggaXNPYmogKSB7CgkJCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmpbIG5hbWUgXSwgYXJncyApID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyApIHsKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkrKyBdLCBhcmdzICkgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJLy8gQSBzcGVjaWFsLCBmYXN0LCBjYXNlIGZvciB0aGUgbW9zdCBjb21tb24gdXNlIG9mIGVhY2gKCQl9IGVsc2UgewoJCQlpZiAoIGlzT2JqICkgewoJCQkJZm9yICggbmFtZSBpbiBvYmogKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5jYWxsKCBvYmpbIG5hbWUgXSwgbmFtZSwgb2JqWyBuYW1lIF0gKSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpKysgXSApID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvLyBVc2UgbmF0aXZlIFN0cmluZy50cmltIGZ1bmN0aW9uIHdoZXJldmVyIHBvc3NpYmxlCgl0cmltOiBjb3JlX3RyaW0gJiYgIWNvcmVfdHJpbS5jYWxsKCJcdUZFRkZceEEwIikgPwoJCWZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlyZXR1cm4gdGV4dCA9PSBudWxsID8KCQkJCSIiIDoKCQkJCWNvcmVfdHJpbS5jYWxsKCB0ZXh0ICk7CgkJfSA6CgoJCS8vIE90aGVyd2lzZSB1c2Ugb3VyIG93biB0cmltbWluZyBmdW5jdGlvbmFsaXR5CgkJZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0ZXh0ID09IG51bGwgPwoJCQkJIiIgOgoJCQkJKCB0ZXh0ICsgIiIgKS5yZXBsYWNlKCBydHJpbSwgIiIgKTsKCQl9LAoKCS8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1ha2VBcnJheTogZnVuY3Rpb24oIGFyciwgcmVzdWx0cyApIHsKCQl2YXIgdHlwZSwKCQkJcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnIgIT0gbnVsbCApIHsKCQkJLy8gVGhlIHdpbmRvdywgc3RyaW5ncyAoYW5kIGZ1bmN0aW9ucykgYWxzbyBoYXZlICdsZW5ndGgnCgkJCS8vIFR3ZWFrZWQgbG9naWMgc2xpZ2h0bHkgdG8gaGFuZGxlIEJsYWNrYmVycnkgNC43IFJlZ0V4cCBpc3N1ZXMgIzY5MzAKCQkJdHlwZSA9IGpRdWVyeS50eXBlKCBhcnIgKTsKCgkJCWlmICggYXJyLmxlbmd0aCA9PSBudWxsIHx8IHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZSA9PT0gInJlZ2V4cCIgfHwgalF1ZXJ5LmlzV2luZG93KCBhcnIgKSApIHsKCQkJCWNvcmVfcHVzaC5jYWxsKCByZXQsIGFyciApOwoJCQl9IGVsc2UgewoJCQkJalF1ZXJ5Lm1lcmdlKCByZXQsIGFyciApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgewoJCXZhciBsZW47CgoJCWlmICggYXJyICkgewoJCQlpZiAoIGNvcmVfaW5kZXhPZiApIHsKCQkJCXJldHVybiBjb3JlX2luZGV4T2YuY2FsbCggYXJyLCBlbGVtLCBpICk7CgkJCX0KCgkJCWxlbiA9IGFyci5sZW5ndGg7CgkJCWkgPSBpID8gaSA8IDAgPyBNYXRoLm1heCggMCwgbGVuICsgaSApIDogaSA6IDA7CgoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCS8vIFNraXAgYWNjZXNzaW5nIGluIHNwYXJzZSBhcnJheXMKCQkJCWlmICggaSBpbiBhcnIgJiYgYXJyWyBpIF0gPT09IGVsZW0gKSB7CgkJCQkJcmV0dXJuIGk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0sCgoJbWVyZ2U6IGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgewoJCXZhciBsID0gc2Vjb25kLmxlbmd0aCwKCQkJaSA9IGZpcnN0Lmxlbmd0aCwKCQkJaiA9IDA7CgoJCWlmICggdHlwZW9mIGwgPT09ICJudW1iZXIiICkgewoJCQlmb3IgKCA7IGogPCBsOyBqKysgKSB7CgkJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKCQkJfQoKCQl9IGVsc2UgewoJCQl3aGlsZSAoIHNlY29uZFtqXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqKysgXTsKCQkJfQoJCX0KCgkJZmlyc3QubGVuZ3RoID0gaTsKCgkJcmV0dXJuIGZpcnN0OwoJfSwKCglncmVwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBpbnYgKSB7CgkJdmFyIHJldFZhbCwKCQkJcmV0ID0gW10sCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGg7CgkJaW52ID0gISFpbnY7CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMKCQkvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgoJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQlyZXRWYWwgPSAhIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7CgkJCWlmICggaW52ICE9PSByZXRWYWwgKSB7CgkJCQlyZXQucHVzaCggZWxlbXNbIGkgXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1hcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgYXJnICkgewoJCXZhciB2YWx1ZSwga2V5LAoJCQlyZXQgPSBbXSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJLy8ganF1ZXJ5IG9iamVjdHMgYXJlIHRyZWF0ZWQgYXMgYXJyYXlzCgkJCWlzQXJyYXkgPSBlbGVtcyBpbnN0YW5jZW9mIGpRdWVyeSB8fCBsZW5ndGggIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiAoICggbGVuZ3RoID4gMCAmJiBlbGVtc1sgMCBdICYmIGVsZW1zWyBsZW5ndGggLTEgXSApIHx8IGxlbmd0aCA9PT0gMCB8fCBqUXVlcnkuaXNBcnJheSggZWxlbXMgKSApIDsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyCgkJaWYgKCBpc0FycmF5ICkgewoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgoJCS8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsCgkJfSBlbHNlIHsKCQkJZm9yICgga2V5IGluIGVsZW1zICkgewoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGtleSBdLCBrZXksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJcmV0dXJuIHJldC5jb25jYXQuYXBwbHkoIFtdLCByZXQgKTsKCX0sCgoJLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCglndWlkOiAxLAoKCS8vIEJpbmQgYSBmdW5jdGlvbiB0byBhIGNvbnRleHQsIG9wdGlvbmFsbHkgcGFydGlhbGx5IGFwcGx5aW5nIGFueQoJLy8gYXJndW1lbnRzLgoJcHJveHk6IGZ1bmN0aW9uKCBmbiwgY29udGV4dCApIHsKCQl2YXIgdG1wLCBhcmdzLCBwcm94eTsKCgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gInN0cmluZyIgKSB7CgkJCXRtcCA9IGZuWyBjb250ZXh0IF07CgkJCWNvbnRleHQgPSBmbjsKCQkJZm4gPSB0bXA7CgkJfQoKCQkvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYwoJCS8vIHRoaXMgdGhyb3dzIGEgVHlwZUVycm9yLCBidXQgd2Ugd2lsbCBqdXN0IHJldHVybiB1bmRlZmluZWQuCgkJaWYgKCAhalF1ZXJ5LmlzRnVuY3Rpb24oIGZuICkgKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoKCQkvLyBTaW11bGF0ZWQgYmluZAoJCWFyZ3MgPSBjb3JlX3NsaWNlLmNhbGwoIGFyZ3VtZW50cywgMiApOwoJCXByb3h5ID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBmbi5hcHBseSggY29udGV4dCwgYXJncy5jb25jYXQoIGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX07CgoJCS8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAoJCXByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwoKCQlyZXR1cm4gcHJveHk7Cgl9LAoKCS8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbgoJLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCglhY2Nlc3M6IGZ1bmN0aW9uKCBlbGVtcywgZm4sIGtleSwgdmFsdWUsIGNoYWluYWJsZSwgZW1wdHlHZXQsIHBhc3MgKSB7CgkJdmFyIGV4ZWMsCgkJCWJ1bGsgPSBrZXkgPT0gbnVsbCwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aDsKCgkJLy8gU2V0cyBtYW55IHZhbHVlcwoJCWlmICgga2V5ICYmIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiICkgewoJCQlmb3IgKCBpIGluIGtleSApIHsKCQkJCWpRdWVyeS5hY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5W2ldLCAxLCBlbXB0eUdldCwgdmFsdWUgKTsKCQkJfQoJCQljaGFpbmFibGUgPSAxOwoKCQkvLyBTZXRzIG9uZSB2YWx1ZQoJCX0gZWxzZSBpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIE9wdGlvbmFsbHksIGZ1bmN0aW9uIHZhbHVlcyBnZXQgZXhlY3V0ZWQgaWYgZXhlYyBpcyB0cnVlCgkJCWV4ZWMgPSBwYXNzID09PSB1bmRlZmluZWQgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCQlpZiAoIGJ1bGsgKSB7CgkJCQkvLyBCdWxrIG9wZXJhdGlvbnMgb25seSBpdGVyYXRlIHdoZW4gZXhlY3V0aW5nIGZ1bmN0aW9uIHZhbHVlcwoJCQkJaWYgKCBleGVjICkgewoJCQkJCWV4ZWMgPSBmbjsKCQkJCQlmbiA9IGZ1bmN0aW9uKCBlbGVtLCBrZXksIHZhbHVlICkgewoJCQkJCQlyZXR1cm4gZXhlYy5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdmFsdWUgKTsKCQkJCQl9OwoKCQkJCS8vIE90aGVyd2lzZSB0aGV5IHJ1biBhZ2FpbnN0IHRoZSBlbnRpcmUgc2V0CgkJCQl9IGVsc2UgewoJCQkJCWZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOwoJCQkJCWZuID0gbnVsbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBmbiApIHsKCQkJCWZvciAoOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQkJZm4oIGVsZW1zW2ldLCBrZXksIGV4ZWMgPyB2YWx1ZS5jYWxsKCBlbGVtc1tpXSwgaSwgZm4oIGVsZW1zW2ldLCBrZXkgKSApIDogdmFsdWUsIHBhc3MgKTsKCQkJCX0KCQkJfQoKCQkJY2hhaW5hYmxlID0gMTsKCQl9CgoJCXJldHVybiBjaGFpbmFibGUgPwoJCQllbGVtcyA6CgoJCQkvLyBHZXRzCgkJCWJ1bGsgPwoJCQkJZm4uY2FsbCggZWxlbXMgKSA6CgkJCQlsZW5ndGggPyBmbiggZWxlbXNbMF0sIGtleSApIDogZW1wdHlHZXQ7Cgl9LAoKCW5vdzogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCX0KfSk7CgpqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmogKSB7CglpZiAoICFyZWFkeUxpc3QgKSB7CgoJCXJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwoKCQkvLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KCQkvLyB3ZSBvbmNlIHRyaWVkIHRvIHVzZSByZWFkeVN0YXRlICJpbnRlcmFjdGl2ZSIgaGVyZSwgYnV0IGl0IGNhdXNlZCBpc3N1ZXMgbGlrZSB0aGUgb25lCgkJLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQoJCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQkJLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CgkJCXNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSwgMSApOwoKCQkvLyBTdGFuZGFyZHMtYmFzZWQgYnJvd3NlcnMgc3VwcG9ydCBET01Db250ZW50TG9hZGVkCgkJfSBlbHNlIGlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCQkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggImxvYWQiLCBqUXVlcnkucmVhZHksIGZhbHNlICk7CgoJCS8vIElmIElFIGV2ZW50IG1vZGVsIGlzIHVzZWQKCQl9IGVsc2UgewoJCQkvLyBFbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwoJCQlkb2N1bWVudC5hdHRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIERPTUNvbnRlbnRMb2FkZWQgKTsKCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hdHRhY2hFdmVudCggIm9ubG9hZCIsIGpRdWVyeS5yZWFkeSApOwoKCQkJLy8gSWYgSUUgYW5kIG5vdCBhIGZyYW1lCgkJCS8vIGNvbnRpbnVhbGx5IGNoZWNrIHRvIHNlZSBpZiB0aGUgZG9jdW1lbnQgaXMgcmVhZHkKCQkJdmFyIHRvcCA9IGZhbHNlOwoKCQkJdHJ5IHsKCQkJCXRvcCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgPT0gbnVsbCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgkJCX0gY2F0Y2goZSkge30KCgkJCWlmICggdG9wICYmIHRvcC5kb1Njcm9sbCApIHsKCQkJCShmdW5jdGlvbiBkb1Njcm9sbENoZWNrKCkgewoJCQkJCWlmICggIWpRdWVyeS5pc1JlYWR5ICkgewoKCQkJCQkJdHJ5IHsKCQkJCQkJCS8vIFVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCgkJCQkJCQkvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwoJCQkJCQkJdG9wLmRvU2Nyb2xsKCJsZWZ0Iik7CgkJCQkJCX0gY2F0Y2goZSkgewoJCQkJCQkJcmV0dXJuIHNldFRpbWVvdXQoIGRvU2Nyb2xsQ2hlY2ssIDUwICk7CgkJCQkJCX0KCgkJCQkJCS8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucwoJCQkJCQlqUXVlcnkucmVhZHkoKTsKCQkJCQl9CgkJCQl9KSgpOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHJlYWR5TGlzdC5wcm9taXNlKCBvYmogKTsKfTsKCi8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcApqUXVlcnkuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCIuc3BsaXQoIiAiKSwgZnVuY3Rpb24oaSwgbmFtZSkgewoJY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKfSk7CgovLyBBbGwgalF1ZXJ5IG9iamVjdHMgc2hvdWxkIHBvaW50IGJhY2sgdG8gdGhlc2UKcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7Ci8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7Cgl2YXIgb2JqZWN0ID0gb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gPSB7fTsKCWpRdWVyeS5lYWNoKCBvcHRpb25zLnNwbGl0KCBjb3JlX3JzcGFjZSApLCBmdW5jdGlvbiggXywgZmxhZyApIHsKCQlvYmplY3RbIGZsYWcgXSA9IHRydWU7Cgl9KTsKCXJldHVybiBvYmplY3Q7Cn0KCi8qCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogKgogKglvcHRpb25zOiBhbiBvcHRpb25hbCBsaXN0IG9mIHNwYWNlLXNlcGFyYXRlZCBvcHRpb25zIHRoYXQgd2lsbCBjaGFuZ2UgaG93CiAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdAogKgogKiBCeSBkZWZhdWx0IGEgY2FsbGJhY2sgbGlzdCB3aWxsIGFjdCBsaWtlIGFuIGV2ZW50IGNhbGxiYWNrIGxpc3QgYW5kIGNhbiBiZQogKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogKgogKiBQb3NzaWJsZSBvcHRpb25zOgogKgogKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAqCQkJCQl2YWx1ZXMgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogKgogKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAqCiAqLwpqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJLy8gQ29udmVydCBvcHRpb25zIGZyb20gU3RyaW5nLWZvcm1hdHRlZCB0byBPYmplY3QtZm9ybWF0dGVkIGlmIG5lZWRlZAoJLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQoJb3B0aW9ucyA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiA/CgkJKCBvcHRpb25zQ2FjaGVbIG9wdGlvbnMgXSB8fCBjcmVhdGVPcHRpb25zKCBvcHRpb25zICkgKSA6CgkJalF1ZXJ5LmV4dGVuZCgge30sIG9wdGlvbnMgKTsKCgl2YXIgLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQoJCW1lbW9yeSwKCQkvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAoJCWZpcmVkLAoJCS8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKCQlmaXJpbmcsCgkJLy8gRmlyc3QgY2FsbGJhY2sgdG8gZmlyZSAodXNlZCBpbnRlcm5hbGx5IGJ5IGFkZCBhbmQgZmlyZVdpdGgpCgkJZmlyaW5nU3RhcnQsCgkJLy8gRW5kIG9mIHRoZSBsb29wIHdoZW4gZmlyaW5nCgkJZmlyaW5nTGVuZ3RoLAoJCS8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IHJlbW92ZSBpZiBuZWVkZWQpCgkJZmlyaW5nSW5kZXgsCgkJLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKCQlsaXN0ID0gW10sCgkJLy8gU3RhY2sgb2YgZmlyZSBjYWxscyBmb3IgcmVwZWF0YWJsZSBsaXN0cwoJCXN0YWNrID0gIW9wdGlvbnMub25jZSAmJiBbXSwKCQkvLyBGaXJlIGNhbGxiYWNrcwoJCWZpcmUgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJbWVtb3J5ID0gb3B0aW9ucy5tZW1vcnkgJiYgZGF0YTsKCQkJZmlyZWQgPSB0cnVlOwoJCQlmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7CgkJCWZpcmluZ1N0YXJ0ID0gMDsKCQkJZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CgkJCWZpcmluZyA9IHRydWU7CgkJCWZvciAoIDsgbGlzdCAmJiBmaXJpbmdJbmRleCA8IGZpcmluZ0xlbmd0aDsgZmlyaW5nSW5kZXgrKyApIHsKCQkJCWlmICggbGlzdFsgZmlyaW5nSW5kZXggXS5hcHBseSggZGF0YVsgMCBdLCBkYXRhWyAxIF0gKSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5zdG9wT25GYWxzZSApIHsKCQkJCQltZW1vcnkgPSBmYWxzZTsgLy8gVG8gcHJldmVudCBmdXJ0aGVyIGNhbGxzIHVzaW5nIGFkZAoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWZpcmluZyA9IGZhbHNlOwoJCQlpZiAoIGxpc3QgKSB7CgkJCQlpZiAoIHN0YWNrICkgewoJCQkJCWlmICggc3RhY2subGVuZ3RoICkgewoJCQkJCQlmaXJlKCBzdGFjay5zaGlmdCgpICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCWxpc3QgPSBbXTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5kaXNhYmxlKCk7CgkJCQl9CgkJCX0KCQl9LAoJCS8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CgkJc2VsZiA9IHsKCQkJLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAoJCQlhZGQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCS8vIEZpcnN0LCB3ZSBzYXZlIHRoZSBjdXJyZW50IGxlbmd0aAoJCQkJCXZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwoJCQkJCShmdW5jdGlvbiBhZGQoIGFyZ3MgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCBhcmdzLCBmdW5jdGlvbiggXywgYXJnICkgewoJCQkJCQkJdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggYXJnICk7CgkJCQkJCQlpZiAoIHR5cGUgPT09ICJmdW5jdGlvbiIgKSB7CgkJCQkJCQkJaWYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApIHsKCQkJCQkJCQkJbGlzdC5wdXNoKCBhcmcgKTsKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCAmJiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJCQkJCQkvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CgkJCQkJCQkJYWRkKCBhcmcgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfSkoIGFyZ3VtZW50cyApOwoJCQkJCS8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCgkJCQkJLy8gY3VycmVudCBmaXJpbmcgYmF0Y2g/CgkJCQkJaWYgKCBmaXJpbmcgKSB7CgkJCQkJCWZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwoJCQkJCS8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KCQkJCQkvLyB3ZSBzaG91bGQgY2FsbCByaWdodCBhd2F5CgkJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCQlmaXJpbmdTdGFydCA9IHN0YXJ0OwoJCQkJCQlmaXJlKCBtZW1vcnkgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAoJCQlyZW1vdmU6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCWpRdWVyeS5lYWNoKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CgkJCQkJCXZhciBpbmRleDsKCQkJCQkJd2hpbGUoICggaW5kZXggPSBqUXVlcnkuaW5BcnJheSggYXJnLCBsaXN0LCBpbmRleCApICkgPiAtMSApIHsKCQkJCQkJCWxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCgkJCQkJCQlpZiAoIGZpcmluZyApIHsKCQkJCQkJCQlpZiAoIGluZGV4IDw9IGZpcmluZ0xlbmd0aCApIHsKCQkJCQkJCQkJZmlyaW5nTGVuZ3RoLS07CgkJCQkJCQkJfQoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nSW5kZXggKSB7CgkJCQkJCQkJCWZpcmluZ0luZGV4LS07CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gQ29udHJvbCBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0CgkJCWhhczogZnVuY3Rpb24oIGZuICkgewoJCQkJcmV0dXJuIGpRdWVyeS5pbkFycmF5KCBmbiwgbGlzdCApID4gLTE7CgkJCX0sCgkJCS8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKCQkJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IFtdOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIEhhdmUgdGhlIGxpc3QgZG8gbm90aGluZyBhbnltb3JlCgkJCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IHN0YWNrID0gbWVtb3J5ID0gdW5kZWZpbmVkOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIElzIGl0IGRpc2FibGVkPwoJCQlkaXNhYmxlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIWxpc3Q7CgkJCX0sCgkJCS8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKCQkJbG9jazogZnVuY3Rpb24oKSB7CgkJCQlzdGFjayA9IHVuZGVmaW5lZDsKCQkJCWlmICggIW1lbW9yeSApIHsKCQkJCQlzZWxmLmRpc2FibGUoKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBJcyBpdCBsb2NrZWQ/CgkJCWxvY2tlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIXN0YWNrOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBhbmQgYXJndW1lbnRzCgkJCWZpcmVXaXRoOiBmdW5jdGlvbiggY29udGV4dCwgYXJncyApIHsKCQkJCWFyZ3MgPSBhcmdzIHx8IFtdOwoJCQkJYXJncyA9IFsgY29udGV4dCwgYXJncy5zbGljZSA/IGFyZ3Muc2xpY2UoKSA6IGFyZ3MgXTsKCQkJCWlmICggbGlzdCAmJiAoICFmaXJlZCB8fCBzdGFjayApICkgewoJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQlzdGFjay5wdXNoKCBhcmdzICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJZmlyZSggYXJncyApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwoJCQlmaXJlOiBmdW5jdGlvbigpIHsKCQkJCXNlbGYuZmlyZVdpdGgoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQoJCQlmaXJlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISFmaXJlZDsKCQkJfQoJCX07CgoJcmV0dXJuIHNlbGY7Cn07CmpRdWVyeS5leHRlbmQoewoKCURlZmVycmVkOiBmdW5jdGlvbiggZnVuYyApIHsKCQl2YXIgdHVwbGVzID0gWwoJCQkJLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGxpc3RlbmVyIGxpc3QsIGZpbmFsIHN0YXRlCgkJCQlbICJyZXNvbHZlIiwgImRvbmUiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAicmVzb2x2ZWQiIF0sCgkJCQlbICJyZWplY3QiLCAiZmFpbCIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCIgXSwKCQkJCVsgIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpIF0KCQkJXSwKCQkJc3RhdGUgPSAicGVuZGluZyIsCgkJCXByb21pc2UgPSB7CgkJCQlzdGF0ZTogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHN0YXRlOwoJCQkJfSwKCQkJCWFsd2F5czogZnVuY3Rpb24oKSB7CgkJCQkJZGVmZXJyZWQuZG9uZSggYXJndW1lbnRzICkuZmFpbCggYXJndW1lbnRzICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoJCQkJdGhlbjogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgewoJCQkJCXZhciBmbnMgPSBhcmd1bWVudHM7CgkJCQkJcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiggbmV3RGVmZXIgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJCQkJCXZhciBhY3Rpb24gPSB0dXBsZVsgMCBdLAoJCQkJCQkJCWZuID0gZm5zWyBpIF07CgkJCQkJCQkvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXIKCQkJCQkJCWRlZmVycmVkWyB0dXBsZVsxXSBdKCBqUXVlcnkuaXNGdW5jdGlvbiggZm4gKSA/CgkJCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQkJCXZhciByZXR1cm5lZCA9IGZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQkJCQkJaWYgKCByZXR1cm5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmV0dXJuZWQucHJvbWlzZSApICkgewoJCQkJCQkJCQkJcmV0dXJuZWQucHJvbWlzZSgpCgkJCQkJCQkJCQkJLmRvbmUoIG5ld0RlZmVyLnJlc29sdmUgKQoJCQkJCQkJCQkJCS5mYWlsKCBuZXdEZWZlci5yZWplY3QgKQoJCQkJCQkJCQkJCS5wcm9ncmVzcyggbmV3RGVmZXIubm90aWZ5ICk7CgkJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCQluZXdEZWZlclsgYWN0aW9uICsgIldpdGgiIF0oIHRoaXMgPT09IGRlZmVycmVkID8gbmV3RGVmZXIgOiB0aGlzLCBbIHJldHVybmVkIF0gKTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0gOgoJCQkJCQkJCW5ld0RlZmVyWyBhY3Rpb24gXQoJCQkJCQkJKTsKCQkJCQkJfSk7CgkJCQkJCWZucyA9IG51bGw7CgkJCQkJfSkucHJvbWlzZSgpOwoJCQkJfSwKCQkJCS8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKCQkJCS8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKCQkJCXByb21pc2U6IGZ1bmN0aW9uKCBvYmogKSB7CgkJCQkJcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZCggb2JqLCBwcm9taXNlICkgOiBwcm9taXNlOwoJCQkJfQoJCQl9LAoJCQlkZWZlcnJlZCA9IHt9OwoKCQkvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0CgkJcHJvbWlzZS5waXBlID0gcHJvbWlzZS50aGVuOwoKCQkvLyBBZGQgbGlzdC1zcGVjaWZpYyBtZXRob2RzCgkJalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgewoJCQl2YXIgbGlzdCA9IHR1cGxlWyAyIF0sCgkJCQlzdGF0ZVN0cmluZyA9IHR1cGxlWyAzIF07CgoJCQkvLyBwcm9taXNlWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gPSBsaXN0LmFkZAoJCQlwcm9taXNlWyB0dXBsZVsxXSBdID0gbGlzdC5hZGQ7CgoJCQkvLyBIYW5kbGUgc3RhdGUKCQkJaWYgKCBzdGF0ZVN0cmluZyApIHsKCQkJCWxpc3QuYWRkKGZ1bmN0aW9uKCkgewoJCQkJCS8vIHN0YXRlID0gWyByZXNvbHZlZCB8IHJlamVjdGVkIF0KCQkJCQlzdGF0ZSA9IHN0YXRlU3RyaW5nOwoKCQkJCS8vIFsgcmVqZWN0X2xpc3QgfCByZXNvbHZlX2xpc3QgXS5kaXNhYmxlOyBwcm9ncmVzc19saXN0LmxvY2sKCQkJCX0sIHR1cGxlc1sgaSBeIDEgXVsgMiBdLmRpc2FibGUsIHR1cGxlc1sgMiBdWyAyIF0ubG9jayApOwoJCQl9CgoJCQkvLyBkZWZlcnJlZFsgcmVzb2x2ZSB8IHJlamVjdCB8IG5vdGlmeSBdID0gbGlzdC5maXJlCgkJCWRlZmVycmVkWyB0dXBsZVswXSBdID0gbGlzdC5maXJlOwoJCQlkZWZlcnJlZFsgdHVwbGVbMF0gKyAiV2l0aCIgXSA9IGxpc3QuZmlyZVdpdGg7CgkJfSk7CgoJCS8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQoJCXByb21pc2UucHJvbWlzZSggZGVmZXJyZWQgKTsKCgkJLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQoJCWlmICggZnVuYyApIHsKCQkJZnVuYy5jYWxsKCBkZWZlcnJlZCwgZGVmZXJyZWQgKTsKCQl9CgoJCS8vIEFsbCBkb25lIQoJCXJldHVybiBkZWZlcnJlZDsKCX0sCgoJLy8gRGVmZXJyZWQgaGVscGVyCgl3aGVuOiBmdW5jdGlvbiggc3Vib3JkaW5hdGUgLyogLCAuLi4sIHN1Ym9yZGluYXRlTiAqLyApIHsKCQl2YXIgaSA9IDAsCgkJCXJlc29sdmVWYWx1ZXMgPSBjb3JlX3NsaWNlLmNhbGwoIGFyZ3VtZW50cyApLAoJCQlsZW5ndGggPSByZXNvbHZlVmFsdWVzLmxlbmd0aCwKCgkJCS8vIHRoZSBjb3VudCBvZiB1bmNvbXBsZXRlZCBzdWJvcmRpbmF0ZXMKCQkJcmVtYWluaW5nID0gbGVuZ3RoICE9PSAxIHx8ICggc3Vib3JkaW5hdGUgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHN1Ym9yZGluYXRlLnByb21pc2UgKSApID8gbGVuZ3RoIDogMCwKCgkJCS8vIHRoZSBtYXN0ZXIgRGVmZXJyZWQuIElmIHJlc29sdmVWYWx1ZXMgY29uc2lzdCBvZiBvbmx5IGEgc2luZ2xlIERlZmVycmVkLCBqdXN0IHVzZSB0aGF0LgoJCQlkZWZlcnJlZCA9IHJlbWFpbmluZyA9PT0gMSA/IHN1Ym9yZGluYXRlIDogalF1ZXJ5LkRlZmVycmVkKCksCgoJCQkvLyBVcGRhdGUgZnVuY3Rpb24gZm9yIGJvdGggcmVzb2x2ZSBhbmQgcHJvZ3Jlc3MgdmFsdWVzCgkJCXVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiggaSwgY29udGV4dHMsIHZhbHVlcyApIHsKCQkJCXJldHVybiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJY29udGV4dHNbIGkgXSA9IHRoaXM7CgkJCQkJdmFsdWVzWyBpIF0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICkgOiB2YWx1ZTsKCQkJCQlpZiggdmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcyApIHsKCQkJCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggY29udGV4dHMsIHZhbHVlcyApOwoJCQkJCX0gZWxzZSBpZiAoICEoIC0tcmVtYWluaW5nICkgKSB7CgkJCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7CgkJCQkJfQoJCQkJfTsKCQkJfSwKCgkJCXByb2dyZXNzVmFsdWVzLCBwcm9ncmVzc0NvbnRleHRzLCByZXNvbHZlQ29udGV4dHM7CgoJCS8vIGFkZCBsaXN0ZW5lcnMgdG8gRGVmZXJyZWQgc3Vib3JkaW5hdGVzOyB0cmVhdCBvdGhlcnMgYXMgcmVzb2x2ZWQKCQlpZiAoIGxlbmd0aCA+IDEgKSB7CgkJCXByb2dyZXNzVmFsdWVzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJcHJvZ3Jlc3NDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CgkJCXJlc29sdmVDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCByZXNvbHZlVmFsdWVzWyBpIF0gJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHJlc29sdmVWYWx1ZXNbIGkgXS5wcm9taXNlICkgKSB7CgkJCQkJcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UoKQoJCQkJCQkuZG9uZSggdXBkYXRlRnVuYyggaSwgcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICkgKQoJCQkJCQkuZmFpbCggZGVmZXJyZWQucmVqZWN0ICkKCQkJCQkJLnByb2dyZXNzKCB1cGRhdGVGdW5jKCBpLCBwcm9ncmVzc0NvbnRleHRzLCBwcm9ncmVzc1ZhbHVlcyApICk7CgkJCQl9IGVsc2UgewoJCQkJCS0tcmVtYWluaW5nOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBpZiB3ZSdyZSBub3Qgd2FpdGluZyBvbiBhbnl0aGluZywgcmVzb2x2ZSB0aGUgbWFzdGVyCgkJaWYgKCAhcmVtYWluaW5nICkgewoJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfQp9KTsKalF1ZXJ5LnN1cHBvcnQgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHN1cHBvcnQsCgkJYWxsLAoJCWEsCgkJc2VsZWN0LAoJCW9wdCwKCQlpbnB1dCwKCQlmcmFnbWVudCwKCQlldmVudE5hbWUsCgkJaSwKCQlpc1N1cHBvcnRlZCwKCQljbGlja0ZuLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCS8vIFNldHVwCglkaXYuc2V0QXR0cmlidXRlKCAiY2xhc3NOYW1lIiwgInQiICk7CglkaXYuaW5uZXJIVE1MID0gIiAgPGxpbmsvPjx0YWJsZT48L3RhYmxlPjxhIGhyZWY9Jy9hJz5hPC9hPjxpbnB1dCB0eXBlPSdjaGVja2JveCcvPiI7CgoJLy8gU3VwcG9ydCB0ZXN0cyB3b24ndCBydW4gaW4gc29tZSBsaW1pdGVkIG9yIG5vbi1icm93c2VyIGVudmlyb25tZW50cwoJYWxsID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIik7CglhID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJhIilbIDAgXTsKCWlmICggIWFsbCB8fCAhYSB8fCAhYWxsLmxlbmd0aCApIHsKCQlyZXR1cm4ge307Cgl9CgoJLy8gRmlyc3QgYmF0Y2ggb2YgdGVzdHMKCXNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpOwoJb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKSApOwoJaW5wdXQgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IilbIDAgXTsKCglhLnN0eWxlLmNzc1RleHQgPSAidG9wOjFweDtmbG9hdDpsZWZ0O29wYWNpdHk6LjUiOwoJc3VwcG9ydCA9IHsKCQkvLyBJRSBzdHJpcHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gLmlubmVySFRNTCBpcyB1c2VkCgkJbGVhZGluZ1doaXRlc3BhY2U6ICggZGl2LmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDMgKSwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGJvZHkgZWxlbWVudHMgYXJlbid0IGF1dG9tYXRpY2FsbHkgaW5zZXJ0ZWQKCQkvLyBJRSB3aWxsIGluc2VydCB0aGVtIGludG8gZW1wdHkgdGFibGVzCgkJdGJvZHk6ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBsaW5rIGVsZW1lbnRzIGdldCBzZXJpYWxpemVkIGNvcnJlY3RseSBieSBpbm5lckhUTUwKCQkvLyBUaGlzIHJlcXVpcmVzIGEgd3JhcHBlciBlbGVtZW50IGluIElFCgkJaHRtbFNlcmlhbGl6ZTogISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsCgoJCS8vIEdldCB0aGUgc3R5bGUgaW5mb3JtYXRpb24gZnJvbSBnZXRBdHRyaWJ1dGUKCQkvLyAoSUUgdXNlcyAuY3NzVGV4dCBpbnN0ZWFkKQoJCXN0eWxlOiAvdG9wLy50ZXN0KCBhLmdldEF0dHJpYnV0ZSgic3R5bGUiKSApLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBVUkxzIGFyZW4ndCBtYW5pcHVsYXRlZAoJCS8vIChJRSBub3JtYWxpemVzIGl0IGJ5IGRlZmF1bHQpCgkJaHJlZk5vcm1hbGl6ZWQ6ICggYS5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIi9hIiApLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBlbGVtZW50IG9wYWNpdHkgZXhpc3RzCgkJLy8gKElFIHVzZXMgZmlsdGVyIGluc3RlYWQpCgkJLy8gVXNlIGEgcmVnZXggdG8gd29yayBhcm91bmQgYSBXZWJLaXQgaXNzdWUuIFNlZSAjNTE0NQoJCW9wYWNpdHk6IC9eMC41Ly50ZXN0KCBhLnN0eWxlLm9wYWNpdHkgKSwKCgkJLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQoJCS8vIChJRSB1c2VzIHN0eWxlRmxvYXQgaW5zdGVhZCBvZiBjc3NGbG9hdCkKCQljc3NGbG9hdDogISFhLnN0eWxlLmNzc0Zsb2F0LAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBpZiBubyB2YWx1ZSBpcyBzcGVjaWZpZWQgZm9yIGEgY2hlY2tib3gKCQkvLyB0aGF0IGl0IGRlZmF1bHRzIHRvICJvbiIuCgkJLy8gKFdlYktpdCBkZWZhdWx0cyB0byAiIiBpbnN0ZWFkKQoJCWNoZWNrT246ICggaW5wdXQudmFsdWUgPT09ICJvbiIgKSwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgoJCS8vIChXZWJLaXQgZGVmYXVsdHMgdG8gZmFsc2UgaW5zdGVhZCBvZiB0cnVlLCBJRSB0b28sIGlmIGl0J3MgaW4gYW4gb3B0Z3JvdXApCgkJb3B0U2VsZWN0ZWQ6IG9wdC5zZWxlY3RlZCwKCgkJLy8gVGVzdCBzZXRBdHRyaWJ1dGUgb24gY2FtZWxDYXNlIGNsYXNzLiBJZiBpdCB3b3Jrcywgd2UgbmVlZCBhdHRyRml4ZXMgd2hlbiBkb2luZyBnZXQvc2V0QXR0cmlidXRlIChpZTYvNykKCQlnZXRTZXRBdHRyaWJ1dGU6IGRpdi5jbGFzc05hbWUgIT09ICJ0IiwKCgkJLy8gVGVzdHMgZm9yIGVuY3R5cGUgc3VwcG9ydCBvbiBhIGZvcm0gKCM2NzQzKQoJCWVuY3R5cGU6ICEhZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpLmVuY3R5cGUsCgoJCS8vIE1ha2VzIHN1cmUgY2xvbmluZyBhbiBodG1sNSBlbGVtZW50IGRvZXMgbm90IGNhdXNlIHByb2JsZW1zCgkJLy8gV2hlcmUgb3V0ZXJIVE1MIGlzIHVuZGVmaW5lZCwgdGhpcyBzdGlsbCB3b3JrcwoJCWh0bWw1Q2xvbmU6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm5hdiIpLmNsb25lTm9kZSggdHJ1ZSApLm91dGVySFRNTCAhPT0gIjw6bmF2PjwvOm5hdj4iLAoKCQkvLyBqUXVlcnkuc3VwcG9ydC5ib3hNb2RlbCBERVBSRUNBVEVEIGluIDEuOCBzaW5jZSB3ZSBkb24ndCBzdXBwb3J0IFF1aXJrcyBNb2RlCgkJYm94TW9kZWw6ICggZG9jdW1lbnQuY29tcGF0TW9kZSA9PT0gIkNTUzFDb21wYXQiICksCgoJCS8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcgoJCXN1Ym1pdEJ1YmJsZXM6IHRydWUsCgkJY2hhbmdlQnViYmxlczogdHJ1ZSwKCQlmb2N1c2luQnViYmxlczogZmFsc2UsCgkJZGVsZXRlRXhwYW5kbzogdHJ1ZSwKCQlub0Nsb25lRXZlbnQ6IHRydWUsCgkJaW5saW5lQmxvY2tOZWVkc0xheW91dDogZmFsc2UsCgkJc2hyaW5rV3JhcEJsb2NrczogZmFsc2UsCgkJcmVsaWFibGVNYXJnaW5SaWdodDogdHJ1ZSwKCQlib3hTaXppbmdSZWxpYWJsZTogdHJ1ZSwKCQlwaXhlbFBvc2l0aW9uOiBmYWxzZQoJfTsKCgkvLyBNYWtlIHN1cmUgY2hlY2tlZCBzdGF0dXMgaXMgcHJvcGVybHkgY2xvbmVkCglpbnB1dC5jaGVja2VkID0gdHJ1ZTsKCXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSBpbnB1dC5jbG9uZU5vZGUoIHRydWUgKS5jaGVja2VkOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKCS8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKCXNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CglzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCgkvLyBUZXN0IHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRlbGV0ZSBhbiBleHBhbmRvIGZyb20gYW4gZWxlbWVudAoJLy8gRmFpbHMgaW4gSW50ZXJuZXQgRXhwbG9yZXIKCXRyeSB7CgkJZGVsZXRlIGRpdi50ZXN0OwoJfSBjYXRjaCggZSApIHsKCQlzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPSBmYWxzZTsKCX0KCglpZiAoICFkaXYuYWRkRXZlbnRMaXN0ZW5lciAmJiBkaXYuYXR0YWNoRXZlbnQgJiYgZGl2LmZpcmVFdmVudCApIHsKCQlkaXYuYXR0YWNoRXZlbnQoICJvbmNsaWNrIiwgY2xpY2tGbiA9IGZ1bmN0aW9uKCkgewoJCQkvLyBDbG9uaW5nIGEgbm9kZSBzaG91bGRuJ3QgY29weSBvdmVyIGFueQoJCQkvLyBib3VuZCBldmVudCBoYW5kbGVycyAoSUUgZG9lcyB0aGlzKQoJCQlzdXBwb3J0Lm5vQ2xvbmVFdmVudCA9IGZhbHNlOwoJCX0pOwoJCWRpdi5jbG9uZU5vZGUoIHRydWUgKS5maXJlRXZlbnQoIm9uY2xpY2siKTsKCQlkaXYuZGV0YWNoRXZlbnQoICJvbmNsaWNrIiwgY2xpY2tGbiApOwoJfQoKCS8vIENoZWNrIGlmIGEgcmFkaW8gbWFpbnRhaW5zIGl0cyB2YWx1ZQoJLy8gYWZ0ZXIgYmVpbmcgYXBwZW5kZWQgdG8gdGhlIERPTQoJaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJaW5wdXQudmFsdWUgPSAidCI7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgInJhZGlvIiApOwoJc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICJ0IjsKCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgImNoZWNrZWQiICk7CgoJLy8gIzExMjE3IC0gV2ViS2l0IGxvc2VzIGNoZWNrIHdoZW4gdGhlIG5hbWUgaXMgYWZ0ZXIgdGhlIGNoZWNrZWQgYXR0cmlidXRlCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJuYW1lIiwgInQiICk7CgoJZGl2LmFwcGVuZENoaWxkKCBpbnB1dCApOwoJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CglmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2Lmxhc3RDaGlsZCApOwoKCS8vIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwoJc3VwcG9ydC5jaGVja0Nsb25lID0gZnJhZ21lbnQuY2xvbmVOb2RlKCB0cnVlICkuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmNoZWNrZWQ7CgoJLy8gQ2hlY2sgaWYgYSBkaXNjb25uZWN0ZWQgY2hlY2tib3ggd2lsbCByZXRhaW4gaXRzIGNoZWNrZWQKCS8vIHZhbHVlIG9mIHRydWUgYWZ0ZXIgYXBwZW5kZWQgdG8gdGhlIERPTSAoSUU2LzcpCglzdXBwb3J0LmFwcGVuZENoZWNrZWQgPSBpbnB1dC5jaGVja2VkOwoKCWZyYWdtZW50LnJlbW92ZUNoaWxkKCBpbnB1dCApOwoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCS8vIFRlY2huaXF1ZSBmcm9tIEp1cml5IFpheXRzZXYKCS8vIGh0dHA6Ly9wZXJmZWN0aW9ua2lsbHMuY29tL2RldGVjdGluZy1ldmVudC1zdXBwb3J0LXdpdGhvdXQtYnJvd3Nlci1zbmlmZmluZy8KCS8vIFdlIG9ubHkgY2FyZSBhYm91dCB0aGUgY2FzZSB3aGVyZSBub24tc3RhbmRhcmQgZXZlbnQgc3lzdGVtcwoJLy8gYXJlIHVzZWQsIG5hbWVseSBpbiBJRS4gU2hvcnQtY2lyY3VpdGluZyBoZXJlIGhlbHBzIHVzIHRvCgkvLyBhdm9pZCBhbiBldmFsIGNhbGwgKGluIHNldEF0dHJpYnV0ZSkgd2hpY2ggY2FuIGNhdXNlIENTUAoJLy8gdG8gZ28gaGF5d2lyZS4gU2VlOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9TZWN1cml0eS9DU1AKCWlmICggZGl2LmF0dGFjaEV2ZW50ICkgewoJCWZvciAoIGkgaW4gewoJCQlzdWJtaXQ6IHRydWUsCgkJCWNoYW5nZTogdHJ1ZSwKCQkJZm9jdXNpbjogdHJ1ZQoJCX0pIHsKCQkJZXZlbnROYW1lID0gIm9uIiArIGk7CgkJCWlzU3VwcG9ydGVkID0gKCBldmVudE5hbWUgaW4gZGl2ICk7CgkJCWlmICggIWlzU3VwcG9ydGVkICkgewoJCQkJZGl2LnNldEF0dHJpYnV0ZSggZXZlbnROYW1lLCAicmV0dXJuOyIgKTsKCQkJCWlzU3VwcG9ydGVkID0gKCB0eXBlb2YgZGl2WyBldmVudE5hbWUgXSA9PT0gImZ1bmN0aW9uIiApOwoJCQl9CgkJCXN1cHBvcnRbIGkgKyAiQnViYmxlcyIgXSA9IGlzU3VwcG9ydGVkOwoJCX0KCX0KCgkvLyBSdW4gdGVzdHMgdGhhdCBuZWVkIGEgYm9keSBhdCBkb2MgcmVhZHkKCWpRdWVyeShmdW5jdGlvbigpIHsKCQl2YXIgY29udGFpbmVyLCBkaXYsIHRkcywgbWFyZ2luRGl2LAoJCQlkaXZSZXNldCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpibG9jaztvdmVyZmxvdzpoaWRkZW47IiwKCQkJYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF07CgoJCWlmICggIWJvZHkgKSB7CgkJCS8vIFJldHVybiBmb3IgZnJhbWVzZXQgZG9jcyB0aGF0IGRvbid0IGhhdmUgYSBib2R5CgkJCXJldHVybjsKCQl9CgoJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gInZpc2liaWxpdHk6aGlkZGVuO2JvcmRlcjowO3dpZHRoOjA7aGVpZ2h0OjA7cG9zaXRpb246c3RhdGljO3RvcDowO21hcmdpbi10b3A6MXB4IjsKCQlib2R5Lmluc2VydEJlZm9yZSggY29udGFpbmVyLCBib2R5LmZpcnN0Q2hpbGQgKTsKCgkJLy8gQ29uc3RydWN0IHRoZSB0ZXN0IGVsZW1lbnQKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQljb250YWluZXIuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCQkvLyBDaGVjayBpZiB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodCB3aGVuIHRoZXkgYXJlIHNldAoJCS8vIHRvIGRpc3BsYXk6bm9uZSBhbmQgdGhlcmUgYXJlIHN0aWxsIG90aGVyIHZpc2libGUgdGFibGUgY2VsbHMgaW4gYQoJCS8vIHRhYmxlIHJvdzsgaWYgc28sIG9mZnNldFdpZHRoL0hlaWdodCBhcmUgbm90IHJlbGlhYmxlIGZvciB1c2Ugd2hlbgoJCS8vIGRldGVybWluaW5nIGlmIGFuIGVsZW1lbnQgaGFzIGJlZW4gaGlkZGVuIGRpcmVjdGx5IHVzaW5nCgkJLy8gZGlzcGxheTpub25lIChpdCBpcyBzdGlsbCBzYWZlIHRvIHVzZSBvZmZzZXRzIGlmIGEgcGFyZW50IGVsZW1lbnQgaXMKCQkvLyBoaWRkZW47IGRvbiBzYWZldHkgZ29nZ2xlcyBhbmQgc2VlIGJ1ZyAjNDUxMiBmb3IgbW9yZSBpbmZvcm1hdGlvbikuCgkJLy8gKG9ubHkgSUUgOCBmYWlscyB0aGlzIHRlc3QpCgkJZGl2LmlubmVySFRNTCA9ICI8dGFibGU+PHRyPjx0ZD48L3RkPjx0ZD50PC90ZD48L3RyPjwvdGFibGU+IjsKCQl0ZHMgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRkIik7CgkJdGRzWyAwIF0uc3R5bGUuY3NzVGV4dCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpub25lIjsKCQlpc1N1cHBvcnRlZCA9ICggdGRzWyAwIF0ub2Zmc2V0SGVpZ2h0ID09PSAwICk7CgoJCXRkc1sgMCBdLnN0eWxlLmRpc3BsYXkgPSAiIjsKCQl0ZHNbIDEgXS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKCQkvLyBDaGVjayBpZiBlbXB0eSB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodAoJCS8vIChJRSA8PSA4IGZhaWwgdGhpcyB0ZXN0KQoJCXN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzID0gaXNTdXBwb3J0ZWQgJiYgKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCgkJLy8gQ2hlY2sgYm94LXNpemluZyBhbmQgbWFyZ2luIGJlaGF2aW9yCgkJZGl2LmlubmVySFRNTCA9ICIiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gImJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDstd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDtwYWRkaW5nOjFweDtib3JkZXI6MXB4O2Rpc3BsYXk6YmxvY2s7d2lkdGg6NHB4O21hcmdpbi10b3A6MSU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjElOyI7CgkJc3VwcG9ydC5ib3hTaXppbmcgPSAoIGRpdi5vZmZzZXRXaWR0aCA9PT0gNCApOwoJCXN1cHBvcnQuZG9lc05vdEluY2x1ZGVNYXJnaW5JbkJvZHlPZmZzZXQgPSAoIGJvZHkub2Zmc2V0VG9wICE9PSAxICk7CgoJCS8vIE5PVEU6IFRvIGFueSBmdXR1cmUgbWFpbnRhaW5lciwgd2UndmUgd2luZG93LmdldENvbXB1dGVkU3R5bGUKCQkvLyBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgoJCWlmICggd2luZG93LmdldENvbXB1dGVkU3R5bGUgKSB7CgkJCXN1cHBvcnQucGl4ZWxQb3NpdGlvbiA9ICggd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGRpdiwgbnVsbCApIHx8IHt9ICkudG9wICE9PSAiMSUiOwoJCQlzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwgeyB3aWR0aDogIjRweCIgfSApLndpZHRoID09PSAiNHB4IjsKCgkJCS8vIENoZWNrIGlmIGRpdiB3aXRoIGV4cGxpY2l0IHdpZHRoIGFuZCBubyBtYXJnaW4tcmlnaHQgaW5jb3JyZWN0bHkKCQkJLy8gZ2V0cyBjb21wdXRlZCBtYXJnaW4tcmlnaHQgYmFzZWQgb24gd2lkdGggb2YgY29udGFpbmVyLiBGb3IgbW9yZQoJCQkvLyBpbmZvIHNlZSBidWcgIzMzMzMKCQkJLy8gRmFpbHMgaW4gV2ViS2l0IGJlZm9yZSBGZWIgMjAxMSBuaWdodGxpZXMKCQkJLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CgkJCW1hcmdpbkRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCQltYXJnaW5EaXYuc3R5bGUuY3NzVGV4dCA9IGRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2UmVzZXQ7CgkJCW1hcmdpbkRpdi5zdHlsZS5tYXJnaW5SaWdodCA9IG1hcmdpbkRpdi5zdHlsZS53aWR0aCA9ICIwIjsKCQkJZGl2LnN0eWxlLndpZHRoID0gIjFweCI7CgkJCWRpdi5hcHBlbmRDaGlsZCggbWFyZ2luRGl2ICk7CgkJCXN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCA9CgkJCQkhcGFyc2VGbG9hdCggKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggbWFyZ2luRGl2LCBudWxsICkgfHwge30gKS5tYXJnaW5SaWdodCApOwoJCX0KCgkJaWYgKCB0eXBlb2YgZGl2LnN0eWxlLnpvb20gIT09ICJ1bmRlZmluZWQiICkgewoJCQkvLyBDaGVjayBpZiBuYXRpdmVseSBibG9jay1sZXZlbCBlbGVtZW50cyBhY3QgbGlrZSBpbmxpbmUtYmxvY2sKCQkJLy8gZWxlbWVudHMgd2hlbiBzZXR0aW5nIHRoZWlyIGRpc3BsYXkgdG8gJ2lubGluZScgYW5kIGdpdmluZwoJCQkvLyB0aGVtIGxheW91dAoJCQkvLyAoSUUgPCA4IGRvZXMgdGhpcykKCQkJZGl2LmlubmVySFRNTCA9ICIiOwoJCQlkaXYuc3R5bGUuY3NzVGV4dCA9IGRpdlJlc2V0ICsgIndpZHRoOjFweDtwYWRkaW5nOjFweDtkaXNwbGF5OmlubGluZTt6b29tOjEiOwoJCQlzdXBwb3J0LmlubGluZUJsb2NrTmVlZHNMYXlvdXQgPSAoIGRpdi5vZmZzZXRXaWR0aCA9PT0gMyApOwoKCQkJLy8gQ2hlY2sgaWYgZWxlbWVudHMgd2l0aCBsYXlvdXQgc2hyaW5rLXdyYXAgdGhlaXIgY2hpbGRyZW4KCQkJLy8gKElFIDYgZG9lcyB0aGlzKQoJCQlkaXYuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCWRpdi5zdHlsZS5vdmVyZmxvdyA9ICJ2aXNpYmxlIjsKCQkJZGl2LmlubmVySFRNTCA9ICI8ZGl2PjwvZGl2PiI7CgkJCWRpdi5maXJzdENoaWxkLnN0eWxlLndpZHRoID0gIjVweCI7CgkJCXN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcyA9ICggZGl2Lm9mZnNldFdpZHRoICE9PSAzICk7CgoJCQljb250YWluZXIuc3R5bGUuem9vbSA9IDE7CgkJfQoKCQkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFCgkJYm9keS5yZW1vdmVDaGlsZCggY29udGFpbmVyICk7CgkJY29udGFpbmVyID0gZGl2ID0gdGRzID0gbWFyZ2luRGl2ID0gbnVsbDsKCX0pOwoKCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKCWZyYWdtZW50LnJlbW92ZUNoaWxkKCBkaXYgKTsKCWFsbCA9IGEgPSBzZWxlY3QgPSBvcHQgPSBpbnB1dCA9IGZyYWdtZW50ID0gZGl2ID0gbnVsbDsKCglyZXR1cm4gc3VwcG9ydDsKfSkoKTsKdmFyIHJicmFjZSA9IC8oPzpce1tcc1xTXSpcfXxcW1tcc1xTXSpcXSkkLywKCXJtdWx0aURhc2ggPSAvKFtBLVpdKS9nOwoKalF1ZXJ5LmV4dGVuZCh7CgljYWNoZToge30sCgoJZGVsZXRlZElkczogW10sCgoJLy8gUmVtb3ZlIGF0IG5leHQgbWFqb3IgcmVsZWFzZSAoMS45LzIuMCkKCXV1aWQ6IDAsCgoJLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCgkvLyBOb24tZGlnaXRzIHJlbW92ZWQgdG8gbWF0Y2ggcmlubGluZWpRdWVyeQoJZXhwYW5kbzogImpRdWVyeSIgKyAoIGpRdWVyeS5mbi5qcXVlcnkgKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggL1xEL2csICIiICksCgoJLy8gVGhlIGZvbGxvd2luZyBlbGVtZW50cyB0aHJvdyB1bmNhdGNoYWJsZSBleGNlcHRpb25zIGlmIHlvdQoJLy8gYXR0ZW1wdCB0byBhZGQgZXhwYW5kbyBwcm9wZXJ0aWVzIHRvIHRoZW0uCglub0RhdGE6IHsKCQkiZW1iZWQiOiB0cnVlLAoJCS8vIEJhbiBhbGwgb2JqZWN0cyBleGNlcHQgZm9yIEZsYXNoICh3aGljaCBoYW5kbGUgZXhwYW5kb3MpCgkJIm9iamVjdCI6ICJjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAiLAoJCSJhcHBsZXQiOiB0cnVlCgl9LAoKCWhhc0RhdGE6IGZ1bmN0aW9uKCBlbGVtICkgewoJCWVsZW0gPSBlbGVtLm5vZGVUeXBlID8galF1ZXJ5LmNhY2hlWyBlbGVtW2pRdWVyeS5leHBhbmRvXSBdIDogZWxlbVsgalF1ZXJ5LmV4cGFuZG8gXTsKCQlyZXR1cm4gISFlbGVtICYmICFpc0VtcHR5RGF0YU9iamVjdCggZWxlbSApOwoJfSwKCglkYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSwgcHZ0IC8qIEludGVybmFsIFVzZSBPbmx5ICovICkgewoJCWlmICggIWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0aGlzQ2FjaGUsIHJldCwKCQkJaW50ZXJuYWxLZXkgPSBqUXVlcnkuZXhwYW5kbywKCQkJZ2V0QnlOYW1lID0gdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciLAoKCQkJLy8gV2UgaGF2ZSB0byBoYW5kbGUgRE9NIG5vZGVzIGFuZCBKUyBvYmplY3RzIGRpZmZlcmVudGx5IGJlY2F1c2UgSUU2LTcKCQkJLy8gY2FuJ3QgR0Mgb2JqZWN0IHJlZmVyZW5jZXMgcHJvcGVybHkgYWNyb3NzIHRoZSBET00tSlMgYm91bmRhcnkKCQkJaXNOb2RlID0gZWxlbS5ub2RlVHlwZSwKCgkJCS8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgdGhlIGdsb2JhbCBqUXVlcnkgY2FjaGU7IEpTIG9iamVjdCBkYXRhIGlzCgkJCS8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSBvYmplY3Qgc28gR0MgY2FuIG9jY3VyIGF1dG9tYXRpY2FsbHkKCQkJY2FjaGUgPSBpc05vZGUgPyBqUXVlcnkuY2FjaGUgOiBlbGVtLAoKCQkJLy8gT25seSBkZWZpbmluZyBhbiBJRCBmb3IgSlMgb2JqZWN0cyBpZiBpdHMgY2FjaGUgYWxyZWFkeSBleGlzdHMgYWxsb3dzCgkJCS8vIHRoZSBjb2RlIHRvIHNob3J0Y3V0IG9uIHRoZSBzYW1lIHBhdGggYXMgYSBET00gbm9kZSB3aXRoIG5vIGNhY2hlCgkJCWlkID0gaXNOb2RlID8gZWxlbVsgaW50ZXJuYWxLZXkgXSA6IGVsZW1bIGludGVybmFsS2V5IF0gJiYgaW50ZXJuYWxLZXk7CgoJCS8vIEF2b2lkIGRvaW5nIGFueSBtb3JlIHdvcmsgdGhhbiB3ZSBuZWVkIHRvIHdoZW4gdHJ5aW5nIHRvIGdldCBkYXRhIG9uIGFuCgkJLy8gb2JqZWN0IHRoYXQgaGFzIG5vIGRhdGEgYXQgYWxsCgkJaWYgKCAoIWlkIHx8ICFjYWNoZVtpZF0gfHwgKCFwdnQgJiYgIWNhY2hlW2lkXS5kYXRhKSkgJiYgZ2V0QnlOYW1lICYmIGRhdGEgPT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCAhaWQgKSB7CgkJCS8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgYSBuZXcgdW5pcXVlIElEIGZvciBlYWNoIGVsZW1lbnQgc2luY2UgdGhlaXIgZGF0YQoJCQkvLyBlbmRzIHVwIGluIHRoZSBnbG9iYWwgY2FjaGUKCQkJaWYgKCBpc05vZGUgKSB7CgkJCQllbGVtWyBpbnRlcm5hbEtleSBdID0gaWQgPSBqUXVlcnkuZGVsZXRlZElkcy5wb3AoKSB8fCBqUXVlcnkuZ3VpZCsrOwoJCQl9IGVsc2UgewoJCQkJaWQgPSBpbnRlcm5hbEtleTsKCQkJfQoJCX0KCgkJaWYgKCAhY2FjaGVbIGlkIF0gKSB7CgkJCWNhY2hlWyBpZCBdID0ge307CgoJCQkvLyBBdm9pZHMgZXhwb3NpbmcgalF1ZXJ5IG1ldGFkYXRhIG9uIHBsYWluIEpTIG9iamVjdHMgd2hlbiB0aGUgb2JqZWN0CgkJCS8vIGlzIHNlcmlhbGl6ZWQgdXNpbmcgSlNPTi5zdHJpbmdpZnkKCQkJaWYgKCAhaXNOb2RlICkgewoJCQkJY2FjaGVbIGlkIF0udG9KU09OID0galF1ZXJ5Lm5vb3A7CgkJCX0KCQl9CgoJCS8vIEFuIG9iamVjdCBjYW4gYmUgcGFzc2VkIHRvIGpRdWVyeS5kYXRhIGluc3RlYWQgb2YgYSBrZXkvdmFsdWUgcGFpcjsgdGhpcyBnZXRzCgkJLy8gc2hhbGxvdyBjb3BpZWQgb3ZlciBvbnRvIHRoZSBleGlzdGluZyBjYWNoZQoJCWlmICggdHlwZW9mIG5hbWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiBuYW1lID09PSAiZnVuY3Rpb24iICkgewoJCQlpZiAoIHB2dCApIHsKCQkJCWNhY2hlWyBpZCBdID0galF1ZXJ5LmV4dGVuZCggY2FjaGVbIGlkIF0sIG5hbWUgKTsKCQkJfSBlbHNlIHsKCQkJCWNhY2hlWyBpZCBdLmRhdGEgPSBqUXVlcnkuZXh0ZW5kKCBjYWNoZVsgaWQgXS5kYXRhLCBuYW1lICk7CgkJCX0KCQl9CgoJCXRoaXNDYWNoZSA9IGNhY2hlWyBpZCBdOwoKCQkvLyBqUXVlcnkgZGF0YSgpIGlzIHN0b3JlZCBpbiBhIHNlcGFyYXRlIG9iamVjdCBpbnNpZGUgdGhlIG9iamVjdCdzIGludGVybmFsIGRhdGEKCQkvLyBjYWNoZSBpbiBvcmRlciB0byBhdm9pZCBrZXkgY29sbGlzaW9ucyBiZXR3ZWVuIGludGVybmFsIGRhdGEgYW5kIHVzZXItZGVmaW5lZAoJCS8vIGRhdGEuCgkJaWYgKCAhcHZ0ICkgewoJCQlpZiAoICF0aGlzQ2FjaGUuZGF0YSApIHsKCQkJCXRoaXNDYWNoZS5kYXRhID0ge307CgkJCX0KCgkJCXRoaXNDYWNoZSA9IHRoaXNDYWNoZS5kYXRhOwoJCX0KCgkJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXNDYWNoZVsgalF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApIF0gPSBkYXRhOwoJCX0KCgkJLy8gQ2hlY2sgZm9yIGJvdGggY29udmVydGVkLXRvLWNhbWVsIGFuZCBub24tY29udmVydGVkIGRhdGEgcHJvcGVydHkgbmFtZXMKCQkvLyBJZiBhIGRhdGEgcHJvcGVydHkgd2FzIHNwZWNpZmllZAoJCWlmICggZ2V0QnlOYW1lICkgewoKCQkJLy8gRmlyc3QgVHJ5IHRvIGZpbmQgYXMtaXMgcHJvcGVydHkgZGF0YQoJCQlyZXQgPSB0aGlzQ2FjaGVbIG5hbWUgXTsKCgkJCS8vIFRlc3QgZm9yIG51bGx8dW5kZWZpbmVkIHByb3BlcnR5IGRhdGEKCQkJaWYgKCByZXQgPT0gbnVsbCApIHsKCgkJCQkvLyBUcnkgdG8gZmluZCB0aGUgY2FtZWxDYXNlZCBwcm9wZXJ0eQoJCQkJcmV0ID0gdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICkgXTsKCQkJfQoJCX0gZWxzZSB7CgkJCXJldCA9IHRoaXNDYWNoZTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBwdnQgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7CgkJaWYgKCAhalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHRoaXNDYWNoZSwgaSwgbCwKCgkJCWlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgoJCQkvLyBTZWUgalF1ZXJ5LmRhdGEgZm9yIG1vcmUgaW5mb3JtYXRpb24KCQkJY2FjaGUgPSBpc05vZGUgPyBqUXVlcnkuY2FjaGUgOiBlbGVtLAoJCQlpZCA9IGlzTm9kZSA/IGVsZW1bIGpRdWVyeS5leHBhbmRvIF0gOiBqUXVlcnkuZXhwYW5kbzsKCgkJLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBubyBjYWNoZSBlbnRyeSBmb3IgdGhpcyBvYmplY3QsIHRoZXJlIGlzIG5vCgkJLy8gcHVycG9zZSBpbiBjb250aW51aW5nCgkJaWYgKCAhY2FjaGVbIGlkIF0gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggbmFtZSApIHsKCgkJCXRoaXNDYWNoZSA9IHB2dCA/IGNhY2hlWyBpZCBdIDogY2FjaGVbIGlkIF0uZGF0YTsKCgkJCWlmICggdGhpc0NhY2hlICkgewoKCQkJCS8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBuYW1lcyBmb3IgZGF0YSBrZXlzCgkJCQlpZiAoICFqUXVlcnkuaXNBcnJheSggbmFtZSApICkgewoKCQkJCQkvLyB0cnkgdGhlIHN0cmluZyBhcyBhIGtleSBiZWZvcmUgYW55IG1hbmlwdWxhdGlvbgoJCQkJCWlmICggbmFtZSBpbiB0aGlzQ2FjaGUgKSB7CgkJCQkJCW5hbWUgPSBbIG5hbWUgXTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gc3BsaXQgdGhlIGNhbWVsIGNhc2VkIHZlcnNpb24gYnkgc3BhY2VzIHVubGVzcyBhIGtleSB3aXRoIHRoZSBzcGFjZXMgZXhpc3RzCgkJCQkJCW5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICk7CgkJCQkJCWlmICggbmFtZSBpbiB0aGlzQ2FjaGUgKSB7CgkJCQkJCQluYW1lID0gWyBuYW1lIF07CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQluYW1lID0gbmFtZS5zcGxpdCgiICIpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCWZvciAoIGkgPSAwLCBsID0gbmFtZS5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJZGVsZXRlIHRoaXNDYWNoZVsgbmFtZVtpXSBdOwoJCQkJfQoKCQkJCS8vIElmIHRoZXJlIGlzIG5vIGRhdGEgbGVmdCBpbiB0aGUgY2FjaGUsIHdlIHdhbnQgdG8gY29udGludWUKCQkJCS8vIGFuZCBsZXQgdGhlIGNhY2hlIG9iamVjdCBpdHNlbGYgZ2V0IGRlc3Ryb3llZAoJCQkJaWYgKCAhKCBwdnQgPyBpc0VtcHR5RGF0YU9iamVjdCA6IGpRdWVyeS5pc0VtcHR5T2JqZWN0ICkoIHRoaXNDYWNoZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCgkJaWYgKCAhcHZ0ICkgewoJCQlkZWxldGUgY2FjaGVbIGlkIF0uZGF0YTsKCgkJCS8vIERvbid0IGRlc3Ryb3kgdGhlIHBhcmVudCBjYWNoZSB1bmxlc3MgdGhlIGludGVybmFsIGRhdGEgb2JqZWN0CgkJCS8vIGhhZCBiZWVuIHRoZSBvbmx5IHRoaW5nIGxlZnQgaW4gaXQKCQkJaWYgKCAhaXNFbXB0eURhdGFPYmplY3QoIGNhY2hlWyBpZCBdICkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCS8vIERlc3Ryb3kgdGhlIGNhY2hlCgkJaWYgKCBpc05vZGUgKSB7CgkJCWpRdWVyeS5jbGVhbkRhdGEoIFsgZWxlbSBdLCB0cnVlICk7CgoJCS8vIFVzZSBkZWxldGUgd2hlbiBzdXBwb3J0ZWQgZm9yIGV4cGFuZG9zIG9yIGBjYWNoZWAgaXMgbm90IGEgd2luZG93IHBlciBpc1dpbmRvdyAoIzEwMDgwKQoJCX0gZWxzZSBpZiAoIGpRdWVyeS5zdXBwb3J0LmRlbGV0ZUV4cGFuZG8gfHwgY2FjaGUgIT0gY2FjaGUud2luZG93ICkgewoJCQlkZWxldGUgY2FjaGVbIGlkIF07CgoJCS8vIFdoZW4gYWxsIGVsc2UgZmFpbHMsIG51bGwKCQl9IGVsc2UgewoJCQljYWNoZVsgaWQgXSA9IG51bGw7CgkJfQoJfSwKCgkvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCglfZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7CgkJcmV0dXJuIGpRdWVyeS5kYXRhKCBlbGVtLCBuYW1lLCBkYXRhLCB0cnVlICk7Cgl9LAoKCS8vIEEgbWV0aG9kIGZvciBkZXRlcm1pbmluZyBpZiBhIERPTSBub2RlIGNhbiBoYW5kbGUgdGhlIGRhdGEgZXhwYW5kbwoJYWNjZXB0RGF0YTogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIG5vRGF0YSA9IGVsZW0ubm9kZU5hbWUgJiYgalF1ZXJ5Lm5vRGF0YVsgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCS8vIG5vZGVzIGFjY2VwdCBkYXRhIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkOyByZWplY3Rpb24gY2FuIGJlIGNvbmRpdGlvbmFsCgkJcmV0dXJuICFub0RhdGEgfHwgbm9EYXRhICE9PSB0cnVlICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzc2lkIikgPT09IG5vRGF0YTsKCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWRhdGE6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBwYXJ0cywgcGFydCwgYXR0ciwgbmFtZSwgbCwKCQkJZWxlbSA9IHRoaXNbMF0sCgkJCWkgPSAwLAoJCQlkYXRhID0gbnVsbDsKCgkJLy8gR2V0cyBhbGwgdmFsdWVzCgkJaWYgKCBrZXkgPT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJCWRhdGEgPSBqUXVlcnkuZGF0YSggZWxlbSApOwoKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAicGFyc2VkQXR0cnMiICkgKSB7CgkJCQkJYXR0ciA9IGVsZW0uYXR0cmlidXRlczsKCQkJCQlmb3IgKCBsID0gYXR0ci5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJCW5hbWUgPSBhdHRyW2ldLm5hbWU7CgoJCQkJCQlpZiAoICFuYW1lLmluZGV4T2YoICJkYXRhLSIgKSApIHsKCQkJCQkJCW5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lLnN1YnN0cmluZyg1KSApOwoKCQkJCQkJCWRhdGFBdHRyKCBlbGVtLCBuYW1lLCBkYXRhWyBuYW1lIF0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJwYXJzZWRBdHRycyIsIHRydWUgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGRhdGE7CgkJfQoKCQkvLyBTZXRzIG11bHRpcGxlIHZhbHVlcwoJCWlmICggdHlwZW9mIGtleSA9PT0gIm9iamVjdCIgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGF0YSggdGhpcywga2V5ICk7CgkJCX0pOwoJCX0KCgkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiwgMiApOwoJCXBhcnRzWzFdID0gcGFydHNbMV0gPyAiLiIgKyBwYXJ0c1sxXSA6ICIiOwoJCXBhcnQgPSBwYXJ0c1sxXSArICIhIjsKCgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCWRhdGEgPSB0aGlzLnRyaWdnZXJIYW5kbGVyKCAiZ2V0RGF0YSIgKyBwYXJ0LCBbIHBhcnRzWzBdIF0gKTsKCgkJCQkvLyBUcnkgdG8gZmV0Y2ggYW55IGludGVybmFsbHkgc3RvcmVkIGRhdGEgZmlyc3QKCQkJCWlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0gKSB7CgkJCQkJZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtLCBrZXkgKTsKCQkJCQlkYXRhID0gZGF0YUF0dHIoIGVsZW0sIGtleSwgZGF0YSApOwoJCQkJfQoKCQkJCXJldHVybiBkYXRhID09PSB1bmRlZmluZWQgJiYgcGFydHNbMV0gPwoJCQkJCXRoaXMuZGF0YSggcGFydHNbMF0gKSA6CgkJCQkJZGF0YTsKCQkJfQoKCQkJcGFydHNbMV0gPSB2YWx1ZTsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkoIHRoaXMgKTsKCgkJCQlzZWxmLnRyaWdnZXJIYW5kbGVyKCAic2V0RGF0YSIgKyBwYXJ0LCBwYXJ0cyApOwoJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSwgdmFsdWUgKTsKCQkJCXNlbGYudHJpZ2dlckhhbmRsZXIoICJjaGFuZ2VEYXRhIiArIHBhcnQsIHBhcnRzICk7CgkJCX0pOwoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSwgbnVsbCwgZmFsc2UgKTsKCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGtleSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkucmVtb3ZlRGF0YSggdGhpcywga2V5ICk7CgkJfSk7Cgl9Cn0pOwoKZnVuY3Rpb24gZGF0YUF0dHIoIGVsZW0sIGtleSwgZGF0YSApIHsKCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGludGVybmFsbHksIHRyeSB0byBmZXRjaCBhbnkKCS8vIGRhdGEgZnJvbSB0aGUgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZQoJaWYgKCBkYXRhID09PSB1bmRlZmluZWQgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJdmFyIG5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2UoIHJtdWx0aURhc2gsICItJDEiICkudG9Mb3dlckNhc2UoKTsKCgkJZGF0YSA9IGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CgoJCWlmICggdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICkgewoJCQl0cnkgewoJCQkJZGF0YSA9IGRhdGEgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKCQkJCStkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6CgkJCQlyYnJhY2UudGVzdCggZGF0YSApID8galF1ZXJ5LnBhcnNlSlNPTiggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBzZXQgdGhlIGRhdGEgc28gaXQgaXNuJ3QgY2hhbmdlZCBsYXRlcgoJCQlqUXVlcnkuZGF0YSggZWxlbSwga2V5LCBkYXRhICk7CgoJCX0gZWxzZSB7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoJfQoKCXJldHVybiBkYXRhOwp9CgovLyBjaGVja3MgYSBjYWNoZSBvYmplY3QgZm9yIGVtcHRpbmVzcwpmdW5jdGlvbiBpc0VtcHR5RGF0YU9iamVjdCggb2JqICkgewoJdmFyIG5hbWU7Cglmb3IgKCBuYW1lIGluIG9iaiApIHsKCgkJLy8gaWYgdGhlIHB1YmxpYyBkYXRhIG9iamVjdCBpcyBlbXB0eSwgdGhlIHByaXZhdGUgaXMgc3RpbGwgZW1wdHkKCQlpZiAoIG5hbWUgPT09ICJkYXRhIiAmJiBqUXVlcnkuaXNFbXB0eU9iamVjdCggb2JqW25hbWVdICkgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoIG5hbWUgIT09ICJ0b0pTT04iICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfQoKCXJldHVybiB0cnVlOwp9CmpRdWVyeS5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBkYXRhICkgewoJCXZhciBxdWV1ZTsKCgkJaWYgKCBlbGVtICkgewoJCQl0eXBlID0gKCB0eXBlIHx8ICJmeCIgKSArICJxdWV1ZSI7CgkJCXF1ZXVlID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCB0eXBlICk7CgoJCQkvLyBTcGVlZCB1cCBkZXF1ZXVlIGJ5IGdldHRpbmcgb3V0IHF1aWNrbHkgaWYgdGhpcyBpcyBqdXN0IGEgbG9va3VwCgkJCWlmICggZGF0YSApIHsKCQkJCWlmICggIXF1ZXVlIHx8IGpRdWVyeS5pc0FycmF5KGRhdGEpICkgewoJCQkJCXF1ZXVlID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCB0eXBlLCBqUXVlcnkubWFrZUFycmF5KGRhdGEpICk7CgkJCQl9IGVsc2UgewoJCQkJCXF1ZXVlLnB1c2goIGRhdGEgKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcXVldWUgfHwgW107CgkJfQoJfSwKCglkZXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIGVsZW0sIHR5cGUgKSwKCQkJc3RhcnRMZW5ndGggPSBxdWV1ZS5sZW5ndGgsCgkJCWZuID0gcXVldWUuc2hpZnQoKSwKCQkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sIHR5cGUgKSwKCQkJbmV4dCA9IGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmRlcXVldWUoIGVsZW0sIHR5cGUgKTsKCQkJfTsKCgkJLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbAoJCWlmICggZm4gPT09ICJpbnByb2dyZXNzIiApIHsKCQkJZm4gPSBxdWV1ZS5zaGlmdCgpOwoJCQlzdGFydExlbmd0aC0tOwoJCX0KCgkJaWYgKCBmbiApIHsKCgkJCS8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKCQkJLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAoJCQlpZiAoIHR5cGUgPT09ICJmeCIgKSB7CgkJCQlxdWV1ZS51bnNoaWZ0KCAiaW5wcm9ncmVzcyIgKTsKCQkJfQoKCQkJLy8gY2xlYXIgdXAgdGhlIGxhc3QgcXVldWUgc3RvcCBmdW5jdGlvbgoJCQlkZWxldGUgaG9va3Muc3RvcDsKCQkJZm4uY2FsbCggZWxlbSwgbmV4dCwgaG9va3MgKTsKCQl9CgoJCWlmICggIXN0YXJ0TGVuZ3RoICYmIGhvb2tzICkgewoJCQlob29rcy5lbXB0eS5maXJlKCk7CgkJfQoJfSwKCgkvLyBub3QgaW50ZW5kZWQgZm9yIHB1YmxpYyBjb25zdW1wdGlvbiAtIGdlbmVyYXRlcyBhIHF1ZXVlSG9va3Mgb2JqZWN0LCBvciByZXR1cm5zIHRoZSBjdXJyZW50IG9uZQoJX3F1ZXVlSG9va3M6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXZhciBrZXkgPSB0eXBlICsgInF1ZXVlSG9va3MiOwoJCXJldHVybiBqUXVlcnkuX2RhdGEoIGVsZW0sIGtleSApIHx8IGpRdWVyeS5fZGF0YSggZWxlbSwga2V5LCB7CgkJCWVtcHR5OiBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLmFkZChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtLCB0eXBlICsgInF1ZXVlIiwgdHJ1ZSApOwoJCQkJalF1ZXJ5LnJlbW92ZURhdGEoIGVsZW0sIGtleSwgdHJ1ZSApOwoJCQl9KQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXZhciBzZXR0ZXIgPSAyOwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZGF0YSA9IHR5cGU7CgkJCXR5cGUgPSAiZngiOwoJCQlzZXR0ZXItLTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwoJCX0KCgkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/CgkJCXRoaXMgOgoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCQkvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZngiICYmIHF1ZXVlWzBdICE9PSAiaW5wcm9ncmVzcyIgKSB7CgkJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJCX0KCQkJfSk7Cgl9LAoJZGVxdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQl9KTsKCX0sCgkvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCgkvLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCglkZWxheTogZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7CgkJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewoJCQl2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKCQkJaG9va3Muc3RvcCA9IGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7CgkJCX07CgkJfSk7Cgl9LAoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0sCgkvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCgkvLyBhcmUgZW1wdGllZCAoZnggaXMgdGhlIHR5cGUgYnkgZGVmYXVsdCkKCXByb21pc2U6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CgkJdmFyIHRtcCwKCQkJY291bnQgPSAxLAoJCQlkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQllbGVtZW50cyA9IHRoaXMsCgkJCWkgPSB0aGlzLmxlbmd0aCwKCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhKCAtLWNvdW50ICkgKSB7CgkJCQkJZGVmZXIucmVzb2x2ZVdpdGgoIGVsZW1lbnRzLCBbIGVsZW1lbnRzIF0gKTsKCQkJCX0KCQkJfTsKCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCW9iaiA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXdoaWxlKCBpLS0gKSB7CgkJCXRtcCA9IGpRdWVyeS5fZGF0YSggZWxlbWVudHNbIGkgXSwgdHlwZSArICJxdWV1ZUhvb2tzIiApOwoJCQlpZiAoIHRtcCAmJiB0bXAuZW1wdHkgKSB7CgkJCQljb3VudCsrOwoJCQkJdG1wLmVtcHR5LmFkZCggcmVzb2x2ZSApOwoJCQl9CgkJfQoJCXJlc29sdmUoKTsKCQlyZXR1cm4gZGVmZXIucHJvbWlzZSggb2JqICk7Cgl9Cn0pOwp2YXIgbm9kZUhvb2ssIGJvb2xIb29rLCBmaXhTcGVjaWZpZWQsCglyY2xhc3MgPSAvW1x0XHJcbl0vZywKCXJyZXR1cm4gPSAvXHIvZywKCXJ0eXBlID0gL14oPzpidXR0b258aW5wdXQpJC9pLAoJcmZvY3VzYWJsZSA9IC9eKD86YnV0dG9ufGlucHV0fG9iamVjdHxzZWxlY3R8dGV4dGFyZWEpJC9pLAoJcmNsaWNrYWJsZSA9IC9eYSg/OnJlYXwpJC9pLAoJcmJvb2xlYW4gPSAvXig/OmF1dG9mb2N1c3xhdXRvcGxheXxhc3luY3xjaGVja2VkfGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkfHNlbGVjdGVkKSQvaSwKCWdldFNldEF0dHJpYnV0ZSA9IGpRdWVyeS5zdXBwb3J0LmdldFNldEF0dHJpYnV0ZTsKCmpRdWVyeS5mbi5leHRlbmQoewoJYXR0cjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5yZW1vdmVBdHRyKCB0aGlzLCBuYW1lICk7CgkJfSk7Cgl9LAoKCXByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCglyZW1vdmVQcm9wOiBmdW5jdGlvbiggbmFtZSApIHsKCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCS8vIHRyeS9jYXRjaCBoYW5kbGVzIGNhc2VzIHdoZXJlIElFIGJhbGtzIChzdWNoIGFzIHJlbW92aW5nIGEgcHJvcGVydHkgb24gd2luZG93KQoJCQl0cnkgewoJCQkJdGhpc1sgbmFtZSBdID0gdW5kZWZpbmVkOwoJCQkJZGVsZXRlIHRoaXNbIG5hbWUgXTsKCQkJfSBjYXRjaCggZSApIHt9CgkJfSk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzTmFtZXMsIGksIGwsIGVsZW0sCgkJCXNldENsYXNzLCBjLCBjbDsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLmFkZENsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lKSApOwoJCQl9KTsKCQl9CgoJCWlmICggdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiApIHsKCQkJY2xhc3NOYW1lcyA9IHZhbHVlLnNwbGl0KCBjb3JlX3JzcGFjZSApOwoKCQkJZm9yICggaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCWVsZW0gPSB0aGlzWyBpIF07CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCWlmICggIWVsZW0uY2xhc3NOYW1lICYmIGNsYXNzTmFtZXMubGVuZ3RoID09PSAxICkgewoJCQkJCQllbGVtLmNsYXNzTmFtZSA9IHZhbHVlOwoKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRDbGFzcyA9ICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiOwoKCQkJCQkJZm9yICggYyA9IDAsIGNsID0gY2xhc3NOYW1lcy5sZW5ndGg7IGMgPCBjbDsgYysrICkgewoJCQkJCQkJaWYgKCBzZXRDbGFzcy5pbmRleE9mKCAiICIgKyBjbGFzc05hbWVzWyBjIF0gKyAiICIgKSA8IDAgKSB7CgkJCQkJCQkJc2V0Q2xhc3MgKz0gY2xhc3NOYW1lc1sgYyBdICsgIiAiOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0galF1ZXJ5LnRyaW0oIHNldENsYXNzICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgcmVtb3ZlcywgY2xhc3NOYW1lLCBlbGVtLCBjLCBjbCwgaSwgbDsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lKSApOwoJCQl9KTsKCQl9CgkJaWYgKCAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJcmVtb3ZlcyA9ICggdmFsdWUgfHwgIiIgKS5zcGxpdCggY29yZV9yc3BhY2UgKTsKCgkJCWZvciAoIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQllbGVtID0gdGhpc1sgaSBdOwoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmIGVsZW0uY2xhc3NOYW1lICkgewoKCQkJCQljbGFzc05hbWUgPSAoIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UoIHJjbGFzcywgIiAiICk7CgoJCQkJCS8vIGxvb3Agb3ZlciBlYWNoIGl0ZW0gaW4gdGhlIHJlbW92YWwgbGlzdAoJCQkJCWZvciAoIGMgPSAwLCBjbCA9IHJlbW92ZXMubGVuZ3RoOyBjIDwgY2w7IGMrKyApIHsKCQkJCQkJLy8gUmVtb3ZlIHVudGlsIHRoZXJlIGlzIG5vdGhpbmcgdG8gcmVtb3ZlLAoJCQkJCQl3aGlsZSAoIGNsYXNzTmFtZS5pbmRleE9mKCIgIiArIHJlbW92ZXNbIGMgXSArICIgIikgPj0gMCApIHsKCQkJCQkJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZS5yZXBsYWNlKCAiICIgKyByZW1vdmVzWyBjIF0gKyAiICIgLCAiICIgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQllbGVtLmNsYXNzTmFtZSA9IHZhbHVlID8galF1ZXJ5LnRyaW0oIGNsYXNzTmFtZSApIDogIiI7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oIHZhbHVlLCBzdGF0ZVZhbCApIHsKCQl2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZSwKCQkJaXNCb29sID0gdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiI7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS50b2dnbGVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyB0b2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwoJCQkJdmFyIGNsYXNzTmFtZSwKCQkJCQlpID0gMCwKCQkJCQlzZWxmID0galF1ZXJ5KCB0aGlzICksCgkJCQkJc3RhdGUgPSBzdGF0ZVZhbCwKCQkJCQljbGFzc05hbWVzID0gdmFsdWUuc3BsaXQoIGNvcmVfcnNwYWNlICk7CgoJCQkJd2hpbGUgKCAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pICkgewoJCQkJCS8vIGNoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdAoJCQkJCXN0YXRlID0gaXNCb29sID8gc3RhdGUgOiAhc2VsZi5oYXNDbGFzcyggY2xhc3NOYW1lICk7CgkJCQkJc2VsZlsgc3RhdGUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIiBdKCBjbGFzc05hbWUgKTsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoIHR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGUgPT09ICJib29sZWFuIiApIHsKCQkJCWlmICggdGhpcy5jbGFzc05hbWUgKSB7CgkJCQkJLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAoJCQkJCWpRdWVyeS5fZGF0YSggdGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSApOwoJCQkJfQoKCQkJCS8vIHRvZ2dsZSB3aG9sZSBjbGFzc05hbWUKCQkJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gIiIgOiBqUXVlcnkuX2RhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiOwoJCQl9CgkJfSk7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiLAoJCQlpID0gMCwKCQkJbCA9IHRoaXMubGVuZ3RoOwoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJaWYgKCB0aGlzW2ldLm5vZGVUeXBlID09PSAxICYmICgiICIgKyB0aGlzW2ldLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShyY2xhc3MsICIgIikuaW5kZXhPZiggY2xhc3NOYW1lICkgPj0gMCApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXZhbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBob29rcywgcmV0LCBpc0Z1bmN0aW9uLAoJCQllbGVtID0gdGhpc1swXTsKCgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJaWYgKCBlbGVtICkgewoJCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIGVsZW0udHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCAidmFsdWUiICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHJldDsKCQkJCX0KCgkJCQlyZXQgPSBlbGVtLnZhbHVlOwoKCQkJCXJldHVybiB0eXBlb2YgcmV0ID09PSAic3RyaW5nIiA/CgkJCQkJLy8gaGFuZGxlIG1vc3QgY29tbW9uIHN0cmluZyBjYXNlcwoJCQkJCXJldC5yZXBsYWNlKHJyZXR1cm4sICIiKSA6CgkJCQkJLy8gaGFuZGxlIGNhc2VzIHdoZXJlIHZhbHVlIGlzIG51bGwvdW5kZWYgb3IgbnVtYmVyCgkJCQkJcmV0ID09IG51bGwgPyAiIiA6IHJldDsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgdmFsLAoJCQkJc2VsZiA9IGpRdWVyeSh0aGlzKTsKCgkJCWlmICggdGhpcy5ub2RlVHlwZSAhPT0gMSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBpc0Z1bmN0aW9uICkgewoJCQkJdmFsID0gdmFsdWUuY2FsbCggdGhpcywgaSwgc2VsZi52YWwoKSApOwoJCQl9IGVsc2UgewoJCQkJdmFsID0gdmFsdWU7CgkJCX0KCgkJCS8vIFRyZWF0IG51bGwvdW5kZWZpbmVkIGFzICIiOyBjb252ZXJ0IG51bWJlcnMgdG8gc3RyaW5nCgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSAiIjsKCQkJfSBlbHNlIGlmICggdHlwZW9mIHZhbCA9PT0gIm51bWJlciIgKSB7CgkJCQl2YWwgKz0gIiI7CgkJCX0gZWxzZSBpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWwgKSApIHsKCQkJCXZhbCA9IGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAoIHZhbHVlICkgewoJCQkJCXJldHVybiB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiOwoJCQkJfSk7CgkJCX0KCgkJCWhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyB0aGlzLnR5cGUgXSB8fCBqUXVlcnkudmFsSG9va3NbIHRoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKCQkJLy8gSWYgc2V0IHJldHVybnMgdW5kZWZpbmVkLCBmYWxsIGJhY2sgdG8gbm9ybWFsIHNldHRpbmcKCQkJaWYgKCAhaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgaG9va3Muc2V0KCB0aGlzLCB2YWwsICJ2YWx1ZSIgKSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy52YWx1ZSA9IHZhbDsKCQkJfQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5leHRlbmQoewoJdmFsSG9va3M6IHsKCQlvcHRpb246IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCS8vIGF0dHJpYnV0ZXMudmFsdWUgaXMgdW5kZWZpbmVkIGluIEJsYWNrYmVycnkgNC43IGJ1dAoJCQkJLy8gdXNlcyAudmFsdWUuIFNlZSAjNjkzMgoJCQkJdmFyIHZhbCA9IGVsZW0uYXR0cmlidXRlcy52YWx1ZTsKCQkJCXJldHVybiAhdmFsIHx8IHZhbC5zcGVjaWZpZWQgPyBlbGVtLnZhbHVlIDogZWxlbS50ZXh0OwoJCQl9CgkJfSwKCQlzZWxlY3Q6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciB2YWx1ZSwgb3B0aW9uLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsCgkJCQkJb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSIgfHwgaW5kZXggPCAwLAoJCQkJCXZhbHVlcyA9IG9uZSA/IG51bGwgOiBbXSwKCQkJCQltYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aCwKCQkJCQlpID0gaW5kZXggPCAwID8KCQkJCQkJbWF4IDoKCQkJCQkJb25lID8gaW5kZXggOiAwOwoKCQkJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKCQkJCWZvciAoIDsgaSA8IG1heDsgaSsrICkgewoJCQkJCW9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJLy8gb2xkSUUgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCgkJCQkJaWYgKCAoIG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCApICYmCgkJCQkJCQkvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCgkJCQkJCQkoIGpRdWVyeS5zdXBwb3J0Lm9wdERpc2FibGVkID8gIW9wdGlvbi5kaXNhYmxlZCA6IG9wdGlvbi5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikgPT09IG51bGwgKSAmJgoJCQkJCQkJKCAhb3B0aW9uLnBhcmVudE5vZGUuZGlzYWJsZWQgfHwgIWpRdWVyeS5ub2RlTmFtZSggb3B0aW9uLnBhcmVudE5vZGUsICJvcHRncm91cCIgKSApICkgewoKCQkJCQkJLy8gR2V0IHRoZSBzcGVjaWZpYyB2YWx1ZSBmb3IgdGhlIG9wdGlvbgoJCQkJCQl2YWx1ZSA9IGpRdWVyeSggb3B0aW9uICkudmFsKCk7CgoJCQkJCQkvLyBXZSBkb24ndCBuZWVkIGFuIGFycmF5IGZvciBvbmUgc2VsZWN0cwoJCQkJCQlpZiAoIG9uZSApIHsKCQkJCQkJCXJldHVybiB2YWx1ZTsKCQkJCQkJfQoKCQkJCQkJLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKCQkJCQkJdmFsdWVzLnB1c2goIHZhbHVlICk7CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiB2YWx1ZXM7CgkJCX0sCgoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCXZhciB2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KCB2YWx1ZSApOwoKCQkJCWpRdWVyeShlbGVtKS5maW5kKCJvcHRpb24iKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KHRoaXMpLnZhbCgpLCB2YWx1ZXMgKSA+PSAwOwoJCQkJfSk7CgoJCQkJaWYgKCAhdmFsdWVzLmxlbmd0aCApIHsKCQkJCQllbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKCQkJCX0KCQkJCXJldHVybiB2YWx1ZXM7CgkJCX0KCQl9Cgl9LAoKCS8vIFVudXNlZCBpbiAxLjgsIGxlZnQgaW4gc28gYXR0ckZuLXN0YWJiZXJzIHdvbid0IGRpZTsgcmVtb3ZlIGluIDEuOQoJYXR0ckZuOiB7fSwKCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIHBhc3MgKSB7CgkJdmFyIHJldCwgaG9va3MsIG5vdHhtbCwKCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCQkvLyBkb24ndCBnZXQvc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYXNzICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBqUXVlcnkuZm5bIG5hbWUgXSApICkgewoJCQlyZXR1cm4galF1ZXJ5KCBlbGVtIClbIG5hbWUgXSggdmFsdWUgKTsKCQl9CgoJCS8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4galF1ZXJ5LnByb3AoIGVsZW0sIG5hbWUsIHZhbHVlICk7CgkJfQoKCQlub3R4bWwgPSBuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKCBlbGVtICk7CgoJCS8vIEFsbCBhdHRyaWJ1dGVzIGFyZSBsb3dlcmNhc2UKCQkvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCgkJaWYgKCBub3R4bWwgKSB7CgkJCW5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CgkJCWhvb2tzID0galF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdIHx8ICggcmJvb2xlYW4udGVzdCggbmFtZSApID8gYm9vbEhvb2sgOiBub2RlSG9vayApOwoJCX0KCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsKCQkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7CgkJCQlyZXR1cm47CgoJCQl9IGVsc2UgaWYgKCBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiBub3R4bWwgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIHZhbHVlICsgIiIgKTsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfQoKCQl9IGVsc2UgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiBub3R4bWwgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgbmFtZSApKSAhPT0gbnVsbCApIHsKCQkJcmV0dXJuIHJldDsKCgkJfSBlbHNlIHsKCgkJCXJldCA9IGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CgoJCQkvLyBOb24tZXhpc3RlbnQgYXR0cmlidXRlcyByZXR1cm4gbnVsbCwgd2Ugbm9ybWFsaXplIHRvIHVuZGVmaW5lZAoJCQlyZXR1cm4gcmV0ID09PSBudWxsID8KCQkJCXVuZGVmaW5lZCA6CgkJCQlyZXQ7CgkJfQoJfSwKCglyZW1vdmVBdHRyOiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJdmFyIHByb3BOYW1lLCBhdHRyTmFtZXMsIG5hbWUsIGlzQm9vbCwKCQkJaSA9IDA7CgoJCWlmICggdmFsdWUgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJCWF0dHJOYW1lcyA9IHZhbHVlLnNwbGl0KCBjb3JlX3JzcGFjZSApOwoKCQkJZm9yICggOyBpIDwgYXR0ck5hbWVzLmxlbmd0aDsgaSsrICkgewoJCQkJbmFtZSA9IGF0dHJOYW1lc1sgaSBdOwoKCQkJCWlmICggbmFtZSApIHsKCQkJCQlwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJCQlpc0Jvb2wgPSByYm9vbGVhbi50ZXN0KCBuYW1lICk7CgoJCQkJCS8vIFNlZSAjOTY5OSBmb3IgZXhwbGFuYXRpb24gb2YgdGhpcyBhcHByb2FjaCAoc2V0dGluZyBmaXJzdCwgdGhlbiByZW1vdmFsKQoJCQkJCS8vIERvIG5vdCBkbyB0aGlzIGZvciBib29sZWFuIGF0dHJpYnV0ZXMgKHNlZSAjMTA4NzApCgkJCQkJaWYgKCAhaXNCb29sICkgewoJCQkJCQlqUXVlcnkuYXR0ciggZWxlbSwgbmFtZSwgIiIgKTsKCQkJCQl9CgkJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIGdldFNldEF0dHJpYnV0ZSA/IG5hbWUgOiBwcm9wTmFtZSApOwoKCQkJCQkvLyBTZXQgY29ycmVzcG9uZGluZyBwcm9wZXJ0eSB0byBmYWxzZSBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCgkJCQkJaWYgKCBpc0Jvb2wgJiYgcHJvcE5hbWUgaW4gZWxlbSApIHsKCQkJCQkJZWxlbVsgcHJvcE5hbWUgXSA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0sCgoJYXR0ckhvb2tzOiB7CgkJdHlwZTogewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCS8vIFdlIGNhbid0IGFsbG93IHRoZSB0eXBlIHByb3BlcnR5IHRvIGJlIGNoYW5nZWQgKHNpbmNlIGl0IGNhdXNlcyBwcm9ibGVtcyBpbiBJRSkKCQkJCWlmICggcnR5cGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQlqUXVlcnkuZXJyb3IoICJ0eXBlIHByb3BlcnR5IGNhbid0IGJlIGNoYW5nZWQiICk7CgkJCQl9IGVsc2UgaWYgKCAhalF1ZXJ5LnN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImlucHV0IikgKSB7CgkJCQkJLy8gU2V0dGluZyB0aGUgdHlwZSBvbiBhIHJhZGlvIGJ1dHRvbiBhZnRlciB0aGUgdmFsdWUgcmVzZXRzIHRoZSB2YWx1ZSBpbiBJRTYtOQoJCQkJCS8vIFJlc2V0IHZhbHVlIHRvIGl0J3MgZGVmYXVsdCBpbiBjYXNlIHR5cGUgaXMgc2V0IGFmdGVyIHZhbHVlCgkJCQkJLy8gVGhpcyBpcyBmb3IgZWxlbWVudCBjcmVhdGlvbgoJCQkJCXZhciB2YWwgPSBlbGVtLnZhbHVlOwoJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAidHlwZSIsIHZhbHVlICk7CgkJCQkJaWYgKCB2YWwgKSB7CgkJCQkJCWVsZW0udmFsdWUgPSB2YWw7CgkJCQkJfQoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0sCgkJLy8gVXNlIHRoZSB2YWx1ZSBwcm9wZXJ0eSBmb3IgYmFjayBjb21wYXQKCQkvLyBVc2UgdGhlIG5vZGVIb29rIGZvciBidXR0b24gZWxlbWVudHMgaW4gSUU2LzcgKCMxOTU0KQoJCXZhbHVlOiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJCQlpZiAoIG5vZGVIb29rICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImJ1dHRvbiIgKSApIHsKCQkJCQlyZXR1cm4gbm9kZUhvb2suZ2V0KCBlbGVtLCBuYW1lICk7CgkJCQl9CgkJCQlyZXR1cm4gbmFtZSBpbiBlbGVtID8KCQkJCQllbGVtLnZhbHVlIDoKCQkJCQludWxsOwoJCQl9LAoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQkJCWlmICggbm9kZUhvb2sgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYnV0dG9uIiApICkgewoJCQkJCXJldHVybiBub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICk7CgkJCQl9CgkJCQkvLyBEb2VzIG5vdCByZXR1cm4gc28gdGhhdCBzZXRBdHRyaWJ1dGUgaXMgYWxzbyB1c2VkCgkJCQllbGVtLnZhbHVlID0gdmFsdWU7CgkJCX0KCQl9Cgl9LAoKCXByb3BGaXg6IHsKCQl0YWJpbmRleDogInRhYkluZGV4IiwKCQlyZWFkb25seTogInJlYWRPbmx5IiwKCQkiZm9yIjogImh0bWxGb3IiLAoJCSJjbGFzcyI6ICJjbGFzc05hbWUiLAoJCW1heGxlbmd0aDogIm1heExlbmd0aCIsCgkJY2VsbHNwYWNpbmc6ICJjZWxsU3BhY2luZyIsCgkJY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCgkJcm93c3BhbjogInJvd1NwYW4iLAoJCWNvbHNwYW46ICJjb2xTcGFuIiwKCQl1c2VtYXA6ICJ1c2VNYXAiLAoJCWZyYW1lYm9yZGVyOiAiZnJhbWVCb3JkZXIiLAoJCWNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIKCX0sCgoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCXZhciByZXQsIGhvb2tzLCBub3R4bWwsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCgkJaWYgKCBub3R4bWwgKSB7CgkJCS8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKCQkJbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzWyBuYW1lIF07CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJcmV0dXJuICggZWxlbVsgbmFtZSBdID0gdmFsdWUgKTsKCQkJfQoKCQl9IGVsc2UgewoJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgKSB7CgkJCQlyZXR1cm4gcmV0OwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBlbGVtWyBuYW1lIF07CgkJCX0KCQl9Cgl9LAoKCXByb3BIb29rczogewoJCXRhYkluZGV4OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkvLyBlbGVtLnRhYkluZGV4IGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuIGl0IGhhc24ndCBiZWVuIGV4cGxpY2l0bHkgc2V0CgkJCQkvLyBodHRwOi8vZmx1aWRwcm9qZWN0Lm9yZy9ibG9nLzIwMDgvMDEvMDkvZ2V0dGluZy1zZXR0aW5nLWFuZC1yZW1vdmluZy10YWJpbmRleC12YWx1ZXMtd2l0aC1qYXZhc2NyaXB0LwoJCQkJdmFyIGF0dHJpYnV0ZU5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoInRhYmluZGV4Iik7CgoJCQkJcmV0dXJuIGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQgPwoJCQkJCXBhcnNlSW50KCBhdHRyaWJ1dGVOb2RlLnZhbHVlLCAxMCApIDoKCQkJCQlyZm9jdXNhYmxlLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSB8fCByY2xpY2thYmxlLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJiBlbGVtLmhyZWYgPwoJCQkJCQkwIDoKCQkJCQkJdW5kZWZpbmVkOwoJCQl9CgkJfQoJfQp9KTsKCi8vIEhvb2sgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwpib29sSG9vayA9IHsKCWdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJLy8gQWxpZ24gYm9vbGVhbiBhdHRyaWJ1dGVzIHdpdGggY29ycmVzcG9uZGluZyBwcm9wZXJ0aWVzCgkJLy8gRmFsbCBiYWNrIHRvIGF0dHJpYnV0ZSBwcmVzZW5jZSB3aGVyZSBzb21lIGJvb2xlYW5zIGFyZSBub3Qgc3VwcG9ydGVkCgkJdmFyIGF0dHJOb2RlLAoJCQlwcm9wZXJ0eSA9IGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lICk7CgkJcmV0dXJuIHByb3BlcnR5ID09PSB0cnVlIHx8IHR5cGVvZiBwcm9wZXJ0eSAhPT0gImJvb2xlYW4iICYmICggYXR0ck5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkgKSAmJiBhdHRyTm9kZS5ub2RlVmFsdWUgIT09IGZhbHNlID8KCQkJbmFtZS50b0xvd2VyQ2FzZSgpIDoKCQkJdW5kZWZpbmVkOwoJfSwKCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCXZhciBwcm9wTmFtZTsKCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQoJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoJCX0gZWxzZSB7CgkJCS8vIHZhbHVlIGlzIHRydWUgc2luY2Ugd2Uga25vdyBhdCB0aGlzIHBvaW50IGl0J3MgdHlwZSBib29sZWFuIGFuZCBub3QgZmFsc2UKCQkJLy8gU2V0IGJvb2xlYW4gYXR0cmlidXRlcyB0byB0aGUgc2FtZSBuYW1lIGFuZCBzZXQgdGhlIERPTSBwcm9wZXJ0eQoJCQlwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJaWYgKCBwcm9wTmFtZSBpbiBlbGVtICkgewoJCQkJLy8gT25seSBzZXQgdGhlIElETCBzcGVjaWZpY2FsbHkgaWYgaXQgYWxyZWFkeSBleGlzdHMgb24gdGhlIGVsZW1lbnQKCQkJCWVsZW1bIHByb3BOYW1lIF0gPSB0cnVlOwoJCQl9CgoJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgbmFtZS50b0xvd2VyQ2FzZSgpICk7CgkJfQoJCXJldHVybiBuYW1lOwoJfQp9OwoKLy8gSUU2LzcgZG8gbm90IHN1cHBvcnQgZ2V0dGluZy9zZXR0aW5nIHNvbWUgYXR0cmlidXRlcyB3aXRoIGdldC9zZXRBdHRyaWJ1dGUKaWYgKCAhZ2V0U2V0QXR0cmlidXRlICkgewoKCWZpeFNwZWNpZmllZCA9IHsKCQluYW1lOiB0cnVlLAoJCWlkOiB0cnVlLAoJCWNvb3JkczogdHJ1ZQoJfTsKCgkvLyBVc2UgdGhpcyBmb3IgYW55IGF0dHJpYnV0ZSBpbiBJRTYvNwoJLy8gVGhpcyBmaXhlcyBhbG1vc3QgZXZlcnkgSUU2LzcgaXNzdWUKCW5vZGVIb29rID0galF1ZXJ5LnZhbEhvb2tzLmJ1dHRvbiA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCQl2YXIgcmV0OwoJCQlyZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKCQkJcmV0dXJuIHJldCAmJiAoIGZpeFNwZWNpZmllZFsgbmFtZSBdID8gcmV0LnZhbHVlICE9PSAiIiA6IHJldC5zcGVjaWZpZWQgKSA/CgkJCQlyZXQudmFsdWUgOgoJCQkJdW5kZWZpbmVkOwoJCX0sCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CgkJCS8vIFNldCB0aGUgZXhpc3Rpbmcgb3IgY3JlYXRlIGEgbmV3IGF0dHJpYnV0ZSBub2RlCgkJCXZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKCQkJaWYgKCAhcmV0ICkgewoJCQkJcmV0ID0gZG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKCBuYW1lICk7CgkJCQllbGVtLnNldEF0dHJpYnV0ZU5vZGUoIHJldCApOwoJCQl9CgkJCXJldHVybiAoIHJldC52YWx1ZSA9IHZhbHVlICsgIiIgKTsKCQl9Cgl9OwoKCS8vIFNldCB3aWR0aCBhbmQgaGVpZ2h0IHRvIGF1dG8gaW5zdGVhZCBvZiAwIG9uIGVtcHR5IHN0cmluZyggQnVnICM4MTUwICkKCS8vIFRoaXMgaXMgZm9yIHJlbW92YWxzCglqUXVlcnkuZWFjaChbICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCWpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSwgewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICggdmFsdWUgPT09ICIiICkgewoJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCAiYXV0byIgKTsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9CgkJCX0KCQl9KTsKCX0pOwoKCS8vIFNldCBjb250ZW50ZWRpdGFibGUgdG8gZmFsc2Ugb24gcmVtb3ZhbHMoIzEwNDI5KQoJLy8gU2V0dGluZyB0byBlbXB0eSBzdHJpbmcgdGhyb3dzIGFuIGVycm9yIGFzIGFuIGludmFsaWQgdmFsdWUKCWpRdWVyeS5hdHRySG9va3MuY29udGVudGVkaXRhYmxlID0gewoJCWdldDogbm9kZUhvb2suZ2V0LAoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCQlpZiAoIHZhbHVlID09PSAiIiApIHsKCQkJCXZhbHVlID0gImZhbHNlIjsKCQkJfQoJCQlub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICk7CgkJfQoJfTsKfQoKCi8vIFNvbWUgYXR0cmlidXRlcyByZXF1aXJlIGEgc3BlY2lhbCBjYWxsIG9uIElFCmlmICggIWpRdWVyeS5zdXBwb3J0LmhyZWZOb3JtYWxpemVkICkgewoJalF1ZXJ5LmVhY2goWyAiaHJlZiIsICJzcmMiLCAid2lkdGgiLCAiaGVpZ2h0IiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCQlqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0sIHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSwgMiApOwoJCQkJcmV0dXJuIHJldCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKCQkJfQoJCX0pOwoJfSk7Cn0KCmlmICggIWpRdWVyeS5zdXBwb3J0LnN0eWxlICkgewoJalF1ZXJ5LmF0dHJIb29rcy5zdHlsZSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBSZXR1cm4gdW5kZWZpbmVkIGluIHRoZSBjYXNlIG9mIGVtcHR5IHN0cmluZwoJCQkvLyBOb3JtYWxpemUgdG8gbG93ZXJjYXNlIHNpbmNlIElFIHVwcGVyY2FzZXMgY3NzIHByb3BlcnR5IG5hbWVzCgkJCXJldHVybiBlbGVtLnN0eWxlLmNzc1RleHQudG9Mb3dlckNhc2UoKSB8fCB1bmRlZmluZWQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJcmV0dXJuICggZWxlbS5zdHlsZS5jc3NUZXh0ID0gdmFsdWUgKyAiIiApOwoJCX0KCX07Cn0KCi8vIFNhZmFyaSBtaXMtcmVwb3J0cyB0aGUgZGVmYXVsdCBzZWxlY3RlZCBwcm9wZXJ0eSBvZiBhbiBvcHRpb24KLy8gQWNjZXNzaW5nIHRoZSBwYXJlbnQncyBzZWxlY3RlZEluZGV4IHByb3BlcnR5IGZpeGVzIGl0CmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkICkgewoJalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IGpRdWVyeS5leHRlbmQoIGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQsIHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoKCQkJaWYgKCBwYXJlbnQgKSB7CgkJCQlwYXJlbnQuc2VsZWN0ZWRJbmRleDsKCgkJCQkvLyBNYWtlIHN1cmUgdGhhdCBpdCBhbHNvIHdvcmtzIHdpdGggb3B0Z3JvdXBzLCBzZWUgIzU3MDEKCQkJCWlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CgkJCQkJcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9KTsKfQoKLy8gSUU2LzcgY2FsbCBlbmN0eXBlIGVuY29kaW5nCmlmICggIWpRdWVyeS5zdXBwb3J0LmVuY3R5cGUgKSB7CglqUXVlcnkucHJvcEZpeC5lbmN0eXBlID0gImVuY29kaW5nIjsKfQoKLy8gUmFkaW9zIGFuZCBjaGVja2JveGVzIGdldHRlci9zZXR0ZXIKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hlY2tPbiApIHsKCWpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbigpIHsKCQlqUXVlcnkudmFsSG9va3NbIHRoaXMgXSA9IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBpbiBXZWJraXQgIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKCQkJfQoJCX07Cgl9KTsKfQpqUXVlcnkuZWFjaChbICJyYWRpbyIsICJjaGVja2JveCIgXSwgZnVuY3Rpb24oKSB7CglqUXVlcnkudmFsSG9va3NbIHRoaXMgXSA9IGpRdWVyeS5leHRlbmQoIGpRdWVyeS52YWxIb29rc1sgdGhpcyBdLCB7CgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7CgkJCQlyZXR1cm4gKCBlbGVtLmNoZWNrZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KGVsZW0pLnZhbCgpLCB2YWx1ZSApID49IDAgKTsKCQkJfQoJCX0KCX0pOwp9KTsKdmFyIHJmb3JtRWxlbXMgPSAvXig/OnRleHRhcmVhfGlucHV0fHNlbGVjdCkkL2ksCglydHlwZW5hbWVzcGFjZSA9IC9eKFteXC5dKnwpKD86XC4oLispfCkkLywKCXJob3ZlckhhY2sgPSAvKD86Xnxccylob3ZlcihcLlxTK3wpXGIvLAoJcmtleUV2ZW50ID0gL15rZXkvLAoJcm1vdXNlRXZlbnQgPSAvXig/Om1vdXNlfGNvbnRleHRtZW51KXxjbGljay8sCglyZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKCWhvdmVySGFjayA9IGZ1bmN0aW9uKCBldmVudHMgKSB7CgkJcmV0dXJuIGpRdWVyeS5ldmVudC5zcGVjaWFsLmhvdmVyID8gZXZlbnRzIDogZXZlbnRzLnJlcGxhY2UoIHJob3ZlckhhY2ssICJtb3VzZWVudGVyJDEgbW91c2VsZWF2ZSQxIiApOwoJfTsKCi8qCiAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICovCmpRdWVyeS5ldmVudCA9IHsKCglhZGQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlcywgaGFuZGxlciwgZGF0YSwgc2VsZWN0b3IgKSB7CgoJCXZhciBlbGVtRGF0YSwgZXZlbnRIYW5kbGUsIGV2ZW50cywKCQkJdCwgdG5zLCB0eXBlLCBuYW1lc3BhY2VzLCBoYW5kbGVPYmosCgkJCWhhbmRsZU9iakluLCBoYW5kbGVycywgc3BlY2lhbDsKCgkJLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChhbGxvdyBwbGFpbiBvYmplY3RzIHRobykKCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhdHlwZXMgfHwgIWhhbmRsZXIgfHwgIShlbGVtRGF0YSA9IGpRdWVyeS5fZGF0YSggZWxlbSApKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCgkJaWYgKCBoYW5kbGVyLmhhbmRsZXIgKSB7CgkJCWhhbmRsZU9iakluID0gaGFuZGxlcjsKCQkJaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CgkJCXNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKCQlpZiAoICFoYW5kbGVyLmd1aWQgKSB7CgkJCWhhbmRsZXIuZ3VpZCA9IGpRdWVyeS5ndWlkKys7CgkJfQoKCQkvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CgkJZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzOwoJCWlmICggIWV2ZW50cyApIHsKCQkJZWxlbURhdGEuZXZlbnRzID0gZXZlbnRzID0ge307CgkJfQoJCWV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlOwoJCWlmICggIWV2ZW50SGFuZGxlICkgewoJCQllbGVtRGF0YS5oYW5kbGUgPSBldmVudEhhbmRsZSA9IGZ1bmN0aW9uKCBlICkgewoJCQkJLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiAoIWUgfHwgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCAhPT0gZS50eXBlKSA/CgkJCQkJalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmFwcGx5KCBldmVudEhhbmRsZS5lbGVtLCBhcmd1bWVudHMgKSA6CgkJCQkJdW5kZWZpbmVkOwoJCQl9OwoJCQkvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZm4gdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggSUUgbm9uLW5hdGl2ZSBldmVudHMKCQkJZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJLy8galF1ZXJ5KC4uLikuYmluZCgibW91c2VvdmVyIG1vdXNlb3V0IiwgZm4pOwoJCXR5cGVzID0galF1ZXJ5LnRyaW0oIGhvdmVySGFjayh0eXBlcykgKS5zcGxpdCggIiAiICk7CgkJZm9yICggdCA9IDA7IHQgPCB0eXBlcy5sZW5ndGg7IHQrKyApIHsKCgkJCXRucyA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWMoIHR5cGVzW3RdICkgfHwgW107CgkJCXR5cGUgPSB0bnNbMV07CgkJCW5hbWVzcGFjZXMgPSAoIHRuc1syXSB8fCAiIiApLnNwbGl0KCAiLiIgKS5zb3J0KCk7CgoJCQkvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBJZiBzZWxlY3RvciBkZWZpbmVkLCBkZXRlcm1pbmUgc3BlY2lhbCBldmVudCBhcGkgdHlwZSwgb3RoZXJ3aXNlIGdpdmVuIHR5cGUKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoKCQkJLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCS8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCgkJCWhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewoJCQkJdHlwZTogdHlwZSwKCQkJCW9yaWdUeXBlOiB0bnNbMV0sCgkJCQlkYXRhOiBkYXRhLAoJCQkJaGFuZGxlcjogaGFuZGxlciwKCQkJCWd1aWQ6IGhhbmRsZXIuZ3VpZCwKCQkJCXNlbGVjdG9yOiBzZWxlY3RvciwKCQkJCW5lZWRzQ29udGV4dDogc2VsZWN0b3IgJiYgalF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICksCgkJCQluYW1lc3BhY2U6IG5hbWVzcGFjZXMuam9pbigiLiIpCgkJCX0sIGhhbmRsZU9iakluICk7CgoJCQkvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlIGlmIHdlJ3JlIHRoZSBmaXJzdAoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdOwoJCQlpZiAoICFoYW5kbGVycyApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCQkJCWhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIvYXR0YWNoRXZlbnQgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJaWYgKCAhc3BlY2lhbC5zZXR1cCB8fCBzcGVjaWFsLnNldHVwLmNhbGwoIGVsZW0sIGRhdGEsIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCS8vIEJpbmQgdGhlIGdsb2JhbCBldmVudCBoYW5kbGVyIHRvIHRoZSBlbGVtZW50CgkJCQkJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJCQkJCWVsZW0uYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgZXZlbnRIYW5kbGUsIGZhbHNlICk7CgoJCQkJCX0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7CgkJCQkJCWVsZW0uYXR0YWNoRXZlbnQoICJvbiIgKyB0eXBlLCBldmVudEhhbmRsZSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKCBzcGVjaWFsLmFkZCApIHsKCQkJCXNwZWNpYWwuYWRkLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoKCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CgkJCQkJaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKCQkJCX0KCQkJfQoKCQkJLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWhhbmRsZXJzLnNwbGljZSggaGFuZGxlcnMuZGVsZWdhdGVDb3VudCsrLCAwLCBoYW5kbGVPYmogKTsKCQkJfSBlbHNlIHsKCQkJCWhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOwoJCQl9CgoJCQkvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCgkJCWpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSA9IHRydWU7CgkJfQoKCQkvLyBOdWxsaWZ5IGVsZW0gdG8gcHJldmVudCBtZW1vcnkgbGVha3MgaW4gSUUKCQllbGVtID0gbnVsbDsKCX0sCgoJZ2xvYmFsOiB7fSwKCgkvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMgKSB7CgoJCXZhciB0LCB0bnMsIHR5cGUsIG9yaWdUeXBlLCBuYW1lc3BhY2VzLCBvcmlnQ291bnQsCgkJCWosIGV2ZW50cywgc3BlY2lhbCwgZXZlbnRUeXBlLCBoYW5kbGVPYmosCgkJCWVsZW1EYXRhID0galF1ZXJ5Lmhhc0RhdGEoIGVsZW0gKSAmJiBqUXVlcnkuX2RhdGEoIGVsZW0gKTsKCgkJaWYgKCAhZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCgkJdHlwZXMgPSBqUXVlcnkudHJpbSggaG92ZXJIYWNrKCB0eXBlcyB8fCAiIiApICkuc3BsaXQoIiAiKTsKCQlmb3IgKCB0ID0gMDsgdCA8IHR5cGVzLmxlbmd0aDsgdCsrICkgewoJCQl0bnMgPSBydHlwZW5hbWVzcGFjZS5leGVjKCB0eXBlc1t0XSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bnNbMV07CgkJCW5hbWVzcGFjZXMgPSB0bnNbMl07CgoJCQkvLyBVbmJpbmQgYWxsIGV2ZW50cyAob24gdGhpcyBuYW1lc3BhY2UsIGlmIHByb3ZpZGVkKSBmb3IgdGhlIGVsZW1lbnQKCQkJaWYgKCAhdHlwZSApIHsKCQkJCWZvciAoIHR5cGUgaW4gZXZlbnRzICkgewoJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKyB0eXBlc1sgdCBdLCBoYW5kbGVyLCBzZWxlY3RvciwgdHJ1ZSApOwoJCQkJfQoJCQkJY29udGludWU7CgkJCX0KCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoJCQl0eXBlID0gKCBzZWxlY3Rvcj8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlICkgfHwgdHlwZTsKCQkJZXZlbnRUeXBlID0gZXZlbnRzWyB0eXBlIF0gfHwgW107CgkJCW9yaWdDb3VudCA9IGV2ZW50VHlwZS5sZW5ndGg7CgkJCW5hbWVzcGFjZXMgPSBuYW1lc3BhY2VzID8gbmV3IFJlZ0V4cCgiKF58XFwuKSIgKyBuYW1lc3BhY2VzLnNwbGl0KCIuIikuc29ydCgpLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIikgOiBudWxsOwoKCQkJLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwoJCQlmb3IgKCBqID0gMDsgaiA8IGV2ZW50VHlwZS5sZW5ndGg7IGorKyApIHsKCQkJCWhhbmRsZU9iaiA9IGV2ZW50VHlwZVsgaiBdOwoKCQkJCWlmICggKCBtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlICkgJiYKCQkJCQkgKCAhaGFuZGxlciB8fCBoYW5kbGVyLmd1aWQgPT09IGhhbmRsZU9iai5ndWlkICkgJiYKCQkJCQkgKCAhbmFtZXNwYWNlcyB8fCBuYW1lc3BhY2VzLnRlc3QoIGhhbmRsZU9iai5uYW1lc3BhY2UgKSApICYmCgkJCQkJICggIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09ICIqKiIgJiYgaGFuZGxlT2JqLnNlbGVjdG9yICkgKSB7CgkJCQkJZXZlbnRUeXBlLnNwbGljZSggai0tLCAxICk7CgoJCQkJCWlmICggaGFuZGxlT2JqLnNlbGVjdG9yICkgewoJCQkJCQlldmVudFR5cGUuZGVsZWdhdGVDb3VudC0tOwoJCQkJCX0KCQkJCQlpZiAoIHNwZWNpYWwucmVtb3ZlICkgewoJCQkJCQlzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKCQkJLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCgkJCWlmICggZXZlbnRUeXBlLmxlbmd0aCA9PT0gMCAmJiBvcmlnQ291bnQgIT09IGV2ZW50VHlwZS5sZW5ndGggKSB7CgkJCQlpZiAoICFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbCggZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7CgkJCQl9CgoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgewoJCQlkZWxldGUgZWxlbURhdGEuaGFuZGxlOwoKCQkJLy8gcmVtb3ZlRGF0YSBhbHNvIGNoZWNrcyBmb3IgZW1wdGluZXNzIGFuZCBjbGVhcnMgdGhlIGV4cGFuZG8gaWYgZW1wdHkKCQkJLy8gc28gdXNlIGl0IGluc3RlYWQgb2YgZGVsZXRlCgkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtLCAiZXZlbnRzIiwgdHJ1ZSApOwoJCX0KCX0sCgoJLy8gRXZlbnRzIHRoYXQgYXJlIHNhZmUgdG8gc2hvcnQtY2lyY3VpdCBpZiBubyBoYW5kbGVycyBhcmUgYXR0YWNoZWQuCgkvLyBOYXRpdmUgRE9NIGV2ZW50cyBzaG91bGQgbm90IGJlIGFkZGVkLCB0aGV5IG1heSBoYXZlIGlubGluZSBoYW5kbGVycy4KCWN1c3RvbUV2ZW50OiB7CgkJImdldERhdGEiOiB0cnVlLAoJCSJzZXREYXRhIjogdHJ1ZSwKCQkiY2hhbmdlRGF0YSI6IHRydWUKCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMgKSB7CgkJLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKCQlpZiAoIGVsZW0gJiYgKGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEV2ZW50IG9iamVjdCBvciBldmVudCB0eXBlCgkJdmFyIGNhY2hlLCBleGNsdXNpdmUsIGksIGN1ciwgb2xkLCBvbnR5cGUsIHNwZWNpYWwsIGhhbmRsZSwgZXZlbnRQYXRoLCBidWJibGVUeXBlLAoJCQl0eXBlID0gZXZlbnQudHlwZSB8fCBldmVudCwKCQkJbmFtZXNwYWNlcyA9IFtdOwoKCQkvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKCQlpZiAoIHJmb2N1c01vcnBoLnRlc3QoIHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdHlwZS5pbmRleE9mKCAiISIgKSA+PSAwICkgewoJCQkvLyBFeGNsdXNpdmUgZXZlbnRzIHRyaWdnZXIgb25seSBmb3IgdGhlIGV4YWN0IGV2ZW50IChubyBuYW1lc3BhY2VzKQoJCQl0eXBlID0gdHlwZS5zbGljZSgwLCAtMSk7CgkJCWV4Y2x1c2l2ZSA9IHRydWU7CgkJfQoKCQlpZiAoIHR5cGUuaW5kZXhPZiggIi4iICkgPj0gMCApIHsKCQkJLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQoJCQluYW1lc3BhY2VzID0gdHlwZS5zcGxpdCgiLiIpOwoJCQl0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoJCQluYW1lc3BhY2VzLnNvcnQoKTsKCQl9CgoJCWlmICggKCFlbGVtIHx8IGpRdWVyeS5ldmVudC5jdXN0b21FdmVudFsgdHlwZSBdKSAmJiAhalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdICkgewoJCQkvLyBObyBqUXVlcnkgaGFuZGxlcnMgZm9yIHRoaXMgZXZlbnQgdHlwZSwgYW5kIGl0IGNhbid0IGhhdmUgaW5saW5lIGhhbmRsZXJzCgkJCXJldHVybjsKCQl9CgoJCS8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBFdmVudCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCgkJZXZlbnQgPSB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiID8KCQkJLy8galF1ZXJ5LkV2ZW50IG9iamVjdAoJCQlldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSA/IGV2ZW50IDoKCQkJLy8gT2JqZWN0IGxpdGVyYWwKCQkJbmV3IGpRdWVyeS5FdmVudCggdHlwZSwgZXZlbnQgKSA6CgkJCS8vIEp1c3QgdGhlIGV2ZW50IHR5cGUgKHN0cmluZykKCQkJbmV3IGpRdWVyeS5FdmVudCggdHlwZSApOwoKCQlldmVudC50eXBlID0gdHlwZTsKCQlldmVudC5pc1RyaWdnZXIgPSB0cnVlOwoJCWV2ZW50LmV4Y2x1c2l2ZSA9IGV4Y2x1c2l2ZTsKCQlldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oICIuIiApOwoJCWV2ZW50Lm5hbWVzcGFjZV9yZSA9IGV2ZW50Lm5hbWVzcGFjZT8gbmV3IFJlZ0V4cCgiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIikgOiBudWxsOwoJCW9udHlwZSA9IHR5cGUuaW5kZXhPZiggIjoiICkgPCAwID8gIm9uIiArIHR5cGUgOiAiIjsKCgkJLy8gSGFuZGxlIGEgZ2xvYmFsIHRyaWdnZXIKCQlpZiAoICFlbGVtICkgewoKCQkJLy8gVE9ETzogU3RvcCB0YXVudGluZyB0aGUgZGF0YSBjYWNoZTsgcmVtb3ZlIGdsb2JhbCBldmVudHMgYW5kIGFsd2F5cyBhdHRhY2ggdG8gZG9jdW1lbnQKCQkJY2FjaGUgPSBqUXVlcnkuY2FjaGU7CgkJCWZvciAoIGkgaW4gY2FjaGUgKSB7CgkJCQlpZiAoIGNhY2hlWyBpIF0uZXZlbnRzICYmIGNhY2hlWyBpIF0uZXZlbnRzWyB0eXBlIF0gKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhLCBjYWNoZVsgaSBdLmhhbmRsZS5lbGVtLCB0cnVlICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCgkJZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwoJCWlmICggIWV2ZW50LnRhcmdldCApIHsKCQkJZXZlbnQudGFyZ2V0ID0gZWxlbTsKCQl9CgoJCS8vIENsb25lIGFueSBpbmNvbWluZyBkYXRhIGFuZCBwcmVwZW5kIHRoZSBldmVudCwgY3JlYXRpbmcgdGhlIGhhbmRsZXIgYXJnIGxpc3QKCQlkYXRhID0gZGF0YSAhPSBudWxsID8galF1ZXJ5Lm1ha2VBcnJheSggZGF0YSApIDogW107CgkJZGF0YS51bnNoaWZ0KCBldmVudCApOwoKCQkvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCgkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgkJaWYgKCBzcGVjaWFsLnRyaWdnZXIgJiYgc3BlY2lhbC50cmlnZ2VyLmFwcGx5KCBlbGVtLCBkYXRhICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkKCQkvLyBCdWJibGUgdXAgdG8gZG9jdW1lbnQsIHRoZW4gdG8gd2luZG93OyB3YXRjaCBmb3IgYSBnbG9iYWwgb3duZXJEb2N1bWVudCB2YXIgKCM5NzI0KQoJCWV2ZW50UGF0aCA9IFtbIGVsZW0sIHNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZSBdXTsKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJYnViYmxlVHlwZSA9IHNwZWNpYWwuZGVsZWdhdGVUeXBlIHx8IHR5cGU7CgkJCWN1ciA9IHJmb2N1c01vcnBoLnRlc3QoIGJ1YmJsZVR5cGUgKyB0eXBlICkgPyBlbGVtIDogZWxlbS5wYXJlbnROb2RlOwoJCQlmb3IgKCBvbGQgPSBlbGVtOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlICkgewoJCQkJZXZlbnRQYXRoLnB1c2goWyBjdXIsIGJ1YmJsZVR5cGUgXSk7CgkJCQlvbGQgPSBjdXI7CgkJCX0KCgkJCS8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQoJCQlpZiAoIG9sZCA9PT0gKGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCkgKSB7CgkJCQlldmVudFBhdGgucHVzaChbIG9sZC5kZWZhdWx0VmlldyB8fCBvbGQucGFyZW50V2luZG93IHx8IHdpbmRvdywgYnViYmxlVHlwZSBdKTsKCQkJfQoJCX0KCgkJLy8gRmlyZSBoYW5kbGVycyBvbiB0aGUgZXZlbnQgcGF0aAoJCWZvciAoIGkgPSAwOyBpIDwgZXZlbnRQYXRoLmxlbmd0aCAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKTsgaSsrICkgewoKCQkJY3VyID0gZXZlbnRQYXRoW2ldWzBdOwoJCQlldmVudC50eXBlID0gZXZlbnRQYXRoW2ldWzFdOwoKCQkJaGFuZGxlID0gKCBqUXVlcnkuX2RhdGEoIGN1ciwgImV2ZW50cyIgKSB8fCB7fSApWyBldmVudC50eXBlIF0gJiYgalF1ZXJ5Ll9kYXRhKCBjdXIsICJoYW5kbGUiICk7CgkJCWlmICggaGFuZGxlICkgewoJCQkJaGFuZGxlLmFwcGx5KCBjdXIsIGRhdGEgKTsKCQkJfQoJCQkvLyBOb3RlIHRoYXQgdGhpcyBpcyBhIGJhcmUgSlMgZnVuY3Rpb24gYW5kIG5vdCBhIGpRdWVyeSBoYW5kbGVyCgkJCWhhbmRsZSA9IG9udHlwZSAmJiBjdXJbIG9udHlwZSBdOwoJCQlpZiAoIGhhbmRsZSAmJiBqUXVlcnkuYWNjZXB0RGF0YSggY3VyICkgJiYgaGFuZGxlLmFwcGx5ICYmIGhhbmRsZS5hcHBseSggY3VyLCBkYXRhICkgPT09IGZhbHNlICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0KCQlldmVudC50eXBlID0gdHlwZTsKCgkJLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwoJCWlmICggIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgoJCQlpZiAoICghc3BlY2lhbC5fZGVmYXVsdCB8fCBzcGVjaWFsLl9kZWZhdWx0LmFwcGx5KCBlbGVtLm93bmVyRG9jdW1lbnQsIGRhdGEgKSA9PT0gZmFsc2UpICYmCgkJCQkhKHR5cGUgPT09ICJjbGljayIgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYSIgKSkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCgkJCQkvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCgkJCQkvLyBDYW4ndCB1c2UgYW4gLmlzRnVuY3Rpb24oKSBjaGVjayBoZXJlIGJlY2F1c2UgSUU2LzcgZmFpbHMgdGhhdCB0ZXN0LgoJCQkJLy8gRG9uJ3QgZG8gZGVmYXVsdCBhY3Rpb25zIG9uIHdpbmRvdywgdGhhdCdzIHdoZXJlIGdsb2JhbCB2YXJpYWJsZXMgYmUgKCM2MTcwKQoJCQkJLy8gSUU8OSBkaWVzIG9uIGZvY3VzL2JsdXIgdG8gaGlkZGVuIGVsZW1lbnQgKCMxNDg2KQoJCQkJaWYgKCBvbnR5cGUgJiYgZWxlbVsgdHlwZSBdICYmICgodHlwZSAhPT0gImZvY3VzIiAmJiB0eXBlICE9PSAiYmx1ciIpIHx8IGV2ZW50LnRhcmdldC5vZmZzZXRXaWR0aCAhPT0gMCkgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJCQkvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCgkJCQkJb2xkID0gZWxlbVsgb250eXBlIF07CgoJCQkJCWlmICggb2xkICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IG51bGw7CgkJCQkJfQoKCQkJCQkvLyBQcmV2ZW50IHJlLXRyaWdnZXJpbmcgb2YgdGhlIHNhbWUgZXZlbnQsIHNpbmNlIHdlIGFscmVhZHkgYnViYmxlZCBpdCBhYm92ZQoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwoJCQkJCWVsZW1bIHR5cGUgXSgpOwoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgoJCQkJCWlmICggb2xkICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IG9sZDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCWRpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCS8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAoJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgfHwgd2luZG93LmV2ZW50ICk7CgoJCXZhciBpLCBqLCBjdXIsIHJldCwgc2VsTWF0Y2gsIG1hdGNoZWQsIG1hdGNoZXMsIGhhbmRsZU9iaiwgc2VsLCByZWxhdGVkLAoJCQloYW5kbGVycyA9ICggKGpRdWVyeS5fZGF0YSggdGhpcywgImV2ZW50cyIgKSB8fCB7fSApWyBldmVudC50eXBlIF0gfHwgW10pLAoJCQlkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKCQkJYXJncyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCXJ1bl9hbGwgPSAhZXZlbnQuZXhjbHVzaXZlICYmICFldmVudC5uYW1lc3BhY2UsCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZXZlbnQudHlwZSBdIHx8IHt9LAoJCQloYW5kbGVyUXVldWUgPSBbXTsKCgkJLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQKCQlhcmdzWzBdID0gZXZlbnQ7CgkJZXZlbnQuZGVsZWdhdGVUYXJnZXQgPSB0aGlzOwoKCQkvLyBDYWxsIHRoZSBwcmVEaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUsIGFuZCBsZXQgaXQgYmFpbCBpZiBkZXNpcmVkCgkJaWYgKCBzcGVjaWFsLnByZURpc3BhdGNoICYmIHNwZWNpYWwucHJlRGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIERldGVybWluZSBoYW5kbGVycyB0aGF0IHNob3VsZCBydW4gaWYgdGhlcmUgYXJlIGRlbGVnYXRlZCBldmVudHMKCQkvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKCQlpZiAoIGRlbGVnYXRlQ291bnQgJiYgIShldmVudC5idXR0b24gJiYgZXZlbnQudHlwZSA9PT0gImNsaWNrIikgKSB7CgoJCQlmb3IgKCBjdXIgPSBldmVudC50YXJnZXQ7IGN1ciAhPSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzICkgewoKCQkJCS8vIERvbid0IHByb2Nlc3MgY2xpY2tzIChPTkxZKSBvbiBkaXNhYmxlZCBlbGVtZW50cyAoIzY5MTEsICM4MTY1LCAjMTEzODIsICMxMTc2NCkKCQkJCWlmICggY3VyLmRpc2FibGVkICE9PSB0cnVlIHx8IGV2ZW50LnR5cGUgIT09ICJjbGljayIgKSB7CgkJCQkJc2VsTWF0Y2ggPSB7fTsKCQkJCQltYXRjaGVzID0gW107CgkJCQkJZm9yICggaSA9IDA7IGkgPCBkZWxlZ2F0ZUNvdW50OyBpKysgKSB7CgkJCQkJCWhhbmRsZU9iaiA9IGhhbmRsZXJzWyBpIF07CgkJCQkJCXNlbCA9IGhhbmRsZU9iai5zZWxlY3RvcjsKCgkJCQkJCWlmICggc2VsTWF0Y2hbIHNlbCBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCQlzZWxNYXRjaFsgc2VsIF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8KCQkJCQkJCQlqUXVlcnkoIHNlbCwgdGhpcyApLmluZGV4KCBjdXIgKSA+PSAwIDoKCQkJCQkJCQlqUXVlcnkuZmluZCggc2VsLCB0aGlzLCBudWxsLCBbIGN1ciBdICkubGVuZ3RoOwoJCQkJCQl9CgkJCQkJCWlmICggc2VsTWF0Y2hbIHNlbCBdICkgewoJCQkJCQkJbWF0Y2hlcy5wdXNoKCBoYW5kbGVPYmogKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG1hdGNoZXMubGVuZ3RoICkgewoJCQkJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IGN1ciwgbWF0Y2hlczogbWF0Y2hlcyB9KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEFkZCB0aGUgcmVtYWluaW5nIChkaXJlY3RseS1ib3VuZCkgaGFuZGxlcnMKCQlpZiAoIGhhbmRsZXJzLmxlbmd0aCA+IGRlbGVnYXRlQ291bnQgKSB7CgkJCWhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogdGhpcywgbWF0Y2hlczogaGFuZGxlcnMuc2xpY2UoIGRlbGVnYXRlQ291bnQgKSB9KTsKCQl9CgoJCS8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCgkJZm9yICggaSA9IDA7IGkgPCBoYW5kbGVyUXVldWUubGVuZ3RoICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpOyBpKysgKSB7CgkJCW1hdGNoZWQgPSBoYW5kbGVyUXVldWVbIGkgXTsKCQkJZXZlbnQuY3VycmVudFRhcmdldCA9IG1hdGNoZWQuZWxlbTsKCgkJCWZvciAoIGogPSAwOyBqIDwgbWF0Y2hlZC5tYXRjaGVzLmxlbmd0aCAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKTsgaisrICkgewoJCQkJaGFuZGxlT2JqID0gbWF0Y2hlZC5tYXRjaGVzWyBqIF07CgoJCQkJLy8gVHJpZ2dlcmVkIGV2ZW50IG11c3QgZWl0aGVyIDEpIGJlIG5vbi1leGNsdXNpdmUgYW5kIGhhdmUgbm8gbmFtZXNwYWNlLCBvcgoJCQkJLy8gMikgaGF2ZSBuYW1lc3BhY2UocykgYSBzdWJzZXQgb3IgZXF1YWwgdG8gdGhvc2UgaW4gdGhlIGJvdW5kIGV2ZW50IChib3RoIGNhbiBoYXZlIG5vIG5hbWVzcGFjZSkuCgkJCQlpZiAoIHJ1bl9hbGwgfHwgKCFldmVudC5uYW1lc3BhY2UgJiYgIWhhbmRsZU9iai5uYW1lc3BhY2UpIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZSAmJiBldmVudC5uYW1lc3BhY2VfcmUudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgewoKCQkJCQlldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CgkJCQkJZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwoKCQkJCQlyZXQgPSAoIChqUXVlcnkuZXZlbnQuc3BlY2lhbFsgaGFuZGxlT2JqLm9yaWdUeXBlIF0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlciApCgkJCQkJCQkuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOwoKCQkJCQlpZiAoIHJldCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCQlldmVudC5yZXN1bHQgPSByZXQ7CgkJCQkJCWlmICggcmV0ID09PSBmYWxzZSApIHsKCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQoJCWlmICggc3BlY2lhbC5wb3N0RGlzcGF0Y2ggKSB7CgkJCXNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCgkvLyBJbmNsdWRlcyBzb21lIGV2ZW50IHByb3BzIHNoYXJlZCBieSBLZXlFdmVudCBhbmQgTW91c2VFdmVudAoJLy8gKioqIGF0dHJDaGFuZ2UgYXR0ck5hbWUgcmVsYXRlZE5vZGUgc3JjRWxlbWVudCAgYXJlIG5vdCBub3JtYWxpemVkLCBub24tVzNDLCBkZXByZWNhdGVkLCB3aWxsIGJlIHJlbW92ZWQgaW4gMS44ICoqKgoJcHJvcHM6ICJhdHRyQ2hhbmdlIGF0dHJOYW1lIHJlbGF0ZWROb2RlIHNyY0VsZW1lbnQgYWx0S2V5IGJ1YmJsZXMgY2FuY2VsYWJsZSBjdHJsS2V5IGN1cnJlbnRUYXJnZXQgZXZlbnRQaGFzZSBtZXRhS2V5IHJlbGF0ZWRUYXJnZXQgc2hpZnRLZXkgdGFyZ2V0IHRpbWVTdGFtcCB2aWV3IHdoaWNoIi5zcGxpdCgiICIpLAoKCWZpeEhvb2tzOiB7fSwKCglrZXlIb29rczogewoJCXByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQkJaWYgKCBldmVudC53aGljaCA9PSBudWxsICkgewoJCQkJZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCgltb3VzZUhvb2tzOiB7CgkJcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgZnJvbUVsZW1lbnQgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCgkJZmlsdGVyOiBmdW5jdGlvbiggZXZlbnQsIG9yaWdpbmFsICkgewoJCQl2YXIgZXZlbnREb2MsIGRvYywgYm9keSwKCQkJCWJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbiwKCQkJCWZyb21FbGVtZW50ID0gb3JpZ2luYWwuZnJvbUVsZW1lbnQ7CgoJCQkvLyBDYWxjdWxhdGUgcGFnZVgvWSBpZiBtaXNzaW5nIGFuZCBjbGllbnRYL1kgYXZhaWxhYmxlCgkJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBvcmlnaW5hbC5jbGllbnRYICE9IG51bGwgKSB7CgkJCQlldmVudERvYyA9IGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwoJCQkJZG9jID0gZXZlbnREb2MuZG9jdW1lbnRFbGVtZW50OwoJCQkJYm9keSA9IGV2ZW50RG9jLmJvZHk7CgoJCQkJZXZlbnQucGFnZVggPSBvcmlnaW5hbC5jbGllbnRYICsgKCBkb2MgJiYgZG9jLnNjcm9sbExlZnQgfHwgYm9keSAmJiBib2R5LnNjcm9sbExlZnQgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudExlZnQgfHwgYm9keSAmJiBib2R5LmNsaWVudExlZnQgfHwgMCApOwoJCQkJZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKCBkb2MgJiYgZG9jLnNjcm9sbFRvcCAgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCAgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCApOwoJCQl9CgoJCQkvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CgkJCWlmICggIWV2ZW50LnJlbGF0ZWRUYXJnZXQgJiYgZnJvbUVsZW1lbnQgKSB7CgkJCQlldmVudC5yZWxhdGVkVGFyZ2V0ID0gZnJvbUVsZW1lbnQgPT09IGV2ZW50LnRhcmdldCA/IG9yaWdpbmFsLnRvRWxlbWVudCA6IGZyb21FbGVtZW50OwoJCQl9CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09PSBsZWZ0OyAyID09PSBtaWRkbGU7IDMgPT09IHJpZ2h0CgkJCS8vIE5vdGU6IGJ1dHRvbiBpcyBub3Qgbm9ybWFsaXplZCwgc28gZG9uJ3QgdXNlIGl0CgkJCWlmICggIWV2ZW50LndoaWNoICYmIGJ1dHRvbiAhPT0gdW5kZWZpbmVkICkgewoJCQkJZXZlbnQud2hpY2ggPSAoIGJ1dHRvbiAmIDEgPyAxIDogKCBidXR0b24gJiAyID8gMyA6ICggYnV0dG9uICYgNCA/IDIgOiAwICkgKSApOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCglmaXg6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdICkgewoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoKCQkvLyBDcmVhdGUgYSB3cml0YWJsZSBjb3B5IG9mIHRoZSBldmVudCBvYmplY3QgYW5kIG5vcm1hbGl6ZSBzb21lIHByb3BlcnRpZXMKCQl2YXIgaSwgcHJvcCwKCQkJb3JpZ2luYWxFdmVudCA9IGV2ZW50LAoJCQlmaXhIb29rID0galF1ZXJ5LmV2ZW50LmZpeEhvb2tzWyBldmVudC50eXBlIF0gfHwge30sCgkJCWNvcHkgPSBmaXhIb29rLnByb3BzID8gdGhpcy5wcm9wcy5jb25jYXQoIGZpeEhvb2sucHJvcHMgKSA6IHRoaXMucHJvcHM7CgoJCWV2ZW50ID0galF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7CgoJCWZvciAoIGkgPSBjb3B5Lmxlbmd0aDsgaTsgKSB7CgkJCXByb3AgPSBjb3B5WyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQl9CgoJCS8vIEZpeCB0YXJnZXQgcHJvcGVydHksIGlmIG5lY2Vzc2FyeSAoIzE5MjUsIElFIDYvNy84ICYgU2FmYXJpMikKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IG9yaWdpbmFsRXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsKCQl9CgoJCS8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCBTYWZhcmkpCgkJaWYgKCBldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwoJCX0KCgkJLy8gRm9yIG1vdXNlL2tleSBldmVudHMsIG1ldGFLZXk9PWZhbHNlIGlmIGl0J3MgdW5kZWZpbmVkICgjMzM2OCwgIzExMzI4OyBJRTYvNy84KQoJCWV2ZW50Lm1ldGFLZXkgPSAhIWV2ZW50Lm1ldGFLZXk7CgoJCXJldHVybiBmaXhIb29rLmZpbHRlcj8gZml4SG9vay5maWx0ZXIoIGV2ZW50LCBvcmlnaW5hbEV2ZW50ICkgOiBldmVudDsKCX0sCgoJc3BlY2lhbDogewoJCWxvYWQ6IHsKCQkJLy8gUHJldmVudCB0cmlnZ2VyZWQgaW1hZ2UubG9hZCBldmVudHMgZnJvbSBidWJibGluZyB0byB3aW5kb3cubG9hZAoJCQlub0J1YmJsZTogdHJ1ZQoJCX0sCgoJCWZvY3VzOiB7CgkJCWRlbGVnYXRlVHlwZTogImZvY3VzaW4iCgkJfSwKCQlibHVyOiB7CgkJCWRlbGVnYXRlVHlwZTogImZvY3Vzb3V0IgoJCX0sCgoJCWJlZm9yZXVubG9hZDogewoJCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlICkgewoJCQkJLy8gV2Ugb25seSB3YW50IHRvIGRvIHRoaXMgc3BlY2lhbCBjYXNlIG9uIHdpbmRvd3MKCQkJCWlmICggalF1ZXJ5LmlzV2luZG93KCB0aGlzICkgKSB7CgkJCQkJdGhpcy5vbmJlZm9yZXVubG9hZCA9IGV2ZW50SGFuZGxlOwoJCQkJfQoJCQl9LAoKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApIHsKCQkJCWlmICggdGhpcy5vbmJlZm9yZXVubG9hZCA9PT0gZXZlbnRIYW5kbGUgKSB7CgkJCQkJdGhpcy5vbmJlZm9yZXVubG9hZCA9IG51bGw7CgkJCQl9CgkJCX0KCQl9Cgl9LAoKCXNpbXVsYXRlOiBmdW5jdGlvbiggdHlwZSwgZWxlbSwgZXZlbnQsIGJ1YmJsZSApIHsKCQkvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUuCgkJLy8gRmFrZSBvcmlnaW5hbEV2ZW50IHRvIGF2b2lkIGRvbm9yJ3Mgc3RvcFByb3BhZ2F0aW9uLCBidXQgaWYgdGhlCgkJLy8gc2ltdWxhdGVkIGV2ZW50IHByZXZlbnRzIGRlZmF1bHQgdGhlbiB3ZSBkbyB0aGUgc2FtZSBvbiB0aGUgZG9ub3IuCgkJdmFyIGUgPSBqUXVlcnkuZXh0ZW5kKAoJCQluZXcgalF1ZXJ5LkV2ZW50KCksCgkJCWV2ZW50LAoJCQl7IHR5cGU6IHR5cGUsCgkJCQlpc1NpbXVsYXRlZDogdHJ1ZSwKCQkJCW9yaWdpbmFsRXZlbnQ6IHt9CgkJCX0KCQkpOwoJCWlmICggYnViYmxlICkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgbnVsbCwgZWxlbSApOwoJCX0gZWxzZSB7CgkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5jYWxsKCBlbGVtLCBlICk7CgkJfQoJCWlmICggZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9Cn07CgovLyBTb21lIHBsdWdpbnMgYXJlIHVzaW5nLCBidXQgaXQncyB1bmRvY3VtZW50ZWQvZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkLgovLyBUaGUgMS43IHNwZWNpYWwgZXZlbnQgaW50ZXJmYWNlIHNob3VsZCBwcm92aWRlIGFsbCB0aGUgaG9va3MgbmVlZGVkIG5vdy4KalF1ZXJ5LmV2ZW50LmhhbmRsZSA9IGpRdWVyeS5ldmVudC5kaXNwYXRjaDsKCmpRdWVyeS5yZW1vdmVFdmVudCA9IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIgPwoJZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCQlpZiAoIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciApIHsKCQkJZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlLCBoYW5kbGUsIGZhbHNlICk7CgkJfQoJfSA6CglmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewoJCXZhciBuYW1lID0gIm9uIiArIHR5cGU7CgoJCWlmICggZWxlbS5kZXRhY2hFdmVudCApIHsKCgkJCS8vICM4NTQ1LCAjNzA1NCwgcHJldmVudGluZyBtZW1vcnkgbGVha3MgZm9yIGN1c3RvbSBldmVudHMgaW4gSUU2LTgKCQkJLy8gZGV0YWNoRXZlbnQgbmVlZGVkIHByb3BlcnR5IG9uIGVsZW1lbnQsIGJ5IG5hbWUgb2YgdGhhdCBldmVudCwgdG8gcHJvcGVybHkgZXhwb3NlIGl0IHRvIEdDCgkJCWlmICggdHlwZW9mIGVsZW1bIG5hbWUgXSA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCQllbGVtWyBuYW1lIF0gPSBudWxsOwoJCQl9CgoJCQllbGVtLmRldGFjaEV2ZW50KCBuYW1lLCBoYW5kbGUgKTsKCQl9Cgl9OwoKalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYywgcHJvcHMgKSB7CgkvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgdGhlICduZXcnIGtleXdvcmQKCWlmICggISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjLCBwcm9wcyApOwoJfQoKCS8vIEV2ZW50IG9iamVjdAoJaWYgKCBzcmMgJiYgc3JjLnR5cGUgKSB7CgkJdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwoJCXRoaXMudHlwZSA9IHNyYy50eXBlOwoKCQkvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAoJCS8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLgoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKCBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMucmV0dXJuVmFsdWUgPT09IGZhbHNlIHx8CgkJCXNyYy5nZXRQcmV2ZW50RGVmYXVsdCAmJiBzcmMuZ2V0UHJldmVudERlZmF1bHQoKSApID8gcmV0dXJuVHJ1ZSA6IHJldHVybkZhbHNlOwoKCS8vIEV2ZW50IHR5cGUKCX0gZWxzZSB7CgkJdGhpcy50eXBlID0gc3JjOwoJfQoKCS8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CglpZiAoIHByb3BzICkgewoJCWpRdWVyeS5leHRlbmQoIHRoaXMsIHByb3BzICk7Cgl9CgoJLy8gQ3JlYXRlIGEgdGltZXN0YW1wIGlmIGluY29taW5nIGV2ZW50IGRvZXNuJ3QgaGF2ZSBvbmUKCXRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwoKCS8vIE1hcmsgaXQgYXMgZml4ZWQKCXRoaXNbIGpRdWVyeS5leHBhbmRvIF0gPSB0cnVlOwp9OwoKZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CglyZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsKCXJldHVybiB0cnVlOwp9CgovLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCmpRdWVyeS5FdmVudC5wcm90b3R5cGUgPSB7CglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwoKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCQlpZiAoICFlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBpZiBwcmV2ZW50RGVmYXVsdCBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5wcmV2ZW50RGVmYXVsdCApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoKCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UgKElFKQoJCX0gZWxzZSB7CgkJCWUucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQl9Cgl9LAoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCAhZSApIHsKCQkJcmV0dXJuOwoJCX0KCQkvLyBpZiBzdG9wUHJvcGFnYXRpb24gZXhpc3RzIHJ1biBpdCBvbiB0aGUgb3JpZ2luYWwgZXZlbnQKCQlpZiAoIGUuc3RvcFByb3BhZ2F0aW9uICkgewoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSBjYW5jZWxCdWJibGUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIHRydWUgKElFKQoJCWUuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCX0sCglzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCXRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9LAoJaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKCWlzUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCWlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZQp9OwoKLy8gQ3JlYXRlIG1vdXNlZW50ZXIvbGVhdmUgZXZlbnRzIHVzaW5nIG1vdXNlb3Zlci9vdXQgYW5kIGV2ZW50LXRpbWUgY2hlY2tzCmpRdWVyeS5lYWNoKHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlkZWxlZ2F0ZVR5cGU6IGZpeCwKCQliaW5kVHlwZTogZml4LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHJldCwKCQkJCXRhcmdldCA9IHRoaXMsCgkJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwKCQkJCWhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iaiwKCQkJCXNlbGVjdG9yID0gaGFuZGxlT2JqLnNlbGVjdG9yOwoKCQkJLy8gRm9yIG1vdXNlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgoJCQkvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwoJCQlpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyggdGFyZ2V0LCByZWxhdGVkICkpICkgewoJCQkJZXZlbnQudHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZTsKCQkJCXJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCWV2ZW50LnR5cGUgPSBmaXg7CgkJCX0KCQkJcmV0dXJuIHJldDsKCQl9Cgl9Owp9KTsKCi8vIElFIHN1Ym1pdCBkZWxlZ2F0aW9uCmlmICggIWpRdWVyeS5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgKSB7CgoJalF1ZXJ5LmV2ZW50LnNwZWNpYWwuc3VibWl0ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBMYXp5LWFkZCBhIHN1Ym1pdCBoYW5kbGVyIHdoZW4gYSBkZXNjZW5kYW50IGZvcm0gbWF5IHBvdGVudGlhbGx5IGJlIHN1Ym1pdHRlZAoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiY2xpY2suX3N1Ym1pdCBrZXlwcmVzcy5fc3VibWl0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkvLyBOb2RlIG5hbWUgY2hlY2sgYXZvaWRzIGEgVk1MLXJlbGF0ZWQgY3Jhc2ggaW4gSUUgKCM5ODA3KQoJCQkJdmFyIGVsZW0gPSBlLnRhcmdldCwKCQkJCQlmb3JtID0galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgfHwgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYnV0dG9uIiApID8gZWxlbS5mb3JtIDogdW5kZWZpbmVkOwoJCQkJaWYgKCBmb3JtICYmICFqUXVlcnkuX2RhdGEoIGZvcm0sICJfc3VibWl0X2F0dGFjaGVkIiApICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGZvcm0sICJzdWJtaXQuX3N1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJZXZlbnQuX3N1Ym1pdF9idWJibGUgPSB0cnVlOwoJCQkJCX0pOwoJCQkJCWpRdWVyeS5fZGF0YSggZm9ybSwgIl9zdWJtaXRfYXR0YWNoZWQiLCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCQkvLyByZXR1cm4gdW5kZWZpbmVkIHNpbmNlIHdlIGRvbid0IG5lZWQgYW4gZXZlbnQgbGlzdGVuZXIKCQl9LAoKCQlwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gSWYgZm9ybSB3YXMgc3VibWl0dGVkIGJ5IHRoZSB1c2VyLCBidWJibGUgdGhlIGV2ZW50IHVwIHRoZSB0cmVlCgkJCWlmICggZXZlbnQuX3N1Ym1pdF9idWJibGUgKSB7CgkJCQlkZWxldGUgZXZlbnQuX3N1Ym1pdF9idWJibGU7CgkJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggInN1Ym1pdCIsIHRoaXMucGFyZW50Tm9kZSwgZXZlbnQsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBSZW1vdmUgZGVsZWdhdGVkIGhhbmRsZXJzOyBjbGVhbkRhdGEgZXZlbnR1YWxseSByZWFwcyBzdWJtaXQgaGFuZGxlcnMgYXR0YWNoZWQgYWJvdmUKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fc3VibWl0IiApOwoJCX0KCX07Cn0KCi8vIElFIGNoYW5nZSBkZWxlZ2F0aW9uIGFuZCBjaGVja2JveC9yYWRpbyBmaXgKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hhbmdlQnViYmxlcyApIHsKCglqUXVlcnkuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCWlmICggcmZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICkgKSB7CgkJCQkvLyBJRSBkb2Vzbid0IGZpcmUgY2hhbmdlIG9uIGEgY2hlY2svcmFkaW8gdW50aWwgYmx1cjsgdHJpZ2dlciBpdCBvbiBjbGljawoJCQkJLy8gYWZ0ZXIgYSBwcm9wZXJ0eWNoYW5nZS4gRWF0IHRoZSBibHVyLWNoYW5nZSBpbiBzcGVjaWFsLmNoYW5nZS5oYW5kbGUuCgkJCQkvLyBUaGlzIHN0aWxsIGZpcmVzIG9uY2hhbmdlIGEgc2Vjb25kIHRpbWUgZm9yIGNoZWNrL3JhZGlvIGFmdGVyIGJsdXIuCgkJCQlpZiAoIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiB8fCB0aGlzLnR5cGUgPT09ICJyYWRpbyIgKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgInByb3BlcnR5Y2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudC5wcm9wZXJ0eU5hbWUgPT09ICJjaGVja2VkIiApIHsKCQkJCQkJCXRoaXMuX2p1c3RfY2hhbmdlZCA9IHRydWU7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiY2xpY2suX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJaWYgKCB0aGlzLl9qdXN0X2NoYW5nZWQgJiYgIWV2ZW50LmlzVHJpZ2dlciApIHsKCQkJCQkJCXRoaXMuX2p1c3RfY2hhbmdlZCA9IGZhbHNlOwoJCQkJCQl9CgkJCQkJCS8vIEFsbG93IHRyaWdnZXJlZCwgc2ltdWxhdGVkIGNoYW5nZSBldmVudHMgKCMxMTUwMCkKCQkJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcywgZXZlbnQsIHRydWUgKTsKCQkJCQl9KTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQkvLyBEZWxlZ2F0ZWQgZXZlbnQ7IGxhenktYWRkIGEgY2hhbmdlIGhhbmRsZXIgb24gZGVzY2VuZGFudCBpbnB1dHMKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgImJlZm9yZWFjdGl2YXRlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBlbGVtID0gZS50YXJnZXQ7CgoJCQkJaWYgKCByZm9ybUVsZW1zLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiX2NoYW5nZV9hdHRhY2hlZCIgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCBlbGVtLCAiY2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWlmICggdGhpcy5wYXJlbnROb2RlICYmICFldmVudC5pc1NpbXVsYXRlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSApOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQkJalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiX2NoYW5nZV9hdHRhY2hlZCIsIHRydWUgKTsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBlbGVtID0gZXZlbnQudGFyZ2V0OwoKCQkJLy8gU3dhbGxvdyBuYXRpdmUgY2hhbmdlIGV2ZW50cyBmcm9tIGNoZWNrYm94L3JhZGlvLCB3ZSBhbHJlYWR5IHRyaWdnZXJlZCB0aGVtIGFib3ZlCgkJCWlmICggdGhpcyAhPT0gZWxlbSB8fCBldmVudC5pc1NpbXVsYXRlZCB8fCBldmVudC5pc1RyaWdnZXIgfHwgKGVsZW0udHlwZSAhPT0gInJhZGlvIiAmJiBlbGVtLnR5cGUgIT09ICJjaGVja2JveCIpICkgewoJCQkJcmV0dXJuIGV2ZW50LmhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fY2hhbmdlIiApOwoKCQkJcmV0dXJuICFyZm9ybUVsZW1zLnRlc3QoIHRoaXMubm9kZU5hbWUgKTsKCQl9Cgl9Owp9CgovLyBDcmVhdGUgImJ1YmJsaW5nIiBmb2N1cyBhbmQgYmx1ciBldmVudHMKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMgKSB7CglqUXVlcnkuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCgkJLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dAoJCXZhciBhdHRhY2hlcyA9IDAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoIGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KCBldmVudCApLCB0cnVlICk7CgkJCX07CgoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBhdHRhY2hlcysrID09PSAwICkgewoJCQkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCX0KCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAtLWF0dGFjaGVzID09PSAwICkgewoJCQkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX07Cgl9KTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CgoJb246IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAvKklOVEVSTkFMKi8gb25lICkgewoJCXZhciBvcmlnRm4sIHR5cGU7CgoJCS8vIFR5cGVzIGNhbiBiZSBhIG1hcCBvZiB0eXBlcy9oYW5kbGVycwoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsKCQkJLy8gKCB0eXBlcy1PYmplY3QsIHNlbGVjdG9yLCBkYXRhICkKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgeyAvLyAmJiBzZWxlY3RvciAhPSBudWxsCgkJCQkvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCgkJCQlkYXRhID0gZGF0YSB8fCBzZWxlY3RvcjsKCQkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCQl9CgkJCWZvciAoIHR5cGUgaW4gdHlwZXMgKSB7CgkJCQl0aGlzLm9uKCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoIGRhdGEgPT0gbnVsbCAmJiBmbiA9PSBudWxsICkgewoJCQkvLyAoIHR5cGVzLCBmbiApCgkJCWZuID0gc2VsZWN0b3I7CgkJCWRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9IGVsc2UgaWYgKCBmbiA9PSBudWxsICkgewoJCQlpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyAoIHR5cGVzLCBzZWxlY3RvciwgZm4gKQoJCQkJZm4gPSBkYXRhOwoJCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQkJfSBlbHNlIHsKCQkJCS8vICggdHlwZXMsIGRhdGEsIGZuICkKCQkJCWZuID0gZGF0YTsKCQkJCWRhdGEgPSBzZWxlY3RvcjsKCQkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCQl9CgkJfQoJCWlmICggZm4gPT09IGZhbHNlICkgewoJCQlmbiA9IHJldHVybkZhbHNlOwoJCX0gZWxzZSBpZiAoICFmbiApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoIG9uZSA9PT0gMSApIHsKCQkJb3JpZ0ZuID0gZm47CgkJCWZuID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCgkJCQlqUXVlcnkoKS5vZmYoIGV2ZW50ICk7CgkJCQlyZXR1cm4gb3JpZ0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfTsKCQkJLy8gVXNlIHNhbWUgZ3VpZCBzbyBjYWxsZXIgY2FuIHJlbW92ZSB1c2luZyBvcmlnRm4KCQkJZm4uZ3VpZCA9IG9yaWdGbi5ndWlkIHx8ICggb3JpZ0ZuLmd1aWQgPSBqUXVlcnkuZ3VpZCsrICk7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCB0eXBlcywgZm4sIGRhdGEsIHNlbGVjdG9yICk7CgkJfSk7Cgl9LAoJb25lOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSApOwoJfSwKCW9mZjogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZm4gKSB7CgkJdmFyIGhhbmRsZU9iaiwgdHlwZTsKCQlpZiAoIHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaiApIHsKCQkJLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudAoJCQloYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CgkJCWpRdWVyeSggdHlwZXMuZGVsZWdhdGVUYXJnZXQgKS5vZmYoCgkJCQloYW5kbGVPYmoubmFtZXNwYWNlID8gaGFuZGxlT2JqLm9yaWdUeXBlICsgIi4iICsgaGFuZGxlT2JqLm5hbWVzcGFjZSA6IGhhbmRsZU9iai5vcmlnVHlwZSwKCQkJCWhhbmRsZU9iai5zZWxlY3RvciwKCQkJCWhhbmRsZU9iai5oYW5kbGVyCgkJCSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CgkJCS8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApCgkJCWZvciAoIHR5cGUgaW4gdHlwZXMgKSB7CgkJCQl0aGlzLm9mZiggdHlwZSwgc2VsZWN0b3IsIHR5cGVzWyB0eXBlIF0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCBzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iICkgewoJCQkvLyAoIHR5cGVzIFssIGZuXSApCgkJCWZuID0gc2VsZWN0b3I7CgkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGZuID09PSBmYWxzZSApIHsKCQkJZm4gPSByZXR1cm5GYWxzZTsKCQl9CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgdHlwZXMsIGZuLCBzZWxlY3RvciApOwoJCX0pOwoJfSwKCgliaW5kOiBmdW5jdGlvbiggdHlwZXMsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLm9uKCB0eXBlcywgbnVsbCwgZGF0YSwgZm4gKTsKCX0sCgl1bmJpbmQ6IGZ1bmN0aW9uKCB0eXBlcywgZm4gKSB7CgkJcmV0dXJuIHRoaXMub2ZmKCB0eXBlcywgbnVsbCwgZm4gKTsKCX0sCgoJbGl2ZTogZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlqUXVlcnkoIHRoaXMuY29udGV4dCApLm9uKCB0eXBlcywgdGhpcy5zZWxlY3RvciwgZGF0YSwgZm4gKTsKCQlyZXR1cm4gdGhpczsKCX0sCglkaWU6IGZ1bmN0aW9uKCB0eXBlcywgZm4gKSB7CgkJalF1ZXJ5KCB0aGlzLmNvbnRleHQgKS5vZmYoIHR5cGVzLCB0aGlzLnNlbGVjdG9yIHx8ICIqKiIsIGZuICk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwoJfSwKCXVuZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGZuICkgewoJCS8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHRoaXMub2ZmKCBzZWxlY3RvciwgIioqIiApIDogdGhpcy5vZmYoIHR5cGVzLCBzZWxlY3RvciB8fCAiKioiLCBmbiApOwoJfSwKCgl0cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOwoJCX0pOwoJfSwKCXRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQlpZiAoIHRoaXNbMF0gKSB7CgkJCXJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpc1swXSwgdHJ1ZSApOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbiggZm4gKSB7CgkJLy8gU2F2ZSByZWZlcmVuY2UgdG8gYXJndW1lbnRzIGZvciBhY2Nlc3MgaW4gY2xvc3VyZQoJCXZhciBhcmdzID0gYXJndW1lbnRzLAoJCQlndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrLAoJCQlpID0gMCwKCQkJdG9nZ2xlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIEZpZ3VyZSBvdXQgd2hpY2ggZnVuY3Rpb24gdG8gZXhlY3V0ZQoJCQkJdmFyIGxhc3RUb2dnbGUgPSAoIGpRdWVyeS5fZGF0YSggdGhpcywgImxhc3RUb2dnbGUiICsgZm4uZ3VpZCApIHx8IDAgKSAlIGk7CgkJCQlqUXVlcnkuX2RhdGEoIHRoaXMsICJsYXN0VG9nZ2xlIiArIGZuLmd1aWQsIGxhc3RUb2dnbGUgKyAxICk7CgoJCQkJLy8gTWFrZSBzdXJlIHRoYXQgY2xpY2tzIHN0b3AKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJLy8gYW5kIGV4ZWN1dGUgdGhlIGZ1bmN0aW9uCgkJCQlyZXR1cm4gYXJnc1sgbGFzdFRvZ2dsZSBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSB8fCBmYWxzZTsKCQkJfTsKCgkJLy8gbGluayBhbGwgdGhlIGZ1bmN0aW9ucywgc28gYW55IG9mIHRoZW0gY2FuIHVuYmluZCB0aGlzIGNsaWNrIGhhbmRsZXIKCQl0b2dnbGVyLmd1aWQgPSBndWlkOwoJCXdoaWxlICggaSA8IGFyZ3MubGVuZ3RoICkgewoJCQlhcmdzWyBpKysgXS5ndWlkID0gZ3VpZDsKCQl9CgoJCXJldHVybiB0aGlzLmNsaWNrKCB0b2dnbGVyICk7Cgl9LAoKCWhvdmVyOiBmdW5jdGlvbiggZm5PdmVyLCBmbk91dCApIHsKCQlyZXR1cm4gdGhpcy5tb3VzZWVudGVyKCBmbk92ZXIgKS5tb3VzZWxlYXZlKCBmbk91dCB8fCBmbk92ZXIgKTsKCX0KfSk7CgpqUXVlcnkuZWFjaCggKCJibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAiICsKCSJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsKCSJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGRhdGEsIGZuICkgewoJCWlmICggZm4gPT0gbnVsbCApIHsKCQkJZm4gPSBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/CgkJCXRoaXMub24oIG5hbWUsIG51bGwsIGRhdGEsIGZuICkgOgoJCQl0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07CgoJaWYgKCBya2V5RXZlbnQudGVzdCggbmFtZSApICkgewoJCWpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50LmtleUhvb2tzOwoJfQoKCWlmICggcm1vdXNlRXZlbnQudGVzdCggbmFtZSApICkgewoJCWpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50Lm1vdXNlSG9va3M7Cgl9Cn0pOwovKiEKICogU2l6emxlIENTUyBTZWxlY3RvciBFbmdpbmUKICogQ29weXJpZ2h0IDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY2FjaGVkcnVucywKCWFzc2VydEdldElkTm90TmFtZSwKCUV4cHIsCglnZXRUZXh0LAoJaXNYTUwsCgljb250YWlucywKCWNvbXBpbGUsCglzb3J0T3JkZXIsCgloYXNEdXBsaWNhdGUsCglvdXRlcm1vc3RDb250ZXh0LAoKCWJhc2VIYXNEdXBsaWNhdGUgPSB0cnVlLAoJc3RydW5kZWZpbmVkID0gInVuZGVmaW5lZCIsCgoJZXhwYW5kbyA9ICggInNpemNhY2hlIiArIE1hdGgucmFuZG9tKCkgKS5yZXBsYWNlKCAiLiIsICIiICksCgoJVG9rZW4gPSBTdHJpbmcsCglkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCWRvY0VsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCglkaXJydW5zID0gMCwKCWRvbmUgPSAwLAoJcG9wID0gW10ucG9wLAoJcHVzaCA9IFtdLnB1c2gsCglzbGljZSA9IFtdLnNsaWNlLAoJLy8gVXNlIGEgc3RyaXBwZWQtZG93biBpbmRleE9mIGlmIGEgbmF0aXZlIG9uZSBpcyB1bmF2YWlsYWJsZQoJaW5kZXhPZiA9IFtdLmluZGV4T2YgfHwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIGkgPSAwLAoJCQlsZW4gPSB0aGlzLmxlbmd0aDsKCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJaWYgKCB0aGlzW2ldID09PSBlbGVtICkgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgkvLyBBdWdtZW50IGEgZnVuY3Rpb24gZm9yIHNwZWNpYWwgdXNlIGJ5IFNpenpsZQoJbWFya0Z1bmN0aW9uID0gZnVuY3Rpb24oIGZuLCB2YWx1ZSApIHsKCQlmblsgZXhwYW5kbyBdID0gdmFsdWUgPT0gbnVsbCB8fCB2YWx1ZTsKCQlyZXR1cm4gZm47Cgl9LAoKCWNyZWF0ZUNhY2hlID0gZnVuY3Rpb24oKSB7CgkJdmFyIGNhY2hlID0ge30sCgkJCWtleXMgPSBbXTsKCgkJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCgkJCWlmICgga2V5cy5wdXNoKCBrZXkgKSA+IEV4cHIuY2FjaGVMZW5ndGggKSB7CgkJCQlkZWxldGUgY2FjaGVbIGtleXMuc2hpZnQoKSBdOwoJCQl9CgoJCQkvLyBSZXRyaWV2ZSB3aXRoIChrZXkgKyAiICIpIHRvIGF2b2lkIGNvbGxpc2lvbiB3aXRoIG5hdGl2ZSBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKHNlZSBJc3N1ZSAjMTU3KQoJCQlyZXR1cm4gKGNhY2hlWyBrZXkgKyAiICIgXSA9IHZhbHVlKTsKCQl9LCBjYWNoZSApOwoJfSwKCgljbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCXRva2VuQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJY29tcGlsZXJDYWNoZSA9IGNyZWF0ZUNhY2hlKCksCgoJLy8gUmVnZXgKCgkvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKCXdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSIsCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXN5bnRheC8jY2hhcmFjdGVycwoJY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58Wy1cXHddfFteXFx4MDAtXFx4YTBdKSsiLAoKCS8vIExvb3NlbHkgbW9kZWxlZCBvbiBDU1MgaWRlbnRpZmllciBjaGFyYWN0ZXJzCgkvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciAoaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMpCgkvLyBQcm9wZXIgc3ludGF4OiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjdmFsdWUtZGVmLWlkZW50aWZpZXIKCWlkZW50aWZpZXIgPSBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCAidyIsICJ3IyIgKSwKCgkvLyBBY2NlcHRhYmxlIG9wZXJhdG9ycyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKCW9wZXJhdG9ycyA9ICIoWypeJHwhfl0/PSkiLAoJYXR0cmlidXRlcyA9ICJcXFsiICsgd2hpdGVzcGFjZSArICIqKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiArIHdoaXRlc3BhY2UgKwoJCSIqKD86IiArIG9wZXJhdG9ycyArIHdoaXRlc3BhY2UgKyAiKig/OihbJ1wiXSkoKD86XFxcXC58W15cXFxcXSkqPylcXDN8KCIgKyBpZGVudGlmaWVyICsgIil8KXwpIiArIHdoaXRlc3BhY2UgKyAiKlxcXSIsCgoJLy8gUHJlZmVyIGFyZ3VtZW50cyBub3QgaW4gcGFyZW5zL2JyYWNrZXRzLAoJLy8gICB0aGVuIGF0dHJpYnV0ZSBzZWxlY3RvcnMgYW5kIG5vbi1wc2V1ZG9zIChkZW5vdGVkIGJ5IDopLAoJLy8gICB0aGVuIGFueXRoaW5nIGVsc2UKCS8vIFRoZXNlIHByZWZlcmVuY2VzIGFyZSBoZXJlIHRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycwoJLy8gICBuZWVkaW5nIHRva2VuaXplIGluIHRoZSBQU0VVRE8gcHJlRmlsdGVyCglwc2V1ZG9zID0gIjooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikoPzpcXCgoPzooWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwyfChbXigpW1xcXV0qfCg/Oig/OiIgKyBhdHRyaWJ1dGVzICsgIil8W146XXxcXFxcLikqfC4qKSlcXCl8KSIsCgoJLy8gRm9yIG1hdGNoRXhwci5QT1MgYW5kIG1hdGNoRXhwci5uZWVkc0NvbnRleHQKCXBvcyA9ICI6KGV2ZW58b2RkfGVxfGd0fGx0fG50aHxmaXJzdHxsYXN0KSg/OlxcKCIgKyB3aGl0ZXNwYWNlICsKCQkiKigoPzotXFxkKT9cXGQqKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSg/PVteLV18JCkiLAoKCS8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKCXJ0cmltID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgd2hpdGVzcGFjZSArICIrJCIsICJnIiApLAoKCXJjb21tYSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiApLAoJcmNvbWJpbmF0b3JzID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqKFtcXHgyMFxcdFxcclxcblxcZj4rfl0pIiArIHdoaXRlc3BhY2UgKyAiKiIgKSwKCXJwc2V1ZG8gPSBuZXcgUmVnRXhwKCBwc2V1ZG9zICksCgoJLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzCglycXVpY2tFeHByID0gL14oPzojKFtcd1wtXSspfChcdyspfFwuKFtcd1wtXSspKSQvLAoKCXJub3QgPSAvXjpub3QvLAoJcnNpYmxpbmcgPSAvW1x4MjBcdFxyXG5cZl0qWyt+XS8sCglyZW5kc1dpdGhOb3QgPSAvOm5vdFwoJC8sCgoJcmhlYWRlciA9IC9oXGQvaSwKCXJpbnB1dHMgPSAvaW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbi9pLAoKCXJiYWNrc2xhc2ggPSAvXFwoPyFcXCkvZywKCgltYXRjaEV4cHIgPSB7CgkJIklEIjogbmV3IFJlZ0V4cCggIl4jKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiApLAoJCSJDTEFTUyI6IG5ldyBSZWdFeHAoICJeXFwuKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiApLAoJCSJOQU1FIjogbmV3IFJlZ0V4cCggIl5cXFtuYW1lPVsnXCJdPygiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKVsnXCJdP1xcXSIgKSwKCQkiVEFHIjogbmV3IFJlZ0V4cCggIl4oIiArIGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncqIiApICsgIikiICksCgkJIkFUVFIiOiBuZXcgUmVnRXhwKCAiXiIgKyBhdHRyaWJ1dGVzICksCgkJIlBTRVVETyI6IG5ldyBSZWdFeHAoICJeIiArIHBzZXVkb3MgKSwKCQkiUE9TIjogbmV3IFJlZ0V4cCggcG9zLCAiaSIgKSwKCQkiQ0hJTEQiOiBuZXcgUmVnRXhwKCAiXjoob25seXxudGh8Zmlyc3R8bGFzdCktY2hpbGQoPzpcXCgiICsgd2hpdGVzcGFjZSArCgkJCSIqKGV2ZW58b2RkfCgoWystXXwpKFxcZCopbnwpIiArIHdoaXRlc3BhY2UgKyAiKig/OihbKy1dfCkiICsgd2hpdGVzcGFjZSArCgkJCSIqKFxcZCspfCkpIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpIiwgImkiICksCgkJLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCgkJIm5lZWRzQ29udGV4dCI6IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKls+K35dfCIgKyBwb3MsICJpIiApCgl9LAoKCS8vIFN1cHBvcnQKCgkvLyBVc2VkIGZvciB0ZXN0aW5nIHNvbWV0aGluZyBvbiBhbiBlbGVtZW50Cglhc3NlcnQgPSBmdW5jdGlvbiggZm4gKSB7CgkJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCQl0cnkgewoJCQlyZXR1cm4gZm4oIGRpdiApOwoJCX0gY2F0Y2ggKGUpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZmluYWxseSB7CgkJCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCgkJCWRpdiA9IG51bGw7CgkJfQoJfSwKCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIHJldHVybnMgb25seSBlbGVtZW50cwoJYXNzZXJ0VGFnTmFtZU5vQ29tbWVudHMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpICk7CgkJcmV0dXJuICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGg7Cgl9KSwKCgkvLyBDaGVjayBpZiBnZXRBdHRyaWJ1dGUgcmV0dXJucyBub3JtYWxpemVkIGhyZWYgYXR0cmlidXRlcwoJYXNzZXJ0SHJlZk5vdE5vcm1hbGl6ZWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoJCXJldHVybiBkaXYuZmlyc3RDaGlsZCAmJiB0eXBlb2YgZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYKCQkJZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIjIjsKCX0pLAoKCS8vIENoZWNrIGlmIGF0dHJpYnV0ZXMgc2hvdWxkIGJlIHJldHJpZXZlZCBieSBhdHRyaWJ1dGUgbm9kZXMKCWFzc2VydEF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuaW5uZXJIVE1MID0gIjxzZWxlY3Q+PC9zZWxlY3Q+IjsKCQl2YXIgdHlwZSA9IHR5cGVvZiBkaXYubGFzdENoaWxkLmdldEF0dHJpYnV0ZSgibXVsdGlwbGUiKTsKCQkvLyBJRTggcmV0dXJucyBhIHN0cmluZyBmb3Igc29tZSBhdHRyaWJ1dGVzIGV2ZW4gd2hlbiBub3QgcHJlc2VudAoJCXJldHVybiB0eXBlICE9PSAiYm9vbGVhbiIgJiYgdHlwZSAhPT0gInN0cmluZyI7Cgl9KSwKCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGNhbiBiZSB0cnVzdGVkCglhc3NlcnRVc2FibGVDbGFzc05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkvLyBPcGVyYSBjYW4ndCBmaW5kIGEgc2Vjb25kIGNsYXNzbmFtZSAoaW4gOS42KQoJCWRpdi5pbm5lckhUTUwgPSAiPGRpdiBjbGFzcz0naGlkZGVuIGUnPjwvZGl2PjxkaXYgY2xhc3M9J2hpZGRlbic+PC9kaXY+IjsKCQlpZiAoICFkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCAhZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImUiKS5sZW5ndGggKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIFNhZmFyaSAzLjIgY2FjaGVzIGNsYXNzIGF0dHJpYnV0ZXMgYW5kIGRvZXNuJ3QgY2F0Y2ggY2hhbmdlcwoJCWRpdi5sYXN0Q2hpbGQuY2xhc3NOYW1lID0gImUiOwoJCXJldHVybiBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZSIpLmxlbmd0aCA9PT0gMjsKCX0pLAoKCS8vIENoZWNrIGlmIGdldEVsZW1lbnRCeUlkIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZQoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeU5hbWUgcHJpdmlsZWdlcyBmb3JtIGNvbnRyb2xzIG9yIHJldHVybnMgZWxlbWVudHMgYnkgSUQKCWFzc2VydFVzYWJsZU5hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkvLyBJbmplY3QgY29udGVudAoJCWRpdi5pZCA9IGV4cGFuZG8gKyAwOwoJCWRpdi5pbm5lckhUTUwgPSAiPGEgbmFtZT0nIiArIGV4cGFuZG8gKyAiJz48L2E+PGRpdiBuYW1lPSciICsgZXhwYW5kbyArICInPjwvZGl2PiI7CgkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGRpdiwgZG9jRWxlbS5maXJzdENoaWxkICk7CgoJCS8vIFRlc3QKCQl2YXIgcGFzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lICYmCgkJCS8vIGJ1Z2d5IGJyb3dzZXJzIHdpbGwgcmV0dXJuIGZld2VyIHRoYW4gdGhlIGNvcnJlY3QgMgoJCQlkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aCA9PT0gMiArCgkJCS8vIGJ1Z2d5IGJyb3dzZXJzIHdpbGwgcmV0dXJuIG1vcmUgdGhhbiB0aGUgY29ycmVjdCAwCgkJCWRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKCBleHBhbmRvICsgMCApLmxlbmd0aDsKCQlhc3NlcnRHZXRJZE5vdE5hbWUgPSAhZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGV4cGFuZG8gKTsKCgkJLy8gQ2xlYW51cAoJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGRpdiApOwoKCQlyZXR1cm4gcGFzczsKCX0pOwoKLy8gSWYgc2xpY2UgaXMgbm90IGF2YWlsYWJsZSwgcHJvdmlkZSBhIGJhY2t1cAp0cnkgewoJc2xpY2UuY2FsbCggZG9jRWxlbS5jaGlsZE5vZGVzLCAwIClbMF0ubm9kZVR5cGU7Cn0gY2F0Y2ggKCBlICkgewoJc2xpY2UgPSBmdW5jdGlvbiggaSApIHsKCQl2YXIgZWxlbSwKCQkJcmVzdWx0cyA9IFtdOwoJCWZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKTsgaSsrICkgewoJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9Owp9CgpmdW5jdGlvbiBTaXp6bGUoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107Cgljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCXZhciBtYXRjaCwgZWxlbSwgeG1sLCBtLAoJCW5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZTsKCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCWlmICggbm9kZVR5cGUgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgKSB7CgkJcmV0dXJuIFtdOwoJfQoKCXhtbCA9IGlzWE1MKCBjb250ZXh0ICk7CgoJaWYgKCAheG1sICYmICFzZWVkICkgewoJCWlmICggKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApKSApIHsKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKCQkJaWYgKCAobSA9IG1hdGNoWzFdKSApIHsKCQkJCWlmICggbm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKTsKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUsIE9wZXJhLCBhbmQgV2Via2l0IHJldHVybiBpdGVtcwoJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJaWYgKCBlbGVtLmlkID09PSBtICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gQ29udGV4dCBpcyBub3QgYSBkb2N1bWVudAoJCQkJCWlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCgkJCQkJCWNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYgZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbChjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBzZWxlY3RvciApLCAwKSApOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgoJCQkvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQoJCQl9IGVsc2UgaWYgKCAobSA9IG1hdGNoWzNdKSAmJiBhc3NlcnRVc2FibGVDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbChjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIG0gKSwgMCkgKTsKCQkJCXJldHVybiByZXN1bHRzOwoJCQl9CgkJfQoJfQoKCS8vIEFsbCBvdGhlcnMKCXJldHVybiBzZWxlY3QoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQsIHhtbCApOwp9CgpTaXp6bGUubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBlbGVtZW50cyApIHsKCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIGVsZW1lbnRzICk7Cn07CgpTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsZW0sIGV4cHIgKSB7CglyZXR1cm4gU2l6emxlKCBleHByLCBudWxsLCBudWxsLCBbIGVsZW0gXSApLmxlbmd0aCA+IDA7Cn07CgovLyBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGlucHV0IHR5cGVzCmZ1bmN0aW9uIGNyZWF0ZUlucHV0UHNldWRvKCB0eXBlICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCX07Cn0KCi8vIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgYnV0dG9ucwpmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8oIHR5cGUgKSB7CglyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7Cgl9Owp9CgovLyBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIHBvc2l0aW9uYWxzCmZ1bmN0aW9uIGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oIGZuICkgewoJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggYXJndW1lbnQgKSB7CgkJYXJndW1lbnQgPSArYXJndW1lbnQ7CgkJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcyApIHsKCQkJdmFyIGosCgkJCQltYXRjaEluZGV4ZXMgPSBmbiggW10sIHNlZWQubGVuZ3RoLCBhcmd1bWVudCApLAoJCQkJaSA9IG1hdGNoSW5kZXhlcy5sZW5ndGg7CgoJCQkvLyBNYXRjaCBlbGVtZW50cyBmb3VuZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4ZXMKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlpZiAoIHNlZWRbIChqID0gbWF0Y2hJbmRleGVzW2ldKSBdICkgewoJCQkJCXNlZWRbal0gPSAhKG1hdGNoZXNbal0gPSBzZWVkW2pdKTsKCQkJCX0KCQkJfQoJCX0pOwoJfSk7Cn0KCi8qKgogKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0KICovCmdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJdmFyIG5vZGUsCgkJcmV0ID0gIiIsCgkJaSA9IDAsCgkJbm9kZVR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCWlmICggbm9kZVR5cGUgKSB7CgkJaWYgKCBub2RlVHlwZSA9PT0gMSB8fCBub2RlVHlwZSA9PT0gOSB8fCBub2RlVHlwZSA9PT0gMTEgKSB7CgkJCS8vIFVzZSB0ZXh0Q29udGVudCBmb3IgZWxlbWVudHMKCQkJLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoc2VlICMxMTE1MykKCQkJaWYgKCB0eXBlb2YgZWxlbS50ZXh0Q29udGVudCA9PT0gInN0cmluZyIgKSB7CgkJCQlyZXR1cm4gZWxlbS50ZXh0Q29udGVudDsKCQkJfSBlbHNlIHsKCQkJCS8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbgoJCQkJZm9yICggZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcgKSB7CgkJCQkJcmV0ICs9IGdldFRleHQoIGVsZW0gKTsKCQkJCX0KCQkJfQoJCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0ICkgewoJCQlyZXR1cm4gZWxlbS5ub2RlVmFsdWU7CgkJfQoJCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoJfSBlbHNlIHsKCgkJLy8gSWYgbm8gbm9kZVR5cGUsIHRoaXMgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gYXJyYXkKCQlmb3IgKCA7IChub2RlID0gZWxlbVtpXSk7IGkrKyApIHsKCQkJLy8gRG8gbm90IHRyYXZlcnNlIGNvbW1lbnQgbm9kZXMKCQkJcmV0ICs9IGdldFRleHQoIG5vZGUgKTsKCQl9Cgl9CglyZXR1cm4gcmV0Owp9OwoKaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiggZWxlbSApIHsKCS8vIGRvY3VtZW50RWxlbWVudCBpcyB2ZXJpZmllZCBmb3IgY2FzZXMgd2hlcmUgaXQgZG9lc24ndCB5ZXQgZXhpc3QKCS8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQoJdmFyIGRvY3VtZW50RWxlbWVudCA9IGVsZW0gJiYgKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKS5kb2N1bWVudEVsZW1lbnQ7CglyZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAiSFRNTCIgOiBmYWxzZTsKfTsKCi8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgpjb250YWlucyA9IFNpenpsZS5jb250YWlucyA9IGRvY0VsZW0uY29udGFpbnMgPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKCQkJYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CgkJcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiBhZG93bi5jb250YWlucyAmJiBhZG93bi5jb250YWlucyhidXApICk7Cgl9IDoKCWRvY0VsZW0uY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJcmV0dXJuIGIgJiYgISEoIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGIgKSAmIDE2ICk7Cgl9IDoKCWZ1bmN0aW9uKCBhLCBiICkgewoJCXdoaWxlICggKGIgPSBiLnBhcmVudE5vZGUpICkgewoJCQlpZiAoIGIgPT09IGEgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9OwoKU2l6emxlLmF0dHIgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCXZhciB2YWwsCgkJeG1sID0gaXNYTUwoIGVsZW0gKTsKCglpZiAoICF4bWwgKSB7CgkJbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCX0KCWlmICggKHZhbCA9IEV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdKSApIHsKCQlyZXR1cm4gdmFsKCBlbGVtICk7Cgl9CglpZiAoIHhtbCB8fCBhc3NlcnRBdHRyaWJ1dGVzICkgewoJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoJfQoJdmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICk7CglyZXR1cm4gdmFsID8KCQl0eXBlb2YgZWxlbVsgbmFtZSBdID09PSAiYm9vbGVhbiIgPwoJCQllbGVtWyBuYW1lIF0gPyBuYW1lIDogbnVsbCA6CgkJCXZhbC5zcGVjaWZpZWQgPyB2YWwudmFsdWUgOiBudWxsIDoKCQludWxsOwp9OwoKRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CgoJLy8gQ2FuIGJlIGFkanVzdGVkIGJ5IHRoZSB1c2VyCgljYWNoZUxlbmd0aDogNTAsCgoJY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sCgoJbWF0Y2g6IG1hdGNoRXhwciwKCgkvLyBJRTYvNyByZXR1cm4gYSBtb2RpZmllZCBocmVmCglhdHRySGFuZGxlOiBhc3NlcnRIcmVmTm90Tm9ybWFsaXplZCA/CgkJe30gOgoJCXsKCQkJImhyZWYiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggImhyZWYiLCAyICk7CgkJCX0sCgkJCSJ0eXBlIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKTsKCQkJfQoJCX0sCgoJZmluZDogewoJCSJJRCI6IGFzc2VydEdldElkTm90TmFtZSA/CgkJCWZ1bmN0aW9uKCBpZCwgY29udGV4dCwgeG1sICkgewoJCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmICF4bWwgKSB7CgkJCQkJdmFyIG0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBpZCApOwoJCQkJCS8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCgkJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwoJCQkJCXJldHVybiBtICYmIG0ucGFyZW50Tm9kZSA/IFttXSA6IFtdOwoJCQkJfQoJCQl9IDoKCQkJZnVuY3Rpb24oIGlkLCBjb250ZXh0LCB4bWwgKSB7CgkJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSBzdHJ1bmRlZmluZWQgJiYgIXhtbCApIHsKCQkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CgoJCQkJCXJldHVybiBtID8KCQkJCQkJbS5pZCA9PT0gaWQgfHwgdHlwZW9mIG0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIG0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKS52YWx1ZSA9PT0gaWQgPwoJCQkJCQkJW21dIDoKCQkJCQkJCXVuZGVmaW5lZCA6CgkJCQkJCVtdOwoJCQkJfQoJCQl9LAoKCQkiVEFHIjogYXNzZXJ0VGFnTmFtZU5vQ29tbWVudHMgPwoJCQlmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgewoJCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCQkJCX0KCQkJfSA6CgkJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCQl2YXIgcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJCS8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKCQkJCWlmICggdGFnID09PSAiKiIgKSB7CgkJCQkJdmFyIGVsZW0sCgkJCQkJCXRtcCA9IFtdLAoJCQkJCQlpID0gMDsKCgkJCQkJZm9yICggOyAoZWxlbSA9IHJlc3VsdHNbaV0pOyBpKysgKSB7CgkJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCXRtcC5wdXNoKCBlbGVtICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXJldHVybiB0bXA7CgkJCQl9CgkJCQlyZXR1cm4gcmVzdWx0czsKCQkJfSwKCgkJIk5BTUUiOiBhc3NlcnRVc2FibGVOYW1lICYmIGZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUgIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlOYW1lKCBuYW1lICk7CgkJCX0KCQl9LAoKCQkiQ0xBU1MiOiBhc3NlcnRVc2FibGVDbGFzc05hbWUgJiYgZnVuY3Rpb24oIGNsYXNzTmFtZSwgY29udGV4dCwgeG1sICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiAheG1sICkgewoJCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSggY2xhc3NOYW1lICk7CgkJCX0KCQl9Cgl9LAoKCXJlbGF0aXZlOiB7CgkJIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAoJCSIgIjogeyBkaXI6ICJwYXJlbnROb2RlIiB9LAoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LAoJCSJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KCX0sCgoJcHJlRmlsdGVyOiB7CgkJIkFUVFIiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggcmJhY2tzbGFzaCwgIiIgKTsKCgkJCS8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCgkJCW1hdGNoWzNdID0gKCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICk7CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbM10gPSAiICIgKyBtYXRjaFszXSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCA0ICk7CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQkvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCgkJCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKCQkJCTIgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCgkJCQkzIHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQoJCQkJNCBzaWduIG9mIHhuLWNvbXBvbmVudAoJCQkJNSB4IG9mIHhuLWNvbXBvbmVudAoJCQkJNiBzaWduIG9mIHktY29tcG9uZW50CgkJCQk3IHkgb2YgeS1jb21wb25lbnQKCQkJKi8KCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCBtYXRjaFsxXSA9PT0gIm50aCIgKSB7CgkJCQkvLyBudGgtY2hpbGQgcmVxdWlyZXMgYXJndW1lbnQKCQkJCWlmICggIW1hdGNoWzJdICkgewoJCQkJCVNpenpsZS5lcnJvciggbWF0Y2hbMF0gKTsKCQkJCX0KCgkJCQkvLyBudW1lcmljIHggYW5kIHkgcGFyYW1ldGVycyBmb3IgRXhwci5maWx0ZXIuQ0hJTEQKCQkJCS8vIHJlbWVtYmVyIHRoYXQgZmFsc2UvdHJ1ZSBjYXN0IHJlc3BlY3RpdmVseSB0byAwLzEKCQkJCW1hdGNoWzNdID0gKyggbWF0Y2hbM10gPyBtYXRjaFs0XSArIChtYXRjaFs1XSB8fCAxKSA6IDIgKiAoIG1hdGNoWzJdID09PSAiZXZlbiIgfHwgbWF0Y2hbMl0gPT09ICJvZGQiICkgKTsKCQkJCW1hdGNoWzRdID0gKyggKCBtYXRjaFs2XSArIG1hdGNoWzddICkgfHwgbWF0Y2hbMl0gPT09ICJvZGQiICk7CgoJCQkvLyBvdGhlciB0eXBlcyBwcm9oaWJpdCBhcmd1bWVudHMKCQkJfSBlbHNlIGlmICggbWF0Y2hbMl0gKSB7CgkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCX0KCgkJCXJldHVybiBtYXRjaDsKCQl9LAoKCQkiUFNFVURPIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQl2YXIgdW5xdW90ZWQsIGV4Y2VzczsKCQkJaWYgKCBtYXRjaEV4cHJbIkNISUxEIl0udGVzdCggbWF0Y2hbMF0gKSApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQlpZiAoIG1hdGNoWzNdICkgewoJCQkJbWF0Y2hbMl0gPSBtYXRjaFszXTsKCQkJfSBlbHNlIGlmICggKHVucXVvdGVkID0gbWF0Y2hbNF0pICkgewoJCQkJLy8gT25seSBjaGVjayBhcmd1bWVudHMgdGhhdCBjb250YWluIGEgcHNldWRvCgkJCQlpZiAoIHJwc2V1ZG8udGVzdCh1bnF1b3RlZCkgJiYKCQkJCQkvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQoJCQkJCShleGNlc3MgPSB0b2tlbml6ZSggdW5xdW90ZWQsIHRydWUgKSkgJiYKCQkJCQkvLyBhZHZhbmNlIHRvIHRoZSBuZXh0IGNsb3NpbmcgcGFyZW50aGVzaXMKCQkJCQkoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZiggIikiLCB1bnF1b3RlZC5sZW5ndGggLSBleGNlc3MgKSAtIHVucXVvdGVkLmxlbmd0aCkgKSB7CgoJCQkJCS8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CgkJCQkJdW5xdW90ZWQgPSB1bnF1b3RlZC5zbGljZSggMCwgZXhjZXNzICk7CgkJCQkJbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCwgZXhjZXNzICk7CgkJCQl9CgkJCQltYXRjaFsyXSA9IHVucXVvdGVkOwoJCQl9CgoJCQkvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCAzICk7CgkJfQoJfSwKCglmaWx0ZXI6IHsKCQkiSUQiOiBhc3NlcnRHZXRJZE5vdE5hbWUgPwoJCQlmdW5jdGlvbiggaWQgKSB7CgkJCQlpZCA9IGlkLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICk7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09PSBpZDsKCQkJCX07CgkJCX0gOgoJCQlmdW5jdGlvbiggaWQgKSB7CgkJCQlpZCA9IGlkLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICk7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQkJCXJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGlkOwoJCQkJfTsKCQkJfSwKCgkJIlRBRyI6IGZ1bmN0aW9uKCBub2RlTmFtZSApIHsKCQkJaWYgKCBub2RlTmFtZSA9PT0gIioiICkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfTsKCQkJfQoJCQlub2RlTmFtZSA9IG5vZGVOYW1lLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICkudG9Mb3dlckNhc2UoKTsKCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWU7CgkJCX07CgkJfSwKCgkJIkNMQVNTIjogZnVuY3Rpb24oIGNsYXNzTmFtZSApIHsKCQkJdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlWyBleHBhbmRvIF1bIGNsYXNzTmFtZSArICIgIiBdOwoKCQkJcmV0dXJuIHBhdHRlcm4gfHwKCQkJCShwYXR0ZXJuID0gbmV3IFJlZ0V4cCggIihefCIgKyB3aGl0ZXNwYWNlICsgIikiICsgY2xhc3NOYW1lICsgIigiICsgd2hpdGVzcGFjZSArICJ8JCkiICkpICYmCgkJCQljbGFzc0NhY2hlKCBjbGFzc05hbWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBwYXR0ZXJuLnRlc3QoIGVsZW0uY2xhc3NOYW1lIHx8ICh0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09IHN0cnVuZGVmaW5lZCAmJiBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3MiKSkgfHwgIiIgKTsKCQkJCX0pOwoJCX0sCgoJCSJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0ICkgewoJCQkJdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkJaWYgKCByZXN1bHQgPT0gbnVsbCApIHsKCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7CgkJCQl9CgkJCQlpZiAoICFvcGVyYXRvciApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCgkJCQlyZXN1bHQgKz0gIiI7CgoJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiPSIgPyByZXN1bHQgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAiXj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPT09IDAgOgoJCQkJCW9wZXJhdG9yID09PSAiKj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPiAtMSA6CgkJCQkJb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc3Vic3RyKCByZXN1bHQubGVuZ3RoIC0gY2hlY2subGVuZ3RoICkgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIn49IiA/ICggIiAiICsgcmVzdWx0ICsgIiAiICkuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKCQkJCQlvcGVyYXRvciA9PT0gInw9IiA/IHJlc3VsdCA9PT0gY2hlY2sgfHwgcmVzdWx0LnN1YnN0ciggMCwgY2hlY2subGVuZ3RoICsgMSApID09PSBjaGVjayArICItIiA6CgkJCQkJZmFsc2U7CgkJCX07CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIHR5cGUsIGFyZ3VtZW50LCBmaXJzdCwgbGFzdCApIHsKCgkJCWlmICggdHlwZSA9PT0gIm50aCIgKSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJdmFyIG5vZGUsIGRpZmYsCgkJCQkJCXBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCgkJCQkJaWYgKCBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgoJCQkJCWlmICggcGFyZW50ICkgewoJCQkJCQlkaWZmID0gMDsKCQkJCQkJZm9yICggbm9kZSA9IHBhcmVudC5maXJzdENoaWxkOyBub2RlOyBub2RlID0gbm9kZS5uZXh0U2libGluZyApIHsKCQkJCQkJCWlmICggbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCQlkaWZmKys7CgkJCQkJCQkJaWYgKCBlbGVtID09PSBub2RlICkgewoJCQkJCQkJCQlicmVhazsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIEluY29ycG9yYXRlIHRoZSBvZmZzZXQgKG9yIGNhc3QgdG8gTmFOKSwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKCQkJCQlkaWZmIC09IGxhc3Q7CgkJCQkJcmV0dXJuIGRpZmYgPT09IGZpcnN0IHx8ICggZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwICk7CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgbm9kZSA9IGVsZW07CgoJCQkJc3dpdGNoICggdHlwZSApIHsKCQkJCQljYXNlICJvbmx5IjoKCQkJCQljYXNlICJmaXJzdCI6CgkJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykgKSB7CgkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQlpZiAoIHR5cGUgPT09ICJmaXJzdCIgKSB7CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoKCQkJCQkJbm9kZSA9IGVsZW07CgoJCQkJCQkvKiBmYWxscyB0aHJvdWdoICovCgkJCQkJY2FzZSAibGFzdCI6CgkJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSApIHsKCQkJCQkJCWlmICggbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9OwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggcHNldWRvLCBhcmd1bWVudCApIHsKCQkJLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKCQkJLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMKCQkJLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwoJCQl2YXIgYXJncywKCQkJCWZuID0gRXhwci5wc2V1ZG9zWyBwc2V1ZG8gXSB8fCBFeHByLnNldEZpbHRlcnNbIHBzZXVkby50b0xvd2VyQ2FzZSgpIF0gfHwKCQkJCQlTaXp6bGUuZXJyb3IoICJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBwc2V1ZG8gKTsKCgkJCS8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKCQkJLy8gYXJndW1lbnRzIGFyZSBuZWVkZWQgdG8gY3JlYXRlIHRoZSBmaWx0ZXIgZnVuY3Rpb24KCQkJLy8ganVzdCBhcyBTaXp6bGUgZG9lcwoJCQlpZiAoIGZuWyBleHBhbmRvIF0gKSB7CgkJCQlyZXR1cm4gZm4oIGFyZ3VtZW50ICk7CgkJCX0KCgkJCS8vIEJ1dCBtYWludGFpbiBzdXBwb3J0IGZvciBvbGQgc2lnbmF0dXJlcwoJCQlpZiAoIGZuLmxlbmd0aCA+IDEgKSB7CgkJCQlhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07CgkJCQlyZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KCBwc2V1ZG8udG9Mb3dlckNhc2UoKSApID8KCQkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCQkJCXZhciBpZHgsCgkJCQkJCQltYXRjaGVkID0gZm4oIHNlZWQsIGFyZ3VtZW50ICksCgkJCQkJCQlpID0gbWF0Y2hlZC5sZW5ndGg7CgkJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQkJaWR4ID0gaW5kZXhPZi5jYWxsKCBzZWVkLCBtYXRjaGVkW2ldICk7CgkJCQkJCQlzZWVkWyBpZHggXSA9ICEoIG1hdGNoZXNbIGlkeCBdID0gbWF0Y2hlZFtpXSApOwoJCQkJCQl9CgkJCQkJfSkgOgoJCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCQlyZXR1cm4gZm4oIGVsZW0sIDAsIGFyZ3MgKTsKCQkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZm47CgkJfQoJfSwKCglwc2V1ZG9zOiB7CgkJIm5vdCI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJCS8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCgkJCS8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCgkJCS8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwoJCQl2YXIgaW5wdXQgPSBbXSwKCQkJCXJlc3VsdHMgPSBbXSwKCQkJCW1hdGNoZXIgPSBjb21waWxlKCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApICk7CgoJCQlyZXR1cm4gbWF0Y2hlclsgZXhwYW5kbyBdID8KCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBlbGVtLAoJCQkJCQl1bm1hdGNoZWQgPSBtYXRjaGVyKCBzZWVkLCBudWxsLCB4bWwsIFtdICksCgkJCQkJCWkgPSBzZWVkLmxlbmd0aDsKCgkJCQkJLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJCQkJCXNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pIDoKCQkJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJaW5wdXRbMF0gPSBlbGVtOwoJCQkJCW1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsKCQkJCQlyZXR1cm4gIXJlc3VsdHMucG9wKCk7CgkJCQl9OwoJCX0pLAoKCQkiaGFzIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFNpenpsZSggc2VsZWN0b3IsIGVsZW0gKS5sZW5ndGggPiAwOwoJCQl9OwoJCX0pLAoKCQkiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAoIGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dCggZWxlbSApICkuaW5kZXhPZiggdGV4dCApID4gLTE7CgkJCX07CgkJfSksCgoJCSJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZTsKCQl9LAoKCQkiZGlzYWJsZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJImNoZWNrZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCgkJCXZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCkgfHwgKG5vZGVOYW1lID09PSAib3B0aW9uIiAmJiAhIWVsZW0uc2VsZWN0ZWQpOwoJCX0sCgoJCSJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQllbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CgkJfSwKCgkJInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwoJCX0sCgoJCSJlbXB0eSI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2VtcHR5LXBzZXVkbwoJCQkvLyA6ZW1wdHkgaXMgb25seSBhZmZlY3RlZCBieSBlbGVtZW50IG5vZGVzIGFuZCBjb250ZW50IG5vZGVzKGluY2x1ZGluZyB0ZXh0KDMpLCBjZGF0YSg0KSksCgkJCS8vICAgbm90IGNvbW1lbnQsIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb25zLCBvciBvdGhlcnMKCQkJLy8gVGhhbmtzIHRvIERpZWdvIFBlcmluaSBmb3IgdGhlIG5vZGVOYW1lIHNob3J0Y3V0CgkJCS8vICAgR3JlYXRlciB0aGFuICJAIiBtZWFucyBhbHBoYSBjaGFyYWN0ZXJzIChzcGVjaWZpY2FsbHkgbm90IHN0YXJ0aW5nIHdpdGggIiMiIG9yICI/IikKCQkJdmFyIG5vZGVUeXBlOwoJCQllbGVtID0gZWxlbS5maXJzdENoaWxkOwoJCQl3aGlsZSAoIGVsZW0gKSB7CgkJCQlpZiAoIGVsZW0ubm9kZU5hbWUgPiAiQCIgfHwgKG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZSkgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmc7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJImhlYWRlciI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gcmhlYWRlci50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCgkJInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIHR5cGUsIGF0dHI7CgkJCS8vIElFNiBhbmQgNyB3aWxsIG1hcCBlbGVtLnR5cGUgdG8gJ3RleHQnIGZvciBuZXcgSFRNTDUgdHlwZXMgKHNlYXJjaCwgZXRjKQoJCQkvLyB1c2UgZ2V0QXR0cmlidXRlIGluc3RlYWQgdG8gdGVzdCB0aGlzIGNhc2UKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJgoJCQkJKHR5cGUgPSBlbGVtLnR5cGUpID09PSAidGV4dCIgJiYKCQkJCSggKGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpKSA9PSBudWxsIHx8IGF0dHIudG9Mb3dlckNhc2UoKSA9PT0gdHlwZSApOwoJCX0sCgoJCS8vIElucHV0IHR5cGVzCgkJInJhZGlvIjogY3JlYXRlSW5wdXRQc2V1ZG8oInJhZGlvIiksCgkJImNoZWNrYm94IjogY3JlYXRlSW5wdXRQc2V1ZG8oImNoZWNrYm94IiksCgkJImZpbGUiOiBjcmVhdGVJbnB1dFBzZXVkbygiZmlsZSIpLAoJCSJwYXNzd29yZCI6IGNyZWF0ZUlucHV0UHNldWRvKCJwYXNzd29yZCIpLAoJCSJpbWFnZSI6IGNyZWF0ZUlucHV0UHNldWRvKCJpbWFnZSIpLAoKCQkic3VibWl0IjogY3JlYXRlQnV0dG9uUHNldWRvKCJzdWJtaXQiKSwKCQkicmVzZXQiOiBjcmVhdGVCdXR0b25Qc2V1ZG8oInJlc2V0IiksCgoJCSJidXR0b24iOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CgkJfSwKCgkJImlucHV0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaW5wdXRzLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiZm9jdXMiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGRvYyA9IGVsZW0ub3duZXJEb2N1bWVudDsKCQkJcmV0dXJuIGVsZW0gPT09IGRvYy5hY3RpdmVFbGVtZW50ICYmICghZG9jLmhhc0ZvY3VzIHx8IGRvYy5oYXNGb2N1cygpKSAmJiAhIShlbGVtLnR5cGUgfHwgZWxlbS5ocmVmIHx8IH5lbGVtLnRhYkluZGV4KTsKCQl9LAoKCQkiYWN0aXZlIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBlbGVtLm93bmVyRG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCQl9LAoKCQkvLyBQb3NpdGlvbmFsIHR5cGVzCgkJImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbigpIHsKCQkJcmV0dXJuIFsgMCBdOwoJCX0pLAoKCQkibGFzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQlyZXR1cm4gWyBsZW5ndGggLSAxIF07CgkJfSksCgoJCSJlcSI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJcmV0dXJuIFsgYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudCBdOwoJCX0pLAoKCQkiZXZlbiI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJIm9kZCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQlmb3IgKCB2YXIgaSA9IDE7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJImx0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewoJCQlmb3IgKCB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7IC0taSA+PSAwOyApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewoJCQlmb3IgKCB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7ICsraSA8IGxlbmd0aDsgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSkKCX0KfTsKCmZ1bmN0aW9uIHNpYmxpbmdDaGVjayggYSwgYiwgcmV0ICkgewoJaWYgKCBhID09PSBiICkgewoJCXJldHVybiByZXQ7Cgl9CgoJdmFyIGN1ciA9IGEubmV4dFNpYmxpbmc7CgoJd2hpbGUgKCBjdXIgKSB7CgkJaWYgKCBjdXIgPT09IGIgKSB7CgkJCXJldHVybiAtMTsKCQl9CgoJCWN1ciA9IGN1ci5uZXh0U2libGluZzsKCX0KCglyZXR1cm4gMTsKfQoKc29ydE9yZGVyID0gZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/CglmdW5jdGlvbiggYSwgYiApIHsKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJCXJldHVybiAwOwoJCX0KCgkJcmV0dXJuICggIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gfHwgIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwoJCQlhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIDoKCQkJYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQKCQkpID8gLTEgOiAxOwoJfSA6CglmdW5jdGlvbiggYSwgYiApIHsKCQkvLyBUaGUgbm9kZXMgYXJlIGlkZW50aWNhbCwgd2UgY2FuIGV4aXQgZWFybHkKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJCXJldHVybiAwOwoKCQkvLyBGYWxsYmFjayB0byB1c2luZyBzb3VyY2VJbmRleCAoaW4gSUUpIGlmIGl0J3MgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKCQl9IGVsc2UgaWYgKCBhLnNvdXJjZUluZGV4ICYmIGIuc291cmNlSW5kZXggKSB7CgkJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCQl9CgoJCXZhciBhbCwgYmwsCgkJCWFwID0gW10sCgkJCWJwID0gW10sCgkJCWF1cCA9IGEucGFyZW50Tm9kZSwKCQkJYnVwID0gYi5wYXJlbnROb2RlLAoJCQljdXIgPSBhdXA7CgoJCS8vIElmIHRoZSBub2RlcyBhcmUgc2libGluZ3MgKG9yIGlkZW50aWNhbCkgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sKCQlpZiAoIGF1cCA9PT0gYnVwICkgewoJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhLCBiICk7CgoJCS8vIElmIG5vIHBhcmVudHMgd2VyZSBmb3VuZCB0aGVuIHRoZSBub2RlcyBhcmUgZGlzY29ubmVjdGVkCgkJfSBlbHNlIGlmICggIWF1cCApIHsKCQkJcmV0dXJuIC0xOwoKCQl9IGVsc2UgaWYgKCAhYnVwICkgewoJCQlyZXR1cm4gMTsKCQl9CgoJCS8vIE90aGVyd2lzZSB0aGV5J3JlIHNvbWV3aGVyZSBlbHNlIGluIHRoZSB0cmVlIHNvIHdlIG5lZWQKCQkvLyB0byBidWlsZCB1cCBhIGZ1bGwgbGlzdCBvZiB0aGUgcGFyZW50Tm9kZXMgZm9yIGNvbXBhcmlzb24KCQl3aGlsZSAoIGN1ciApIHsKCQkJYXAudW5zaGlmdCggY3VyICk7CgkJCWN1ciA9IGN1ci5wYXJlbnROb2RlOwoJCX0KCgkJY3VyID0gYnVwOwoKCQl3aGlsZSAoIGN1ciApIHsKCQkJYnAudW5zaGlmdCggY3VyICk7CgkJCWN1ciA9IGN1ci5wYXJlbnROb2RlOwoJCX0KCgkJYWwgPSBhcC5sZW5ndGg7CgkJYmwgPSBicC5sZW5ndGg7CgoJCS8vIFN0YXJ0IHdhbGtpbmcgZG93biB0aGUgdHJlZSBsb29raW5nIGZvciBhIGRpc2NyZXBhbmN5CgkJZm9yICggdmFyIGkgPSAwOyBpIDwgYWwgJiYgaSA8IGJsOyBpKysgKSB7CgkJCWlmICggYXBbaV0gIT09IGJwW2ldICkgewoJCQkJcmV0dXJuIHNpYmxpbmdDaGVjayggYXBbaV0sIGJwW2ldICk7CgkJCX0KCQl9CgoJCS8vIFdlIGVuZGVkIHNvbWVwbGFjZSB1cCB0aGUgdHJlZSBzbyBkbyBhIHNpYmxpbmcgY2hlY2sKCQlyZXR1cm4gaSA9PT0gYWwgPwoJCQlzaWJsaW5nQ2hlY2soIGEsIGJwW2ldLCAtMSApIDoKCQkJc2libGluZ0NoZWNrKCBhcFtpXSwgYiwgMSApOwoJfTsKCi8vIEFsd2F5cyBhc3N1bWUgdGhlIHByZXNlbmNlIG9mIGR1cGxpY2F0ZXMgaWYgc29ydCBkb2Vzbid0Ci8vIHBhc3MgdGhlbSB0byBvdXIgY29tcGFyaXNvbiBmdW5jdGlvbiAoYXMgaW4gR29vZ2xlIENocm9tZSkuClswLCAwXS5zb3J0KCBzb3J0T3JkZXIgKTsKYmFzZUhhc0R1cGxpY2F0ZSA9ICFoYXNEdXBsaWNhdGU7CgovLyBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzClNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24oIHJlc3VsdHMgKSB7Cgl2YXIgZWxlbSwKCQlkdXBsaWNhdGVzID0gW10sCgkJaSA9IDEsCgkJaiA9IDA7CgoJaGFzRHVwbGljYXRlID0gYmFzZUhhc0R1cGxpY2F0ZTsKCXJlc3VsdHMuc29ydCggc29ydE9yZGVyICk7CgoJaWYgKCBoYXNEdXBsaWNhdGUgKSB7CgkJZm9yICggOyAoZWxlbSA9IHJlc3VsdHNbaV0pOyBpKysgKSB7CgkJCWlmICggZWxlbSA9PT0gcmVzdWx0c1sgaSAtIDEgXSApIHsKCQkJCWogPSBkdXBsaWNhdGVzLnB1c2goIGkgKTsKCQkJfQoJCX0KCQl3aGlsZSAoIGotLSApIHsKCQkJcmVzdWx0cy5zcGxpY2UoIGR1cGxpY2F0ZXNbIGogXSwgMSApOwoJCX0KCX0KCglyZXR1cm4gcmVzdWx0czsKfTsKClNpenpsZS5lcnJvciA9IGZ1bmN0aW9uKCBtc2cgKSB7Cgl0aHJvdyBuZXcgRXJyb3IoICJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnICk7Cn07CgpmdW5jdGlvbiB0b2tlbml6ZSggc2VsZWN0b3IsIHBhcnNlT25seSApIHsKCXZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLAoJCXNvRmFyLCBncm91cHMsIHByZUZpbHRlcnMsCgkJY2FjaGVkID0gdG9rZW5DYWNoZVsgZXhwYW5kbyBdWyBzZWxlY3RvciArICIgIiBdOwoKCWlmICggY2FjaGVkICkgewoJCXJldHVybiBwYXJzZU9ubHkgPyAwIDogY2FjaGVkLnNsaWNlKCAwICk7Cgl9CgoJc29GYXIgPSBzZWxlY3RvcjsKCWdyb3VwcyA9IFtdOwoJcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwoKCXdoaWxlICggc29GYXIgKSB7CgoJCS8vIENvbW1hIGFuZCBmaXJzdCBydW4KCQlpZiAoICFtYXRjaGVkIHx8IChtYXRjaCA9IHJjb21tYS5leGVjKCBzb0ZhciApKSApIHsKCQkJaWYgKCBtYXRjaCApIHsKCQkJCS8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkCgkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaFswXS5sZW5ndGggKSB8fCBzb0ZhcjsKCQkJfQoJCQlncm91cHMucHVzaCggdG9rZW5zID0gW10gKTsKCQl9CgoJCW1hdGNoZWQgPSBmYWxzZTsKCgkJLy8gQ29tYmluYXRvcnMKCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKCQkJdG9rZW5zLnB1c2goIG1hdGNoZWQgPSBuZXcgVG9rZW4oIG1hdGNoLnNoaWZ0KCkgKSApOwoJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaGVkLmxlbmd0aCApOwoKCQkJLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCgkJCW1hdGNoZWQudHlwZSA9IG1hdGNoWzBdLnJlcGxhY2UoIHJ0cmltLCAiICIgKTsKCQl9CgoJCS8vIEZpbHRlcnMKCQlmb3IgKCB0eXBlIGluIEV4cHIuZmlsdGVyICkgewoJCQlpZiAoIChtYXRjaCA9IG1hdGNoRXhwclsgdHlwZSBdLmV4ZWMoIHNvRmFyICkpICYmICghcHJlRmlsdGVyc1sgdHlwZSBdIHx8CgkJCQkobWF0Y2ggPSBwcmVGaWx0ZXJzWyB0eXBlIF0oIG1hdGNoICkpKSApIHsKCgkJCQl0b2tlbnMucHVzaCggbWF0Y2hlZCA9IG5ldyBUb2tlbiggbWF0Y2guc2hpZnQoKSApICk7CgkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaGVkLmxlbmd0aCApOwoJCQkJbWF0Y2hlZC50eXBlID0gdHlwZTsKCQkJCW1hdGNoZWQubWF0Y2hlcyA9IG1hdGNoOwoJCQl9CgkJfQoKCQlpZiAoICFtYXRjaGVkICkgewoJCQlicmVhazsKCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSBsZW5ndGggb2YgdGhlIGludmFsaWQgZXhjZXNzCgkvLyBpZiB3ZSdyZSBqdXN0IHBhcnNpbmcKCS8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2VucwoJcmV0dXJuIHBhcnNlT25seSA/CgkJc29GYXIubGVuZ3RoIDoKCQlzb0ZhciA/CgkJCVNpenpsZS5lcnJvciggc2VsZWN0b3IgKSA6CgkJCS8vIENhY2hlIHRoZSB0b2tlbnMKCQkJdG9rZW5DYWNoZSggc2VsZWN0b3IsIGdyb3VwcyApLnNsaWNlKCAwICk7Cn0KCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UgKSB7Cgl2YXIgZGlyID0gY29tYmluYXRvci5kaXIsCgkJY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYgY29tYmluYXRvci5kaXIgPT09ICJwYXJlbnROb2RlIiwKCQlkb25lTmFtZSA9IGRvbmUrKzsKCglyZXR1cm4gY29tYmluYXRvci5maXJzdCA/CgkJLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCWlmICggY2hlY2tOb25FbGVtZW50cyB8fCBlbGVtLm5vZGVUeXBlID09PSAxICApIHsKCQkJCQlyZXR1cm4gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICk7CgkJCQl9CgkJCX0KCQl9IDoKCgkJLy8gQ2hlY2sgYWdhaW5zdCBhbGwgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnRzCgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJLy8gV2UgY2FuJ3Qgc2V0IGFyYml0cmFyeSBkYXRhIG9uIFhNTCBub2Rlcywgc28gdGhleSBkb24ndCBiZW5lZml0IGZyb20gZGlyIGNhY2hpbmcKCQkJaWYgKCAheG1sICkgewoJCQkJdmFyIGNhY2hlLAoJCQkJCWRpcmtleSA9IGRpcnJ1bnMgKyAiICIgKyBkb25lTmFtZSArICIgIiwKCQkJCQljYWNoZWRrZXkgPSBkaXJrZXkgKyBjYWNoZWRydW5zOwoJCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCQlpZiAoIGNoZWNrTm9uRWxlbWVudHMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJaWYgKCAoY2FjaGUgPSBlbGVtWyBleHBhbmRvIF0pID09PSBjYWNoZWRrZXkgKSB7CgkJCQkJCQlyZXR1cm4gZWxlbS5zaXpzZXQ7CgkJCQkJCX0gZWxzZSBpZiAoIHR5cGVvZiBjYWNoZSA9PT0gInN0cmluZyIgJiYgY2FjaGUuaW5kZXhPZihkaXJrZXkpID09PSAwICkgewoJCQkJCQkJaWYgKCBlbGVtLnNpenNldCApIHsKCQkJCQkJCQlyZXR1cm4gZWxlbTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWVsZW1bIGV4cGFuZG8gXSA9IGNhY2hlZGtleTsKCQkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQkJZWxlbS5zaXpzZXQgPSB0cnVlOwoJCQkJCQkJCXJldHVybiBlbGVtOwoJCQkJCQkJfQoJCQkJCQkJZWxlbS5zaXpzZXQgPSBmYWxzZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBjaGVja05vbkVsZW1lbnRzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQlyZXR1cm4gZWxlbTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX07Cn0KCmZ1bmN0aW9uIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApIHsKCXJldHVybiBtYXRjaGVycy5sZW5ndGggPiAxID8KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlpZiAoICFtYXRjaGVyc1tpXSggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gOgoJCW1hdGNoZXJzWzBdOwp9CgpmdW5jdGlvbiBjb25kZW5zZSggdW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sICkgewoJdmFyIGVsZW0sCgkJbmV3VW5tYXRjaGVkID0gW10sCgkJaSA9IDAsCgkJbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwKCQltYXBwZWQgPSBtYXAgIT0gbnVsbDsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQluZXdVbm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJaWYgKCBtYXBwZWQgKSB7CgkJCQkJbWFwLnB1c2goIGkgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4gbmV3VW5tYXRjaGVkOwp9CgpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7CglpZiAoIHBvc3RGaWx0ZXIgJiYgIXBvc3RGaWx0ZXJbIGV4cGFuZG8gXSApIHsKCQlwb3N0RmlsdGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbHRlciApOwoJfQoJaWYgKCBwb3N0RmluZGVyICYmICFwb3N0RmluZGVyWyBleHBhbmRvIF0gKSB7CgkJcG9zdEZpbmRlciA9IHNldE1hdGNoZXIoIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvciApOwoJfQoJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sICkgewoJCXZhciB0ZW1wLCBpLCBlbGVtLAoJCQlwcmVNYXAgPSBbXSwKCQkJcG9zdE1hcCA9IFtdLAoJCQlwcmVleGlzdGluZyA9IHJlc3VsdHMubGVuZ3RoLAoKCQkJLy8gR2V0IGluaXRpYWwgZWxlbWVudHMgZnJvbSBzZWVkIG9yIGNvbnRleHQKCQkJZWxlbXMgPSBzZWVkIHx8IG11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yIHx8ICIqIiwgY29udGV4dC5ub2RlVHlwZSA/IFsgY29udGV4dCBdIDogY29udGV4dCwgW10gKSwKCgkJCS8vIFByZWZpbHRlciB0byBnZXQgbWF0Y2hlciBpbnB1dCwgcHJlc2VydmluZyBhIG1hcCBmb3Igc2VlZC1yZXN1bHRzIHN5bmNocm9uaXphdGlvbgoJCQltYXRjaGVySW4gPSBwcmVGaWx0ZXIgJiYgKCBzZWVkIHx8ICFzZWxlY3RvciApID8KCQkJCWNvbmRlbnNlKCBlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCApIDoKCQkJCWVsZW1zLAoKCQkJbWF0Y2hlck91dCA9IG1hdGNoZXIgPwoJCQkJLy8gSWYgd2UgaGF2ZSBhIHBvc3RGaW5kZXIsIG9yIGZpbHRlcmVkIHNlZWQsIG9yIG5vbi1zZWVkIHBvc3RGaWx0ZXIgb3IgcHJlZXhpc3RpbmcgcmVzdWx0cywKCQkJCXBvc3RGaW5kZXIgfHwgKCBzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlciApID8KCgkJCQkJLy8gLi4uaW50ZXJtZWRpYXRlIHByb2Nlc3NpbmcgaXMgbmVjZXNzYXJ5CgkJCQkJW10gOgoKCQkJCQkvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKCQkJCQlyZXN1bHRzIDoKCQkJCW1hdGNoZXJJbjsKCgkJLy8gRmluZCBwcmltYXJ5IG1hdGNoZXMKCQlpZiAoIG1hdGNoZXIgKSB7CgkJCW1hdGNoZXIoIG1hdGNoZXJJbiwgbWF0Y2hlck91dCwgY29udGV4dCwgeG1sICk7CgkJfQoKCQkvLyBBcHBseSBwb3N0RmlsdGVyCgkJaWYgKCBwb3N0RmlsdGVyICkgewoJCQl0ZW1wID0gY29uZGVuc2UoIG1hdGNoZXJPdXQsIHBvc3RNYXAgKTsKCQkJcG9zdEZpbHRlciggdGVtcCwgW10sIGNvbnRleHQsIHhtbCApOwoKCQkJLy8gVW4tbWF0Y2ggZmFpbGluZyBlbGVtZW50cyBieSBtb3ZpbmcgdGhlbSBiYWNrIHRvIG1hdGNoZXJJbgoJCQlpID0gdGVtcC5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCAoZWxlbSA9IHRlbXBbaV0pICkgewoJCQkJCW1hdGNoZXJPdXRbIHBvc3RNYXBbaV0gXSA9ICEobWF0Y2hlckluWyBwb3N0TWFwW2ldIF0gPSBlbGVtKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBzZWVkICkgewoJCQlpZiAoIHBvc3RGaW5kZXIgfHwgcHJlRmlsdGVyICkgewoJCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJCS8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwoJCQkJCXRlbXAgPSBbXTsKCQkJCQlpID0gbWF0Y2hlck91dC5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSApIHsKCQkJCQkJCS8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoCgkJCQkJCQl0ZW1wLnB1c2goIChtYXRjaGVySW5baV0gPSBlbGVtKSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXBvc3RGaW5kZXIoIG51bGwsIChtYXRjaGVyT3V0ID0gW10pLCB0ZW1wLCB4bWwgKTsKCQkJCX0KCgkJCQkvLyBNb3ZlIG1hdGNoZWQgZWxlbWVudHMgZnJvbSBzZWVkIHRvIHJlc3VsdHMgdG8ga2VlcCB0aGVtIHN5bmNocm9uaXplZAoJCQkJaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmCgkJCQkJCSh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbCggc2VlZCwgZWxlbSApIDogcHJlTWFwW2ldKSA+IC0xICkgewoKCQkJCQkJc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKCQl9IGVsc2UgewoJCQltYXRjaGVyT3V0ID0gY29uZGVuc2UoCgkJCQltYXRjaGVyT3V0ID09PSByZXN1bHRzID8KCQkJCQltYXRjaGVyT3V0LnNwbGljZSggcHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoICkgOgoJCQkJCW1hdGNoZXJPdXQKCQkJKTsKCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJcG9zdEZpbmRlciggbnVsbCwgcmVzdWx0cywgbWF0Y2hlck91dCwgeG1sICk7CgkJCX0gZWxzZSB7CgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBtYXRjaGVyT3V0ICk7CgkJCX0KCQl9Cgl9KTsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnMoIHRva2VucyApIHsKCXZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosCgkJbGVuID0gdG9rZW5zLmxlbmd0aCwKCQlsZWFkaW5nUmVsYXRpdmUgPSBFeHByLnJlbGF0aXZlWyB0b2tlbnNbMF0udHlwZSBdLAoJCWltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsiICJdLAoJCWkgPSBsZWFkaW5nUmVsYXRpdmUgPyAxIDogMCwKCgkJLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKCQltYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKCQl9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlICksCgkJbWF0Y2hBbnlDb250ZXh0ID0gYWRkQ29tYmluYXRvciggZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBpbmRleE9mLmNhbGwoIGNoZWNrQ29udGV4dCwgZWxlbSApID4gLTE7CgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAoJCW1hdGNoZXJzID0gWyBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQlyZXR1cm4gKCAhbGVhZGluZ1JlbGF0aXZlICYmICggeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQgKSApIHx8ICgKCQkJCShjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CgkJCQkJbWF0Y2hDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSA6CgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOwoJCX0gXTsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2ldLnR5cGUgXSkgKSB7CgkJCW1hdGNoZXJzID0gWyBhZGRDb21iaW5hdG9yKCBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwgbWF0Y2hlciApIF07CgkJfSBlbHNlIHsKCQkJbWF0Y2hlciA9IEV4cHIuZmlsdGVyWyB0b2tlbnNbaV0udHlwZSBdLmFwcGx5KCBudWxsLCB0b2tlbnNbaV0ubWF0Y2hlcyApOwoKCQkJLy8gUmV0dXJuIHNwZWNpYWwgdXBvbiBzZWVpbmcgYSBwb3NpdGlvbmFsIG1hdGNoZXIKCQkJaWYgKCBtYXRjaGVyWyBleHBhbmRvIF0gKSB7CgkJCQkvLyBGaW5kIHRoZSBuZXh0IHJlbGF0aXZlIG9wZXJhdG9yIChpZiBhbnkpIGZvciBwcm9wZXIgaGFuZGxpbmcKCQkJCWogPSArK2k7CgkJCQlmb3IgKCA7IGogPCBsZW47IGorKyApIHsKCQkJCQlpZiAoIEV4cHIucmVsYXRpdmVbIHRva2Vuc1tqXS50eXBlIF0gKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBzZXRNYXRjaGVyKAoJCQkJCWkgPiAxICYmIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApLAoJCQkJCWkgPiAxICYmIHRva2Vucy5zbGljZSggMCwgaSAtIDEgKS5qb2luKCIiKS5yZXBsYWNlKCBydHJpbSwgIiQxIiApLAoJCQkJCW1hdGNoZXIsCgkJCQkJaSA8IGogJiYgbWF0Y2hlckZyb21Ub2tlbnMoIHRva2Vucy5zbGljZSggaSwgaiApICksCgkJCQkJaiA8IGxlbiAmJiBtYXRjaGVyRnJvbVRva2VucyggKHRva2VucyA9IHRva2Vucy5zbGljZSggaiApKSApLAoJCQkJCWogPCBsZW4gJiYgdG9rZW5zLmpvaW4oIiIpCgkJCQkpOwoJCQl9CgkJCW1hdGNoZXJzLnB1c2goIG1hdGNoZXIgKTsKCQl9Cgl9CgoJcmV0dXJuIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMgKSB7Cgl2YXIgYnlTZXQgPSBzZXRNYXRjaGVycy5sZW5ndGggPiAwLAoJCWJ5RWxlbWVudCA9IGVsZW1lbnRNYXRjaGVycy5sZW5ndGggPiAwLAoJCXN1cGVyTWF0Y2hlciA9IGZ1bmN0aW9uKCBzZWVkLCBjb250ZXh0LCB4bWwsIHJlc3VsdHMsIGV4cGFuZENvbnRleHQgKSB7CgkJCXZhciBlbGVtLCBqLCBtYXRjaGVyLAoJCQkJc2V0TWF0Y2hlZCA9IFtdLAoJCQkJbWF0Y2hlZENvdW50ID0gMCwKCQkJCWkgPSAiMCIsCgkJCQl1bm1hdGNoZWQgPSBzZWVkICYmIFtdLAoJCQkJb3V0ZXJtb3N0ID0gZXhwYW5kQ29udGV4dCAhPSBudWxsLAoJCQkJY29udGV4dEJhY2t1cCA9IG91dGVybW9zdENvbnRleHQsCgkJCQkvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIGNvbnRleHQKCQkJCWVsZW1zID0gc2VlZCB8fCBieUVsZW1lbnQgJiYgRXhwci5maW5kWyJUQUciXSggIioiLCBleHBhbmRDb250ZXh0ICYmIGNvbnRleHQucGFyZW50Tm9kZSB8fCBjb250ZXh0ICksCgkJCQkvLyBOZXN0ZWQgbWF0Y2hlcnMgc2hvdWxkIHVzZSBub24taW50ZWdlciBkaXJydW5zCgkJCQlkaXJydW5zVW5pcXVlID0gKGRpcnJ1bnMgKz0gY29udGV4dEJhY2t1cCA9PSBudWxsID8gMSA6IE1hdGguRSk7CgoJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0ICE9PSBkb2N1bWVudCAmJiBjb250ZXh0OwoJCQkJY2FjaGVkcnVucyA9IHN1cGVyTWF0Y2hlci5lbDsKCQkJfQoKCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMKCQkJZm9yICggOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCQlpZiAoIGJ5RWxlbWVudCAmJiBlbGVtICkgewoJCQkJCWZvciAoIGogPSAwOyAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqXSk7IGorKyApIHsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQkJCWRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwoJCQkJCQljYWNoZWRydW5zID0gKytzdXBlck1hdGNoZXIuZWw7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFRyYWNrIHVubWF0Y2hlZCBlbGVtZW50cyBmb3Igc2V0IGZpbHRlcnMKCQkJCWlmICggYnlTZXQgKSB7CgkJCQkJLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycwoJCQkJCWlmICggKGVsZW0gPSAhbWF0Y2hlciAmJiBlbGVtKSApIHsKCQkJCQkJbWF0Y2hlZENvdW50LS07CgkJCQkJfQoKCQkJCQkvLyBMZW5ndGhlbiB0aGUgYXJyYXkgZm9yIGV2ZXJ5IGVsZW1lbnQsIG1hdGNoZWQgb3Igbm90CgkJCQkJaWYgKCBzZWVkICkgewoJCQkJCQl1bm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gQXBwbHkgc2V0IGZpbHRlcnMgdG8gdW5tYXRjaGVkIGVsZW1lbnRzCgkJCW1hdGNoZWRDb3VudCArPSBpOwoJCQlpZiAoIGJ5U2V0ICYmIGkgIT09IG1hdGNoZWRDb3VudCApIHsKCQkJCWZvciAoIGogPSAwOyAobWF0Y2hlciA9IHNldE1hdGNoZXJzW2pdKTsgaisrICkgewoJCQkJCW1hdGNoZXIoIHVubWF0Y2hlZCwgc2V0TWF0Y2hlZCwgY29udGV4dCwgeG1sICk7CgkJCQl9CgoJCQkJaWYgKCBzZWVkICkgewoJCQkJCS8vIFJlaW50ZWdyYXRlIGVsZW1lbnQgbWF0Y2hlcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHNvcnRpbmcKCQkJCQlpZiAoIG1hdGNoZWRDb3VudCA+IDAgKSB7CgkJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQkJaWYgKCAhKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSApIHsKCQkJCQkJCQlzZXRNYXRjaGVkW2ldID0gcG9wLmNhbGwoIHJlc3VsdHMgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gRGlzY2FyZCBpbmRleCBwbGFjZWhvbGRlciB2YWx1ZXMgdG8gZ2V0IG9ubHkgYWN0dWFsIG1hdGNoZXMKCQkJCQlzZXRNYXRjaGVkID0gY29uZGVuc2UoIHNldE1hdGNoZWQgKTsKCQkJCX0KCgkJCQkvLyBBZGQgbWF0Y2hlcyB0byByZXN1bHRzCgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBzZXRNYXRjaGVkICk7CgoJCQkJLy8gU2VlZGxlc3Mgc2V0IG1hdGNoZXMgc3VjY2VlZGluZyBtdWx0aXBsZSBzdWNjZXNzZnVsIG1hdGNoZXJzIHN0aXB1bGF0ZSBzb3J0aW5nCgkJCQlpZiAoIG91dGVybW9zdCAmJiAhc2VlZCAmJiBzZXRNYXRjaGVkLmxlbmd0aCA+IDAgJiYKCQkJCQkoIG1hdGNoZWRDb3VudCArIHNldE1hdGNoZXJzLmxlbmd0aCApID4gMSApIHsKCgkJCQkJU2l6emxlLnVuaXF1ZVNvcnQoIHJlc3VsdHMgKTsKCQkJCX0KCQkJfQoKCQkJLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzCgkJCWlmICggb3V0ZXJtb3N0ICkgewoJCQkJZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKCQkJfQoKCQkJcmV0dXJuIHVubWF0Y2hlZDsKCQl9OwoKCXN1cGVyTWF0Y2hlci5lbCA9IDA7CglyZXR1cm4gYnlTZXQgPwoJCW1hcmtGdW5jdGlvbiggc3VwZXJNYXRjaGVyICkgOgoJCXN1cGVyTWF0Y2hlcjsKfQoKY29tcGlsZSA9IFNpenpsZS5jb21waWxlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBncm91cCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLyApIHsKCXZhciBpLAoJCXNldE1hdGNoZXJzID0gW10sCgkJZWxlbWVudE1hdGNoZXJzID0gW10sCgkJY2FjaGVkID0gY29tcGlsZXJDYWNoZVsgZXhwYW5kbyBdWyBzZWxlY3RvciArICIgIiBdOwoKCWlmICggIWNhY2hlZCApIHsKCQkvLyBHZW5lcmF0ZSBhIGZ1bmN0aW9uIG9mIHJlY3Vyc2l2ZSBmdW5jdGlvbnMgdGhhdCBjYW4gYmUgdXNlZCB0byBjaGVjayBlYWNoIGVsZW1lbnQKCQlpZiAoICFncm91cCApIHsKCQkJZ3JvdXAgPSB0b2tlbml6ZSggc2VsZWN0b3IgKTsKCQl9CgkJaSA9IGdyb3VwLmxlbmd0aDsKCQl3aGlsZSAoIGktLSApIHsKCQkJY2FjaGVkID0gbWF0Y2hlckZyb21Ub2tlbnMoIGdyb3VwW2ldICk7CgkJCWlmICggY2FjaGVkWyBleHBhbmRvIF0gKSB7CgkJCQlzZXRNYXRjaGVycy5wdXNoKCBjYWNoZWQgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnRNYXRjaGVycy5wdXNoKCBjYWNoZWQgKTsKCQkJfQoJCX0KCgkJLy8gQ2FjaGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCgkJY2FjaGVkID0gY29tcGlsZXJDYWNoZSggc2VsZWN0b3IsIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApICk7Cgl9CglyZXR1cm4gY2FjaGVkOwp9OwoKZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IsIGNvbnRleHRzLCByZXN1bHRzICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IGNvbnRleHRzLmxlbmd0aDsKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCVNpenpsZSggc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzICk7Cgl9CglyZXR1cm4gcmVzdWx0czsKfQoKZnVuY3Rpb24gc2VsZWN0KCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCwgeG1sICkgewoJdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCgkJbWF0Y2ggPSB0b2tlbml6ZSggc2VsZWN0b3IgKSwKCQlqID0gbWF0Y2gubGVuZ3RoOwoKCWlmICggIXNlZWQgKSB7CgkJLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgZ3JvdXAKCQlpZiAoIG1hdGNoLmxlbmd0aCA9PT0gMSApIHsKCgkJCS8vIFRha2UgYSBzaG9ydGN1dCBhbmQgc2V0IHRoZSBjb250ZXh0IGlmIHRoZSByb290IHNlbGVjdG9yIGlzIGFuIElECgkJCXRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAgKTsKCQkJaWYgKCB0b2tlbnMubGVuZ3RoID4gMiAmJiAodG9rZW4gPSB0b2tlbnNbMF0pLnR5cGUgPT09ICJJRCIgJiYKCQkJCQljb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmICF4bWwgJiYKCQkJCQlFeHByLnJlbGF0aXZlWyB0b2tlbnNbMV0udHlwZSBdICkgewoKCQkJCWNvbnRleHQgPSBFeHByLmZpbmRbIklEIl0oIHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZSggcmJhY2tzbGFzaCwgIiIgKSwgY29udGV4dCwgeG1sIClbMF07CgkJCQlpZiAoICFjb250ZXh0ICkgewoJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJfQoKCQkJCXNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UoIHRva2Vucy5zaGlmdCgpLmxlbmd0aCApOwoJCQl9CgoJCQkvLyBGZXRjaCBhIHNlZWQgc2V0IGZvciByaWdodC10by1sZWZ0IG1hdGNoaW5nCgkJCWZvciAoIGkgPSBtYXRjaEV4cHJbIlBPUyJdLnRlc3QoIHNlbGVjdG9yICkgPyAtMSA6IHRva2Vucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCXRva2VuID0gdG9rZW5zW2ldOwoKCQkJCS8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKCQkJCWlmICggRXhwci5yZWxhdGl2ZVsgKHR5cGUgPSB0b2tlbi50eXBlKSBdICkgewoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsKCQkJCQkvLyBTZWFyY2gsIGV4cGFuZGluZyBjb250ZXh0IGZvciBsZWFkaW5nIHNpYmxpbmcgY29tYmluYXRvcnMKCQkJCQlpZiAoIChzZWVkID0gZmluZCgKCQkJCQkJdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCByYmFja3NsYXNoLCAiIiApLAoJCQkJCQlyc2libGluZy50ZXN0KCB0b2tlbnNbMF0udHlwZSApICYmIGNvbnRleHQucGFyZW50Tm9kZSB8fCBjb250ZXh0LAoJCQkJCQl4bWwKCQkJCQkpKSApIHsKCgkJCQkJCS8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQoJCQkJCQl0b2tlbnMuc3BsaWNlKCBpLCAxICk7CgkJCQkJCXNlbGVjdG9yID0gc2VlZC5sZW5ndGggJiYgdG9rZW5zLmpvaW4oIiIpOwoJCQkJCQlpZiAoICFzZWxlY3RvciApIHsKCQkJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoIHNlZWQsIDAgKSApOwoJCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJCX0KCgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBDb21waWxlIGFuZCBleGVjdXRlIGEgZmlsdGVyaW5nIGZ1bmN0aW9uCgkvLyBQcm92aWRlIGBtYXRjaGAgdG8gYXZvaWQgcmV0b2tlbml6YXRpb24gaWYgd2UgbW9kaWZpZWQgdGhlIHNlbGVjdG9yIGFib3ZlCgljb21waWxlKCBzZWxlY3RvciwgbWF0Y2ggKSgKCQlzZWVkLAoJCWNvbnRleHQsCgkJeG1sLAoJCXJlc3VsdHMsCgkJcnNpYmxpbmcudGVzdCggc2VsZWN0b3IgKQoJKTsKCXJldHVybiByZXN1bHRzOwp9CgppZiAoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwgKSB7CgkoZnVuY3Rpb24oKSB7CgkJdmFyIGRpc2Nvbm5lY3RlZE1hdGNoLAoJCQlvbGRTZWxlY3QgPSBzZWxlY3QsCgkJCXJlc2NhcGUgPSAvJ3xcXC9nLAoJCQlyYXR0cmlidXRlUXVvdGVzID0gL1w9W1x4MjBcdFxyXG5cZl0qKFteJyJcXV0qKVtceDIwXHRcclxuXGZdKlxdL2csCgoJCQkvLyBxU2EoOmZvY3VzKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoQ2hyb21lIDIxKSwgbm8gbmVlZCB0byBhbHNvIGFkZCB0byBidWdneU1hdGNoZXMgc2luY2UgbWF0Y2hlcyBjaGVja3MgYnVnZ3lRU0EKCQkJLy8gQSBzdXBwb3J0IHRlc3Qgd291bGQgcmVxdWlyZSB0b28gbXVjaCBjb2RlICh3b3VsZCBpbmNsdWRlIGRvY3VtZW50IHJlYWR5KQoJCQlyYnVnZ3lRU0EgPSBbICI6Zm9jdXMiIF0sCgoJCQkvLyBtYXRjaGVzU2VsZWN0b3IoOmFjdGl2ZSkgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKElFOS9PcGVyYSAxMS41KQoJCQkvLyBBIHN1cHBvcnQgdGVzdCB3b3VsZCByZXF1aXJlIHRvbyBtdWNoIGNvZGUgKHdvdWxkIGluY2x1ZGUgZG9jdW1lbnQgcmVhZHkpCgkJCS8vIGp1c3Qgc2tpcCBtYXRjaGVzU2VsZWN0b3IgZm9yIDphY3RpdmUKCQkJcmJ1Z2d5TWF0Y2hlcyA9IFsgIjphY3RpdmUiIF0sCgkJCW1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXNTZWxlY3RvciB8fAoJCQkJZG9jRWxlbS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKCQkJCWRvY0VsZW0ud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8CgkJCQlkb2NFbGVtLm9NYXRjaGVzU2VsZWN0b3IgfHwKCQkJCWRvY0VsZW0ubXNNYXRjaGVzU2VsZWN0b3I7CgoJCS8vIEJ1aWxkIFFTQSByZWdleAoJCS8vIFJlZ2V4IHN0cmF0ZWd5IGFkb3B0ZWQgZnJvbSBEaWVnbyBQZXJpbmkKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkJLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQoJCQkvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY3RseQoJCQkvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKCQkJLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkKCQkJZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCgkJCS8vIElFOCAtIFNvbWUgYm9vbGVhbiBhdHRyaWJ1dGVzIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKCQkJaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooPzpjaGVja2VkfGRpc2FibGVkfGlzbWFwfG11bHRpcGxlfHJlYWRvbmx5fHNlbGVjdGVkfHZhbHVlKSIgKTsKCQkJfQoKCQkJLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIChkbyBub3QgcHV0IHRlc3RzIGFmdGVyIHRoaXMgb25lKQoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKCQkJfQoJCX0pOwoKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCgkJCS8vIE9wZXJhIDEwLTEyL0lFOSAtIF49ICQ9ICo9IGFuZCBlbXB0eSB2YWx1ZXMKCQkJLy8gU2hvdWxkIG5vdCBzZWxlY3QgYW55dGhpbmcKCQkJZGl2LmlubmVySFRNTCA9ICI8cCB0ZXN0PScnPjwvcD4iOwoJCQlpZiAoIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCJbdGVzdF49JyddIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJbKl4kXT0iICsgd2hpdGVzcGFjZSArICIqKD86XCJcInwnJykiICk7CgkJCX0KCgkJCS8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCgkJCS8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSAoZG8gbm90IHB1dCB0ZXN0cyBhZnRlciB0aGlzIG9uZSkKCQkJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQgdHlwZT0naGlkZGVuJy8+IjsKCQkJaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIjplbmFibGVkIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goIjplbmFibGVkIiwgIjpkaXNhYmxlZCIpOwoJCQl9CgkJfSk7CgoJCS8vIHJidWdneVFTQSBhbHdheXMgY29udGFpbnMgOmZvY3VzLCBzbyBubyBuZWVkIGZvciBhIGxlbmd0aCBjaGVjawoJCXJidWdneVFTQSA9IC8qIHJidWdneVFTQS5sZW5ndGggJiYgKi8gbmV3IFJlZ0V4cCggcmJ1Z2d5UVNBLmpvaW4oInwiKSApOwoKCQlzZWxlY3QgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQsIHhtbCApIHsKCQkJLy8gT25seSB1c2UgcXVlcnlTZWxlY3RvckFsbCB3aGVuIG5vdCBmaWx0ZXJpbmcsCgkJCS8vIHdoZW4gdGhpcyBpcyBub3QgeG1sLAoJCQkvLyBhbmQgd2hlbiBubyBRU0EgYnVncyBhcHBseQoJCQlpZiAoICFzZWVkICYmICF4bWwgJiYgIXJidWdneVFTQS50ZXN0KCBzZWxlY3RvciApICkgewoJCQkJdmFyIGdyb3VwcywgaSwKCQkJCQlvbGQgPSB0cnVlLAoJCQkJCW5pZCA9IGV4cGFuZG8sCgkJCQkJbmV3Q29udGV4dCA9IGNvbnRleHQsCgkJCQkJbmV3U2VsZWN0b3IgPSBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmIHNlbGVjdG9yOwoKCQkJCS8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwoJCQkJLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAoJCQkJLy8gYW5kIHdvcmtpbmcgdXAgZnJvbSB0aGVyZSAoVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoZSB0ZWNobmlxdWUpCgkJCQkvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKCQkJCWlmICggY29udGV4dC5ub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiICkgewoJCQkJCWdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKCQkJCQlpZiAoIChvbGQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgiaWQiKSkgKSB7CgkJCQkJCW5pZCA9IG9sZC5yZXBsYWNlKCByZXNjYXBlLCAiXFwkJiIgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQljb250ZXh0LnNldEF0dHJpYnV0ZSggImlkIiwgbmlkICk7CgkJCQkJfQoJCQkJCW5pZCA9ICJbaWQ9JyIgKyBuaWQgKyAiJ10gIjsKCgkJCQkJaSA9IGdyb3Vwcy5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWdyb3Vwc1tpXSA9IG5pZCArIGdyb3Vwc1tpXS5qb2luKCIiKTsKCQkJCQl9CgkJCQkJbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgY29udGV4dC5wYXJlbnROb2RlIHx8IGNvbnRleHQ7CgkJCQkJbmV3U2VsZWN0b3IgPSBncm91cHMuam9pbigiLCIpOwoJCQkJfQoKCQkJCWlmICggbmV3U2VsZWN0b3IgKSB7CgkJCQkJdHJ5IHsKCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbCggbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKAoJCQkJCQkJbmV3U2VsZWN0b3IKCQkJCQkJKSwgMCApICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0gY2F0Y2gocXNhRXJyb3IpIHsKCQkJCQl9IGZpbmFsbHkgewoJCQkJCQlpZiAoICFvbGQgKSB7CgkJCQkJCQljb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgiaWQiKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIG9sZFNlbGVjdCggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQsIHhtbCApOwoJCX07CgoJCWlmICggbWF0Y2hlcyApIHsKCQkJYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJCQkvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKCQkJCS8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUgKElFIDkpCgkJCQlkaXNjb25uZWN0ZWRNYXRjaCA9IG1hdGNoZXMuY2FsbCggZGl2LCAiZGl2IiApOwoKCQkJCS8vIFRoaXMgc2hvdWxkIGZhaWwgd2l0aCBhbiBleGNlcHRpb24KCQkJCS8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKCQkJCXRyeSB7CgkJCQkJbWF0Y2hlcy5jYWxsKCBkaXYsICJbdGVzdCE9JyddOnNpenpsZSIgKTsKCQkJCQlyYnVnZ3lNYXRjaGVzLnB1c2goICIhPSIsIHBzZXVkb3MgKTsKCQkJCX0gY2F0Y2ggKCBlICkge30KCQkJfSk7CgoJCQkvLyByYnVnZ3lNYXRjaGVzIGFsd2F5cyBjb250YWlucyA6YWN0aXZlIGFuZCA6Zm9jdXMsIHNvIG5vIG5lZWQgZm9yIGEgbGVuZ3RoIGNoZWNrCgkJCXJidWdneU1hdGNoZXMgPSAvKiByYnVnZ3lNYXRjaGVzLmxlbmd0aCAmJiAqLyBuZXcgUmVnRXhwKCByYnVnZ3lNYXRjaGVzLmpvaW4oInwiKSApOwoKCQkJU2l6emxlLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbGVtLCBleHByICkgewoJCQkJLy8gTWFrZSBzdXJlIHRoYXQgYXR0cmlidXRlIHNlbGVjdG9ycyBhcmUgcXVvdGVkCgkJCQlleHByID0gZXhwci5yZXBsYWNlKCByYXR0cmlidXRlUXVvdGVzLCAiPSckMSddIiApOwoKCQkJCS8vIHJidWdneU1hdGNoZXMgYWx3YXlzIGNvbnRhaW5zIDphY3RpdmUsIHNvIG5vIG5lZWQgZm9yIGFuIGV4aXN0ZW5jZSBjaGVjawoJCQkJaWYgKCAhaXNYTUwoIGVsZW0gKSAmJiAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KCBleHByICkgJiYgIXJidWdneVFTQS50ZXN0KCBleHByICkgKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIHJldCA9IG1hdGNoZXMuY2FsbCggZWxlbSwgZXhwciApOwoKCQkJCQkJLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoJCQkJCQlpZiAoIHJldCB8fCBkaXNjb25uZWN0ZWRNYXRjaCB8fAoJCQkJCQkJCS8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CgkJCQkJCQkJLy8gZnJhZ21lbnQgaW4gSUUgOQoJCQkJCQkJCWVsZW0uZG9jdW1lbnQgJiYgZWxlbS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEgKSB7CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9CgkJCQkJfSBjYXRjaChlKSB7fQoJCQkJfQoKCQkJCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIFsgZWxlbSBdICkubGVuZ3RoID4gMDsKCQkJfTsKCQl9Cgl9KSgpOwp9CgovLyBEZXByZWNhdGVkCkV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07CgovLyBCYWNrLWNvbXBhdApmdW5jdGlvbiBzZXRGaWx0ZXJzKCkge30KRXhwci5maWx0ZXJzID0gc2V0RmlsdGVycy5wcm90b3R5cGUgPSBFeHByLnBzZXVkb3M7CkV4cHIuc2V0RmlsdGVycyA9IG5ldyBzZXRGaWx0ZXJzKCk7CgovLyBPdmVycmlkZSBzaXp6bGUgYXR0cmlidXRlIHJldHJpZXZhbApTaXp6bGUuYXR0ciA9IGpRdWVyeS5hdHRyOwpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgp9KSggd2luZG93ICk7CnZhciBydW50aWwgPSAvVW50aWwkLywKCXJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAoJaXNTaW1wbGUgPSAvXi5bXjojXFtcLixdKiQvLAoJcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dCwKCS8vIG1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0CglndWFyYW50ZWVkVW5pcXVlID0gewoJCWNoaWxkcmVuOiB0cnVlLAoJCWNvbnRlbnRzOiB0cnVlLAoJCW5leHQ6IHRydWUsCgkJcHJldjogdHJ1ZQoJfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBpLCBsLCBsZW5ndGgsIG4sIHIsIHJldCwKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlmb3IgKCBpID0gMCwgbCA9IHNlbGYubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCBzZWxmWyBpIF0sIHRoaXMgKSApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldCA9IHRoaXMucHVzaFN0YWNrKCAiIiwgImZpbmQiLCBzZWxlY3RvciApOwoKCQlmb3IgKCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQlsZW5ndGggPSByZXQubGVuZ3RoOwoJCQlqUXVlcnkuZmluZCggc2VsZWN0b3IsIHRoaXNbaV0sIHJldCApOwoKCQkJaWYgKCBpID4gMCApIHsKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSByZXN1bHRzIGFyZSB1bmlxdWUKCQkJCWZvciAoIG4gPSBsZW5ndGg7IG4gPCByZXQubGVuZ3RoOyBuKysgKSB7CgkJCQkJZm9yICggciA9IDA7IHIgPCBsZW5ndGg7IHIrKyApIHsKCQkJCQkJaWYgKCByZXRbcl0gPT09IHJldFtuXSApIHsKCQkJCQkJCXJldC5zcGxpY2Uobi0tLCAxKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgloYXM6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdmFyIGksCgkJCXRhcmdldHMgPSBqUXVlcnkoIHRhcmdldCwgdGhpcyApLAoJCQlsZW4gPSB0YXJnZXRzLmxlbmd0aDsKCgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQkJaWYgKCBqUXVlcnkuY29udGFpbnMoIHRoaXMsIHRhcmdldHNbaV0gKSApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJfQoJCX0pOwoJfSwKCglub3Q6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgZmFsc2UpLCAibm90Iiwgc2VsZWN0b3IpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgdHJ1ZSksICJmaWx0ZXIiLCBzZWxlY3RvciApOwoJfSwKCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiAhIXNlbGVjdG9yICYmICgKCQkJdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiA/CgkJCQkvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CgkJCQkvLyBzbyAkKCJwOmZpcnN0IikuaXMoInA6bGFzdCIpIHdvbid0IHJldHVybiB0cnVlIGZvciBhIGRvYyB3aXRoIHR3byAicCIuCgkJCQlybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICkgPwoJCQkJCWpRdWVyeSggc2VsZWN0b3IsIHRoaXMuY29udGV4dCApLmluZGV4KCB0aGlzWzBdICkgPj0gMCA6CgkJCQkJalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwIDoKCQkJCXRoaXMuZmlsdGVyKCBzZWxlY3RvciApLmxlbmd0aCA+IDAgKTsKCX0sCgoJY2xvc2VzdDogZnVuY3Rpb24oIHNlbGVjdG9ycywgY29udGV4dCApIHsKCQl2YXIgY3VyLAoJCQlpID0gMCwKCQkJbCA9IHRoaXMubGVuZ3RoLAoJCQlyZXQgPSBbXSwKCQkJcG9zID0gcm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvcnMgKSB8fCB0eXBlb2Ygc2VsZWN0b3JzICE9PSAic3RyaW5nIiA/CgkJCQlqUXVlcnkoIHNlbGVjdG9ycywgY29udGV4dCB8fCB0aGlzLmNvbnRleHQgKSA6CgkJCQkwOwoKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWN1ciA9IHRoaXNbaV07CgoJCQl3aGlsZSAoIGN1ciAmJiBjdXIub3duZXJEb2N1bWVudCAmJiBjdXIgIT09IGNvbnRleHQgJiYgY3VyLm5vZGVUeXBlICE9PSAxMSApIHsKCQkJCWlmICggcG9zID8gcG9zLmluZGV4KGN1cikgPiAtMSA6IGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykgKSB7CgkJCQkJcmV0LnB1c2goIGN1ciApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJCX0KCQl9CgoJCXJldCA9IHJldC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQ7CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggcmV0LCAiY2xvc2VzdCIsIHNlbGVjdG9ycyApOwoJfSwKCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluCgkvLyB0aGUgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMKCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCgkJLy8gTm8gYXJndW1lbnQsIHJldHVybiBpbmRleCBpbiBwYXJlbnQKCQlpZiAoICFlbGVtICkgewoJCQlyZXR1cm4gKCB0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSApID8gdGhpcy5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CgkJfQoKCQkvLyBpbmRleCBpbiBzZWxlY3RvcgoJCWlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoIHRoaXNbMF0sIGpRdWVyeSggZWxlbSApICk7CgkJfQoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoCgkJCS8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAoJCQllbGVtLmpxdWVyeSA/IGVsZW1bMF0gOiBlbGVtLCB0aGlzICk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXZhciBzZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KCQkJCWpRdWVyeSggc2VsZWN0b3IsIGNvbnRleHQgKSA6CgkJCQlqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciAmJiBzZWxlY3Rvci5ub2RlVHlwZSA/IFsgc2VsZWN0b3IgXSA6IHNlbGVjdG9yICksCgkJCWFsbCA9IGpRdWVyeS5tZXJnZSggdGhpcy5nZXQoKSwgc2V0ICk7CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggaXNEaXNjb25uZWN0ZWQoIHNldFswXSApIHx8IGlzRGlzY29ubmVjdGVkKCBhbGxbMF0gKSA/CgkJCWFsbCA6CgkJCWpRdWVyeS51bmlxdWUoIGFsbCApICk7Cgl9LAoKCWFkZEJhY2s6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwoJCQl0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKHNlbGVjdG9yKQoJCSk7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmFuZFNlbGYgPSBqUXVlcnkuZm4uYWRkQmFjazsKCi8vIEEgcGFpbmZ1bGx5IHNpbXBsZSBjaGVjayB0byBzZWUgaWYgYW4gZWxlbWVudCBpcyBkaXNjb25uZWN0ZWQKLy8gZnJvbSBhIGRvY3VtZW50IChzaG91bGQgYmUgaW1wcm92ZWQsIHdoZXJlIGZlYXNpYmxlKS4KZnVuY3Rpb24gaXNEaXNjb25uZWN0ZWQoIG5vZGUgKSB7CglyZXR1cm4gIW5vZGUgfHwgIW5vZGUucGFyZW50Tm9kZSB8fCBub2RlLnBhcmVudE5vZGUubm9kZVR5cGUgPT09IDExOwp9CgpmdW5jdGlvbiBzaWJsaW5nKCBjdXIsIGRpciApIHsKCWRvIHsKCQljdXIgPSBjdXJbIGRpciBdOwoJfSB3aGlsZSAoIGN1ciAmJiBjdXIubm9kZVR5cGUgIT09IDEgKTsKCglyZXR1cm4gY3VyOwp9CgpqUXVlcnkuZWFjaCh7CglwYXJlbnQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkJcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKCX0sCglwYXJlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiICk7Cgl9LAoJcGFyZW50c1VudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwgKTsKCX0sCgluZXh0OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gc2libGluZyggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXY6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciICk7Cgl9LAoJcHJldkFsbDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7Cgl9LAoJbmV4dFVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsICk7Cgl9LAoJcHJldlVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciLCB1bnRpbCApOwoJfSwKCXNpYmxpbmdzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoICggZWxlbS5wYXJlbnROb2RlIHx8IHt9ICkuZmlyc3RDaGlsZCwgZWxlbSApOwoJfSwKCWNoaWxkcmVuOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoIGVsZW0uZmlyc3RDaGlsZCApOwoJfSwKCWNvbnRlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaWZyYW1lIiApID8KCQkJZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDoKCQkJalF1ZXJ5Lm1lcmdlKCBbXSwgZWxlbS5jaGlsZE5vZGVzICk7Cgl9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHVudGlsLCBzZWxlY3RvciApIHsKCQl2YXIgcmV0ID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgoJCWlmICggIXJ1bnRpbC50ZXN0KCBuYW1lICkgKSB7CgkJCXNlbGVjdG9yID0gdW50aWw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCXJldCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCByZXQgKTsKCQl9CgoJCXJldCA9IHRoaXMubGVuZ3RoID4gMSAmJiAhZ3VhcmFudGVlZFVuaXF1ZVsgbmFtZSBdID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQ7CgoJCWlmICggdGhpcy5sZW5ndGggPiAxICYmIHJwYXJlbnRzcHJldi50ZXN0KCBuYW1lICkgKSB7CgkJCXJldCA9IHJldC5yZXZlcnNlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCwgbmFtZSwgY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKS5qb2luKCIsIikgKTsKCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CglmaWx0ZXI6IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJCWlmICggbm90ICkgewoJCQlleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CgkJfQoKCQlyZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxID8KCQkJalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGVsZW1zWzBdLCBleHByKSA/IFsgZWxlbXNbMF0gXSA6IFtdIDoKCQkJalF1ZXJ5LmZpbmQubWF0Y2hlcyhleHByLCBlbGVtcyk7Cgl9LAoKCWRpcjogZnVuY3Rpb24oIGVsZW0sIGRpciwgdW50aWwgKSB7CgkJdmFyIG1hdGNoZWQgPSBbXSwKCQkJY3VyID0gZWxlbVsgZGlyIF07CgoJCXdoaWxlICggY3VyICYmIGN1ci5ub2RlVHlwZSAhPT0gOSAmJiAodW50aWwgPT09IHVuZGVmaW5lZCB8fCBjdXIubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeSggY3VyICkuaXMoIHVudGlsICkpICkgewoJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCW1hdGNoZWQucHVzaCggY3VyICk7CgkJCX0KCQkJY3VyID0gY3VyW2Rpcl07CgkJfQoJCXJldHVybiBtYXRjaGVkOwoJfSwKCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKCQl2YXIgciA9IFtdOwoKCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgewoJCQlpZiAoIG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSApIHsKCQkJCXIucHVzaCggbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcjsKCX0KfSk7CgovLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdApmdW5jdGlvbiB3aW5ub3coIGVsZW1lbnRzLCBxdWFsaWZpZXIsIGtlZXAgKSB7CgoJLy8gQ2FuJ3QgcGFzcyBudWxsIG9yIHVuZGVmaW5lZCB0byBpbmRleE9mIGluIEZpcmVmb3ggNAoJLy8gU2V0IHRvIDAgdG8gc2tpcCBzdHJpbmcgY2hlY2sKCXF1YWxpZmllciA9IHF1YWxpZmllciB8fCAwOwoKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXZhciByZXRWYWwgPSAhIXF1YWxpZmllci5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CgkJCXJldHVybiByZXRWYWwgPT09IGtlZXA7CgkJfSk7CgoJfSBlbHNlIGlmICggcXVhbGlmaWVyLm5vZGVUeXBlICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApID09PSBrZWVwOwoJCX0pOwoKCX0gZWxzZSBpZiAoIHR5cGVvZiBxdWFsaWZpZXIgPT09ICJzdHJpbmciICkgewoJCXZhciBmaWx0ZXJlZCA9IGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CgkJfSk7CgoJCWlmICggaXNTaW1wbGUudGVzdCggcXVhbGlmaWVyICkgKSB7CgkJCXJldHVybiBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZmlsdGVyZWQsICFrZWVwKTsKCQl9IGVsc2UgewoJCQlxdWFsaWZpZXIgPSBqUXVlcnkuZmlsdGVyKCBxdWFsaWZpZXIsIGZpbHRlcmVkICk7CgkJfQoJfQoKCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJcmV0dXJuICggalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHF1YWxpZmllciApID49IDAgKSA9PT0ga2VlcDsKCX0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVNhZmVGcmFnbWVudCggZG9jdW1lbnQgKSB7Cgl2YXIgbGlzdCA9IG5vZGVOYW1lcy5zcGxpdCggInwiICksCglzYWZlRnJhZyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCglpZiAoIHNhZmVGcmFnLmNyZWF0ZUVsZW1lbnQgKSB7CgkJd2hpbGUgKCBsaXN0Lmxlbmd0aCApIHsKCQkJc2FmZUZyYWcuY3JlYXRlRWxlbWVudCgKCQkJCWxpc3QucG9wKCkKCQkJKTsKCQl9Cgl9CglyZXR1cm4gc2FmZUZyYWc7Cn0KCnZhciBub2RlTmFtZXMgPSAiYWJicnxhcnRpY2xlfGFzaWRlfGF1ZGlvfGJkaXxjYW52YXN8ZGF0YXxkYXRhbGlzdHxkZXRhaWxzfGZpZ2NhcHRpb258ZmlndXJlfGZvb3RlcnwiICsKCQkiaGVhZGVyfGhncm91cHxtYXJrfG1ldGVyfG5hdnxvdXRwdXR8cHJvZ3Jlc3N8c2VjdGlvbnxzdW1tYXJ5fHRpbWV8dmlkZW8iLAoJcmlubGluZWpRdWVyeSA9IC8galF1ZXJ5XGQrPSIoPzpudWxsfFxkKykiL2csCglybGVhZGluZ1doaXRlc3BhY2UgPSAvXlxzKy8sCglyeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpLAoJcnRhZ05hbWUgPSAvPChbXHc6XSspLywKCXJ0Ym9keSA9IC88dGJvZHkvaSwKCXJodG1sID0gLzx8JiM/XHcrOy8sCglybm9Jbm5lcmh0bWwgPSAvPCg/OnNjcmlwdHxzdHlsZXxsaW5rKS9pLAoJcm5vY2FjaGUgPSAvPCg/OnNjcmlwdHxvYmplY3R8ZW1iZWR8b3B0aW9ufHN0eWxlKS9pLAoJcm5vc2hpbWNhY2hlID0gbmV3IFJlZ0V4cCgiPCg/OiIgKyBub2RlTmFtZXMgKyAiKVtcXHMvPl0iLCAiaSIpLAoJcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvLAoJLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZAoJcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwKCXJzY3JpcHRUeXBlID0gL1wvKGphdmF8ZWNtYSlzY3JpcHQvaSwKCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8XC1cLSl8W1xdXC1dezJ9PlxzKiQvZywKCXdyYXBNYXAgPSB7CgkJb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwKCQlsZWdlbmQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCgkJdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCgkJdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJdGQ6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLAoJCWFyZWE6IFsgMSwgIjxtYXA+IiwgIjwvbWFwPiIgXSwKCQlfZGVmYXVsdDogWyAwLCAiIiwgIiIgXQoJfSwKCXNhZmVGcmFnbWVudCA9IGNyZWF0ZVNhZmVGcmFnbWVudCggZG9jdW1lbnQgKSwKCWZyYWdtZW50RGl2ID0gc2FmZUZyYWdtZW50LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApOwoKd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uOwp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwp3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCi8vIElFNi04IGNhbid0IHNlcmlhbGl6ZSBsaW5rLCBzY3JpcHQsIHN0eWxlLCBvciBhbnkgaHRtbDUgKE5vU2NvcGUpIHRhZ3MsCi8vIHVubGVzcyB3cmFwcGVkIGluIGEgZGl2IHdpdGggbm9uLWJyZWFraW5nIGNoYXJhY3RlcnMgaW4gZnJvbnQgb2YgaXQuCmlmICggIWpRdWVyeS5zdXBwb3J0Lmh0bWxTZXJpYWxpemUgKSB7Cgl3cmFwTWFwLl9kZWZhdWx0ID0gWyAxLCAiWDxkaXY+IiwgIjwvZGl2PiIgXTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgl0ZXh0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnRleHQoIHRoaXMgKSA6CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCAoIHRoaXNbMF0gJiYgdGhpc1swXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkuY3JlYXRlVGV4dE5vZGUoIHZhbHVlICkgKTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCApOwoJfSwKCgl3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJalF1ZXJ5KHRoaXMpLndyYXBBbGwoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCWlmICggdGhpc1swXSApIHsKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJdmFyIHdyYXAgPSBqUXVlcnkoIGh0bWwsIHRoaXNbMF0ub3duZXJEb2N1bWVudCApLmVxKDApLmNsb25lKHRydWUpOwoKCQkJaWYgKCB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCQl3cmFwLmluc2VydEJlZm9yZSggdGhpc1swXSApOwoJCQl9CgoJCQl3cmFwLm1hcChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gdGhpczsKCgkJCQl3aGlsZSAoIGVsZW0uZmlyc3RDaGlsZCAmJiBlbGVtLmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbTsKCQkJfSkuYXBwZW5kKCB0aGlzICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJalF1ZXJ5KHRoaXMpLndyYXBJbm5lciggaHRtbC5jYWxsKHRoaXMsIGkpICk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSBqUXVlcnkoIHRoaXMgKSwKCQkJCWNvbnRlbnRzID0gc2VsZi5jb250ZW50cygpOwoKCQkJaWYgKCBjb250ZW50cy5sZW5ndGggKSB7CgkJCQljb250ZW50cy53cmFwQWxsKCBodG1sICk7CgoJCQl9IGVsc2UgewoJCQkJc2VsZi5hcHBlbmQoIGh0bWwgKTsKCQkJfQoJCX0pOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQl2YXIgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICk7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBpc0Z1bmN0aW9uID8gaHRtbC5jYWxsKHRoaXMsIGkpIDogaHRtbCApOwoJCX0pOwoJfSwKCgl1bndyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIWpRdWVyeS5ub2RlTmFtZSggdGhpcywgImJvZHkiICkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5yZXBsYWNlV2l0aCggdGhpcy5jaGlsZE5vZGVzICk7CgkJCX0KCQl9KS5lbmQoKTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgKSB7CgkJCQl0aGlzLmFwcGVuZENoaWxkKCBlbGVtICk7CgkJCX0KCQl9KTsKCX0sCgoJcHJlcGVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExICkgewoJCQkJdGhpcy5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMuZmlyc3RDaGlsZCApOwoJCQl9CgkJfSk7Cgl9LAoKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhaXNEaXNjb25uZWN0ZWQoIHRoaXNbMF0gKSApIHsKCQkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmYWxzZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl2YXIgc2V0ID0galF1ZXJ5LmNsZWFuKCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubWVyZ2UoIHNldCwgdGhpcyApLCAiYmVmb3JlIiwgdGhpcy5zZWxlY3RvciApOwoJCX0KCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKCkgewoJCWlmICggIWlzRGlzY29ubmVjdGVkKCB0aGlzWzBdICkgKSB7CgkJCXJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZmFsc2UsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwoJCQl9KTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdmFyIHNldCA9IGpRdWVyeS5jbGVhbiggYXJndW1lbnRzICk7CgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1lcmdlKCB0aGlzLCBzZXQgKSwgImFmdGVyIiwgdGhpcy5zZWxlY3RvciApOwoJCX0KCX0sCgoJLy8ga2VlcERhdGEgaXMgZm9yIGludGVybmFsIHVzZSBvbmx5LS1kbyBub3QgZG9jdW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKCQl2YXIgZWxlbSwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggIXNlbGVjdG9yIHx8IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBbIGVsZW0gXSApLmxlbmd0aCApIHsKCQkJCWlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggWyBlbGVtIF0gKTsKCQkJCX0KCgkJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQllbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsZW0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCS8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgKTsKCQkJfQoKCQkJLy8gUmVtb3ZlIGFueSByZW1haW5pbmcgbm9kZXMKCQkJd2hpbGUgKCBlbGVtLmZpcnN0Q2hpbGQgKSB7CgkJCQllbGVtLnJlbW92ZUNoaWxkKCBlbGVtLmZpcnN0Q2hpbGQgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbiggZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJZGF0YUFuZEV2ZW50cyA9IGRhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGZhbHNlIDogZGF0YUFuZEV2ZW50czsKCQlkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CgoJCXJldHVybiB0aGlzLm1hcCggZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4galF1ZXJ5LmNsb25lKCB0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApOwoJCX0pOwoJfSwKCglodG1sOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LAoJCQkJaSA9IDAsCgkJCQlsID0gdGhpcy5sZW5ndGg7CgoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSA/CgkJCQkJZWxlbS5pbm5lckhUTUwucmVwbGFjZSggcmlubGluZWpRdWVyeSwgIiIgKSA6CgkJCQkJdW5kZWZpbmVkOwoJCQl9CgoJCQkvLyBTZWUgaWYgd2UgY2FuIHRha2UgYSBzaG9ydGN1dCBhbmQganVzdCB1c2UgaW5uZXJIVE1MCgkJCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAhcm5vSW5uZXJodG1sLnRlc3QoIHZhbHVlICkgJiYKCQkJCSggalF1ZXJ5LnN1cHBvcnQuaHRtbFNlcmlhbGl6ZSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoIHZhbHVlICkgICkgJiYKCQkJCSggalF1ZXJ5LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgfHwgIXJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCB2YWx1ZSApICkgJiYKCQkJCSF3cmFwTWFwWyAoIHJ0YWdOYW1lLmV4ZWMoIHZhbHVlICkgfHwgWyIiLCAiIl0gKVsxXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICk7CgoJCQkJdHJ5IHsKCQkJCQlmb3IgKDsgaSA8IGw7IGkrKyApIHsKCQkJCQkJLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCQkJCWVsZW0gPSB0aGlzW2ldIHx8IHt9OwoJCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQlqUXVlcnkuY2xlYW5EYXRhKCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiKiIgKSApOwoJCQkJCQkJZWxlbS5pbm5lckhUTUwgPSB2YWx1ZTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJZWxlbSA9IDA7CgoJCQkJLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0KCgkJCWlmICggZWxlbSApIHsKCQkJCXRoaXMuZW1wdHkoKS5hcHBlbmQoIHZhbHVlICk7CgkJCX0KCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCApOwoJfSwKCglyZXBsYWNlV2l0aDogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggIWlzRGlzY29ubmVjdGVkKCB0aGlzWzBdICkgKSB7CgkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBlbGVtZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00gYmVmb3JlIHRoZXkgYXJlIGluc2VydGVkCgkJCS8vIHRoaXMgY2FuIGhlbHAgZml4IHJlcGxhY2luZyBhIHBhcmVudCB3aXRoIGNoaWxkIGVsZW1lbnRzCgkJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCQl2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwgb2xkID0gc2VsZi5odG1sKCk7CgkJCQkJc2VsZi5yZXBsYWNlV2l0aCggdmFsdWUuY2FsbCggdGhpcywgaSwgb2xkICkgKTsKCQkJCX0pOwoJCQl9CgoJCQlpZiAoIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIgKSB7CgkJCQl2YWx1ZSA9IGpRdWVyeSggdmFsdWUgKS5kZXRhY2goKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBuZXh0ID0gdGhpcy5uZXh0U2libGluZywKCQkJCQlwYXJlbnQgPSB0aGlzLnBhcmVudE5vZGU7CgoJCQkJalF1ZXJ5KCB0aGlzICkucmVtb3ZlKCk7CgoJCQkJaWYgKCBuZXh0ICkgewoJCQkJCWpRdWVyeShuZXh0KS5iZWZvcmUoIHZhbHVlICk7CgkJCQl9IGVsc2UgewoJCQkJCWpRdWVyeShwYXJlbnQpLmFwcGVuZCggdmFsdWUgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5sZW5ndGggPwoJCQl0aGlzLnB1c2hTdGFjayggalF1ZXJ5KGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZSksICJyZXBsYWNlV2l0aCIsIHZhbHVlICkgOgoJCQl0aGlzOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmUoIHNlbGVjdG9yLCB0cnVlICk7Cgl9LAoKCWRvbU1hbmlwOiBmdW5jdGlvbiggYXJncywgdGFibGUsIGNhbGxiYWNrICkgewoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJYXJncyA9IFtdLmNvbmNhdC5hcHBseSggW10sIGFyZ3MgKTsKCgkJdmFyIHJlc3VsdHMsIGZpcnN0LCBmcmFnbWVudCwgaU5vQ2xvbmUsCgkJCWkgPSAwLAoJCQl2YWx1ZSA9IGFyZ3NbMF0sCgkJCXNjcmlwdHMgPSBbXSwKCQkJbCA9IHRoaXMubGVuZ3RoOwoKCQkvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lICYmIGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgcmNoZWNrZWQudGVzdCggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeSh0aGlzKS5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlhcmdzWzBdID0gdmFsdWUuY2FsbCggdGhpcywgaSwgdGFibGUgPyBzZWxmLmh0bWwoKSA6IHVuZGVmaW5lZCApOwoJCQkJc2VsZi5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrICk7CgkJCX0pOwoJCX0KCgkJaWYgKCB0aGlzWzBdICkgewoJCQlyZXN1bHRzID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoIGFyZ3MsIHRoaXMsIHNjcmlwdHMgKTsKCQkJZnJhZ21lbnQgPSByZXN1bHRzLmZyYWdtZW50OwoJCQlmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CgoJCQlpZiAoIGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxICkgewoJCQkJZnJhZ21lbnQgPSBmaXJzdDsKCQkJfQoKCQkJaWYgKCBmaXJzdCApIHsKCQkJCXRhYmxlID0gdGFibGUgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBmaXJzdCwgInRyIiApOwoKCQkJCS8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwCgkJCQkvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgoJCQkJLy8gRnJhZ21lbnRzIGZyb20gdGhlIGZyYWdtZW50IGNhY2hlIG11c3QgYWx3YXlzIGJlIGNsb25lZCBhbmQgbmV2ZXIgdXNlZCBpbiBwbGFjZS4KCQkJCWZvciAoIGlOb0Nsb25lID0gcmVzdWx0cy5jYWNoZWFibGUgfHwgbCAtIDE7IGkgPCBsOyBpKysgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCgKCQkJCQkJdGFibGUgJiYgalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzW2ldLCAidGFibGUiICkgPwoJCQkJCQkJZmluZE9yQXBwZW5kKCB0aGlzW2ldLCAidGJvZHkiICkgOgoJCQkJCQkJdGhpc1tpXSwKCQkJCQkJaSA9PT0gaU5vQ2xvbmUgPwoJCQkJCQkJZnJhZ21lbnQgOgoJCQkJCQkJalF1ZXJ5LmNsb25lKCBmcmFnbWVudCwgdHJ1ZSwgdHJ1ZSApCgkJCQkJKTsKCQkJCX0KCQkJfQoKCQkJLy8gRml4ICMxMTgwOTogQXZvaWQgbGVha2luZyBtZW1vcnkKCQkJZnJhZ21lbnQgPSBmaXJzdCA9IG51bGw7CgoJCQlpZiAoIHNjcmlwdHMubGVuZ3RoICkgewoJCQkJalF1ZXJ5LmVhY2goIHNjcmlwdHMsIGZ1bmN0aW9uKCBpLCBlbGVtICkgewoJCQkJCWlmICggZWxlbS5zcmMgKSB7CgkJCQkJCWlmICggalF1ZXJ5LmFqYXggKSB7CgkJCQkJCQlqUXVlcnkuYWpheCh7CgkJCQkJCQkJdXJsOiBlbGVtLnNyYywKCQkJCQkJCQl0eXBlOiAiR0VUIiwKCQkJCQkJCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJCQkJCQkJYXN5bmM6IGZhbHNlLAoJCQkJCQkJCWdsb2JhbDogZmFsc2UsCgkJCQkJCQkJInRocm93cyI6IHRydWUKCQkJCQkJCX0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJalF1ZXJ5LmVycm9yKCJubyBhamF4Iik7CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQlqUXVlcnkuZ2xvYmFsRXZhbCggKCBlbGVtLnRleHQgfHwgZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVySFRNTCB8fCAiIiApLnJlcGxhY2UoIHJjbGVhblNjcmlwdCwgIiIgKSApOwoJCQkJCX0KCgkJCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQkJCWVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWxlbSApOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpmdW5jdGlvbiBmaW5kT3JBcHBlbmQoIGVsZW0sIHRhZyApIHsKCXJldHVybiBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKVswXSB8fCBlbGVtLmFwcGVuZENoaWxkKCBlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCggdGFnICkgKTsKfQoKZnVuY3Rpb24gY2xvbmVDb3B5RXZlbnQoIHNyYywgZGVzdCApIHsKCglpZiAoIGRlc3Qubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeS5oYXNEYXRhKCBzcmMgKSApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHR5cGUsIGksIGwsCgkJb2xkRGF0YSA9IGpRdWVyeS5fZGF0YSggc3JjICksCgkJY3VyRGF0YSA9IGpRdWVyeS5fZGF0YSggZGVzdCwgb2xkRGF0YSApLAoJCWV2ZW50cyA9IG9sZERhdGEuZXZlbnRzOwoKCWlmICggZXZlbnRzICkgewoJCWRlbGV0ZSBjdXJEYXRhLmhhbmRsZTsKCQljdXJEYXRhLmV2ZW50cyA9IHt9OwoKCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJZm9yICggaSA9IDAsIGwgPSBldmVudHNbIHR5cGUgXS5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQlqUXVlcnkuZXZlbnQuYWRkKCBkZXN0LCB0eXBlLCBldmVudHNbIHR5cGUgXVsgaSBdICk7CgkJCX0KCQl9Cgl9CgoJLy8gbWFrZSB0aGUgY2xvbmVkIHB1YmxpYyBkYXRhIG9iamVjdCBhIGNvcHkgZnJvbSB0aGUgb3JpZ2luYWwKCWlmICggY3VyRGF0YS5kYXRhICkgewoJCWN1ckRhdGEuZGF0YSA9IGpRdWVyeS5leHRlbmQoIHt9LCBjdXJEYXRhLmRhdGEgKTsKCX0KfQoKZnVuY3Rpb24gY2xvbmVGaXhBdHRyaWJ1dGVzKCBzcmMsIGRlc3QgKSB7Cgl2YXIgbm9kZU5hbWU7CgoJLy8gV2UgZG8gbm90IG5lZWQgdG8gZG8gYW55dGhpbmcgZm9yIG5vbi1FbGVtZW50cwoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgewoJCXJldHVybjsKCX0KCgkvLyBjbGVhckF0dHJpYnV0ZXMgcmVtb3ZlcyB0aGUgYXR0cmlidXRlcywgd2hpY2ggd2UgZG9uJ3Qgd2FudCwKCS8vIGJ1dCBhbHNvIHJlbW92ZXMgdGhlIGF0dGFjaEV2ZW50IGV2ZW50cywgd2hpY2ggd2UgKmRvKiB3YW50CglpZiAoIGRlc3QuY2xlYXJBdHRyaWJ1dGVzICkgewoJCWRlc3QuY2xlYXJBdHRyaWJ1dGVzKCk7Cgl9CgoJLy8gbWVyZ2VBdHRyaWJ1dGVzLCBpbiBjb250cmFzdCwgb25seSBtZXJnZXMgYmFjayBvbiB0aGUKCS8vIG9yaWdpbmFsIGF0dHJpYnV0ZXMsIG5vdCB0aGUgZXZlbnRzCglpZiAoIGRlc3QubWVyZ2VBdHRyaWJ1dGVzICkgewoJCWRlc3QubWVyZ2VBdHRyaWJ1dGVzKCBzcmMgKTsKCX0KCglub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCglpZiAoIG5vZGVOYW1lID09PSAib2JqZWN0IiApIHsKCQkvLyBJRTYtMTAgaW1wcm9wZXJseSBjbG9uZXMgY2hpbGRyZW4gb2Ygb2JqZWN0IGVsZW1lbnRzIHVzaW5nIGNsYXNzaWQuCgkJLy8gSUUxMCB0aHJvd3MgTm9Nb2RpZmljYXRpb25BbGxvd2VkRXJyb3IgaWYgcGFyZW50IGlzIG51bGwsICMxMjEzMi4KCQlpZiAoIGRlc3QucGFyZW50Tm9kZSApIHsKCQkJZGVzdC5vdXRlckhUTUwgPSBzcmMub3V0ZXJIVE1MOwoJCX0KCgkJLy8gVGhpcyBwYXRoIGFwcGVhcnMgdW5hdm9pZGFibGUgZm9yIElFOS4gV2hlbiBjbG9uaW5nIGFuIG9iamVjdAoJCS8vIGVsZW1lbnQgaW4gSUU5LCB0aGUgb3V0ZXJIVE1MIHN0cmF0ZWd5IGFib3ZlIGlzIG5vdCBzdWZmaWNpZW50LgoJCS8vIElmIHRoZSBzcmMgaGFzIGlubmVySFRNTCBhbmQgdGhlIGRlc3RpbmF0aW9uIGRvZXMgbm90LAoJCS8vIGNvcHkgdGhlIHNyYy5pbm5lckhUTUwgaW50byB0aGUgZGVzdC5pbm5lckhUTUwuICMxMDMyNAoJCWlmICggalF1ZXJ5LnN1cHBvcnQuaHRtbDVDbG9uZSAmJiAoc3JjLmlubmVySFRNTCAmJiAhalF1ZXJ5LnRyaW0oZGVzdC5pbm5lckhUTUwpKSApIHsKCQkJZGVzdC5pbm5lckhUTUwgPSBzcmMuaW5uZXJIVE1MOwoJCX0KCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiByY2hlY2thYmxlVHlwZS50ZXN0KCBzcmMudHlwZSApICkgewoJCS8vIElFNi04IGZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3gKCQkvLyBvciByYWRpbyBidXR0b24uIFdvcnNlLCBJRTYtNyBmYWlsIHRvIGdpdmUgdGhlIGNsb25lZCBlbGVtZW50CgkJLy8gYSBjaGVja2VkIGFwcGVhcmFuY2UgaWYgdGhlIGRlZmF1bHRDaGVja2VkIHZhbHVlIGlzbid0IGFsc28gc2V0CgoJCWRlc3QuZGVmYXVsdENoZWNrZWQgPSBkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsKCgkJLy8gSUU2LTcgZ2V0IGNvbmZ1c2VkIGFuZCBlbmQgdXAgc2V0dGluZyB0aGUgdmFsdWUgb2YgYSBjbG9uZWQKCQkvLyBjaGVja2JveC9yYWRpbyBidXR0b24gdG8gYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgIm9uIgoJCWlmICggZGVzdC52YWx1ZSAhPT0gc3JjLnZhbHVlICkgewoJCQlkZXN0LnZhbHVlID0gc3JjLnZhbHVlOwoJCX0KCgkvLyBJRTYtOCBmYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZAoJLy8gc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib3B0aW9uIiApIHsKCQlkZXN0LnNlbGVjdGVkID0gc3JjLmRlZmF1bHRTZWxlY3RlZDsKCgkvLyBJRTYtOCBmYWlscyB0byBzZXQgdGhlIGRlZmF1bHRWYWx1ZSB0byB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuCgkvLyBjbG9uaW5nIG90aGVyIHR5cGVzIG9mIGlucHV0IGZpZWxkcwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgKSB7CgkJZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwoKCS8vIElFIGJsYW5rcyBjb250ZW50cyB3aGVuIGNsb25pbmcgc2NyaXB0cwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJzY3JpcHQiICYmIGRlc3QudGV4dCAhPT0gc3JjLnRleHQgKSB7CgkJZGVzdC50ZXh0ID0gc3JjLnRleHQ7Cgl9CgoJLy8gRXZlbnQgZGF0YSBnZXRzIHJlZmVyZW5jZWQgaW5zdGVhZCBvZiBjb3BpZWQgaWYgdGhlIGV4cGFuZG8KCS8vIGdldHMgY29waWVkIHRvbwoJZGVzdC5yZW1vdmVBdHRyaWJ1dGUoIGpRdWVyeS5leHBhbmRvICk7Cn0KCmpRdWVyeS5idWlsZEZyYWdtZW50ID0gZnVuY3Rpb24oIGFyZ3MsIGNvbnRleHQsIHNjcmlwdHMgKSB7Cgl2YXIgZnJhZ21lbnQsIGNhY2hlYWJsZSwgY2FjaGVoaXQsCgkJZmlyc3QgPSBhcmdzWyAwIF07CgoJLy8gU2V0IGNvbnRleHQgZnJvbSB3aGF0IG1heSBjb21lIGluIGFzIHVuZGVmaW5lZCBvciBhIGpRdWVyeSBjb2xsZWN0aW9uIG9yIGEgbm9kZQoJLy8gVXBkYXRlZCB0byBmaXggIzEyMjY2IHdoZXJlIGFjY2Vzc2luZyBjb250ZXh0WzBdIGNvdWxkIHRocm93IGFuIGV4Y2VwdGlvbiBpbiBJRTkvMTAgJgoJLy8gYWxzbyBkb3VibGVzIGFzIGZpeCBmb3IgIzg5NTAgd2hlcmUgcGxhaW4gb2JqZWN0cyBjYXVzZWQgY3JlYXRlRG9jdW1lbnRGcmFnbWVudCBleGNlcHRpb24KCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoJY29udGV4dCA9ICFjb250ZXh0Lm5vZGVUeXBlICYmIGNvbnRleHRbMF0gfHwgY29udGV4dDsKCWNvbnRleHQgPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dDsKCgkvLyBPbmx5IGNhY2hlICJzbWFsbCIgKDEvMiBLQikgSFRNTCBzdHJpbmdzIHRoYXQgYXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWFpbiBkb2N1bWVudAoJLy8gQ2xvbmluZyBvcHRpb25zIGxvc2VzIHRoZSBzZWxlY3RlZCBzdGF0ZSwgc28gZG9uJ3QgY2FjaGUgdGhlbQoJLy8gSUUgNiBkb2Vzbid0IGxpa2UgaXQgd2hlbiB5b3UgcHV0IDxvYmplY3Q+IG9yIDxlbWJlZD4gZWxlbWVudHMgaW4gYSBmcmFnbWVudAoJLy8gQWxzbywgV2ViS2l0IGRvZXMgbm90IGNsb25lICdjaGVja2VkJyBhdHRyaWJ1dGVzIG9uIGNsb25lTm9kZSwgc28gZG9uJ3QgY2FjaGUKCS8vIExhc3RseSwgSUU2LDcsOCB3aWxsIG5vdCBjb3JyZWN0bHkgcmV1c2UgY2FjaGVkIGZyYWdtZW50cyB0aGF0IHdlcmUgY3JlYXRlZCBmcm9tIHVua25vd24gZWxlbXMgIzEwNTAxCglpZiAoIGFyZ3MubGVuZ3RoID09PSAxICYmIHR5cGVvZiBmaXJzdCA9PT0gInN0cmluZyIgJiYgZmlyc3QubGVuZ3RoIDwgNTEyICYmIGNvbnRleHQgPT09IGRvY3VtZW50ICYmCgkJZmlyc3QuY2hhckF0KDApID09PSAiPCIgJiYgIXJub2NhY2hlLnRlc3QoIGZpcnN0ICkgJiYKCQkoalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSB8fCAhcmNoZWNrZWQudGVzdCggZmlyc3QgKSkgJiYKCQkoalF1ZXJ5LnN1cHBvcnQuaHRtbDVDbG9uZSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoIGZpcnN0ICkpICkgewoKCQkvLyBNYXJrIGNhY2hlYWJsZSBhbmQgbG9vayBmb3IgYSBoaXQKCQljYWNoZWFibGUgPSB0cnVlOwoJCWZyYWdtZW50ID0galF1ZXJ5LmZyYWdtZW50c1sgZmlyc3QgXTsKCQljYWNoZWhpdCA9IGZyYWdtZW50ICE9PSB1bmRlZmluZWQ7Cgl9CgoJaWYgKCAhZnJhZ21lbnQgKSB7CgkJZnJhZ21lbnQgPSBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCQlqUXVlcnkuY2xlYW4oIGFyZ3MsIGNvbnRleHQsIGZyYWdtZW50LCBzY3JpcHRzICk7CgoJCS8vIFVwZGF0ZSB0aGUgY2FjaGUsIGJ1dCBvbmx5IHN0b3JlIGZhbHNlCgkJLy8gdW5sZXNzIHRoaXMgaXMgYSBzZWNvbmQgcGFyc2luZyBvZiB0aGUgc2FtZSBjb250ZW50CgkJaWYgKCBjYWNoZWFibGUgKSB7CgkJCWpRdWVyeS5mcmFnbWVudHNbIGZpcnN0IF0gPSBjYWNoZWhpdCAmJiBmcmFnbWVudDsKCQl9Cgl9CgoJcmV0dXJuIHsgZnJhZ21lbnQ6IGZyYWdtZW50LCBjYWNoZWFibGU6IGNhY2hlYWJsZSB9Owp9OwoKalF1ZXJ5LmZyYWdtZW50cyA9IHt9OwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKCBuYW1lLCBvcmlnaW5hbCApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBlbGVtcywKCQkJaSA9IDAsCgkJCXJldCA9IFtdLAoJCQlpbnNlcnQgPSBqUXVlcnkoIHNlbGVjdG9yICksCgkJCWwgPSBpbnNlcnQubGVuZ3RoLAoJCQlwYXJlbnQgPSB0aGlzLmxlbmd0aCA9PT0gMSAmJiB0aGlzWzBdLnBhcmVudE5vZGU7CgoJCWlmICggKHBhcmVudCA9PSBudWxsIHx8IHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgPT09IDExICYmIHBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgJiYgbCA9PT0gMSApIHsKCQkJaW5zZXJ0WyBvcmlnaW5hbCBdKCB0aGlzWzBdICk7CgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCWVsZW1zID0gKCBpID4gMCA/IHRoaXMuY2xvbmUodHJ1ZSkgOiB0aGlzICkuZ2V0KCk7CgkJCQlqUXVlcnkoIGluc2VydFtpXSApWyBvcmlnaW5hbCBdKCBlbGVtcyApOwoJCQkJcmV0ID0gcmV0LmNvbmNhdCggZWxlbXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQsIG5hbWUsIGluc2VydC5zZWxlY3RvciApOwoJCX0KCX07Cn0pOwoKZnVuY3Rpb24gZ2V0QWxsKCBlbGVtICkgewoJaWYgKCB0eXBlb2YgZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJcmV0dXJuIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoICIqIiApOwoKCX0gZWxzZSBpZiAoIHR5cGVvZiBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwgIT09ICJ1bmRlZmluZWQiICkgewoJCXJldHVybiBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoICIqIiApOwoKCX0gZWxzZSB7CgkJcmV0dXJuIFtdOwoJfQp9CgovLyBVc2VkIGluIGNsZWFuLCBmaXhlcyB0aGUgZGVmYXVsdENoZWNrZWQgcHJvcGVydHkKZnVuY3Rpb24gZml4RGVmYXVsdENoZWNrZWQoIGVsZW0gKSB7CglpZiAoIHJjaGVja2FibGVUeXBlLnRlc3QoIGVsZW0udHlwZSApICkgewoJCWVsZW0uZGVmYXVsdENoZWNrZWQgPSBlbGVtLmNoZWNrZWQ7Cgl9Cn0KCmpRdWVyeS5leHRlbmQoewoJY2xvbmU6IGZ1bmN0aW9uKCBlbGVtLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQl2YXIgc3JjRWxlbWVudHMsCgkJCWRlc3RFbGVtZW50cywKCQkJaSwKCQkJY2xvbmU7CgoJCWlmICggalF1ZXJ5LnN1cHBvcnQuaHRtbDVDbG9uZSB8fCBqUXVlcnkuaXNYTUxEb2MoZWxlbSkgfHwgIXJub3NoaW1jYWNoZS50ZXN0KCAiPCIgKyBlbGVtLm5vZGVOYW1lICsgIj4iICkgKSB7CgkJCWNsb25lID0gZWxlbS5jbG9uZU5vZGUoIHRydWUgKTsKCgkJLy8gSUU8PTggZG9lcyBub3QgcHJvcGVybHkgY2xvbmUgZGV0YWNoZWQsIHVua25vd24gZWxlbWVudCBub2RlcwoJCX0gZWxzZSB7CgkJCWZyYWdtZW50RGl2LmlubmVySFRNTCA9IGVsZW0ub3V0ZXJIVE1MOwoJCQlmcmFnbWVudERpdi5yZW1vdmVDaGlsZCggY2xvbmUgPSBmcmFnbWVudERpdi5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICghalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50IHx8ICFqUXVlcnkuc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCkgJiYKCQkJCShlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExKSAmJiAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pICkgewoJCQkvLyBJRSBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuIHVzaW5nIGNsb25lTm9kZS4KCQkJLy8gQ2FsbGluZyBkZXRhY2hFdmVudCBvbiB0aGUgY2xvbmUgd2lsbCBhbHNvIHJlbW92ZSB0aGUgZXZlbnRzCgkJCS8vIGZyb20gdGhlIG9yaWdpbmFsLiBJbiBvcmRlciB0byBnZXQgYXJvdW5kIHRoaXMsIHdlIHVzZSBzb21lCgkJCS8vIHByb3ByaWV0YXJ5IG1ldGhvZHMgdG8gY2xlYXIgdGhlIGV2ZW50cy4gVGhhbmtzIHRvIE1vb1Rvb2xzCgkJCS8vIGd1eXMgZm9yIHRoaXMgaG90bmVzcy4KCgkJCWNsb25lRml4QXR0cmlidXRlcyggZWxlbSwgY2xvbmUgKTsKCgkJCS8vIFVzaW5nIFNpenpsZSBoZXJlIGlzIGNyYXp5IHNsb3csIHNvIHdlIHVzZSBnZXRFbGVtZW50c0J5VGFnTmFtZSBpbnN0ZWFkCgkJCXNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7CgkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsKCgkJCS8vIFdlaXJkIGl0ZXJhdGlvbiBiZWNhdXNlIElFIHdpbGwgcmVwbGFjZSB0aGUgbGVuZ3RoIHByb3BlcnR5CgkJCS8vIHdpdGggYW4gZWxlbWVudCBpZiB5b3UgYXJlIGNsb25pbmcgdGhlIGJvZHkgYW5kIG9uZSBvZiB0aGUKCQkJLy8gZWxlbWVudHMgb24gdGhlIHBhZ2UgaGFzIGEgbmFtZSBvciBpZCBvZiAibGVuZ3RoIgoJCQlmb3IgKCBpID0gMDsgc3JjRWxlbWVudHNbaV07ICsraSApIHsKCQkJCS8vIEVuc3VyZSB0aGF0IHRoZSBkZXN0aW5hdGlvbiBub2RlIGlzIG5vdCBudWxsOyBGaXhlcyAjOTU4NwoJCQkJaWYgKCBkZXN0RWxlbWVudHNbaV0gKSB7CgkJCQkJY2xvbmVGaXhBdHRyaWJ1dGVzKCBzcmNFbGVtZW50c1tpXSwgZGVzdEVsZW1lbnRzW2ldICk7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKCQlpZiAoIGRhdGFBbmRFdmVudHMgKSB7CgkJCWNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOwoKCQkJaWYgKCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQkJCXNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7CgkJCQlkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lICk7CgoJCQkJZm9yICggaSA9IDA7IHNyY0VsZW1lbnRzW2ldOyArK2kgKSB7CgkJCQkJY2xvbmVDb3B5RXZlbnQoIHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJc3JjRWxlbWVudHMgPSBkZXN0RWxlbWVudHMgPSBudWxsOwoKCQkvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbiggZWxlbXMsIGNvbnRleHQsIGZyYWdtZW50LCBzY3JpcHRzICkgewoJCXZhciBpLCBqLCBlbGVtLCB0YWcsIHdyYXAsIGRlcHRoLCBkaXYsIGhhc0JvZHksIHRib2R5LCBsZW4sIGhhbmRsZVNjcmlwdCwganNUYWdzLAoJCQlzYWZlID0gY29udGV4dCA9PT0gZG9jdW1lbnQgJiYgc2FmZUZyYWdtZW50LAoJCQlyZXQgPSBbXTsKCgkJLy8gRW5zdXJlIHRoYXQgY29udGV4dCBpcyBhIGRvY3VtZW50CgkJaWYgKCAhY29udGV4dCB8fCB0eXBlb2YgY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50ID09PSAidW5kZWZpbmVkIiApIHsKCQkJY29udGV4dCA9IGRvY3VtZW50OwoJCX0KCgkJLy8gVXNlIHRoZSBhbHJlYWR5LWNyZWF0ZWQgc2FmZSBmcmFnbWVudCBpZiBjb250ZXh0IHBlcm1pdHMKCQlmb3IgKCBpID0gMDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAibnVtYmVyIiApIHsKCQkJCWVsZW0gKz0gIiI7CgkJCX0KCgkJCWlmICggIWVsZW0gKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gQ29udmVydCBodG1sIHN0cmluZyBpbnRvIERPTSBub2RlcwoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJCWlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsKCQkJCQllbGVtID0gY29udGV4dC5jcmVhdGVUZXh0Tm9kZSggZWxlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBFbnN1cmUgYSBzYWZlIGNvbnRhaW5lciBpbiB3aGljaCB0byByZW5kZXIgdGhlIGh0bWwKCQkJCQlzYWZlID0gc2FmZSB8fCBjcmVhdGVTYWZlRnJhZ21lbnQoIGNvbnRleHQgKTsKCQkJCQlkaXYgPSBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCQkJCXNhZmUuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCQkJCQkvLyBGaXggIlhIVE1MIi1zdHlsZSB0YWdzIGluIGFsbCBicm93c2VycwoJCQkJCWVsZW0gPSBlbGVtLnJlcGxhY2UocnhodG1sVGFnLCAiPCQxPjwvJDI+Iik7CgoJCQkJCS8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKCQkJCQl0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoIGVsZW0gKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCk7CgkJCQkJd3JhcCA9IHdyYXBNYXBbIHRhZyBdIHx8IHdyYXBNYXAuX2RlZmF1bHQ7CgkJCQkJZGVwdGggPSB3cmFwWzBdOwoJCQkJCWRpdi5pbm5lckhUTUwgPSB3cmFwWzFdICsgZWxlbSArIHdyYXBbMl07CgoJCQkJCS8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCgkJCQkJd2hpbGUgKCBkZXB0aC0tICkgewoJCQkJCQlkaXYgPSBkaXYubGFzdENoaWxkOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIElFJ3MgYXV0b2luc2VydGVkIDx0Ym9keT4gZnJvbSB0YWJsZSBmcmFnbWVudHMKCQkJCQlpZiAoICFqUXVlcnkuc3VwcG9ydC50Ym9keSApIHsKCgkJCQkJCS8vIFN0cmluZyB3YXMgYSA8dGFibGU+LCAqbWF5KiBoYXZlIHNwdXJpb3VzIDx0Ym9keT4KCQkJCQkJaGFzQm9keSA9IHJ0Ym9keS50ZXN0KGVsZW0pOwoJCQkJCQkJdGJvZHkgPSB0YWcgPT09ICJ0YWJsZSIgJiYgIWhhc0JvZHkgPwoJCQkJCQkJCWRpdi5maXJzdENoaWxkICYmIGRpdi5maXJzdENoaWxkLmNoaWxkTm9kZXMgOgoKCQkJCQkJCQkvLyBTdHJpbmcgd2FzIGEgYmFyZSA8dGhlYWQ+IG9yIDx0Zm9vdD4KCQkJCQkJCQl3cmFwWzFdID09PSAiPHRhYmxlPiIgJiYgIWhhc0JvZHkgPwoJCQkJCQkJCQlkaXYuY2hpbGROb2RlcyA6CgkJCQkJCQkJCVtdOwoKCQkJCQkJZm9yICggaiA9IHRib2R5Lmxlbmd0aCAtIDE7IGogPj0gMCA7IC0taiApIHsKCQkJCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0Ym9keVsgaiBdLCAidGJvZHkiICkgJiYgIXRib2R5WyBqIF0uY2hpbGROb2Rlcy5sZW5ndGggKSB7CgkJCQkJCQkJdGJvZHlbIGogXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0Ym9keVsgaiBdICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIElFIGNvbXBsZXRlbHkga2lsbHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gaW5uZXJIVE1MIGlzIHVzZWQKCQkJCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSAmJiBybGVhZGluZ1doaXRlc3BhY2UudGVzdCggZWxlbSApICkgewoJCQkJCQlkaXYuaW5zZXJ0QmVmb3JlKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBybGVhZGluZ1doaXRlc3BhY2UuZXhlYyhlbGVtKVswXSApLCBkaXYuZmlyc3RDaGlsZCApOwoJCQkJCX0KCgkJCQkJZWxlbSA9IGRpdi5jaGlsZE5vZGVzOwoKCQkJCQkvLyBUYWtlIG91dCBvZiBmcmFnbWVudCBjb250YWluZXIgKHdlIG5lZWQgYSBmcmVzaCBkaXYgZWFjaCB0aW1lKQoJCQkJCWRpdi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBkaXYgKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBlbGVtLm5vZGVUeXBlICkgewoJCQkJcmV0LnB1c2goIGVsZW0gKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeS5tZXJnZSggcmV0LCBlbGVtICk7CgkJCX0KCQl9CgoJCS8vIEZpeCAjMTEzNTY6IENsZWFyIGVsZW1lbnRzIGZyb20gc2FmZUZyYWdtZW50CgkJaWYgKCBkaXYgKSB7CgkJCWVsZW0gPSBkaXYgPSBzYWZlID0gbnVsbDsKCQl9CgoJCS8vIFJlc2V0IGRlZmF1bHRDaGVja2VkIGZvciBhbnkgcmFkaW9zIGFuZCBjaGVja2JveGVzCgkJLy8gYWJvdXQgdG8gYmUgYXBwZW5kZWQgdG8gdGhlIERPTSBpbiBJRSA2LzcgKCM4MDYwKQoJCWlmICggIWpRdWVyeS5zdXBwb3J0LmFwcGVuZENoZWNrZWQgKSB7CgkJCWZvciAoIGkgPSAwOyAoZWxlbSA9IHJldFtpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpbnB1dCIgKSApIHsKCQkJCQlmaXhEZWZhdWx0Q2hlY2tlZCggZWxlbSApOwoJCQkJfSBlbHNlIGlmICggdHlwZW9mIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJCWpRdWVyeS5ncmVwKCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpLCBmaXhEZWZhdWx0Q2hlY2tlZCApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBBcHBlbmQgZWxlbWVudHMgdG8gYSBwcm92aWRlZCBkb2N1bWVudCBmcmFnbWVudAoJCWlmICggZnJhZ21lbnQgKSB7CgkJCS8vIFNwZWNpYWwgaGFuZGxpbmcgb2YgZWFjaCBzY3JpcHQgZWxlbWVudAoJCQloYW5kbGVTY3JpcHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQkJCS8vIENoZWNrIGlmIHdlIGNvbnNpZGVyIGl0IGV4ZWN1dGFibGUKCQkJCWlmICggIWVsZW0udHlwZSB8fCByc2NyaXB0VHlwZS50ZXN0KCBlbGVtLnR5cGUgKSApIHsKCQkJCQkvLyBEZXRhY2ggdGhlIHNjcmlwdCBhbmQgc3RvcmUgaXQgaW4gdGhlIHNjcmlwdHMgYXJyYXkgKGlmIHByb3ZpZGVkKSBvciB0aGUgZnJhZ21lbnQKCQkJCQkvLyBSZXR1cm4gdHJ1dGh5IHRvIGluZGljYXRlIHRoYXQgaXQgaGFzIGJlZW4gaGFuZGxlZAoJCQkJCXJldHVybiBzY3JpcHRzID8KCQkJCQkJc2NyaXB0cy5wdXNoKCBlbGVtLnBhcmVudE5vZGUgPyBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsZW0gKSA6IGVsZW0gKSA6CgkJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICk7CgkJCQl9CgkJCX07CgoJCQlmb3IgKCBpID0gMDsgKGVsZW0gPSByZXRbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCS8vIENoZWNrIGlmIHdlJ3JlIGRvbmUgYWZ0ZXIgaGFuZGxpbmcgYW4gZXhlY3V0YWJsZSBzY3JpcHQKCQkJCWlmICggISggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2NyaXB0IiApICYmIGhhbmRsZVNjcmlwdCggZWxlbSApICkgKSB7CgkJCQkJLy8gQXBwZW5kIHRvIGZyYWdtZW50IGFuZCBoYW5kbGUgZW1iZWRkZWQgc2NyaXB0cwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICk7CgkJCQkJaWYgKCB0eXBlb2YgZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCQkJCS8vIGhhbmRsZVNjcmlwdCBhbHRlcnMgdGhlIERPTSwgc28gdXNlIGpRdWVyeS5tZXJnZSB0byBlbnN1cmUgc25hcHNob3QgaXRlcmF0aW9uCgkJCQkJCWpzVGFncyA9IGpRdWVyeS5ncmVwKCBqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzY3JpcHQiKSApLCBoYW5kbGVTY3JpcHQgKTsKCgkJCQkJCS8vIFNwbGljZSB0aGUgc2NyaXB0cyBpbnRvIHJldCBhZnRlciB0aGVpciBmb3JtZXIgYW5jZXN0b3IgYW5kIGFkdmFuY2Ugb3VyIGluZGV4IGJleW9uZCB0aGVtCgkJCQkJCXJldC5zcGxpY2UuYXBwbHkoIHJldCwgW2kgKyAxLCAwXS5jb25jYXQoIGpzVGFncyApICk7CgkJCQkJCWkgKz0ganNUYWdzLmxlbmd0aDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWNsZWFuRGF0YTogZnVuY3Rpb24oIGVsZW1zLCAvKiBpbnRlcm5hbCAqLyBhY2NlcHREYXRhICkgewoJCXZhciBkYXRhLCBpZCwgZWxlbSwgdHlwZSwKCQkJaSA9IDAsCgkJCWludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCgkJCWNhY2hlID0galF1ZXJ5LmNhY2hlLAoJCQlkZWxldGVFeHBhbmRvID0galF1ZXJ5LnN1cHBvcnQuZGVsZXRlRXhwYW5kbywKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsOwoKCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCgkJCWlmICggYWNjZXB0RGF0YSB8fCBqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoKCQkJCWlkID0gZWxlbVsgaW50ZXJuYWxLZXkgXTsKCQkJCWRhdGEgPSBpZCAmJiBjYWNoZVsgaWQgXTsKCgkJCQlpZiAoIGRhdGEgKSB7CgkJCQkJaWYgKCBkYXRhLmV2ZW50cyApIHsKCQkJCQkJZm9yICggdHlwZSBpbiBkYXRhLmV2ZW50cyApIHsKCQkJCQkJCWlmICggc3BlY2lhbFsgdHlwZSBdICkgewoJCQkJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKTsKCgkJCQkJCQkvLyBUaGlzIGlzIGEgc2hvcnRjdXQgdG8gYXZvaWQgalF1ZXJ5LmV2ZW50LnJlbW92ZSdzIG92ZXJoZWFkCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGNhY2hlIG9ubHkgaWYgaXQgd2FzIG5vdCBhbHJlYWR5IHJlbW92ZWQgYnkgalF1ZXJ5LmV2ZW50LnJlbW92ZQoJCQkJCWlmICggY2FjaGVbIGlkIF0gKSB7CgoJCQkJCQlkZWxldGUgY2FjaGVbIGlkIF07CgoJCQkJCQkvLyBJRSBkb2VzIG5vdCBhbGxvdyB1cyB0byBkZWxldGUgZXhwYW5kbyBwcm9wZXJ0aWVzIGZyb20gbm9kZXMsCgkJCQkJCS8vIG5vciBkb2VzIGl0IGhhdmUgYSByZW1vdmVBdHRyaWJ1dGUgZnVuY3Rpb24gb24gRG9jdW1lbnQgbm9kZXM7CgkJCQkJCS8vIHdlIG11c3QgaGFuZGxlIGFsbCBvZiB0aGVzZSBjYXNlcwoJCQkJCQlpZiAoIGRlbGV0ZUV4cGFuZG8gKSB7CgkJCQkJCQlkZWxldGUgZWxlbVsgaW50ZXJuYWxLZXkgXTsKCgkJCQkJCX0gZWxzZSBpZiAoIGVsZW0ucmVtb3ZlQXR0cmlidXRlICkgewoJCQkJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIGludGVybmFsS2V5ICk7CgoJCQkJCQl9IGVsc2UgewoJCQkJCQkJZWxlbVsgaW50ZXJuYWxLZXkgXSA9IG51bGw7CgkJCQkJCX0KCgkJCQkJCWpRdWVyeS5kZWxldGVkSWRzLnB1c2goIGlkICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9KTsKLy8gTGltaXQgc2NvcGUgcG9sbHV0aW9uIGZyb20gYW55IGRlcHJlY2F0ZWQgQVBJCihmdW5jdGlvbigpIHsKCnZhciBtYXRjaGVkLCBicm93c2VyOwoKLy8gVXNlIG9mIGpRdWVyeS5icm93c2VyIGlzIGZyb3duZWQgdXBvbi4KLy8gTW9yZSBkZXRhaWxzOiBodHRwOi8vYXBpLmpxdWVyeS5jb20valF1ZXJ5LmJyb3dzZXIKLy8galF1ZXJ5LnVhTWF0Y2ggbWFpbnRhaW5lZCBmb3IgYmFjay1jb21wYXQKalF1ZXJ5LnVhTWF0Y2ggPSBmdW5jdGlvbiggdWEgKSB7Cgl1YSA9IHVhLnRvTG93ZXJDYXNlKCk7CgoJdmFyIG1hdGNoID0gLyhjaHJvbWUpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCS8od2Via2l0KVsgXC9dKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKCQkvKG9wZXJhKSg/Oi4qdmVyc2lvbnwpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCS8obXNpZSkgKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKCQl1YS5pbmRleE9mKCJjb21wYXRpYmxlIikgPCAwICYmIC8obW96aWxsYSkoPzouKj8gcnY6KFtcdy5dKyl8KS8uZXhlYyggdWEgKSB8fAoJCVtdOwoKCXJldHVybiB7CgkJYnJvd3NlcjogbWF0Y2hbIDEgXSB8fCAiIiwKCQl2ZXJzaW9uOiBtYXRjaFsgMiBdIHx8ICIwIgoJfTsKfTsKCm1hdGNoZWQgPSBqUXVlcnkudWFNYXRjaCggbmF2aWdhdG9yLnVzZXJBZ2VudCApOwpicm93c2VyID0ge307CgppZiAoIG1hdGNoZWQuYnJvd3NlciApIHsKCWJyb3dzZXJbIG1hdGNoZWQuYnJvd3NlciBdID0gdHJ1ZTsKCWJyb3dzZXIudmVyc2lvbiA9IG1hdGNoZWQudmVyc2lvbjsKfQoKLy8gQ2hyb21lIGlzIFdlYmtpdCwgYnV0IFdlYmtpdCBpcyBhbHNvIFNhZmFyaS4KaWYgKCBicm93c2VyLmNocm9tZSApIHsKCWJyb3dzZXIud2Via2l0ID0gdHJ1ZTsKfSBlbHNlIGlmICggYnJvd3Nlci53ZWJraXQgKSB7Cglicm93c2VyLnNhZmFyaSA9IHRydWU7Cn0KCmpRdWVyeS5icm93c2VyID0gYnJvd3NlcjsKCmpRdWVyeS5zdWIgPSBmdW5jdGlvbigpIHsKCWZ1bmN0aW9uIGpRdWVyeVN1Yiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJcmV0dXJuIG5ldyBqUXVlcnlTdWIuZm4uaW5pdCggc2VsZWN0b3IsIGNvbnRleHQgKTsKCX0KCWpRdWVyeS5leHRlbmQoIHRydWUsIGpRdWVyeVN1YiwgdGhpcyApOwoJalF1ZXJ5U3ViLnN1cGVyY2xhc3MgPSB0aGlzOwoJalF1ZXJ5U3ViLmZuID0galF1ZXJ5U3ViLnByb3RvdHlwZSA9IHRoaXMoKTsKCWpRdWVyeVN1Yi5mbi5jb25zdHJ1Y3RvciA9IGpRdWVyeVN1YjsKCWpRdWVyeVN1Yi5zdWIgPSB0aGlzLnN1YjsKCWpRdWVyeVN1Yi5mbi5pbml0ID0gZnVuY3Rpb24gaW5pdCggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJaWYgKCBjb250ZXh0ICYmIGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgJiYgIShjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5U3ViKSApIHsKCQkJY29udGV4dCA9IGpRdWVyeVN1YiggY29udGV4dCApOwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5mbi5pbml0LmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByb290alF1ZXJ5U3ViICk7Cgl9OwoJalF1ZXJ5U3ViLmZuLmluaXQucHJvdG90eXBlID0galF1ZXJ5U3ViLmZuOwoJdmFyIHJvb3RqUXVlcnlTdWIgPSBqUXVlcnlTdWIoZG9jdW1lbnQpOwoJcmV0dXJuIGpRdWVyeVN1YjsKfTsKCn0pKCk7CnZhciBjdXJDU1MsIGlmcmFtZSwgaWZyYW1lRG9jLAoJcmFscGhhID0gL2FscGhhXChbXildKlwpL2ksCglyb3BhY2l0eSA9IC9vcGFjaXR5PShbXildKikvLAoJcnBvc2l0aW9uID0gL14odG9wfHJpZ2h0fGJvdHRvbXxsZWZ0KSQvLAoJLy8gc3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZSBleGNlcHQgInRhYmxlIiwgInRhYmxlLWNlbGwiLCBvciAidGFibGUtY2FwdGlvbiIKCS8vIHNlZSBoZXJlIGZvciBkaXNwbGF5IHZhbHVlczogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9DU1MvZGlzcGxheQoJcmRpc3BsYXlzd2FwID0gL14obm9uZXx0YWJsZSg/IS1jW2VhXSkuKykvLAoJcm1hcmdpbiA9IC9ebWFyZ2luLywKCXJudW1zcGxpdCA9IG5ldyBSZWdFeHAoICJeKCIgKyBjb3JlX3BudW0gKyAiKSguKikkIiwgImkiICksCglybnVtbm9ucHggPSBuZXcgUmVnRXhwKCAiXigiICsgY29yZV9wbnVtICsgIikoPyFweClbYS16JV0rJCIsICJpIiApLAoJcnJlbE51bSA9IG5ldyBSZWdFeHAoICJeKFstK10pPSgiICsgY29yZV9wbnVtICsgIikiLCAiaSIgKSwKCWVsZW1kaXNwbGF5ID0geyBCT0RZOiAiYmxvY2siIH0sCgoJY3NzU2hvdyA9IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHZpc2liaWxpdHk6ICJoaWRkZW4iLCBkaXNwbGF5OiAiYmxvY2siIH0sCgljc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CgkJbGV0dGVyU3BhY2luZzogMCwKCQlmb250V2VpZ2h0OiA0MDAKCX0sCgoJY3NzRXhwYW5kID0gWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdLAoJY3NzUHJlZml4ZXMgPSBbICJXZWJraXQiLCAiTyIsICJNb3oiLCAibXMiIF0sCgoJZXZlbnRzVG9nZ2xlID0galF1ZXJ5LmZuLnRvZ2dsZTsKCi8vIHJldHVybiBhIGNzcyBwcm9wZXJ0eSBtYXBwZWQgdG8gYSBwb3RlbnRpYWxseSB2ZW5kb3IgcHJlZml4ZWQgcHJvcGVydHkKZnVuY3Rpb24gdmVuZG9yUHJvcE5hbWUoIHN0eWxlLCBuYW1lICkgewoKCS8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkCglpZiAoIG5hbWUgaW4gc3R5bGUgKSB7CgkJcmV0dXJuIG5hbWU7Cgl9CgoJLy8gY2hlY2sgZm9yIHZlbmRvciBwcmVmaXhlZCBuYW1lcwoJdmFyIGNhcE5hbWUgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKCQlvcmlnTmFtZSA9IG5hbWUsCgkJaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKCgl3aGlsZSAoIGktLSApIHsKCQluYW1lID0gY3NzUHJlZml4ZXNbIGkgXSArIGNhcE5hbWU7CgkJaWYgKCBuYW1lIGluIHN0eWxlICkgewoJCQlyZXR1cm4gbmFtZTsKCQl9Cgl9CgoJcmV0dXJuIG9yaWdOYW1lOwp9CgpmdW5jdGlvbiBpc0hpZGRlbiggZWxlbSwgZWwgKSB7CgllbGVtID0gZWwgfHwgZWxlbTsKCXJldHVybiBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSA9PT0gIm5vbmUiIHx8ICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOwp9CgpmdW5jdGlvbiBzaG93SGlkZSggZWxlbWVudHMsIHNob3cgKSB7Cgl2YXIgZWxlbSwgZGlzcGxheSwKCQl2YWx1ZXMgPSBbXSwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQl2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiApOwoJCWlmICggc2hvdyApIHsKCQkJLy8gUmVzZXQgdGhlIGlubGluZSBkaXNwbGF5IG9mIHRoaXMgZWxlbWVudCB0byBsZWFybiBpZiBpdCBpcwoJCQkvLyBiZWluZyBoaWRkZW4gYnkgY2FzY2FkZWQgcnVsZXMgb3Igbm90CgkJCWlmICggIXZhbHVlc1sgaW5kZXggXSAmJiBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiApIHsKCQkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOwoJCQl9CgoJCQkvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lCgkJCS8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCgkJCS8vIGZvciBzdWNoIGFuIGVsZW1lbnQKCQkJaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuKCBlbGVtICkgKSB7CgkJCQl2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgY3NzX2RlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkaXNwbGF5ID0gY3VyQ1NTKCBlbGVtLCAiZGlzcGxheSIgKTsKCgkJCWlmICggIXZhbHVlc1sgaW5kZXggXSAmJiBkaXNwbGF5ICE9PSAibm9uZSIgKSB7CgkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgZGlzcGxheSApOwoJCQl9CgkJfQoJfQoKCS8vIFNldCB0aGUgZGlzcGxheSBvZiBtb3N0IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCgkvLyB0byBhdm9pZCB0aGUgY29uc3RhbnQgcmVmbG93Cglmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCWVsZW0gPSBlbGVtZW50c1sgaW5kZXggXTsKCQlpZiAoICFlbGVtLnN0eWxlICkgewoJCQljb250aW51ZTsKCQl9CgkJaWYgKCAhc2hvdyB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICkgewoJCQllbGVtLnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gdmFsdWVzWyBpbmRleCBdIHx8ICIiIDogIm5vbmUiOwoJCX0KCX0KCglyZXR1cm4gZWxlbWVudHM7Cn0KCmpRdWVyeS5mbi5leHRlbmQoewoJY3NzOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKCQkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lLCB2YWx1ZSApIDoKCQkJCWpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKTsKCQl9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCglzaG93OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMsIHRydWUgKTsKCX0sCgloaWRlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMgKTsKCX0sCgl0b2dnbGU6IGZ1bmN0aW9uKCBzdGF0ZSwgZm4yICkgewoJCXZhciBib29sID0gdHlwZW9mIHN0YXRlID09PSAiYm9vbGVhbiI7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHN0YXRlICkgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIGZuMiApICkgewoJCQlyZXR1cm4gZXZlbnRzVG9nZ2xlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggYm9vbCA/IHN0YXRlIDogaXNIaWRkZW4oIHRoaXMgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnNob3coKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeSggdGhpcyApLmhpZGUoKTsKCQkJfQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5leHRlbmQoewoJLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CgkvLyBiZWhhdmlvciBvZiBnZXR0aW5nIGFuZCBzZXR0aW5nIGEgc3R5bGUgcHJvcGVydHkKCWNzc0hvb2tzOiB7CgkJb3BhY2l0eTogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKCQkJCQl2YXIgcmV0ID0gY3VyQ1NTKCBlbGVtLCAib3BhY2l0eSIgKTsKCQkJCQlyZXR1cm4gcmV0ID09PSAiIiA/ICIxIiA6IHJldDsKCgkJCQl9CgkJCX0KCQl9Cgl9LAoKCS8vIEV4Y2x1ZGUgdGhlIGZvbGxvd2luZyBjc3MgcHJvcGVydGllcyB0byBhZGQgcHgKCWNzc051bWJlcjogewoJCSJmaWxsT3BhY2l0eSI6IHRydWUsCgkJImZvbnRXZWlnaHQiOiB0cnVlLAoJCSJsaW5lSGVpZ2h0IjogdHJ1ZSwKCQkib3BhY2l0eSI6IHRydWUsCgkJIm9ycGhhbnMiOiB0cnVlLAoJCSJ3aWRvd3MiOiB0cnVlLAoJCSJ6SW5kZXgiOiB0cnVlLAoJCSJ6b29tIjogdHJ1ZQoJfSwKCgkvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCgkvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCgljc3NQcm9wczogewoJCS8vIG5vcm1hbGl6ZSBmbG9hdCBjc3MgcHJvcGVydHkKCQkiZmxvYXQiOiBqUXVlcnkuc3VwcG9ydC5jc3NGbG9hdCA/ICJjc3NGbG9hdCIgOiAic3R5bGVGbG9hdCIKCX0sCgoJLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUKCXN0eWxlOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhICkgewoJCS8vIERvbid0IHNldCBzdHlsZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4IHx8ICFlbGVtLnN0eWxlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQl2YXIgcmV0LCB0eXBlLCBob29rcywKCQkJb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICksCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSB8fCAoIGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSA9IHZlbmRvclByb3BOYW1lKCBzdHlsZSwgb3JpZ05hbWUgKSApOwoKCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCgkJLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKCQkvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCXR5cGUgPSB0eXBlb2YgdmFsdWU7CgoJCQkvLyBjb252ZXJ0IHJlbGF0aXZlIG51bWJlciBzdHJpbmdzICgrPSBvciAtPSkgdG8gcmVsYXRpdmUgbnVtYmVycy4gIzczNDUKCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcnJlbE51bS5leGVjKCB2YWx1ZSApKSApIHsKCQkJCXZhbHVlID0gKCByZXRbMV0gKyAxICkgKiByZXRbMl0gKyBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKCBlbGVtLCBuYW1lICkgKTsKCQkJCS8vIEZpeGVzIGJ1ZyAjOTIzNwoJCQkJdHlwZSA9ICJudW1iZXIiOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhhdCBOYU4gYW5kIG51bGwgdmFsdWVzIGFyZW4ndCBzZXQuIFNlZTogIzcxMTYKCQkJaWYgKCB2YWx1ZSA9PSBudWxsIHx8IHR5cGUgPT09ICJudW1iZXIiICYmIGlzTmFOKCB2YWx1ZSApICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhIG51bWJlciB3YXMgcGFzc2VkIGluLCBhZGQgJ3B4JyB0byB0aGUgKGV4Y2VwdCBmb3IgY2VydGFpbiBDU1MgcHJvcGVydGllcykKCQkJaWYgKCB0eXBlID09PSAibnVtYmVyIiAmJiAhalF1ZXJ5LmNzc051bWJlclsgb3JpZ05hbWUgXSApIHsKCQkJCXZhbHVlICs9ICJweCI7CgkJCX0KCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gV3JhcHBlZCB0byBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgZXJyb3JzIHdoZW4gJ2ludmFsaWQnIHZhbHVlcyBhcmUgcHJvdmlkZWQKCQkJCS8vIEZpeGVzIGJ1ZyAjNTUwOQoJCQkJdHJ5IHsKCQkJCQlzdHlsZVsgbmFtZSBdID0gdmFsdWU7CgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCgkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgZmFsc2UsIGV4dHJhICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgoJCQkvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdAoJCQlyZXR1cm4gc3R5bGVbIG5hbWUgXTsKCQl9Cgl9LAoKCWNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIG51bWVyaWMsIGV4dHJhICkgewoJCXZhciB2YWwsIG51bSwgaG9va3MsCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIGVsZW0uc3R5bGUsIG9yaWdOYW1lICkgKTsKCgkJLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewoJCQl2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CgkJfQoKCQkvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCXZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSApOwoJCX0KCgkJLy9jb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCgkJaWYgKCB2YWwgPT09ICJub3JtYWwiICYmIG5hbWUgaW4gY3NzTm9ybWFsVHJhbnNmb3JtICkgewoJCQl2YWwgPSBjc3NOb3JtYWxUcmFuc2Zvcm1bIG5hbWUgXTsKCQl9CgoJCS8vIFJldHVybiwgY29udmVydGluZyB0byBudW1iZXIgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKCQlpZiAoIG51bWVyaWMgfHwgZXh0cmEgIT09IHVuZGVmaW5lZCApIHsKCQkJbnVtID0gcGFyc2VGbG9hdCggdmFsICk7CgkJCXJldHVybiBudW1lcmljIHx8IGpRdWVyeS5pc051bWVyaWMoIG51bSApID8gbnVtIHx8IDAgOiB2YWw7CgkJfQoJCXJldHVybiB2YWw7Cgl9LAoKCS8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMKCXN3YXA6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQl2YXIgcmV0LCBuYW1lLAoJCQlvbGQgPSB7fTsKCgkJLy8gUmVtZW1iZXIgdGhlIG9sZCB2YWx1ZXMsIGFuZCBpbnNlcnQgdGhlIG5ldyBvbmVzCgkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCQlvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJCX0KCgkJcmV0ID0gY2FsbGJhY2suY2FsbCggZWxlbSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KfSk7CgovLyBOT1RFOiBUbyBhbnkgZnV0dXJlIG1haW50YWluZXIsIHdlJ3ZlIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlCi8vIGJlY2F1c2UganNkb20gb24gbm9kZS5qcyB3aWxsIGJyZWFrIHdpdGhvdXQgaXQuCmlmICggd2luZG93LmdldENvbXB1dGVkU3R5bGUgKSB7CgljdXJDU1MgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQl2YXIgcmV0LCB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLAoJCQljb21wdXRlZCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICksCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJaWYgKCBjb21wdXRlZCApIHsKCgkJCS8vIGdldFByb3BlcnR5VmFsdWUgaXMgb25seSBuZWVkZWQgZm9yIC5jc3MoJ2ZpbHRlcicpIGluIElFOSwgc2VlICMxMjUzNwoJCQlyZXQgPSBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKCBuYW1lICkgfHwgY29tcHV0ZWRbIG5hbWUgXTsKCgkJCWlmICggcmV0ID09PSAiIiAmJiAhalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsKCQkJCXJldCA9IGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSApOwoJCQl9CgoJCQkvLyBBIHRyaWJ1dGUgdG8gdGhlICJhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzIgoJCQkvLyBDaHJvbWUgPCAxNyBhbmQgU2FmYXJpIDUuMCB1c2VzICJjb21wdXRlZCB2YWx1ZSIgaW5zdGVhZCBvZiAidXNlZCB2YWx1ZSIgZm9yIG1hcmdpbi1yaWdodAoJCQkvLyBTYWZhcmkgNS4xLjcgKGF0IGxlYXN0KSByZXR1cm5zIHBlcmNlbnRhZ2UgZm9yIGEgbGFyZ2VyIHNldCBvZiB2YWx1ZXMsIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMKCQkJLy8gdGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCgkJCWlmICggcm51bW5vbnB4LnRlc3QoIHJldCApICYmIHJtYXJnaW4udGVzdCggbmFtZSApICkgewoJCQkJd2lkdGggPSBzdHlsZS53aWR0aDsKCQkJCW1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CgkJCQltYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwoKCQkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKCQkJCXJldCA9IGNvbXB1dGVkLndpZHRoOwoKCQkJCXN0eWxlLndpZHRoID0gd2lkdGg7CgkJCQlzdHlsZS5taW5XaWR0aCA9IG1pbldpZHRoOwoJCQkJc3R5bGUubWF4V2lkdGggPSBtYXhXaWR0aDsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldDsKCX07Cn0gZWxzZSBpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jdXJyZW50U3R5bGUgKSB7CgljdXJDU1MgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQl2YXIgbGVmdCwgcnNMZWZ0LAoJCQlyZXQgPSBlbGVtLmN1cnJlbnRTdHlsZSAmJiBlbGVtLmN1cnJlbnRTdHlsZVsgbmFtZSBdLAoJCQlzdHlsZSA9IGVsZW0uc3R5bGU7CgoJCS8vIEF2b2lkIHNldHRpbmcgcmV0IHRvIGVtcHR5IHN0cmluZyBoZXJlCgkJLy8gc28gd2UgZG9uJ3QgZGVmYXVsdCB0byBhdXRvCgkJaWYgKCByZXQgPT0gbnVsbCAmJiBzdHlsZSAmJiBzdHlsZVsgbmFtZSBdICkgewoJCQlyZXQgPSBzdHlsZVsgbmFtZSBdOwoJCX0KCgkJLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwoJCS8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCgkJLy8gSWYgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIHJlZ3VsYXIgcGl4ZWwgbnVtYmVyCgkJLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgkJLy8gYnV0IG5vdCBwb3NpdGlvbiBjc3MgYXR0cmlidXRlcywgYXMgdGhvc2UgYXJlIHByb3BvcnRpb25hbCB0byB0aGUgcGFyZW50IGVsZW1lbnQgaW5zdGVhZAoJCS8vIGFuZCB3ZSBjYW4ndCBtZWFzdXJlIHRoZSBwYXJlbnQgaW5zdGVhZCBiZWNhdXNlIGl0IG1pZ2h0IHRyaWdnZXIgYSAic3RhY2tpbmcgZG9sbHMiIHByb2JsZW0KCQlpZiAoIHJudW1ub25weC50ZXN0KCByZXQgKSAmJiAhcnBvc2l0aW9uLnRlc3QoIG5hbWUgKSApIHsKCgkJCS8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKCQkJbGVmdCA9IHN0eWxlLmxlZnQ7CgkJCXJzTGVmdCA9IGVsZW0ucnVudGltZVN0eWxlICYmIGVsZW0ucnVudGltZVN0eWxlLmxlZnQ7CgoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCWlmICggcnNMZWZ0ICkgewoJCQkJZWxlbS5ydW50aW1lU3R5bGUubGVmdCA9IGVsZW0uY3VycmVudFN0eWxlLmxlZnQ7CgkJCX0KCQkJc3R5bGUubGVmdCA9IG5hbWUgPT09ICJmb250U2l6ZSIgPyAiMWVtIiA6IHJldDsKCQkJcmV0ID0gc3R5bGUucGl4ZWxMZWZ0ICsgInB4IjsKCgkJCS8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKCQkJc3R5bGUubGVmdCA9IGxlZnQ7CgkJCWlmICggcnNMZWZ0ICkgewoJCQkJZWxlbS5ydW50aW1lU3R5bGUubGVmdCA9IHJzTGVmdDsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldCA9PT0gIiIgPyAiYXV0byIgOiByZXQ7Cgl9Owp9CgpmdW5jdGlvbiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICkgewoJdmFyIG1hdGNoZXMgPSBybnVtc3BsaXQuZXhlYyggdmFsdWUgKTsKCXJldHVybiBtYXRjaGVzID8KCQkJTWF0aC5tYXgoIDAsIG1hdGNoZXNbIDEgXSAtICggc3VidHJhY3QgfHwgMCApICkgKyAoIG1hdGNoZXNbIDIgXSB8fCAicHgiICkgOgoJCQl2YWx1ZTsKfQoKZnVuY3Rpb24gYXVnbWVudFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhLCBpc0JvcmRlckJveCApIHsKCXZhciBpID0gZXh0cmEgPT09ICggaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IiApID8KCQkvLyBJZiB3ZSBhbHJlYWR5IGhhdmUgdGhlIHJpZ2h0IG1lYXN1cmVtZW50LCBhdm9pZCBhdWdtZW50YXRpb24KCQk0IDoKCQkvLyBPdGhlcndpc2UgaW5pdGlhbGl6ZSBmb3IgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCBwcm9wZXJ0aWVzCgkJbmFtZSA9PT0gIndpZHRoIiA/IDEgOiAwLAoKCQl2YWwgPSAwOwoKCWZvciAoIDsgaSA8IDQ7IGkgKz0gMiApIHsKCQkvLyBib3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4sIHNvIGFkZCBpdCBpZiB3ZSB3YW50IGl0CgkJaWYgKCBleHRyYSA9PT0gIm1hcmdpbiIgKSB7CgkJCS8vIHdlIHVzZSBqUXVlcnkuY3NzIGluc3RlYWQgb2YgY3VyQ1NTIGhlcmUKCQkJLy8gYmVjYXVzZSBvZiB0aGUgcmVsaWFibGVNYXJnaW5SaWdodCBDU1MgaG9vayEKCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0sIHRydWUgKTsKCQl9CgoJCS8vIEZyb20gdGhpcyBwb2ludCBvbiB3ZSB1c2UgY3VyQ1NTIGZvciBtYXhpbXVtIHBlcmZvcm1hbmNlIChyZWxldmFudCBpbiBhbmltYXRpb25zKQoJCWlmICggaXNCb3JkZXJCb3ggKSB7CgkJCS8vIGJvcmRlci1ib3ggaW5jbHVkZXMgcGFkZGluZywgc28gcmVtb3ZlIGl0IGlmIHdlIHdhbnQgY29udGVudAoJCQlpZiAoIGV4dHJhID09PSAiY29udGVudCIgKSB7CgkJCQl2YWwgLT0gcGFyc2VGbG9hdCggY3VyQ1NTKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSApICkgfHwgMDsKCQkJfQoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CgkJCQl2YWwgLT0gcGFyc2VGbG9hdCggY3VyQ1NTKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiApICkgfHwgMDsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQsIHNvIGFkZCBwYWRkaW5nCgkJCXZhbCArPSBwYXJzZUZsb2F0KCBjdXJDU1MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdICkgKSB8fCAwOwoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCBub3IgcGFkZGluZywgc28gYWRkIGJvcmRlcgoJCQlpZiAoIGV4dHJhICE9PSAicGFkZGluZyIgKSB7CgkJCQl2YWwgKz0gcGFyc2VGbG9hdCggY3VyQ1NTKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiApICkgfHwgMDsKCQkJfQoJCX0KCX0KCglyZXR1cm4gdmFsOwp9CgpmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApIHsKCgkvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQoJdmFyIHZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCgkJdmFsdWVJc0JvcmRlckJveCA9IHRydWUsCgkJaXNCb3JkZXJCb3ggPSBqUXVlcnkuc3VwcG9ydC5ib3hTaXppbmcgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImJveFNpemluZyIgKSA9PT0gImJvcmRlci1ib3giOwoKCS8vIHNvbWUgbm9uLWh0bWwgZWxlbWVudHMgcmV0dXJuIHVuZGVmaW5lZCBmb3Igb2Zmc2V0V2lkdGgsIHNvIGNoZWNrIGZvciBudWxsL3VuZGVmaW5lZAoJLy8gc3ZnIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjQ5Mjg1CgkvLyBNYXRoTUwgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00OTE2NjgKCWlmICggdmFsIDw9IDAgfHwgdmFsID09IG51bGwgKSB7CgkJLy8gRmFsbCBiYWNrIHRvIGNvbXB1dGVkIHRoZW4gdW5jb21wdXRlZCBjc3MgaWYgbmVjZXNzYXJ5CgkJdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lICk7CgkJaWYgKCB2YWwgPCAwIHx8IHZhbCA9PSBudWxsICkgewoJCQl2YWwgPSBlbGVtLnN0eWxlWyBuYW1lIF07CgkJfQoKCQkvLyBDb21wdXRlZCB1bml0IGlzIG5vdCBwaXhlbHMuIFN0b3AgaGVyZSBhbmQgcmV0dXJuLgoJCWlmICggcm51bW5vbnB4LnRlc3QodmFsKSApIHsKCQkJcmV0dXJuIHZhbDsKCQl9CgoJCS8vIHdlIG5lZWQgdGhlIGNoZWNrIGZvciBzdHlsZSBpbiBjYXNlIGEgYnJvd3NlciB3aGljaCByZXR1cm5zIHVucmVsaWFibGUgdmFsdWVzCgkJLy8gZm9yIGdldENvbXB1dGVkU3R5bGUgc2lsZW50bHkgZmFsbHMgYmFjayB0byB0aGUgcmVsaWFibGUgZWxlbS5zdHlsZQoJCXZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCAmJiAoIGpRdWVyeS5zdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlIHx8IHZhbCA9PT0gZWxlbS5zdHlsZVsgbmFtZSBdICk7CgoJCS8vIE5vcm1hbGl6ZSAiIiwgYXV0bywgYW5kIHByZXBhcmUgZm9yIGV4dHJhCgkJdmFsID0gcGFyc2VGbG9hdCggdmFsICkgfHwgMDsKCX0KCgkvLyB1c2UgdGhlIGFjdGl2ZSBib3gtc2l6aW5nIG1vZGVsIHRvIGFkZC9zdWJ0cmFjdCBpcnJlbGV2YW50IHN0eWxlcwoJcmV0dXJuICggdmFsICsKCQlhdWdtZW50V2lkdGhPckhlaWdodCgKCQkJZWxlbSwKCQkJbmFtZSwKCQkJZXh0cmEgfHwgKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICksCgkJCXZhbHVlSXNCb3JkZXJCb3gKCQkpCgkpICsgInB4IjsKfQoKCi8vIFRyeSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CmZ1bmN0aW9uIGNzc19kZWZhdWx0RGlzcGxheSggbm9kZU5hbWUgKSB7CglpZiAoIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdICkgewoJCXJldHVybiBlbGVtZGlzcGxheVsgbm9kZU5hbWUgXTsKCX0KCgl2YXIgZWxlbSA9IGpRdWVyeSggIjwiICsgbm9kZU5hbWUgKyAiPiIgKS5hcHBlbmRUbyggZG9jdW1lbnQuYm9keSApLAoJCWRpc3BsYXkgPSBlbGVtLmNzcygiZGlzcGxheSIpOwoJZWxlbS5yZW1vdmUoKTsKCgkvLyBJZiB0aGUgc2ltcGxlIHdheSBmYWlscywKCS8vIGdldCBlbGVtZW50J3MgcmVhbCBkZWZhdWx0IGRpc3BsYXkgYnkgYXR0YWNoaW5nIGl0IHRvIGEgdGVtcCBpZnJhbWUKCWlmICggZGlzcGxheSA9PT0gIm5vbmUiIHx8IGRpc3BsYXkgPT09ICIiICkgewoJCS8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIGlmcmFtZSBpZiBwb3NzaWJsZQoJCWlmcmFtZSA9IGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoCgkJCWlmcmFtZSB8fCBqUXVlcnkuZXh0ZW5kKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpZnJhbWUiKSwgewoJCQkJZnJhbWVCb3JkZXI6IDAsCgkJCQl3aWR0aDogMCwKCQkJCWhlaWdodDogMAoJCQl9KQoJCSk7CgoJCS8vIENyZWF0ZSBhIGNhY2hlYWJsZSBjb3B5IG9mIHRoZSBpZnJhbWUgZG9jdW1lbnQgb24gZmlyc3QgY2FsbC4KCQkvLyBJRSBhbmQgT3BlcmEgd2lsbCBhbGxvdyB1cyB0byByZXVzZSB0aGUgaWZyYW1lRG9jIHdpdGhvdXQgcmUtd3JpdGluZyB0aGUgZmFrZSBIVE1MCgkJLy8gZG9jdW1lbnQgdG8gaXQ7IFdlYktpdCAmIEZpcmVmb3ggd29uJ3QgYWxsb3cgcmV1c2luZyB0aGUgaWZyYW1lIGRvY3VtZW50LgoJCWlmICggIWlmcmFtZURvYyB8fCAhaWZyYW1lLmNyZWF0ZUVsZW1lbnQgKSB7CgkJCWlmcmFtZURvYyA9ICggaWZyYW1lLmNvbnRlbnRXaW5kb3cgfHwgaWZyYW1lLmNvbnRlbnREb2N1bWVudCApLmRvY3VtZW50OwoJCQlpZnJhbWVEb2Mud3JpdGUoIjwhZG9jdHlwZSBodG1sPjxodG1sPjxib2R5PiIpOwoJCQlpZnJhbWVEb2MuY2xvc2UoKTsKCQl9CgoJCWVsZW0gPSBpZnJhbWVEb2MuYm9keS5hcHBlbmRDaGlsZCggaWZyYW1lRG9jLmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpICk7CgoJCWRpc3BsYXkgPSBjdXJDU1MoIGVsZW0sICJkaXNwbGF5IiApOwoJCWRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoIGlmcmFtZSApOwoJfQoKCS8vIFN0b3JlIHRoZSBjb3JyZWN0IGRlZmF1bHQgZGlzcGxheQoJZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF0gPSBkaXNwbGF5OwoKCXJldHVybiBkaXNwbGF5Owp9CgpqUXVlcnkuZWFjaChbICJoZWlnaHQiLCAid2lkdGgiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gPSB7CgkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQsIGV4dHJhICkgewoJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJLy8gY2VydGFpbiBlbGVtZW50cyBjYW4gaGF2ZSBkaW1lbnNpb24gaW5mbyBpZiB3ZSBpbnZpc2libHkgc2hvdyB0aGVtCgkJCQkvLyBob3dldmVyLCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0IGZyb20gdGhpcwoJCQkJaWYgKCBlbGVtLm9mZnNldFdpZHRoID09PSAwICYmIHJkaXNwbGF5c3dhcC50ZXN0KCBjdXJDU1MoIGVsZW0sICJkaXNwbGF5IiApICkgKSB7CgkJCQkJcmV0dXJuIGpRdWVyeS5zd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApOwoJCQkJfQoJCQl9CgkJfSwKCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIGV4dHJhICkgewoJCQlyZXR1cm4gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBleHRyYSA/CgkJCQlhdWdtZW50V2lkdGhPckhlaWdodCgKCQkJCQllbGVtLAoJCQkJCW5hbWUsCgkJCQkJZXh0cmEsCgkJCQkJalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciICkgPT09ICJib3JkZXItYm94IgoJCQkJKSA6IDAKCQkJKTsKCQl9Cgl9Owp9KTsKCmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wYWNpdHkgKSB7CglqUXVlcnkuY3NzSG9va3Mub3BhY2l0eSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJLy8gSUUgdXNlcyBmaWx0ZXJzIGZvciBvcGFjaXR5CgkJCXJldHVybiByb3BhY2l0eS50ZXN0KCAoY29tcHV0ZWQgJiYgZWxlbS5jdXJyZW50U3R5bGUgPyBlbGVtLmN1cnJlbnRTdHlsZS5maWx0ZXIgOiBlbGVtLnN0eWxlLmZpbHRlcikgfHwgIiIgKSA/CgkJCQkoIDAuMDEgKiBwYXJzZUZsb2F0KCBSZWdFeHAuJDEgKSApICsgIiIgOgoJCQkJY29tcHV0ZWQgPyAiMSIgOiAiIjsKCQl9LAoKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJdmFyIHN0eWxlID0gZWxlbS5zdHlsZSwKCQkJCWN1cnJlbnRTdHlsZSA9IGVsZW0uY3VycmVudFN0eWxlLAoJCQkJb3BhY2l0eSA9IGpRdWVyeS5pc051bWVyaWMoIHZhbHVlICkgPyAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIgOiAiIiwKCQkJCWZpbHRlciA9IGN1cnJlbnRTdHlsZSAmJiBjdXJyZW50U3R5bGUuZmlsdGVyIHx8IHN0eWxlLmZpbHRlciB8fCAiIjsKCgkJCS8vIElFIGhhcyB0cm91YmxlIHdpdGggb3BhY2l0eSBpZiBpdCBkb2VzIG5vdCBoYXZlIGxheW91dAoJCQkvLyBGb3JjZSBpdCBieSBzZXR0aW5nIHRoZSB6b29tIGxldmVsCgkJCXN0eWxlLnpvb20gPSAxOwoKCQkJLy8gaWYgc2V0dGluZyBvcGFjaXR5IHRvIDEsIGFuZCBubyBvdGhlciBmaWx0ZXJzIGV4aXN0IC0gYXR0ZW1wdCB0byByZW1vdmUgZmlsdGVyIGF0dHJpYnV0ZSAjNjY1MgoJCQlpZiAoIHZhbHVlID49IDEgJiYgalF1ZXJ5LnRyaW0oIGZpbHRlci5yZXBsYWNlKCByYWxwaGEsICIiICkgKSA9PT0gIiIgJiYKCQkJCXN0eWxlLnJlbW92ZUF0dHJpYnV0ZSApIHsKCgkJCQkvLyBTZXR0aW5nIHN0eWxlLmZpbHRlciB0byBudWxsLCAiIiAmICIgIiBzdGlsbCBsZWF2ZSAiZmlsdGVyOiIgaW4gdGhlIGNzc1RleHQKCQkJCS8vIGlmICJmaWx0ZXI6IiBpcyBwcmVzZW50IGF0IGFsbCwgY2xlYXJUeXBlIGlzIGRpc2FibGVkLCB3ZSB3YW50IHRvIGF2b2lkIHRoaXMKCQkJCS8vIHN0eWxlLnJlbW92ZUF0dHJpYnV0ZSBpcyBJRSBPbmx5LCBidXQgc28gYXBwYXJlbnRseSBpcyB0aGlzIGNvZGUgcGF0aC4uLgoJCQkJc3R5bGUucmVtb3ZlQXR0cmlidXRlKCAiZmlsdGVyIiApOwoKCQkJCS8vIGlmIHRoZXJlIHRoZXJlIGlzIG5vIGZpbHRlciBzdHlsZSBhcHBsaWVkIGluIGEgY3NzIHJ1bGUsIHdlIGFyZSBkb25lCgkJCQlpZiAoIGN1cnJlbnRTdHlsZSAmJiAhY3VycmVudFN0eWxlLmZpbHRlciApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIG90aGVyd2lzZSwgc2V0IG5ldyBmaWx0ZXIgdmFsdWVzCgkJCXN0eWxlLmZpbHRlciA9IHJhbHBoYS50ZXN0KCBmaWx0ZXIgKSA/CgkJCQlmaWx0ZXIucmVwbGFjZSggcmFscGhhLCBvcGFjaXR5ICkgOgoJCQkJZmlsdGVyICsgIiAiICsgb3BhY2l0eTsKCQl9Cgl9Owp9CgovLyBUaGVzZSBob29rcyBjYW5ub3QgYmUgYWRkZWQgdW50aWwgRE9NIHJlYWR5IGJlY2F1c2UgdGhlIHN1cHBvcnQgdGVzdAovLyBmb3IgaXQgaXMgbm90IHJ1biB1bnRpbCBhZnRlciBET00gcmVhZHkKalF1ZXJ5KGZ1bmN0aW9uKCkgewoJaWYgKCAhalF1ZXJ5LnN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCApIHsKCQlqUXVlcnkuY3NzSG9va3MubWFyZ2luUmlnaHQgPSB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CgkJCQkvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKCQkJCXJldHVybiBqUXVlcnkuc3dhcCggZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJCXJldHVybiBjdXJDU1MoIGVsZW0sICJtYXJnaW5SaWdodCIgKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX07Cgl9CgoJLy8gV2Via2l0IGJ1ZzogaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTI5MDg0CgkvLyBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgcGVyY2VudCB3aGVuIHNwZWNpZmllZCBmb3IgdG9wL2xlZnQvYm90dG9tL3JpZ2h0CgkvLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwgd2UganVzdCBjaGVjayBmb3IgaXQgaGVyZQoJaWYgKCAhalF1ZXJ5LnN1cHBvcnQucGl4ZWxQb3NpdGlvbiAmJiBqUXVlcnkuZm4ucG9zaXRpb24gKSB7CgkJalF1ZXJ5LmVhY2goIFsgInRvcCIsICJsZWZ0IiBdLCBmdW5jdGlvbiggaSwgcHJvcCApIHsKCQkJalF1ZXJ5LmNzc0hvb2tzWyBwcm9wIF0gPSB7CgkJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJCQl2YXIgcmV0ID0gY3VyQ1NTKCBlbGVtLCBwcm9wICk7CgkJCQkJCS8vIGlmIGN1ckNTUyByZXR1cm5zIHBlcmNlbnRhZ2UsIGZhbGxiYWNrIHRvIG9mZnNldAoJCQkJCQlyZXR1cm4gcm51bW5vbnB4LnRlc3QoIHJldCApID8galF1ZXJ5KCBlbGVtICkucG9zaXRpb24oKVsgcHJvcCBdICsgInB4IiA6IHJldDsKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7Cgl9Cgp9KTsKCmlmICggalF1ZXJ5LmV4cHIgJiYgalF1ZXJ5LmV4cHIuZmlsdGVycyApIHsKCWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICggZWxlbS5vZmZzZXRXaWR0aCA9PT0gMCAmJiBlbGVtLm9mZnNldEhlaWdodCA9PT0gMCApIHx8ICghalF1ZXJ5LnN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzICYmICgoZWxlbS5zdHlsZSAmJiBlbGVtLnN0eWxlLmRpc3BsYXkpIHx8IGN1ckNTUyggZWxlbSwgImRpc3BsYXkiICkpID09PSAibm9uZSIpOwoJfTsKCglqUXVlcnkuZXhwci5maWx0ZXJzLnZpc2libGUgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gIWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuKCBlbGVtICk7Cgl9Owp9CgovLyBUaGVzZSBob29rcyBhcmUgdXNlZCBieSBhbmltYXRlIHRvIGV4cGFuZCBwcm9wZXJ0aWVzCmpRdWVyeS5lYWNoKHsKCW1hcmdpbjogIiIsCglwYWRkaW5nOiAiIiwKCWJvcmRlcjogIldpZHRoIgp9LCBmdW5jdGlvbiggcHJlZml4LCBzdWZmaXggKSB7CglqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdID0gewoJCWV4cGFuZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgaSwKCgkJCQkvLyBhc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKCQkJCXBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF0sCgkJCQlleHBhbmRlZCA9IHt9OwoKCQkJZm9yICggaSA9IDA7IGkgPCA0OyBpKysgKSB7CgkJCQlleHBhbmRlZFsgcHJlZml4ICsgY3NzRXhwYW5kWyBpIF0gKyBzdWZmaXggXSA9CgkJCQkJcGFydHNbIGkgXSB8fCBwYXJ0c1sgaSAtIDIgXSB8fCBwYXJ0c1sgMCBdOwoJCQl9CgoJCQlyZXR1cm4gZXhwYW5kZWQ7CgkJfQoJfTsKCglpZiAoICFybWFyZ2luLnRlc3QoIHByZWZpeCApICkgewoJCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7Cgl9Cn0pOwp2YXIgcjIwID0gLyUyMC9nLAoJcmJyYWNrZXQgPSAvXFtcXSQvLAoJckNSTEYgPSAvXHI/XG4vZywKCXJpbnB1dCA9IC9eKD86Y29sb3J8ZGF0ZXxkYXRldGltZXxkYXRldGltZS1sb2NhbHxlbWFpbHxoaWRkZW58bW9udGh8bnVtYmVyfHBhc3N3b3JkfHJhbmdlfHNlYXJjaHx0ZWx8dGV4dHx0aW1lfHVybHx3ZWVrKSQvaSwKCXJzZWxlY3RUZXh0YXJlYSA9IC9eKD86c2VsZWN0fHRleHRhcmVhKS9pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglzZXJpYWxpemU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBqUXVlcnkucGFyYW0oIHRoaXMuc2VyaWFsaXplQXJyYXkoKSApOwoJfSwKCXNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCB0aGlzLmVsZW1lbnRzICkgOiB0aGlzOwoJCX0pCgkJLmZpbHRlcihmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy5uYW1lICYmICF0aGlzLmRpc2FibGVkICYmCgkJCQkoIHRoaXMuY2hlY2tlZCB8fCByc2VsZWN0VGV4dGFyZWEudGVzdCggdGhpcy5ub2RlTmFtZSApIHx8CgkJCQkJcmlucHV0LnRlc3QoIHRoaXMudHlwZSApICk7CgkJfSkKCQkubWFwKGZ1bmN0aW9uKCBpLCBlbGVtICl7CgkJCXZhciB2YWwgPSBqUXVlcnkoIHRoaXMgKS52YWwoKTsKCgkJCXJldHVybiB2YWwgPT0gbnVsbCA/CgkJCQludWxsIDoKCQkJCWpRdWVyeS5pc0FycmF5KCB2YWwgKSA/CgkJCQkJalF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbiggdmFsLCBpICl7CgkJCQkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQkJCQl9KSA6CgkJCQkJeyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJfSkuZ2V0KCk7Cgl9Cn0pOwoKLy9TZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgovL2tleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwpqUXVlcnkucGFyYW0gPSBmdW5jdGlvbiggYSwgdHJhZGl0aW9uYWwgKSB7Cgl2YXIgcHJlZml4LAoJCXMgPSBbXSwKCQlhZGQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCgkJCXZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgPyB2YWx1ZSgpIDogKCB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSApOwoJCQlzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KCBrZXkgKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdmFsdWUgKTsKCQl9OwoKCS8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCglpZiAoIHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQgKSB7CgkJdHJhZGl0aW9uYWwgPSBqUXVlcnkuYWpheFNldHRpbmdzICYmIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7Cgl9CgoJLy8gSWYgYW4gYXJyYXkgd2FzIHBhc3NlZCBpbiwgYXNzdW1lIHRoYXQgaXQgaXMgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cy4KCWlmICggalF1ZXJ5LmlzQXJyYXkoIGEgKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggYSApICkgKSB7CgkJLy8gU2VyaWFsaXplIHRoZSBmb3JtIGVsZW1lbnRzCgkJalF1ZXJ5LmVhY2goIGEsIGZ1bmN0aW9uKCkgewoJCQlhZGQoIHRoaXMubmFtZSwgdGhpcy52YWx1ZSApOwoJCX0pOwoKCX0gZWxzZSB7CgkJLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCgkJLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCgkJZm9yICggcHJlZml4IGluIGEgKSB7CgkJCWJ1aWxkUGFyYW1zKCBwcmVmaXgsIGFbIHByZWZpeCBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KCXJldHVybiBzLmpvaW4oICImIiApLnJlcGxhY2UoIHIyMCwgIisiICk7Cn07CgpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7Cgl2YXIgbmFtZTsKCglpZiAoIGpRdWVyeS5pc0FycmF5KCBvYmogKSApIHsKCQkvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KCQlqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaSwgdiApIHsKCQkJaWYgKCB0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KCBwcmVmaXggKSApIHsKCQkJCS8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KCQkJCWFkZCggcHJlZml4LCB2ICk7CgoJCQl9IGVsc2UgewoJCQkJLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCgkJCQkvLyBudW1lcmljIGluZGV4IHRvIHJlc29sdmUgZGVzZXJpYWxpemF0aW9uIGFtYmlndWl0eSBpc3N1ZXMuCgkJCQkvLyBOb3RlIHRoYXQgcmFjayAoYXMgb2YgMS4wLjApIGNhbid0IGN1cnJlbnRseSBkZXNlcmlhbGl6ZQoJCQkJLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCgkJCQkvLyBhIHNlcnZlciBlcnJvci4gUG9zc2libGUgZml4ZXMgYXJlIHRvIG1vZGlmeSByYWNrJ3MKCQkJCS8vIGRlc2VyaWFsaXphdGlvbiBhbGdvcml0aG0gb3IgdG8gcHJvdmlkZSBhbiBvcHRpb24gb3IgZmxhZwoJCQkJLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgoJCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQkJfQoJCX0pOwoKCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewoJCS8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoKCX0gZWxzZSB7CgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgoJCWFkZCggcHJlZml4LCBvYmogKTsKCX0KfQp2YXIKCS8vIERvY3VtZW50IGxvY2F0aW9uCglhamF4TG9jUGFydHMsCglhamF4TG9jYXRpb24sCgoJcmhhc2ggPSAvIy4qJC8sCglyaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKVxyPyQvbWcsIC8vIElFIGxlYXZlcyBhbiBcciBjaGFyYWN0ZXIgYXQgRU9MCgkvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KCXJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwXC1zdG9yYWdlfC4rXC1leHRlbnNpb258ZmlsZXxyZXN8d2lkZ2V0KTokLywKCXJub0NvbnRlbnQgPSAvXig/OkdFVHxIRUFEKSQvLAoJcnByb3RvY29sID0gL15cL1wvLywKCXJxdWVyeSA9IC9cPy8sCglyc2NyaXB0ID0gLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2ksCglydHMgPSAvKFs/Jl0pXz1bXiZdKi8sCglydXJsID0gL14oW1x3XCtcLlwtXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKXwpfCkvLAoKCS8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKCV9sb2FkID0galF1ZXJ5LmZuLmxvYWQsCgoJLyogUHJlZmlsdGVycwoJICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKCSAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CgkgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CgkgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCgkgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXByZWZpbHRlcnMgPSB7fSwKCgkvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCgkgKiAxKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAoJICovCgl0cmFuc3BvcnRzID0ge30sCgoJLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCglhbGxUeXBlcyA9IFsiKi8iXSArIFsiKiJdOwoKLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CnRyeSB7CglhamF4TG9jYXRpb24gPSBsb2NhdGlvbi5ocmVmOwp9IGNhdGNoKCBlICkgewoJLy8gVXNlIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiBhbiBBIGVsZW1lbnQKCS8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCglhamF4TG9jYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCWFqYXhMb2NhdGlvbi5ocmVmID0gIiI7CglhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKfQoKLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCmFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyggYWpheExvY2F0aW9uLnRvTG93ZXJDYXNlKCkgKSB8fCBbXTsKCi8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CmZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlICkgewoKCS8vIGRhdGFUeXBlRXhwcmVzc2lvbiBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8gIioiCglyZXR1cm4gZnVuY3Rpb24oIGRhdGFUeXBlRXhwcmVzc2lvbiwgZnVuYyApIHsKCgkJaWYgKCB0eXBlb2YgZGF0YVR5cGVFeHByZXNzaW9uICE9PSAic3RyaW5nIiApIHsKCQkJZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKCQkJZGF0YVR5cGVFeHByZXNzaW9uID0gIioiOwoJCX0KCgkJdmFyIGRhdGFUeXBlLCBsaXN0LCBwbGFjZUJlZm9yZSwKCQkJZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkuc3BsaXQoIGNvcmVfcnNwYWNlICksCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBkYXRhVHlwZXMubGVuZ3RoOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBmdW5jICkgKSB7CgkJCS8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlc1sgaSBdOwoJCQkJLy8gV2UgY29udHJvbCBpZiB3ZSdyZSBhc2tlZCB0byBhZGQgYmVmb3JlCgkJCQkvLyBhbnkgZXhpc3RpbmcgZWxlbWVudAoJCQkJcGxhY2VCZWZvcmUgPSAvXlwrLy50ZXN0KCBkYXRhVHlwZSApOwoJCQkJaWYgKCBwbGFjZUJlZm9yZSApIHsKCQkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlLnN1YnN0ciggMSApIHx8ICIqIjsKCQkJCX0KCQkJCWxpc3QgPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW107CgkJCQkvLyB0aGVuIHdlIGFkZCB0byB0aGUgc3RydWN0dXJlIGFjY29yZGluZ2x5CgkJCQlsaXN0WyBwbGFjZUJlZm9yZSA/ICJ1bnNoaWZ0IiA6ICJwdXNoIiBdKCBmdW5jICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiwKCQlkYXRhVHlwZSAvKiBpbnRlcm5hbCAqLywgaW5zcGVjdGVkIC8qIGludGVybmFsICovICkgewoKCWRhdGFUeXBlID0gZGF0YVR5cGUgfHwgb3B0aW9ucy5kYXRhVHlwZXNbIDAgXTsKCWluc3BlY3RlZCA9IGluc3BlY3RlZCB8fCB7fTsKCglpbnNwZWN0ZWRbIGRhdGFUeXBlIF0gPSB0cnVlOwoKCXZhciBzZWxlY3Rpb24sCgkJbGlzdCA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSwKCQlpID0gMCwKCQlsZW5ndGggPSBsaXN0ID8gbGlzdC5sZW5ndGggOiAwLAoJCWV4ZWN1dGVPbmx5ID0gKCBzdHJ1Y3R1cmUgPT09IHByZWZpbHRlcnMgKTsKCglmb3IgKCA7IGkgPCBsZW5ndGggJiYgKCBleGVjdXRlT25seSB8fCAhc2VsZWN0aW9uICk7IGkrKyApIHsKCQlzZWxlY3Rpb24gPSBsaXN0WyBpIF0oIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKTsKCQkvLyBJZiB3ZSBnb3QgcmVkaXJlY3RlZCB0byBhbm90aGVyIGRhdGFUeXBlCgkJLy8gd2UgdHJ5IHRoZXJlIGlmIGV4ZWN1dGluZyBvbmx5IGFuZCBub3QgZG9uZSBhbHJlYWR5CgkJaWYgKCB0eXBlb2Ygc2VsZWN0aW9uID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCAhZXhlY3V0ZU9ubHkgfHwgaW5zcGVjdGVkWyBzZWxlY3Rpb24gXSApIHsKCQkJCXNlbGVjdGlvbiA9IHVuZGVmaW5lZDsKCQkJfSBlbHNlIHsKCQkJCW9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoIHNlbGVjdGlvbiApOwoJCQkJc2VsZWN0aW9uID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoCgkJCQkJCXN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiwgc2VsZWN0aW9uLCBpbnNwZWN0ZWQgKTsKCQkJfQoJCX0KCX0KCS8vIElmIHdlJ3JlIG9ubHkgZXhlY3V0aW5nIG9yIG5vdGhpbmcgd2FzIHNlbGVjdGVkCgkvLyB3ZSB0cnkgdGhlIGNhdGNoYWxsIGRhdGFUeXBlIGlmIG5vdCBkb25lIGFscmVhZHkKCWlmICggKCBleGVjdXRlT25seSB8fCAhc2VsZWN0aW9uICkgJiYgIWluc3BlY3RlZFsgIioiIF0gKSB7CgkJc2VsZWN0aW9uID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoCgkJCQlzdHJ1Y3R1cmUsIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIsICIqIiwgaW5zcGVjdGVkICk7Cgl9CgkvLyB1bm5lY2Vzc2FyeSB3aGVuIG9ubHkgZXhlY3V0aW5nIChwcmVmaWx0ZXJzKQoJLy8gYnV0IGl0J2xsIGJlIGlnbm9yZWQgYnkgdGhlIGNhbGxlciBpbiB0aGF0IGNhc2UKCXJldHVybiBzZWxlY3Rpb247Cn0KCi8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwovLyB0aGF0IHRha2VzICJmbGF0IiBvcHRpb25zIChub3QgdG8gYmUgZGVlcCBleHRlbmRlZCkKLy8gRml4ZXMgIzk4ODcKZnVuY3Rpb24gYWpheEV4dGVuZCggdGFyZ2V0LCBzcmMgKSB7Cgl2YXIga2V5LCBkZWVwLAoJCWZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKCWZvciAoIGtleSBpbiBzcmMgKSB7CgkJaWYgKCBzcmNbIGtleSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCSggZmxhdE9wdGlvbnNbIGtleSBdID8gdGFyZ2V0IDogKCBkZWVwIHx8ICggZGVlcCA9IHt9ICkgKSApWyBrZXkgXSA9IHNyY1sga2V5IF07CgkJfQoJfQoJaWYgKCBkZWVwICkgewoJCWpRdWVyeS5leHRlbmQoIHRydWUsIHRhcmdldCwgZGVlcCApOwoJfQp9CgpqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcywgY2FsbGJhY2sgKSB7CglpZiAoIHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICYmIF9sb2FkICkgewoJCXJldHVybiBfbG9hZC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7Cgl9CgoJLy8gRG9uJ3QgZG8gYSByZXF1ZXN0IGlmIG5vIGVsZW1lbnRzIGFyZSBiZWluZyByZXF1ZXN0ZWQKCWlmICggIXRoaXMubGVuZ3RoICkgewoJCXJldHVybiB0aGlzOwoJfQoKCXZhciBzZWxlY3RvciwgdHlwZSwgcmVzcG9uc2UsCgkJc2VsZiA9IHRoaXMsCgkJb2ZmID0gdXJsLmluZGV4T2YoIiAiKTsKCglpZiAoIG9mZiA+PSAwICkgewoJCXNlbGVjdG9yID0gdXJsLnNsaWNlKCBvZmYsIHVybC5sZW5ndGggKTsKCQl1cmwgPSB1cmwuc2xpY2UoIDAsIG9mZiApOwoJfQoKCS8vIElmIGl0J3MgYSBmdW5jdGlvbgoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcGFyYW1zICkgKSB7CgoJCS8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCgkJY2FsbGJhY2sgPSBwYXJhbXM7CgkJcGFyYW1zID0gdW5kZWZpbmVkOwoKCS8vIE90aGVyd2lzZSwgYnVpbGQgYSBwYXJhbSBzdHJpbmcKCX0gZWxzZSBpZiAoIHBhcmFtcyAmJiB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApIHsKCQl0eXBlID0gIlBPU1QiOwoJfQoKCS8vIFJlcXVlc3QgdGhlIHJlbW90ZSBkb2N1bWVudAoJalF1ZXJ5LmFqYXgoewoJCXVybDogdXJsLAoKCQkvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQKCQl0eXBlOiB0eXBlLAoJCWRhdGFUeXBlOiAiaHRtbCIsCgkJZGF0YTogcGFyYW1zLAoJCWNvbXBsZXRlOiBmdW5jdGlvbigganFYSFIsIHN0YXR1cyApIHsKCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCXNlbGYuZWFjaCggY2FsbGJhY2ssIHJlc3BvbnNlIHx8IFsganFYSFIucmVzcG9uc2VUZXh0LCBzdGF0dXMsIGpxWEhSIF0gKTsKCQkJfQoJCX0KCX0pLmRvbmUoZnVuY3Rpb24oIHJlc3BvbnNlVGV4dCApIHsKCgkJLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCgkJcmVzcG9uc2UgPSBhcmd1bWVudHM7CgoJCS8vIFNlZSBpZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQKCQlzZWxmLmh0bWwoIHNlbGVjdG9yID8KCgkJCS8vIENyZWF0ZSBhIGR1bW15IGRpdiB0byBob2xkIHRoZSByZXN1bHRzCgkJCWpRdWVyeSgiPGRpdj4iKQoKCQkJCS8vIGluamVjdCB0aGUgY29udGVudHMgb2YgdGhlIGRvY3VtZW50IGluLCByZW1vdmluZyB0aGUgc2NyaXB0cwoJCQkJLy8gdG8gYXZvaWQgYW55ICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzIGluIElFCgkJCQkuYXBwZW5kKCByZXNwb25zZVRleHQucmVwbGFjZSggcnNjcmlwdCwgIiIgKSApCgoJCQkJLy8gTG9jYXRlIHRoZSBzcGVjaWZpZWQgZWxlbWVudHMKCQkJCS5maW5kKCBzZWxlY3RvciApIDoKCgkJCS8vIElmIG5vdCwganVzdCBpbmplY3QgdGhlIGZ1bGwgcmVzdWx0CgkJCXJlc3BvbnNlVGV4dCApOwoKCX0pOwoKCXJldHVybiB0aGlzOwp9OwoKLy8gQXR0YWNoIGEgYnVuY2ggb2YgZnVuY3Rpb25zIGZvciBoYW5kbGluZyBjb21tb24gQUpBWCBldmVudHMKalF1ZXJ5LmVhY2goICJhamF4U3RhcnQgYWpheFN0b3AgYWpheENvbXBsZXRlIGFqYXhFcnJvciBhamF4U3VjY2VzcyBhamF4U2VuZCIuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbyApewoJalF1ZXJ5LmZuWyBvIF0gPSBmdW5jdGlvbiggZiApewoJCXJldHVybiB0aGlzLm9uKCBvLCBmICk7Cgl9Owp9KTsKCmpRdWVyeS5lYWNoKCBbICJnZXQiLCAicG9zdCIgXSwgZnVuY3Rpb24oIGksIG1ldGhvZCApIHsKCWpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdHRlZAoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGRhdGEgKSApIHsKCQkJdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCXJldHVybiBqUXVlcnkuYWpheCh7CgkJCXR5cGU6IG1ldGhvZCwKCQkJdXJsOiB1cmwsCgkJCWRhdGE6IGRhdGEsCgkJCXN1Y2Nlc3M6IGNhbGxiYWNrLAoJCQlkYXRhVHlwZTogdHlwZQoJCX0pOwoJfTsKfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCglnZXRTY3JpcHQ6IGZ1bmN0aW9uKCB1cmwsIGNhbGxiYWNrICkgewoJCXJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICJzY3JpcHQiICk7Cgl9LAoKCWdldEpTT046IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIGNhbGxiYWNrICkgewoJCXJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIgKTsKCX0sCgoJLy8gQ3JlYXRlcyBhIGZ1bGwgZmxlZGdlZCBzZXR0aW5ncyBvYmplY3QgaW50byB0YXJnZXQKCS8vIHdpdGggYm90aCBhamF4U2V0dGluZ3MgYW5kIHNldHRpbmdzIGZpZWxkcy4KCS8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuCglhamF4U2V0dXA6IGZ1bmN0aW9uKCB0YXJnZXQsIHNldHRpbmdzICkgewoJCWlmICggc2V0dGluZ3MgKSB7CgkJCS8vIEJ1aWxkaW5nIGEgc2V0dGluZ3Mgb2JqZWN0CgkJCWFqYXhFeHRlbmQoIHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyApOwoJCX0gZWxzZSB7CgkJCS8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKCQkJc2V0dGluZ3MgPSB0YXJnZXQ7CgkJCXRhcmdldCA9IGpRdWVyeS5hamF4U2V0dGluZ3M7CgkJfQoJCWFqYXhFeHRlbmQoIHRhcmdldCwgc2V0dGluZ3MgKTsKCQlyZXR1cm4gdGFyZ2V0OwoJfSwKCglhamF4U2V0dGluZ3M6IHsKCQl1cmw6IGFqYXhMb2NhdGlvbiwKCQlpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBhamF4TG9jUGFydHNbIDEgXSApLAoJCWdsb2JhbDogdHJ1ZSwKCQl0eXBlOiAiR0VUIiwKCQljb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCIsCgkJcHJvY2Vzc0RhdGE6IHRydWUsCgkJYXN5bmM6IHRydWUsCgkJLyoKCQl0aW1lb3V0OiAwLAoJCWRhdGE6IG51bGwsCgkJZGF0YVR5cGU6IG51bGwsCgkJdXNlcm5hbWU6IG51bGwsCgkJcGFzc3dvcmQ6IG51bGwsCgkJY2FjaGU6IG51bGwsCgkJdGhyb3dzOiBmYWxzZSwKCQl0cmFkaXRpb25hbDogZmFsc2UsCgkJaGVhZGVyczoge30sCgkJKi8KCgkJYWNjZXB0czogewoJCQl4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKCQkJaHRtbDogInRleHQvaHRtbCIsCgkJCXRleHQ6ICJ0ZXh0L3BsYWluIiwKCQkJanNvbjogImFwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCIsCgkJCSIqIjogYWxsVHlwZXMKCQl9LAoKCQljb250ZW50czogewoJCQl4bWw6IC94bWwvLAoJCQlodG1sOiAvaHRtbC8sCgkJCWpzb246IC9qc29uLwoJCX0sCgoJCXJlc3BvbnNlRmllbGRzOiB7CgkJCXhtbDogInJlc3BvbnNlWE1MIiwKCQkJdGV4dDogInJlc3BvbnNlVGV4dCIKCQl9LAoKCQkvLyBMaXN0IG9mIGRhdGEgY29udmVydGVycwoJCS8vIDEpIGtleSBmb3JtYXQgaXMgInNvdXJjZV90eXBlIGRlc3RpbmF0aW9uX3R5cGUiIChhIHNpbmdsZSBzcGFjZSBpbi1iZXR3ZWVuKQoJCS8vIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkIGZvciBzb3VyY2VfdHlwZQoJCWNvbnZlcnRlcnM6IHsKCgkJCS8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAoJCQkiKiB0ZXh0Ijogd2luZG93LlN0cmluZywKCgkJCS8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQoJCQkidGV4dCBodG1sIjogdHJ1ZSwKCgkJCS8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KCQkJInRleHQganNvbiI6IGpRdWVyeS5wYXJzZUpTT04sCgoJCQkvLyBQYXJzZSB0ZXh0IGFzIHhtbAoJCQkidGV4dCB4bWwiOiBqUXVlcnkucGFyc2VYTUwKCQl9LAoKCQkvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgoJCS8vIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBvcHRpb25zIGhlcmUgaWYKCQkvLyBhbmQgd2hlbiB5b3UgY3JlYXRlIG9uZSB0aGF0IHNob3VsZG4ndCBiZQoJCS8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQoJCWZsYXRPcHRpb25zOiB7CgkJCWNvbnRleHQ6IHRydWUsCgkJCXVybDogdHJ1ZQoJCX0KCX0sCgoJYWpheFByZWZpbHRlcjogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBwcmVmaWx0ZXJzICksCglhamF4VHJhbnNwb3J0OiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMgKSwKCgkvLyBNYWluIG1ldGhvZAoJYWpheDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCgkJLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKCQlpZiAoIHR5cGVvZiB1cmwgPT09ICJvYmplY3QiICkgewoJCQlvcHRpb25zID0gdXJsOwoJCQl1cmwgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCQl2YXIgLy8gaWZNb2RpZmllZCBrZXkKCQkJaWZNb2RpZmllZEtleSwKCQkJLy8gUmVzcG9uc2UgaGVhZGVycwoJCQlyZXNwb25zZUhlYWRlcnNTdHJpbmcsCgkJCXJlc3BvbnNlSGVhZGVycywKCQkJLy8gdHJhbnNwb3J0CgkJCXRyYW5zcG9ydCwKCQkJLy8gdGltZW91dCBoYW5kbGUKCQkJdGltZW91dFRpbWVyLAoJCQkvLyBDcm9zcy1kb21haW4gZGV0ZWN0aW9uIHZhcnMKCQkJcGFydHMsCgkJCS8vIFRvIGtub3cgaWYgZ2xvYmFsIGV2ZW50cyBhcmUgdG8gYmUgZGlzcGF0Y2hlZAoJCQlmaXJlR2xvYmFscywKCQkJLy8gTG9vcCB2YXJpYWJsZQoJCQlpLAoJCQkvLyBDcmVhdGUgdGhlIGZpbmFsIG9wdGlvbnMgb2JqZWN0CgkJCXMgPSBqUXVlcnkuYWpheFNldHVwKCB7fSwgb3B0aW9ucyApLAoJCQkvLyBDYWxsYmFja3MgY29udGV4dAoJCQljYWxsYmFja0NvbnRleHQgPSBzLmNvbnRleHQgfHwgcywKCQkJLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cwoJCQkvLyBJdCdzIHRoZSBjYWxsYmFja0NvbnRleHQgaWYgb25lIHdhcyBwcm92aWRlZCBpbiB0aGUgb3B0aW9ucwoJCQkvLyBhbmQgaWYgaXQncyBhIERPTSBub2RlIG9yIGEgalF1ZXJ5IGNvbGxlY3Rpb24KCQkJZ2xvYmFsRXZlbnRDb250ZXh0ID0gY2FsbGJhY2tDb250ZXh0ICE9PSBzICYmCgkJCQkoIGNhbGxiYWNrQ29udGV4dC5ub2RlVHlwZSB8fCBjYWxsYmFja0NvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgKSA/CgkJCQkJCWpRdWVyeSggY2FsbGJhY2tDb250ZXh0ICkgOiBqUXVlcnkuZXZlbnQsCgkJCS8vIERlZmVycmVkcwoJCQlkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQljb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLAoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAoJCQkvLyBIZWFkZXJzICh0aGV5IGFyZSBzZW50IGFsbCBhdCBvbmNlKQoJCQlyZXF1ZXN0SGVhZGVycyA9IHt9LAoJCQlyZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sCgkJCS8vIFRoZSBqcVhIUiBzdGF0ZQoJCQlzdGF0ZSA9IDAsCgkJCS8vIERlZmF1bHQgYWJvcnQgbWVzc2FnZQoJCQlzdHJBYm9ydCA9ICJjYW5jZWxlZCIsCgkJCS8vIEZha2UgeGhyCgkJCWpxWEhSID0gewoKCQkJCXJlYWR5U3RhdGU6IDAsCgoJCQkJLy8gQ2FjaGVzIHRoZSBoZWFkZXIKCQkJCXNldFJlcXVlc3RIZWFkZXI6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQkJCQlpZiAoICFzdGF0ZSApIHsKCQkJCQkJdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCQkJCQluYW1lID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gfHwgbmFtZTsKCQkJCQkJcmVxdWVzdEhlYWRlcnNbIG5hbWUgXSA9IHZhbHVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgoJCQkJLy8gUmF3IHN0cmluZwoJCQkJZ2V0QWxsUmVzcG9uc2VIZWFkZXJzOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwoJCQkJfSwKCgkJCQkvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCgkJCQlnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oIGtleSApIHsKCQkJCQl2YXIgbWF0Y2g7CgkJCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCQkJaWYgKCAhcmVzcG9uc2VIZWFkZXJzICkgewoJCQkJCQkJcmVzcG9uc2VIZWFkZXJzID0ge307CgkJCQkJCQl3aGlsZSggKCBtYXRjaCA9IHJoZWFkZXJzLmV4ZWMoIHJlc3BvbnNlSGVhZGVyc1N0cmluZyApICkgKSB7CgkJCQkJCQkJcmVzcG9uc2VIZWFkZXJzWyBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpIF0gPSBtYXRjaFsgMiBdOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCW1hdGNoID0gcmVzcG9uc2VIZWFkZXJzWyBrZXkudG9Mb3dlckNhc2UoKSBdOwoJCQkJCX0KCQkJCQlyZXR1cm4gbWF0Y2ggPT09IHVuZGVmaW5lZCA/IG51bGwgOiBtYXRjaDsKCQkJCX0sCgoJCQkJLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXIKCQkJCW92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQlzLm1pbWVUeXBlID0gdHlwZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIENhbmNlbCB0aGUgcmVxdWVzdAoJCQkJYWJvcnQ6IGZ1bmN0aW9uKCBzdGF0dXNUZXh0ICkgewoJCQkJCXN0YXR1c1RleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwoJCQkJCWlmICggdHJhbnNwb3J0ICkgewoJCQkJCQl0cmFuc3BvcnQuYWJvcnQoIHN0YXR1c1RleHQgKTsKCQkJCQl9CgkJCQkJZG9uZSggMCwgc3RhdHVzVGV4dCApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9OwoKCQkvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKCQkvLyBJdCBpcyBkZWZpbmVkIGhlcmUgYmVjYXVzZSBqc2xpbnQgY29tcGxhaW5zIGlmIGl0IGlzIGRlY2xhcmVkCgkJLy8gYXQgdGhlIGVuZCBvZiB0aGUgZnVuY3Rpb24gKHdoaWNoIHdvdWxkIGJlIG1vcmUgbG9naWNhbCBhbmQgcmVhZGFibGUpCgkJZnVuY3Rpb24gZG9uZSggc3RhdHVzLCBuYXRpdmVTdGF0dXNUZXh0LCByZXNwb25zZXMsIGhlYWRlcnMgKSB7CgkJCXZhciBpc1N1Y2Nlc3MsIHN1Y2Nlc3MsIGVycm9yLCByZXNwb25zZSwgbW9kaWZpZWQsCgkJCQlzdGF0dXNUZXh0ID0gbmF0aXZlU3RhdHVzVGV4dDsKCgkJCS8vIENhbGxlZCBvbmNlCgkJCWlmICggc3RhdGUgPT09IDIgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFN0YXRlIGlzICJkb25lIiBub3cKCQkJc3RhdGUgPSAyOwoKCQkJLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMKCQkJaWYgKCB0aW1lb3V0VGltZXIgKSB7CgkJCQljbGVhclRpbWVvdXQoIHRpbWVvdXRUaW1lciApOwoJCQl9CgoJCQkvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbgoJCQkvLyAobm8gbWF0dGVyIGhvdyBsb25nIHRoZSBqcVhIUiBvYmplY3Qgd2lsbCBiZSB1c2VkKQoJCQl0cmFuc3BvcnQgPSB1bmRlZmluZWQ7CgoJCQkvLyBDYWNoZSByZXNwb25zZSBoZWFkZXJzCgkJCXJlc3BvbnNlSGVhZGVyc1N0cmluZyA9IGhlYWRlcnMgfHwgIiI7CgoJCQkvLyBTZXQgcmVhZHlTdGF0ZQoJCQlqcVhIUi5yZWFkeVN0YXRlID0gc3RhdHVzID4gMCA/IDQgOiAwOwoKCQkJLy8gR2V0IHJlc3BvbnNlIGRhdGEKCQkJaWYgKCByZXNwb25zZXMgKSB7CgkJCQlyZXNwb25zZSA9IGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKTsKCQkJfQoKCQkJLy8gSWYgc3VjY2Vzc2Z1bCwgaGFuZGxlIHR5cGUgY2hhaW5pbmcKCQkJaWYgKCBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNCApIHsKCgkJCQkvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgoJCQkJaWYgKCBzLmlmTW9kaWZpZWQgKSB7CgoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkxhc3QtTW9kaWZpZWQiKTsKCQkJCQlpZiAoIG1vZGlmaWVkICkgewoJCQkJCQlqUXVlcnkubGFzdE1vZGlmaWVkWyBpZk1vZGlmaWVkS2V5IF0gPSBtb2RpZmllZDsKCQkJCQl9CgkJCQkJbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiRXRhZyIpOwoJCQkJCWlmICggbW9kaWZpZWQgKSB7CgkJCQkJCWpRdWVyeS5ldGFnWyBpZk1vZGlmaWVkS2V5IF0gPSBtb2RpZmllZDsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gSWYgbm90IG1vZGlmaWVkCgkJCQlpZiAoIHN0YXR1cyA9PT0gMzA0ICkgewoKCQkJCQlzdGF0dXNUZXh0ID0gIm5vdG1vZGlmaWVkIjsKCQkJCQlpc1N1Y2Nlc3MgPSB0cnVlOwoKCQkJCS8vIElmIHdlIGhhdmUgZGF0YQoJCQkJfSBlbHNlIHsKCgkJCQkJaXNTdWNjZXNzID0gYWpheENvbnZlcnQoIHMsIHJlc3BvbnNlICk7CgkJCQkJc3RhdHVzVGV4dCA9IGlzU3VjY2Vzcy5zdGF0ZTsKCQkJCQlzdWNjZXNzID0gaXNTdWNjZXNzLmRhdGE7CgkJCQkJZXJyb3IgPSBpc1N1Y2Nlc3MuZXJyb3I7CgkJCQkJaXNTdWNjZXNzID0gIWVycm9yOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJLy8gV2UgZXh0cmFjdCBlcnJvciBmcm9tIHN0YXR1c1RleHQKCQkJCS8vIHRoZW4gbm9ybWFsaXplIHN0YXR1c1RleHQgYW5kIHN0YXR1cyBmb3Igbm9uLWFib3J0cwoJCQkJZXJyb3IgPSBzdGF0dXNUZXh0OwoJCQkJaWYgKCAhc3RhdHVzVGV4dCB8fCBzdGF0dXMgKSB7CgkJCQkJc3RhdHVzVGV4dCA9ICJlcnJvciI7CgkJCQkJaWYgKCBzdGF0dXMgPCAwICkgewoJCQkJCQlzdGF0dXMgPSAwOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKCQkJanFYSFIuc3RhdHVzID0gc3RhdHVzOwoJCQlqcVhIUi5zdGF0dXNUZXh0ID0gKCBuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQgKSArICIiOwoKCQkJLy8gU3VjY2Vzcy9FcnJvcgoJCQlpZiAoIGlzU3VjY2VzcyApIHsKCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsgc3VjY2Vzcywgc3RhdHVzVGV4dCwganFYSFIgXSApOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdICk7CgkJCX0KCgkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCWpxWEhSLnN0YXR1c0NvZGUoIHN0YXR1c0NvZGUgKTsKCQkJc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXgiICsgKCBpc1N1Y2Nlc3MgPyAiU3VjY2VzcyIgOiAiRXJyb3IiICksCgkJCQkJCVsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdICk7CgkJCX0KCgkJCS8vIENvbXBsZXRlCgkJCWNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCBdICk7CgoJCQlpZiAoIGZpcmVHbG9iYWxzICkgewoJCQkJZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoICJhamF4Q29tcGxldGUiLCBbIGpxWEhSLCBzIF0gKTsKCQkJCS8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgoJCQkJaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBBdHRhY2ggZGVmZXJyZWRzCgkJZGVmZXJyZWQucHJvbWlzZSgganFYSFIgKTsKCQlqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKCQlqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7CgkJanFYSFIuY29tcGxldGUgPSBjb21wbGV0ZURlZmVycmVkLmFkZDsKCgkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQlqcVhIUi5zdGF0dXNDb2RlID0gZnVuY3Rpb24oIG1hcCApIHsKCQkJaWYgKCBtYXAgKSB7CgkJCQl2YXIgdG1wOwoJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJZm9yICggdG1wIGluIG1hcCApIHsKCQkJCQkJc3RhdHVzQ29kZVsgdG1wIF0gPSBbIHN0YXR1c0NvZGVbdG1wXSwgbWFwW3RtcF0gXTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXRtcCA9IG1hcFsganFYSFIuc3RhdHVzIF07CgkJCQkJanFYSFIuYWx3YXlzKCB0bXAgKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9OwoKCQkvLyBSZW1vdmUgaGFzaCBjaGFyYWN0ZXIgKCM3NTMxOiBhbmQgc3RyaW5nIHByb21vdGlvbikKCQkvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkICgjNTg2NjogSUU3IGlzc3VlIHdpdGggcHJvdG9jb2wtbGVzcyB1cmxzKQoJCS8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQoJCXMudXJsID0gKCAoIHVybCB8fCBzLnVybCApICsgIiIgKS5yZXBsYWNlKCByaGFzaCwgIiIgKS5yZXBsYWNlKCBycHJvdG9jb2wsIGFqYXhMb2NQYXJ0c1sgMSBdICsgIi8vIiApOwoKCQkvLyBFeHRyYWN0IGRhdGFUeXBlcyBsaXN0CgkJcy5kYXRhVHlwZXMgPSBqUXVlcnkudHJpbSggcy5kYXRhVHlwZSB8fCAiKiIgKS50b0xvd2VyQ2FzZSgpLnNwbGl0KCBjb3JlX3JzcGFjZSApOwoKCQkvLyBBIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyIHdoZW4gd2UgaGF2ZSBhIHByb3RvY29sOmhvc3Q6cG9ydCBtaXNtYXRjaAoJCWlmICggcy5jcm9zc0RvbWFpbiA9PSBudWxsICkgewoJCQlwYXJ0cyA9IHJ1cmwuZXhlYyggcy51cmwudG9Mb3dlckNhc2UoKSApOwoJCQlzLmNyb3NzRG9tYWluID0gISEoIHBhcnRzICYmCgkJCQkoIHBhcnRzWyAxIF0gIT09IGFqYXhMb2NQYXJ0c1sgMSBdIHx8IHBhcnRzWyAyIF0gIT09IGFqYXhMb2NQYXJ0c1sgMiBdIHx8CgkJCQkJKCBwYXJ0c1sgMyBdIHx8ICggcGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSAhPQoJCQkJCQkoIGFqYXhMb2NQYXJ0c1sgMyBdIHx8ICggYWpheExvY1BhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgKQoJCQkpOwoJCX0KCgkJLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCgkJaWYgKCBzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcy5kYXRhID0galF1ZXJ5LnBhcmFtKCBzLmRhdGEsIHMudHJhZGl0aW9uYWwgKTsKCQl9CgoJCS8vIEFwcGx5IHByZWZpbHRlcnMKCQlpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQlyZXR1cm4ganFYSFI7CgkJfQoKCQkvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwoJCWZpcmVHbG9iYWxzID0gcy5nbG9iYWw7CgoJCS8vIFVwcGVyY2FzZSB0aGUgdHlwZQoJCXMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKCQkvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAoJCXMuaGFzQ29udGVudCA9ICFybm9Db250ZW50LnRlc3QoIHMudHlwZSApOwoKCQkvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCgkJaWYgKCBmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDAgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0YXJ0IiApOwoJCX0KCgkJLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKCQlpZiAoICFzLmhhc0NvbnRlbnQgKSB7CgoJCQkvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCgkJCWlmICggcy5kYXRhICkgewoJCQkJcy51cmwgKz0gKCBycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5kYXRhOwoJCQkJLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQoJCQkJZGVsZXRlIHMuZGF0YTsKCQkJfQoKCQkJLy8gR2V0IGlmTW9kaWZpZWRLZXkgYmVmb3JlIGFkZGluZyB0aGUgYW50aS1jYWNoZSBwYXJhbWV0ZXIKCQkJaWZNb2RpZmllZEtleSA9IHMudXJsOwoKCQkJLy8gQWRkIGFudGktY2FjaGUgaW4gdXJsIGlmIG5lZWRlZAoJCQlpZiAoIHMuY2FjaGUgPT09IGZhbHNlICkgewoKCQkJCXZhciB0cyA9IGpRdWVyeS5ub3coKSwKCQkJCQkvLyB0cnkgcmVwbGFjaW5nIF89IGlmIGl0IGlzIHRoZXJlCgkJCQkJcmV0ID0gcy51cmwucmVwbGFjZSggcnRzLCAiJDFfPSIgKyB0cyApOwoKCQkJCS8vIGlmIG5vdGhpbmcgd2FzIHJlcGxhY2VkLCBhZGQgdGltZXN0YW1wIHRvIHRoZSBlbmQKCQkJCXMudXJsID0gcmV0ICsgKCAoIHJldCA9PT0gcy51cmwgKSA/ICggcnF1ZXJ5LnRlc3QoIHMudXJsICkgPyAiJiIgOiAiPyIgKSArICJfPSIgKyB0cyA6ICIiICk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgY29ycmVjdCBoZWFkZXIsIGlmIGRhdGEgaXMgYmVpbmcgc2VudAoJCWlmICggcy5kYXRhICYmIHMuaGFzQ29udGVudCAmJiBzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSB8fCBvcHRpb25zLmNvbnRlbnRUeXBlICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSApOwoJCX0KCgkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJaWZNb2RpZmllZEtleSA9IGlmTW9kaWZpZWRLZXkgfHwgcy51cmw7CgkJCWlmICggalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdICk7CgkJCX0KCQkJaWYgKCBqUXVlcnkuZXRhZ1sgaWZNb2RpZmllZEtleSBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1sgaWZNb2RpZmllZEtleSBdICk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkiQWNjZXB0IiwKCQkJcy5kYXRhVHlwZXNbIDAgXSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gPwoJCQkJcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1swXSBdICsgKCBzLmRhdGFUeXBlc1sgMCBdICE9PSAiKiIgPyAiLCAiICsgYWxsVHlwZXMgKyAiOyBxPTAuMDEiIDogIiIgKSA6CgkJCQlzLmFjY2VwdHNbICIqIiBdCgkJKTsKCgkJLy8gQ2hlY2sgZm9yIGhlYWRlcnMgb3B0aW9uCgkJZm9yICggaSBpbiBzLmhlYWRlcnMgKSB7CgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIGksIHMuaGVhZGVyc1sgaSBdICk7CgkJfQoKCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CgkJaWYgKCBzLmJlZm9yZVNlbmQgJiYgKCBzLmJlZm9yZVNlbmQuY2FsbCggY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcyApID09PSBmYWxzZSB8fCBzdGF0ZSA9PT0gMiApICkgewoJCQkJLy8gQWJvcnQgaWYgbm90IGRvbmUgYWxyZWFkeSBhbmQgcmV0dXJuCgkJCQlyZXR1cm4ganFYSFIuYWJvcnQoKTsKCgkJfQoKCQkvLyBhYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24KCQlzdHJBYm9ydCA9ICJhYm9ydCI7CgoJCS8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcwoJCWZvciAoIGkgaW4geyBzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDEgfSApIHsKCQkJanFYSFJbIGkgXSggc1sgaSBdICk7CgkJfQoKCQkvLyBHZXQgdHJhbnNwb3J0CgkJdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgoJCS8vIElmIG5vIHRyYW5zcG9ydCwgd2UgYXV0by1hYm9ydAoJCWlmICggIXRyYW5zcG9ydCApIHsKCQkJZG9uZSggLTEsICJObyBUcmFuc3BvcnQiICk7CgkJfSBlbHNlIHsKCQkJanFYSFIucmVhZHlTdGF0ZSA9IDE7CgkJCS8vIFNlbmQgZ2xvYmFsIGV2ZW50CgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhTZW5kIiwgWyBqcVhIUiwgcyBdICk7CgkJCX0KCQkJLy8gVGltZW91dAoJCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJCXRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CgkJCQkJanFYSFIuYWJvcnQoICJ0aW1lb3V0IiApOwoJCQkJfSwgcy50aW1lb3V0ICk7CgkJCX0KCgkJCXRyeSB7CgkJCQlzdGF0ZSA9IDE7CgkJCQl0cmFuc3BvcnQuc2VuZCggcmVxdWVzdEhlYWRlcnMsIGRvbmUgKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQoJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJZG9uZSggLTEsIGUgKTsKCQkJCS8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyBlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4ganFYSFI7Cgl9LAoKCS8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwoJYWN0aXZlOiAwLAoKCS8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKCWxhc3RNb2RpZmllZDoge30sCglldGFnOiB7fQoKfSk7CgovKiBIYW5kbGVzIHJlc3BvbnNlcyB0byBhbiBhamF4IHJlcXVlc3Q6CiAqIC0gc2V0cyBhbGwgcmVzcG9uc2VYWFggZmllbGRzIGFjY29yZGluZ2x5CiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogKi8KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsKCgl2YXIgY3QsIHR5cGUsIGZpbmFsRGF0YVR5cGUsIGZpcnN0RGF0YVR5cGUsCgkJY29udGVudHMgPSBzLmNvbnRlbnRzLAoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLAoJCXJlc3BvbnNlRmllbGRzID0gcy5yZXNwb25zZUZpZWxkczsKCgkvLyBGaWxsIHJlc3BvbnNlWFhYIGZpZWxkcwoJZm9yICggdHlwZSBpbiByZXNwb25zZUZpZWxkcyApIHsKCQlpZiAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlqcVhIUlsgcmVzcG9uc2VGaWVsZHNbdHlwZV0gXSA9IHJlc3BvbnNlc1sgdHlwZSBdOwoJCX0KCX0KCgkvLyBSZW1vdmUgYXV0byBkYXRhVHlwZSBhbmQgZ2V0IGNvbnRlbnQtdHlwZSBpbiB0aGUgcHJvY2VzcwoJd2hpbGUoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJjb250ZW50LXR5cGUiICk7CgkJfQoJfQoKCS8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQoJaWYgKCBjdCApIHsKCQlmb3IgKCB0eXBlIGluIGNvbnRlbnRzICkgewoJCQlpZiAoIGNvbnRlbnRzWyB0eXBlIF0gJiYgY29udGVudHNbIHR5cGUgXS50ZXN0KCBjdCApICkgewoJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoKCS8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQoJaWYgKCBkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMgKSB7CgkJZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1sgMCBdOwoJfSBlbHNlIHsKCQkvLyBUcnkgY29udmVydGlibGUgZGF0YVR5cGVzCgkJZm9yICggdHlwZSBpbiByZXNwb25zZXMgKSB7CgkJCWlmICggIWRhdGFUeXBlc1sgMCBdIHx8IHMuY29udmVydGVyc1sgdHlwZSArICIgIiArIGRhdGFUeXBlc1swXSBdICkgewoJCQkJZmluYWxEYXRhVHlwZSA9IHR5cGU7CgkJCQlicmVhazsKCQkJfQoJCQlpZiAoICFmaXJzdERhdGFUeXBlICkgewoJCQkJZmlyc3REYXRhVHlwZSA9IHR5cGU7CgkJCX0KCQl9CgkJLy8gT3IganVzdCB1c2UgZmlyc3Qgb25lCgkJZmluYWxEYXRhVHlwZSA9IGZpbmFsRGF0YVR5cGUgfHwgZmlyc3REYXRhVHlwZTsKCX0KCgkvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCgkvLyBXZSBhZGQgdGhlIGRhdGFUeXBlIHRvIHRoZSBsaXN0IGlmIG5lZWRlZAoJLy8gYW5kIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQoJaWYgKCBmaW5hbERhdGFUeXBlICkgewoJCWlmICggZmluYWxEYXRhVHlwZSAhPT0gZGF0YVR5cGVzWyAwIF0gKSB7CgkJCWRhdGFUeXBlcy51bnNoaWZ0KCBmaW5hbERhdGFUeXBlICk7CgkJfQoJCXJldHVybiByZXNwb25zZXNbIGZpbmFsRGF0YVR5cGUgXTsKCX0KfQoKLy8gQ2hhaW4gY29udmVyc2lvbnMgZ2l2ZW4gdGhlIHJlcXVlc3QgYW5kIHRoZSBvcmlnaW5hbCByZXNwb25zZQpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UgKSB7CgoJdmFyIGNvbnYsIGNvbnYyLCBjdXJyZW50LCB0bXAsCgkJLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLnNsaWNlKCksCgkJcHJldiA9IGRhdGFUeXBlc1sgMCBdLAoJCWNvbnZlcnRlcnMgPSB7fSwKCQlpID0gMDsKCgkvLyBBcHBseSB0aGUgZGF0YUZpbHRlciBpZiBwcm92aWRlZAoJaWYgKCBzLmRhdGFGaWx0ZXIgKSB7CgkJcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIoIHJlc3BvbnNlLCBzLmRhdGFUeXBlICk7Cgl9CgoJLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCglpZiAoIGRhdGFUeXBlc1sgMSBdICkgewoJCWZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewoJCQljb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwoJCX0KCX0KCgkvLyBDb252ZXJ0IHRvIGVhY2ggc2VxdWVudGlhbCBkYXRhVHlwZSwgdG9sZXJhdGluZyBsaXN0IG1vZGlmaWNhdGlvbgoJZm9yICggOyAoY3VycmVudCA9IGRhdGFUeXBlc1srK2ldKTsgKSB7CgoJCS8vIFRoZXJlJ3Mgb25seSB3b3JrIHRvIGRvIGlmIGN1cnJlbnQgZGF0YVR5cGUgaXMgbm9uLWF1dG8KCQlpZiAoIGN1cnJlbnQgIT09ICIqIiApIHsKCgkJCS8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQKCQkJaWYgKCBwcmV2ICE9PSAiKiIgJiYgcHJldiAhPT0gY3VycmVudCApIHsKCgkJCQkvLyBTZWVrIGEgZGlyZWN0IGNvbnZlcnRlcgoJCQkJY29udiA9IGNvbnZlcnRlcnNbIHByZXYgKyAiICIgKyBjdXJyZW50IF0gfHwgY29udmVydGVyc1sgIiogIiArIGN1cnJlbnQgXTsKCgkJCQkvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcgoJCQkJaWYgKCAhY29udiApIHsKCQkJCQlmb3IgKCBjb252MiBpbiBjb252ZXJ0ZXJzICkgewoKCQkJCQkJLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CgkJCQkJCXRtcCA9IGNvbnYyLnNwbGl0KCIgIik7CgkJCQkJCWlmICggdG1wWyAxIF0gPT09IGN1cnJlbnQgKSB7CgoJCQkJCQkJLy8gSWYgcHJldiBjYW4gYmUgY29udmVydGVkIHRvIGFjY2VwdGVkIGlucHV0CgkJCQkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIHRtcFsgMCBdIF0gfHwKCQkJCQkJCQljb252ZXJ0ZXJzWyAiKiAiICsgdG1wWyAwIF0gXTsKCQkJCQkJCWlmICggY29udiApIHsKCQkJCQkJCQkvLyBDb25kZW5zZSBlcXVpdmFsZW5jZSBjb252ZXJ0ZXJzCgkJCQkJCQkJaWYgKCBjb252ID09PSB0cnVlICkgewoJCQkJCQkJCQljb252ID0gY29udmVydGVyc1sgY29udjIgXTsKCgkJCQkJCQkJLy8gT3RoZXJ3aXNlLCBpbnNlcnQgdGhlIGludGVybWVkaWF0ZSBkYXRhVHlwZQoJCQkJCQkJCX0gZWxzZSBpZiAoIGNvbnZlcnRlcnNbIGNvbnYyIF0gIT09IHRydWUgKSB7CgkJCQkJCQkJCWN1cnJlbnQgPSB0bXBbIDAgXTsKCQkJCQkJCQkJZGF0YVR5cGVzLnNwbGljZSggaS0tLCAwLCBjdXJyZW50ICk7CgkJCQkJCQkJfQoKCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzWyJ0aHJvd3MiXSApIHsKCQkJCQkJcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkJcmV0dXJuIHsgc3RhdGU6ICJwYXJzZXJlcnJvciIsIGVycm9yOiBjb252ID8gZSA6ICJObyBjb252ZXJzaW9uIGZyb20gIiArIHByZXYgKyAiIHRvICIgKyBjdXJyZW50IH07CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFVwZGF0ZSBwcmV2IGZvciBuZXh0IGl0ZXJhdGlvbgoJCQlwcmV2ID0gY3VycmVudDsKCQl9Cgl9CgoJcmV0dXJuIHsgc3RhdGU6ICJzdWNjZXNzIiwgZGF0YTogcmVzcG9uc2UgfTsKfQp2YXIgb2xkQ2FsbGJhY2tzID0gW10sCglycXVlc3Rpb24gPSAvXD8vLAoJcmpzb25wID0gLyg9KVw/KD89JnwkKXxcP1w/LywKCW5vbmNlID0galF1ZXJ5Lm5vdygpOwoKLy8gRGVmYXVsdCBqc29ucCBzZXR0aW5ncwpqUXVlcnkuYWpheFNldHVwKHsKCWpzb25wOiAiY2FsbGJhY2siLAoJanNvbnBDYWxsYmFjazogZnVuY3Rpb24oKSB7CgkJdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8ICggalF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIG5vbmNlKysgKSApOwoJCXRoaXNbIGNhbGxiYWNrIF0gPSB0cnVlOwoJCXJldHVybiBjYWxsYmFjazsKCX0KfSk7CgovLyBEZXRlY3QsIG5vcm1hbGl6ZSBvcHRpb25zIGFuZCBpbnN0YWxsIGNhbGxiYWNrcyBmb3IganNvbnAgcmVxdWVzdHMKalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoICJqc29uIGpzb25wIiwgZnVuY3Rpb24oIHMsIG9yaWdpbmFsU2V0dGluZ3MsIGpxWEhSICkgewoKCXZhciBjYWxsYmFja05hbWUsIG92ZXJ3cml0dGVuLCByZXNwb25zZUNvbnRhaW5lciwKCQlkYXRhID0gcy5kYXRhLAoJCXVybCA9IHMudXJsLAoJCWhhc0NhbGxiYWNrID0gcy5qc29ucCAhPT0gZmFsc2UsCgkJcmVwbGFjZUluVXJsID0gaGFzQ2FsbGJhY2sgJiYgcmpzb25wLnRlc3QoIHVybCApLAoJCXJlcGxhY2VJbkRhdGEgPSBoYXNDYWxsYmFjayAmJiAhcmVwbGFjZUluVXJsICYmIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiAmJgoJCQkhKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYKCQkJcmpzb25wLnRlc3QoIGRhdGEgKTsKCgkvLyBIYW5kbGUgaWZmIHRoZSBleHBlY3RlZCBkYXRhIHR5cGUgaXMgImpzb25wIiBvciB3ZSBoYXZlIGEgcGFyYW1ldGVyIHRvIHNldAoJaWYgKCBzLmRhdGFUeXBlc1sgMCBdID09PSAianNvbnAiIHx8IHJlcGxhY2VJblVybCB8fCByZXBsYWNlSW5EYXRhICkgewoKCQkvLyBHZXQgY2FsbGJhY2sgbmFtZSwgcmVtZW1iZXJpbmcgcHJlZXhpc3RpbmcgdmFsdWUgYXNzb2NpYXRlZCB3aXRoIGl0CgkJY2FsbGJhY2tOYW1lID0gcy5qc29ucENhbGxiYWNrID0galF1ZXJ5LmlzRnVuY3Rpb24oIHMuanNvbnBDYWxsYmFjayApID8KCQkJcy5qc29ucENhbGxiYWNrKCkgOgoJCQlzLmpzb25wQ2FsbGJhY2s7CgkJb3ZlcndyaXR0ZW4gPSB3aW5kb3dbIGNhbGxiYWNrTmFtZSBdOwoKCQkvLyBJbnNlcnQgY2FsbGJhY2sgaW50byB1cmwgb3IgZm9ybSBkYXRhCgkJaWYgKCByZXBsYWNlSW5VcmwgKSB7CgkJCXMudXJsID0gdXJsLnJlcGxhY2UoIHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSApOwoJCX0gZWxzZSBpZiAoIHJlcGxhY2VJbkRhdGEgKSB7CgkJCXMuZGF0YSA9IGRhdGEucmVwbGFjZSggcmpzb25wLCAiJDEiICsgY2FsbGJhY2tOYW1lICk7CgkJfSBlbHNlIGlmICggaGFzQ2FsbGJhY2sgKSB7CgkJCXMudXJsICs9ICggcnF1ZXN0aW9uLnRlc3QoIHVybCApID8gIiYiIDogIj8iICkgKyBzLmpzb25wICsgIj0iICsgY2FsbGJhY2tOYW1lOwoJCX0KCgkJLy8gVXNlIGRhdGEgY29udmVydGVyIHRvIHJldHJpZXZlIGpzb24gYWZ0ZXIgc2NyaXB0IGV4ZWN1dGlvbgoJCXMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKCQkJCWpRdWVyeS5lcnJvciggY2FsbGJhY2tOYW1lICsgIiB3YXMgbm90IGNhbGxlZCIgKTsKCQkJfQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsKCQl9OwoKCQkvLyBmb3JjZSBqc29uIGRhdGFUeXBlCgkJcy5kYXRhVHlwZXNbIDAgXSA9ICJqc29uIjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFjawoJCXdpbmRvd1sgY2FsbGJhY2tOYW1lIF0gPSBmdW5jdGlvbigpIHsKCQkJcmVzcG9uc2VDb250YWluZXIgPSBhcmd1bWVudHM7CgkJfTsKCgkJLy8gQ2xlYW4tdXAgZnVuY3Rpb24gKGZpcmVzIGFmdGVyIGNvbnZlcnRlcnMpCgkJanFYSFIuYWx3YXlzKGZ1bmN0aW9uKCkgewoJCQkvLyBSZXN0b3JlIHByZWV4aXN0aW5nIHZhbHVlCgkJCXdpbmRvd1sgY2FsbGJhY2tOYW1lIF0gPSBvdmVyd3JpdHRlbjsKCgkJCS8vIFNhdmUgYmFjayBhcyBmcmVlCgkJCWlmICggc1sgY2FsbGJhY2tOYW1lIF0gKSB7CgkJCQkvLyBtYWtlIHN1cmUgdGhhdCByZS11c2luZyB0aGUgb3B0aW9ucyBkb2Vzbid0IHNjcmV3IHRoaW5ncyBhcm91bmQKCQkJCXMuanNvbnBDYWxsYmFjayA9IG9yaWdpbmFsU2V0dGluZ3MuanNvbnBDYWxsYmFjazsKCgkJCQkvLyBzYXZlIHRoZSBjYWxsYmFjayBuYW1lIGZvciBmdXR1cmUgdXNlCgkJCQlvbGRDYWxsYmFja3MucHVzaCggY2FsbGJhY2tOYW1lICk7CgkJCX0KCgkJCS8vIENhbGwgaWYgaXQgd2FzIGEgZnVuY3Rpb24gYW5kIHdlIGhhdmUgYSByZXNwb25zZQoJCQlpZiAoIHJlc3BvbnNlQ29udGFpbmVyICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBvdmVyd3JpdHRlbiApICkgewoJCQkJb3ZlcndyaXR0ZW4oIHJlc3BvbnNlQ29udGFpbmVyWyAwIF0gKTsKCQkJfQoKCQkJcmVzcG9uc2VDb250YWluZXIgPSBvdmVyd3JpdHRlbiA9IHVuZGVmaW5lZDsKCQl9KTsKCgkJLy8gRGVsZWdhdGUgdG8gc2NyaXB0CgkJcmV0dXJuICJzY3JpcHQiOwoJfQp9KTsKLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUKalF1ZXJ5LmFqYXhTZXR1cCh7CglhY2NlcHRzOiB7CgkJc2NyaXB0OiAidGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCgl9LAoJY29udGVudHM6IHsKCQlzY3JpcHQ6IC9qYXZhc2NyaXB0fGVjbWFzY3JpcHQvCgl9LAoJY29udmVydGVyczogewoJCSJ0ZXh0IHNjcmlwdCI6IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlqUXVlcnkuZ2xvYmFsRXZhbCggdGV4dCApOwoJCQlyZXR1cm4gdGV4dDsKCQl9Cgl9Cn0pOwoKLy8gSGFuZGxlIGNhY2hlJ3Mgc3BlY2lhbCBjYXNlIGFuZCBnbG9iYWwKalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoICJzY3JpcHQiLCBmdW5jdGlvbiggcyApIHsKCWlmICggcy5jYWNoZSA9PT0gdW5kZWZpbmVkICkgewoJCXMuY2FjaGUgPSBmYWxzZTsKCX0KCWlmICggcy5jcm9zc0RvbWFpbiApIHsKCQlzLnR5cGUgPSAiR0VUIjsKCQlzLmdsb2JhbCA9IGZhbHNlOwoJfQp9KTsKCi8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydApqUXVlcnkuYWpheFRyYW5zcG9ydCggInNjcmlwdCIsIGZ1bmN0aW9uKHMpIHsKCgkvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgoJCXZhciBzY3JpcHQsCgkJCWhlYWQgPSBkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiaGVhZCIgKVswXSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCXJldHVybiB7CgoJCQlzZW5kOiBmdW5jdGlvbiggXywgY2FsbGJhY2sgKSB7CgoJCQkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNjcmlwdCIgKTsKCgkJCQlzY3JpcHQuYXN5bmMgPSAiYXN5bmMiOwoKCQkJCWlmICggcy5zY3JpcHRDaGFyc2V0ICkgewoJCQkJCXNjcmlwdC5jaGFyc2V0ID0gcy5zY3JpcHRDaGFyc2V0OwoJCQkJfQoKCQkJCXNjcmlwdC5zcmMgPSBzLnVybDsKCgkJCQkvLyBBdHRhY2ggaGFuZGxlcnMgZm9yIGFsbCBicm93c2VycwoJCQkJc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiggXywgaXNBYm9ydCApIHsKCgkJCQkJaWYgKCBpc0Fib3J0IHx8ICFzY3JpcHQucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KCBzY3JpcHQucmVhZHlTdGF0ZSApICkgewoKCQkJCQkJLy8gSGFuZGxlIG1lbW9yeSBsZWFrIGluIElFCgkJCQkJCXNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKCgkJCQkJCS8vIFJlbW92ZSB0aGUgc2NyaXB0CgkJCQkJCWlmICggaGVhZCAmJiBzY3JpcHQucGFyZW50Tm9kZSApIHsKCQkJCQkJCWhlYWQucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCQkJCQl9CgoJCQkJCQkvLyBEZXJlZmVyZW5jZSB0aGUgc2NyaXB0CgkJCQkJCXNjcmlwdCA9IHVuZGVmaW5lZDsKCgkJCQkJCS8vIENhbGxiYWNrIGlmIG5vdCBhYm9ydAoJCQkJCQlpZiAoICFpc0Fib3J0ICkgewoJCQkJCQkJY2FsbGJhY2soIDIwMCwgInN1Y2Nlc3MiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9OwoJCQkJLy8gVXNlIGluc2VydEJlZm9yZSBpbnN0ZWFkIG9mIGFwcGVuZENoaWxkICB0byBjaXJjdW12ZW50IGFuIElFNiBidWcuCgkJCQkvLyBUaGlzIGFyaXNlcyB3aGVuIGEgYmFzZSBub2RlIGlzIHVzZWQgKCMyNzA5IGFuZCAjNDM3OCkuCgkJCQloZWFkLmluc2VydEJlZm9yZSggc2NyaXB0LCBoZWFkLmZpcnN0Q2hpbGQgKTsKCQkJfSwKCgkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCWlmICggc2NyaXB0ICkgewoJCQkJCXNjcmlwdC5vbmxvYWQoIDAsIDEgKTsKCQkJCX0KCQkJfQoJCX07Cgl9Cn0pOwp2YXIgeGhyQ2FsbGJhY2tzLAoJLy8gIzUyODA6IEludGVybmV0IEV4cGxvcmVyIHdpbGwga2VlcCBjb25uZWN0aW9ucyBhbGl2ZSBpZiB3ZSBkb24ndCBhYm9ydCBvbiB1bmxvYWQKCXhock9uVW5sb2FkQWJvcnQgPSB3aW5kb3cuQWN0aXZlWE9iamVjdCA/IGZ1bmN0aW9uKCkgewoJCS8vIEFib3J0IGFsbCBwZW5kaW5nIHJlcXVlc3RzCgkJZm9yICggdmFyIGtleSBpbiB4aHJDYWxsYmFja3MgKSB7CgkJCXhockNhbGxiYWNrc1sga2V5IF0oIDAsIDEgKTsKCQl9Cgl9IDogZmFsc2UsCgl4aHJJZCA9IDA7CgovLyBGdW5jdGlvbnMgdG8gY3JlYXRlIHhocnMKZnVuY3Rpb24gY3JlYXRlU3RhbmRhcmRYSFIoKSB7Cgl0cnkgewoJCXJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7Cgl9IGNhdGNoKCBlICkge30KfQoKZnVuY3Rpb24gY3JlYXRlQWN0aXZlWEhSKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCAiTWljcm9zb2Z0LlhNTEhUVFAiICk7Cgl9IGNhdGNoKCBlICkge30KfQoKLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdAovLyAoVGhpcyBpcyBzdGlsbCBhdHRhY2hlZCB0byBhamF4U2V0dGluZ3MgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpCmpRdWVyeS5hamF4U2V0dGluZ3MueGhyID0gd2luZG93LkFjdGl2ZVhPYmplY3QgPwoJLyogTWljcm9zb2Z0IGZhaWxlZCB0byBwcm9wZXJseQoJICogaW1wbGVtZW50IHRoZSBYTUxIdHRwUmVxdWVzdCBpbiBJRTcgKGNhbid0IHJlcXVlc3QgbG9jYWwgZmlsZXMpLAoJICogc28gd2UgdXNlIHRoZSBBY3RpdmVYT2JqZWN0IHdoZW4gaXQgaXMgYXZhaWxhYmxlCgkgKiBBZGRpdGlvbmFsbHkgWE1MSHR0cFJlcXVlc3QgY2FuIGJlIGRpc2FibGVkIGluIElFNy9JRTggc28KCSAqIHdlIG5lZWQgYSBmYWxsYmFjay4KCSAqLwoJZnVuY3Rpb24oKSB7CgkJcmV0dXJuICF0aGlzLmlzTG9jYWwgJiYgY3JlYXRlU3RhbmRhcmRYSFIoKSB8fCBjcmVhdGVBY3RpdmVYSFIoKTsKCX0gOgoJLy8gRm9yIGFsbCBvdGhlciBicm93c2VycywgdXNlIHRoZSBzdGFuZGFyZCBYTUxIdHRwUmVxdWVzdCBvYmplY3QKCWNyZWF0ZVN0YW5kYXJkWEhSOwoKLy8gRGV0ZXJtaW5lIHN1cHBvcnQgcHJvcGVydGllcwooZnVuY3Rpb24oIHhociApIHsKCWpRdWVyeS5leHRlbmQoIGpRdWVyeS5zdXBwb3J0LCB7CgkJYWpheDogISF4aHIsCgkJY29yczogISF4aHIgJiYgKCAid2l0aENyZWRlbnRpYWxzIiBpbiB4aHIgKQoJfSk7Cn0pKCBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpICk7CgovLyBDcmVhdGUgdHJhbnNwb3J0IGlmIHRoZSBicm93c2VyIGNhbiBwcm92aWRlIGFuIHhocgppZiAoIGpRdWVyeS5zdXBwb3J0LmFqYXggKSB7CgoJalF1ZXJ5LmFqYXhUcmFuc3BvcnQoZnVuY3Rpb24oIHMgKSB7CgkJLy8gQ3Jvc3MgZG9tYWluIG9ubHkgYWxsb3dlZCBpZiBzdXBwb3J0ZWQgdGhyb3VnaCBYTUxIdHRwUmVxdWVzdAoJCWlmICggIXMuY3Jvc3NEb21haW4gfHwgalF1ZXJ5LnN1cHBvcnQuY29ycyApIHsKCgkJCXZhciBjYWxsYmFjazsKCgkJCXJldHVybiB7CgkJCQlzZW5kOiBmdW5jdGlvbiggaGVhZGVycywgY29tcGxldGUgKSB7CgoJCQkJCS8vIEdldCBhIG5ldyB4aHIKCQkJCQl2YXIgaGFuZGxlLCBpLAoJCQkJCQl4aHIgPSBzLnhocigpOwoKCQkJCQkvLyBPcGVuIHRoZSBzb2NrZXQKCQkJCQkvLyBQYXNzaW5nIG51bGwgdXNlcm5hbWUsIGdlbmVyYXRlcyBhIGxvZ2luIHBvcHVwIG9uIE9wZXJhICgjMjg2NSkKCQkJCQlpZiAoIHMudXNlcm5hbWUgKSB7CgkJCQkJCXhoci5vcGVuKCBzLnR5cGUsIHMudXJsLCBzLmFzeW5jLCBzLnVzZXJuYW1lLCBzLnBhc3N3b3JkICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJeGhyLm9wZW4oIHMudHlwZSwgcy51cmwsIHMuYXN5bmMgKTsKCQkJCQl9CgoJCQkJCS8vIEFwcGx5IGN1c3RvbSBmaWVsZHMgaWYgcHJvdmlkZWQKCQkJCQlpZiAoIHMueGhyRmllbGRzICkgewoJCQkJCQlmb3IgKCBpIGluIHMueGhyRmllbGRzICkgewoJCQkJCQkJeGhyWyBpIF0gPSBzLnhockZpZWxkc1sgaSBdOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCgkJCQkJaWYgKCBzLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlICkgewoJCQkJCQl4aHIub3ZlcnJpZGVNaW1lVHlwZSggcy5taW1lVHlwZSApOwoJCQkJCX0KCgkJCQkJLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKCQkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCgkJCQkJLy8gYWtpbiB0byBhIGppZ3NhdyBwdXp6bGUsIHdlIHNpbXBseSBuZXZlciBzZXQgaXQgdG8gYmUgc3VyZS4KCQkJCQkvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKCQkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KCQkJCQlpZiAoICFzLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0gKSB7CgkJCQkJCWhlYWRlcnNbICJYLVJlcXVlc3RlZC1XaXRoIiBdID0gIlhNTEh0dHBSZXF1ZXN0IjsKCQkJCQl9CgoJCQkJCS8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCgkJCQkJdHJ5IHsKCQkJCQkJZm9yICggaSBpbiBoZWFkZXJzICkgewoJCQkJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIGksIGhlYWRlcnNbIGkgXSApOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCggXyApIHt9CgoJCQkJCS8vIERvIHNlbmQgdGhlIHJlcXVlc3QKCQkJCQkvLyBUaGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24gd2hpY2ggaXMgYWN0dWFsbHkKCQkJCQkvLyBoYW5kbGVkIGluIGpRdWVyeS5hamF4IChzbyBubyB0cnkvY2F0Y2ggaGVyZSkKCQkJCQl4aHIuc2VuZCggKCBzLmhhc0NvbnRlbnQgJiYgcy5kYXRhICkgfHwgbnVsbCApOwoKCQkJCQkvLyBMaXN0ZW5lcgoJCQkJCWNhbGxiYWNrID0gZnVuY3Rpb24oIF8sIGlzQWJvcnQgKSB7CgoJCQkJCQl2YXIgc3RhdHVzLAoJCQkJCQkJc3RhdHVzVGV4dCwKCQkJCQkJCXJlc3BvbnNlSGVhZGVycywKCQkJCQkJCXJlc3BvbnNlcywKCQkJCQkJCXhtbDsKCgkJCQkJCS8vIEZpcmVmb3ggdGhyb3dzIGV4Y2VwdGlvbnMgd2hlbiBhY2Nlc3NpbmcgcHJvcGVydGllcwoJCQkJCQkvLyBvZiBhbiB4aHIgd2hlbiBhIG5ldHdvcmsgZXJyb3Igb2NjdXJyZWQKCQkJCQkJLy8gaHR0cDovL2hlbHBmdWwua25vYnMtZGlhbHMuY29tL2luZGV4LnBocC9Db21wb25lbnRfcmV0dXJuZWRfZmFpbHVyZV9jb2RlOl8weDgwMDQwMTExXyhOU19FUlJPUl9OT1RfQVZBSUxBQkxFKQoJCQkJCQl0cnkgewoKCQkJCQkJCS8vIFdhcyBuZXZlciBjYWxsZWQgYW5kIGlzIGFib3J0ZWQgb3IgY29tcGxldGUKCQkJCQkJCWlmICggY2FsbGJhY2sgJiYgKCBpc0Fib3J0IHx8IHhoci5yZWFkeVN0YXRlID09PSA0ICkgKSB7CgoJCQkJCQkJCS8vIE9ubHkgY2FsbGVkIG9uY2UKCQkJCQkJCQljYWxsYmFjayA9IHVuZGVmaW5lZDsKCgkJCQkJCQkJLy8gRG8gbm90IGtlZXAgYXMgYWN0aXZlIGFueW1vcmUKCQkJCQkJCQlpZiAoIGhhbmRsZSApIHsKCQkJCQkJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwoJCQkJCQkJCQlpZiAoIHhock9uVW5sb2FkQWJvcnQgKSB7CgkJCQkJCQkJCQlkZWxldGUgeGhyQ2FsbGJhY2tzWyBoYW5kbGUgXTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0KCgkJCQkJCQkJLy8gSWYgaXQncyBhbiBhYm9ydAoJCQkJCQkJCWlmICggaXNBYm9ydCApIHsKCQkJCQkJCQkJLy8gQWJvcnQgaXQgbWFudWFsbHkgaWYgbmVlZGVkCgkJCQkJCQkJCWlmICggeGhyLnJlYWR5U3RhdGUgIT09IDQgKSB7CgkJCQkJCQkJCQl4aHIuYWJvcnQoKTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXN0YXR1cyA9IHhoci5zdGF0dXM7CgkJCQkJCQkJCXJlc3BvbnNlSGVhZGVycyA9IHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKCQkJCQkJCQkJcmVzcG9uc2VzID0ge307CgkJCQkJCQkJCXhtbCA9IHhoci5yZXNwb25zZVhNTDsKCgkJCQkJCQkJCS8vIENvbnN0cnVjdCByZXNwb25zZSBsaXN0CgkJCQkJCQkJCWlmICggeG1sICYmIHhtbC5kb2N1bWVudEVsZW1lbnQgLyogIzQ5NTggKi8gKSB7CgkJCQkJCQkJCQlyZXNwb25zZXMueG1sID0geG1sOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQkvLyBXaGVuIHJlcXVlc3RpbmcgYmluYXJ5IGRhdGEsIElFNi05IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uCgkJCQkJCQkJCS8vIG9uIGFueSBhdHRlbXB0IHRvIGFjY2VzcyByZXNwb25zZVRleHQgKCMxMTQyNikKCQkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJCXJlc3BvbnNlcy50ZXh0ID0geGhyLnJlc3BvbnNlVGV4dDsKCQkJCQkJCQkJfSBjYXRjaCggZSApIHsKCQkJCQkJCQkJfQoKCQkJCQkJCQkJLy8gRmlyZWZveCB0aHJvd3MgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nCgkJCQkJCQkJCS8vIHN0YXR1c1RleHQgZm9yIGZhdWx0eSBjcm9zcy1kb21haW4gcmVxdWVzdHMKCQkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJCXN0YXR1c1RleHQgPSB4aHIuc3RhdHVzVGV4dDsKCQkJCQkJCQkJfSBjYXRjaCggZSApIHsKCQkJCQkJCQkJCS8vIFdlIG5vcm1hbGl6ZSB3aXRoIFdlYmtpdCBnaXZpbmcgYW4gZW1wdHkgc3RhdHVzVGV4dAoJCQkJCQkJCQkJc3RhdHVzVGV4dCA9ICIiOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQkvLyBGaWx0ZXIgc3RhdHVzIGZvciBub24gc3RhbmRhcmQgYmVoYXZpb3JzCgoJCQkJCQkJCQkvLyBJZiB0aGUgcmVxdWVzdCBpcyBsb2NhbCBhbmQgd2UgaGF2ZSBkYXRhOiBhc3N1bWUgYSBzdWNjZXNzCgkJCQkJCQkJCS8vIChzdWNjZXNzIHdpdGggbm8gZGF0YSB3b24ndCBnZXQgbm90aWZpZWQsIHRoYXQncyB0aGUgYmVzdCB3ZQoJCQkJCQkJCQkvLyBjYW4gZG8gZ2l2ZW4gY3VycmVudCBpbXBsZW1lbnRhdGlvbnMpCgkJCQkJCQkJCWlmICggIXN0YXR1cyAmJiBzLmlzTG9jYWwgJiYgIXMuY3Jvc3NEb21haW4gKSB7CgkJCQkJCQkJCQlzdGF0dXMgPSByZXNwb25zZXMudGV4dCA/IDIwMCA6IDQwNDsKCQkJCQkJCQkJLy8gSUUgLSAjMTQ1MDogc29tZXRpbWVzIHJldHVybnMgMTIyMyB3aGVuIGl0IHNob3VsZCBiZSAyMDQKCQkJCQkJCQkJfSBlbHNlIGlmICggc3RhdHVzID09PSAxMjIzICkgewoJCQkJCQkJCQkJc3RhdHVzID0gMjA0OwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9IGNhdGNoKCBmaXJlZm94QWNjZXNzRXhjZXB0aW9uICkgewoJCQkJCQkJaWYgKCAhaXNBYm9ydCApIHsKCQkJCQkJCQljb21wbGV0ZSggLTEsIGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24gKTsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJLy8gQ2FsbCBjb21wbGV0ZSBpZiBuZWVkZWQKCQkJCQkJaWYgKCByZXNwb25zZXMgKSB7CgkJCQkJCQljb21wbGV0ZSggc3RhdHVzLCBzdGF0dXNUZXh0LCByZXNwb25zZXMsIHJlc3BvbnNlSGVhZGVycyApOwoJCQkJCQl9CgkJCQkJfTsKCgkJCQkJaWYgKCAhcy5hc3luYyApIHsKCQkJCQkJLy8gaWYgd2UncmUgaW4gc3luYyBtb2RlIHdlIGZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCWNhbGxiYWNrKCk7CgkJCQkJfSBlbHNlIGlmICggeGhyLnJlYWR5U3RhdGUgPT09IDQgKSB7CgkJCQkJCS8vIChJRTYgJiBJRTcpIGlmIGl0J3MgaW4gY2FjaGUgYW5kIGhhcyBiZWVuCgkJCQkJCS8vIHJldHJpZXZlZCBkaXJlY3RseSB3ZSBuZWVkIHRvIGZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJaGFuZGxlID0gKyt4aHJJZDsKCQkJCQkJaWYgKCB4aHJPblVubG9hZEFib3J0ICkgewoJCQkJCQkJLy8gQ3JlYXRlIHRoZSBhY3RpdmUgeGhycyBjYWxsYmFja3MgbGlzdCBpZiBuZWVkZWQKCQkJCQkJCS8vIGFuZCBhdHRhY2ggdGhlIHVubG9hZCBoYW5kbGVyCgkJCQkJCQlpZiAoICF4aHJDYWxsYmFja3MgKSB7CgkJCQkJCQkJeGhyQ2FsbGJhY2tzID0ge307CgkJCQkJCQkJalF1ZXJ5KCB3aW5kb3cgKS51bmxvYWQoIHhock9uVW5sb2FkQWJvcnQgKTsKCQkJCQkJCX0KCQkJCQkJCS8vIEFkZCB0byBsaXN0IG9mIGFjdGl2ZSB4aHJzIGNhbGxiYWNrcwoJCQkJCQkJeGhyQ2FsbGJhY2tzWyBoYW5kbGUgXSA9IGNhbGxiYWNrOwoJCQkJCQl9CgkJCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBjYWxsYmFjazsKCQkJCQl9CgkJCQl9LAoKCQkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCQljYWxsYmFjaygwLDEpOwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9Cgl9KTsKfQp2YXIgZnhOb3csIHRpbWVySWQsCglyZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywKCXJmeG51bSA9IG5ldyBSZWdFeHAoICJeKD86KFstK10pPXwpKCIgKyBjb3JlX3BudW0gKyAiKShbYS16JV0qKSQiLCAiaSIgKSwKCXJydW4gPSAvcXVldWVIb29rcyQvLAoJYW5pbWF0aW9uUHJlZmlsdGVycyA9IFsgZGVmYXVsdFByZWZpbHRlciBdLAoJdHdlZW5lcnMgPSB7CgkJIioiOiBbZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCQl2YXIgZW5kLCB1bml0LAoJCQkJdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKCBwcm9wLCB2YWx1ZSApLAoJCQkJcGFydHMgPSByZnhudW0uZXhlYyggdmFsdWUgKSwKCQkJCXRhcmdldCA9IHR3ZWVuLmN1cigpLAoJCQkJc3RhcnQgPSArdGFyZ2V0IHx8IDAsCgkJCQlzY2FsZSA9IDEsCgkJCQltYXhJdGVyYXRpb25zID0gMjA7CgoJCQlpZiAoIHBhcnRzICkgewoJCQkJZW5kID0gK3BhcnRzWzJdOwoJCQkJdW5pdCA9IHBhcnRzWzNdIHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICk7CgoJCQkJLy8gV2UgbmVlZCB0byBjb21wdXRlIHN0YXJ0aW5nIHZhbHVlCgkJCQlpZiAoIHVuaXQgIT09ICJweCIgJiYgc3RhcnQgKSB7CgkJCQkJLy8gSXRlcmF0aXZlbHkgYXBwcm94aW1hdGUgZnJvbSBhIG5vbnplcm8gc3RhcnRpbmcgcG9pbnQKCQkJCQkvLyBQcmVmZXIgdGhlIGN1cnJlbnQgcHJvcGVydHksIGJlY2F1c2UgdGhpcyBwcm9jZXNzIHdpbGwgYmUgdHJpdmlhbCBpZiBpdCB1c2VzIHRoZSBzYW1lIHVuaXRzCgkJCQkJLy8gRmFsbGJhY2sgdG8gZW5kIG9yIGEgc2ltcGxlIGNvbnN0YW50CgkJCQkJc3RhcnQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCBwcm9wLCB0cnVlICkgfHwgZW5kIHx8IDE7CgoJCQkJCWRvIHsKCQkJCQkJLy8gSWYgcHJldmlvdXMgaXRlcmF0aW9uIHplcm9lZCBvdXQsIGRvdWJsZSB1bnRpbCB3ZSBnZXQgKnNvbWV0aGluZyoKCQkJCQkJLy8gVXNlIGEgc3RyaW5nIGZvciBkb3VibGluZyBmYWN0b3Igc28gd2UgZG9uJ3QgYWNjaWRlbnRhbGx5IHNlZSBzY2FsZSBhcyB1bmNoYW5nZWQgYmVsb3cKCQkJCQkJc2NhbGUgPSBzY2FsZSB8fCAiLjUiOwoKCQkJCQkJLy8gQWRqdXN0IGFuZCBhcHBseQoJCQkJCQlzdGFydCA9IHN0YXJ0IC8gc2NhbGU7CgkJCQkJCWpRdWVyeS5zdHlsZSggdHdlZW4uZWxlbSwgcHJvcCwgc3RhcnQgKyB1bml0ICk7CgoJCQkJCS8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvIG9yIE5hTiBmcm9tIHR3ZWVuLmN1cigpCgkJCQkJLy8gQW5kIGJyZWFraW5nIHRoZSBsb29wIGlmIHNjYWxlIGlzIHVuY2hhbmdlZCBvciBwZXJmZWN0LCBvciBpZiB3ZSd2ZSBqdXN0IGhhZCBlbm91Z2gKCQkJCQl9IHdoaWxlICggc2NhbGUgIT09IChzY2FsZSA9IHR3ZWVuLmN1cigpIC8gdGFyZ2V0KSAmJiBzY2FsZSAhPT0gMSAmJiAtLW1heEl0ZXJhdGlvbnMgKTsKCQkJCX0KCgkJCQl0d2Vlbi51bml0ID0gdW5pdDsKCQkJCXR3ZWVuLnN0YXJ0ID0gc3RhcnQ7CgkJCQkvLyBJZiBhICs9Ly09IHRva2VuIHdhcyBwcm92aWRlZCwgd2UncmUgZG9pbmcgYSByZWxhdGl2ZSBhbmltYXRpb24KCQkJCXR3ZWVuLmVuZCA9IHBhcnRzWzFdID8gc3RhcnQgKyAoIHBhcnRzWzFdICsgMSApICogZW5kIDogZW5kOwoJCQl9CgkJCXJldHVybiB0d2VlbjsKCQl9XQoJfTsKCi8vIEFuaW1hdGlvbnMgY3JlYXRlZCBzeW5jaHJvbm91c2x5IHdpbGwgcnVuIHN5bmNocm9ub3VzbHkKZnVuY3Rpb24gY3JlYXRlRnhOb3coKSB7CglzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCWZ4Tm93ID0gdW5kZWZpbmVkOwoJfSwgMCApOwoJcmV0dXJuICggZnhOb3cgPSBqUXVlcnkubm93KCkgKTsKfQoKZnVuY3Rpb24gY3JlYXRlVHdlZW5zKCBhbmltYXRpb24sIHByb3BzICkgewoJalF1ZXJ5LmVhY2goIHByb3BzLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJdmFyIGNvbGxlY3Rpb24gPSAoIHR3ZWVuZXJzWyBwcm9wIF0gfHwgW10gKS5jb25jYXQoIHR3ZWVuZXJzWyAiKiIgXSApLAoJCQlpbmRleCA9IDAsCgkJCWxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoJCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJCWlmICggY29sbGVjdGlvblsgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIHByb3AsIHZhbHVlICkgKSB7CgoJCQkJLy8gd2UncmUgZG9uZSB3aXRoIHRoaXMgcHJvcGVydHkKCQkJCXJldHVybjsKCQkJfQoJCX0KCX0pOwp9CgpmdW5jdGlvbiBBbmltYXRpb24oIGVsZW0sIHByb3BlcnRpZXMsIG9wdGlvbnMgKSB7Cgl2YXIgcmVzdWx0LAoJCWluZGV4ID0gMCwKCQl0d2VlbmVySW5kZXggPSAwLAoJCWxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLAoJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKCBmdW5jdGlvbigpIHsKCQkJLy8gZG9uJ3QgbWF0Y2ggZWxlbSBpbiB0aGUgOmFuaW1hdGVkIHNlbGVjdG9yCgkJCWRlbGV0ZSB0aWNrLmVsZW07CgkJfSksCgkJdGljayA9IGZ1bmN0aW9uKCkgewoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQkJcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAoJCQkJLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykKCQkJCXRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKCQkJCXBlcmNlbnQgPSAxIC0gdGVtcCwKCQkJCWluZGV4ID0gMCwKCQkJCWxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwoKCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggcGVyY2VudCApOwoJCQl9CgoJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgcGVyY2VudCwgcmVtYWluaW5nIF0pOwoKCQkJaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7CgkJCQlyZXR1cm4gcmVtYWluaW5nOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uIF0gKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgkJYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CgkJCWVsZW06IGVsZW0sCgkJCXByb3BzOiBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcGVydGllcyApLAoJCQlvcHRzOiBqUXVlcnkuZXh0ZW5kKCB0cnVlLCB7IHNwZWNpYWxFYXNpbmc6IHt9IH0sIG9wdGlvbnMgKSwKCQkJb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAoJCQlvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCgkJCXN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJCXR3ZWVuczogW10sCgkJCWNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiggcHJvcCwgZW5kLCBlYXNpbmcgKSB7CgkJCQl2YXIgdHdlZW4gPSBqUXVlcnkuVHdlZW4oIGVsZW0sIGFuaW1hdGlvbi5vcHRzLCBwcm9wLCBlbmQsCgkJCQkJCWFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmdbIHByb3AgXSB8fCBhbmltYXRpb24ub3B0cy5lYXNpbmcgKTsKCQkJCWFuaW1hdGlvbi50d2VlbnMucHVzaCggdHdlZW4gKTsKCQkJCXJldHVybiB0d2VlbjsKCQkJfSwKCQkJc3RvcDogZnVuY3Rpb24oIGdvdG9FbmQgKSB7CgkJCQl2YXIgaW5kZXggPSAwLAoJCQkJCS8vIGlmIHdlIGFyZSBnb2luZyB0byB0aGUgZW5kLCB3ZSB3YW50IHRvIHJ1biBhbGwgdGhlIHR3ZWVucwoJCQkJCS8vIG90aGVyd2lzZSB3ZSBza2lwIHRoaXMgcGFydAoJCQkJCWxlbmd0aCA9IGdvdG9FbmQgPyBhbmltYXRpb24udHdlZW5zLmxlbmd0aCA6IDA7CgoJCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIDEgKTsKCQkJCX0KCgkJCQkvLyByZXNvbHZlIHdoZW4gd2UgcGxheWVkIHRoZSBsYXN0IGZyYW1lCgkJCQkvLyBvdGhlcndpc2UsIHJlamVjdAoJCQkJaWYgKCBnb3RvRW5kICkgewoJCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgZ290b0VuZCBdICk7CgkJCQl9IGVsc2UgewoJCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9CgkJfSksCgkJcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CgoJcHJvcEZpbHRlciggcHJvcHMsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmcgKTsKCglmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQlyZXN1bHQgPSBhbmltYXRpb25QcmVmaWx0ZXJzWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgZWxlbSwgcHJvcHMsIGFuaW1hdGlvbi5vcHRzICk7CgkJaWYgKCByZXN1bHQgKSB7CgkJCXJldHVybiByZXN1bHQ7CgkJfQoJfQoKCWNyZWF0ZVR3ZWVucyggYW5pbWF0aW9uLCBwcm9wcyApOwoKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGFuaW1hdGlvbi5vcHRzLnN0YXJ0ICkgKSB7CgkJYW5pbWF0aW9uLm9wdHMuc3RhcnQuY2FsbCggZWxlbSwgYW5pbWF0aW9uICk7Cgl9CgoJalF1ZXJ5LmZ4LnRpbWVyKAoJCWpRdWVyeS5leHRlbmQoIHRpY2ssIHsKCQkJYW5pbTogYW5pbWF0aW9uLAoJCQlxdWV1ZTogYW5pbWF0aW9uLm9wdHMucXVldWUsCgkJCWVsZW06IGVsZW0KCQl9KQoJKTsKCgkvLyBhdHRhY2ggY2FsbGJhY2tzIGZyb20gb3B0aW9ucwoJcmV0dXJuIGFuaW1hdGlvbi5wcm9ncmVzcyggYW5pbWF0aW9uLm9wdHMucHJvZ3Jlc3MgKQoJCS5kb25lKCBhbmltYXRpb24ub3B0cy5kb25lLCBhbmltYXRpb24ub3B0cy5jb21wbGV0ZSApCgkJLmZhaWwoIGFuaW1hdGlvbi5vcHRzLmZhaWwgKQoJCS5hbHdheXMoIGFuaW1hdGlvbi5vcHRzLmFsd2F5cyApOwp9CgpmdW5jdGlvbiBwcm9wRmlsdGVyKCBwcm9wcywgc3BlY2lhbEVhc2luZyApIHsKCXZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7CgoJLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzCglmb3IgKCBpbmRleCBpbiBwcm9wcyApIHsKCQluYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggaW5kZXggKTsKCQllYXNpbmcgPSBzcGVjaWFsRWFzaW5nWyBuYW1lIF07CgkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXTsKCQlpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQllYXNpbmcgPSB2YWx1ZVsgMSBdOwoJCQl2YWx1ZSA9IHByb3BzWyBpbmRleCBdID0gdmFsdWVbIDAgXTsKCQl9CgoJCWlmICggaW5kZXggIT09IG5hbWUgKSB7CgkJCXByb3BzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJZGVsZXRlIHByb3BzWyBpbmRleCBdOwoJCX0KCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXTsKCQlpZiAoIGhvb2tzICYmICJleHBhbmQiIGluIGhvb2tzICkgewoJCQl2YWx1ZSA9IGhvb2tzLmV4cGFuZCggdmFsdWUgKTsKCQkJZGVsZXRlIHByb3BzWyBuYW1lIF07CgoJCQkvLyBub3QgcXVpdGUgJC5leHRlbmQsIHRoaXMgd29udCBvdmVyd3JpdGUga2V5cyBhbHJlYWR5IHByZXNlbnQuCgkJCS8vIGFsc28gLSByZXVzaW5nICdpbmRleCcgZnJvbSBhYm92ZSBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiCgkJCWZvciAoIGluZGV4IGluIHZhbHVlICkgewoJCQkJaWYgKCAhKCBpbmRleCBpbiBwcm9wcyApICkgewoJCQkJCXByb3BzWyBpbmRleCBdID0gdmFsdWVbIGluZGV4IF07CgkJCQkJc3BlY2lhbEVhc2luZ1sgaW5kZXggXSA9IGVhc2luZzsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCXNwZWNpYWxFYXNpbmdbIG5hbWUgXSA9IGVhc2luZzsKCQl9Cgl9Cn0KCmpRdWVyeS5BbmltYXRpb24gPSBqUXVlcnkuZXh0ZW5kKCBBbmltYXRpb24sIHsKCgl0d2VlbmVyOiBmdW5jdGlvbiggcHJvcHMsIGNhbGxiYWNrICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHByb3BzICkgKSB7CgkJCWNhbGxiYWNrID0gcHJvcHM7CgkJCXByb3BzID0gWyAiKiIgXTsKCQl9IGVsc2UgewoJCQlwcm9wcyA9IHByb3BzLnNwbGl0KCIgIik7CgkJfQoKCQl2YXIgcHJvcCwKCQkJaW5kZXggPSAwLAoJCQlsZW5ndGggPSBwcm9wcy5sZW5ndGg7CgoJCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCQlwcm9wID0gcHJvcHNbIGluZGV4IF07CgkJCXR3ZWVuZXJzWyBwcm9wIF0gPSB0d2VlbmVyc1sgcHJvcCBdIHx8IFtdOwoJCQl0d2VlbmVyc1sgcHJvcCBdLnVuc2hpZnQoIGNhbGxiYWNrICk7CgkJfQoJfSwKCglwcmVmaWx0ZXI6IGZ1bmN0aW9uKCBjYWxsYmFjaywgcHJlcGVuZCApIHsKCQlpZiAoIHByZXBlbmQgKSB7CgkJCWFuaW1hdGlvblByZWZpbHRlcnMudW5zaGlmdCggY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQlhbmltYXRpb25QcmVmaWx0ZXJzLnB1c2goIGNhbGxiYWNrICk7CgkJfQoJfQp9KTsKCmZ1bmN0aW9uIGRlZmF1bHRQcmVmaWx0ZXIoIGVsZW0sIHByb3BzLCBvcHRzICkgewoJdmFyIGluZGV4LCBwcm9wLCB2YWx1ZSwgbGVuZ3RoLCBkYXRhU2hvdywgdG9nZ2xlLCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsCgkJYW5pbSA9IHRoaXMsCgkJc3R5bGUgPSBlbGVtLnN0eWxlLAoJCW9yaWcgPSB7fSwKCQloYW5kbGVkID0gW10sCgkJaGlkZGVuID0gZWxlbS5ub2RlVHlwZSAmJiBpc0hpZGRlbiggZWxlbSApOwoKCS8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKCWlmICggIW9wdHMucXVldWUgKSB7CgkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKCQlpZiAoIGhvb2tzLnVucXVldWVkID09IG51bGwgKSB7CgkJCWhvb2tzLnVucXVldWVkID0gMDsKCQkJb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CgkJCWhvb2tzLmVtcHR5LmZpcmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgewoJCQkJCW9sZGZpcmUoKTsKCQkJCX0KCQkJfTsKCQl9CgkJaG9va3MudW5xdWV1ZWQrKzsKCgkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCgkJCS8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcwoJCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJCWhvb2tzLnVucXVldWVkLS07CgkJCQlpZiAoICFqUXVlcnkucXVldWUoIGVsZW0sICJmeCIgKS5sZW5ndGggKSB7CgkJCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCX0KCgkvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwoJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICggImhlaWdodCIgaW4gcHJvcHMgfHwgIndpZHRoIiBpbiBwcm9wcyApICkgewoJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAoJCS8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUUgZG9lcyBub3QKCQkvLyBjaGFuZ2UgdGhlIG92ZXJmbG93IGF0dHJpYnV0ZSB3aGVuIG92ZXJmbG93WCBhbmQKCQkvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQoJCW9wdHMub3ZlcmZsb3cgPSBbIHN0eWxlLm92ZXJmbG93LCBzdHlsZS5vdmVyZmxvd1gsIHN0eWxlLm92ZXJmbG93WSBdOwoKCQkvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBpbmxpbmUtYmxvY2sgZm9yIGhlaWdodC93aWR0aAoJCS8vIGFuaW1hdGlvbnMgb24gaW5saW5lIGVsZW1lbnRzIHRoYXQgYXJlIGhhdmluZyB3aWR0aC9oZWlnaHQgYW5pbWF0ZWQKCQlpZiAoIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAiaW5saW5lIiAmJgoJCQkJalF1ZXJ5LmNzcyggZWxlbSwgImZsb2F0IiApID09PSAibm9uZSIgKSB7CgoJCQkvLyBpbmxpbmUtbGV2ZWwgZWxlbWVudHMgYWNjZXB0IGlubGluZS1ibG9jazsKCQkJLy8gYmxvY2stbGV2ZWwgZWxlbWVudHMgbmVlZCB0byBiZSBpbmxpbmUgd2l0aCBsYXlvdXQKCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCB8fCBjc3NfZGVmYXVsdERpc3BsYXkoIGVsZW0ubm9kZU5hbWUgKSA9PT0gImlubGluZSIgKSB7CgkJCQlzdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CgoJCQl9IGVsc2UgewoJCQkJc3R5bGUuem9vbSA9IDE7CgkJCX0KCQl9Cgl9CgoJaWYgKCBvcHRzLm92ZXJmbG93ICkgewoJCXN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CgkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcyApIHsKCQkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJc3R5bGUub3ZlcmZsb3cgPSBvcHRzLm92ZXJmbG93WyAwIF07CgkJCQlzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WyAxIF07CgkJCQlzdHlsZS5vdmVyZmxvd1kgPSBvcHRzLm92ZXJmbG93WyAyIF07CgkJCX0pOwoJCX0KCX0KCgoJLy8gc2hvdy9oaWRlIHBhc3MKCWZvciAoIGluZGV4IGluIHByb3BzICkgewoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07CgkJaWYgKCByZnh0eXBlcy5leGVjKCB2YWx1ZSApICkgewoJCQlkZWxldGUgcHJvcHNbIGluZGV4IF07CgkJCXRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gInRvZ2dsZSI7CgkJCWlmICggdmFsdWUgPT09ICggaGlkZGVuID8gImhpZGUiIDogInNob3ciICkgKSB7CgkJCQljb250aW51ZTsKCQkJfQoJCQloYW5kbGVkLnB1c2goIGluZGV4ICk7CgkJfQoJfQoKCWxlbmd0aCA9IGhhbmRsZWQubGVuZ3RoOwoJaWYgKCBsZW5ndGggKSB7CgkJZGF0YVNob3cgPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiZnhzaG93Iiwge30gKTsKCQlpZiAoICJoaWRkZW4iIGluIGRhdGFTaG93ICkgewoJCQloaWRkZW4gPSBkYXRhU2hvdy5oaWRkZW47CgkJfQoKCQkvLyBzdG9yZSBzdGF0ZSBpZiBpdHMgdG9nZ2xlIC0gZW5hYmxlcyAuc3RvcCgpLnRvZ2dsZSgpIHRvICJyZXZlcnNlIgoJCWlmICggdG9nZ2xlICkgewoJCQlkYXRhU2hvdy5oaWRkZW4gPSAhaGlkZGVuOwoJCX0KCQlpZiAoIGhpZGRlbiApIHsKCQkJalF1ZXJ5KCBlbGVtICkuc2hvdygpOwoJCX0gZWxzZSB7CgkJCWFuaW0uZG9uZShmdW5jdGlvbigpIHsKCQkJCWpRdWVyeSggZWxlbSApLmhpZGUoKTsKCQkJfSk7CgkJfQoJCWFuaW0uZG9uZShmdW5jdGlvbigpIHsKCQkJdmFyIHByb3A7CgkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtLCAiZnhzaG93IiwgdHJ1ZSApOwoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIG9yaWdbIHByb3AgXSApOwoJCQl9CgkJfSk7CgkJZm9yICggaW5kZXggPSAwIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCQlwcm9wID0gaGFuZGxlZFsgaW5kZXggXTsKCQkJdHdlZW4gPSBhbmltLmNyZWF0ZVR3ZWVuKCBwcm9wLCBoaWRkZW4gPyBkYXRhU2hvd1sgcHJvcCBdIDogMCApOwoJCQlvcmlnWyBwcm9wIF0gPSBkYXRhU2hvd1sgcHJvcCBdIHx8IGpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCApOwoKCQkJaWYgKCAhKCBwcm9wIGluIGRhdGFTaG93ICkgKSB7CgkJCQlkYXRhU2hvd1sgcHJvcCBdID0gdHdlZW4uc3RhcnQ7CgkJCQlpZiAoIGhpZGRlbiApIHsKCQkJCQl0d2Vlbi5lbmQgPSB0d2Vlbi5zdGFydDsKCQkJCQl0d2Vlbi5zdGFydCA9IHByb3AgPT09ICJ3aWR0aCIgfHwgcHJvcCA9PT0gImhlaWdodCIgPyAxIDogMDsKCQkJCX0KCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gVHdlZW4oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nICkgewoJcmV0dXJuIG5ldyBUd2Vlbi5wcm90b3R5cGUuaW5pdCggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKTsKfQpqUXVlcnkuVHdlZW4gPSBUd2VlbjsKClR3ZWVuLnByb3RvdHlwZSA9IHsKCWNvbnN0cnVjdG9yOiBUd2VlbiwKCWluaXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZywgdW5pdCApIHsKCQl0aGlzLmVsZW0gPSBlbGVtOwoJCXRoaXMucHJvcCA9IHByb3A7CgkJdGhpcy5lYXNpbmcgPSBlYXNpbmcgfHwgInN3aW5nIjsKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwoJCXRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CgkJdGhpcy5lbmQgPSBlbmQ7CgkJdGhpcy51bml0ID0gdW5pdCB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOwoJfSwKCWN1cjogZnVuY3Rpb24oKSB7CgkJdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJcmV0dXJuIGhvb2tzICYmIGhvb2tzLmdldCA/CgkJCWhvb2tzLmdldCggdGhpcyApIDoKCQkJVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LmdldCggdGhpcyApOwoJfSwKCXJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7CgkJdmFyIGVhc2VkLAoJCQlob29rcyA9IFR3ZWVuLnByb3BIb29rc1sgdGhpcy5wcm9wIF07CgoJCWlmICggdGhpcy5vcHRpb25zLmR1cmF0aW9uICkgewoJCQl0aGlzLnBvcyA9IGVhc2VkID0galF1ZXJ5LmVhc2luZ1sgdGhpcy5lYXNpbmcgXSgKCQkJCXBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbgoJCQkpOwoJCX0gZWxzZSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBwZXJjZW50OwoJCX0KCQl0aGlzLm5vdyA9ICggdGhpcy5lbmQgLSB0aGlzLnN0YXJ0ICkgKiBlYXNlZCArIHRoaXMuc3RhcnQ7CgoJCWlmICggdGhpcy5vcHRpb25zLnN0ZXAgKSB7CgkJCXRoaXMub3B0aW9ucy5zdGVwLmNhbGwoIHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMgKTsKCQl9CgoJCWlmICggaG9va3MgJiYgaG9va3Muc2V0ICkgewoJCQlob29rcy5zZXQoIHRoaXMgKTsKCQl9IGVsc2UgewoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuc2V0KCB0aGlzICk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQp9OwoKVHdlZW4ucHJvdG90eXBlLmluaXQucHJvdG90eXBlID0gVHdlZW4ucHJvdG90eXBlOwoKVHdlZW4ucHJvcEhvb2tzID0gewoJX2RlZmF1bHQ6IHsKCQlnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCQkJdmFyIHJlc3VsdDsKCgkJCWlmICggdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYKCQkJCSghdHdlZW4uZWxlbS5zdHlsZSB8fCB0d2Vlbi5lbGVtLnN0eWxlWyB0d2Vlbi5wcm9wIF0gPT0gbnVsbCkgKSB7CgkJCQlyZXR1cm4gdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdOwoJCQl9CgoJCQkvLyBwYXNzaW5nIGFueSB2YWx1ZSBhcyBhIDR0aCBwYXJhbWV0ZXIgdG8gLmNzcyB3aWxsIGF1dG9tYXRpY2FsbHkKCQkJLy8gYXR0ZW1wdCBhIHBhcnNlRmxvYXQgYW5kIGZhbGxiYWNrIHRvIGEgc3RyaW5nIGlmIHRoZSBwYXJzZSBmYWlscwoJCQkvLyBzbywgc2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0LgoJCQkvLyBjb21wbGV4IHZhbHVlcyBzdWNoIGFzICJyb3RhdGUoMXJhZCkiIGFyZSByZXR1cm5lZCBhcyBpcy4KCQkJcmVzdWx0ID0galF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgZmFsc2UsICIiICk7CgkJCS8vIEVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCBhbmQgImF1dG8iIGFyZSBjb252ZXJ0ZWQgdG8gMC4KCQkJcmV0dXJuICFyZXN1bHQgfHwgcmVzdWx0ID09PSAiYXV0byIgPyAwIDogcmVzdWx0OwoJCX0sCgkJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CgkJCS8vIHVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0IC0gdXNlIGNzc0hvb2sgaWYgaXRzIHRoZXJlIC0gdXNlIC5zdHlsZSBpZiBpdHMKCQkJLy8gYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUKCQkJaWYgKCBqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdICkgewoJCQkJalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSggdHdlZW4gKTsKCQkJfSBlbHNlIGlmICggdHdlZW4uZWxlbS5zdHlsZSAmJiAoIHR3ZWVuLmVsZW0uc3R5bGVbIGpRdWVyeS5jc3NQcm9wc1sgdHdlZW4ucHJvcCBdIF0gIT0gbnVsbCB8fCBqUXVlcnkuY3NzSG9va3NbIHR3ZWVuLnByb3AgXSApICkgewoJCQkJalF1ZXJ5LnN0eWxlKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCB0d2Vlbi5ub3cgKyB0d2Vlbi51bml0ICk7CgkJCX0gZWxzZSB7CgkJCQl0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gPSB0d2Vlbi5ub3c7CgkJCX0KCQl9Cgl9Cn07CgovLyBSZW1vdmUgaW4gMi4wIC0gdGhpcyBzdXBwb3J0cyBJRTgncyBwYW5pYyBiYXNlZCBhcHByb2FjaAovLyB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCWlmICggdHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUgKSB7CgkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQl9Cgl9Cn07CgpqUXVlcnkuZWFjaChbICJ0b2dnbGUiLCAic2hvdyIsICJoaWRlIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBjc3NGbiA9IGpRdWVyeS5mblsgbmFtZSBdOwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHNwZWVkID09IG51bGwgfHwgdHlwZW9mIHNwZWVkID09PSAiYm9vbGVhbiIgfHwKCQkJLy8gc3BlY2lhbCBjaGVjayBmb3IgLnRvZ2dsZSggaGFuZGxlciwgaGFuZGxlciwgLi4uICkKCQkJKCAhaSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggZWFzaW5nICkgKSA/CgkJCWNzc0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA6CgkJCXRoaXMuYW5pbWF0ZSggZ2VuRngoIG5hbWUsIHRydWUgKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmYWRlVG86IGZ1bmN0aW9uKCBzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2sgKSB7CgoJCS8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAoJCXJldHVybiB0aGlzLmZpbHRlciggaXNIaWRkZW4gKS5jc3MoICJvcGFjaXR5IiwgMCApLnNob3coKQoKCQkJLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCgkJCS5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0sCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKCQkJb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsKCgkJCQkvLyBFbXB0eSBhbmltYXRpb25zIHJlc29sdmUgaW1tZWRpYXRlbHkKCQkJCWlmICggZW1wdHkgKSB7CgkJCQkJYW5pbS5zdG9wKCB0cnVlICk7CgkJCQl9CgkJCX07CgoJCXJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8KCQkJdGhpcy5lYWNoKCBkb0FuaW1hdGlvbiApIDoKCQkJdGhpcy5xdWV1ZSggb3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbiApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCB0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CgkJCXZhciBzdG9wID0gaG9va3Muc3RvcDsKCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCXN0b3AoIGdvdG9FbmQgKTsKCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZ290b0VuZCA9IGNsZWFyUXVldWU7CgkJCWNsZWFyUXVldWUgPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGNsZWFyUXVldWUgJiYgdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBkZXF1ZXVlID0gdHJ1ZSwKCQkJCWluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCQkJZGF0YSA9IGpRdWVyeS5fZGF0YSggdGhpcyApOwoKCQkJaWYgKCBpbmRleCApIHsKCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgKSB7CgkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCBpbmRleCBpbiBkYXRhICkgewoJCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgJiYgcnJ1bi50ZXN0KCBpbmRleCApICkgewoJCQkJCQlzdG9wUXVldWUoIGRhdGFbIGluZGV4IF0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7CgkJCQlpZiAoIHRpbWVyc1sgaW5kZXggXS5lbGVtID09PSB0aGlzICYmICh0eXBlID09IG51bGwgfHwgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlKSApIHsKCQkJCQl0aW1lcnNbIGluZGV4IF0uYW5pbS5zdG9wKCBnb3RvRW5kICk7CgkJCQkJZGVxdWV1ZSA9IGZhbHNlOwoJCQkJCXRpbWVycy5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQl9CgkJCX0KCgkJCS8vIHN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQKCQkJLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUKCQkJLy8gYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQKCQkJaWYgKCBkZXF1ZXVlIHx8ICFnb3RvRW5kICkgewoJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJfQoJCX0pOwoJfQp9KTsKCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBpbmNsdWRlV2lkdGggKSB7Cgl2YXIgd2hpY2gsCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9LAoJCWkgPSAwOwoKCS8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKCS8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKCWluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aD8gMSA6IDA7Cglmb3IoIDsgaSA8IDQgOyBpICs9IDIgLSBpbmNsdWRlV2lkdGggKSB7CgkJd2hpY2ggPSBjc3NFeHBhbmRbIGkgXTsKCQlhdHRyc1sgIm1hcmdpbiIgKyB3aGljaCBdID0gYXR0cnNbICJwYWRkaW5nIiArIHdoaWNoIF0gPSB0eXBlOwoJfQoKCWlmICggaW5jbHVkZVdpZHRoICkgewoJCWF0dHJzLm9wYWNpdHkgPSBhdHRycy53aWR0aCA9IHR5cGU7Cgl9CgoJcmV0dXJuIGF0dHJzOwp9CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKCXNsaWRlRG93bjogZ2VuRngoInNob3ciKSwKCXNsaWRlVXA6IGdlbkZ4KCJoaWRlIiksCglzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIpLAoJZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfSwKCWZhZGVUb2dnbGU6IHsgb3BhY2l0eTogInRvZ2dsZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5hbmltYXRlKCBwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LnNwZWVkID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGZuICkgewoJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCB7fSwgc3BlZWQgKSA6IHsKCQljb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fAoJCQlqUXVlcnkuaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBzcGVlZCwKCQlkdXJhdGlvbjogc3BlZWQsCgkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFqUXVlcnkuaXNGdW5jdGlvbiggZWFzaW5nICkgJiYgZWFzaW5nCgl9OwoKCW9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gIm51bWJlciIgPyBvcHQuZHVyYXRpb24gOgoJCW9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKCS8vIG5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKCWlmICggb3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlICkgewoJCW9wdC5xdWV1ZSA9ICJmeCI7Cgl9CgoJLy8gUXVldWVpbmcKCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgoJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0Lm9sZCApICkgewoJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQl9CgoJCWlmICggb3B0LnF1ZXVlICkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgb3B0LnF1ZXVlICk7CgkJfQoJfTsKCglyZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmVhc2luZyA9IHsKCWxpbmVhcjogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIHA7Cgl9LAoJc3dpbmc6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiAwLjUgLSBNYXRoLmNvcyggcCpNYXRoLlBJICkgLyAyOwoJfQp9OwoKalF1ZXJ5LnRpbWVycyA9IFtdOwpqUXVlcnkuZnggPSBUd2Vlbi5wcm90b3R5cGUuaW5pdDsKalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsKCXZhciB0aW1lciwKCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCWkgPSAwOwoKCWZ4Tm93ID0galF1ZXJ5Lm5vdygpOwoKCWZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKCQl0aW1lciA9IHRpbWVyc1sgaSBdOwoJCS8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZAoJCWlmICggIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyICkgewoJCQl0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsKCQl9Cgl9CgoJaWYgKCAhdGltZXJzLmxlbmd0aCApIHsKCQlqUXVlcnkuZnguc3RvcCgpOwoJfQoJZnhOb3cgPSB1bmRlZmluZWQ7Cn07CgpqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiggdGltZXIgKSB7CglpZiAoIHRpbWVyKCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKCB0aW1lciApICYmICF0aW1lcklkICkgewoJCXRpbWVySWQgPSBzZXRJbnRlcnZhbCggalF1ZXJ5LmZ4LnRpY2ssIGpRdWVyeS5meC5pbnRlcnZhbCApOwoJfQp9OwoKalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CgpqUXVlcnkuZnguc3RvcCA9IGZ1bmN0aW9uKCkgewoJY2xlYXJJbnRlcnZhbCggdGltZXJJZCApOwoJdGltZXJJZCA9IG51bGw7Cn07CgpqUXVlcnkuZnguc3BlZWRzID0gewoJc2xvdzogNjAwLAoJZmFzdDogMjAwLAoJLy8gRGVmYXVsdCBzcGVlZAoJX2RlZmF1bHQ6IDQwMAp9OwoKLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKCmlmICggalF1ZXJ5LmV4cHIgJiYgalF1ZXJ5LmV4cHIuZmlsdGVycyApIHsKCWpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoalF1ZXJ5LnRpbWVycywgZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKCQl9KS5sZW5ndGg7Cgl9Owp9CnZhciBycm9vdCA9IC9eKD86Ym9keXxodG1sKSQvaTsKCmpRdWVyeS5mbi5vZmZzZXQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQlyZXR1cm4gb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcyA6CgkJCXRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KCB0aGlzLCBvcHRpb25zLCBpICk7CgkJCX0pOwoJfQoKCXZhciBkb2NFbGVtLCBib2R5LCB3aW4sIGNsaWVudFRvcCwgY2xpZW50TGVmdCwgc2Nyb2xsVG9wLCBzY3JvbGxMZWZ0LAoJCWJveCA9IHsgdG9wOiAwLCBsZWZ0OiAwIH0sCgkJZWxlbSA9IHRoaXNbIDAgXSwKCQlkb2MgPSBlbGVtICYmIGVsZW0ub3duZXJEb2N1bWVudDsKCglpZiAoICFkb2MgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggKGJvZHkgPSBkb2MuYm9keSkgPT09IGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5vZmZzZXQuYm9keU9mZnNldCggZWxlbSApOwoJfQoKCWRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwoKCS8vIE1ha2Ugc3VyZSBpdCdzIG5vdCBhIGRpc2Nvbm5lY3RlZCBET00gbm9kZQoJaWYgKCAhalF1ZXJ5LmNvbnRhaW5zKCBkb2NFbGVtLCBlbGVtICkgKSB7CgkJcmV0dXJuIGJveDsKCX0KCgkvLyBJZiB3ZSBkb24ndCBoYXZlIGdCQ1IsIGp1c3QgdXNlIDAsMCByYXRoZXIgdGhhbiBlcnJvcgoJLy8gQmxhY2tCZXJyeSA1LCBpT1MgMyAob3JpZ2luYWwgaVBob25lKQoJaWYgKCB0eXBlb2YgZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiICkgewoJCWJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7Cgl9Cgl3aW4gPSBnZXRXaW5kb3coIGRvYyApOwoJY2xpZW50VG9wICA9IGRvY0VsZW0uY2xpZW50VG9wICB8fCBib2R5LmNsaWVudFRvcCAgfHwgMDsKCWNsaWVudExlZnQgPSBkb2NFbGVtLmNsaWVudExlZnQgfHwgYm9keS5jbGllbnRMZWZ0IHx8IDA7CglzY3JvbGxUb3AgID0gd2luLnBhZ2VZT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsVG9wOwoJc2Nyb2xsTGVmdCA9IHdpbi5wYWdlWE9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbExlZnQ7CglyZXR1cm4gewoJCXRvcDogYm94LnRvcCAgKyBzY3JvbGxUb3AgIC0gY2xpZW50VG9wLAoJCWxlZnQ6IGJveC5sZWZ0ICsgc2Nyb2xsTGVmdCAtIGNsaWVudExlZnQKCX07Cn07CgpqUXVlcnkub2Zmc2V0ID0gewoKCWJvZHlPZmZzZXQ6IGZ1bmN0aW9uKCBib2R5ICkgewoJCXZhciB0b3AgPSBib2R5Lm9mZnNldFRvcCwKCQkJbGVmdCA9IGJvZHkub2Zmc2V0TGVmdDsKCgkJaWYgKCBqUXVlcnkuc3VwcG9ydC5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCApIHsKCQkJdG9wICArPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKGJvZHksICJtYXJnaW5Ub3AiKSApIHx8IDA7CgkJCWxlZnQgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyhib2R5LCAibWFyZ2luTGVmdCIpICkgfHwgMDsKCQl9CgoJCXJldHVybiB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH07Cgl9LAoKCXNldE9mZnNldDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGkgKSB7CgkJdmFyIHBvc2l0aW9uID0galF1ZXJ5LmNzcyggZWxlbSwgInBvc2l0aW9uIiApOwoKCQkvLyBzZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCgkJaWYgKCBwb3NpdGlvbiA9PT0gInN0YXRpYyIgKSB7CgkJCWVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoJCX0KCgkJdmFyIGN1ckVsZW0gPSBqUXVlcnkoIGVsZW0gKSwKCQkJY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKSwKCQkJY3VyQ1NTVG9wID0galF1ZXJ5LmNzcyggZWxlbSwgInRvcCIgKSwKCQkJY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoIGVsZW0sICJsZWZ0IiApLAoJCQljYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJiBqUXVlcnkuaW5BcnJheSgiYXV0byIsIFtjdXJDU1NUb3AsIGN1ckNTU0xlZnRdKSA+IC0xLAoJCQlwcm9wcyA9IHt9LCBjdXJQb3NpdGlvbiA9IHt9LCBjdXJUb3AsIGN1ckxlZnQ7CgoJCS8vIG5lZWQgdG8gYmUgYWJsZSB0byBjYWxjdWxhdGUgcG9zaXRpb24gaWYgZWl0aGVyIHRvcCBvciBsZWZ0IGlzIGF1dG8gYW5kIHBvc2l0aW9uIGlzIGVpdGhlciBhYnNvbHV0ZSBvciBmaXhlZAoJCWlmICggY2FsY3VsYXRlUG9zaXRpb24gKSB7CgkJCWN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwoJCQljdXJUb3AgPSBjdXJQb3NpdGlvbi50b3A7CgkJCWN1ckxlZnQgPSBjdXJQb3NpdGlvbi5sZWZ0OwoJCX0gZWxzZSB7CgkJCWN1clRvcCA9IHBhcnNlRmxvYXQoIGN1ckNTU1RvcCApIHx8IDA7CgkJCWN1ckxlZnQgPSBwYXJzZUZsb2F0KCBjdXJDU1NMZWZ0ICkgfHwgMDsKCQl9CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdGlvbnMgKSApIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMuY2FsbCggZWxlbSwgaSwgY3VyT2Zmc2V0ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudG9wICE9IG51bGwgKSB7CgkJCXByb3BzLnRvcCA9ICggb3B0aW9ucy50b3AgLSBjdXJPZmZzZXQudG9wICkgKyBjdXJUb3A7CgkJfQoJCWlmICggb3B0aW9ucy5sZWZ0ICE9IG51bGwgKSB7CgkJCXByb3BzLmxlZnQgPSAoIG9wdGlvbnMubGVmdCAtIGN1ck9mZnNldC5sZWZ0ICkgKyBjdXJMZWZ0OwoJCX0KCgkJaWYgKCAidXNpbmciIGluIG9wdGlvbnMgKSB7CgkJCW9wdGlvbnMudXNpbmcuY2FsbCggZWxlbSwgcHJvcHMgKTsKCQl9IGVsc2UgewoJCQljdXJFbGVtLmNzcyggcHJvcHMgKTsKCQl9Cgl9Cn07CgoKalF1ZXJ5LmZuLmV4dGVuZCh7CgoJcG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXNbMF0gKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBlbGVtID0gdGhpc1swXSwKCgkJLy8gR2V0ICpyZWFsKiBvZmZzZXRQYXJlbnQKCQlvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpLAoKCQkvLyBHZXQgY29ycmVjdCBvZmZzZXRzCgkJb2Zmc2V0ICAgICAgID0gdGhpcy5vZmZzZXQoKSwKCQlwYXJlbnRPZmZzZXQgPSBycm9vdC50ZXN0KG9mZnNldFBhcmVudFswXS5ub2RlTmFtZSkgPyB7IHRvcDogMCwgbGVmdDogMCB9IDogb2Zmc2V0UGFyZW50Lm9mZnNldCgpOwoKCQkvLyBTdWJ0cmFjdCBlbGVtZW50IG1hcmdpbnMKCQkvLyBub3RlOiB3aGVuIGFuIGVsZW1lbnQgaGFzIG1hcmdpbjogYXV0byB0aGUgb2Zmc2V0TGVmdCBhbmQgbWFyZ2luTGVmdAoJCS8vIGFyZSB0aGUgc2FtZSBpbiBTYWZhcmkgY2F1c2luZyBvZmZzZXQubGVmdCB0byBpbmNvcnJlY3RseSBiZSAwCgkJb2Zmc2V0LnRvcCAgLT0gcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyhlbGVtLCAibWFyZ2luVG9wIikgKSB8fCAwOwoJCW9mZnNldC5sZWZ0IC09IHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoZWxlbSwgIm1hcmdpbkxlZnQiKSApIHx8IDA7CgoJCS8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycwoJCXBhcmVudE9mZnNldC50b3AgICs9IHBhcnNlRmxvYXQoIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50WzBdLCAiYm9yZGVyVG9wV2lkdGgiKSApIHx8IDA7CgkJcGFyZW50T2Zmc2V0LmxlZnQgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJMZWZ0V2lkdGgiKSApIHx8IDA7CgoJCS8vIFN1YnRyYWN0IHRoZSB0d28gb2Zmc2V0cwoJCXJldHVybiB7CgkJCXRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCwKCQkJbGVmdDogb2Zmc2V0LmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdAoJCX07Cgl9LAoKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keTsKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYgKCFycm9vdC50ZXN0KG9mZnNldFBhcmVudC5ub2RlTmFtZSkgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikgKSB7CgkJCQlvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwoJCQl9CgkJCXJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keTsKCQl9KTsKCX0KfSk7CgoKLy8gQ3JlYXRlIHNjcm9sbExlZnQgYW5kIHNjcm9sbFRvcCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7c2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0Iiwgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQifSwgZnVuY3Rpb24oIG1ldGhvZCwgcHJvcCApIHsKCXZhciB0b3AgPSAvWS8udGVzdCggcHJvcCApOwoKCWpRdWVyeS5mblsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdmFsICkgewoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbWV0aG9kLCB2YWwgKSB7CgkJCXZhciB3aW4gPSBnZXRXaW5kb3coIGVsZW0gKTsKCgkJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gd2luID8gKHByb3AgaW4gd2luKSA/IHdpblsgcHJvcCBdIDoKCQkJCQl3aW4uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyBtZXRob2QgXSA6CgkJCQkJZWxlbVsgbWV0aG9kIF07CgkJCX0KCgkJCWlmICggd2luICkgewoJCQkJd2luLnNjcm9sbFRvKAoJCQkJCSF0b3AgPyB2YWwgOiBqUXVlcnkoIHdpbiApLnNjcm9sbExlZnQoKSwKCQkJCQkgdG9wID8gdmFsIDogalF1ZXJ5KCB3aW4gKS5zY3JvbGxUb3AoKQoJCQkJKTsKCgkJCX0gZWxzZSB7CgkJCQllbGVtWyBtZXRob2QgXSA9IHZhbDsKCQkJfQoJCX0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsICk7Cgl9Owp9KTsKCmZ1bmN0aW9uIGdldFdpbmRvdyggZWxlbSApIHsKCXJldHVybiBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSA/CgkJZWxlbSA6CgkJZWxlbS5ub2RlVHlwZSA9PT0gOSA/CgkJCWVsZW0uZGVmYXVsdFZpZXcgfHwgZWxlbS5wYXJlbnRXaW5kb3cgOgoJCQlmYWxzZTsKfQovLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIGhlaWdodCwgd2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHsgSGVpZ2h0OiAiaGVpZ2h0IiwgV2lkdGg6ICJ3aWR0aCIgfSwgZnVuY3Rpb24oIG5hbWUsIHR5cGUgKSB7CglqUXVlcnkuZWFjaCggeyBwYWRkaW5nOiAiaW5uZXIiICsgbmFtZSwgY29udGVudDogdHlwZSwgIiI6ICJvdXRlciIgKyBuYW1lIH0sIGZ1bmN0aW9uKCBkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lICkgewoJCS8vIG1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAoJCWpRdWVyeS5mblsgZnVuY05hbWUgXSA9IGZ1bmN0aW9uKCBtYXJnaW4sIHZhbHVlICkgewoJCQl2YXIgY2hhaW5hYmxlID0gYXJndW1lbnRzLmxlbmd0aCAmJiAoIGRlZmF1bHRFeHRyYSB8fCB0eXBlb2YgbWFyZ2luICE9PSAiYm9vbGVhbiIgKSwKCQkJCWV4dHJhID0gZGVmYXVsdEV4dHJhIHx8ICggbWFyZ2luID09PSB0cnVlIHx8IHZhbHVlID09PSB0cnVlID8gIm1hcmdpbiIgOiAiYm9yZGVyIiApOwoKCQkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsKCQkJCXZhciBkb2M7CgoJCQkJaWYgKCBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCQkJCQkvLyBBcyBvZiA1LzgvMjAxMiB0aGlzIHdpbGwgeWllbGQgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIE1vYmlsZSBTYWZhcmksIGJ1dCB0aGVyZQoJCQkJCS8vIGlzbid0IGEgd2hvbGUgbG90IHdlIGNhbiBkby4gU2VlIHB1bGwgcmVxdWVzdCBhdCB0aGlzIFVSTCBmb3IgZGlzY3Vzc2lvbjoKCQkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzc2NAoJCQkJCXJldHVybiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgImNsaWVudCIgKyBuYW1lIF07CgkJCQl9CgoJCQkJLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSA5ICkgewoJCQkJCWRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwoKCQkJCQkvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0gb3IgY2xpZW50W1dpZHRoL0hlaWdodF0sIHdoaWNoZXZlciBpcyBncmVhdGVzdAoJCQkJCS8vIHVuZm9ydHVuYXRlbHksIHRoaXMgY2F1c2VzIGJ1ZyAjMzgzOCBpbiBJRTYvOCBvbmx5LCBidXQgdGhlcmUgaXMgY3VycmVudGx5IG5vIGdvb2QsIHNtYWxsIHdheSB0byBmaXggaXQuCgkJCQkJcmV0dXJuIE1hdGgubWF4KAoJCQkJCQllbGVtLmJvZHlbICJzY3JvbGwiICsgbmFtZSBdLCBkb2NbICJzY3JvbGwiICsgbmFtZSBdLAoJCQkJCQllbGVtLmJvZHlbICJvZmZzZXQiICsgbmFtZSBdLCBkb2NbICJvZmZzZXQiICsgbmFtZSBdLAoJCQkJCQlkb2NbICJjbGllbnQiICsgbmFtZSBdCgkJCQkJKTsKCQkJCX0KCgkJCQlyZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/CgkJCQkJLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCwgcmVxdWVzdGluZyBidXQgbm90IGZvcmNpbmcgcGFyc2VGbG9hdAoJCQkJCWpRdWVyeS5jc3MoIGVsZW0sIHR5cGUsIHZhbHVlLCBleHRyYSApIDoKCgkJCQkJLy8gU2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudAoJCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgdHlwZSwgdmFsdWUsIGV4dHJhICk7CgkJCX0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlLCBudWxsICk7CgkJfTsKCX0pOwp9KTsKLy8gRXhwb3NlIGpRdWVyeSB0byB0aGUgZ2xvYmFsIG9iamVjdAp3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7CgovLyBFeHBvc2UgalF1ZXJ5IGFzIGFuIEFNRCBtb2R1bGUsIGJ1dCBvbmx5IGZvciBBTUQgbG9hZGVycyB0aGF0Ci8vIHVuZGVyc3RhbmQgdGhlIGlzc3VlcyB3aXRoIGxvYWRpbmcgbXVsdGlwbGUgdmVyc2lvbnMgb2YgalF1ZXJ5Ci8vIGluIGEgcGFnZSB0aGF0IGFsbCBtaWdodCBjYWxsIGRlZmluZSgpLiBUaGUgbG9hZGVyIHdpbGwgaW5kaWNhdGUKLy8gdGhleSBoYXZlIHNwZWNpYWwgYWxsb3dhbmNlcyBmb3IgbXVsdGlwbGUgalF1ZXJ5IHZlcnNpb25zIGJ5Ci8vIHNwZWNpZnlpbmcgZGVmaW5lLmFtZC5qUXVlcnkgPSB0cnVlLiBSZWdpc3RlciBhcyBhIG5hbWVkIG1vZHVsZSwKLy8gc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlciBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLAovLyBidXQgbm90IHVzZSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0IHVuZGVyc3RhbmRzIGFub255bW91cwovLyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdCB3YXkgdG8gcmVnaXN0ZXIuCi8vIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlIGRlcml2ZWQgZnJvbQovLyBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZSBmaWxlIG5hbWUuCi8vIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMgdG8gY2FsbAovLyBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCAmJiBkZWZpbmUuYW1kLmpRdWVyeSApIHsKCWRlZmluZSggImpxdWVyeSIsIFtdLCBmdW5jdGlvbiAoKSB7IHJldHVybiBqUXVlcnk7IH0gKTsKfQoKfSkoIHdpbmRvdyApOwo="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,Ly8gU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20vZGV2b25nb3ZldHQvanF1ZXJ5LmV2ZW50LmRyYWcvYmxvYi80NTFkOTBlMWE3MzdmNDlmNjEzZDA5NjYwODJjZTY3NTgyYjBhZmQxL2RyYWcvanF1ZXJ5LmV2ZW50LmRyYWcuanMKLy8KLy8JV2FybmluZyEgTWFrZSBzdXJlIHRoZSBoaWphY2soKSBpcyBwYXRjaCB0byB3b3JrIHdpdGggYW55IGpxdWVyeSB2ZXJzaW9uOgovLwovLyAgICgkLmV2ZW50LmRpc3BhdGNoIHx8ICQuZXZlbnQuaGFuZGxlKS5jYWxsKCBlbGVtLCBldmVudCApOwovLwoKLyohCmpxdWVyeS5ldmVudC5kcmFnLmpzIH4gdjEuNiB+IENvcHlyaWdodCAoYykgMjAwOCwgVGhyZWUgRHViIE1lZGlhIChodHRwOi8vdGhyZWVkdWJtZWRpYS5jb20pCkxpc2NlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UgfiBodHRwOi8vdGhyZWVkdWJtZWRpYS5nb29nbGVjb2RlLmNvbS9maWxlcy9NSVQtTElDRU5TRS50eHQKKi8KOyhmdW5jdGlvbigkKXsgLy8gc2VjdXJlICQgalF1ZXJ5IGFsaWFzCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovLyBDcmVhdGVkOiAyMDA4LTA2LTA0IHwgVXBkYXRlZDogMjAwOS0wNC0yMQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLy8gRXZlbnRzOiBkcmFnLCBkcmFnc3RhcnQsIGRyYWdlbmQKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgovLyBqcXVlcnkgbWV0aG9kCiQuZm4uZHJhZyA9IGZ1bmN0aW9uKCBmbjEsIGZuMiwgZm4zICl7CglpZiAoIGZuMiApIHRoaXMuYmluZCgnZHJhZ3N0YXJ0JywgZm4xICk7IC8vIDIrIGFyZ3MKCWlmICggZm4zICkgdGhpcy5iaW5kKCdkcmFnZW5kJywgZm4zICk7IC8vIDMgYXJncwoJcmV0dXJuICFmbjEgPyB0aGlzLnRyaWdnZXIoJ2RyYWcnKSAvLyAwIGFyZ3MKCQk6IHRoaXMuYmluZCgnZHJhZycsIGZuMiA/IGZuMiA6IGZuMSApOyAvLyAxKyBhcmdzCgl9OwoKLy8gbG9jYWwgcmVmcwp2YXIgJGV2ZW50ID0gJC5ldmVudCwgJHNwZWNpYWwgPSAkZXZlbnQuc3BlY2lhbCwKCi8vIHNwZWNpYWwgZXZlbnQgY29uZmlndXJhdGlvbgpkcmFnID0gJHNwZWNpYWwuZHJhZyA9IHsKCW5vdDogJzppbnB1dCcsIC8vIGRvbid0IGJlZ2luIHRvIGRyYWcgb24gZXZlbnQudGFyZ2V0cyB0aGF0IG1hdGNoIHRoaXMgc2VsZWN0b3IKCWRpc3RhbmNlOiAwLCAvLyBkaXN0YW5jZSBkcmFnZ2VkIGJlZm9yZSBkcmFnc3RhcnQKCXdoaWNoOiAxLCAvLyBtb3VzZSBidXR0b24gcHJlc3NlZCB0byBzdGFydCBkcmFnIHNlcXVlbmNlCglkcm9wOiBmYWxzZSwgLy8gZmFsc2UgdG8gc3VwcHJlc3MgZHJvcCBldmVudHMKCWRyYWdnaW5nOiBmYWxzZSwgLy8gaG9sZCB0aGUgYWN0aXZlIHRhcmdldCBlbGVtZW50CglzZXR1cDogZnVuY3Rpb24oIGRhdGEgKXsKCQlkYXRhID0gJC5leHRlbmQoewoJCQlkaXN0YW5jZTogZHJhZy5kaXN0YW5jZSwKCQkJd2hpY2g6IGRyYWcud2hpY2gsCgkJCW5vdDogZHJhZy5ub3QsCgkJCWRyb3A6IGRyYWcuZHJvcAoJCQl9LCBkYXRhIHx8IHt9KTsKCQlkYXRhLmRpc3RhbmNlID0gc3F1YXJlZCggZGF0YS5kaXN0YW5jZSApOyAvLyAgeMKyICsgecKyID0gZGlzdGFuY2XCsgoJCSRldmVudC5hZGQoIHRoaXMsICJtb3VzZWRvd24iLCBoYW5kbGVyLCBkYXRhICk7CgkJaWYgKCB0aGlzLmF0dGFjaEV2ZW50ICkgdGhpcy5hdHRhY2hFdmVudCgib25kcmFnc3RhcnQiLCBkb250U3RhcnQgKTsgLy8gcHJldmVudCBpbWFnZSBkcmFnZ2luZyBpbiBJRS4uLgoJCX0sCgl0ZWFyZG93bjogZnVuY3Rpb24oKXsKCQkkZXZlbnQucmVtb3ZlKCB0aGlzLCAibW91c2Vkb3duIiwgaGFuZGxlciApOwoJCWlmICggdGhpcyA9PT0gZHJhZy5kcmFnZ2luZyApIGRyYWcuZHJhZ2dpbmcgPSBkcmFnLnByb3h5ID0gZmFsc2U7IC8vIGRlYWN0aXZhdGUgZWxlbWVudAoJCXNlbGVjdGFibGUoIHRoaXMsIHRydWUgKTsgLy8gZW5hYmxlIHRleHQgc2VsZWN0aW9uCgkJaWYgKCB0aGlzLmRldGFjaEV2ZW50ICkgdGhpcy5kZXRhY2hFdmVudCgib25kcmFnc3RhcnQiLCBkb250U3RhcnQgKTsgLy8gcHJldmVudCBpbWFnZSBkcmFnZ2luZyBpbiBJRS4uLgoJCX0KCX07CgovLyBwcmV2ZW50IG5vcm1hbCBldmVudCBiaW5kaW5nLi4uCiRzcGVjaWFsLmRyYWdzdGFydCA9ICRzcGVjaWFsLmRyYWdlbmQgPSB7IHNldHVwOmZ1bmN0aW9uKCl7fSwgdGVhcmRvd246ZnVuY3Rpb24oKXt9IH07CgovLyBoYW5kbGUgZHJhZy1yZWxlYXRkIERPTSBldmVudHMKZnVuY3Rpb24gaGFuZGxlciAoIGV2ZW50ICl7Cgl2YXIgZWxlbSA9IHRoaXMsIHJldHVybmVkLCBkYXRhID0gZXZlbnQuZGF0YSB8fCB7fTsKCS8vIG1vdXNlbW92ZSBvciBtb3VzZXVwCglpZiAoIGRhdGEuZWxlbSApewoJCS8vIHVwZGF0ZSBldmVudCBwcm9wZXJ0aWVzLi4uCgkJZWxlbSA9IGV2ZW50LmRyYWdUYXJnZXQgPSBkYXRhLmVsZW07IC8vIGRyYWcgc291cmNlIGVsZW1lbnQKCQlldmVudC5kcmFnUHJveHkgPSBkcmFnLnByb3h5IHx8IGVsZW07IC8vIHByb3h5IGVsZW1lbnQgb3Igc291cmNlCgkJZXZlbnQuY3Vyc29yT2Zmc2V0WCA9IGRhdGEucGFnZVggLSBkYXRhLmxlZnQ7IC8vIG1vdXNlZG93biBvZmZzZXQKCQlldmVudC5jdXJzb3JPZmZzZXRZID0gZGF0YS5wYWdlWSAtIGRhdGEudG9wOyAvLyBtb3VzZWRvd24gb2Zmc2V0CgkJZXZlbnQub2Zmc2V0WCA9IGV2ZW50LnBhZ2VYIC0gZXZlbnQuY3Vyc29yT2Zmc2V0WDsgLy8gZWxlbWVudCBvZmZzZXQKCQlldmVudC5vZmZzZXRZID0gZXZlbnQucGFnZVkgLSBldmVudC5jdXJzb3JPZmZzZXRZOyAvLyBlbGVtZW50IG9mZnNldAoJCX0KCS8vIG1vdXNlZG93biwgY2hlY2sgc29tZSBpbml0aWFsIHByb3BzIHRvIGF2b2lkIHRoZSBzd2l0Y2ggc3RhdGVtZW50CgllbHNlIGlmICggZHJhZy5kcmFnZ2luZyB8fCAoIGRhdGEud2hpY2g+MCAmJiBldmVudC53aGljaCE9ZGF0YS53aGljaCApIHx8CgkJJCggZXZlbnQudGFyZ2V0ICkuaXMoIGRhdGEubm90ICkgKSByZXR1cm47CgkvLyBoYW5kbGUgdmFyaW91cyBldmVudHMKCXN3aXRjaCAoIGV2ZW50LnR5cGUgKXsKCQkvLyBtb3VzZWRvd24sIGxlZnQgY2xpY2ssIGV2ZW50LnRhcmdldCBpcyBub3QgcmVzdHJpY3RlZCwgaW5pdCBkcmFnZ2luZwoJCWNhc2UgJ21vdXNlZG93bic6CgkJCSQuZXh0ZW5kKCBkYXRhLCAkKCBlbGVtICkub2Zmc2V0KCksIHsKCQkJCWVsZW06IGVsZW0sIHRhcmdldDogZXZlbnQudGFyZ2V0LAoJCQkJcGFnZVg6IGV2ZW50LnBhZ2VYLCBwYWdlWTogZXZlbnQucGFnZVkKCQkJCX0pOyAvLyBzdG9yZSBzb21lIGluaXRpYWwgYXR0cmlidXRlcwoJCQkkZXZlbnQuYWRkKCBkb2N1bWVudCwgIm1vdXNlbW92ZSBtb3VzZXVwIiwgaGFuZGxlciwgZGF0YSApOwoJCQlzZWxlY3RhYmxlKCBlbGVtLCBmYWxzZSApOyAvLyBkaXNhYmxlIHRleHQgc2VsZWN0aW9uCgkJCWRyYWcuZHJhZ2dpbmcgPSBudWxsOyAvLyBwZW5kaW5nIHN0YXRlCgkJCWJyZWFrOyAvLyBwcmV2ZW50cyB0ZXh0IHNlbGVjdGlvbiBpbiBzYWZhcmkKCQkvLyBtb3VzZW1vdmUsIGNoZWNrIGRpc3RhbmNlLCBzdGFydCBkcmFnZ2luZwoJCWNhc2UgIWRyYWcuZHJhZ2dpbmcgJiYgJ21vdXNlbW92ZSc6CgkJCWlmICggc3F1YXJlZCggZXZlbnQucGFnZVgtZGF0YS5wYWdlWCApCgkJCQkrIHNxdWFyZWQoIGV2ZW50LnBhZ2VZLWRhdGEucGFnZVkgKSAvLyAgeMKyICsgecKyID0gZGlzdGFuY2XCsgoJCQkJPCBkYXRhLmRpc3RhbmNlICkgYnJlYWs7IC8vIGRpc3RhbmNlIHRvbGVyYW5jZSBub3QgcmVhY2hlZAoJCQlldmVudC50YXJnZXQgPSBkYXRhLnRhcmdldDsgLy8gZm9yY2UgdGFyZ2V0IGZyb20gIm1vdXNlZG93biIgZXZlbnQgKGZpeCBkaXN0YW5jZSBpc3N1ZSkKCQkJcmV0dXJuZWQgPSBoaWphY2soIGV2ZW50LCAiZHJhZ3N0YXJ0IiwgZWxlbSApOyAvLyB0cmlnZ2VyICJkcmFnc3RhcnQiLCByZXR1cm4gcHJveHkgZWxlbWVudAoJCQlpZiAoIHJldHVybmVkICE9PSBmYWxzZSApeyAvLyAiZHJhZ3N0YXJ0IiBub3QgcmVqZWN0ZWQKCQkJCWRyYWcuZHJhZ2dpbmcgPSBlbGVtOyAvLyBhY3RpdmF0ZSBlbGVtZW50CgkJCQlkcmFnLnByb3h5ID0gZXZlbnQuZHJhZ1Byb3h5ID0gJCggcmV0dXJuZWQgfHwgZWxlbSApWzBdOyAvLyBzZXQgcHJveHkKCQkJCX0KCQkvLyBtb3VzZW1vdmUsIGRyYWdnaW5nCgkJY2FzZSAnbW91c2Vtb3ZlJzoKCQkJaWYgKCBkcmFnLmRyYWdnaW5nICl7CgkJCQlyZXR1cm5lZCA9IGhpamFjayggZXZlbnQsICJkcmFnIiwgZWxlbSApOyAvLyB0cmlnZ2VyICJkcmFnIgoJCQkJaWYgKCBkYXRhLmRyb3AgJiYgJHNwZWNpYWwuZHJvcCApeyAvLyBtYW5hZ2UgZHJvcCBldmVudHMKCQkJCQkkc3BlY2lhbC5kcm9wLmFsbG93ZWQgPSAoIHJldHVybmVkICE9PSBmYWxzZSApOyAvLyBwcmV2ZW50IGRyb3AKCQkJCQkkc3BlY2lhbC5kcm9wLmhhbmRsZXIoIGV2ZW50ICk7IC8vICJkcm9wc3RhcnQiLCAiZHJvcGVuZCIKCQkJCQl9CgkJCQlpZiAoIHJldHVybmVkICE9PSBmYWxzZSApIGJyZWFrOyAvLyAiZHJhZyIgbm90IHJlamVjdGVkLCBzdG9wCgkJCQlldmVudC50eXBlID0gIm1vdXNldXAiOyAvLyBoZWxwcyAiZHJvcCIgaGFuZGxlciBiZWhhdmUKCQkJCX0KCQkvLyBtb3VzZXVwLCBzdG9wIGRyYWdnaW5nCgkJY2FzZSAnbW91c2V1cCc6CgkJCSRldmVudC5yZW1vdmUoIGRvY3VtZW50LCAibW91c2Vtb3ZlIG1vdXNldXAiLCBoYW5kbGVyICk7IC8vIHJlbW92ZSBwYWdlIGV2ZW50cwoJCQlpZiAoIGRyYWcuZHJhZ2dpbmcgKXsKCQkJCWlmICggZGF0YS5kcm9wICYmICRzcGVjaWFsLmRyb3AgKSAkc3BlY2lhbC5kcm9wLmhhbmRsZXIoIGV2ZW50ICk7IC8vICJkcm9wIgoJCQkJaGlqYWNrKCBldmVudCwgImRyYWdlbmQiLCBlbGVtICk7IC8vIHRyaWdnZXIgImRyYWdlbmQiCgkJCQl9CgkJCXNlbGVjdGFibGUoIGVsZW0sIHRydWUgKTsgLy8gZW5hYmxlIHRleHQgc2VsZWN0aW9uCgkJCWRyYWcuZHJhZ2dpbmcgPSBkcmFnLnByb3h5ID0gZGF0YS5lbGVtID0gZmFsc2U7IC8vIGRlYWN0aXZhdGUgZWxlbWVudAoJCQlicmVhazsKCQl9Cgl9OwoKLy8gc2V0IGV2ZW50IHR5cGUgdG8gY3VzdG9tIHZhbHVlLCBhbmQgaGFuZGxlIGl0CmZ1bmN0aW9uIGhpamFjayAoIGV2ZW50LCB0eXBlLCBlbGVtICl7CglldmVudC50eXBlID0gdHlwZTsgLy8gZm9yY2UgdGhlIGV2ZW50IHR5cGUKCXZhciByZXN1bHQgPSAoJC5ldmVudC5kaXNwYXRjaCB8fCAkLmV2ZW50LmhhbmRsZSkuY2FsbCggZWxlbSwgZXZlbnQgKTsKCXJldHVybiByZXN1bHQ9PT1mYWxzZSA/IGZhbHNlIDogcmVzdWx0IHx8IGV2ZW50LnJlc3VsdDsKCX07CgovLyByZXR1cm4gdGhlIHZhbHVlIHNxdWFyZWQKZnVuY3Rpb24gc3F1YXJlZCAoIHZhbHVlICl7IHJldHVybiBNYXRoLnBvdyggdmFsdWUsIDIgKTsgfTsKCi8vIHN1cHByZXNzIGRlZmF1bHQgZHJhZ3N0YXJ0IElFIGV2ZW50cy4uLgpmdW5jdGlvbiBkb250U3RhcnQoKXsgcmV0dXJuICggZHJhZy5kcmFnZ2luZyA9PT0gZmFsc2UgKTsgfTsKCi8vIHRvZ2dsZXMgdGV4dCBzZWxlY3Rpb24gYXR0cmlidXRlcwpmdW5jdGlvbiBzZWxlY3RhYmxlICggZWxlbSwgYm9vbCApewoJaWYgKCAhZWxlbSApIHJldHVybjsgLy8gbWF5YmUgZWxlbWVudCB3YXMgcmVtb3ZlZCA/CgllbGVtID0gZWxlbS5vd25lckRvY3VtZW50ID8gZWxlbS5vd25lckRvY3VtZW50IDogZWxlbTsKCWVsZW0udW5zZWxlY3RhYmxlID0gYm9vbCA/ICJvZmYiIDogIm9uIjsgLy8gSUUKCWlmICggZWxlbS5zdHlsZSApIGVsZW0uc3R5bGUuTW96VXNlclNlbGVjdCA9IGJvb2wgPyAiIiA6ICJub25lIjsgLy8gRkYKCSQuZXZlbnRbIGJvb2wgPyAicmVtb3ZlIiA6ICJhZGQiIF0oIGVsZW0sICJzZWxlY3RzdGFydCBtb3VzZWRvd24iLCBkb250U3RhcnQgKTsgLy8gSUUvT3BlcmEKCX07CgovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KfSkoIGpRdWVyeSApOyAvLyBjb25maW5lIHNjb3BlCg=="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,Ly8gU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb3VzZXdoZWVsL2Jsb2IvYTA2ZWY0ZTFhMTI3Nzk1NjA2NjQyYzU1ZTIyZDRmMjk0NWVkYzA2MS9qcXVlcnkubW91c2V3aGVlbC5qcwoKLyohIENvcHlyaWdodCAoYykgMjAxMSBCcmFuZG9uIEFhcm9uIChodHRwOi8vYnJhbmRvbmFhcm9uLm5ldCkKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlIChMSUNFTlNFLnR4dCkuCiAqCiAqIFRoYW5rcyB0bzogaHR0cDovL2Fkb21hcy5vcmcvamF2YXNjcmlwdC1tb3VzZS13aGVlbC8gZm9yIHNvbWUgcG9pbnRlcnMuCiAqIFRoYW5rcyB0bzogTWF0aGlhcyBCYW5rKGh0dHA6Ly93d3cubWF0aGlhcy1iYW5rLmRlKSBmb3IgYSBzY29wZSBidWcgZml4LgogKiBUaGFua3MgdG86IFNlYW11cyBMZWFoeSBmb3IgYWRkaW5nIGRlbHRhWCBhbmQgZGVsdGFZCiAqCiAqIFZlcnNpb246IDMuMC42CiAqCiAqIFJlcXVpcmVzOiAxLjIuMisKICovCgooZnVuY3Rpb24oJCkgewoKdmFyIHR5cGVzID0gWydET01Nb3VzZVNjcm9sbCcsICdtb3VzZXdoZWVsJ107CgppZiAoJC5ldmVudC5maXhIb29rcykgewogICAgZm9yICggdmFyIGk9dHlwZXMubGVuZ3RoOyBpOyApIHsKICAgICAgICAkLmV2ZW50LmZpeEhvb2tzWyB0eXBlc1stLWldIF0gPSAkLmV2ZW50Lm1vdXNlSG9va3M7CiAgICB9Cn0KCiQuZXZlbnQuc3BlY2lhbC5tb3VzZXdoZWVsID0gewogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggdGhpcy5hZGRFdmVudExpc3RlbmVyICkgewogICAgICAgICAgICBmb3IgKCB2YXIgaT10eXBlcy5sZW5ndGg7IGk7ICkgewogICAgICAgICAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKCB0eXBlc1stLWldLCBoYW5kbGVyLCBmYWxzZSApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5vbm1vdXNld2hlZWwgPSBoYW5kbGVyOwogICAgICAgIH0KICAgIH0sCgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyICkgewogICAgICAgICAgICBmb3IgKCB2YXIgaT10eXBlcy5sZW5ndGg7IGk7ICkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlc1stLWldLCBoYW5kbGVyLCBmYWxzZSApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5vbm1vdXNld2hlZWwgPSBudWxsOwogICAgICAgIH0KICAgIH0KfTsKCiQuZm4uZXh0ZW5kKHsKICAgIG1vdXNld2hlZWw6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCJtb3VzZXdoZWVsIiwgZm4pIDogdGhpcy50cmlnZ2VyKCJtb3VzZXdoZWVsIik7CiAgICB9LAoKICAgIHVubW91c2V3aGVlbDogZnVuY3Rpb24oZm4pIHsKICAgICAgICByZXR1cm4gdGhpcy51bmJpbmQoIm1vdXNld2hlZWwiLCBmbik7CiAgICB9Cn0pOwoKCmZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQpIHsKICAgIHZhciBvcmdFdmVudCA9IGV2ZW50IHx8IHdpbmRvdy5ldmVudCwgYXJncyA9IFtdLnNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLCBkZWx0YSA9IDAsIHJldHVyblZhbHVlID0gdHJ1ZSwgZGVsdGFYID0gMCwgZGVsdGFZID0gMDsKICAgIGV2ZW50ID0gJC5ldmVudC5maXgob3JnRXZlbnQpOwogICAgZXZlbnQudHlwZSA9ICJtb3VzZXdoZWVsIjsKCiAgICAvLyBPbGQgc2Nob29sIHNjcm9sbHdoZWVsIGRlbHRhCiAgICBpZiAoIG9yZ0V2ZW50LndoZWVsRGVsdGEgKSB7IGRlbHRhID0gb3JnRXZlbnQud2hlZWxEZWx0YS8xMjA7IH0KICAgIGlmICggb3JnRXZlbnQuZGV0YWlsICAgICApIHsgZGVsdGEgPSAtb3JnRXZlbnQuZGV0YWlsLzM7IH0KCiAgICAvLyBOZXcgc2Nob29sIG11bHRpZGltZW5zaW9uYWwgc2Nyb2xsICh0b3VjaHBhZHMpIGRlbHRhcwogICAgZGVsdGFZID0gZGVsdGE7CgogICAgLy8gR2Vja28KICAgIGlmICggb3JnRXZlbnQuYXhpcyAhPT0gdW5kZWZpbmVkICYmIG9yZ0V2ZW50LmF4aXMgPT09IG9yZ0V2ZW50LkhPUklaT05UQUxfQVhJUyApIHsKICAgICAgICBkZWx0YVkgPSAwOwogICAgICAgIGRlbHRhWCA9IC0xKmRlbHRhOwogICAgfQoKICAgIC8vIFdlYmtpdAogICAgaWYgKCBvcmdFdmVudC53aGVlbERlbHRhWSAhPT0gdW5kZWZpbmVkICkgeyBkZWx0YVkgPSBvcmdFdmVudC53aGVlbERlbHRhWS8xMjA7IH0KICAgIGlmICggb3JnRXZlbnQud2hlZWxEZWx0YVggIT09IHVuZGVmaW5lZCApIHsgZGVsdGFYID0gLTEqb3JnRXZlbnQud2hlZWxEZWx0YVgvMTIwOyB9CgogICAgLy8gQWRkIGV2ZW50IGFuZCBkZWx0YSB0byB0aGUgZnJvbnQgb2YgdGhlIGFyZ3VtZW50cwogICAgYXJncy51bnNoaWZ0KGV2ZW50LCBkZWx0YSwgZGVsdGFYLCBkZWx0YVkpOwoKICAgIHJldHVybiAoJC5ldmVudC5kaXNwYXRjaCB8fCAkLmV2ZW50LmhhbmRsZSkuYXBwbHkodGhpcywgYXJncyk7Cn0KCn0pKGpRdWVyeSk7Cg=="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyoqICMjIGpxdWVyeS5mbG90LmNhbnZhc3dyYXBwZXIKClRoaXMgcGx1Z2luIGNvbnRhaW5zIHRoZSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgYW5kIG1hbmlwdWxhdGluZyBib3RoIHRoZSBjYW52YXMKbGF5ZXJzIGFuZCBzdmcgbGF5ZXJzLgoKVGhlIENhbnZhcyBvYmplY3QgaXMgYSB3cmFwcGVyIGFyb3VuZCBhbiBIVE1MNSBjYW52YXMgdGFnLgpUaGUgY29uc3RydWN0b3IgQ2FudmFzKGNscywgY29udGFpbmVyKSB0YWtlcyBhcyBwYXJhbWV0ZXJzIGNscywKdGhlIGxpc3Qgb2YgY2xhc3NlcyB0byBhcHBseSB0byB0aGUgY2FudmFzIGFkbmQgdGhlIGNvbnRhaW50ZXIsCmVsZW1lbnQgb250byB3aGljaCB0byBhcHBlbmQgdGhlIGNhbnZhcy4gVGhlIGNhbnZhcyBvcGVyYXRpb25zCmRvbid0IHdvcmsgdW5sZXNzIHRoZSBjYW52YXMgaXMgYXR0YWNoZWQgdG8gdGhlIERPTS4KCiMjIyBqcXVlcnkuY2FudmFzd3JhcHBlci5qcyBBUEkgZnVuY3Rpb25zCiovCgooZnVuY3Rpb24oJCkgewogICAgdmFyIENhbnZhcyA9IGZ1bmN0aW9uKGNscywgY29udGFpbmVyKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBjb250YWluZXIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbHMpWzBdOwoKICAgICAgICBpZiAoIWVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsczsKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXJlY3Rpb24gPSAnbHRyJzsKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9ICcwcHgnOwogICAgICAgICAgICBlbGVtZW50LnN0eWxlLnRvcCA9ICcwcHgnOwoKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGVsZW1lbnQpOwoKICAgICAgICAgICAgLy8gSWYgSFRNTDUgQ2FudmFzIGlzbid0IGF2YWlsYWJsZSwgdGhyb3cKCiAgICAgICAgICAgIGlmICghZWxlbWVudC5nZXRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhbnZhcyBpcyBub3QgYXZhaWxhYmxlLicpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoKICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dCA9IGVsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICB0aGlzLnBpeGVsUmF0aW8gPSAkLnBsb3QuYnJvd3Nlci5nZXRQaXhlbFJhdGlvKGNvbnRleHQpOwoKICAgICAgICAvLyBTaXplIHRoZSBjYW52YXMgdG8gbWF0Y2ggdGhlIGludGVybmFsIGRpbWVuc2lvbnMgb2YgaXRzIGNvbnRhaW5lcgogICAgICAgIHZhciB3aWR0aCA9ICQoY29udGFpbmVyKS53aWR0aCgpOwogICAgICAgIHZhciBoZWlnaHQgPSAkKGNvbnRhaW5lcikuaGVpZ2h0KCk7CiAgICAgICAgdGhpcy5yZXNpemUod2lkdGgsIGhlaWdodCk7CgogICAgICAgIC8vIENvbGxlY3Rpb24gb2YgSFRNTCBkaXYgbGF5ZXJzIGZvciB0ZXh0IG92ZXJsYWlkIG9udG8gdGhlIGNhbnZhcwoKICAgICAgICB0aGlzLlNWR0NvbnRhaW5lciA9IG51bGw7CiAgICAgICAgdGhpcy5TVkcgPSB7fTsKCiAgICAgICAgLy8gQ2FjaGUgb2YgdGV4dCBmcmFnbWVudHMgYW5kIG1ldHJpY3MsIHNvIHdlIGNhbiBhdm9pZCBleHBlbnNpdmVseQogICAgICAgIC8vIHJlLWNhbGN1bGF0aW5nIHRoZW0gd2hlbiB0aGUgcGxvdCBpcyByZS1yZW5kZXJlZCBpbiBhIGxvb3AuCgogICAgICAgIHRoaXMuX3RleHRDYWNoZSA9IHt9OwogICAgfQoKICAgIC8qKgogICAgLSByZXNpemUod2lkdGgsIGhlaWdodCkKCiAgICAgUmVzaXplcyB0aGUgY2FudmFzIHRvIHRoZSBnaXZlbiBkaW1lbnNpb25zLgogICAgIFRoZSB3aWR0aCByZXByZXNlbnRzIHRoZSBuZXcgd2lkdGggb2YgdGhlIGNhbnZhcywgbWVhbndoaWxlIHRoZSBoZWlnaHQKICAgICBpcyB0aGUgbmV3IGhlaWdodCBvZiB0aGUgY2FudmFzLCBib3RoIG9mIHRoZW0gaW4gcGl4ZWxzLgogICAgKi8KCiAgICBDYW52YXMucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICB2YXIgbWluU2l6ZSA9IDEwOwogICAgICAgIHdpZHRoID0gd2lkdGggPCBtaW5TaXplID8gbWluU2l6ZSA6IHdpZHRoOwogICAgICAgIGhlaWdodCA9IGhlaWdodCA8IG1pblNpemUgPyBtaW5TaXplIDogaGVpZ2h0OwoKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCwKICAgICAgICAgICAgY29udGV4dCA9IHRoaXMuY29udGV4dCwKICAgICAgICAgICAgcGl4ZWxSYXRpbyA9IHRoaXMucGl4ZWxSYXRpbzsKCiAgICAgICAgLy8gUmVzaXplIHRoZSBjYW52YXMsIGluY3JlYXNpbmcgaXRzIGRlbnNpdHkgYmFzZWQgb24gdGhlIGRpc3BsYXkncwogICAgICAgIC8vIHBpeGVsIHJhdGlvOyBiYXNpY2FsbHkgZ2l2aW5nIGl0IG1vcmUgcGl4ZWxzIHdpdGhvdXQgaW5jcmVhc2luZyB0aGUKICAgICAgICAvLyBzaXplIG9mIGl0cyBlbGVtZW50LCB0byB0YWtlIGFkdmFudGFnZSBvZiB0aGUgZmFjdCB0aGF0IHJldGluYQogICAgICAgIC8vIGRpc3BsYXlzIGhhdmUgdGhhdCBtYW55IG1vcmUgcGl4ZWxzIGluIHRoZSBzYW1lIGFkdmVydGlzZWQgc3BhY2UuCgogICAgICAgIC8vIFJlc2l6aW5nIHNob3VsZCByZXNldCB0aGUgc3RhdGUgKGV4Y2FudmFzIHNlZW1zIHRvIGJlIGJ1Z2d5IHRob3VnaCkKCiAgICAgICAgaWYgKHRoaXMud2lkdGggIT09IHdpZHRoKSB7CiAgICAgICAgICAgIGVsZW1lbnQud2lkdGggPSB3aWR0aCAqIHBpeGVsUmF0aW87CiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmhlaWdodCAhPT0gaGVpZ2h0KSB7CiAgICAgICAgICAgIGVsZW1lbnQuaGVpZ2h0ID0gaGVpZ2h0ICogcGl4ZWxSYXRpbzsKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgKyAncHgnOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICB9CgogICAgICAgIC8vIFNhdmUgdGhlIGNvbnRleHQsIHNvIHdlIGNhbiByZXNldCBpbiBjYXNlIHdlIGdldCByZXBsb3R0ZWQuICBUaGUKICAgICAgICAvLyByZXN0b3JlIGVuc3VyZSB0aGF0IHdlJ3JlIHJlYWxseSBiYWNrIGF0IHRoZSBpbml0aWFsIHN0YXRlLCBhbmQKICAgICAgICAvLyBzaG91bGQgYmUgc2FmZSBldmVuIGlmIHdlIGhhdmVuJ3Qgc2F2ZWQgdGhlIGluaXRpYWwgc3RhdGUgeWV0LgoKICAgICAgICBjb250ZXh0LnJlc3RvcmUoKTsKICAgICAgICBjb250ZXh0LnNhdmUoKTsKCiAgICAgICAgLy8gU2NhbGUgdGhlIGNvb3JkaW5hdGUgc3BhY2UgdG8gbWF0Y2ggdGhlIGRpc3BsYXkgZGVuc2l0eTsgc28gZXZlbiB0aG91Z2ggd2UKICAgICAgICAvLyBtYXkgaGF2ZSB0d2ljZSBhcyBtYW55IHBpeGVscywgd2Ugc3RpbGwgd2FudCBsaW5lcyBhbmQgb3RoZXIgZHJhd2luZyB0bwogICAgICAgIC8vIGFwcGVhciBhdCB0aGUgc2FtZSBzaXplOyB0aGUgZXh0cmEgcGl4ZWxzIHdpbGwganVzdCBtYWtlIHRoZW0gY3Jpc3Blci4KCiAgICAgICAgY29udGV4dC5zY2FsZShwaXhlbFJhdGlvLCBwaXhlbFJhdGlvKTsKICAgIH07CgogICAgLyoqCiAgICAtIGNsZWFyKCkKCiAgICAgQ2xlYXJzIHRoZSBlbnRpcmUgY2FudmFzIGFyZWEsIG5vdCBpbmNsdWRpbmcgYW55IG92ZXJsYWlkIEhUTUwgdGV4dAogICAgKi8KICAgIENhbnZhcy5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgIH07CgogICAgLyoqCiAgICAtIHJlbmRlcigpCgogICAgIEZpbmlzaGVzIHJlbmRlcmluZyB0aGUgY2FudmFzLCBpbmNsdWRpbmcgbWFuYWdpbmcgdGhlIHRleHQgb3ZlcmxheS4KICAgICovCiAgICBDYW52YXMucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjYWNoZSA9IHRoaXMuX3RleHRDYWNoZTsKCiAgICAgICAgLy8gRm9yIGVhY2ggdGV4dCBsYXllciwgYWRkIGVsZW1lbnRzIG1hcmtlZCBhcyBhY3RpdmUgdGhhdCBoYXZlbid0CiAgICAgICAgLy8gYWxyZWFkeSBiZWVuIHJlbmRlcmVkLCBhbmQgcmVtb3ZlIHRob3NlIHRoYXQgYXJlIG5vIGxvbmdlciBhY3RpdmUuCgogICAgICAgIGZvciAodmFyIGxheWVyS2V5IGluIGNhY2hlKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBsYXllcktleSkpIHsKICAgICAgICAgICAgICAgIHZhciBsYXllciA9IHRoaXMuZ2V0U1ZHTGF5ZXIobGF5ZXJLZXkpLAogICAgICAgICAgICAgICAgICAgIGxheWVyQ2FjaGUgPSBjYWNoZVtsYXllcktleV07CgogICAgICAgICAgICAgICAgdmFyIGRpc3BsYXkgPSBsYXllci5zdHlsZS5kaXNwbGF5OwogICAgICAgICAgICAgICAgbGF5ZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBzdHlsZUtleSBpbiBsYXllckNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwobGF5ZXJDYWNoZSwgc3R5bGVLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZUNhY2hlID0gbGF5ZXJDYWNoZVtzdHlsZUtleV07CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzdHlsZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzdHlsZUNhY2hlLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IHN0eWxlQ2FjaGVba2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zID0gdmFsLnBvc2l0aW9uczsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHBvc2l0aW9uOyBwb3NpdGlvbnNbaV07IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwb3NpdGlvbi5yZW5kZXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxheWVyLmFwcGVuZENoaWxkKHBvc2l0aW9uLmVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLnJlbmRlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5zcGxpY2UoaS0tLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NpdGlvbi5yZW5kZXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChwb3NpdGlvbi5lbGVtZW50LmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24uZWxlbWVudC5yZW1vdmVDaGlsZChwb3NpdGlvbi5lbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbi5lbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocG9zaXRpb24uZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwubWVhc3VyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbC5tZWFzdXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHN0eWxlQ2FjaGVba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsYXllci5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAtIGdldFNWR0xheWVyKGNsYXNzZXMpCgogICAgIENyZWF0ZXMgKGlmIG5lY2Vzc2FyeSkgYW5kIHJldHVybnMgdGhlIFNWRyBvdmVybGF5IGNvbnRhaW5lci4KICAgICBUaGUgY2xhc3NlcyBzdHJpbmcgcmVwcmVzZW50cyB0aGUgc3RyaW5nIG9mIHNwYWNlLXNlcGFyYXRlZCBDU1MgY2xhc3NlcwogICAgIHVzZWQgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhlIHRleHQgbGF5ZXIuIEl0IHJldHVybiB0aGUgc3ZnLWxheWVyIGRpdi4KICAgICovCiAgICBDYW52YXMucHJvdG90eXBlLmdldFNWR0xheWVyID0gZnVuY3Rpb24oY2xhc3NlcykgewogICAgICAgIHZhciBsYXllciA9IHRoaXMuU1ZHW2NsYXNzZXNdOwoKICAgICAgICAvLyBDcmVhdGUgdGhlIFNWRyBsYXllciBpZiBpdCBkb2Vzbid0IGV4aXN0CgogICAgICAgIGlmICghbGF5ZXIpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBzdmcgbGF5ZXIgY29udGFpbmVyLCBpZiBpdCBkb2Vzbid0IGV4aXN0CgogICAgICAgICAgICB2YXIgc3ZnRWxlbWVudDsKCiAgICAgICAgICAgIGlmICghdGhpcy5TVkdDb250YWluZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuU1ZHQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB0aGlzLlNWR0NvbnRhaW5lci5jbGFzc05hbWUgPSAnZmxvdC1zdmcnOwogICAgICAgICAgICAgICAgdGhpcy5TVkdDb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnOwogICAgICAgICAgICAgICAgdGhpcy5TVkdDb250YWluZXIuc3R5bGUudG9wID0gJzBweCc7CiAgICAgICAgICAgICAgICB0aGlzLlNWR0NvbnRhaW5lci5zdHlsZS5sZWZ0ID0gJzBweCc7CiAgICAgICAgICAgICAgICB0aGlzLlNWR0NvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7CiAgICAgICAgICAgICAgICB0aGlzLlNWR0NvbnRhaW5lci5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIHRoaXMuU1ZHQ29udGFpbmVyLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQucGFyZW50Tm9kZS5hcHBlbmRDaGlsZCh0aGlzLlNWR0NvbnRhaW5lcik7CgogICAgICAgICAgICAgICAgc3ZnRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLCAnc3ZnJyk7CiAgICAgICAgICAgICAgICBzdmdFbGVtZW50LnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICAgICAgc3ZnRWxlbWVudC5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7CgogICAgICAgICAgICAgICAgdGhpcy5TVkdDb250YWluZXIuYXBwZW5kQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdmdFbGVtZW50ID0gdGhpcy5TVkdDb250YWluZXIuZmlyc3RDaGlsZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywgJ2cnKTsKICAgICAgICAgICAgbGF5ZXIuc2V0QXR0cmlidXRlKCdjbGFzcycsIGNsYXNzZXMpOwogICAgICAgICAgICBsYXllci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGxheWVyLnN0eWxlLnRvcCA9ICcwcHgnOwogICAgICAgICAgICBsYXllci5zdHlsZS5sZWZ0ID0gJzBweCc7CiAgICAgICAgICAgIGxheWVyLnN0eWxlLmJvdHRvbSA9ICcwcHgnOwogICAgICAgICAgICBsYXllci5zdHlsZS5yaWdodCA9ICcwcHgnOwogICAgICAgICAgICBzdmdFbGVtZW50LmFwcGVuZENoaWxkKGxheWVyKTsKICAgICAgICAgICAgdGhpcy5TVkdbY2xhc3Nlc10gPSBsYXllcjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsYXllcjsKICAgIH07CgogICAgLyoqCiAgICAtIGdldFRleHRJbmZvKGxheWVyLCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgpCgogICAgIENyZWF0ZXMgKGlmIG5lY2Vzc2FyeSkgYW5kIHJldHVybnMgYSB0ZXh0IGluZm8gb2JqZWN0LgogICAgIFRoZSBvYmplY3QgbG9va3MgbGlrZSB0aGlzOgogICAgIGBgYGpzCiAgICAgewogICAgICAgICB3aWR0aCAvL1dpZHRoIG9mIHRoZSB0ZXh0J3Mgd3JhcHBlciBkaXYuCiAgICAgICAgIGhlaWdodCAvL0hlaWdodCBvZiB0aGUgdGV4dCdzIHdyYXBwZXIgZGl2LgogICAgICAgICBlbGVtZW50IC8vVGhlIEhUTUwgZGl2IGNvbnRhaW5pbmcgdGhlIHRleHQuCiAgICAgICAgIHBvc2l0aW9ucyAvL0FycmF5IG9mIHBvc2l0aW9ucyBhdCB3aGljaCB0aGlzIHRleHQgaXMgZHJhd24uCiAgICAgIH0KICAgICAgYGBgCiAgICAgIFRoZSBwb3NpdGlvbnMgYXJyYXkgY29udGFpbnMgb2JqZWN0cyB0aGF0IGxvb2sgbGlrZSB0aGlzOgogICAgICBgYGBqcwogICAgICB7CiAgICAgICAgIGFjdGl2ZSAvL0ZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB0ZXh0IHNob3VsZCBiZSB2aXNpYmxlLgogICAgICAgICByZW5kZXJlZCAvL0ZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB0ZXh0IGlzIGN1cnJlbnRseSB2aXNpYmxlLgogICAgICAgICBlbGVtZW50IC8vVGhlIEhUTUwgZGl2IGNvbnRhaW5pbmcgdGhlIHRleHQuCiAgICAgICAgIHRleHQgLy9UaGUgYWN0dWFsIHRleHQgYW5kIGlzIGlkZW50aWNhbCB3aXRoIGVsZW1lbnRbMF0udGV4dENvbnRlbnQuCiAgICAgICAgIHggLy9YIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KICAgICAgICAgeSAvL1kgY29vcmRpbmF0ZSBhdCB3aGljaCB0byBkcmF3IHRoZSB0ZXh0LgogICAgICB9CiAgICAgIGBgYAogICAgICBFYWNoIHBvc2l0aW9uIGFmdGVyIHRoZSBmaXJzdCByZWNlaXZlcyBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50LgogICAgICBUaGUgaWRlYSBpcyB0aGF0IHRoYXQgdGhlIHdpZHRoLCBoZWlnaHQsIGFuZCBnZW5lcmFsICdpZGVudGl0eScgb2YgdGhlCiAgICAgIHRleHQgaXMgY29uc3RhbnQgbm8gbWF0dGVyIHdoZXJlIGl0IGlzIHBsYWNlZDsgdGhlIHBsYWNlbWVudHMgYXJlIGEKICAgICAgc2Vjb25kYXJ5IHByb3BlcnR5LgoKICAgICAgQ2FudmFzIG1haW50YWlucyBhIGNhY2hlIG9mIHJlY2VudGx5LXVzZWQgdGV4dCBpbmZvIG9iamVjdHM7IGdldFRleHRJbmZvCiAgICAgIGVpdGhlciByZXR1cm5zIHRoZSBjYWNoZWQgZWxlbWVudCBvciBjcmVhdGVzIGEgbmV3IGVudHJ5LgoKICAgICBUaGUgbGF5ZXIgcGFyYW1ldGVyIGlzIHN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTIGNsYXNzZXMgdW5pcXVlbHkKICAgICBpZGVudGlmeWluZyB0aGUgbGF5ZXIgY29udGFpbmluZyB0aGlzIHRleHQuCiAgICAgVGV4dCBpcyB0aGUgdGV4dCBzdHJpbmcgdG8gcmV0cmlldmUgaW5mbyBmb3IuCiAgICAgRm9udCBpcyBlaXRoZXIgYSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUyBjbGFzc2VzIG9yIGEgZm9udC1zcGVjIG9iamVjdCwKICAgICBkZWZpbmluZyB0aGUgdGV4dCdzIGZvbnQgYW5kIHN0eWxlLgogICAgIEFuZ2xlIGlzIHRoZSBhbmdsZSBhdCB3aGljaCB0byByb3RhdGUgdGhlIHRleHQsIGluIGRlZ3JlZXMuIEFuZ2xlIGlzIGN1cnJlbnRseSB1bnVzZWQsCiAgICAgaXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiB0aGUgZnV0dXJlLgogICAgIFRoZSBsYXN0IHBhcmFtZXRlciBpcyB0aGUgTWF4aW11bSB3aWR0aCBvZiB0aGUgdGV4dCBiZWZvcmUgaXQgd3JhcHMuCiAgICAgVGhlIG1ldGhvZCByZXR1cm5zIGEgdGV4dCBpbmZvIG9iamVjdC4KICAgICovCiAgICBDYW52YXMucHJvdG90eXBlLmdldFRleHRJbmZvID0gZnVuY3Rpb24obGF5ZXIsIHRleHQsIGZvbnQsIGFuZ2xlLCB3aWR0aCkgewogICAgICAgIHZhciB0ZXh0U3R5bGUsIGxheWVyQ2FjaGUsIHN0eWxlQ2FjaGUsIGluZm87CgogICAgICAgIC8vIENhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLCBpbiBjYXNlIHdlIHdlcmUgZ2l2ZW4gYSBudW1iZXIgb3Igc3VjaAoKICAgICAgICB0ZXh0ID0gJycgKyB0ZXh0OwoKICAgICAgICAvLyBJZiB0aGUgZm9udCBpcyBhIGZvbnQtc3BlYyBvYmplY3QsIGdlbmVyYXRlIGEgQ1NTIGZvbnQgZGVmaW5pdGlvbgoKICAgICAgICBpZiAodHlwZW9mIGZvbnQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHRleHRTdHlsZSA9IGZvbnQuc3R5bGUgKyAnICcgKyBmb250LnZhcmlhbnQgKyAnICcgKyBmb250LndlaWdodCArICcgJyArIGZvbnQuc2l6ZSArICdweC8nICsgZm9udC5saW5lSGVpZ2h0ICsgJ3B4ICcgKyBmb250LmZhbWlseTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0ZXh0U3R5bGUgPSBmb250OwogICAgICAgIH0KCiAgICAgICAgLy8gUmV0cmlldmUgKG9yIGNyZWF0ZSkgdGhlIGNhY2hlIGZvciB0aGUgdGV4dCdzIGxheWVyIGFuZCBzdHlsZXMKCiAgICAgICAgbGF5ZXJDYWNoZSA9IHRoaXMuX3RleHRDYWNoZVtsYXllcl07CgogICAgICAgIGlmIChsYXllckNhY2hlID09IG51bGwpIHsKICAgICAgICAgICAgbGF5ZXJDYWNoZSA9IHRoaXMuX3RleHRDYWNoZVtsYXllcl0gPSB7fTsKICAgICAgICB9CgogICAgICAgIHN0eWxlQ2FjaGUgPSBsYXllckNhY2hlW3RleHRTdHlsZV07CgogICAgICAgIGlmIChzdHlsZUNhY2hlID09IG51bGwpIHsKICAgICAgICAgICAgc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbdGV4dFN0eWxlXSA9IHt9OwogICAgICAgIH0KCiAgICAgICAgdmFyIGtleSA9IGdlbmVyYXRlS2V5KHRleHQpOwogICAgICAgIGluZm8gPSBzdHlsZUNhY2hlW2tleV07CgogICAgICAgIC8vIElmIHdlIGNhbid0IGZpbmQgYSBtYXRjaGluZyBlbGVtZW50IGluIG91ciBjYWNoZSwgY3JlYXRlIGEgbmV3IG9uZQoKICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywgJ3RleHQnKTsKICAgICAgICAgICAgaWYgKHRleHQuaW5kZXhPZignPGJyPicpICE9PSAtMSkgewogICAgICAgICAgICAgICAgYWRkVHNwYW5FbGVtZW50cyh0ZXh0LCBlbGVtZW50LCAtOTk5OSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQodGV4dE5vZGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5tYXhXaWR0aCA9IHdpZHRoOwogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZU5TKG51bGwsICd4JywgLTk5OTkpOwogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZU5TKG51bGwsICd5JywgLTk5OTkpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBmb250ID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5mb250ID0gdGV4dFN0eWxlOwogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5maWxsID0gZm9udC5maWxsOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBmb250ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgZm9udCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2V0U1ZHTGF5ZXIobGF5ZXIpLmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgZWxlbWVudFJlY3QgPSBlbGVtZW50LmdldEJCb3goKTsKCiAgICAgICAgICAgIGluZm8gPSBzdHlsZUNhY2hlW2tleV0gPSB7CiAgICAgICAgICAgICAgICB3aWR0aDogZWxlbWVudFJlY3Qud2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGVsZW1lbnRSZWN0LmhlaWdodCwKICAgICAgICAgICAgICAgIG1lYXN1cmVkOiB0cnVlLAogICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgICAgICAgIHBvc2l0aW9uczogW10KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vcmVtb3ZlIGVsZW1lbnRzIGZyb20gZG9tCiAgICAgICAgICAgIHdoaWxlIChlbGVtZW50LmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQoZWxlbWVudC5maXJzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBpbmZvLm1lYXN1cmVkID0gdHJ1ZTsKICAgICAgICByZXR1cm4gaW5mbzsKICAgIH07CgogICAgZnVuY3Rpb24gdXBkYXRlVHJhbnNmb3JtcyAoZWxlbWVudCwgdHJhbnNmb3JtcykgewogICAgICAgIGVsZW1lbnQudHJhbnNmb3JtLmJhc2VWYWwuY2xlYXIoKTsKICAgICAgICBpZiAodHJhbnNmb3JtcykgewogICAgICAgICAgICB0cmFuc2Zvcm1zLmZvckVhY2goZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgZWxlbWVudC50cmFuc2Zvcm0uYmFzZVZhbC5hcHBlbmRJdGVtKHQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAtIGFkZFRleHQgKGxheWVyLCB4LCB5LCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgsIGhhbGlnbiwgdmFsaWduLCB0cmFuc2Zvcm1zKQoKICAgICBBZGRzIGEgdGV4dCBzdHJpbmcgdG8gdGhlIGNhbnZhcyB0ZXh0IG92ZXJsYXkuCiAgICAgVGhlIHRleHQgaXNuJ3QgZHJhd24gaW1tZWRpYXRlbHk7IGl0IGlzIG1hcmtlZCBhcyByZW5kZXJpbmcsIHdoaWNoIHdpbGwKICAgICByZXN1bHQgaW4gaXRzIGFkZGl0aW9uIHRvIHRoZSBjYW52YXMgb24gdGhlIG5leHQgcmVuZGVyIHBhc3MuCgogICAgIFRoZSBsYXllciBpcyBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUyBjbGFzc2VzIHVuaXF1ZWx5CiAgICAgaWRlbnRpZnlpbmcgdGhlIGxheWVyIGNvbnRhaW5pbmcgdGhpcyB0ZXh0LgogICAgIFggYW5kIFkgcmVwcmVzZW50cyB0aGUgWCBhbmQgWSBjb29yZGluYXRlIGF0IHdoaWNoIHRvIGRyYXcgdGhlIHRleHQuCiAgICAgYW5kIHRleHQgaXMgdGhlIHN0cmluZyB0byBkcmF3CiAgICAqLwogICAgQ2FudmFzLnByb3RvdHlwZS5hZGRUZXh0ID0gZnVuY3Rpb24obGF5ZXIsIHgsIHksIHRleHQsIGZvbnQsIGFuZ2xlLCB3aWR0aCwgaGFsaWduLCB2YWxpZ24sIHRyYW5zZm9ybXMpIHsKICAgICAgICB2YXIgaW5mbyA9IHRoaXMuZ2V0VGV4dEluZm8obGF5ZXIsIHRleHQsIGZvbnQsIGFuZ2xlLCB3aWR0aCksCiAgICAgICAgICAgIHBvc2l0aW9ucyA9IGluZm8ucG9zaXRpb25zOwoKICAgICAgICAvLyBUd2VhayB0aGUgZGl2J3MgcG9zaXRpb24gdG8gbWF0Y2ggdGhlIHRleHQncyBhbGlnbm1lbnQKCiAgICAgICAgaWYgKGhhbGlnbiA9PT0gJ2NlbnRlcicpIHsKICAgICAgICAgICAgeCAtPSBpbmZvLndpZHRoIC8gMjsKICAgICAgICB9IGVsc2UgaWYgKGhhbGlnbiA9PT0gJ3JpZ2h0JykgewogICAgICAgICAgICB4IC09IGluZm8ud2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAodmFsaWduID09PSAnbWlkZGxlJykgewogICAgICAgICAgICB5IC09IGluZm8uaGVpZ2h0IC8gMjsKICAgICAgICB9IGVsc2UgaWYgKHZhbGlnbiA9PT0gJ2JvdHRvbScpIHsKICAgICAgICAgICAgeSAtPSBpbmZvLmhlaWdodDsKICAgICAgICB9CgogICAgICAgIHkgKz0gMC43NSAqIGluZm8uaGVpZ2h0OwoKCiAgICAgICAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgdGhpcyB0ZXh0IGFscmVhZHkgZXhpc3RzIGF0IHRoaXMgcG9zaXRpb24uCiAgICAgICAgLy8gSWYgc28sIG1hcmsgaXQgZm9yIGluY2x1c2lvbiBpbiB0aGUgbmV4dCByZW5kZXIgcGFzcy4KCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHBvc2l0aW9uOyBwb3NpdGlvbnNbaV07IGkrKykgewogICAgICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgaWYgKHBvc2l0aW9uLnggPT09IHggJiYgcG9zaXRpb24ueSA9PT0geSAmJiBwb3NpdGlvbi50ZXh0ID09PSB0ZXh0KSB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbi5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICB1cGRhdGVUcmFuc2Zvcm1zKHBvc2l0aW9uLmVsZW1lbnQsIHRyYW5zZm9ybXMpOwoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmIChwb3NpdGlvbi5hY3RpdmUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbi5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgcG9zaXRpb24udGV4dCA9IHRleHQ7CiAgICAgICAgICAgICAgICBpZiAodGV4dC5pbmRleE9mKCc8YnI+JykgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgeSAtPSAwLjI1ICogaW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgYWRkVHNwYW5FbGVtZW50cyh0ZXh0LCBwb3NpdGlvbi5lbGVtZW50LCB4KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24uZWxlbWVudC50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb3NpdGlvbi5lbGVtZW50LnNldEF0dHJpYnV0ZU5TKG51bGwsICd4JywgeCk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbi5lbGVtZW50LnNldEF0dHJpYnV0ZU5TKG51bGwsICd5JywgeSk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbi54ID0geDsKICAgICAgICAgICAgICAgIHBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICB1cGRhdGVUcmFuc2Zvcm1zKHBvc2l0aW9uLmVsZW1lbnQsIHRyYW5zZm9ybXMpOwoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlIHRleHQgZG9lc24ndCBleGlzdCBhdCB0aGlzIHBvc2l0aW9uLCBjcmVhdGUgYSBuZXcgZW50cnkKCiAgICAgICAgLy8gRm9yIHRoZSB2ZXJ5IGZpcnN0IHBvc2l0aW9uIHdlJ2xsIHJlLXVzZSB0aGUgb3JpZ2luYWwgZWxlbWVudCwKICAgICAgICAvLyB3aGlsZSBmb3Igc3Vic2VxdWVudCBvbmVzIHdlJ2xsIGNsb25lIGl0LgoKICAgICAgICBwb3NpdGlvbiA9IHsKICAgICAgICAgICAgYWN0aXZlOiB0cnVlLAogICAgICAgICAgICByZW5kZXJlZDogZmFsc2UsCiAgICAgICAgICAgIGVsZW1lbnQ6IHBvc2l0aW9ucy5sZW5ndGggPyBpbmZvLmVsZW1lbnQuY2xvbmVOb2RlKCkgOiBpbmZvLmVsZW1lbnQsCiAgICAgICAgICAgIHRleHQ6IHRleHQsCiAgICAgICAgICAgIHg6IHgsCiAgICAgICAgICAgIHk6IHkKICAgICAgICB9OwoKICAgICAgICBwb3NpdGlvbnMucHVzaChwb3NpdGlvbik7CgogICAgICAgIGlmICh0ZXh0LmluZGV4T2YoJzxicj4nKSAhPT0gLTEpIHsKICAgICAgICAgICAgeSAtPSAwLjI1ICogaW5mby5oZWlnaHQ7CiAgICAgICAgICAgIGFkZFRzcGFuRWxlbWVudHModGV4dCwgcG9zaXRpb24uZWxlbWVudCwgeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zaXRpb24uZWxlbWVudC50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgfQoKICAgICAgICAvLyBNb3ZlIHRoZSBlbGVtZW50IHRvIGl0cyBmaW5hbCBwb3NpdGlvbiB3aXRoaW4gdGhlIGNvbnRhaW5lcgogICAgICAgIHBvc2l0aW9uLmVsZW1lbnQuc2V0QXR0cmlidXRlTlMobnVsbCwgJ3gnLCB4KTsKICAgICAgICBwb3NpdGlvbi5lbGVtZW50LnNldEF0dHJpYnV0ZU5TKG51bGwsICd5JywgeSk7CiAgICAgICAgcG9zaXRpb24uZWxlbWVudC5zdHlsZS50ZXh0QWxpZ24gPSBoYWxpZ247CiAgICAgICAgLy8gdXBkYXRlIHRoZSB0cmFuc2Zvcm1zCiAgICAgICAgdXBkYXRlVHJhbnNmb3Jtcyhwb3NpdGlvbi5lbGVtZW50LCB0cmFuc2Zvcm1zKTsKICAgfTsKCiAgICB2YXIgYWRkVHNwYW5FbGVtZW50cyA9IGZ1bmN0aW9uKHRleHQsIGVsZW1lbnQsIHgpIHsKICAgICAgICB2YXIgbGluZXMgPSB0ZXh0LnNwbGl0KCc8YnI+JyksCiAgICAgICAgICAgIHRzcGFuLCBpLCBvZmZzZXQ7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoIWVsZW1lbnQuY2hpbGROb2Rlc1tpXSkgewogICAgICAgICAgICAgICAgdHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywgJ3RzcGFuJyk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHRzcGFuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRzcGFuID0gZWxlbWVudC5jaGlsZE5vZGVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRzcGFuLnRleHRDb250ZW50ID0gbGluZXNbaV07CiAgICAgICAgICAgIG9mZnNldCA9IGkgKiAxICsgJ2VtJzsKICAgICAgICAgICAgdHNwYW4uc2V0QXR0cmlidXRlTlMobnVsbCwgJ2R5Jywgb2Zmc2V0KTsKICAgICAgICAgICAgdHNwYW4uc2V0QXR0cmlidXRlTlMobnVsbCwgJ3gnLCB4KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAtIHJlbW92ZVRleHQgKGxheWVyLCB4LCB5LCB0ZXh0LCBmb250LCBhbmdsZSkKCiAgICAgIFRoZSBmdW5jdGlvbiByZW1vdmVzIG9uZSBvciBtb3JlIHRleHQgc3RyaW5ncyBmcm9tIHRoZSBjYW52YXMgdGV4dCBvdmVybGF5LgogICAgICBJZiBubyBwYXJhbWV0ZXJzIGFyZSBnaXZlbiwgYWxsIHRleHQgd2l0aGluIHRoZSBsYXllciBpcyByZW1vdmVkLgoKICAgICAgTm90ZSB0aGF0IHRoZSB0ZXh0IGlzIG5vdCBpbW1lZGlhdGVseSByZW1vdmVkOyBpdCBpcyBzaW1wbHkgbWFya2VkIGFzCiAgICAgIGluYWN0aXZlLCB3aGljaCB3aWxsIHJlc3VsdCBpbiBpdHMgcmVtb3ZhbCBvbiB0aGUgbmV4dCByZW5kZXIgcGFzcy4KICAgICAgVGhpcyBhdm9pZHMgdGhlIHBlcmZvcm1hbmNlIHBlbmFsdHkgZm9yICdjbGVhciBhbmQgcmVkcmF3JyBiZWhhdmlvciwKICAgICAgd2hlcmUgd2UgcG90ZW50aWFsbHkgZ2V0IHJpZCBvZiBhbGwgdGV4dCBvbiBhIGxheWVyLCBidXQgd2lsbCBsaWtlbHkKICAgICAgYWRkIGJhY2sgbW9zdCBvciBhbGwgb2YgaXQgbGF0ZXIsIGFzIHdoZW4gcmVkcmF3aW5nIGF4ZXMsIGZvciBleGFtcGxlLgoKICAgICAgVGhlIGxheWVyIGlzIGEgc3RyaW5nIG9mIHNwYWNlLXNlcGFyYXRlZCBDU1MgY2xhc3NlcyB1bmlxdWVseQogICAgICBpZGVudGlmeWluZyB0aGUgbGF5ZXIgY29udGFpbmluZyB0aGlzIHRleHQuIFRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyIGFyZQogICAgICBYIGFuZCBZIGNvb3JkaW5hdGUgb2YgdGhlIHRleHQuCiAgICAgIFRleHQgaXMgdGhlIHN0cmluZyB0byByZW1vdmUsIHdoaWxlIHRoZSBmb250IGlzIGVpdGhlciBhIHN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTCiAgICAgIGNsYXNzZXMgb3IgYSBmb250LXNwZWMgb2JqZWN0LCBkZWZpbmluZyB0aGUgdGV4dCdzIGZvbnQgYW5kIHN0eWxlLgogICAgICovCiAgICBDYW52YXMucHJvdG90eXBlLnJlbW92ZVRleHQgPSBmdW5jdGlvbihsYXllciwgeCwgeSwgdGV4dCwgZm9udCwgYW5nbGUpIHsKICAgICAgICB2YXIgaW5mbywgaHRtbFlDb29yZDsKICAgICAgICBpZiAodGV4dCA9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBsYXllckNhY2hlID0gdGhpcy5fdGV4dENhY2hlW2xheWVyXTsKICAgICAgICAgICAgaWYgKGxheWVyQ2FjaGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgc3R5bGVLZXkgaW4gbGF5ZXJDYWNoZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGxheWVyQ2FjaGUsIHN0eWxlS2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbc3R5bGVLZXldOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3R5bGVDYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc3R5bGVDYWNoZSwga2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbnMgPSBzdHlsZUNhY2hlW2tleV0ucG9zaXRpb25zOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5mbyA9IHRoaXMuZ2V0VGV4dEluZm8obGF5ZXIsIHRleHQsIGZvbnQsIGFuZ2xlKTsKICAgICAgICAgICAgcG9zaXRpb25zID0gaW5mby5wb3NpdGlvbnM7CiAgICAgICAgICAgIHBvc2l0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICBodG1sWUNvb3JkID0geSArIDAuNzUgKiBpbmZvLmhlaWdodDsKICAgICAgICAgICAgICAgIGlmIChwb3NpdGlvbi54ID09PSB4ICYmIHBvc2l0aW9uLnkgPT09IGh0bWxZQ29vcmQgJiYgcG9zaXRpb24udGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgLSBjbGVhckNhY2hlKCkKCiAgICAgQ2xlYXJzIHRoZSBjYWNoZSB1c2VkIHRvIHNwZWVkIHVwIHRoZSB0ZXh0IHNpemUgbWVhc3VyZW1lbnRzLgogICAgIEFzIGFuICh1bmZvcnR1bmF0ZSkgc2lkZSBlZmZlY3QgYWxsIHRleHQgd2l0aGluIHRoZSB0ZXh0IExheWVyIGlzIHJlbW92ZWQuCiAgICAgVXNlIHRoaXMgZnVuY3Rpb24gYmVmb3JlIHBsb3Quc2V0dXBHcmlkKCkgYW5kIHBsb3QuZHJhdygpIGlmIHRoZSBwbG90IGp1c3QKICAgICBiZWNhbWUgdmlzaWJsZSBvciB0aGUgc3R5bGVzIGNoYW5nZWQuCiAgICAqLwogICAgQ2FudmFzLnByb3RvdHlwZS5jbGVhckNhY2hlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNhY2hlID0gdGhpcy5fdGV4dENhY2hlOwogICAgICAgIGZvciAodmFyIGxheWVyS2V5IGluIGNhY2hlKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBsYXllcktleSkpIHsKICAgICAgICAgICAgICAgIHZhciBsYXllciA9IHRoaXMuZ2V0U1ZHTGF5ZXIobGF5ZXJLZXkpOwogICAgICAgICAgICAgICAgd2hpbGUgKGxheWVyLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBsYXllci5yZW1vdmVDaGlsZChsYXllci5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuX3RleHRDYWNoZSA9IHt9OwogICAgfTsKCiAgICBmdW5jdGlvbiBnZW5lcmF0ZUtleSh0ZXh0KSB7CiAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSgvMHwxfDJ8M3w0fDV8Nnw3fDh8OS9nLCAnMCcpOwogICAgfQoKICAgIGlmICghd2luZG93LkZsb3QpIHsKICAgICAgICB3aW5kb3cuRmxvdCA9IHt9OwogICAgfQoKICAgIHdpbmRvdy5GbG90LkNhbnZhcyA9IENhbnZhczsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogUGx1Z2luIGZvciBqUXVlcnkgZm9yIHdvcmtpbmcgd2l0aCBjb2xvcnMuCiAqCiAqIFZlcnNpb24gMS4xLgogKgogKiBJbnNwaXJhdGlvbiBmcm9tIGpRdWVyeSBjb2xvciBhbmltYXRpb24gcGx1Z2luIGJ5IEpvaG4gUmVzaWcuCiAqCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBieSBPbGUgTGF1cnNlbiwgT2N0b2JlciAyMDA5LgogKgogKiBFeGFtcGxlczoKICoKICogICAkLmNvbG9yLnBhcnNlKCIjZmZmIikuc2NhbGUoJ3JnYicsIDAuMjUpLmFkZCgnYScsIC0wLjUpLnRvU3RyaW5nKCkKICogICB2YXIgYyA9ICQuY29sb3IuZXh0cmFjdCgkKCIjbXlkaXYiKSwgJ2JhY2tncm91bmQtY29sb3InKTsKICogICBjb25zb2xlLmxvZyhjLnIsIGMuZywgYy5iLCBjLmEpOwogKiAgICQuY29sb3IubWFrZSgxMDAsIDUwLCAyNSwgMC40KS50b1N0cmluZygpIC8vIHJldHVybnMgInJnYmEoMTAwLDUwLDI1LDAuNCkiCiAqCiAqIE5vdGUgdGhhdCAuc2NhbGUoKSBhbmQgLmFkZCgpIHJldHVybiB0aGUgc2FtZSBtb2RpZmllZCBvYmplY3QKICogaW5zdGVhZCBvZiBtYWtpbmcgYSBuZXcgb25lLgogKgogKiBWLiAxLjE6IEZpeCBlcnJvciBoYW5kbGluZyBzbyBlLmcuIHBhcnNpbmcgYW4gZW1wdHkgc3RyaW5nIGRvZXMKICogcHJvZHVjZSBhIGNvbG9yIHJhdGhlciB0aGFuIGp1c3QgY3Jhc2hpbmcuCiAqLwoKKGZ1bmN0aW9uKCQpIHsKICAgICQuY29sb3IgPSB7fTsKCiAgICAvLyBjb25zdHJ1Y3QgY29sb3Igb2JqZWN0IHdpdGggc29tZSBjb252ZW5pZW50IGNoYWluYWJsZSBoZWxwZXJzCiAgICAkLmNvbG9yLm1ha2UgPSBmdW5jdGlvbiAociwgZywgYiwgYSkgewogICAgICAgIHZhciBvID0ge307CiAgICAgICAgby5yID0gciB8fCAwOwogICAgICAgIG8uZyA9IGcgfHwgMDsKICAgICAgICBvLmIgPSBiIHx8IDA7CiAgICAgICAgby5hID0gYSAhPSBudWxsID8gYSA6IDE7CgogICAgICAgIG8uYWRkID0gZnVuY3Rpb24gKGMsIGQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBvW2MuY2hhckF0KGkpXSArPSBkOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gby5ub3JtYWxpemUoKTsKICAgICAgICB9OwoKICAgICAgICBvLnNjYWxlID0gZnVuY3Rpb24gKGMsIGYpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBvW2MuY2hhckF0KGkpXSAqPSBmOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gby5ub3JtYWxpemUoKTsKICAgICAgICB9OwoKICAgICAgICBvLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoby5hID49IDEuMCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJyZ2IoIiArIFtvLnIsIG8uZywgby5iXS5qb2luKCIsIikgKyAiKSI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gInJnYmEoIiArIFtvLnIsIG8uZywgby5iLCBvLmFdLmpvaW4oIiwiKSArICIpIjsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIG8ubm9ybWFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiBjbGFtcChtaW4sIHZhbHVlLCBtYXgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA8IG1pbiA/IG1pbiA6ICh2YWx1ZSA+IG1heCA/IG1heCA6IHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgby5yID0gY2xhbXAoMCwgcGFyc2VJbnQoby5yKSwgMjU1KTsKICAgICAgICAgICAgby5nID0gY2xhbXAoMCwgcGFyc2VJbnQoby5nKSwgMjU1KTsKICAgICAgICAgICAgby5iID0gY2xhbXAoMCwgcGFyc2VJbnQoby5iKSwgMjU1KTsKICAgICAgICAgICAgby5hID0gY2xhbXAoMCwgby5hLCAxKTsKICAgICAgICAgICAgcmV0dXJuIG87CiAgICAgICAgfTsKCiAgICAgICAgby5jbG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICQuY29sb3IubWFrZShvLnIsIG8uYiwgby5nLCBvLmEpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBvLm5vcm1hbGl6ZSgpOwogICAgfQoKICAgIC8vIGV4dHJhY3QgQ1NTIGNvbG9yIHByb3BlcnR5IGZyb20gZWxlbWVudCwgZ29pbmcgdXAgaW4gdGhlIERPTQogICAgLy8gaWYgaXQncyAidHJhbnNwYXJlbnQiCiAgICAkLmNvbG9yLmV4dHJhY3QgPSBmdW5jdGlvbiAoZWxlbSwgY3NzKSB7CiAgICAgICAgdmFyIGM7CgogICAgICAgIGRvIHsKICAgICAgICAgICAgYyA9IGVsZW0uY3NzKGNzcykudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgLy8ga2VlcCBnb2luZyB1bnRpbCB3ZSBmaW5kIGFuIGVsZW1lbnQgdGhhdCBoYXMgY29sb3IsIG9yCiAgICAgICAgICAgIC8vIHdlIGhpdCB0aGUgYm9keSBvciByb290IChoYXZlIG5vIHBhcmVudCkKICAgICAgICAgICAgaWYgKGMgIT09ICcnICYmIGMgIT09ICd0cmFuc3BhcmVudCcpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtID0gZWxlbS5wYXJlbnQoKTsKICAgICAgICB9IHdoaWxlIChlbGVtLmxlbmd0aCAmJiAhJC5ub2RlTmFtZShlbGVtLmdldCgwKSwgImJvZHkiKSk7CgogICAgICAgIC8vIGNhdGNoIFNhZmFyaSdzIHdheSBvZiBzaWduYWxsaW5nIHRyYW5zcGFyZW50CiAgICAgICAgaWYgKGMgPT09ICJyZ2JhKDAsIDAsIDAsIDApIikgewogICAgICAgICAgICBjID0gInRyYW5zcGFyZW50IjsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkLmNvbG9yLnBhcnNlKGMpOwogICAgfQoKICAgIC8vIHBhcnNlIENTUyBjb2xvciBzdHJpbmcgKGxpa2UgInJnYigxMCwgMzIsIDQzKSIgb3IgIiNmZmYiKSwKICAgIC8vIHJldHVybnMgY29sb3Igb2JqZWN0LCBpZiBwYXJzaW5nIGZhaWxlZCwgeW91IGdldCBibGFjayAoMCwgMCwKICAgIC8vIDApIG91dAogICAgJC5jb2xvci5wYXJzZSA9IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICB2YXIgcmVzLCBtID0gJC5jb2xvci5tYWtlOwoKICAgICAgICAvLyBMb29rIGZvciByZ2IobnVtLG51bSxudW0pCiAgICAgICAgcmVzID0gL3JnYlwoXHMqKFswLTldezEsM30pXHMqLFxzKihbMC05XXsxLDN9KVxzKixccyooWzAtOV17MSwzfSlccypcKS8uZXhlYyhzdHIpOwogICAgICAgIGlmIChyZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG0ocGFyc2VJbnQocmVzWzFdLCAxMCksIHBhcnNlSW50KHJlc1syXSwgMTApLCBwYXJzZUludChyZXNbM10sIDEwKSk7CiAgICAgICAgfQoKICAgICAgICAvLyBMb29rIGZvciByZ2JhKG51bSxudW0sbnVtLG51bSkKICAgICAgICByZXMgPSAvcmdiYVwoXHMqKFswLTldezEsM30pXHMqLFxzKihbMC05XXsxLDN9KVxzKixccyooWzAtOV17MSwzfSlccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXHMqXCkvLmV4ZWMoc3RyKQogICAgICAgIGlmIChyZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG0ocGFyc2VJbnQocmVzWzFdLCAxMCksIHBhcnNlSW50KHJlc1syXSwgMTApLCBwYXJzZUludChyZXNbM10sIDEwKSwgcGFyc2VGbG9hdChyZXNbNF0pKTsKICAgICAgICB9CgogICAgICAgIC8vIExvb2sgZm9yIHJnYihudW0lLG51bSUsbnVtJSkKICAgICAgICByZXMgPSAvcmdiXChccyooWzAtOV0rKD86XC5bMC05XSspPyklXHMqLFxzKihbMC05XSsoPzpcLlswLTldKyk/KSVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pJVxzKlwpLy5leGVjKHN0cik7CiAgICAgICAgaWYgKHJlcykgewogICAgICAgICAgICByZXR1cm4gbShwYXJzZUZsb2F0KHJlc1sxXSkgKiAyLjU1LCBwYXJzZUZsb2F0KHJlc1syXSkgKiAyLjU1LCBwYXJzZUZsb2F0KHJlc1szXSkgKiAyLjU1KTsKICAgICAgICB9CgogICAgICAgIC8vIExvb2sgZm9yIHJnYmEobnVtJSxudW0lLG51bSUsbnVtKQogICAgICAgIHJlcyA9IC9yZ2JhXChccyooWzAtOV0rKD86XC5bMC05XSspPyklXHMqLFxzKihbMC05XSsoPzpcLlswLTldKyk/KSVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pJVxzKixccyooWzAtOV0rKD86XC5bMC05XSspPylccypcKS8uZXhlYyhzdHIpOwogICAgICAgIGlmIChyZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG0ocGFyc2VGbG9hdChyZXNbMV0pICogMi41NSwgcGFyc2VGbG9hdChyZXNbMl0pICogMi41NSwgcGFyc2VGbG9hdChyZXNbM10pICogMi41NSwgcGFyc2VGbG9hdChyZXNbNF0pKTsKICAgICAgICB9CgogICAgICAgIC8vIExvb2sgZm9yICNhMGIxYzIKICAgICAgICByZXMgPSAvIyhbYS1mQS1GMC05XXsyfSkoW2EtZkEtRjAtOV17Mn0pKFthLWZBLUYwLTldezJ9KS8uZXhlYyhzdHIpOwogICAgICAgIGlmIChyZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG0ocGFyc2VJbnQocmVzWzFdLCAxNiksIHBhcnNlSW50KHJlc1syXSwgMTYpLCBwYXJzZUludChyZXNbM10sIDE2KSk7CiAgICAgICAgfQoKICAgICAgICAvLyBMb29rIGZvciAjZmZmCiAgICAgICAgcmVzID0gLyMoW2EtZkEtRjAtOV0pKFthLWZBLUYwLTldKShbYS1mQS1GMC05XSkvLmV4ZWMoc3RyKTsKICAgICAgICBpZiAocmVzKSB7CiAgICAgICAgICAgIHJldHVybiBtKHBhcnNlSW50KHJlc1sxXSArIHJlc1sxXSwgMTYpLCBwYXJzZUludChyZXNbMl0gKyByZXNbMl0sIDE2KSwgcGFyc2VJbnQocmVzWzNdICsgcmVzWzNdLCAxNikpOwogICAgICAgIH0KCiAgICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSdyZSBtb3N0IGxpa2VseSBkZWFsaW5nIHdpdGggYSBuYW1lZCBjb2xvcgogICAgICAgIHZhciBuYW1lID0gJC50cmltKHN0cikudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAobmFtZSA9PT0gInRyYW5zcGFyZW50IikgewogICAgICAgICAgICByZXR1cm4gbSgyNTUsIDI1NSwgMjU1LCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBkZWZhdWx0IHRvIGJsYWNrCiAgICAgICAgICAgIHJlcyA9IGxvb2t1cENvbG9yc1tuYW1lXSB8fCBbMCwgMCwgMF07CiAgICAgICAgICAgIHJldHVybiBtKHJlc1swXSwgcmVzWzFdLCByZXNbMl0pOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgbG9va3VwQ29sb3JzID0gewogICAgICAgIGFxdWE6IFswLCAyNTUsIDI1NV0sCiAgICAgICAgYXp1cmU6IFsyNDAsIDI1NSwgMjU1XSwKICAgICAgICBiZWlnZTogWzI0NSwgMjQ1LCAyMjBdLAogICAgICAgIGJsYWNrOiBbMCwgMCwgMF0sCiAgICAgICAgYmx1ZTogWzAsIDAsIDI1NV0sCiAgICAgICAgYnJvd246IFsxNjUsIDQyLCA0Ml0sCiAgICAgICAgY3lhbjogWzAsIDI1NSwgMjU1XSwKICAgICAgICBkYXJrYmx1ZTogWzAsIDAsIDEzOV0sCiAgICAgICAgZGFya2N5YW46IFswLCAxMzksIDEzOV0sCiAgICAgICAgZGFya2dyZXk6IFsxNjksIDE2OSwgMTY5XSwKICAgICAgICBkYXJrZ3JlZW46IFswLCAxMDAsIDBdLAogICAgICAgIGRhcmtraGFraTogWzE4OSwgMTgzLCAxMDddLAogICAgICAgIGRhcmttYWdlbnRhOiBbMTM5LCAwLCAxMzldLAogICAgICAgIGRhcmtvbGl2ZWdyZWVuOiBbODUsIDEwNywgNDddLAogICAgICAgIGRhcmtvcmFuZ2U6IFsyNTUsIDE0MCwgMF0sCiAgICAgICAgZGFya29yY2hpZDogWzE1MywgNTAsIDIwNF0sCiAgICAgICAgZGFya3JlZDogWzEzOSwgMCwgMF0sCiAgICAgICAgZGFya3NhbG1vbjogWzIzMywgMTUwLCAxMjJdLAogICAgICAgIGRhcmt2aW9sZXQ6IFsxNDgsIDAsIDIxMV0sCiAgICAgICAgZnVjaHNpYTogWzI1NSwgMCwgMjU1XSwKICAgICAgICBnb2xkOiBbMjU1LCAyMTUsIDBdLAogICAgICAgIGdyZWVuOiBbMCwgMTI4LCAwXSwKICAgICAgICBpbmRpZ286IFs3NSwgMCwgMTMwXSwKICAgICAgICBraGFraTogWzI0MCwgMjMwLCAxNDBdLAogICAgICAgIGxpZ2h0Ymx1ZTogWzE3MywgMjE2LCAyMzBdLAogICAgICAgIGxpZ2h0Y3lhbjogWzIyNCwgMjU1LCAyNTVdLAogICAgICAgIGxpZ2h0Z3JlZW46IFsxNDQsIDIzOCwgMTQ0XSwKICAgICAgICBsaWdodGdyZXk6IFsyMTEsIDIxMSwgMjExXSwKICAgICAgICBsaWdodHBpbms6IFsyNTUsIDE4MiwgMTkzXSwKICAgICAgICBsaWdodHllbGxvdzogWzI1NSwgMjU1LCAyMjRdLAogICAgICAgIGxpbWU6IFswLCAyNTUsIDBdLAogICAgICAgIG1hZ2VudGE6IFsyNTUsIDAsIDI1NV0sCiAgICAgICAgbWFyb29uOiBbMTI4LCAwLCAwXSwKICAgICAgICBuYXZ5OiBbMCwgMCwgMTI4XSwKICAgICAgICBvbGl2ZTogWzEyOCwgMTI4LCAwXSwKICAgICAgICBvcmFuZ2U6IFsyNTUsIDE2NSwgMF0sCiAgICAgICAgcGluazogWzI1NSwgMTkyLCAyMDNdLAogICAgICAgIHB1cnBsZTogWzEyOCwgMCwgMTI4XSwKICAgICAgICB2aW9sZXQ6IFsxMjgsIDAsIDEyOF0sCiAgICAgICAgcmVkOiBbMjU1LCAwLCAwXSwKICAgICAgICBzaWx2ZXI6IFsxOTIsIDE5MiwgMTkyXSwKICAgICAgICB3aGl0ZTogWzI1NSwgMjU1LCAyNTVdLAogICAgICAgIHllbGxvdzogWzI1NSwgMjU1LCAwXQogICAgfTsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogSmF2YXNjcmlwdCBwbG90dGluZyBsaWJyYXJ5IGZvciBqUXVlcnksIHZlcnNpb24gMy4wLjAuCgpDb3B5cmlnaHQgKGMpIDIwMDctMjAxNCBJT0xBIGFuZCBPbGUgTGF1cnNlbi4KTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoKKi8KCi8vIHRoZSBhY3R1YWwgRmxvdCBjb2RlCihmdW5jdGlvbigkKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIENhbnZhcyA9IHdpbmRvdy5GbG90LkNhbnZhczsKCiAgICBmdW5jdGlvbiBkZWZhdWx0VGlja0dlbmVyYXRvcihheGlzKSB7CiAgICAgICAgdmFyIHRpY2tzID0gW10sCiAgICAgICAgICAgIHN0YXJ0ID0gJC5wbG90LnNhdHVyYXRlZC5zYXR1cmF0ZSgkLnBsb3Quc2F0dXJhdGVkLmZsb29ySW5CYXNlKGF4aXMubWluLCBheGlzLnRpY2tTaXplKSksCiAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICB2ID0gTnVtYmVyLk5hTiwKICAgICAgICAgICAgcHJldjsKCiAgICAgICAgaWYgKHN0YXJ0ID09PSAtTnVtYmVyLk1BWF9WQUxVRSkgewogICAgICAgICAgICB0aWNrcy5wdXNoKHN0YXJ0KTsKICAgICAgICAgICAgc3RhcnQgPSAkLnBsb3Quc2F0dXJhdGVkLmZsb29ySW5CYXNlKGF4aXMubWluICsgYXhpcy50aWNrU2l6ZSwgYXhpcy50aWNrU2l6ZSk7CiAgICAgICAgfQoKICAgICAgICBkbyB7CiAgICAgICAgICAgIHByZXYgPSB2OwogICAgICAgICAgICAvL3YgPSBzdGFydCArIGkgKiBheGlzLnRpY2tTaXplOwogICAgICAgICAgICB2ID0gJC5wbG90LnNhdHVyYXRlZC5tdWx0aXBseUFkZChheGlzLnRpY2tTaXplLCBpLCBzdGFydCk7CiAgICAgICAgICAgIHRpY2tzLnB1c2godik7CiAgICAgICAgICAgICsraTsKICAgICAgICB9IHdoaWxlICh2IDwgYXhpcy5tYXggJiYgdiAhPT0gcHJldik7CgogICAgICAgIHJldHVybiB0aWNrczsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWZhdWx0VGlja0Zvcm1hdHRlcih2YWx1ZSwgYXhpcywgcHJlY2lzaW9uKSB7CiAgICAgICAgdmFyIG9sZFRpY2tEZWNpbWFscyA9IGF4aXMudGlja0RlY2ltYWxzLAogICAgICAgICAgICBleHBQb3NpdGlvbiA9ICgiIiArIHZhbHVlKS5pbmRleE9mKCJlIik7CgogICAgICAgIGlmIChleHBQb3NpdGlvbiAhPT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIGV4cFJlcFRpY2tGb3JtYXR0ZXIodmFsdWUsIGF4aXMsIHByZWNpc2lvbik7CiAgICAgICAgfQoKICAgICAgICBpZiAocHJlY2lzaW9uID4gMCkgewogICAgICAgICAgICBheGlzLnRpY2tEZWNpbWFscyA9IHByZWNpc2lvbjsKICAgICAgICB9CgogICAgICAgIHZhciBmYWN0b3IgPSBheGlzLnRpY2tEZWNpbWFscyA/IHBhcnNlRmxvYXQoJzFlJyArIGF4aXMudGlja0RlY2ltYWxzKSA6IDEsCiAgICAgICAgICAgIGZvcm1hdHRlZCA9ICIiICsgTWF0aC5yb3VuZCh2YWx1ZSAqIGZhY3RvcikgLyBmYWN0b3I7CgogICAgICAgIC8vIElmIHRpY2tEZWNpbWFscyB3YXMgc3BlY2lmaWVkLCBlbnN1cmUgdGhhdCB3ZSBoYXZlIGV4YWN0bHkgdGhhdAogICAgICAgIC8vIG11Y2ggcHJlY2lzaW9uOyBvdGhlcndpc2UgZGVmYXVsdCB0byB0aGUgdmFsdWUncyBvd24gcHJlY2lzaW9uLgogICAgICAgIGlmIChheGlzLnRpY2tEZWNpbWFscyAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWNpbWFsID0gZm9ybWF0dGVkLmluZGV4T2YoIi4iKSwKICAgICAgICAgICAgICAgIGRlY2ltYWxQcmVjaXNpb24gPSBkZWNpbWFsID09PSAtMSA/IDAgOiBmb3JtYXR0ZWQubGVuZ3RoIC0gZGVjaW1hbCAtIDE7CiAgICAgICAgICAgIGlmIChkZWNpbWFsUHJlY2lzaW9uIDwgYXhpcy50aWNrRGVjaW1hbHMpIHsKICAgICAgICAgICAgICAgIHZhciBkZWNpbWFscyA9ICgiIiArIGZhY3Rvcikuc3Vic3RyKDEsIGF4aXMudGlja0RlY2ltYWxzIC0gZGVjaW1hbFByZWNpc2lvbik7CiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgPSAoZGVjaW1hbFByZWNpc2lvbiA/IGZvcm1hdHRlZCA6IGZvcm1hdHRlZCArICIuIikgKyBkZWNpbWFsczsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXhpcy50aWNrRGVjaW1hbHMgPSBvbGRUaWNrRGVjaW1hbHM7CiAgICAgICAgcmV0dXJuIGZvcm1hdHRlZDsKICAgIH07CgogICAgZnVuY3Rpb24gZXhwUmVwVGlja0Zvcm1hdHRlcih2YWx1ZSwgYXhpcywgcHJlY2lzaW9uKSB7CiAgICAgICAgdmFyIGV4cFBvc2l0aW9uID0gKCIiICsgdmFsdWUpLmluZGV4T2YoImUiKSwKICAgICAgICAgICAgZXhwb25lbnRWYWx1ZSA9IHBhcnNlSW50KCgiIiArIHZhbHVlKS5zdWJzdHIoZXhwUG9zaXRpb24gKyAxKSksCiAgICAgICAgICAgIHRlbkV4cG9uZW50ID0gZXhwUG9zaXRpb24gIT09IC0xID8gZXhwb25lbnRWYWx1ZSA6ICh2YWx1ZSA+IDAgPyBNYXRoLmZsb29yKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4xMCkgOiAwKSwKICAgICAgICAgICAgcm91bmRXaXRoID0gcGFyc2VGbG9hdCgnMWUnICsgdGVuRXhwb25lbnQpLAogICAgICAgICAgICB4ID0gdmFsdWUgLyByb3VuZFdpdGg7CgogICAgICAgIGlmIChwcmVjaXNpb24pIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZWRQcmVjaXNpb24gPSByZWNvbXB1dGVQcmVjaXNpb24odmFsdWUsIHByZWNpc2lvbik7CiAgICAgICAgICAgIHJldHVybiAodmFsdWUgLyByb3VuZFdpdGgpLnRvRml4ZWQodXBkYXRlZFByZWNpc2lvbikgKyAnZScgKyB0ZW5FeHBvbmVudDsKICAgICAgICB9CgogICAgICAgIGlmIChheGlzLnRpY2tEZWNpbWFscyA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIHgudG9GaXhlZChyZWNvbXB1dGVQcmVjaXNpb24odmFsdWUsIGF4aXMudGlja0RlY2ltYWxzKSkgKyAnZScgKyB0ZW5FeHBvbmVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHgudG9GaXhlZCgpICsgJ2UnICsgdGVuRXhwb25lbnQ7CiAgICB9CgogICAgZnVuY3Rpb24gcmVjb21wdXRlUHJlY2lzaW9uKG51bSwgcHJlY2lzaW9uKSB7CiAgICAgICAgLy9mb3IgbnVtYmVycyBjbG9zZSB0byB6ZXJvLCB0aGUgcHJlY2lzaW9uIGZyb20gZmxvdCB3aWxsIGJlIGEgYmlnIG51bWJlcgogICAgICAgIC8vd2hpbGUgZm9yIGJpZyBudW1iZXJzLCB0aGUgcHJlY2lzaW9uIHdpbGwgYmUgbmVnYXRpdmUKICAgICAgICB2YXIgbG9nMTBWYWx1ZSA9IE1hdGgubG9nKE1hdGguYWJzKG51bSkpICogTWF0aC5MT0cxMEUsCiAgICAgICAgICAgIG5ld1ByZWNpc2lvbiA9IE1hdGguYWJzKGxvZzEwVmFsdWUgKyBwcmVjaXNpb24pOwoKICAgICAgICByZXR1cm4gbmV3UHJlY2lzaW9uIDw9IDIwID8gTWF0aC5mbG9vcihuZXdQcmVjaXNpb24pIDogMjA7CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBUaGUgdG9wLWxldmVsIGNvbnRhaW5lciBmb3IgdGhlIGVudGlyZSBwbG90LgogICAgZnVuY3Rpb24gUGxvdChwbGFjZWhvbGRlciwgZGF0YV8sIG9wdGlvbnNfLCBwbHVnaW5zKSB7CiAgICAgICAgLy8gZGF0YSBpcyBvbiB0aGUgZm9ybToKICAgICAgICAvLyAgIFsgc2VyaWVzMSwgc2VyaWVzMiAuLi4gXQogICAgICAgIC8vIHdoZXJlIHNlcmllcyBpcyBlaXRoZXIganVzdCB0aGUgZGF0YSBhcyBbIFt4MSwgeTFdLCBbeDIsIHkyXSwgLi4uIF0KICAgICAgICAvLyBvciB7IGRhdGE6IFsgW3gxLCB5MV0sIFt4MiwgeTJdLCAuLi4gXSwgbGFiZWw6ICJzb21lIGxhYmVsIiwgLi4uIH0KCiAgICAgICAgdmFyIHNlcmllcyA9IFtdLAogICAgICAgICAgICBvcHRpb25zID0gewogICAgICAgICAgICAgICAgLy8gdGhlIGNvbG9yIHRoZW1lIHVzZWQgZm9yIGdyYXBocwogICAgICAgICAgICAgICAgY29sb3JzOiBbIiNlZGMyNDAiLCAiI2FmZDhmOCIsICIjY2I0YjRiIiwgIiM0ZGE3NGQiLCAiIzk0NDBlZCJdLAogICAgICAgICAgICAgICAgeGF4aXM6IHsKICAgICAgICAgICAgICAgICAgICBzaG93OiBudWxsLCAvLyBudWxsID0gYXV0by1kZXRlY3QsIHRydWUgPSBhbHdheXMsIGZhbHNlID0gbmV2ZXIKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogImJvdHRvbSIsIC8vIG9yICJ0b3AiCiAgICAgICAgICAgICAgICAgICAgbW9kZTogbnVsbCwgLy8gbnVsbCBvciAidGltZSIKICAgICAgICAgICAgICAgICAgICBmb250OiBudWxsLCAvLyBudWxsIChkZXJpdmVkIGZyb20gQ1NTIGluIHBsYWNlaG9sZGVyKSBvciBvYmplY3QgbGlrZSB7IHNpemU6IDExLCBsaW5lSGVpZ2h0OiAxMywgc3R5bGU6ICJpdGFsaWMiLCB3ZWlnaHQ6ICJib2xkIiwgZmFtaWx5OiAic2Fucy1zZXJpZiIsIHZhcmlhbnQ6ICJzbWFsbC1jYXBzIiB9CiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG51bGwsIC8vIGJhc2UgY29sb3IsIGxhYmVscywgdGlja3MKICAgICAgICAgICAgICAgICAgICB0aWNrQ29sb3I6IG51bGwsIC8vIHBvc3NpYmx5IGRpZmZlcmVudCBjb2xvciBvZiB0aWNrcywgZS5nLiAicmdiYSgwLDAsMCwwLjE1KSIKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IG51bGwsIC8vIG51bGwgb3IgZjogbnVtYmVyIC0+IG51bWJlciB0byB0cmFuc2Zvcm0gYXhpcwogICAgICAgICAgICAgICAgICAgIGludmVyc2VUcmFuc2Zvcm06IG51bGwsIC8vIGlmIHRyYW5zZm9ybSBpcyBzZXQsIHRoaXMgc2hvdWxkIGJlIHRoZSBpbnZlcnNlIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgbWluOiBudWxsLCAvLyBtaW4uIHZhbHVlIHRvIHNob3csIG51bGwgbWVhbnMgc2V0IGF1dG9tYXRpY2FsbHkKICAgICAgICAgICAgICAgICAgICBtYXg6IG51bGwsIC8vIG1heC4gdmFsdWUgdG8gc2hvdywgbnVsbCBtZWFucyBzZXQgYXV0b21hdGljYWxseQogICAgICAgICAgICAgICAgICAgIGF1dG9TY2FsZU1hcmdpbjogbnVsbCwgLy8gbWFyZ2luIGluICUgdG8gYWRkIGlmIGF1dG9TY2FsZSBvcHRpb24gaXMgb24gImxvb3NlIiBtb2RlLAogICAgICAgICAgICAgICAgICAgIGF1dG9TY2FsZTogImV4YWN0IiwgLy8gQXZhaWxhYmxlIG1vZGVzOiAibm9uZSIsICJsb29zZSIsICJleGFjdCIsICJzbGlkaW5nLXdpbmRvdyIKICAgICAgICAgICAgICAgICAgICB3aW5kb3dTaXplOiBudWxsLCAvLyBudWxsIG9yIG51bWJlci4gVGhpcyBpcyB0aGUgc2l6ZSBvZiBzbGlkaW5nLXdpbmRvdy4KICAgICAgICAgICAgICAgICAgICBncm93T25seTogbnVsbCwgLy8gZ3JvdyBvbmx5LCB1c2VmdWwgZm9yIHNtb290aGVyIGF1dG8tc2NhbGUsIHRoZSBzY2FsZXMgd2lsbCBncm93IHRvIGFjY29tb2RhdGUgZGF0YSBidXQgd29uJ3Qgc2hyaW5rIGJhY2suCiAgICAgICAgICAgICAgICAgICAgdGlja3M6IG51bGwsIC8vIGVpdGhlciBbMSwgM10gb3IgW1sxLCAiYSJdLCAzXSBvciAoZm46IGF4aXMgaW5mbyAtPiB0aWNrcykgb3IgYXBwLiBudW1iZXIgb2YgdGlja3MgZm9yIGF1dG8tdGlja3MKICAgICAgICAgICAgICAgICAgICB0aWNrRm9ybWF0dGVyOiBudWxsLCAvLyBmbjogbnVtYmVyIC0+IHN0cmluZwogICAgICAgICAgICAgICAgICAgIHNob3dUaWNrTGFiZWxzOiAibWFqb3IiLCAvLyAibm9uZSIsICJlbmRwb2ludHMiLCAibWFqb3IiLCAiYWxsIgogICAgICAgICAgICAgICAgICAgIGxhYmVsV2lkdGg6IG51bGwsIC8vIHNpemUgb2YgdGljayBsYWJlbHMgaW4gcGl4ZWxzCiAgICAgICAgICAgICAgICAgICAgbGFiZWxIZWlnaHQ6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgcmVzZXJ2ZVNwYWNlOiBudWxsLCAvLyB3aGV0aGVyIHRvIHJlc2VydmUgc3BhY2UgZXZlbiBpZiBheGlzIGlzbid0IHNob3duCiAgICAgICAgICAgICAgICAgICAgdGlja0xlbmd0aDogbnVsbCwgLy8gc2l6ZSBpbiBwaXhlbHMgb2YgbWFqb3IgdGljayBtYXJrcwogICAgICAgICAgICAgICAgICAgIHNob3dNaW5vclRpY2tzOiBudWxsLCAvLyB0cnVlID0gc2hvdyBtaW5vciB0aWNrIG1hcmtzLCBmYWxzZSA9IGhpZGUgbWlub3IgdGljayBtYXJrcwogICAgICAgICAgICAgICAgICAgIHNob3dUaWNrczogbnVsbCwgLy8gdHJ1ZSA9IHNob3cgdGljayBtYXJrcywgZmFsc2UgPSBoaWRlIGFsbCB0aWNrIG1hcmtzCiAgICAgICAgICAgICAgICAgICAgZ3JpZExpbmVzOiBudWxsLCAvLyB0cnVlID0gc2hvdyBncmlkIGxpbmVzLCBmYWxzZSA9IGhpZGUgZ3JpZCBsaW5lcwogICAgICAgICAgICAgICAgICAgIGFsaWduVGlja3NXaXRoQXhpczogbnVsbCwgLy8gYXhpcyBudW1iZXIgb3IgbnVsbCBmb3Igbm8gc3luYwogICAgICAgICAgICAgICAgICAgIHRpY2tEZWNpbWFsczogbnVsbCwgLy8gbm8uIG9mIGRlY2ltYWxzLCBudWxsIG1lYW5zIGF1dG8KICAgICAgICAgICAgICAgICAgICB0aWNrU2l6ZTogbnVsbCwgLy8gbnVtYmVyIG9yIFtudW1iZXIsICJ1bml0Il0KICAgICAgICAgICAgICAgICAgICBtaW5UaWNrU2l6ZTogbnVsbCwgLy8gbnVtYmVyIG9yIFtudW1iZXIsICJ1bml0Il0KICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IHsgYmVsb3c6IDAsIGFib3ZlOiAwIH0sIC8vIHRoZSBwbG90IGRyYXdpbmcgb2Zmc2V0LiB0aGlzIGlzIGNhbGN1bGF0ZWQgYnkgdGhlIGZsb3QubmF2aWdhdGUgZm9yIGVhY2ggYXhpcwogICAgICAgICAgICAgICAgICAgIGJveFBvc2l0aW9uOiB7IGNlbnRlclg6IDAsIGNlbnRlclk6IDAgfSAvL3Bvc2l0aW9uIG9mIHRoZSBheGlzIG9uIHRoZSBjb3JyZXNwb25kaW5nIGF4aXMgYm94CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgeWF4aXM6IHsKICAgICAgICAgICAgICAgICAgICBhdXRvU2NhbGVNYXJnaW46IDAuMDIsIC8vIG1hcmdpbiBpbiAlIHRvIGFkZCBpZiBhdXRvU2NhbGUgb3B0aW9uIGlzIG9uICJsb29zZSIgbW9kZQogICAgICAgICAgICAgICAgICAgIGF1dG9TY2FsZTogImxvb3NlIiwgLy8gQXZhaWxhYmxlIG1vZGVzOiAibm9uZSIsICJsb29zZSIsICJleGFjdCIKICAgICAgICAgICAgICAgICAgICBncm93T25seTogbnVsbCwgLy8gZ3JvdyBvbmx5LCB1c2VmdWwgZm9yIHNtb290aGVyIGF1dG8tc2NhbGUsIHRoZSBzY2FsZXMgd2lsbCBncm93IHRvIGFjY29tb2RhdGUgZGF0YSBidXQgd29uJ3Qgc2hyaW5rIGJhY2suCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJsZWZ0IiwgLy8gb3IgInJpZ2h0IgogICAgICAgICAgICAgICAgICAgIHNob3dUaWNrTGFiZWxzOiAibWFqb3IiLCAvLyAibm9uZSIsICJlbmRwb2ludHMiLCAibWFqb3IiLCAiYWxsIgogICAgICAgICAgICAgICAgICAgIG9mZnNldDogeyBiZWxvdzogMCwgYWJvdmU6IDAgfSwgLy8gdGhlIHBsb3QgZHJhd2luZyBvZmZzZXQuIHRoaXMgaXMgY2FsY3VsYXRlZCBieSB0aGUgZmxvdC5uYXZpZ2F0ZSBmb3IgZWFjaCBheGlzCiAgICAgICAgICAgICAgICAgICAgYm94UG9zaXRpb246IHsgY2VudGVyWDogMCwgY2VudGVyWTogMCB9IC8vcG9zaXRpb24gb2YgdGhlIGF4aXMgb24gdGhlIGNvcnJlc3BvbmRpbmcgYXhpcyBib3gKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB4YXhlczogW10sCiAgICAgICAgICAgICAgICB5YXhlczogW10sCiAgICAgICAgICAgICAgICBzZXJpZXM6IHsKICAgICAgICAgICAgICAgICAgICBwb2ludHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdzogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIHJhZGl1czogMywKICAgICAgICAgICAgICAgICAgICAgICAgbGluZVdpZHRoOiAyLCAvLyBpbiBwaXhlbHMKICAgICAgICAgICAgICAgICAgICAgICAgZmlsbDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmlsbENvbG9yOiAiI2ZmZmZmZiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHN5bWJvbDogJ2NpcmNsZScgLy8gb3IgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGxpbmVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGRvbid0IHB1dCBpbiBzaG93OiBmYWxzZSBzbyB3ZSBjYW4gc2VlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdoZXRoZXIgbGluZXMgd2VyZSBhY3RpdmVseSBkaXNhYmxlZAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lV2lkdGg6IDEsIC8vIGluIHBpeGVscwogICAgICAgICAgICAgICAgICAgICAgICBmaWxsOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmlsbENvbG9yOiBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICBzdGVwczogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT21pdCAnemVybycsIHNvIHdlIGNhbiBsYXRlciBkZWZhdWx0IGl0cyB2YWx1ZSB0bwogICAgICAgICAgICAgICAgICAgICAgICAvLyBtYXRjaCB0aGF0IG9mIHRoZSAnZmlsbCcgb3B0aW9uLgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgYmFyczogewogICAgICAgICAgICAgICAgICAgICAgICBzaG93OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgbGluZVdpZHRoOiAyLCAvLyBpbiBwaXhlbHMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmFyV2lkdGg6IG51bWJlciBvciBbbnVtYmVyLCBhYnNvbHV0ZV0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiAnYWJzb2x1dGUnIGlzIGZhbHNlLCAnbnVtYmVyJyBpcyByZWxhdGl2ZSB0byB0aGUgbWluaW11bSBkaXN0YW5jZSBiZXR3ZWVuIHBvaW50cyBmb3IgdGhlIHNlcmllcwogICAgICAgICAgICAgICAgICAgICAgICAvLyB3aGVuICdhYnNvbHV0ZScgaXMgdHJ1ZSwgJ251bWJlcicgaXMgY29uc2lkZXJlZCB0byBiZSBpbiB1bml0cyBvZiB0aGUgeC1heGlzCiAgICAgICAgICAgICAgICAgICAgICAgIGhvcml6b250YWw6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBiYXJXaWR0aDogMC44LAogICAgICAgICAgICAgICAgICAgICAgICBmaWxsOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBmaWxsQ29sb3I6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduOiAibGVmdCIsIC8vICJsZWZ0IiwgInJpZ2h0Iiwgb3IgImNlbnRlciIKICAgICAgICAgICAgICAgICAgICAgICAgemVybzogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2hhZG93U2l6ZTogMywKICAgICAgICAgICAgICAgICAgICBoaWdobGlnaHRDb2xvcjogbnVsbAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGdyaWQ6IHsKICAgICAgICAgICAgICAgICAgICBzaG93OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGFib3ZlRGF0YTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6ICIjNTQ1NDU0IiwgLy8gcHJpbWFyeSBjb2xvciB1c2VkIGZvciBvdXRsaW5lIGFuZCBsYWJlbHMKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG51bGwsIC8vIG51bGwgZm9yIHRyYW5zcGFyZW50LCBlbHNlIGNvbG9yCiAgICAgICAgICAgICAgICAgICAgYm9yZGVyQ29sb3I6IG51bGwsIC8vIHNldCBpZiBkaWZmZXJlbnQgZnJvbSB0aGUgZ3JpZCBjb2xvcgogICAgICAgICAgICAgICAgICAgIHRpY2tDb2xvcjogbnVsbCwgLy8gY29sb3IgZm9yIHRoZSB0aWNrcywgZS5nLiAicmdiYSgwLDAsMCwwLjE1KSIKICAgICAgICAgICAgICAgICAgICBtYXJnaW46IDAsIC8vIGRpc3RhbmNlIGZyb20gdGhlIGNhbnZhcyBlZGdlIHRvIHRoZSBncmlkCiAgICAgICAgICAgICAgICAgICAgbGFiZWxNYXJnaW46IDUsIC8vIGluIHBpeGVscwogICAgICAgICAgICAgICAgICAgIGF4aXNNYXJnaW46IDgsIC8vIGluIHBpeGVscwogICAgICAgICAgICAgICAgICAgIGJvcmRlcldpZHRoOiAxLCAvLyBpbiBwaXhlbHMKICAgICAgICAgICAgICAgICAgICBtaW5Cb3JkZXJNYXJnaW46IG51bGwsIC8vIGluIHBpeGVscywgbnVsbCBtZWFucyB0YWtlbiBmcm9tIHBvaW50cyByYWRpdXMKICAgICAgICAgICAgICAgICAgICBtYXJraW5nczogbnVsbCwgLy8gYXJyYXkgb2YgcmFuZ2VzIG9yIGZuOiBheGVzIC0+IGFycmF5IG9mIHJhbmdlcwogICAgICAgICAgICAgICAgICAgIG1hcmtpbmdzQ29sb3I6ICIjZjRmNGY0IiwKICAgICAgICAgICAgICAgICAgICBtYXJraW5nc0xpbmVXaWR0aDogMiwKICAgICAgICAgICAgICAgICAgICAvLyBpbnRlcmFjdGl2ZSBzdHVmZgogICAgICAgICAgICAgICAgICAgIGNsaWNrYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaG92ZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBhdXRvSGlnaGxpZ2h0OiB0cnVlLCAvLyBoaWdobGlnaHQgaW4gY2FzZSBtb3VzZSBpcyBuZWFyCiAgICAgICAgICAgICAgICAgICAgbW91c2VBY3RpdmVSYWRpdXM6IDE1IC8vIGhvdyBmYXIgdGhlIG1vdXNlIGNhbiBiZSBhd2F5IHRvIGFjdGl2YXRlIGFuIGl0ZW0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnRlcmFjdGlvbjogewogICAgICAgICAgICAgICAgICAgIHJlZHJhd092ZXJsYXlJbnRlcnZhbDogMTAwMCAvIDYwIC8vIHRpbWUgYmV0d2VlbiB1cGRhdGVzLCAtMSBtZWFucyBpbiBzYW1lIGZsb3cKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBob29rczoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3VyZmFjZSA9IG51bGwsIC8vIHRoZSBjYW52YXMgZm9yIHRoZSBwbG90IGl0c2VsZgogICAgICAgICAgICBvdmVybGF5ID0gbnVsbCwgLy8gY2FudmFzIGZvciBpbnRlcmFjdGl2ZSBzdHVmZiBvbiB0b3Agb2YgcGxvdAogICAgICAgICAgICBldmVudEhvbGRlciA9IG51bGwsIC8vIGpRdWVyeSBvYmplY3QgdGhhdCBldmVudHMgc2hvdWxkIGJlIGJvdW5kIHRvCiAgICAgICAgICAgIGN0eCA9IG51bGwsCiAgICAgICAgICAgIG9jdHggPSBudWxsLAogICAgICAgICAgICB4YXhlcyA9IFtdLAogICAgICAgICAgICB5YXhlcyA9IFtdLAogICAgICAgICAgICBwbG90T2Zmc2V0ID0gewogICAgICAgICAgICAgICAgbGVmdDogMCwKICAgICAgICAgICAgICAgIHJpZ2h0OiAwLAogICAgICAgICAgICAgICAgdG9wOiAwLAogICAgICAgICAgICAgICAgYm90dG9tOiAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBsb3RXaWR0aCA9IDAsCiAgICAgICAgICAgIHBsb3RIZWlnaHQgPSAwLAogICAgICAgICAgICBob29rcyA9IHsKICAgICAgICAgICAgICAgIHByb2Nlc3NPcHRpb25zOiBbXSwKICAgICAgICAgICAgICAgIHByb2Nlc3NSYXdEYXRhOiBbXSwKICAgICAgICAgICAgICAgIHByb2Nlc3NEYXRhcG9pbnRzOiBbXSwKICAgICAgICAgICAgICAgIHByb2Nlc3NPZmZzZXQ6IFtdLAogICAgICAgICAgICAgICAgc2V0dXBHcmlkOiBbXSwKICAgICAgICAgICAgICAgIGFkanVzdFNlcmllc0RhdGFSYW5nZTogW10sCiAgICAgICAgICAgICAgICBzZXRSYW5nZTogW10sCiAgICAgICAgICAgICAgICBkcmF3QmFja2dyb3VuZDogW10sCiAgICAgICAgICAgICAgICBkcmF3U2VyaWVzOiBbXSwKICAgICAgICAgICAgICAgIGRyYXdBeGlzOiBbXSwKICAgICAgICAgICAgICAgIGRyYXc6IFtdLAogICAgICAgICAgICAgICAgYXhpc1Jlc2VydmVTcGFjZTogW10sCiAgICAgICAgICAgICAgICBiaW5kRXZlbnRzOiBbXSwKICAgICAgICAgICAgICAgIGRyYXdPdmVybGF5OiBbXSwKICAgICAgICAgICAgICAgIHJlc2l6ZTogW10sCiAgICAgICAgICAgICAgICBzaHV0ZG93bjogW10KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcGxvdCA9IHRoaXM7CgogICAgICAgIHZhciBldmVudE1hbmFnZXIgPSB7fTsKCiAgICAgICAgLy8gaW50ZXJhY3RpdmUgZmVhdHVyZXMKCiAgICAgICAgdmFyIHJlZHJhd1RpbWVvdXQgPSBudWxsOwoKICAgICAgICAvLyBwdWJsaWMgZnVuY3Rpb25zCiAgICAgICAgcGxvdC5zZXREYXRhID0gc2V0RGF0YTsKICAgICAgICBwbG90LnNldHVwR3JpZCA9IHNldHVwR3JpZDsKICAgICAgICBwbG90LmRyYXcgPSBkcmF3OwogICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyOwogICAgICAgIH07CiAgICAgICAgcGxvdC5nZXRDYW52YXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHN1cmZhY2UuZWxlbWVudDsKICAgICAgICB9OwogICAgICAgIHBsb3QuZ2V0U3VyZmFjZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gc3VyZmFjZTsKICAgICAgICB9OwogICAgICAgIHBsb3QuZ2V0RXZlbnRIb2xkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50SG9sZGVyWzBdOwogICAgICAgIH07CiAgICAgICAgcGxvdC5nZXRQbG90T2Zmc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBwbG90T2Zmc2V0OwogICAgICAgIH07CiAgICAgICAgcGxvdC53aWR0aCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcGxvdFdpZHRoOwogICAgICAgIH07CiAgICAgICAgcGxvdC5oZWlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBsb3RIZWlnaHQ7CiAgICAgICAgfTsKICAgICAgICBwbG90Lm9mZnNldCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbyA9IGV2ZW50SG9sZGVyLm9mZnNldCgpOwogICAgICAgICAgICBvLmxlZnQgKz0gcGxvdE9mZnNldC5sZWZ0OwogICAgICAgICAgICBvLnRvcCArPSBwbG90T2Zmc2V0LnRvcDsKICAgICAgICAgICAgcmV0dXJuIG87CiAgICAgICAgfTsKICAgICAgICBwbG90LmdldERhdGEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHNlcmllczsKICAgICAgICB9OwogICAgICAgIHBsb3QuZ2V0QXhlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcmVzID0ge307CiAgICAgICAgICAgICQuZWFjaCh4YXhlcy5jb25jYXQoeWF4ZXMpLCBmdW5jdGlvbihfLCBheGlzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXhpcykgewogICAgICAgICAgICAgICAgICAgIHJlc1theGlzLmRpcmVjdGlvbiArIChheGlzLm4gIT09IDEgPyBheGlzLm4gOiAiIikgKyAiYXhpcyJdID0gYXhpczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfTsKICAgICAgICBwbG90LmdldFhBeGVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB4YXhlczsKICAgICAgICB9OwogICAgICAgIHBsb3QuZ2V0WUF4ZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHlheGVzOwogICAgICAgIH07CiAgICAgICAgcGxvdC5jMnAgPSBjYW52YXNUb0NhcnRlc2lhbkF4aXNDb29yZHM7CiAgICAgICAgcGxvdC5wMmMgPSBjYXJ0ZXNpYW5BeGlzVG9DYW52YXNDb29yZHM7CiAgICAgICAgcGxvdC5nZXRPcHRpb25zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zOwogICAgICAgIH07CiAgICAgICAgcGxvdC50cmlnZ2VyUmVkcmF3T3ZlcmxheSA9IHRyaWdnZXJSZWRyYXdPdmVybGF5OwogICAgICAgIHBsb3QucG9pbnRPZmZzZXQgPSBmdW5jdGlvbihwb2ludCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgbGVmdDogcGFyc2VJbnQoeGF4ZXNbYXhpc051bWJlcihwb2ludCwgIngiKSAtIDFdLnAyYygrcG9pbnQueCkgKyBwbG90T2Zmc2V0LmxlZnQsIDEwKSwKICAgICAgICAgICAgICAgIHRvcDogcGFyc2VJbnQoeWF4ZXNbYXhpc051bWJlcihwb2ludCwgInkiKSAtIDFdLnAyYygrcG9pbnQueSkgKyBwbG90T2Zmc2V0LnRvcCwgMTApCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBwbG90LnNodXRkb3duID0gc2h1dGRvd247CiAgICAgICAgcGxvdC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNodXRkb3duKCk7CiAgICAgICAgICAgIHBsYWNlaG9sZGVyLnJlbW92ZURhdGEoInBsb3QiKS5lbXB0eSgpOwoKICAgICAgICAgICAgc2VyaWVzID0gW107CiAgICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgICBzdXJmYWNlID0gbnVsbDsKICAgICAgICAgICAgb3ZlcmxheSA9IG51bGw7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgY3R4ID0gbnVsbDsKICAgICAgICAgICAgb2N0eCA9IG51bGw7CiAgICAgICAgICAgIHhheGVzID0gW107CiAgICAgICAgICAgIHlheGVzID0gW107CiAgICAgICAgICAgIGhvb2tzID0gbnVsbDsKICAgICAgICAgICAgcGxvdCA9IG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgcGxvdC5yZXNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHdpZHRoID0gcGxhY2Vob2xkZXIud2lkdGgoKSwKICAgICAgICAgICAgICAgIGhlaWdodCA9IHBsYWNlaG9sZGVyLmhlaWdodCgpOwogICAgICAgICAgICBzdXJmYWNlLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICAgICAgb3ZlcmxheS5yZXNpemUod2lkdGgsIGhlaWdodCk7CgogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucmVzaXplLCBbd2lkdGgsIGhlaWdodF0pOwogICAgICAgIH07CgogICAgICAgIHBsb3QuY2xlYXJUZXh0Q2FjaGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHN1cmZhY2UuY2xlYXJDYWNoZSgpOwogICAgICAgICAgICBvdmVybGF5LmNsZWFyQ2FjaGUoKTsKICAgICAgICB9OwoKICAgICAgICBwbG90LmF1dG9TY2FsZUF4aXMgPSBhdXRvU2NhbGVBeGlzOwogICAgICAgIHBsb3QuY29tcHV0ZVJhbmdlRm9yRGF0YVNlcmllcyA9IGNvbXB1dGVSYW5nZUZvckRhdGFTZXJpZXM7CiAgICAgICAgcGxvdC5hZGp1c3RTZXJpZXNEYXRhUmFuZ2UgPSBhZGp1c3RTZXJpZXNEYXRhUmFuZ2U7CiAgICAgICAgcGxvdC5maW5kTmVhcmJ5SXRlbSA9IGZpbmROZWFyYnlJdGVtOwogICAgICAgIHBsb3QuZmluZE5lYXJieUludGVycG9sYXRpb25Qb2ludCA9IGZpbmROZWFyYnlJbnRlcnBvbGF0aW9uUG9pbnQ7CiAgICAgICAgcGxvdC5jb21wdXRlVmFsdWVQcmVjaXNpb24gPSBjb21wdXRlVmFsdWVQcmVjaXNpb247CiAgICAgICAgcGxvdC5jb21wdXRlVGlja1NpemUgPSBjb21wdXRlVGlja1NpemU7CiAgICAgICAgcGxvdC5hZGRFdmVudEhhbmRsZXIgPSBhZGRFdmVudEhhbmRsZXI7CgogICAgICAgIC8vIHB1YmxpYyBhdHRyaWJ1dGVzCiAgICAgICAgcGxvdC5ob29rcyA9IGhvb2tzOwoKICAgICAgICAvLyBpbml0aWFsaXplCiAgICAgICAgdmFyIE1JTk9SX1RJQ0tTX0NPVU5UX0NPTlNUQU5UID0gJC5wbG90LnVpQ29uc3RhbnRzLk1JTk9SX1RJQ0tTX0NPVU5UX0NPTlNUQU5UOwogICAgICAgIHZhciBUSUNLX0xFTkdUSF9DT05TVEFOVCA9ICQucGxvdC51aUNvbnN0YW50cy5USUNLX0xFTkdUSF9DT05TVEFOVDsKICAgICAgICBpbml0UGx1Z2lucyhwbG90KTsKICAgICAgICBzZXR1cENhbnZhc2VzKCk7CiAgICAgICAgcGFyc2VPcHRpb25zKG9wdGlvbnNfKTsKICAgICAgICBzZXREYXRhKGRhdGFfKTsKICAgICAgICBzZXR1cEdyaWQodHJ1ZSk7CiAgICAgICAgZHJhdygpOwogICAgICAgIGJpbmRFdmVudHMoKTsKCiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZUhvb2tzKGhvb2ssIGFyZ3MpIHsKICAgICAgICAgICAgYXJncyA9IFtwbG90XS5jb25jYXQoYXJncyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaG9vay5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgaG9va1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5pdFBsdWdpbnMoKSB7CiAgICAgICAgICAgIC8vIFJlZmVyZW5jZXMgdG8ga2V5IGNsYXNzZXMsIGFsbG93aW5nIHBsdWdpbnMgdG8gbW9kaWZ5IHRoZW0KCiAgICAgICAgICAgIHZhciBjbGFzc2VzID0gewogICAgICAgICAgICAgICAgQ2FudmFzOiBDYW52YXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGx1Z2lucy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIHAgPSBwbHVnaW5zW2ldOwogICAgICAgICAgICAgICAgcC5pbml0KHBsb3QsIGNsYXNzZXMpOwogICAgICAgICAgICAgICAgaWYgKHAub3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMsIHAub3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBhcnNlT3B0aW9ucyhvcHRzKSB7CiAgICAgICAgICAgICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMsIG9wdHMpOwoKICAgICAgICAgICAgLy8gJC5leHRlbmQgbWVyZ2VzIGFycmF5cywgcmF0aGVyIHRoYW4gcmVwbGFjaW5nIHRoZW0uICBXaGVuIGxlc3MKICAgICAgICAgICAgLy8gY29sb3JzIGFyZSBwcm92aWRlZCB0aGFuIHRoZSBzaXplIG9mIHRoZSBkZWZhdWx0IHBhbGV0dGUsIHdlCiAgICAgICAgICAgIC8vIGVuZCB1cCB3aXRoIHRob3NlIGNvbG9ycyBwbHVzIHRoZSByZW1haW5pbmcgZGVmYXVsdHMsIHdoaWNoIGlzCiAgICAgICAgICAgIC8vIG5vdCBleHBlY3RlZCBiZWhhdmlvcjsgYXZvaWQgaXQgYnkgcmVwbGFjaW5nIHRoZW0gaGVyZS4KCiAgICAgICAgICAgIGlmIChvcHRzICYmIG9wdHMuY29sb3JzKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmNvbG9ycyA9IG9wdHMuY29sb3JzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy54YXhpcy5jb2xvciA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnhheGlzLmNvbG9yID0gJC5jb2xvci5wYXJzZShvcHRpb25zLmdyaWQuY29sb3IpLnNjYWxlKCdhJywgMC4yMikudG9TdHJpbmcoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMueWF4aXMuY29sb3IgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgb3B0aW9ucy55YXhpcy5jb2xvciA9ICQuY29sb3IucGFyc2Uob3B0aW9ucy5ncmlkLmNvbG9yKS5zY2FsZSgnYScsIDAuMjIpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLnhheGlzLnRpY2tDb2xvciA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyBncmlkLnRpY2tDb2xvciBmb3IgYmFjay1jb21wYXRpYmlsaXR5CiAgICAgICAgICAgICAgICBvcHRpb25zLnhheGlzLnRpY2tDb2xvciA9IG9wdGlvbnMuZ3JpZC50aWNrQ29sb3IgfHwgb3B0aW9ucy54YXhpcy5jb2xvcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMueWF4aXMudGlja0NvbG9yID09IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIGdyaWQudGlja0NvbG9yIGZvciBiYWNrLWNvbXBhdGliaWxpdHkKICAgICAgICAgICAgICAgIG9wdGlvbnMueWF4aXMudGlja0NvbG9yID0gb3B0aW9ucy5ncmlkLnRpY2tDb2xvciB8fCBvcHRpb25zLnlheGlzLmNvbG9yOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yID09IG51bGwpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMuZ3JpZC5ib3JkZXJDb2xvciA9IG9wdGlvbnMuZ3JpZC5jb2xvcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuZ3JpZC50aWNrQ29sb3IgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgb3B0aW9ucy5ncmlkLnRpY2tDb2xvciA9ICQuY29sb3IucGFyc2Uob3B0aW9ucy5ncmlkLmNvbG9yKS5zY2FsZSgnYScsIDAuMjIpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpbGwgaW4gZGVmYXVsdHMgZm9yIGF4aXMgb3B0aW9ucywgaW5jbHVkaW5nIGFueSB1bnNwZWNpZmllZAogICAgICAgICAgICAvLyBmb250LXNwZWMgZmllbGRzLCBpZiBhIGZvbnQtc3BlYyB3YXMgcHJvdmlkZWQuCgogICAgICAgICAgICAvLyBJZiBubyB4L3kgYXhpcyBvcHRpb25zIHdlcmUgcHJvdmlkZWQsIGNyZWF0ZSBvbmUgb2YgZWFjaCBhbnl3YXksCiAgICAgICAgICAgIC8vIHNpbmNlIHRoZSByZXN0IG9mIHRoZSBjb2RlIGFzc3VtZXMgdGhhdCB0aGV5IGV4aXN0LgoKICAgICAgICAgICAgdmFyIGksIGF4aXNPcHRpb25zLCBheGlzQ291bnQsCiAgICAgICAgICAgICAgICBmb250U2l6ZSA9IHBsYWNlaG9sZGVyLmNzcygiZm9udC1zaXplIiksCiAgICAgICAgICAgICAgICBmb250U2l6ZURlZmF1bHQgPSBmb250U2l6ZSA/ICtmb250U2l6ZS5yZXBsYWNlKCJweCIsICIiKSA6IDEzLAogICAgICAgICAgICAgICAgZm9udERlZmF1bHRzID0gewogICAgICAgICAgICAgICAgICAgIHN0eWxlOiBwbGFjZWhvbGRlci5jc3MoImZvbnQtc3R5bGUiKSwKICAgICAgICAgICAgICAgICAgICBzaXplOiBNYXRoLnJvdW5kKDAuOCAqIGZvbnRTaXplRGVmYXVsdCksCiAgICAgICAgICAgICAgICAgICAgdmFyaWFudDogcGxhY2Vob2xkZXIuY3NzKCJmb250LXZhcmlhbnQiKSwKICAgICAgICAgICAgICAgICAgICB3ZWlnaHQ6IHBsYWNlaG9sZGVyLmNzcygiZm9udC13ZWlnaHQiKSwKICAgICAgICAgICAgICAgICAgICBmYW1pbHk6IHBsYWNlaG9sZGVyLmNzcygiZm9udC1mYW1pbHkiKQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGF4aXNDb3VudCA9IG9wdGlvbnMueGF4ZXMubGVuZ3RoIHx8IDE7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBheGlzQ291bnQ7ICsraSkgewogICAgICAgICAgICAgICAgYXhpc09wdGlvbnMgPSBvcHRpb25zLnhheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXNPcHRpb25zICYmICFheGlzT3B0aW9ucy50aWNrQ29sb3IpIHsKICAgICAgICAgICAgICAgICAgICBheGlzT3B0aW9ucy50aWNrQ29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBheGlzT3B0aW9ucyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zLnhheGlzLCBheGlzT3B0aW9ucyk7CiAgICAgICAgICAgICAgICBvcHRpb25zLnhheGVzW2ldID0gYXhpc09wdGlvbnM7CgogICAgICAgICAgICAgICAgaWYgKGF4aXNPcHRpb25zLmZvbnQpIHsKICAgICAgICAgICAgICAgICAgICBheGlzT3B0aW9ucy5mb250ID0gJC5leHRlbmQoe30sIGZvbnREZWZhdWx0cywgYXhpc09wdGlvbnMuZm9udCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmNvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF4aXNPcHRpb25zLmZvbnQuY29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmxpbmVIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXhpc09wdGlvbnMuZm9udC5saW5lSGVpZ2h0ID0gTWF0aC5yb3VuZChheGlzT3B0aW9ucy5mb250LnNpemUgKiAxLjE1KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGF4aXNDb3VudCA9IG9wdGlvbnMueWF4ZXMubGVuZ3RoIHx8IDE7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBheGlzQ291bnQ7ICsraSkgewogICAgICAgICAgICAgICAgYXhpc09wdGlvbnMgPSBvcHRpb25zLnlheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXNPcHRpb25zICYmICFheGlzT3B0aW9ucy50aWNrQ29sb3IpIHsKICAgICAgICAgICAgICAgICAgICBheGlzT3B0aW9ucy50aWNrQ29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBheGlzT3B0aW9ucyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zLnlheGlzLCBheGlzT3B0aW9ucyk7CiAgICAgICAgICAgICAgICBvcHRpb25zLnlheGVzW2ldID0gYXhpc09wdGlvbnM7CgogICAgICAgICAgICAgICAgaWYgKGF4aXNPcHRpb25zLmZvbnQpIHsKICAgICAgICAgICAgICAgICAgICBheGlzT3B0aW9ucy5mb250ID0gJC5leHRlbmQoe30sIGZvbnREZWZhdWx0cywgYXhpc09wdGlvbnMuZm9udCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmNvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF4aXNPcHRpb25zLmZvbnQuY29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmxpbmVIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXhpc09wdGlvbnMuZm9udC5saW5lSGVpZ2h0ID0gTWF0aC5yb3VuZChheGlzT3B0aW9ucy5mb250LnNpemUgKiAxLjE1KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNhdmUgb3B0aW9ucyBvbiBheGVzIGZvciBmdXR1cmUgcmVmZXJlbmNlCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvcHRpb25zLnhheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBnZXRPckNyZWF0ZUF4aXMoeGF4ZXMsIGkgKyAxKS5vcHRpb25zID0gb3B0aW9ucy54YXhlc1tpXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9wdGlvbnMueWF4ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGdldE9yQ3JlYXRlQXhpcyh5YXhlcywgaSArIDEpLm9wdGlvbnMgPSBvcHRpb25zLnlheGVzW2ldOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3Byb2Nlc3MgYm94UG9zaXRpb24gb3B0aW9ucyB1c2VkIGZvciBheGlzLmJveCBzaXplCiAgICAgICAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uKF8sIGF4aXMpIHsKICAgICAgICAgICAgICAgIGF4aXMuYm94UG9zaXRpb24gPSBheGlzLm9wdGlvbnMuYm94UG9zaXRpb24gfHwge2NlbnRlclg6IDAsIGNlbnRlclk6IDB9OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGFkZCBob29rcyBmcm9tIG9wdGlvbnMKICAgICAgICAgICAgZm9yICh2YXIgbiBpbiBob29rcykgewogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaG9va3Nbbl0gJiYgb3B0aW9ucy5ob29rc1tuXS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBob29rc1tuXSA9IGhvb2tzW25dLmNvbmNhdChvcHRpb25zLmhvb2tzW25dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnByb2Nlc3NPcHRpb25zLCBbb3B0aW9uc10pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0RGF0YShkKSB7CiAgICAgICAgICAgIHZhciBvbGRzZXJpZXMgPSBzZXJpZXM7CiAgICAgICAgICAgIHNlcmllcyA9IHBhcnNlRGF0YShkKTsKICAgICAgICAgICAgZmlsbEluU2VyaWVzT3B0aW9ucygpOwogICAgICAgICAgICBwcm9jZXNzRGF0YShvbGRzZXJpZXMpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGFyc2VEYXRhKGQpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGQubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBzID0gJC5leHRlbmQodHJ1ZSwge30sIG9wdGlvbnMuc2VyaWVzKTsKCiAgICAgICAgICAgICAgICBpZiAoZFtpXS5kYXRhICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzLmRhdGEgPSBkW2ldLmRhdGE7IC8vIG1vdmUgdGhlIGRhdGEgaW5zdGVhZCBvZiBkZWVwLWNvcHkKICAgICAgICAgICAgICAgICAgICBkZWxldGUgZFtpXS5kYXRhOwoKICAgICAgICAgICAgICAgICAgICAkLmV4dGVuZCh0cnVlLCBzLCBkW2ldKTsKCiAgICAgICAgICAgICAgICAgICAgZFtpXS5kYXRhID0gcy5kYXRhOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzLmRhdGEgPSBkW2ldOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJlcy5wdXNoKHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYXhpc051bWJlcihvYmosIGNvb3JkKSB7CiAgICAgICAgICAgIHZhciBhID0gb2JqW2Nvb3JkICsgImF4aXMiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgLy8gaWYgd2UgZ290IGEgcmVhbCBheGlzLCBleHRyYWN0IG51bWJlcgogICAgICAgICAgICAgICAgYSA9IGEubjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBhICE9PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgYSA9IDE7IC8vIGRlZmF1bHQgdG8gZmlyc3QgYXhpcwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGFsbEF4ZXMoKSB7CiAgICAgICAgICAgIC8vIHJldHVybiBmbGF0IGFycmF5IHdpdGhvdXQgYW5ub3lpbmcgbnVsbCBlbnRyaWVzCiAgICAgICAgICAgIHJldHVybiB4YXhlcy5jb25jYXQoeWF4ZXMpLmZpbHRlcihmdW5jdGlvbihhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBjYW52YXMgdG8gYXhpcyBmb3IgY2FydGVzaWFuIGF4ZXMKICAgICAgICBmdW5jdGlvbiBjYW52YXNUb0NhcnRlc2lhbkF4aXNDb29yZHMocG9zKSB7CiAgICAgICAgICAgIC8vIHJldHVybiBhbiBvYmplY3Qgd2l0aCB4L3kgY29ycmVzcG9uZGluZyB0byBhbGwgdXNlZCBheGVzCiAgICAgICAgICAgIHZhciByZXMgPSB7fSwKICAgICAgICAgICAgICAgIGksIGF4aXM7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB4YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgYXhpcyA9IHhheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXMgJiYgYXhpcy51c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzWyJ4IiArIGF4aXMubl0gPSBheGlzLmMycChwb3MubGVmdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB5YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgYXhpcyA9IHlheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXMgJiYgYXhpcy51c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzWyJ5IiArIGF4aXMubl0gPSBheGlzLmMycChwb3MudG9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJlcy54MSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXMueCA9IHJlcy54MTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJlcy55MSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXMueSA9IHJlcy55MTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9CgogICAgICAgIC8vIGF4aXMgdG8gY2FudmFzIGZvciBjYXJ0ZXNpYW4gYXhlcwogICAgICAgIGZ1bmN0aW9uIGNhcnRlc2lhbkF4aXNUb0NhbnZhc0Nvb3Jkcyhwb3MpIHsKICAgICAgICAgICAgLy8gZ2V0IGNhbnZhcyBjb29yZHMgZnJvbSB0aGUgZmlyc3QgcGFpciBvZiB4L3kgZm91bmQgaW4gcG9zCiAgICAgICAgICAgIHZhciByZXMgPSB7fSwKICAgICAgICAgICAgICAgIGksIGF4aXMsIGtleTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB4YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgYXhpcyA9IHhheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXMgJiYgYXhpcy51c2VkKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gIngiICsgYXhpcy5uOwogICAgICAgICAgICAgICAgICAgIGlmIChwb3Nba2V5XSA9PSBudWxsICYmIGF4aXMubiA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSAieCI7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocG9zW2tleV0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXMubGVmdCA9IGF4aXMucDJjKHBvc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgeWF4ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGF4aXMgPSB5YXhlc1tpXTsKICAgICAgICAgICAgICAgIGlmIChheGlzICYmIGF4aXMudXNlZCkgewogICAgICAgICAgICAgICAgICAgIGtleSA9ICJ5IiArIGF4aXMubjsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zW2tleV0gPT0gbnVsbCAmJiBheGlzLm4gPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gInkiOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc1trZXldICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnRvcCA9IGF4aXMucDJjKHBvc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0T3JDcmVhdGVBeGlzKGF4ZXMsIG51bWJlcikgewogICAgICAgICAgICBpZiAoIWF4ZXNbbnVtYmVyIC0gMV0pIHsKICAgICAgICAgICAgICAgIGF4ZXNbbnVtYmVyIC0gMV0gPSB7CiAgICAgICAgICAgICAgICAgICAgbjogbnVtYmVyLCAvLyBzYXZlIHRoZSBudW1iZXIgZm9yIGZ1dHVyZSByZWZlcmVuY2UKICAgICAgICAgICAgICAgICAgICBkaXJlY3Rpb246IGF4ZXMgPT09IHhheGVzID8gIngiIDogInkiLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6ICQuZXh0ZW5kKHRydWUsIHt9LCBheGVzID09PSB4YXhlcyA/IG9wdGlvbnMueGF4aXMgOiBvcHRpb25zLnlheGlzKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGF4ZXNbbnVtYmVyIC0gMV07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaWxsSW5TZXJpZXNPcHRpb25zKCkgewogICAgICAgICAgICB2YXIgbmVlZGVkQ29sb3JzID0gc2VyaWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgIG1heEluZGV4ID0gLTEsCiAgICAgICAgICAgICAgICBpOwoKICAgICAgICAgICAgLy8gU3VidHJhY3QgdGhlIG51bWJlciBvZiBzZXJpZXMgdGhhdCBhbHJlYWR5IGhhdmUgZml4ZWQgY29sb3JzIG9yCiAgICAgICAgICAgIC8vIGNvbG9yIGluZGV4ZXMgZnJvbSB0aGUgbnVtYmVyIHRoYXQgd2Ugc3RpbGwgbmVlZCB0byBnZW5lcmF0ZS4KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBzYyA9IHNlcmllc1tpXS5jb2xvcjsKICAgICAgICAgICAgICAgIGlmIChzYyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZGVkQ29sb3JzLS07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzYyA9PT0gIm51bWJlciIgJiYgc2MgPiBtYXhJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhJbmRleCA9IHNjOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgYW55IG9mIHRoZSBzZXJpZXMgaGF2ZSBmaXhlZCBjb2xvciBpbmRleGVzLCB0aGVuIHdlIG5lZWQgdG8KICAgICAgICAgICAgLy8gZ2VuZXJhdGUgYXQgbGVhc3QgYXMgbWFueSBjb2xvcnMgYXMgdGhlIGhpZ2hlc3QgaW5kZXguCgogICAgICAgICAgICBpZiAobmVlZGVkQ29sb3JzIDw9IG1heEluZGV4KSB7CiAgICAgICAgICAgICAgICBuZWVkZWRDb2xvcnMgPSBtYXhJbmRleCArIDE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdlbmVyYXRlIGFsbCB0aGUgY29sb3JzLCB1c2luZyBmaXJzdCB0aGUgb3B0aW9uIGNvbG9ycyBhbmQgdGhlbgogICAgICAgICAgICAvLyB2YXJpYXRpb25zIG9uIHRob3NlIGNvbG9ycyBvbmNlIHRoZXkncmUgZXhoYXVzdGVkLgoKICAgICAgICAgICAgdmFyIGMsIGNvbG9ycyA9IFtdLAogICAgICAgICAgICAgICAgY29sb3JQb29sID0gb3B0aW9ucy5jb2xvcnMsCiAgICAgICAgICAgICAgICBjb2xvclBvb2xTaXplID0gY29sb3JQb29sLmxlbmd0aCwKICAgICAgICAgICAgICAgIHZhcmlhdGlvbiA9IDAsCiAgICAgICAgICAgICAgICBkZWZpbmVkQ29sb3JzID0gTWF0aC5tYXgoMCwgc2VyaWVzLmxlbmd0aCAtIG5lZWRlZENvbG9ycyk7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbmVlZGVkQ29sb3JzOyBpKyspIHsKICAgICAgICAgICAgICAgIGMgPSAkLmNvbG9yLnBhcnNlKGNvbG9yUG9vbFsoZGVmaW5lZENvbG9ycyArIGkpICUgY29sb3JQb29sU2l6ZV0gfHwgIiM2NjYiKTsKCiAgICAgICAgICAgICAgICAvLyBFYWNoIHRpbWUgd2UgZXhoYXVzdCB0aGUgY29sb3JzIGluIHRoZSBwb29sIHdlIGFkanVzdAogICAgICAgICAgICAgICAgLy8gYSBzY2FsaW5nIGZhY3RvciB1c2VkIHRvIHByb2R1Y2UgbW9yZSB2YXJpYXRpb25zIG9uCiAgICAgICAgICAgICAgICAvLyB0aG9zZSBjb2xvcnMuIFRoZSBmYWN0b3IgYWx0ZXJuYXRlcyBuZWdhdGl2ZS9wb3NpdGl2ZQogICAgICAgICAgICAgICAgLy8gdG8gcHJvZHVjZSBsaWdodGVyL2RhcmtlciBjb2xvcnMuCgogICAgICAgICAgICAgICAgLy8gUmVzZXQgdGhlIHZhcmlhdGlvbiBhZnRlciBldmVyeSBmZXcgY3ljbGVzLCBvciBlbHNlCiAgICAgICAgICAgICAgICAvLyBpdCB3aWxsIGVuZCB1cCBwcm9kdWNpbmcgb25seSB3aGl0ZSBvciBibGFjayBjb2xvcnMuCgogICAgICAgICAgICAgICAgaWYgKGkgJSBjb2xvclBvb2xTaXplID09PSAwICYmIGkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFyaWF0aW9uID49IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhcmlhdGlvbiA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWF0aW9uID0gLXZhcmlhdGlvbiAtIDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHZhcmlhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHZhcmlhdGlvbiA9IC12YXJpYXRpb247CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29sb3JzW2ldID0gYy5zY2FsZSgncmdiJywgMSArIHZhcmlhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpbmFsaXplIHRoZSBzZXJpZXMgb3B0aW9ucywgZmlsbGluZyBpbiB0aGVpciBjb2xvcnMKCiAgICAgICAgICAgIHZhciBjb2xvcmkgPSAwLAogICAgICAgICAgICAgICAgczsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgcyA9IHNlcmllc1tpXTsKCiAgICAgICAgICAgICAgICAvLyBhc3NpZ24gY29sb3JzCiAgICAgICAgICAgICAgICBpZiAocy5jb2xvciA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcy5jb2xvciA9IGNvbG9yc1tjb2xvcmldLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgKytjb2xvcmk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzLmNvbG9yID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIHMuY29sb3IgPSBjb2xvcnNbcy5jb2xvcl0udG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB0dXJuIG9uIGxpbmVzIGF1dG9tYXRpY2FsbHkgaW4gY2FzZSBub3RoaW5nIGlzIHNldAogICAgICAgICAgICAgICAgaWYgKHMubGluZXMuc2hvdyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHYsIHNob3cgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGZvciAodiBpbiBzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzW3ZdICYmIHNbdl0uc2hvdykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChzaG93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHMubGluZXMuc2hvdyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIElmIG5vdGhpbmcgd2FzIHByb3ZpZGVkIGZvciBsaW5lcy56ZXJvLCBkZWZhdWx0IGl0IHRvIG1hdGNoCiAgICAgICAgICAgICAgICAvLyBsaW5lcy5maWxsLCBzaW5jZSBhcmVhcyBieSBkZWZhdWx0IHNob3VsZCBleHRlbmQgdG8gemVyby4KCiAgICAgICAgICAgICAgICBpZiAocy5saW5lcy56ZXJvID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzLmxpbmVzLnplcm8gPSAhIXMubGluZXMuZmlsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzZXR1cCBheGVzCiAgICAgICAgICAgICAgICBzLnhheGlzID0gZ2V0T3JDcmVhdGVBeGlzKHhheGVzLCBheGlzTnVtYmVyKHMsICJ4IikpOwogICAgICAgICAgICAgICAgcy55YXhpcyA9IGdldE9yQ3JlYXRlQXhpcyh5YXhlcywgYXhpc051bWJlcihzLCAieSIpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0RhdGEocHJldlNlcmllcykgewogICAgICAgICAgICB2YXIgdG9wU2VudHJ5ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICAgICAgICAgICAgYm90dG9tU2VudHJ5ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICAgICAgICAgICAgaSwgaiwgaywgbSwKICAgICAgICAgICAgICAgIHMsIHBvaW50cywgcHMsIHZhbCwgZiwgcCwKICAgICAgICAgICAgICAgIGRhdGEsIGZvcm1hdDsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUF4aXMoYXhpcywgbWluLCBtYXgpIHsKICAgICAgICAgICAgICAgIGlmIChtaW4gPCBheGlzLmRhdGFtaW4gJiYgbWluICE9PSAtSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICBheGlzLmRhdGFtaW4gPSBtaW47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG1heCA+IGF4aXMuZGF0YW1heCAmJiBtYXggIT09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgYXhpcy5kYXRhbWF4ID0gbWF4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiByZXVzZVBvaW50cyhwcmV2U2VyaWVzLCBpKSB7CiAgICAgICAgICAgICAgICBpZiAocHJldlNlcmllcyAmJiBwcmV2U2VyaWVzW2ldICYmIHByZXZTZXJpZXNbaV0uZGF0YXBvaW50cyAmJiBwcmV2U2VyaWVzW2ldLmRhdGFwb2ludHMucG9pbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTZXJpZXNbaV0uZGF0YXBvaW50cy5wb2ludHM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkLmVhY2goYWxsQXhlcygpLCBmdW5jdGlvbihfLCBheGlzKSB7CiAgICAgICAgICAgICAgICAvLyBpbml0IGF4aXMKICAgICAgICAgICAgICAgIGlmIChheGlzLm9wdGlvbnMuZ3Jvd09ubHkgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBheGlzLmRhdGFtaW4gPSB0b3BTZW50cnk7CiAgICAgICAgICAgICAgICAgICAgYXhpcy5kYXRhbWF4ID0gYm90dG9tU2VudHJ5OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5kYXRhbWluID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXhpcy5kYXRhbWluID0gdG9wU2VudHJ5OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5kYXRhbWF4ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXhpcy5kYXRhbWF4ID0gYm90dG9tU2VudHJ5OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF4aXMudXNlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHMgPSBzZXJpZXNbaV07CiAgICAgICAgICAgICAgICBzLmRhdGFwb2ludHMgPSB7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRzOiBbXQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAocy5kYXRhcG9pbnRzLnBvaW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBzLmRhdGFwb2ludHMucG9pbnRzID0gcmV1c2VQb2ludHMocHJldlNlcmllcywgaSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnByb2Nlc3NSYXdEYXRhLCBbcywgcy5kYXRhLCBzLmRhdGFwb2ludHNdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZmlyc3QgcGFzczogY2xlYW4gYW5kIGNvcHkgZGF0YQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBzID0gc2VyaWVzW2ldOwoKICAgICAgICAgICAgICAgIGRhdGEgPSBzLmRhdGE7CiAgICAgICAgICAgICAgICBmb3JtYXQgPSBzLmRhdGFwb2ludHMuZm9ybWF0OwoKICAgICAgICAgICAgICAgIGlmICghZm9ybWF0KSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gW107CiAgICAgICAgICAgICAgICAgICAgLy8gZmluZCBvdXQgaG93IHRvIGNvcHkKICAgICAgICAgICAgICAgICAgICBmb3JtYXQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHg6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHk6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBjb21wdXRlUmFuZ2U6IHMueGF4aXMub3B0aW9ucy5hdXRvU2NhbGUgIT09ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiBudWxsCiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGZvcm1hdC5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgeDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIHk6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXB1dGVSYW5nZTogcy55YXhpcy5vcHRpb25zLmF1dG9TY2FsZSAhPT0gJ25vbmUnLAogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0VmFsdWU6IG51bGwKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc3RhY2sgfHwgcy5iYXJzLnNob3cgfHwgKHMubGluZXMuc2hvdyAmJiBzLmxpbmVzLmZpbGwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZFBzID0gcy5kYXRhcG9pbnRzLnBvaW50c2l6ZSAhPSBudWxsID8gcy5kYXRhcG9pbnRzLnBvaW50c2l6ZSA6IChzLmRhdGEgJiYgcy5kYXRhWzBdICYmIHMuZGF0YVswXS5sZW5ndGggPyBzLmRhdGFbMF0ubGVuZ3RoIDogMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZFBzID4gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHg6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHk6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wdXRlUmFuZ2U6IHMueWF4aXMub3B0aW9ucy5hdXRvU2NhbGUgIT09ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0VmFsdWU6IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzLmRhdGFwb2ludHMuZm9ybWF0ID0gZm9ybWF0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHMueGF4aXMudXNlZCA9IHMueWF4aXMudXNlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgaWYgKHMuZGF0YXBvaW50cy5wb2ludHNpemUgIT0gbnVsbCkgY29udGludWU7IC8vIGFscmVhZHkgZmlsbGVkIGluCgogICAgICAgICAgICAgICAgcy5kYXRhcG9pbnRzLnBvaW50c2l6ZSA9IGZvcm1hdC5sZW5ndGg7CiAgICAgICAgICAgICAgICBwcyA9IHMuZGF0YXBvaW50cy5wb2ludHNpemU7CiAgICAgICAgICAgICAgICBwb2ludHMgPSBzLmRhdGFwb2ludHMucG9pbnRzOwoKICAgICAgICAgICAgICAgIHZhciBpbnNlcnRTdGVwcyA9IHMubGluZXMuc2hvdyAmJiBzLmxpbmVzLnN0ZXBzOwoKICAgICAgICAgICAgICAgIGZvciAoaiA9IGsgPSAwOyBqIDwgZGF0YS5sZW5ndGg7ICsraiwgayArPSBwcykgewogICAgICAgICAgICAgICAgICAgIHAgPSBkYXRhW2pdOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbnVsbGlmeSA9IHAgPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoIW51bGxpZnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChtID0gMDsgbSA8IHBzOyArK20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHBbbV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmID0gZm9ybWF0W21dOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGYubnVtYmVyICYmIHZhbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9ICt2YWw7IC8vIGNvbnZlcnQgdG8gbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc05hTih2YWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGYucmVxdWlyZWQpIG51bGxpZnkgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGYuZGVmYXVsdFZhbHVlICE9IG51bGwpIHZhbCA9IGYuZGVmYXVsdFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludHNbayArIG1dID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbGlmeSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gcG9pbnRzW2sgKyBtXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYgPSBmb3JtYXRbbV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXh0cmFjdCBtaW4vbWF4IGluZm8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZi5jb21wdXRlUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGYueCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlQXhpcyhzLnhheGlzLCB2YWwsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGYueSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlQXhpcyhzLnlheGlzLCB2YWwsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludHNbayArIG1dID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBwb2ludHMubGVuZ3RoID0gazsgLy90cmltcyB0aGUgaW50ZXJuYWwgYnVmZmVyIHRvIHRoZSBjb3JyZWN0IGxlbmd0aAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBnaXZlIHRoZSBob29rcyBhIGNoYW5jZSB0byBydW4KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgcyA9IHNlcmllc1tpXTsKCiAgICAgICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucHJvY2Vzc0RhdGFwb2ludHMsIFtzLCBzLmRhdGFwb2ludHNdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gc2Vjb25kIHBhc3M6IGZpbmQgZGF0YW1heC9kYXRhbWluIGZvciBhdXRvLXNjYWxpbmcKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgcyA9IHNlcmllc1tpXTsKICAgICAgICAgICAgICAgIGZvcm1hdCA9IHMuZGF0YXBvaW50cy5mb3JtYXQ7CgogICAgICAgICAgICAgICAgaWYgKGZvcm1hdC5ldmVyeShmdW5jdGlvbiAoZikgeyByZXR1cm4gIWYuY29tcHV0ZVJhbmdlOyB9KSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IHBsb3QuYWRqdXN0U2VyaWVzRGF0YVJhbmdlKHMsCiAgICAgICAgICAgICAgICAgICAgcGxvdC5jb21wdXRlUmFuZ2VGb3JEYXRhU2VyaWVzKHMpKTsKCiAgICAgICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MuYWRqdXN0U2VyaWVzRGF0YVJhbmdlLCBbcywgcmFuZ2VdKTsKCiAgICAgICAgICAgICAgICB1cGRhdGVBeGlzKHMueGF4aXMsIHJhbmdlLnhtaW4sIHJhbmdlLnhtYXgpOwogICAgICAgICAgICAgICAgdXBkYXRlQXhpcyhzLnlheGlzLCByYW5nZS55bWluLCByYW5nZS55bWF4KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5lYWNoKGFsbEF4ZXMoKSwgZnVuY3Rpb24oXywgYXhpcykgewogICAgICAgICAgICAgICAgaWYgKGF4aXMuZGF0YW1pbiA9PT0gdG9wU2VudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgYXhpcy5kYXRhbWluID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXhpcy5kYXRhbWF4ID09PSBib3R0b21TZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBheGlzLmRhdGFtYXggPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldHVwQ2FudmFzZXMoKSB7CiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGUgcGxhY2Vob2xkZXIgaXMgY2xlYXIgb2YgZXZlcnl0aGluZyBleGNlcHQgY2FudmFzZXMKICAgICAgICAgICAgLy8gZnJvbSBhIHByZXZpb3VzIHBsb3QgaW4gdGhpcyBjb250YWluZXIgdGhhdCB3ZSdsbCB0cnkgdG8gcmUtdXNlLgoKICAgICAgICAgICAgcGxhY2Vob2xkZXIuY3NzKCJwYWRkaW5nIiwgMCkgLy8gcGFkZGluZyBtZXNzZXMgdXAgdGhlIHBvc2l0aW9uaW5nCiAgICAgICAgICAgICAgICAuY2hpbGRyZW4oKS5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEkKHRoaXMpLmhhc0NsYXNzKCJmbG90LW92ZXJsYXkiKSAmJiAhJCh0aGlzKS5oYXNDbGFzcygnZmxvdC1iYXNlJyk7CiAgICAgICAgICAgICAgICB9KS5yZW1vdmUoKTsKCiAgICAgICAgICAgIGlmIChwbGFjZWhvbGRlci5jc3MoInBvc2l0aW9uIikgPT09ICdzdGF0aWMnKSB7CiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlci5jc3MoInBvc2l0aW9uIiwgInJlbGF0aXZlIik7IC8vIGZvciBwb3NpdGlvbmluZyBsYWJlbHMgYW5kIG92ZXJsYXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3VyZmFjZSA9IG5ldyBDYW52YXMoImZsb3QtYmFzZSIsIHBsYWNlaG9sZGVyWzBdKTsKICAgICAgICAgICAgb3ZlcmxheSA9IG5ldyBDYW52YXMoImZsb3Qtb3ZlcmxheSIsIHBsYWNlaG9sZGVyWzBdKTsgLy8gb3ZlcmxheSBjYW52YXMgZm9yIGludGVyYWN0aXZlIGZlYXR1cmVzCgogICAgICAgICAgICBjdHggPSBzdXJmYWNlLmNvbnRleHQ7CiAgICAgICAgICAgIG9jdHggPSBvdmVybGF5LmNvbnRleHQ7CgogICAgICAgICAgICAvLyBkZWZpbmUgd2hpY2ggZWxlbWVudCB3ZSdyZSBsaXN0ZW5pbmcgZm9yIGV2ZW50cyBvbgogICAgICAgICAgICBldmVudEhvbGRlciA9ICQob3ZlcmxheS5lbGVtZW50KS51bmJpbmQoKTsKCiAgICAgICAgICAgIC8vIElmIHdlJ3JlIHJlLXVzaW5nIGEgcGxvdCBvYmplY3QsIHNodXQgZG93biB0aGUgb2xkIG9uZQoKICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gcGxhY2Vob2xkZXIuZGF0YSgicGxvdCIpOwoKICAgICAgICAgICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgICAgICAgICAgICBleGlzdGluZy5zaHV0ZG93bigpOwogICAgICAgICAgICAgICAgb3ZlcmxheS5jbGVhcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzYXZlIGluIGNhc2Ugd2UgZ2V0IHJlcGxvdHRlZAogICAgICAgICAgICBwbGFjZWhvbGRlci5kYXRhKCJwbG90IiwgcGxvdCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBiaW5kRXZlbnRzKCkgewogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MuYmluZEV2ZW50cywgW2V2ZW50SG9sZGVyXSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEhhbmRsZXIoZXZlbnQsIGhhbmRsZXIsIGV2ZW50SG9sZGVyLCBwcmlvcml0eSkgewogICAgICAgICAgICB2YXIga2V5ID0gZXZlbnRIb2xkZXIgKyBldmVudDsKICAgICAgICAgICAgdmFyIGV2ZW50TGlzdCA9IGV2ZW50TWFuYWdlcltrZXldIHx8IFtdOwoKICAgICAgICAgICAgZXZlbnRMaXN0LnB1c2goeyJldmVudCI6IGV2ZW50LCAiaGFuZGxlciI6IGhhbmRsZXIsICJldmVudEhvbGRlciI6IGV2ZW50SG9sZGVyLCAicHJpb3JpdHkiOiBwcmlvcml0eX0pOwogICAgICAgICAgICBldmVudExpc3Quc29ydCgoYSwgYikgPT4gYi5wcmlvcml0eSAtIGEucHJpb3JpdHkgKTsKICAgICAgICAgICAgZXZlbnRMaXN0LmZvckVhY2goIGV2ZW50RGF0YSA9PiB7CiAgICAgICAgICAgICAgICBldmVudERhdGEuZXZlbnRIb2xkZXIudW5iaW5kKGV2ZW50RGF0YS5ldmVudCwgZXZlbnREYXRhLmhhbmRsZXIpOwogICAgICAgICAgICAgICAgZXZlbnREYXRhLmV2ZW50SG9sZGVyLmJpbmQoZXZlbnREYXRhLmV2ZW50LCBldmVudERhdGEuaGFuZGxlcik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZXZlbnRNYW5hZ2VyW2tleV0gPSBldmVudExpc3Q7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzaHV0ZG93bigpIHsKICAgICAgICAgICAgaWYgKHJlZHJhd1RpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZWRyYXdUaW1lb3V0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnNodXRkb3duLCBbZXZlbnRIb2xkZXJdKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldFRyYW5zZm9ybWF0aW9uSGVscGVycyhheGlzKSB7CiAgICAgICAgICAgIC8vIHNldCBoZWxwZXIgZnVuY3Rpb25zIG9uIHRoZSBheGlzLCBhc3N1bWVzIHBsb3QgYXJlYQogICAgICAgICAgICAvLyBoYXMgYmVlbiBjb21wdXRlZCBhbHJlYWR5CgogICAgICAgICAgICBmdW5jdGlvbiBpZGVudGl0eSh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4geDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHMsIG0sIHQgPSBheGlzLm9wdGlvbnMudHJhbnNmb3JtIHx8IGlkZW50aXR5LAogICAgICAgICAgICAgICAgaXQgPSBheGlzLm9wdGlvbnMuaW52ZXJzZVRyYW5zZm9ybTsKCiAgICAgICAgICAgIC8vIHByZWNvbXB1dGUgaG93IG11Y2ggdGhlIGF4aXMgaXMgc2NhbGluZyBhIHBvaW50CiAgICAgICAgICAgIC8vIGluIGNhbnZhcyBzcGFjZQogICAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT09ICJ4IikgewogICAgICAgICAgICAgICAgaWYgKGlzRmluaXRlKHQoYXhpcy5tYXgpIC0gdChheGlzLm1pbikpKSB7CiAgICAgICAgICAgICAgICAgICAgcyA9IGF4aXMuc2NhbGUgPSBwbG90V2lkdGggLyBNYXRoLmFicyh0KGF4aXMubWF4KSAtIHQoYXhpcy5taW4pKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcyA9IGF4aXMuc2NhbGUgPSAxIC8gTWF0aC5hYnMoJC5wbG90LnNhdHVyYXRlZC5kZWx0YSh0KGF4aXMubWluKSwgdChheGlzLm1heCksIHBsb3RXaWR0aCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbSA9IE1hdGgubWluKHQoYXhpcy5tYXgpLCB0KGF4aXMubWluKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaXNGaW5pdGUodChheGlzLm1heCkgLSB0KGF4aXMubWluKSkpIHsKICAgICAgICAgICAgICAgICAgICBzID0gYXhpcy5zY2FsZSA9IHBsb3RIZWlnaHQgLyBNYXRoLmFicyh0KGF4aXMubWF4KSAtIHQoYXhpcy5taW4pKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcyA9IGF4aXMuc2NhbGUgPSAxIC8gTWF0aC5hYnMoJC5wbG90LnNhdHVyYXRlZC5kZWx0YSh0KGF4aXMubWluKSwgdChheGlzLm1heCksIHBsb3RIZWlnaHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHMgPSAtczsKICAgICAgICAgICAgICAgIG0gPSBNYXRoLm1heCh0KGF4aXMubWF4KSwgdChheGlzLm1pbikpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBkYXRhIHBvaW50IHRvIGNhbnZhcyBjb29yZGluYXRlCiAgICAgICAgICAgIGlmICh0ID09PSBpZGVudGl0eSkgewogICAgICAgICAgICAgICAgLy8gc2xpZ2h0IG9wdGltaXphdGlvbgogICAgICAgICAgICAgICAgYXhpcy5wMmMgPSBmdW5jdGlvbihwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXRlKHAgLSBtKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHAgLSBtKSAqIHM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChwIC8gNCAtIG0gLyA0KSAqIHMgKiA0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBheGlzLnAyYyA9IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdHAgPSB0KHApOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNGaW5pdGUodHAgLSBtKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHRwIC0gbSkgKiBzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodHAgLyA0IC0gbSAvIDQpICogcyAqIDQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY2FudmFzIGNvb3JkaW5hdGUgdG8gZGF0YSBwb2ludAogICAgICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgICAgICBheGlzLmMycCA9IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbSArIGMgLyBzOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGF4aXMuYzJwID0gZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpdChtICsgYyAvIHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWVhc3VyZVRpY2tMYWJlbHMoYXhpcykgewogICAgICAgICAgICB2YXIgb3B0cyA9IGF4aXMub3B0aW9ucywKICAgICAgICAgICAgICAgIHRpY2tzID0gb3B0cy5zaG93VGlja0xhYmVscyAhPT0gJ25vbmUnICYmIGF4aXMudGlja3MgPyBheGlzLnRpY2tzIDogW10sCiAgICAgICAgICAgICAgICBzaG93TWFqb3JUaWNrTGFiZWxzID0gb3B0cy5zaG93VGlja0xhYmVscyA9PT0gJ21ham9yJyB8fCBvcHRzLnNob3dUaWNrTGFiZWxzID09PSAnYWxsJywKICAgICAgICAgICAgICAgIHNob3dFbmRwb2ludHNUaWNrTGFiZWxzID0gb3B0cy5zaG93VGlja0xhYmVscyA9PT0gJ2VuZHBvaW50cycgfHwgb3B0cy5zaG93VGlja0xhYmVscyA9PT0gJ2FsbCcsCiAgICAgICAgICAgICAgICBsYWJlbFdpZHRoID0gb3B0cy5sYWJlbFdpZHRoIHx8IDAsCiAgICAgICAgICAgICAgICBsYWJlbEhlaWdodCA9IG9wdHMubGFiZWxIZWlnaHQgfHwgMCwKICAgICAgICAgICAgICAgIGxlZ2FjeVN0eWxlcyA9IGF4aXMuZGlyZWN0aW9uICsgIkF4aXMgIiArIGF4aXMuZGlyZWN0aW9uICsgYXhpcy5uICsgIkF4aXMiLAogICAgICAgICAgICAgICAgbGF5ZXIgPSAiZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyAiLWF4aXMgZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyBheGlzLm4gKyAiLWF4aXMgIiArIGxlZ2FjeVN0eWxlcywKICAgICAgICAgICAgICAgIGZvbnQgPSBvcHRzLmZvbnQgfHwgImZsb3QtdGljay1sYWJlbCB0aWNrTGFiZWwiOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aWNrcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aWNrc1tpXTsKICAgICAgICAgICAgICAgIHZhciBsYWJlbCA9IHQubGFiZWw7CgogICAgICAgICAgICAgICAgaWYgKCF0LmxhYmVsIHx8CiAgICAgICAgICAgICAgICAgICAgKHNob3dNYWpvclRpY2tMYWJlbHMgPT09IGZhbHNlICYmIGkgPiAwICYmIGkgPCB0aWNrcy5sZW5ndGggLSAxKSB8fAogICAgICAgICAgICAgICAgICAgIChzaG93RW5kcG9pbnRzVGlja0xhYmVscyA9PT0gZmFsc2UgJiYgKGkgPT09IDAgfHwgaSA9PT0gdGlja3MubGVuZ3RoIC0gMSkpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0LmxhYmVsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGxhYmVsID0gdC5sYWJlbC5uYW1lOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBpbmZvID0gc3VyZmFjZS5nZXRUZXh0SW5mbyhsYXllciwgbGFiZWwsIGZvbnQpOwoKICAgICAgICAgICAgICAgIGxhYmVsV2lkdGggPSBNYXRoLm1heChsYWJlbFdpZHRoLCBpbmZvLndpZHRoKTsKICAgICAgICAgICAgICAgIGxhYmVsSGVpZ2h0ID0gTWF0aC5tYXgobGFiZWxIZWlnaHQsIGluZm8uaGVpZ2h0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXhpcy5sYWJlbFdpZHRoID0gb3B0cy5sYWJlbFdpZHRoIHx8IGxhYmVsV2lkdGg7CiAgICAgICAgICAgIGF4aXMubGFiZWxIZWlnaHQgPSBvcHRzLmxhYmVsSGVpZ2h0IHx8IGxhYmVsSGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGVBeGlzQm94Rmlyc3RQaGFzZShheGlzKSB7CiAgICAgICAgICAgIC8vIGZpbmQgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgYXhpcyBieSBsb29raW5nIGF0IGxhYmVsCiAgICAgICAgICAgIC8vIHdpZHRocy9oZWlnaHRzIGFuZCB0aWNrcywgbWFrZSByb29tIGJ5IGRpbWluaXNoaW5nIHRoZQogICAgICAgICAgICAvLyBwbG90T2Zmc2V0OyB0aGlzIGZpcnN0IHBoYXNlIG9ubHkgbG9va3MgYXQgb25lCiAgICAgICAgICAgIC8vIGRpbWVuc2lvbiBwZXIgYXhpcywgdGhlIG90aGVyIGRpbWVuc2lvbiBkZXBlbmRzIG9uIHRoZQogICAgICAgICAgICAvLyBvdGhlciBheGVzIHNvIHdpbGwgaGF2ZSB0byB3YWl0CgogICAgICAgICAgICAvLyBoZXJlIHJlc2VydmUgYWRkaXRpb25hbCBzcGFjZQogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MuYXhpc1Jlc2VydmVTcGFjZSwgW2F4aXNdKTsKCiAgICAgICAgICAgIHZhciBsdyA9IGF4aXMubGFiZWxXaWR0aCwKICAgICAgICAgICAgICAgIGxoID0gYXhpcy5sYWJlbEhlaWdodCwKICAgICAgICAgICAgICAgIHBvcyA9IGF4aXMub3B0aW9ucy5wb3NpdGlvbiwKICAgICAgICAgICAgICAgIGlzWEF4aXMgPSBheGlzLmRpcmVjdGlvbiA9PT0gIngiLAogICAgICAgICAgICAgICAgdGlja0xlbmd0aCA9IGF4aXMub3B0aW9ucy50aWNrTGVuZ3RoLAogICAgICAgICAgICAgICAgc2hvd1RpY2tzID0gYXhpcy5vcHRpb25zLnNob3dUaWNrcywKICAgICAgICAgICAgICAgIHNob3dNaW5vclRpY2tzID0gYXhpcy5vcHRpb25zLnNob3dNaW5vclRpY2tzLAogICAgICAgICAgICAgICAgZ3JpZExpbmVzID0gYXhpcy5vcHRpb25zLmdyaWRMaW5lcywKICAgICAgICAgICAgICAgIGF4aXNNYXJnaW4gPSBvcHRpb25zLmdyaWQuYXhpc01hcmdpbiwKICAgICAgICAgICAgICAgIHBhZGRpbmcgPSBvcHRpb25zLmdyaWQubGFiZWxNYXJnaW4sCiAgICAgICAgICAgICAgICBpbm5lcm1vc3QgPSB0cnVlLAogICAgICAgICAgICAgICAgb3V0ZXJtb3N0ID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGZvdW5kID0gZmFsc2U7CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgdGhlIGF4aXMncyBwb3NpdGlvbiBpbiBpdHMgZGlyZWN0aW9uIGFuZCBvbiBpdHMgc2lkZQoKICAgICAgICAgICAgJC5lYWNoKGlzWEF4aXMgPyB4YXhlcyA6IHlheGVzLCBmdW5jdGlvbihpLCBhKSB7CiAgICAgICAgICAgICAgICBpZiAoYSAmJiAoYS5zaG93IHx8IGEucmVzZXJ2ZVNwYWNlKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChhID09PSBheGlzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGEub3B0aW9ucy5wb3NpdGlvbiA9PT0gcG9zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0ZXJtb3N0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbm5lcm1vc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBUaGUgb3V0ZXJtb3N0IGF4aXMgb24gZWFjaCBzaWRlIGhhcyBubyBtYXJnaW4KICAgICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICAgICAgYXhpc01hcmdpbiA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNldCB0aGUgZGVmYXVsdCB0aWNrTGVuZ3RoIGlmIG5lY2Vzc2FyeQogICAgICAgICAgICBpZiAodGlja0xlbmd0aCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aWNrTGVuZ3RoID0gVElDS19MRU5HVEhfQ09OU1RBTlQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJ5IGRlZmF1bHQsIG1ham9yIHRpY2sgbWFya3MgYXJlIHZpc2libGUKICAgICAgICAgICAgaWYgKHNob3dUaWNrcyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzaG93VGlja3MgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCeSBkZWZhdWx0LCBtaW5vciB0aWNrIG1hcmtzIGFyZSB2aXNpYmxlCiAgICAgICAgICAgIGlmIChzaG93TWlub3JUaWNrcyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzaG93TWlub3JUaWNrcyA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJ5IGRlZmF1bHQsIGdyaWQgbGluZXMgYXJlIHZpc2libGUKICAgICAgICAgICAgaWYgKGdyaWRMaW5lcyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5uZXJtb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgZ3JpZExpbmVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZ3JpZExpbmVzID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghaXNOYU4oK3RpY2tMZW5ndGgpKSB7CiAgICAgICAgICAgICAgICBwYWRkaW5nICs9IHNob3dUaWNrcyA/ICt0aWNrTGVuZ3RoIDogMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzWEF4aXMpIHsKICAgICAgICAgICAgICAgIGxoICs9IHBhZGRpbmc7CgogICAgICAgICAgICAgICAgaWYgKHBvcyA9PT0gImJvdHRvbSIpIHsKICAgICAgICAgICAgICAgICAgICBwbG90T2Zmc2V0LmJvdHRvbSArPSBsaCArIGF4aXNNYXJnaW47CiAgICAgICAgICAgICAgICAgICAgYXhpcy5ib3ggPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogc3VyZmFjZS5oZWlnaHQgLSBwbG90T2Zmc2V0LmJvdHRvbSwKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBsaAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGF4aXMuYm94ID0gewogICAgICAgICAgICAgICAgICAgICAgICB0b3A6IHBsb3RPZmZzZXQudG9wICsgYXhpc01hcmdpbiwKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBsaAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgcGxvdE9mZnNldC50b3AgKz0gbGggKyBheGlzTWFyZ2luOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbHcgKz0gcGFkZGluZzsKCiAgICAgICAgICAgICAgICBpZiAocG9zID09PSAibGVmdCIpIHsKICAgICAgICAgICAgICAgICAgICBheGlzLmJveCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogcGxvdE9mZnNldC5sZWZ0ICsgYXhpc01hcmdpbiwKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGx3CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBwbG90T2Zmc2V0LmxlZnQgKz0gbHcgKyBheGlzTWFyZ2luOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwbG90T2Zmc2V0LnJpZ2h0ICs9IGx3ICsgYXhpc01hcmdpbjsKICAgICAgICAgICAgICAgICAgICBheGlzLmJveCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogc3VyZmFjZS53aWR0aCAtIHBsb3RPZmZzZXQucmlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBsdwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNhdmUgZm9yIGZ1dHVyZSByZWZlcmVuY2UKICAgICAgICAgICAgYXhpcy5wb3NpdGlvbiA9IHBvczsKICAgICAgICAgICAgYXhpcy50aWNrTGVuZ3RoID0gdGlja0xlbmd0aDsKICAgICAgICAgICAgYXhpcy5zaG93TWlub3JUaWNrcyA9IHNob3dNaW5vclRpY2tzOwogICAgICAgICAgICBheGlzLnNob3dUaWNrcyA9IHNob3dUaWNrczsKICAgICAgICAgICAgYXhpcy5ncmlkTGluZXMgPSBncmlkTGluZXM7CiAgICAgICAgICAgIGF4aXMuYm94LnBhZGRpbmcgPSBwYWRkaW5nOwogICAgICAgICAgICBheGlzLmlubmVybW9zdCA9IGlubmVybW9zdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGFsbG9jYXRlQXhpc0JveFNlY29uZFBoYXNlKGF4aXMpIHsKICAgICAgICAgICAgLy8gbm93IHRoYXQgYWxsIGF4aXMgYm94ZXMgaGF2ZSBiZWVuIHBsYWNlZCBpbiBvbmUKICAgICAgICAgICAgLy8gZGltZW5zaW9uLCB3ZSBjYW4gc2V0IHRoZSByZW1haW5pbmcgZGltZW5zaW9uIGNvb3JkaW5hdGVzCiAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICBheGlzLmJveC5sZWZ0ID0gcGxvdE9mZnNldC5sZWZ0IC0gYXhpcy5sYWJlbFdpZHRoIC8gMjsKICAgICAgICAgICAgICAgIGF4aXMuYm94LndpZHRoID0gc3VyZmFjZS53aWR0aCAtIHBsb3RPZmZzZXQubGVmdCAtIHBsb3RPZmZzZXQucmlnaHQgKyBheGlzLmxhYmVsV2lkdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBheGlzLmJveC50b3AgPSBwbG90T2Zmc2V0LnRvcCAtIGF4aXMubGFiZWxIZWlnaHQgLyAyOwogICAgICAgICAgICAgICAgYXhpcy5ib3guaGVpZ2h0ID0gc3VyZmFjZS5oZWlnaHQgLSBwbG90T2Zmc2V0LmJvdHRvbSAtIHBsb3RPZmZzZXQudG9wICsgYXhpcy5sYWJlbEhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRqdXN0TGF5b3V0Rm9yVGhpbmdzU3RpY2tpbmdPdXQoKSB7CiAgICAgICAgICAgIC8vIHBvc3NpYmx5IGFkanVzdCBwbG90IG9mZnNldCB0byBlbnN1cmUgZXZlcnl0aGluZyBzdGF5cwogICAgICAgICAgICAvLyBpbnNpZGUgdGhlIGNhbnZhcyBhbmQgaXNuJ3QgY2xpcHBlZCBvZmYKCiAgICAgICAgICAgIHZhciBtaW5NYXJnaW4gPSBvcHRpb25zLmdyaWQubWluQm9yZGVyTWFyZ2luLAogICAgICAgICAgICAgICAgaTsKCiAgICAgICAgICAgIC8vIGNoZWNrIHN0dWZmIGZyb20gdGhlIHBsb3QgKEZJWE1FOiB0aGlzIHNob3VsZCBqdXN0IHJlYWQKICAgICAgICAgICAgLy8gYSB2YWx1ZSBmcm9tIHRoZSBzZXJpZXMsIG90aGVyd2lzZSBpdCdzIGltcG9zc2libGUgdG8KICAgICAgICAgICAgLy8gY3VzdG9taXplKQogICAgICAgICAgICBpZiAobWluTWFyZ2luID09IG51bGwpIHsKICAgICAgICAgICAgICAgIG1pbk1hcmdpbiA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgbWluTWFyZ2luID0gTWF0aC5tYXgobWluTWFyZ2luLCAyICogKHNlcmllc1tpXS5wb2ludHMucmFkaXVzICsgc2VyaWVzW2ldLnBvaW50cy5saW5lV2lkdGggLyAyKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBhLCBvZmZzZXQgPSB7fSwKICAgICAgICAgICAgICAgIG1hcmdpbnMgPSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogbWluTWFyZ2luLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiBtaW5NYXJnaW4sCiAgICAgICAgICAgICAgICAgICAgdG9wOiBtaW5NYXJnaW4sCiAgICAgICAgICAgICAgICAgICAgYm90dG9tOiBtaW5NYXJnaW4KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBjaGVjayBheGlzIGxhYmVscywgbm90ZSB3ZSBkb24ndCBjaGVjayB0aGUgYWN0dWFsCiAgICAgICAgICAgIC8vIGxhYmVscyBidXQgaW5zdGVhZCB1c2UgdGhlIG92ZXJhbGwgd2lkdGgvaGVpZ2h0IHRvIG5vdAogICAgICAgICAgICAvLyBqdW1wIGFzIG11Y2ggYXJvdW5kIHdpdGggcmVwbG90cwogICAgICAgICAgICAkLmVhY2goYWxsQXhlcygpLCBmdW5jdGlvbihfLCBheGlzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXhpcy5yZXNlcnZlU3BhY2UgJiYgYXhpcy50aWNrcyAmJiBheGlzLnRpY2tzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbnMubGVmdCA9IE1hdGgubWF4KG1hcmdpbnMubGVmdCwgYXhpcy5sYWJlbFdpZHRoIC8gMik7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbnMucmlnaHQgPSBNYXRoLm1heChtYXJnaW5zLnJpZ2h0LCBheGlzLmxhYmVsV2lkdGggLyAyKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5zLmJvdHRvbSA9IE1hdGgubWF4KG1hcmdpbnMuYm90dG9tLCBheGlzLmxhYmVsSGVpZ2h0IC8gMik7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbnMudG9wID0gTWF0aC5tYXgobWFyZ2lucy50b3AsIGF4aXMubGFiZWxIZWlnaHQgLyAyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9yIChhIGluIG1hcmdpbnMpIHsKICAgICAgICAgICAgICAgIG9mZnNldFthXSA9IG1hcmdpbnNbYV0gLSBwbG90T2Zmc2V0W2FdOwogICAgICAgICAgICB9CiAgICAgICAgICAgICQuZWFjaCh4YXhlcy5jb25jYXQoeWF4ZXMpLCBmdW5jdGlvbihfLCBheGlzKSB7CiAgICAgICAgICAgICAgICBhbGlnbkF4aXNXaXRoR3JpZChheGlzLCBvZmZzZXQsIGZ1bmN0aW9uIChvZmZzZXQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2Zmc2V0ID4gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHBsb3RPZmZzZXQubGVmdCA9IE1hdGguY2VpbChNYXRoLm1heChtYXJnaW5zLmxlZnQsIHBsb3RPZmZzZXQubGVmdCkpOwogICAgICAgICAgICBwbG90T2Zmc2V0LnJpZ2h0ID0gTWF0aC5jZWlsKE1hdGgubWF4KG1hcmdpbnMucmlnaHQsIHBsb3RPZmZzZXQucmlnaHQpKTsKICAgICAgICAgICAgcGxvdE9mZnNldC50b3AgPSBNYXRoLmNlaWwoTWF0aC5tYXgobWFyZ2lucy50b3AsIHBsb3RPZmZzZXQudG9wKSk7CiAgICAgICAgICAgIHBsb3RPZmZzZXQuYm90dG9tID0gTWF0aC5jZWlsKE1hdGgubWF4KG1hcmdpbnMuYm90dG9tLCBwbG90T2Zmc2V0LmJvdHRvbSkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWxpZ25BeGlzV2l0aEdyaWQoYXhpcywgb2Zmc2V0LCBpc1ZhbGlkKSB7CiAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PT0gImJvdHRvbSIgJiYgaXNWYWxpZChvZmZzZXQuYm90dG9tKSkgewogICAgICAgICAgICAgICAgICAgIGF4aXMuYm94LnRvcCAtPSBNYXRoLmNlaWwob2Zmc2V0LmJvdHRvbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PT0gInRvcCIgJiYgaXNWYWxpZChvZmZzZXQudG9wKSkgewogICAgICAgICAgICAgICAgICAgIGF4aXMuYm94LnRvcCArPSBNYXRoLmNlaWwob2Zmc2V0LnRvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PT0gImxlZnQiICYmIGlzVmFsaWQob2Zmc2V0LmxlZnQpKSB7CiAgICAgICAgICAgICAgICAgICAgYXhpcy5ib3gubGVmdCArPSBNYXRoLmNlaWwob2Zmc2V0LmxlZnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT09ICJyaWdodCIgJiYgaXNWYWxpZChvZmZzZXQucmlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgYXhpcy5ib3gubGVmdCAtPSBNYXRoLmNlaWwob2Zmc2V0LnJpZ2h0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0dXBHcmlkKGF1dG9TY2FsZSkgewogICAgICAgICAgICB2YXIgaSwgYSwgYXhlcyA9IGFsbEF4ZXMoKSwKICAgICAgICAgICAgICAgIHNob3dHcmlkID0gb3B0aW9ucy5ncmlkLnNob3c7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBwbG90J3Mgb2Zmc2V0IGZyb20gdGhlIGVkZ2Ugb2YgdGhlIGNhbnZhcwoKICAgICAgICAgICAgZm9yIChhIGluIHBsb3RPZmZzZXQpIHsKICAgICAgICAgICAgICAgIHBsb3RPZmZzZXRbYV0gPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucHJvY2Vzc09mZnNldCwgW3Bsb3RPZmZzZXRdKTsKCiAgICAgICAgICAgIC8vIElmIHRoZSBncmlkIGlzIHZpc2libGUsIGFkZCBpdHMgYm9yZGVyIHdpZHRoIHRvIHRoZSBvZmZzZXQKICAgICAgICAgICAgZm9yIChhIGluIHBsb3RPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgKG9wdGlvbnMuZ3JpZC5ib3JkZXJXaWR0aCkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgcGxvdE9mZnNldFthXSArPSBzaG93R3JpZCA/IG9wdGlvbnMuZ3JpZC5ib3JkZXJXaWR0aFthXSA6IDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBsb3RPZmZzZXRbYV0gKz0gc2hvd0dyaWQgPyBvcHRpb25zLmdyaWQuYm9yZGVyV2lkdGggOiAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAkLmVhY2goYXhlcywgZnVuY3Rpb24oXywgYXhpcykgewogICAgICAgICAgICAgICAgdmFyIGF4aXNPcHRzID0gYXhpcy5vcHRpb25zOwogICAgICAgICAgICAgICAgYXhpcy5zaG93ID0gYXhpc09wdHMuc2hvdyA9PSBudWxsID8gYXhpcy51c2VkIDogYXhpc09wdHMuc2hvdzsKICAgICAgICAgICAgICAgIGF4aXMucmVzZXJ2ZVNwYWNlID0gYXhpc09wdHMucmVzZXJ2ZVNwYWNlID09IG51bGwgPyBheGlzLnNob3cgOiBheGlzT3B0cy5yZXNlcnZlU3BhY2U7CiAgICAgICAgICAgICAgICBzZXR1cFRpY2tGb3JtYXR0ZXIoYXhpcyk7CiAgICAgICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3Muc2V0UmFuZ2UsIFtheGlzLCBhdXRvU2NhbGVdKTsKICAgICAgICAgICAgICAgIHNldFJhbmdlKGF4aXMsIGF1dG9TY2FsZSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHNob3dHcmlkKSB7CiAgICAgICAgICAgICAgICBwbG90V2lkdGggPSBzdXJmYWNlLndpZHRoIC0gcGxvdE9mZnNldC5sZWZ0IC0gcGxvdE9mZnNldC5yaWdodDsKICAgICAgICAgICAgICAgIHBsb3RIZWlnaHQgPSBzdXJmYWNlLmhlaWdodCAtIHBsb3RPZmZzZXQuYm90dG9tIC0gcGxvdE9mZnNldC50b3A7CgogICAgICAgICAgICAgICAgdmFyIGFsbG9jYXRlZEF4ZXMgPSAkLmdyZXAoYXhlcywgZnVuY3Rpb24oYXhpcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBheGlzLnNob3cgfHwgYXhpcy5yZXNlcnZlU3BhY2U7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAkLmVhY2goYWxsb2NhdGVkQXhlcywgZnVuY3Rpb24oXywgYXhpcykgewogICAgICAgICAgICAgICAgICAgIC8vIG1ha2UgdGhlIHRpY2tzCiAgICAgICAgICAgICAgICAgICAgc2V0dXBUaWNrR2VuZXJhdGlvbihheGlzKTsKICAgICAgICAgICAgICAgICAgICBzZXRNYWpvclRpY2tzKGF4aXMpOwogICAgICAgICAgICAgICAgICAgIHNuYXBSYW5nZVRvVGlja3MoYXhpcywgYXhpcy50aWNrcywgc2VyaWVzKTsKCiAgICAgICAgICAgICAgICAgICAgLy9mb3IgY29tcHV0aW5nIHRoZSBlbmRwb2ludHMgcHJlY2lzaW9uLCB0cmFuc2Zvcm1hdGlvbkhlbHBlcnMgYXJlIG5lZWRlZAogICAgICAgICAgICAgICAgICAgIHNldFRyYW5zZm9ybWF0aW9uSGVscGVycyhheGlzKTsKICAgICAgICAgICAgICAgICAgICBzZXRFbmRwb2ludFRpY2tzKGF4aXMsIHNlcmllcyk7CgogICAgICAgICAgICAgICAgICAgIC8vIGZpbmQgbGFiZWxXaWR0aC9IZWlnaHQgZm9yIGF4aXMKICAgICAgICAgICAgICAgICAgICBtZWFzdXJlVGlja0xhYmVscyhheGlzKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHdpdGggYWxsIGRpbWVuc2lvbnMgY2FsY3VsYXRlZCwgd2UgY2FuIGNvbXB1dGUgdGhlCiAgICAgICAgICAgICAgICAvLyBheGlzIGJvdW5kaW5nIGJveGVzLCBzdGFydCBmcm9tIHRoZSBvdXRzaWRlCiAgICAgICAgICAgICAgICAvLyAocmV2ZXJzZSBvcmRlcikKICAgICAgICAgICAgICAgIGZvciAoaSA9IGFsbG9jYXRlZEF4ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgICAgICAgICBhbGxvY2F0ZUF4aXNCb3hGaXJzdFBoYXNlKGFsbG9jYXRlZEF4ZXNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB3ZSd2ZSBnb3QgZW5vdWdoIHNwYWNlIGZvciB0aGluZ3MgdGhhdAogICAgICAgICAgICAgICAgLy8gbWlnaHQgc3RpY2sgb3V0CiAgICAgICAgICAgICAgICBhZGp1c3RMYXlvdXRGb3JUaGluZ3NTdGlja2luZ091dCgpOwoKICAgICAgICAgICAgICAgICQuZWFjaChhbGxvY2F0ZWRBeGVzLCBmdW5jdGlvbihfLCBheGlzKSB7CiAgICAgICAgICAgICAgICAgICAgYWxsb2NhdGVBeGlzQm94U2Vjb25kUGhhc2UoYXhpcyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9hZGp1c3QgYXhpcyBhbmQgcGxvdE9mZnNldCBhY2NvcmRpbmcgdG8gZ3JpZC5tYXJnaW5zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmdyaWQubWFyZ2luKSB7CiAgICAgICAgICAgICAgICBmb3IgKGEgaW4gcGxvdE9mZnNldCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXJnaW4gPSBvcHRpb25zLmdyaWQubWFyZ2luIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgcGxvdE9mZnNldFthXSArPSB0eXBlb2YgbWFyZ2luID09PSAibnVtYmVyIiA/IG1hcmdpbiA6IChtYXJnaW5bYV0gfHwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkLmVhY2goeGF4ZXMuY29uY2F0KHlheGVzKSwgZnVuY3Rpb24oXywgYXhpcykgewogICAgICAgICAgICAgICAgICAgIGFsaWduQXhpc1dpdGhHcmlkKGF4aXMsIG9wdGlvbnMuZ3JpZC5tYXJnaW4sIGZ1bmN0aW9uKG9mZnNldCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2Zmc2V0ICE9PSB1bmRlZmluZWQgJiYgb2Zmc2V0ICE9PSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vYWZ0ZXIgYWRqdXN0aW5nIHRoZSBheGlzLCBwbG90IHdpZHRoIGFuZCBoZWlnaHQgd2lsbCBiZSBtb2RpZmllZAogICAgICAgICAgICBwbG90V2lkdGggPSBzdXJmYWNlLndpZHRoIC0gcGxvdE9mZnNldC5sZWZ0IC0gcGxvdE9mZnNldC5yaWdodDsKICAgICAgICAgICAgcGxvdEhlaWdodCA9IHN1cmZhY2UuaGVpZ2h0IC0gcGxvdE9mZnNldC5ib3R0b20gLSBwbG90T2Zmc2V0LnRvcDsKCiAgICAgICAgICAgIC8vIG5vdyB3ZSBnb3QgdGhlIHByb3BlciBwbG90IGRpbWVuc2lvbnMsIHdlIGNhbiBjb21wdXRlIHRoZSBzY2FsaW5nCiAgICAgICAgICAgICQuZWFjaChheGVzLCBmdW5jdGlvbihfLCBheGlzKSB7CiAgICAgICAgICAgICAgICBzZXRUcmFuc2Zvcm1hdGlvbkhlbHBlcnMoYXhpcyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHNob3dHcmlkKSB7CiAgICAgICAgICAgICAgICBkcmF3QXhpc0xhYmVscygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3Muc2V0dXBHcmlkLCBbXSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB3aWRlbk1pbk1heChtaW5pbXVtLCBtYXhpbXVtKSB7CiAgICAgICAgICAgIHZhciBtaW4gPSAobWluaW11bSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IG1pbmltdW0pOwogICAgICAgICAgICB2YXIgbWF4ID0gKG1heGltdW0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBtYXhpbXVtKTsKICAgICAgICAgICAgdmFyIGRlbHRhID0gbWF4IC0gbWluOwogICAgICAgICAgICBpZiAoZGVsdGEgPT09IDAuMCkgewogICAgICAgICAgICAgICAgLy8gZGVnZW5lcmF0ZSBjYXNlCiAgICAgICAgICAgICAgICB2YXIgd2lkZW4gPSBtYXggPT09IDAgPyAxIDogMC4wMTsKICAgICAgICAgICAgICAgIHZhciB3bWluID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChtaW4gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdtaW4gLT0gd2lkZW47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWx3YXlzIHdpZGVuIG1heCBpZiB3ZSBjb3VsZG4ndCB3aWRlbiBtaW4gdG8gZW5zdXJlIHdlCiAgICAgICAgICAgICAgICAvLyBkb24ndCBmYWxsIGludG8gbWluID09IG1heCB3aGljaCBkb2Vzbid0IHdvcmsKICAgICAgICAgICAgICAgIGlmIChtYXggPT0gbnVsbCB8fCBtaW4gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG1heCArPSB3aWRlbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAod21pbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbWluID0gd21pbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIG1pbjogbWluLAogICAgICAgICAgICAgICAgbWF4OiBtYXgKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGF1dG9TY2FsZUF4aXMoYXhpcykgewogICAgICAgICAgICB2YXIgb3B0cyA9IGF4aXMub3B0aW9ucywKICAgICAgICAgICAgICAgIG1pbiA9IG9wdHMubWluLAogICAgICAgICAgICAgICAgbWF4ID0gb3B0cy5tYXgsCiAgICAgICAgICAgICAgICBkYXRhbWluID0gYXhpcy5kYXRhbWluLAogICAgICAgICAgICAgICAgZGF0YW1heCA9IGF4aXMuZGF0YW1heCwKICAgICAgICAgICAgICAgIGRlbHRhOwoKICAgICAgICAgICAgc3dpdGNoIChvcHRzLmF1dG9TY2FsZSkgewogICAgICAgICAgICAgICAgY2FzZSAibm9uZSI6CiAgICAgICAgICAgICAgICAgICAgbWluID0gKyhvcHRzLm1pbiAhPSBudWxsID8gb3B0cy5taW4gOiBkYXRhbWluKTsKICAgICAgICAgICAgICAgICAgICBtYXggPSArKG9wdHMubWF4ICE9IG51bGwgPyBvcHRzLm1heCA6IGRhdGFtYXgpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAibG9vc2UiOgogICAgICAgICAgICAgICAgICAgIGlmIChkYXRhbWluICE9IG51bGwgJiYgZGF0YW1heCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbiA9IGRhdGFtaW47CiAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9IGRhdGFtYXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhID0gJC5wbG90LnNhdHVyYXRlZC5zYXR1cmF0ZShtYXggLSBtaW4pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWFyZ2luID0gKCh0eXBlb2Ygb3B0cy5hdXRvU2NhbGVNYXJnaW4gPT09ICdudW1iZXInKSA/IG9wdHMuYXV0b1NjYWxlTWFyZ2luIDogMC4wMik7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbiA9ICQucGxvdC5zYXR1cmF0ZWQuc2F0dXJhdGUobWluIC0gZGVsdGEgKiBtYXJnaW4pOwogICAgICAgICAgICAgICAgICAgICAgICBtYXggPSAkLnBsb3Quc2F0dXJhdGVkLnNhdHVyYXRlKG1heCArIGRlbHRhICogbWFyZ2luKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB3ZSBkb24ndCBnbyBiZWxvdyB6ZXJvIGlmIGFsbCB2YWx1ZXMgYXJlIHBvc2l0aXZlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtaW4gPCAwICYmIGRhdGFtaW4gPj0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbiA9IG9wdHMubWluOwogICAgICAgICAgICAgICAgICAgICAgICBtYXggPSBvcHRzLm1heDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJleGFjdCI6CiAgICAgICAgICAgICAgICAgICAgbWluID0gKGRhdGFtaW4gIT0gbnVsbCA/IGRhdGFtaW4gOiBvcHRzLm1pbik7CiAgICAgICAgICAgICAgICAgICAgbWF4ID0gKGRhdGFtYXggIT0gbnVsbCA/IGRhdGFtYXggOiBvcHRzLm1heCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJzbGlkaW5nLXdpbmRvdyI6CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFtYXggPiBtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZSB0aGUgd2luZG93IHRvIGZpdCB0aGUgbmV3IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGtlZXBpbmcgdGhlIGF4aXMgcmFuZ2UgY29uc3RhbnQKICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gZGF0YW1heDsKICAgICAgICAgICAgICAgICAgICAgICAgbWluID0gTWF0aC5tYXgoZGF0YW1heCAtIChvcHRzLndpbmRvd1NpemUgfHwgMTAwKSwgbWluKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB3aWRlbmVkTWluTWF4ID0gd2lkZW5NaW5NYXgobWluLCBtYXgpOwogICAgICAgICAgICBtaW4gPSB3aWRlbmVkTWluTWF4Lm1pbjsKICAgICAgICAgICAgbWF4ID0gd2lkZW5lZE1pbk1heC5tYXg7CgogICAgICAgICAgICAvLyBncm93IGxvb3NlIG9yIGdyb3cgZXhhY3Qgc3VwcG9ydGVkCiAgICAgICAgICAgIGlmIChvcHRzLmdyb3dPbmx5ID09PSB0cnVlICYmIG9wdHMuYXV0b1NjYWxlICE9PSAibm9uZSIgJiYgb3B0cy5hdXRvU2NhbGUgIT09ICJzbGlkaW5nLXdpbmRvdyIpIHsKICAgICAgICAgICAgICAgIG1pbiA9IChtaW4gPCBkYXRhbWluKSA/IG1pbiA6IChkYXRhbWluICE9PSBudWxsID8gZGF0YW1pbiA6IG1pbik7CiAgICAgICAgICAgICAgICBtYXggPSAobWF4ID4gZGF0YW1heCkgPyBtYXggOiAoZGF0YW1heCAhPT0gbnVsbCA/IGRhdGFtYXggOiBtYXgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBheGlzLmF1dG9TY2FsZWRNaW4gPSBtaW47CiAgICAgICAgICAgIGF4aXMuYXV0b1NjYWxlZE1heCA9IG1heDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldFJhbmdlKGF4aXMsIGF1dG9TY2FsZSkgewogICAgICAgICAgICB2YXIgbWluID0gdHlwZW9mIGF4aXMub3B0aW9ucy5taW4gPT09ICdudW1iZXInID8gYXhpcy5vcHRpb25zLm1pbiA6IGF4aXMubWluLAogICAgICAgICAgICAgICAgbWF4ID0gdHlwZW9mIGF4aXMub3B0aW9ucy5tYXggPT09ICdudW1iZXInID8gYXhpcy5vcHRpb25zLm1heCA6IGF4aXMubWF4LAogICAgICAgICAgICAgICAgcGxvdE9mZnNldCA9IGF4aXMub3B0aW9ucy5vZmZzZXQ7CgogICAgICAgICAgICBpZiAoYXV0b1NjYWxlKSB7CiAgICAgICAgICAgICAgICBhdXRvU2NhbGVBeGlzKGF4aXMpOwogICAgICAgICAgICAgICAgbWluID0gYXhpcy5hdXRvU2NhbGVkTWluOwogICAgICAgICAgICAgICAgbWF4ID0gYXhpcy5hdXRvU2NhbGVkTWF4OwogICAgICAgICAgICB9CgogICAgICAgICAgICBtaW4gPSAobWluICE9IG51bGwgPyBtaW4gOiAtMSkgKyAocGxvdE9mZnNldC5iZWxvdyB8fCAwKTsKICAgICAgICAgICAgbWF4ID0gKG1heCAhPSBudWxsID8gbWF4IDogMSkgKyAocGxvdE9mZnNldC5hYm92ZSB8fCAwKTsKCiAgICAgICAgICAgIGlmIChtaW4gPiBtYXgpIHsKICAgICAgICAgICAgICAgIHZhciB0bXAgPSBtaW47CiAgICAgICAgICAgICAgICBtaW4gPSBtYXg7CiAgICAgICAgICAgICAgICBtYXggPSB0bXA7CiAgICAgICAgICAgICAgICBheGlzLm9wdGlvbnMub2Zmc2V0ID0geyBhYm92ZTogMCwgYmVsb3c6IDAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXhpcy5taW4gPSAkLnBsb3Quc2F0dXJhdGVkLnNhdHVyYXRlKG1pbik7CiAgICAgICAgICAgIGF4aXMubWF4ID0gJC5wbG90LnNhdHVyYXRlZC5zYXR1cmF0ZShtYXgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tcHV0ZVZhbHVlUHJlY2lzaW9uIChtaW4sIG1heCwgZGlyZWN0aW9uLCB0aWNrcywgdGlja0RlY2ltYWxzKSB7CiAgICAgICAgICAgIHZhciBub1RpY2tzID0gZml4dXBOdW1iZXJPZlRpY2tzKGRpcmVjdGlvbiwgc3VyZmFjZSwgdGlja3MpOwoKICAgICAgICAgICAgdmFyIGRlbHRhID0gJC5wbG90LnNhdHVyYXRlZC5kZWx0YShtaW4sIG1heCwgbm9UaWNrcyksCiAgICAgICAgICAgICAgICBkZWMgPSAtTWF0aC5mbG9vcihNYXRoLmxvZyhkZWx0YSkgLyBNYXRoLkxOMTApOwoKICAgICAgICAgICAgLy9pZiBpdCBpcyBjYWxsZWQgd2l0aCB0aWNrRGVjaW1hbHMsIHRoZW4gdGhlIHByZWNpc2lvbiBzaG91bGQgbm90IGJlIGdyZWF0aGVyIHRoZW4gdGhhdAogICAgICAgICAgICBpZiAodGlja0RlY2ltYWxzICYmIGRlYyA+IHRpY2tEZWNpbWFscykgewogICAgICAgICAgICAgICAgZGVjID0gdGlja0RlY2ltYWxzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWFnbiA9IHBhcnNlRmxvYXQoJzFlJyArICgtZGVjKSksCiAgICAgICAgICAgICAgICBub3JtID0gZGVsdGEgLyBtYWduOwoKICAgICAgICAgICAgaWYgKG5vcm0gPiAyLjI1ICYmIG5vcm0gPCAzICYmIChkZWMgKyAxKSA8PSB0aWNrRGVjaW1hbHMpIHsKICAgICAgICAgICAgICAgIC8vd2UgbmVlZCBhbiBleHRyYSBkZWNpbWFscyB3aGVuIHRpY2tTaXplIGlzIDIuNQogICAgICAgICAgICAgICAgKytkZWM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBpc0Zpbml0ZShkZWMpID8gZGVjIDogMDsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBjb21wdXRlVGlja1NpemUgKG1pbiwgbWF4LCBub1RpY2tzLCB0aWNrRGVjaW1hbHMpIHsKICAgICAgICAgICAgdmFyIGRlbHRhID0gJC5wbG90LnNhdHVyYXRlZC5kZWx0YShtaW4sIG1heCwgbm9UaWNrcyksCiAgICAgICAgICAgICAgICBkZWMgPSAtTWF0aC5mbG9vcihNYXRoLmxvZyhkZWx0YSkgLyBNYXRoLkxOMTApOwoKICAgICAgICAgICAgLy9pZiBpdCBpcyBjYWxsZWQgd2l0aCB0aWNrRGVjaW1hbHMsIHRoZW4gdGhlIHByZWNpc2lvbiBzaG91bGQgbm90IGJlIGdyZWF0aGVyIHRoZW4gdGhhdAogICAgICAgICAgICBpZiAodGlja0RlY2ltYWxzICYmIGRlYyA+IHRpY2tEZWNpbWFscykgewogICAgICAgICAgICAgICAgZGVjID0gdGlja0RlY2ltYWxzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWFnbiA9IHBhcnNlRmxvYXQoJzFlJyArICgtZGVjKSksCiAgICAgICAgICAgICAgICBub3JtID0gZGVsdGEgLyBtYWduLCAvLyBub3JtIGlzIGJldHdlZW4gMS4wIGFuZCAxMC4wCiAgICAgICAgICAgICAgICBzaXplOwoKICAgICAgICAgICAgaWYgKG5vcm0gPCAxLjUpIHsKICAgICAgICAgICAgICAgIHNpemUgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vcm0gPCAzKSB7CiAgICAgICAgICAgICAgICBzaXplID0gMjsKICAgICAgICAgICAgICAgIGlmIChub3JtID4gMi4yNSAmJiAodGlja0RlY2ltYWxzID09IG51bGwgfHwgKGRlYyArIDEpIDw9IHRpY2tEZWNpbWFscykpIHsKICAgICAgICAgICAgICAgICAgICBzaXplID0gMi41OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vcm0gPCA3LjUpIHsKICAgICAgICAgICAgICAgIHNpemUgPSA1OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2l6ZSA9IDEwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzaXplICo9IG1hZ247CiAgICAgICAgICAgIHJldHVybiBzaXplOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0QXhpc1RpY2tTaXplKG1pbiwgbWF4LCBkaXJlY3Rpb24sIG9wdGlvbnMsIHRpY2tEZWNpbWFscykgewogICAgICAgICAgICB2YXIgbm9UaWNrczsKCiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy50aWNrcyA9PT0gIm51bWJlciIgJiYgb3B0aW9ucy50aWNrcyA+IDApIHsKICAgICAgICAgICAgICAgIG5vVGlja3MgPSBvcHRpb25zLnRpY2tzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBoZXVyaXN0aWMgYmFzZWQgb24gdGhlIG1vZGVsIGEqc3FydCh4KSBmaXR0ZWQgdG8KICAgICAgICAgICAgLy8gc29tZSBkYXRhIHBvaW50cyB0aGF0IHNlZW1lZCByZWFzb25hYmxlCiAgICAgICAgICAgICAgICBub1RpY2tzID0gMC4zICogTWF0aC5zcXJ0KGRpcmVjdGlvbiA9PT0gIngiID8gc3VyZmFjZS53aWR0aCA6IHN1cmZhY2UuaGVpZ2h0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHNpemUgPSBjb21wdXRlVGlja1NpemUobWluLCBtYXgsIG5vVGlja3MsIHRpY2tEZWNpbWFscyk7CgogICAgICAgICAgICBpZiAob3B0aW9ucy5taW5UaWNrU2l6ZSAhPSBudWxsICYmIHNpemUgPCBvcHRpb25zLm1pblRpY2tTaXplKSB7CiAgICAgICAgICAgICAgICBzaXplID0gb3B0aW9ucy5taW5UaWNrU2l6ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMudGlja1NpemUgfHwgc2l6ZTsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBmaXh1cE51bWJlck9mVGlja3MoZGlyZWN0aW9uLCBzdXJmYWNlLCB0aWNrc09wdGlvbikgewogICAgICAgICAgICB2YXIgbm9UaWNrczsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdGlja3NPcHRpb24gPT09ICJudW1iZXIiICYmIHRpY2tzT3B0aW9uID4gMCkgewogICAgICAgICAgICAgICAgbm9UaWNrcyA9IHRpY2tzT3B0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbm9UaWNrcyA9IDAuMyAqIE1hdGguc3FydChkaXJlY3Rpb24gPT09ICJ4IiA/IHN1cmZhY2Uud2lkdGggOiBzdXJmYWNlLmhlaWdodCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBub1RpY2tzOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0dXBUaWNrRm9ybWF0dGVyKGF4aXMpIHsKICAgICAgICAgICAgdmFyIG9wdHMgPSBheGlzLm9wdGlvbnM7CiAgICAgICAgICAgIGlmICghYXhpcy50aWNrRm9ybWF0dGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdHMudGlja0Zvcm1hdHRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIGF4aXMudGlja0Zvcm1hdHRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiIiArIG9wdHMudGlja0Zvcm1hdHRlci5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBheGlzLnRpY2tGb3JtYXR0ZXIgPSBkZWZhdWx0VGlja0Zvcm1hdHRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0dXBUaWNrR2VuZXJhdGlvbihheGlzKSB7CiAgICAgICAgICAgIHZhciBvcHRzID0gYXhpcy5vcHRpb25zOwogICAgICAgICAgICB2YXIgbm9UaWNrczsKCiAgICAgICAgICAgIG5vVGlja3MgPSBmaXh1cE51bWJlck9mVGlja3MoYXhpcy5kaXJlY3Rpb24sIHN1cmZhY2UsIG9wdHMudGlja3MpOwoKICAgICAgICAgICAgYXhpcy5kZWx0YSA9ICQucGxvdC5zYXR1cmF0ZWQuZGVsdGEoYXhpcy5taW4sIGF4aXMubWF4LCBub1RpY2tzKTsKICAgICAgICAgICAgdmFyIHByZWNpc2lvbiA9IHBsb3QuY29tcHV0ZVZhbHVlUHJlY2lzaW9uKGF4aXMubWluLCBheGlzLm1heCwgYXhpcy5kaXJlY3Rpb24sIG5vVGlja3MsIG9wdHMudGlja0RlY2ltYWxzKTsKCiAgICAgICAgICAgIGF4aXMudGlja0RlY2ltYWxzID0gTWF0aC5tYXgoMCwgb3B0cy50aWNrRGVjaW1hbHMgIT0gbnVsbCA/IG9wdHMudGlja0RlY2ltYWxzIDogcHJlY2lzaW9uKTsKICAgICAgICAgICAgYXhpcy50aWNrU2l6ZSA9IGdldEF4aXNUaWNrU2l6ZShheGlzLm1pbiwgYXhpcy5tYXgsIGF4aXMuZGlyZWN0aW9uLCBvcHRzLCBvcHRzLnRpY2tEZWNpbWFscyk7CgogICAgICAgICAgICAvLyBGbG90IHN1cHBvcnRzIGJhc2UtMTAgYXhlczsgYW55IG90aGVyIG1vZGUgZWxzZSBpcyBoYW5kbGVkIGJ5IGEgcGx1Zy1pbiwKICAgICAgICAgICAgLy8gbGlrZSBmbG90LnRpbWUuanMuCgogICAgICAgICAgICBpZiAoIWF4aXMudGlja0dlbmVyYXRvcikgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRzLnRpY2tHZW5lcmF0b3IgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICBheGlzLnRpY2tHZW5lcmF0b3IgPSBvcHRzLnRpY2tHZW5lcmF0b3I7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGF4aXMudGlja0dlbmVyYXRvciA9IGRlZmF1bHRUaWNrR2VuZXJhdG9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0cy5hbGlnblRpY2tzV2l0aEF4aXMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG90aGVyQXhpcyA9IChheGlzLmRpcmVjdGlvbiA9PT0gIngiID8geGF4ZXMgOiB5YXhlcylbb3B0cy5hbGlnblRpY2tzV2l0aEF4aXMgLSAxXTsKICAgICAgICAgICAgICAgIGlmIChvdGhlckF4aXMgJiYgb3RoZXJBeGlzLnVzZWQgJiYgb3RoZXJBeGlzICE9PSBheGlzKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc2lkZXIgc25hcHBpbmcgbWluL21heCB0byBvdXRlcm1vc3QgbmljZSB0aWNrcwogICAgICAgICAgICAgICAgICAgIHZhciBuaWNlVGlja3MgPSBheGlzLnRpY2tHZW5lcmF0b3IoYXhpcywgcGxvdCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5pY2VUaWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLm1pbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBheGlzLm1pbiA9IE1hdGgubWluKGF4aXMubWluLCBuaWNlVGlja3NbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5tYXggPT0gbnVsbCAmJiBuaWNlVGlja3MubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXhpcy5tYXggPSBNYXRoLm1heChheGlzLm1heCwgbmljZVRpY2tzW25pY2VUaWNrcy5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGF4aXMudGlja0dlbmVyYXRvciA9IGZ1bmN0aW9uKGF4aXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29weSB0aWNrcywgc2NhbGVkIHRvIHRoaXMgYXhpcwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGlja3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYsIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvdGhlckF4aXMudGlja3MubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSAob3RoZXJBeGlzLnRpY2tzW2ldLnYgLSBvdGhlckF4aXMubWluKSAvIChvdGhlckF4aXMubWF4IC0gb3RoZXJBeGlzLm1pbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ID0gYXhpcy5taW4gKyB2ICogKGF4aXMubWF4IC0gYXhpcy5taW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlja3MucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGlja3M7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgbWlnaHQgbmVlZCBhbiBleHRyYSBkZWNpbWFsIHNpbmNlIGZvcmNlZAogICAgICAgICAgICAgICAgICAgIC8vIHRpY2tzIGRvbid0IG5lY2Vzc2FyaWx5IGZpdCBuYXR1cmFsbHkKICAgICAgICAgICAgICAgICAgICBpZiAoIWF4aXMubW9kZSAmJiBvcHRzLnRpY2tEZWNpbWFscyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBleHRyYURlYyA9IE1hdGgubWF4KDAsIC1NYXRoLmZsb29yKE1hdGgubG9nKGF4aXMuZGVsdGEpIC8gTWF0aC5MTjEwKSArIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHMgPSBheGlzLnRpY2tHZW5lcmF0b3IoYXhpcywgcGxvdCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IHByb2NlZWQgaWYgdGhlIHRpY2sgaW50ZXJ2YWwgcm91bmRlZAogICAgICAgICAgICAgICAgICAgICAgICAvLyB3aXRoIGFuIGV4dHJhIGRlY2ltYWwgZG9lc24ndCBnaXZlIHVzIGEKICAgICAgICAgICAgICAgICAgICAgICAgLy8gemVybyBhdCBlbmQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodHMubGVuZ3RoID4gMSAmJiAvXC4uKjAkLy50ZXN0KCh0c1sxXSAtIHRzWzBdKS50b0ZpeGVkKGV4dHJhRGVjKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBheGlzLnRpY2tEZWNpbWFscyA9IGV4dHJhRGVjOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXRNYWpvclRpY2tzKGF4aXMpIHsKICAgICAgICAgICAgdmFyIG90aWNrcyA9IGF4aXMub3B0aW9ucy50aWNrcywKICAgICAgICAgICAgICAgIHRpY2tzID0gW107CiAgICAgICAgICAgIGlmIChvdGlja3MgPT0gbnVsbCB8fCAodHlwZW9mIG90aWNrcyA9PT0gIm51bWJlciIgJiYgb3RpY2tzID4gMCkpIHsKICAgICAgICAgICAgICAgIHRpY2tzID0gYXhpcy50aWNrR2VuZXJhdG9yKGF4aXMsIHBsb3QpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG90aWNrcykgewogICAgICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihvdGlja3MpKSB7CiAgICAgICAgICAgICAgICAvLyBnZW5lcmF0ZSB0aGUgdGlja3MKICAgICAgICAgICAgICAgICAgICB0aWNrcyA9IG90aWNrcyhheGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGlja3MgPSBvdGlja3M7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNsZWFuIHVwL2xhYmVsaWZ5IHRoZSBzdXBwbGllZCB0aWNrcywgY29weSB0aGVtIG92ZXIKICAgICAgICAgICAgdmFyIGksIHY7CiAgICAgICAgICAgIGF4aXMudGlja3MgPSBbXTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRpY2tzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHQgPSB0aWNrc1tpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdCA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICB2ID0gK3RbMF07CiAgICAgICAgICAgICAgICAgICAgaWYgKHQubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IHRbMV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2ID0gK3Q7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFpc05hTih2KSkgewogICAgICAgICAgICAgICAgICAgIGF4aXMudGlja3MucHVzaCgKICAgICAgICAgICAgICAgICAgICAgICAgbmV3VGljayh2LCBsYWJlbCwgYXhpcywgJ21ham9yJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBuZXdUaWNrKHYsIGxhYmVsLCBheGlzLCB0eXBlKSB7CiAgICAgICAgICAgIGlmIChsYWJlbCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbWluJzoKICAgICAgICAgICAgICAgICAgICBjYXNlICdtYXgnOgogICAgICAgICAgICAgICAgICAgICAgICAvL2ltcHJvdmluZyB0aGUgcHJlY2lzaW9uIG9mIGVuZHBvaW50cwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJlY2lzaW9uID0gZ2V0RW5kcG9pbnRQcmVjaXNpb24odiwgYXhpcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gaXNGaW5pdGUocHJlY2lzaW9uKSA/IGF4aXMudGlja0Zvcm1hdHRlcih2LCBheGlzLCBwcmVjaXNpb24sIHBsb3QpIDogYXhpcy50aWNrRm9ybWF0dGVyKHYsIGF4aXMsIHByZWNpc2lvbiwgcGxvdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ21ham9yJzoKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBheGlzLnRpY2tGb3JtYXR0ZXIodiwgYXhpcywgdW5kZWZpbmVkLCBwbG90KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdjogdiwKICAgICAgICAgICAgICAgIGxhYmVsOiBsYWJlbAogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc25hcFJhbmdlVG9UaWNrcyhheGlzLCB0aWNrcywgc2VyaWVzKSB7CiAgICAgICAgICAgIHZhciBhbnlEYXRhSW5TZXJpZXMgPSBmdW5jdGlvbihzZXJpZXMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJpZXMuc29tZShlID0+IGUuZGF0YXBvaW50cy5wb2ludHMubGVuZ3RoID4gMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChheGlzLm9wdGlvbnMuYXV0b1NjYWxlID09PSAibG9vc2UiICYmIHRpY2tzLmxlbmd0aCA+IDAgJiYgYW55RGF0YUluU2VyaWVzKHNlcmllcykpIHsKICAgICAgICAgICAgICAgIC8vIHNuYXAgdG8gdGlja3MKICAgICAgICAgICAgICAgIGF4aXMubWluID0gTWF0aC5taW4oYXhpcy5taW4sIHRpY2tzWzBdLnYpOwogICAgICAgICAgICAgICAgYXhpcy5tYXggPSBNYXRoLm1heChheGlzLm1heCwgdGlja3NbdGlja3MubGVuZ3RoIC0gMV0udik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldEVuZHBvaW50UHJlY2lzaW9uKHZhbHVlLCBheGlzKSB7CiAgICAgICAgICAgIHZhciBjYW52YXMxID0gTWF0aC5mbG9vcihheGlzLnAyYyh2YWx1ZSkpLAogICAgICAgICAgICAgICAgY2FudmFzMiA9IGF4aXMuZGlyZWN0aW9uID09PSAieCIgPyBjYW52YXMxICsgMSA6IGNhbnZhczEgLSAxLAogICAgICAgICAgICAgICAgcG9pbnQxID0gYXhpcy5jMnAoY2FudmFzMSksCiAgICAgICAgICAgICAgICBwb2ludDIgPSBheGlzLmMycChjYW52YXMyKSwKICAgICAgICAgICAgICAgIHByZWNpc2lvbiA9IGNvbXB1dGVWYWx1ZVByZWNpc2lvbihwb2ludDEsIHBvaW50MiwgYXhpcy5kaXJlY3Rpb24sIDEpOwoKICAgICAgICAgICAgcmV0dXJuIHByZWNpc2lvbjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldEVuZHBvaW50VGlja3MoYXhpcywgc2VyaWVzKSB7CiAgICAgICAgICAgIGlmIChpc1ZhbGlkRW5kcG9pbnRUaWNrKGF4aXMsIHNlcmllcykpIHsKICAgICAgICAgICAgICAgIGF4aXMudGlja3MudW5zaGlmdChuZXdUaWNrKGF4aXMubWluLCBudWxsLCBheGlzLCAnbWluJykpOwogICAgICAgICAgICAgICAgYXhpcy50aWNrcy5wdXNoKG5ld1RpY2soYXhpcy5tYXgsIG51bGwsIGF4aXMsICdtYXgnKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbmRwb2ludFRpY2soYXhpcywgc2VyaWVzKSB7CiAgICAgICAgICAgIGlmIChheGlzLm9wdGlvbnMuc2hvd1RpY2tMYWJlbHMgPT09ICdlbmRwb2ludHMnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXhpcy5vcHRpb25zLnNob3dUaWNrTGFiZWxzID09PSAnYWxsJykgewogICAgICAgICAgICAgICAgdmFyIGFzc29jaWF0ZWRTZXJpZXMgPSBzZXJpZXMuZmlsdGVyKGZ1bmN0aW9uKHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHMueGF4aXMgPT09IGF4aXM7CiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgbm90QWxsQmFyU2VyaWVzID0gYXNzb2NpYXRlZFNlcmllcy5zb21lKGZ1bmN0aW9uKHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFzLmJhcnMuc2hvdzsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBhc3NvY2lhdGVkU2VyaWVzLmxlbmd0aCA9PT0gMCB8fCBub3RBbGxCYXJTZXJpZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF4aXMub3B0aW9ucy5zaG93VGlja0xhYmVscyA9PT0gJ21ham9yJyB8fCBheGlzLm9wdGlvbnMuc2hvd1RpY2tMYWJlbHMgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3KCkgewogICAgICAgICAgICBzdXJmYWNlLmNsZWFyKCk7CiAgICAgICAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5kcmF3QmFja2dyb3VuZCwgW2N0eF0pOwoKICAgICAgICAgICAgdmFyIGdyaWQgPSBvcHRpb25zLmdyaWQ7CgogICAgICAgICAgICAvLyBkcmF3IGJhY2tncm91bmQsIGlmIGFueQogICAgICAgICAgICBpZiAoZ3JpZC5zaG93ICYmIGdyaWQuYmFja2dyb3VuZENvbG9yKSB7CiAgICAgICAgICAgICAgICBkcmF3QmFja2dyb3VuZCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ3JpZC5zaG93ICYmICFncmlkLmFib3ZlRGF0YSkgewogICAgICAgICAgICAgICAgZHJhd0dyaWQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5kcmF3U2VyaWVzLCBbY3R4LCBzZXJpZXNbaV0sIGksIGdldENvbG9yT3JHcmFkaWVudF0pOwogICAgICAgICAgICAgICAgZHJhd1NlcmllcyhzZXJpZXNbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MuZHJhdywgW2N0eF0pOwoKICAgICAgICAgICAgaWYgKGdyaWQuc2hvdyAmJiBncmlkLmFib3ZlRGF0YSkgewogICAgICAgICAgICAgICAgZHJhd0dyaWQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3VyZmFjZS5yZW5kZXIoKTsKCiAgICAgICAgICAgIC8vIEEgZHJhdyBpbXBsaWVzIHRoYXQgZWl0aGVyIHRoZSBheGVzIG9yIGRhdGEgaGF2ZSBjaGFuZ2VkLCBzbyB3ZQogICAgICAgICAgICAvLyBzaG91bGQgcHJvYmFibHkgdXBkYXRlIHRoZSBvdmVybGF5IGhpZ2hsaWdodHMgYXMgd2VsbC4KICAgICAgICAgICAgdHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RSYW5nZShyYW5nZXMsIGNvb3JkKSB7CiAgICAgICAgICAgIHZhciBheGlzLCBmcm9tLCB0bywga2V5LCBheGVzID0gYWxsQXhlcygpOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBheGlzID0gYXhlc1tpXTsKICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gY29vcmQpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBjb29yZCArIGF4aXMubiArICJheGlzIjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJhbmdlc1trZXldICYmIGF4aXMubiA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdXBwb3J0IHgxYXhpcyBhcyB4YXhpcwogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBjb29yZCArICJheGlzIjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChyYW5nZXNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gcmFuZ2VzW2tleV0uZnJvbTsKICAgICAgICAgICAgICAgICAgICAgICAgdG8gPSByYW5nZXNba2V5XS50bzsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMtY29tcGF0IHN0dWZmIC0gdG8gYmUgcmVtb3ZlZCBpbiBmdXR1cmUKICAgICAgICAgICAgaWYgKCFyYW5nZXNba2V5XSkgewogICAgICAgICAgICAgICAgYXhpcyA9IGNvb3JkID09PSAieCIgPyB4YXhlc1swXSA6IHlheGVzWzBdOwogICAgICAgICAgICAgICAgZnJvbSA9IHJhbmdlc1tjb29yZCArICIxIl07CiAgICAgICAgICAgICAgICB0byA9IHJhbmdlc1tjb29yZCArICIyIl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGF1dG8tcmV2ZXJzZSBhcyBhbiBhZGRlZCBib251cwogICAgICAgICAgICBpZiAoZnJvbSAhPSBudWxsICYmIHRvICE9IG51bGwgJiYgZnJvbSA+IHRvKSB7CiAgICAgICAgICAgICAgICB2YXIgdG1wID0gZnJvbTsKICAgICAgICAgICAgICAgIGZyb20gPSB0bzsKICAgICAgICAgICAgICAgIHRvID0gdG1wOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZnJvbTogZnJvbSwKICAgICAgICAgICAgICAgIHRvOiB0bywKICAgICAgICAgICAgICAgIGF4aXM6IGF4aXMKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdCYWNrZ3JvdW5kKCkgewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwoKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdldENvbG9yT3JHcmFkaWVudChvcHRpb25zLmdyaWQuYmFja2dyb3VuZENvbG9yLCBwbG90SGVpZ2h0LCAwLCAicmdiYSgyNTUsIDI1NSwgMjU1LCAwKSIpOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgcGxvdFdpZHRoLCBwbG90SGVpZ2h0KTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdNYXJraW5ncygpIHsKICAgICAgICAgICAgLy8gZHJhdyBtYXJraW5ncwogICAgICAgICAgICB2YXIgbWFya2luZ3MgPSBvcHRpb25zLmdyaWQubWFya2luZ3MsCiAgICAgICAgICAgICAgICBheGVzOwoKICAgICAgICAgICAgaWYgKG1hcmtpbmdzKSB7CiAgICAgICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKG1hcmtpbmdzKSkgewogICAgICAgICAgICAgICAgICAgIGF4ZXMgPSBwbG90LmdldEF4ZXMoKTsKICAgICAgICAgICAgICAgICAgICAvLyB4bWluIGV0Yy4gaXMgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHRvIGJlCiAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlZCBpbiB0aGUgZnV0dXJlCiAgICAgICAgICAgICAgICAgICAgYXhlcy54bWluID0gYXhlcy54YXhpcy5taW47CiAgICAgICAgICAgICAgICAgICAgYXhlcy54bWF4ID0gYXhlcy54YXhpcy5tYXg7CiAgICAgICAgICAgICAgICAgICAgYXhlcy55bWluID0gYXhlcy55YXhpcy5taW47CiAgICAgICAgICAgICAgICAgICAgYXhlcy55bWF4ID0gYXhlcy55YXhpcy5tYXg7CgogICAgICAgICAgICAgICAgICAgIG1hcmtpbmdzID0gbWFya2luZ3MoYXhlcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWFya2luZ3MubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IG1hcmtpbmdzW2ldLAogICAgICAgICAgICAgICAgICAgICAgICB4cmFuZ2UgPSBleHRyYWN0UmFuZ2UobSwgIngiKSwKICAgICAgICAgICAgICAgICAgICAgICAgeXJhbmdlID0gZXh0cmFjdFJhbmdlKG0sICJ5Iik7CgogICAgICAgICAgICAgICAgICAgIC8vIGZpbGwgaW4gbWlzc2luZwogICAgICAgICAgICAgICAgICAgIGlmICh4cmFuZ2UuZnJvbSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhyYW5nZS5mcm9tID0geHJhbmdlLmF4aXMubWluOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHhyYW5nZS50byA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhyYW5nZS50byA9IHhyYW5nZS5heGlzLm1heDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh5cmFuZ2UuZnJvbSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHlyYW5nZS5mcm9tID0geXJhbmdlLmF4aXMubWluOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHlyYW5nZS50byA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHlyYW5nZS50byA9IHlyYW5nZS5heGlzLm1heDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsaXAKICAgICAgICAgICAgICAgICAgICBpZiAoeHJhbmdlLnRvIDwgeHJhbmdlLmF4aXMubWluIHx8IHhyYW5nZS5mcm9tID4geHJhbmdlLmF4aXMubWF4IHx8CiAgICAgICAgICAgICAgICAgICAgICAgIHlyYW5nZS50byA8IHlyYW5nZS5heGlzLm1pbiB8fCB5cmFuZ2UuZnJvbSA+IHlyYW5nZS5heGlzLm1heCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHhyYW5nZS5mcm9tID0gTWF0aC5tYXgoeHJhbmdlLmZyb20sIHhyYW5nZS5heGlzLm1pbik7CiAgICAgICAgICAgICAgICAgICAgeHJhbmdlLnRvID0gTWF0aC5taW4oeHJhbmdlLnRvLCB4cmFuZ2UuYXhpcy5tYXgpOwogICAgICAgICAgICAgICAgICAgIHlyYW5nZS5mcm9tID0gTWF0aC5tYXgoeXJhbmdlLmZyb20sIHlyYW5nZS5heGlzLm1pbik7CiAgICAgICAgICAgICAgICAgICAgeXJhbmdlLnRvID0gTWF0aC5taW4oeXJhbmdlLnRvLCB5cmFuZ2UuYXhpcy5tYXgpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgeGVxdWFsID0geHJhbmdlLmZyb20gPT09IHhyYW5nZS50bywKICAgICAgICAgICAgICAgICAgICAgICAgeWVxdWFsID0geXJhbmdlLmZyb20gPT09IHlyYW5nZS50bzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHhlcXVhbCAmJiB5ZXF1YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIGRyYXcKICAgICAgICAgICAgICAgICAgICB4cmFuZ2UuZnJvbSA9IE1hdGguZmxvb3IoeHJhbmdlLmF4aXMucDJjKHhyYW5nZS5mcm9tKSk7CiAgICAgICAgICAgICAgICAgICAgeHJhbmdlLnRvID0gTWF0aC5mbG9vcih4cmFuZ2UuYXhpcy5wMmMoeHJhbmdlLnRvKSk7CiAgICAgICAgICAgICAgICAgICAgeXJhbmdlLmZyb20gPSBNYXRoLmZsb29yKHlyYW5nZS5heGlzLnAyYyh5cmFuZ2UuZnJvbSkpOwogICAgICAgICAgICAgICAgICAgIHlyYW5nZS50byA9IE1hdGguZmxvb3IoeXJhbmdlLmF4aXMucDJjKHlyYW5nZS50bykpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoeGVxdWFsIHx8IHllcXVhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGluZVdpZHRoID0gbS5saW5lV2lkdGggfHwgb3B0aW9ucy5ncmlkLm1hcmtpbmdzTGluZVdpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViUGl4ZWwgPSBsaW5lV2lkdGggJSAyID8gMC41IDogMDsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBtLmNvbG9yIHx8IG9wdGlvbnMuZ3JpZC5tYXJraW5nc0NvbG9yOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gbGluZVdpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeGVxdWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHhyYW5nZS50byArIHN1YlBpeGVsLCB5cmFuZ2UuZnJvbSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKHhyYW5nZS50byArIHN1YlBpeGVsLCB5cmFuZ2UudG8pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4cmFuZ2UuZnJvbSwgeXJhbmdlLnRvICsgc3ViUGl4ZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4cmFuZ2UudG8sIHlyYW5nZS50byArIHN1YlBpeGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IG0uY29sb3IgfHwgb3B0aW9ucy5ncmlkLm1hcmtpbmdzQ29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4cmFuZ2UuZnJvbSwgeXJhbmdlLnRvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeHJhbmdlLnRvIC0geHJhbmdlLmZyb20sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5cmFuZ2UuZnJvbSAtIHlyYW5nZS50byk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaW5kRWRnZXMoYXhpcykgewogICAgICAgICAgICB2YXIgYm94ID0gYXhpcy5ib3gsCiAgICAgICAgICAgICAgICB4ID0gMCwKICAgICAgICAgICAgICAgIHkgPSAwOwoKICAgICAgICAgICAgLy8gZmluZCB0aGUgZWRnZXMKICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09PSAieCIpIHsKICAgICAgICAgICAgICAgIHggPSAwOwogICAgICAgICAgICAgICAgeSA9IGJveC50b3AgLSBwbG90T2Zmc2V0LnRvcCArIChheGlzLnBvc2l0aW9uID09PSAidG9wIiA/IGJveC5oZWlnaHQgOiAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHkgPSAwOwogICAgICAgICAgICAgICAgeCA9IGJveC5sZWZ0IC0gcGxvdE9mZnNldC5sZWZ0ICsgKGF4aXMucG9zaXRpb24gPT09ICJsZWZ0IiA/IGJveC53aWR0aCA6IDApICsgYXhpcy5ib3hQb3NpdGlvbi5jZW50ZXJYOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgeDogeCwKICAgICAgICAgICAgICAgIHk6IHkKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBhbGlnblBvc2l0aW9uKGxpbmVXaWR0aCwgcG9zKSB7CiAgICAgICAgICAgIHJldHVybiAoKGxpbmVXaWR0aCAlIDIpICE9PSAwKSA/IE1hdGguZmxvb3IocG9zKSArIDAuNSA6IHBvczsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBkcmF3VGlja0JhcihheGlzKSB7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAxOwogICAgICAgICAgICB2YXIgZWRnZXMgPSBmaW5kRWRnZXMoYXhpcyksCiAgICAgICAgICAgICAgICB4ID0gZWRnZXMueCwKICAgICAgICAgICAgICAgIHkgPSBlZGdlcy55OwoKICAgICAgICAgICAgLy8gZHJhdyB0aWNrIGJhcgogICAgICAgICAgICBpZiAoYXhpcy5zaG93KSB7CiAgICAgICAgICAgICAgICB2YXIgeG9mZiA9IDAsCiAgICAgICAgICAgICAgICAgICAgeW9mZiA9IDA7CgogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYXhpcy5vcHRpb25zLmNvbG9yOwogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09PSAieCIpIHsKICAgICAgICAgICAgICAgICAgICB4b2ZmID0gcGxvdFdpZHRoICsgMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgeW9mZiA9IHBsb3RIZWlnaHQgKyAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICAgICAgeSA9IGFsaWduUG9zaXRpb24oY3R4LmxpbmVXaWR0aCwgeSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHggPSBhbGlnblBvc2l0aW9uKGN0eC5saW5lV2lkdGgsIHgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggKyB4b2ZmLCB5ICsgeW9mZik7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBkcmF3VGlja01hcmtzKGF4aXMpIHsKICAgICAgICAgICAgdmFyIHQgPSBheGlzLnRpY2tMZW5ndGgsCiAgICAgICAgICAgICAgICBtaW5vclRpY2tzID0gYXhpcy5zaG93TWlub3JUaWNrcywKICAgICAgICAgICAgICAgIG1pbm9yVGlja3NOciA9IE1JTk9SX1RJQ0tTX0NPVU5UX0NPTlNUQU5ULAogICAgICAgICAgICAgICAgZWRnZXMgPSBmaW5kRWRnZXMoYXhpcyksCiAgICAgICAgICAgICAgICB4ID0gZWRnZXMueCwKICAgICAgICAgICAgICAgIHkgPSBlZGdlcy55LAogICAgICAgICAgICAgICAgaSA9IDA7CgogICAgICAgICAgICAvLyBkcmF3IG1ham9yIHRpY2sgbWFya3MKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYXhpcy5vcHRpb25zLmNvbG9yOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXhpcy50aWNrcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIHYgPSBheGlzLnRpY2tzW2ldLnYsCiAgICAgICAgICAgICAgICAgICAgeG9mZiA9IDAsCiAgICAgICAgICAgICAgICAgICAgeW9mZiA9IDAsCiAgICAgICAgICAgICAgICAgICAgeG1pbm9yID0gMCwKICAgICAgICAgICAgICAgICAgICB5bWlub3IgPSAwLAogICAgICAgICAgICAgICAgICAgIGo7CgogICAgICAgICAgICAgICAgaWYgKCFpc05hTih2KSAmJiB2ID49IGF4aXMubWluICYmIHYgPD0gYXhpcy5tYXgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT09ICJ4IikgewogICAgICAgICAgICAgICAgICAgICAgICB4ID0gYXhpcy5wMmModik7CiAgICAgICAgICAgICAgICAgICAgICAgIHlvZmYgPSB0OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT09ICJ0b3AiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b2ZmID0gLXlvZmY7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB5ID0gYXhpcy5wMmModik7CiAgICAgICAgICAgICAgICAgICAgICAgIHhvZmYgPSB0OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT09ICJsZWZ0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeG9mZiA9IC14b2ZmOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT09ICJ4IikgewogICAgICAgICAgICAgICAgICAgICAgICB4ID0gYWxpZ25Qb3NpdGlvbihjdHgubGluZVdpZHRoLCB4KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB5ID0gYWxpZ25Qb3NpdGlvbihjdHgubGluZVdpZHRoLCB5KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgeG9mZiwgeSArIHlvZmYpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vZHJhdyBtaW5vciB0aWNrIG1hcmtzCiAgICAgICAgICAgICAgICBpZiAobWlub3JUaWNrcyA9PT0gdHJ1ZSAmJiBpIDwgYXhpcy50aWNrcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHYxID0gYXhpcy50aWNrc1tpXS52LAogICAgICAgICAgICAgICAgICAgICAgICB2MiA9IGF4aXMudGlja3NbaSArIDFdLnYsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXAgPSAodjIgLSB2MSkgLyAobWlub3JUaWNrc05yICsgMSk7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPD0gbWlub3JUaWNrc05yOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29tcHV0ZSBtaW5vciB0aWNrIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5bWlub3IgPSB0IC8gMjsgLy8gbWlub3IgdGlja3MgYXJlIGhhbGYgbGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gYWxpZ25Qb3NpdGlvbihjdHgubGluZVdpZHRoLCBheGlzLnAyYyh2MSArIGogKiBzdGVwKSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PT0gInRvcCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5bWlub3IgPSAteW1pbm9yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGdvIG92ZXIgdGhlIHBsb3QgYm9yZGVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh4IDwgMCkgfHwgKHggPiBwbG90V2lkdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4bWlub3IgPSB0IC8gMjsgLy8gbWlub3IgdGlja3MgYXJlIGhhbGYgbGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5ID0gYWxpZ25Qb3NpdGlvbihjdHgubGluZVdpZHRoLCBheGlzLnAyYyh2MSArIGogKiBzdGVwKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT09ICJsZWZ0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtaW5vciA9IC14bWlub3I7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgZ28gb3ZlciB0aGUgcGxvdCBib3JkZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHkgPCAwKSB8fCAoeSA+IHBsb3RIZWlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHhtaW5vciwgeSArIHltaW5vcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gZHJhd0dyaWRMaW5lcyhheGlzKSB7CiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoZSBsaW5lIHdpbGwgYmUgb3ZlcmxhcHBlZCB3aXRoIGEgYm9yZGVyCiAgICAgICAgICAgIHZhciBvdmVybGFwcGVkV2l0aEJvcmRlciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGJ3ID0gb3B0aW9ucy5ncmlkLmJvcmRlcldpZHRoOwogICAgICAgICAgICAgICAgcmV0dXJuICgoKHR5cGVvZiBidyA9PT0gIm9iamVjdCIgJiYgYndbYXhpcy5wb3NpdGlvbl0gPiAwKSB8fCBidyA+IDApICYmICh2YWx1ZSA9PT0gYXhpcy5taW4gfHwgdmFsdWUgPT09IGF4aXMubWF4KSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBvcHRpb25zLmdyaWQudGlja0NvbG9yOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIHZhciBpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXhpcy50aWNrcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIHYgPSBheGlzLnRpY2tzW2ldLnYsCiAgICAgICAgICAgICAgICAgICAgeG9mZiA9IDAsCiAgICAgICAgICAgICAgICAgICAgeW9mZiA9IDAsCiAgICAgICAgICAgICAgICAgICAgeCA9IDAsCiAgICAgICAgICAgICAgICAgICAgeSA9IDA7CgogICAgICAgICAgICAgICAgaWYgKGlzTmFOKHYpIHx8IHYgPCBheGlzLm1pbiB8fCB2ID4gYXhpcy5tYXgpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIC8vIHNraXAgdGhvc2UgbHlpbmcgb24gdGhlIGF4ZXMgaWYgd2UgZ290IGEgYm9yZGVyCiAgICAgICAgICAgICAgICBpZiAob3ZlcmxhcHBlZFdpdGhCb3JkZXIodikpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICAgICAgeCA9IGF4aXMucDJjKHYpOwogICAgICAgICAgICAgICAgICAgIHkgPSBwbG90SGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIHlvZmYgPSAtcGxvdEhlaWdodDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgeCA9IDA7CiAgICAgICAgICAgICAgICAgICAgeSA9IGF4aXMucDJjKHYpOwogICAgICAgICAgICAgICAgICAgIHhvZmYgPSBwbG90V2lkdGg7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09PSAieCIpIHsKICAgICAgICAgICAgICAgICAgICB4ID0gYWxpZ25Qb3NpdGlvbihjdHgubGluZVdpZHRoLCB4KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgeSA9IGFsaWduUG9zaXRpb24oY3R4LmxpbmVXaWR0aCwgeSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHhvZmYsIHkgKyB5b2ZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGRyYXdCb3JkZXIoKSB7CiAgICAgICAgICAgIC8vIElmIGVpdGhlciBib3JkZXJXaWR0aCBvciBib3JkZXJDb2xvciBpcyBhbiBvYmplY3QsIHRoZW4gZHJhdyB0aGUgYm9yZGVyCiAgICAgICAgICAgIC8vIGxpbmUgYnkgbGluZSBpbnN0ZWFkIG9mIGFzIG9uZSByZWN0YW5nbGUKICAgICAgICAgICAgdmFyIGJ3ID0gb3B0aW9ucy5ncmlkLmJvcmRlcldpZHRoLAogICAgICAgICAgICAgICAgYmMgPSBvcHRpb25zLmdyaWQuYm9yZGVyQ29sb3I7CgogICAgICAgICAgICBpZiAodHlwZW9mIGJ3ID09PSAib2JqZWN0IiB8fCB0eXBlb2YgYmMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGJ3ICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIGJ3ID0gewogICAgICAgICAgICAgICAgICAgICAgICB0b3A6IGJ3LAogICAgICAgICAgICAgICAgICAgICAgICByaWdodDogYncsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogYncsCiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IGJ3CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYmMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgYmMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogYmMsCiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0OiBiYywKICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tOiBiYywKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogYmMKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChidy50b3AgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYmMudG9wOwogICAgICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBidy50b3A7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCAtIGJ3LmxlZnQsIDAgLSBidy50b3AgLyAyKTsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKHBsb3RXaWR0aCwgMCAtIGJ3LnRvcCAvIDIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYncucmlnaHQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYmMucmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGJ3LnJpZ2h0OwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHBsb3RXaWR0aCArIGJ3LnJpZ2h0IC8gMiwgMCAtIGJ3LnRvcCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhwbG90V2lkdGggKyBidy5yaWdodCAvIDIsIHBsb3RIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYncuYm90dG9tID4gMCkgewogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGJjLmJvdHRvbTsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYncuYm90dG9tOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHBsb3RXaWR0aCArIGJ3LnJpZ2h0LCBwbG90SGVpZ2h0ICsgYncuYm90dG9tIC8gMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbygwLCBwbG90SGVpZ2h0ICsgYncuYm90dG9tIC8gMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChidy5sZWZ0ID4gMCkgewogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGJjLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGJ3LmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCAtIGJ3LmxlZnQgLyAyLCBwbG90SGVpZ2h0ICsgYncuYm90dG9tKTsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKDAgLSBidy5sZWZ0IC8gMiwgMCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGJ3OwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gb3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVJlY3QoLWJ3IC8gMiwgLWJ3IC8gMiwgcGxvdFdpZHRoICsgYncsIHBsb3RIZWlnaHQgKyBidyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBkcmF3R3JpZCgpIHsKICAgICAgICAgICAgdmFyIGF4ZXMsIGJ3OwoKICAgICAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsKCiAgICAgICAgICAgIGRyYXdNYXJraW5ncygpOwoKICAgICAgICAgICAgYXhlcyA9IGFsbEF4ZXMoKTsKICAgICAgICAgICAgYncgPSBvcHRpb25zLmdyaWQuYm9yZGVyV2lkdGg7CgogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGF4ZXMubGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICAgIHZhciBheGlzID0gYXhlc1tqXTsKCiAgICAgICAgICAgICAgICBpZiAoIWF4aXMuc2hvdykgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRyYXdUaWNrQmFyKGF4aXMpOwogICAgICAgICAgICAgICAgaWYgKGF4aXMuc2hvd1RpY2tzID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgZHJhd1RpY2tNYXJrcyhheGlzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXhpcy5ncmlkTGluZXMgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBkcmF3R3JpZExpbmVzKGF4aXMsIGJ3KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZHJhdyBib3JkZXIKICAgICAgICAgICAgaWYgKGJ3KSB7CiAgICAgICAgICAgICAgICBkcmF3Qm9yZGVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3QXhpc0xhYmVscygpIHsKICAgICAgICAgICAgJC5lYWNoKGFsbEF4ZXMoKSwgZnVuY3Rpb24oXywgYXhpcykgewogICAgICAgICAgICAgICAgdmFyIGJveCA9IGF4aXMuYm94LAogICAgICAgICAgICAgICAgICAgIGxlZ2FjeVN0eWxlcyA9IGF4aXMuZGlyZWN0aW9uICsgIkF4aXMgIiArIGF4aXMuZGlyZWN0aW9uICsgYXhpcy5uICsgIkF4aXMiLAogICAgICAgICAgICAgICAgICAgIGxheWVyID0gImZsb3QtIiArIGF4aXMuZGlyZWN0aW9uICsgIi1heGlzIGZsb3QtIiArIGF4aXMuZGlyZWN0aW9uICsgYXhpcy5uICsgIi1heGlzICIgKyBsZWdhY3lTdHlsZXMsCiAgICAgICAgICAgICAgICAgICAgZm9udCA9IGF4aXMub3B0aW9ucy5mb250IHx8ICJmbG90LXRpY2stbGFiZWwgdGlja0xhYmVsIiwKICAgICAgICAgICAgICAgICAgICBpLCB4LCB5LCBoYWxpZ24sIHZhbGlnbiwgaW5mbywKICAgICAgICAgICAgICAgICAgICBtYXJnaW4gPSAzLAogICAgICAgICAgICAgICAgICAgIG51bGxCb3ggPSB7eDogTmFOLCB5OiBOYU4sIHdpZHRoOiBOYU4sIGhlaWdodDogTmFOfSwgbmV3TGFiZWxCb3gsIGxhYmVsQm94ZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICBvdmVybGFwcGluZyA9IGZ1bmN0aW9uKHgxMSwgeTExLCB4MTIsIHkxMiwgeDIxLCB5MjEsIHgyMiwgeTIyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoKHgxMSA8PSB4MjEgJiYgeDIxIDw9IHgxMikgfHwgKHgyMSA8PSB4MTEgJiYgeDExIDw9IHgyMikpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKHkxMSA8PSB5MjEgJiYgeTIxIDw9IHkxMikgfHwgKHkyMSA8PSB5MTEgJiYgeTExIDw9IHkyMikpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcHNPdGhlckxhYmVscyA9IGZ1bmN0aW9uKG5ld0xhYmVsQm94LCBwcmV2aW91c0xhYmVsQm94ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzTGFiZWxCb3hlcy5zb21lKGZ1bmN0aW9uKGxhYmVsQm94KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3ZlcmxhcHBpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TGFiZWxCb3gueCwgbmV3TGFiZWxCb3gueSwgbmV3TGFiZWxCb3gueCArIG5ld0xhYmVsQm94LndpZHRoLCBuZXdMYWJlbEJveC55ICsgbmV3TGFiZWxCb3guaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsQm94LngsIGxhYmVsQm94LnksIGxhYmVsQm94LnggKyBsYWJlbEJveC53aWR0aCwgbGFiZWxCb3gueSArIGxhYmVsQm94LmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZHJhd0F4aXNMYWJlbCA9IGZ1bmN0aW9uICh0aWNrLCBsYWJlbEJveGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGljayB8fCAhdGljay5sYWJlbCB8fCB0aWNrLnYgPCBheGlzLm1pbiB8fCB0aWNrLnYgPiBheGlzLm1heCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGxCb3g7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGluZm8gPSBzdXJmYWNlLmdldFRleHRJbmZvKGxheWVyLCB0aWNrLmxhYmVsLCBmb250KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYWxpZ24gPSAiY2VudGVyIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSBwbG90T2Zmc2V0LmxlZnQgKyBheGlzLnAyYyh0aWNrLnYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT09ICJib3R0b20iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IGJveC50b3AgKyBib3gucGFkZGluZyAtIGF4aXMuYm94UG9zaXRpb24uY2VudGVyWTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IGJveC50b3AgKyBib3guaGVpZ2h0IC0gYm94LnBhZGRpbmcgKyBheGlzLmJveFBvc2l0aW9uLmNlbnRlclk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWduID0gImJvdHRvbSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdMYWJlbEJveCA9IHt4OiB4IC0gaW5mby53aWR0aCAvIDIgLSBtYXJnaW4sIHk6IHkgLSBtYXJnaW4sIHdpZHRoOiBpbmZvLndpZHRoICsgMiAqIG1hcmdpbiwgaGVpZ2h0OiBpbmZvLmhlaWdodCArIDIgKiBtYXJnaW59OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWduID0gIm1pZGRsZSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5ID0gcGxvdE9mZnNldC50b3AgKyBheGlzLnAyYyh0aWNrLnYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT09ICJsZWZ0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSBib3gubGVmdCArIGJveC53aWR0aCAtIGJveC5wYWRkaW5nIC0gYXhpcy5ib3hQb3NpdGlvbi5jZW50ZXJYOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbGlnbiA9ICJyaWdodCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSBib3gubGVmdCArIGJveC5wYWRkaW5nICsgYXhpcy5ib3hQb3NpdGlvbi5jZW50ZXJYOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TGFiZWxCb3ggPSB7eDogeCAtIGluZm8ud2lkdGggLyAyIC0gbWFyZ2luLCB5OiB5IC0gbWFyZ2luLCB3aWR0aDogaW5mby53aWR0aCArIDIgKiBtYXJnaW4sIGhlaWdodDogaW5mby5oZWlnaHQgKyAyICogbWFyZ2lufTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJsYXBzT3RoZXJMYWJlbHMobmV3TGFiZWxCb3gsIGxhYmVsQm94ZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbEJveDsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgc3VyZmFjZS5hZGRUZXh0KGxheWVyLCB4LCB5LCB0aWNrLmxhYmVsLCBmb250LCBudWxsLCBudWxsLCBoYWxpZ24sIHZhbGlnbik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3TGFiZWxCb3g7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgdGV4dCBiZWZvcmUgY2hlY2tpbmcgZm9yIGF4aXMuc2hvdyBhbmQgdGlja3MubGVuZ3RoOwogICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHBsdWdpbnMsIGxpa2UgZmxvdC10aWNrcm90b3IsIHRoYXQgZHJhdyB0aGVpciBvd24KICAgICAgICAgICAgICAgIC8vIHRpY2sgbGFiZWxzIHdpbGwgZW5kIHVwIHdpdGggYm90aCB0aGVpcnMgYW5kIHRoZSBkZWZhdWx0cy4KCiAgICAgICAgICAgICAgICBzdXJmYWNlLnJlbW92ZVRleHQobGF5ZXIpOwoKICAgICAgICAgICAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5kcmF3QXhpcywgW2F4aXMsIHN1cmZhY2VdKTsKCiAgICAgICAgICAgICAgICBpZiAoIWF4aXMuc2hvdykgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzd2l0Y2ggKGF4aXMub3B0aW9ucy5zaG93VGlja0xhYmVscykgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ25vbmUnOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdlbmRwb2ludHMnOgogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbEJveGVzLnB1c2goZHJhd0F4aXNMYWJlbChheGlzLnRpY2tzWzBdLCBsYWJlbEJveGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsQm94ZXMucHVzaChkcmF3QXhpc0xhYmVsKGF4aXMudGlja3NbYXhpcy50aWNrcy5sZW5ndGggLSAxXSwgbGFiZWxCb3hlcykpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdtYWpvcic6CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsQm94ZXMucHVzaChkcmF3QXhpc0xhYmVsKGF4aXMudGlja3NbMF0sIGxhYmVsQm94ZXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxCb3hlcy5wdXNoKGRyYXdBeGlzTGFiZWwoYXhpcy50aWNrc1theGlzLnRpY2tzLmxlbmd0aCAtIDFdLCBsYWJlbEJveGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBheGlzLnRpY2tzLmxlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxCb3hlcy5wdXNoKGRyYXdBeGlzTGFiZWwoYXhpcy50aWNrc1tpXSwgbGFiZWxCb3hlcykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2FsbCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsQm94ZXMucHVzaChkcmF3QXhpc0xhYmVsKGF4aXMudGlja3NbMF0sIFtdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsQm94ZXMucHVzaChkcmF3QXhpc0xhYmVsKGF4aXMudGlja3NbYXhpcy50aWNrcy5sZW5ndGggLSAxXSwgbGFiZWxCb3hlcykpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgYXhpcy50aWNrcy5sZW5ndGggLSAxOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsQm94ZXMucHVzaChkcmF3QXhpc0xhYmVsKGF4aXMudGlja3NbaV0sIGxhYmVsQm94ZXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3U2VyaWVzKHNlcmllcykgewogICAgICAgICAgICBpZiAoc2VyaWVzLmxpbmVzLnNob3cpIHsKICAgICAgICAgICAgICAgICQucGxvdC5kcmF3U2VyaWVzLmRyYXdTZXJpZXNMaW5lcyhzZXJpZXMsIGN0eCwgcGxvdE9mZnNldCwgcGxvdFdpZHRoLCBwbG90SGVpZ2h0LCBwbG90LmRyYXdTeW1ib2wsIGdldENvbG9yT3JHcmFkaWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZXJpZXMuYmFycy5zaG93KSB7CiAgICAgICAgICAgICAgICAkLnBsb3QuZHJhd1Nlcmllcy5kcmF3U2VyaWVzQmFycyhzZXJpZXMsIGN0eCwgcGxvdE9mZnNldCwgcGxvdFdpZHRoLCBwbG90SGVpZ2h0LCBwbG90LmRyYXdTeW1ib2wsIGdldENvbG9yT3JHcmFkaWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZXJpZXMucG9pbnRzLnNob3cpIHsKICAgICAgICAgICAgICAgICQucGxvdC5kcmF3U2VyaWVzLmRyYXdTZXJpZXNQb2ludHMoc2VyaWVzLCBjdHgsIHBsb3RPZmZzZXQsIHBsb3RXaWR0aCwgcGxvdEhlaWdodCwgcGxvdC5kcmF3U3ltYm9sLCBnZXRDb2xvck9yR3JhZGllbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb21wdXRlUmFuZ2VGb3JEYXRhU2VyaWVzKHNlcmllcywgZm9yY2UsIGlzVmFsaWQpIHsKICAgICAgICAgICAgdmFyIHBvaW50cyA9IHNlcmllcy5kYXRhcG9pbnRzLnBvaW50cywKICAgICAgICAgICAgICAgIHBzID0gc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzaXplLAogICAgICAgICAgICAgICAgZm9ybWF0ID0gc2VyaWVzLmRhdGFwb2ludHMuZm9ybWF0LAogICAgICAgICAgICAgICAgdG9wU2VudHJ5ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICAgICAgICAgICAgYm90dG9tU2VudHJ5ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICAgICAgICAgICAgcmFuZ2UgPSB7CiAgICAgICAgICAgICAgICAgICAgeG1pbjogdG9wU2VudHJ5LAogICAgICAgICAgICAgICAgICAgIHltaW46IHRvcFNlbnRyeSwKICAgICAgICAgICAgICAgICAgICB4bWF4OiBib3R0b21TZW50cnksCiAgICAgICAgICAgICAgICAgICAgeW1heDogYm90dG9tU2VudHJ5CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwb2ludHMubGVuZ3RoOyBqICs9IHBzKSB7CiAgICAgICAgICAgICAgICBpZiAocG9pbnRzW2pdID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAoaXNWYWxpZCkgPT09ICdmdW5jdGlvbicgJiYgIWlzVmFsaWQocG9pbnRzW2pdKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvciAodmFyIG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSBwb2ludHNbaiArIG1dLAogICAgICAgICAgICAgICAgICAgICAgICBmID0gZm9ybWF0W21dOwogICAgICAgICAgICAgICAgICAgIGlmIChmID09PSBudWxsIHx8IGYgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgKGlzVmFsaWQpID09PSAnZnVuY3Rpb24nICYmICFpc1ZhbGlkKHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoKCFmb3JjZSAmJiAhZi5jb21wdXRlUmFuZ2UpIHx8IHZhbCA9PT0gSW5maW5pdHkgfHwgdmFsID09PSAtSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZi54ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwgPCByYW5nZS54bWluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS54bWluID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID4gcmFuZ2UueG1heCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UueG1heCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGYueSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsIDwgcmFuZ2UueW1pbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UueW1pbiA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA+IHJhbmdlLnltYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnltYXggPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByYW5nZTsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBhZGp1c3RTZXJpZXNEYXRhUmFuZ2Uoc2VyaWVzLCByYW5nZSkgewogICAgICAgICAgICBpZiAoc2VyaWVzLmJhcnMuc2hvdykgewogICAgICAgICAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGdvdCByb29tIGZvciB0aGUgYmFyIG9uIHRoZSBkYW5jaW5nIGZsb29yCiAgICAgICAgICAgICAgICB2YXIgZGVsdGE7CgogICAgICAgICAgICAgICAgLy8gdXBkYXRlIGJhciB3aWR0aCBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIHZhciB1c2VBYnNvbHV0ZUJhcldpZHRoID0gc2VyaWVzLmJhcnMuYmFyV2lkdGhbMV07CiAgICAgICAgICAgICAgICBpZiAoc2VyaWVzLmRhdGFwb2ludHMgJiYgc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzICYmICF1c2VBYnNvbHV0ZUJhcldpZHRoKSB7CiAgICAgICAgICAgICAgICAgICAgY29tcHV0ZUJhcldpZHRoKHNlcmllcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGJhcldpZHRoID0gc2VyaWVzLmJhcnMuYmFyV2lkdGhbMF0gfHwgc2VyaWVzLmJhcnMuYmFyV2lkdGg7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlcmllcy5iYXJzLmFsaWduKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAicmlnaHQiOgogICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSA9IC1iYXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgPSAtYmFyV2lkdGggLyAyOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzZXJpZXMuYmFycy5ob3Jpem9udGFsKSB7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UueW1pbiArPSBkZWx0YTsKICAgICAgICAgICAgICAgICAgICByYW5nZS55bWF4ICs9IGRlbHRhICsgYmFyV2lkdGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByYW5nZS54bWluICs9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgIHJhbmdlLnhtYXggKz0gZGVsdGEgKyBiYXJXaWR0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKChzZXJpZXMuYmFycy5zaG93ICYmIHNlcmllcy5iYXJzLnplcm8pIHx8IChzZXJpZXMubGluZXMuc2hvdyAmJiBzZXJpZXMubGluZXMuemVybykpIHsKICAgICAgICAgICAgICAgIHZhciBwcyA9IHNlcmllcy5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKCiAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIDAgcG9pbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGNvbXB1dGVkIHkgcmFuZ2Ugd2hlbiByZXF1ZXN0ZWQKICAgICAgICAgICAgICAgIGlmIChwcyA8PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgLyppZiBwcyA+IDAgdGhlIHBvaW50cyB3ZXJlIGFscmVhZHkgdGFrZW4gaW50byBhY2NvdW50IGZvciBhdXRvU2NhbGUgKi8KICAgICAgICAgICAgICAgICAgICByYW5nZS55bWluID0gTWF0aC5taW4oMCwgcmFuZ2UueW1pbik7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UueW1heCA9IE1hdGgubWF4KDAsIHJhbmdlLnltYXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmFuZ2U7CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gY29tcHV0ZUJhcldpZHRoKHNlcmllcykgewogICAgICAgICAgICB2YXIgeFZhbHVlcyA9IFtdOwogICAgICAgICAgICB2YXIgcG9pbnRzaXplID0gc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzaXplLCBtaW5EaXN0YW5jZSA9IE51bWJlci5NQVhfVkFMVUU7CgogICAgICAgICAgICBpZiAoc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzLmxlbmd0aCA8PSBwb2ludHNpemUpIHsKICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlID0gMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gc2VyaWVzLmJhcnMuaG9yaXpvbnRhbCA/IDEgOiAwOwogICAgICAgICAgICBmb3IgKHZhciBqID0gc3RhcnQ7IGogPCBzZXJpZXMuZGF0YXBvaW50cy5wb2ludHMubGVuZ3RoOyBqICs9IHBvaW50c2l6ZSkgewogICAgICAgICAgICAgICAgaWYgKGlzRmluaXRlKHNlcmllcy5kYXRhcG9pbnRzLnBvaW50c1tqXSkgJiYgc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzW2pdICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgeFZhbHVlcy5wdXNoKHNlcmllcy5kYXRhcG9pbnRzLnBvaW50c1tqXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIG9ubHlVbmlxdWUodmFsdWUsIGluZGV4LCBzZWxmKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5pbmRleE9mKHZhbHVlKSA9PT0gaW5kZXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHhWYWx1ZXMgPSB4VmFsdWVzLmZpbHRlciggb25seVVuaXF1ZSApOwogICAgICAgICAgICB4VmFsdWVzLnNvcnQoZnVuY3Rpb24oYSwgYil7cmV0dXJuIGEgLSBifSk7CgogICAgICAgICAgICBmb3IgKHZhciBqID0gMTsgaiA8IHhWYWx1ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciBkaXN0YW5jZSA9IE1hdGguYWJzKHhWYWx1ZXNbal0gLSB4VmFsdWVzW2ogLSAxXSk7CiAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPCBtaW5EaXN0YW5jZSAmJiBpc0Zpbml0ZShkaXN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIHNlcmllcy5iYXJzLmJhcldpZHRoID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgc2VyaWVzLmJhcnMuYmFyV2lkdGggPSBzZXJpZXMuYmFycy5iYXJXaWR0aCAqIG1pbkRpc3RhbmNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VyaWVzLmJhcnMuYmFyV2lkdGhbMF0gPSBzZXJpZXMuYmFycy5iYXJXaWR0aFswXSAqIG1pbkRpc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyByZXR1cm5zIHRoZSBkYXRhIGl0ZW0gdGhlIG1vdXNlIGlzIG92ZXIvIHRoZSBjdXJzb3IgaXMgY2xvc2VzdCB0bywgb3IgbnVsbCBpZiBub25lIGlzIGZvdW5kCiAgICAgICAgZnVuY3Rpb24gZmluZE5lYXJieUl0ZW0obW91c2VYLCBtb3VzZVksIHNlcmllc0ZpbHRlciwgcmFkaXVzLCBjb21wdXRlRGlzdGFuY2UpIHsKICAgICAgICAgICAgdmFyIGksIGosCiAgICAgICAgICAgICAgICBpdGVtID0gbnVsbCwKICAgICAgICAgICAgICAgIHNtYWxsZXN0RGlzdGFuY2UgPSByYWRpdXMgKiByYWRpdXMgKyAxOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHNlcmllcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICAgICAgaWYgKCFzZXJpZXNGaWx0ZXIoaSkpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBzID0gc2VyaWVzW2ldOwogICAgICAgICAgICAgICAgaWYgKCFzLmRhdGFwb2ludHMpIHJldHVybjsKCiAgICAgICAgICAgICAgICBpZiAocy5saW5lcy5zaG93IHx8IHMucG9pbnRzLnNob3cpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm91bmQgPSBmaW5kTmVhcmJ5UG9pbnQocywgbW91c2VYLCBtb3VzZVksIHJhZGl1cywgc21hbGxlc3REaXN0YW5jZSwgY29tcHV0ZURpc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc21hbGxlc3REaXN0YW5jZSA9IGZvdW5kLmRpc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICBpdGVtID0gW2ksIGZvdW5kLmRhdGFJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzLmJhcnMuc2hvdyAmJiAhaXRlbSkgeyAvLyBubyBvdGhlciBwb2ludCBjYW4gYmUgbmVhcmJ5CiAgICAgICAgICAgICAgICAgICAgdmFyIGZvdW5kSW5kZXggPSBmaW5kTmVhcmJ5QmFyKHMsIG1vdXNlWCwgbW91c2VZKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRJbmRleCA+PSAwKSBpdGVtID0gW2ksIGZvdW5kSW5kZXhdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgaSA9IGl0ZW1bMF07CiAgICAgICAgICAgICAgICBqID0gaXRlbVsxXTsKICAgICAgICAgICAgICAgIHZhciBwcyA9IHNlcmllc1tpXS5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGRhdGFwb2ludDogc2VyaWVzW2ldLmRhdGFwb2ludHMucG9pbnRzLnNsaWNlKGogKiBwcywgKGogKyAxKSAqIHBzKSwKICAgICAgICAgICAgICAgICAgICBkYXRhSW5kZXg6IGosCiAgICAgICAgICAgICAgICAgICAgc2VyaWVzOiBzZXJpZXNbaV0sCiAgICAgICAgICAgICAgICAgICAgc2VyaWVzSW5kZXg6IGkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmluZE5lYXJieVBvaW50IChzZXJpZXMsIG1vdXNlWCwgbW91c2VZLCBtYXhEaXN0YW5jZSwgc21hbGxlc3REaXN0YW5jZSwgY29tcHV0ZURpc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBteCA9IHNlcmllcy54YXhpcy5jMnAobW91c2VYKSwKICAgICAgICAgICAgICAgIG15ID0gc2VyaWVzLnlheGlzLmMycChtb3VzZVkpLAogICAgICAgICAgICAgICAgbWF4eCA9IG1heERpc3RhbmNlIC8gc2VyaWVzLnhheGlzLnNjYWxlLAogICAgICAgICAgICAgICAgbWF4eSA9IG1heERpc3RhbmNlIC8gc2VyaWVzLnlheGlzLnNjYWxlLAogICAgICAgICAgICAgICAgcG9pbnRzID0gc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICAgICAgcHMgPSBzZXJpZXMuZGF0YXBvaW50cy5wb2ludHNpemU7CgogICAgICAgICAgICAvLyB3aXRoIGludmVyc2UgdHJhbnNmb3Jtcywgd2UgY2FuJ3QgdXNlIHRoZSBtYXh4L21heHkKICAgICAgICAgICAgLy8gb3B0aW1pemF0aW9uLCBzYWRseQogICAgICAgICAgICBpZiAoc2VyaWVzLnhheGlzLm9wdGlvbnMuaW52ZXJzZVRyYW5zZm9ybSkgewogICAgICAgICAgICAgICAgbWF4eCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZXJpZXMueWF4aXMub3B0aW9ucy5pbnZlcnNlVHJhbnNmb3JtKSB7CiAgICAgICAgICAgICAgICBtYXh5ID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGZvdW5kID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwb2ludHMubGVuZ3RoOyBqICs9IHBzKSB7CiAgICAgICAgICAgICAgICB2YXIgeCA9IHBvaW50c1tqXTsKICAgICAgICAgICAgICAgIHZhciB5ID0gcG9pbnRzW2ogKyAxXTsKICAgICAgICAgICAgICAgIGlmICh4ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoeCAtIG14ID4gbWF4eCB8fCB4IC0gbXggPCAtbWF4eCB8fAogICAgICAgICAgICAgICAgICAgIHkgLSBteSA+IG1heHkgfHwgeSAtIG15IDwgLW1heHkpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBXZSBoYXZlIHRvIGNhbGN1bGF0ZSBkaXN0YW5jZXMgaW4gcGl4ZWxzLCBub3QgaW4KICAgICAgICAgICAgICAgIC8vIGRhdGEgdW5pdHMsIGJlY2F1c2UgdGhlIHNjYWxlcyBvZiB0aGUgYXhlcyBtYXkgYmUgZGlmZmVyZW50CiAgICAgICAgICAgICAgICB2YXIgZHggPSBNYXRoLmFicyhzZXJpZXMueGF4aXMucDJjKHgpIC0gbW91c2VYKTsKICAgICAgICAgICAgICAgIHZhciBkeSA9IE1hdGguYWJzKHNlcmllcy55YXhpcy5wMmMoeSkgLSBtb3VzZVkpOwogICAgICAgICAgICAgICAgdmFyIGRpc3QgPSBjb21wdXRlRGlzdGFuY2UgPyBjb21wdXRlRGlzdGFuY2UoZHgsIGR5KSA6IGR4ICogZHggKyBkeSAqIGR5OwoKICAgICAgICAgICAgICAgIC8vIHVzZSA8PSB0byBlbnN1cmUgbGFzdCBwb2ludCB0YWtlcyBwcmVjZWRlbmNlCiAgICAgICAgICAgICAgICAvLyAobGFzdCBnZW5lcmFsbHkgbWVhbnMgb24gdG9wIG9mKQogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBzbWFsbGVzdERpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgc21hbGxlc3REaXN0YW5jZSA9IGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgZm91bmQgPSB7IGRhdGFJbmRleDogaiAvIHBzLCBkaXN0YW5jZTogZGlzdCB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZm91bmQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaW5kTmVhcmJ5QmFyIChzZXJpZXMsIG1vdXNlWCwgbW91c2VZKSB7CiAgICAgICAgICAgIHZhciBiYXJMZWZ0LCBiYXJSaWdodCwKICAgICAgICAgICAgICAgIGJhcldpZHRoID0gc2VyaWVzLmJhcnMuYmFyV2lkdGhbMF0gfHwgc2VyaWVzLmJhcnMuYmFyV2lkdGgsCiAgICAgICAgICAgICAgICBteCA9IHNlcmllcy54YXhpcy5jMnAobW91c2VYKSwKICAgICAgICAgICAgICAgIG15ID0gc2VyaWVzLnlheGlzLmMycChtb3VzZVkpLAogICAgICAgICAgICAgICAgcG9pbnRzID0gc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICAgICAgcHMgPSBzZXJpZXMuZGF0YXBvaW50cy5wb2ludHNpemU7CgogICAgICAgICAgICBzd2l0Y2ggKHNlcmllcy5iYXJzLmFsaWduKSB7CiAgICAgICAgICAgICAgICBjYXNlICJsZWZ0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLWJhcldpZHRoOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLWJhcldpZHRoIC8gMjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYmFyUmlnaHQgPSBiYXJMZWZ0ICsgYmFyV2lkdGg7CgogICAgICAgICAgICB2YXIgZmlsbFRvd2FyZHMgPSBzZXJpZXMuYmFycy5maWxsVG93YXJkcyB8fCAwOwogICAgICAgICAgICB2YXIgYm90dG9tID0gZmlsbFRvd2FyZHMgPiBzZXJpZXMueWF4aXMubWluID8gTWF0aC5taW4oc2VyaWVzLnlheGlzLm1heCwgZmlsbFRvd2FyZHMpIDogc2VyaWVzLnlheGlzLm1pbjsKCiAgICAgICAgICAgIHZhciBmb3VuZEluZGV4ID0gLTE7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcG9pbnRzLmxlbmd0aDsgaiArPSBwcykgewogICAgICAgICAgICAgICAgdmFyIHggPSBwb2ludHNbal0sIHkgPSBwb2ludHNbaiArIDFdOwogICAgICAgICAgICAgICAgaWYgKHggPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAvLyBmb3IgYSBiYXIgZ3JhcGgsIHRoZSBjdXJzb3IgbXVzdCBiZSBpbnNpZGUgdGhlIGJhcgogICAgICAgICAgICAgICAgaWYgKHNlcmllcy5iYXJzLmhvcml6b250YWwgPwogICAgICAgICAgICAgICAgICAgIChteCA8PSBNYXRoLm1heChib3R0b20sIHgpICYmIG14ID49IE1hdGgubWluKGJvdHRvbSwgeCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbXkgPj0geSArIGJhckxlZnQgJiYgbXkgPD0geSArIGJhclJpZ2h0KSA6CiAgICAgICAgICAgICAgICAgICAgKG14ID49IHggKyBiYXJMZWZ0ICYmIG14IDw9IHggKyBiYXJSaWdodCAmJgogICAgICAgICAgICAgICAgICAgICAgICBteSA+PSBNYXRoLm1pbihib3R0b20sIHkpICYmIG15IDw9IE1hdGgubWF4KGJvdHRvbSwgeSkpKQogICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEluZGV4ID0gaiAvIHBzOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZm91bmRJbmRleDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpbmROZWFyYnlJbnRlcnBvbGF0aW9uUG9pbnQocG9zWCwgcG9zWSwgc2VyaWVzRmlsdGVyKSB7CiAgICAgICAgICAgIHZhciBpLCBqLCBkaXN0LCBkeCwgZHksIHBzLAogICAgICAgICAgICAgICAgaXRlbSwKICAgICAgICAgICAgICAgIHNtYWxsZXN0RGlzdGFuY2UgPSBOdW1iZXIuTUFYX1ZBTFVFOwoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgaWYgKCFzZXJpZXNGaWx0ZXIoaSkpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwb2ludHMgPSBzZXJpZXNbaV0uZGF0YXBvaW50cy5wb2ludHM7CiAgICAgICAgICAgICAgICBwcyA9IHNlcmllc1tpXS5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKCiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgZGF0YSBpcyBjb21pbmcgZnJvbSBwb3NpdGl2ZSAtPiBuZWdhdGl2ZSwgcmV2ZXJzZSB0aGUgY29tcGFyaXNvbgogICAgICAgICAgICAgICAgY29uc3QgY29tcGFyZXIgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIHBzXSA8IHBvaW50c1swXQogICAgICAgICAgICAgICAgICAgID8gZnVuY3Rpb24gKHgxLCB4MikgeyByZXR1cm4geDEgPiB4MiB9CiAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoeDEsIHgyKSB7IHJldHVybiB4MiA+IHgxIH07CgogICAgICAgICAgICAgICAgLy8gZG8gbm90IGludGVycG9sYXRlIG91dHNpZGUgdGhlIGJvdW5kcyBvZiB0aGUgZGF0YS4KICAgICAgICAgICAgICAgIGlmIChjb21wYXJlcihwb3NYLCBwb2ludHNbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmluZCB0aGUgbmVhcmVzdCBwb2ludHMsIHgtd2lzZQogICAgICAgICAgICAgICAgZm9yIChqID0gcHM7IGogPCBwb2ludHMubGVuZ3RoOyBqICs9IHBzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBhcmVyKHBvc1gsIHBvaW50c1tqXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE5vdyBJbnRlcnBvbGF0ZQogICAgICAgICAgICAgICAgdmFyIHksCiAgICAgICAgICAgICAgICAgICAgcDF4ID0gcG9pbnRzW2ogLSBwc10sCiAgICAgICAgICAgICAgICAgICAgcDF5ID0gcG9pbnRzW2ogLSBwcyArIDFdLAogICAgICAgICAgICAgICAgICAgIHAyeCA9IHBvaW50c1tqXSwKICAgICAgICAgICAgICAgICAgICBwMnkgPSBwb2ludHNbaiArIDFdOwoKICAgICAgICAgICAgICAgIGlmICgocDF4ID09PSB1bmRlZmluZWQpIHx8IChwMnggPT09IHVuZGVmaW5lZCkgfHwKICAgICAgICAgICAgICAgICAgICAocDF5ID09PSB1bmRlZmluZWQpIHx8IChwMnkgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAocDF4ID09PSBwMngpIHsKICAgICAgICAgICAgICAgICAgICB5ID0gcDJ5CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHkgPSBwMXkgKyAocDJ5IC0gcDF5KSAqIChwb3NYIC0gcDF4KSAvIChwMnggLSBwMXgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHBvc1kgPSB5OwoKICAgICAgICAgICAgICAgIGR4ID0gTWF0aC5hYnMoc2VyaWVzW2ldLnhheGlzLnAyYyhwMngpIC0gcG9zWCk7CiAgICAgICAgICAgICAgICBkeSA9IE1hdGguYWJzKHNlcmllc1tpXS55YXhpcy5wMmMocDJ5KSAtIHBvc1kpOwogICAgICAgICAgICAgICAgZGlzdCA9IGR4ICogZHggKyBkeSAqIGR5OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgc21hbGxlc3REaXN0YW5jZSkgewogICAgICAgICAgICAgICAgICAgIHNtYWxsZXN0RGlzdGFuY2UgPSBkaXN0OwogICAgICAgICAgICAgICAgICAgIGl0ZW0gPSBbcG9zWCwgcG9zWSwgaSwgal07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICBpID0gaXRlbVsyXTsKICAgICAgICAgICAgICAgIGogPSBpdGVtWzNdOwogICAgICAgICAgICAgICAgcHMgPSBzZXJpZXNbaV0uZGF0YXBvaW50cy5wb2ludHNpemU7CiAgICAgICAgICAgICAgICBwb2ludHMgPSBzZXJpZXNbaV0uZGF0YXBvaW50cy5wb2ludHM7CiAgICAgICAgICAgICAgICBwMXggPSBwb2ludHNbaiAtIHBzXTsKICAgICAgICAgICAgICAgIHAxeSA9IHBvaW50c1tqIC0gcHMgKyAxXTsKICAgICAgICAgICAgICAgIHAyeCA9IHBvaW50c1tqXTsKICAgICAgICAgICAgICAgIHAyeSA9IHBvaW50c1tqICsgMV07CgogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICBkYXRhcG9pbnQ6IFtpdGVtWzBdLCBpdGVtWzFdXSwKICAgICAgICAgICAgICAgICAgICBsZWZ0UG9pbnQ6IFtwMXgsIHAxeV0sCiAgICAgICAgICAgICAgICAgICAgcmlnaHRQb2ludDogW3AyeCwgcDJ5XSwKICAgICAgICAgICAgICAgICAgICBzZXJpZXNJbmRleDogaQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyUmVkcmF3T3ZlcmxheSgpIHsKICAgICAgICAgICAgdmFyIHQgPSBvcHRpb25zLmludGVyYWN0aW9uLnJlZHJhd092ZXJsYXlJbnRlcnZhbDsKICAgICAgICAgICAgaWYgKHQgPT09IC0xKSB7IC8vIHNraXAgZXZlbnQgcXVldWUKICAgICAgICAgICAgICAgIGRyYXdPdmVybGF5KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghcmVkcmF3VGltZW91dCkgewogICAgICAgICAgICAgICAgcmVkcmF3VGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZHJhd092ZXJsYXkocGxvdCk7CiAgICAgICAgICAgICAgICB9LCB0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZHJhd092ZXJsYXkocGxvdCkgewogICAgICAgICAgICByZWRyYXdUaW1lb3V0ID0gbnVsbDsKCiAgICAgICAgICAgIGlmICghb2N0eCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG92ZXJsYXkuY2xlYXIoKTsKICAgICAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLmRyYXdPdmVybGF5LCBbb2N0eCwgb3ZlcmxheV0pOwogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgQ3VzdG9tRXZlbnQoJ29uRHJhd2luZ0RvbmUnKTsKICAgICAgICAgICAgcGxvdC5nZXRFdmVudEhvbGRlcigpLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICBwbG90LmdldFBsYWNlaG9sZGVyKCkudHJpZ2dlcignZHJhd2luZ2RvbmUnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldENvbG9yT3JHcmFkaWVudChzcGVjLCBib3R0b20sIHRvcCwgZGVmYXVsdENvbG9yKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3BlYyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzcGVjOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gYXNzdW1lIHRoaXMgaXMgYSBncmFkaWVudCBzcGVjOyBJRSBjdXJyZW50bHkgb25seQogICAgICAgICAgICAgICAgLy8gc3VwcG9ydHMgYSBzaW1wbGUgdmVydGljYWwgZ3JhZGllbnQgcHJvcGVybHksIHNvIHRoYXQncwogICAgICAgICAgICAgICAgLy8gd2hhdCB3ZSBzdXBwb3J0IHRvbwogICAgICAgICAgICAgICAgdmFyIGdyYWRpZW50ID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIHRvcCwgMCwgYm90dG9tKTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHNwZWMuY29sb3JzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjID0gc3BlYy5jb2xvcnNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY28gPSAkLmNvbG9yLnBhcnNlKGRlZmF1bHRDb2xvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmJyaWdodG5lc3MgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY28gPSBjby5zY2FsZSgncmdiJywgYy5icmlnaHRuZXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMub3BhY2l0eSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjby5hICo9IGMub3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgYyA9IGNvLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcChpIC8gKGwgLSAxKSwgYyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGdyYWRpZW50OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIEFkZCB0aGUgcGxvdCBmdW5jdGlvbiB0byB0aGUgdG9wIGxldmVsIG9mIHRoZSBqUXVlcnkgb2JqZWN0CgogICAgJC5wbG90ID0gZnVuY3Rpb24ocGxhY2Vob2xkZXIsIGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgcGxvdCA9IG5ldyBQbG90KCQocGxhY2Vob2xkZXIpLCBkYXRhLCBvcHRpb25zLCAkLnBsb3QucGx1Z2lucyk7CiAgICAgICAgcmV0dXJuIHBsb3Q7CiAgICB9OwoKICAgICQucGxvdC52ZXJzaW9uID0gIjMuMC4wIjsKCiAgICAkLnBsb3QucGx1Z2lucyA9IFtdOwoKICAgIC8vIEFsc28gYWRkIHRoZSBwbG90IGZ1bmN0aW9uIGFzIGEgY2hhaW5hYmxlIHByb3BlcnR5CiAgICAkLmZuLnBsb3QgPSBmdW5jdGlvbihkYXRhLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJC5wbG90KHRoaXMsIGRhdGEsIG9wdGlvbnMpOwogICAgICAgIH0pOwogICAgfTsKCiAgICAkLnBsb3QubGluZWFyVGlja0dlbmVyYXRvciA9IGRlZmF1bHRUaWNrR2VuZXJhdG9yOwogICAgJC5wbG90LmRlZmF1bHRUaWNrRm9ybWF0dGVyID0gZGVmYXVsdFRpY2tGb3JtYXR0ZXI7CiAgICAkLnBsb3QuZXhwUmVwVGlja0Zvcm1hdHRlciA9IGV4cFJlcFRpY2tGb3JtYXR0ZXI7Cn0pKGpRdWVyeSk7Cg=="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,KGZ1bmN0aW9uICgkKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICB2YXIgc2F0dXJhdGVkID0gewogICAgICAgIHNhdHVyYXRlOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICBpZiAoYSA9PT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0sCiAgICAgICAgZGVsdGE6IGZ1bmN0aW9uKG1pbiwgbWF4LCBub1RpY2tzKSB7CiAgICAgICAgICAgIHJldHVybiAoKG1heCAtIG1pbikgLyBub1RpY2tzKSA9PT0gSW5maW5pdHkgPyAobWF4IC8gbm9UaWNrcyAtIG1pbiAvIG5vVGlja3MpIDogKG1heCAtIG1pbikgLyBub1RpY2tzCiAgICAgICAgfSwKICAgICAgICBtdWx0aXBseTogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIHNhdHVyYXRlZC5zYXR1cmF0ZShhICogYik7CiAgICAgICAgfSwKICAgICAgICAvLyByZXR1cm5zIGMgKiBiSW50ICogYS4gQmVhaHZlcyBwcm9wZXJseSBpbiB0aGUgY2FzZSB3aGVyZSBjIGlzIG5lZ2F0aXZlCiAgICAgICAgLy8gYW5kIGJJbnQgKiBhIGlzIGJpZ2dlciB0aGF0IE51bWJlci5NQVhfVkFMVUUgKEluZmluaXR5KQogICAgICAgIG11bHRpcGx5QWRkOiBmdW5jdGlvbiAoYSwgYkludCwgYykgewogICAgICAgICAgICBpZiAoaXNGaW5pdGUoYSAqIGJJbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2F0dXJhdGVkLnNhdHVyYXRlKGEgKiBiSW50ICsgYyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYzsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJJbnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSBhOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBzYXR1cmF0ZWQuc2F0dXJhdGUocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLy8gcm91bmQgdG8gbmVhcmJ5IGxvd2VyIG11bHRpcGxlIG9mIGJhc2UKICAgICAgICBmbG9vckluQmFzZTogZnVuY3Rpb24obiwgYmFzZSkgewogICAgICAgICAgICByZXR1cm4gYmFzZSAqIE1hdGguZmxvb3IobiAvIGJhc2UpOwogICAgICAgIH0KICAgIH07CgogICAgJC5wbG90LnNhdHVyYXRlZCA9IHNhdHVyYXRlZDsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyoqICMjIGpxdWVyeS5mbG90LmJyb3dzZXIuanMKClRoaXMgcGx1Z2luIGlzIHVzZWQgdG8gbWFrZSBhdmFpbGFibGUgc29tZSBicm93c2VyLXJlbGF0ZWQgdXRpbGl0eSBmdW5jdGlvbnMuCgojIyMgTWV0aG9kcwoqLwoKKGZ1bmN0aW9uICgkKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIGJyb3dzZXIgPSB7CiAgICAgICAgLyoqCiAgICAgICAgLSBnZXRQYWdlWFkoZSkKCiAgICAgICAgIENhbGN1bGF0ZXMgdGhlIHBhZ2VYIGFuZCBwYWdlWSB1c2luZyB0aGUgc2NyZWVuWCwgc2NyZWVuWSBwcm9wZXJ0aWVzIG9mIHRoZSBldmVudAogICAgICAgICBhbmQgdGhlIHNjcm9sbGluZyBvZiB0aGUgcGFnZS4gVGhpcyBpcyBuZWVkZWQgYmVjYXVzZSB0aGUgcGFnZVggYW5kIHBhZ2VZCiAgICAgICAgIHByb3BlcnRpZXMgb2YgdGhlIGV2ZW50IGFyZSBub3QgY29ycmVjdCB3aGlsZSBydW5uaW5nIHRlc3RzIGluIEVkZ2UuICovCiAgICAgICAgZ2V0UGFnZVhZOiBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAvLyBUaGlzIGNvZGUgaXMgaW5zcGlyZWQgZnJvbSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzQ2NDg5MAogICAgICAgICAgICB2YXIgZG9jID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAogICAgICAgICAgICAgICAgcGFnZVggPSBlLmNsaWVudFggKyAod2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0KSAtIChkb2MuY2xpZW50TGVmdCB8fCAwKSwKICAgICAgICAgICAgICAgIHBhZ2VZID0gZS5jbGllbnRZICsgKHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2Muc2Nyb2xsVG9wKSAtIChkb2MuY2xpZW50VG9wIHx8IDApOwogICAgICAgICAgICByZXR1cm4geyBYOiBwYWdlWCwgWTogcGFnZVkgfTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAtIGdldFBpeGVsUmF0aW8oY29udGV4dCkKCiAgICAgICAgIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgY3VycmVudCBwaXhlbCByYXRpbyBkZWZpbmVkIGJ5IHRoZSBwcm9kdWN0IG9mIGRlc2t0b3AKICAgICAgICAgem9vbSBhbmQgcGFnZSB6b29tLgogICAgICAgICBBZGRpdGlvbmFsIGluZm86IGh0dHBzOi8vd3d3Lmh0bWw1cm9ja3MuY29tL2VuL3R1dG9yaWFscy9jYW52YXMvaGlkcGkvCiAgICAgICAgKi8KICAgICAgICBnZXRQaXhlbFJhdGlvOiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBkZXZpY2VQaXhlbFJhdGlvID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8gfHwgMSwKICAgICAgICAgICAgICAgIGJhY2tpbmdTdG9yZVJhdGlvID0KICAgICAgICAgICAgICAgIGNvbnRleHQud2Via2l0QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fAogICAgICAgICAgICAgICAgY29udGV4dC5tb3pCYWNraW5nU3RvcmVQaXhlbFJhdGlvIHx8CiAgICAgICAgICAgICAgICBjb250ZXh0Lm1zQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fAogICAgICAgICAgICAgICAgY29udGV4dC5vQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fAogICAgICAgICAgICAgICAgY29udGV4dC5iYWNraW5nU3RvcmVQaXhlbFJhdGlvIHx8IDE7CiAgICAgICAgICAgIHJldHVybiBkZXZpY2VQaXhlbFJhdGlvIC8gYmFja2luZ1N0b3JlUmF0aW87CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgLSBpc1NhZmFyaSwgaXNNb2JpbGVTYWZhcmksIGlzT3BlcmEsIGlzRmlyZWZveCwgaXNJRSwgaXNFZGdlLCBpc0Nocm9tZSwgaXNCbGluawoKICAgICAgICAgVGhpcyBpcyBhIGNvbGxlY3Rpb24gb2YgZnVuY3Rpb25zLCB1c2VkIHRvIGNoZWNrIGlmIHRoZSBjb2RlIGlzIHJ1bm5pbmcgaW4gYQogICAgICAgICBwYXJ0aWN1bGFyIGJyb3dzZXIgb3IgSmF2YXNjcmlwdCBlbmdpbmUuCiAgICAgICAgKi8KICAgICAgICBpc1NhZmFyaTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vICoqKiBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy85ODQ3NTgwL2hvdy10by1kZXRlY3Qtc2FmYXJpLWNocm9tZS1pZS1maXJlZm94LWFuZC1vcGVyYS1icm93c2VyCiAgICAgICAgICAgIC8vIFNhZmFyaSAzLjArICJbb2JqZWN0IEhUTUxFbGVtZW50Q29uc3RydWN0b3JdIgogICAgICAgICAgICByZXR1cm4gL2NvbnN0cnVjdG9yL2kudGVzdCh3aW5kb3cudG9wLkhUTUxFbGVtZW50KSB8fCAoZnVuY3Rpb24gKHApIHsgcmV0dXJuIHAudG9TdHJpbmcoKSA9PT0gIltvYmplY3QgU2FmYXJpUmVtb3RlTm90aWZpY2F0aW9uXSI7IH0pKCF3aW5kb3cudG9wWydzYWZhcmknXSB8fCAodHlwZW9mIHdpbmRvdy50b3Auc2FmYXJpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cudG9wLnNhZmFyaS5wdXNoTm90aWZpY2F0aW9uKSk7CiAgICAgICAgfSwKCiAgICAgICAgaXNNb2JpbGVTYWZhcmk6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvL2lzTW9iaWxlU2FmYXJpIGFkYXB0ZWQgZnJvbSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMDA3NDgwL2RldGVybWluZS1pZi11c2VyLW5hdmlnYXRlZC1mcm9tLW1vYmlsZS1zYWZhcmkKICAgICAgICAgICAgcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goLyhpUG9kfGlQaG9uZXxpUGFkKS8pICYmIG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0FwcGxlV2ViS2l0Lyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNPcGVyYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vICoqKiBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy85ODQ3NTgwL2hvdy10by1kZXRlY3Qtc2FmYXJpLWNocm9tZS1pZS1maXJlZm94LWFuZC1vcGVyYS1icm93c2VyCiAgICAgICAgICAgIC8vT3BlcmEgOC4wKwogICAgICAgICAgICByZXR1cm4gKCEhd2luZG93Lm9wciAmJiAhIW9wci5hZGRvbnMpIHx8ICEhd2luZG93Lm9wZXJhIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignIE9QUi8nKSA+PSAwOwogICAgICAgIH0sCgogICAgICAgIGlzRmlyZWZveDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vICoqKiBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy85ODQ3NTgwL2hvdy10by1kZXRlY3Qtc2FmYXJpLWNocm9tZS1pZS1maXJlZm94LWFuZC1vcGVyYS1icm93c2VyCiAgICAgICAgICAgIC8vIEZpcmVmb3ggMS4wKwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIEluc3RhbGxUcmlnZ2VyICE9PSAndW5kZWZpbmVkJzsKICAgICAgICB9LAoKICAgICAgICBpc0lFOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gKioqIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzk4NDc1ODAvaG93LXRvLWRldGVjdC1zYWZhcmktY2hyb21lLWllLWZpcmVmb3gtYW5kLW9wZXJhLWJyb3dzZXIKICAgICAgICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgNi0xMQogICAgICAgICAgICByZXR1cm4gLypAY2Nfb24hQCovZmFsc2UgfHwgISFkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgfSwKCiAgICAgICAgaXNFZGdlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gKioqIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzk4NDc1ODAvaG93LXRvLWRldGVjdC1zYWZhcmktY2hyb21lLWllLWZpcmVmb3gtYW5kLW9wZXJhLWJyb3dzZXIKICAgICAgICAgICAgLy8gRWRnZSAyMCsKICAgICAgICAgICAgcmV0dXJuICFicm93c2VyLmlzSUUoKSAmJiAhIXdpbmRvdy5TdHlsZU1lZGlhOwogICAgICAgIH0sCgogICAgICAgIGlzQ2hyb21lOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gKioqIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzk4NDc1ODAvaG93LXRvLWRldGVjdC1zYWZhcmktY2hyb21lLWllLWZpcmVmb3gtYW5kLW9wZXJhLWJyb3dzZXIKICAgICAgICAgICAgLy8gQ2hyb21lIDErCiAgICAgICAgICAgIHJldHVybiAhIXdpbmRvdy5jaHJvbWUgJiYgISF3aW5kb3cuY2hyb21lLndlYnN0b3JlOwogICAgICAgIH0sCgogICAgICAgIGlzQmxpbms6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyAqKiogaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvOTg0NzU4MC9ob3ctdG8tZGV0ZWN0LXNhZmFyaS1jaHJvbWUtaWUtZmlyZWZveC1hbmQtb3BlcmEtYnJvd3NlcgogICAgICAgICAgICByZXR1cm4gKGJyb3dzZXIuaXNDaHJvbWUoKSB8fCBicm93c2VyLmlzT3BlcmEoKSkgJiYgISF3aW5kb3cuQ1NTOwogICAgICAgIH0KICAgIH07CgogICAgJC5wbG90LmJyb3dzZXIgPSBicm93c2VyOwp9KShqUXVlcnkpOwo="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyoqCiMjIGpxdWVyeS5mbG90LmRyYXdTZXJpZXMuanMKClRoaXMgcGx1Z2luIGlzIHVzZWQgYnkgZmxvdCBmb3IgZHJhd2luZyBsaW5lcywgcGxvdHMsIGJhcnMgb3IgYXJlYS4KCiMjIyBQdWJsaWMgbWV0aG9kcwoqLwoKKGZ1bmN0aW9uKCQpIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBmdW5jdGlvbiBEcmF3U2VyaWVzKCkgewogICAgICAgIGZ1bmN0aW9uIHBsb3RMaW5lKGRhdGFwb2ludHMsIHhvZmZzZXQsIHlvZmZzZXQsIGF4aXN4LCBheGlzeSwgY3R4LCBzdGVwcykgewogICAgICAgICAgICB2YXIgcG9pbnRzID0gZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgICAgICBwcyA9IGRhdGFwb2ludHMucG9pbnRzaXplLAogICAgICAgICAgICAgICAgcHJldnggPSBudWxsLAogICAgICAgICAgICAgICAgcHJldnkgPSBudWxsOwogICAgICAgICAgICB2YXIgeDEgPSAwLjAsCiAgICAgICAgICAgICAgICB5MSA9IDAuMCwKICAgICAgICAgICAgICAgIHgyID0gMC4wLAogICAgICAgICAgICAgICAgeTIgPSAwLjAsCiAgICAgICAgICAgICAgICBteCA9IG51bGwsCiAgICAgICAgICAgICAgICBteSA9IG51bGwsCiAgICAgICAgICAgICAgICBpID0gMDsKCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgZm9yIChpID0gcHM7IGkgPCBwb2ludHMubGVuZ3RoOyBpICs9IHBzKSB7CiAgICAgICAgICAgICAgICB4MSA9IHBvaW50c1tpIC0gcHNdOwogICAgICAgICAgICAgICAgeTEgPSBwb2ludHNbaSAtIHBzICsgMV07CiAgICAgICAgICAgICAgICB4MiA9IHBvaW50c1tpXTsKICAgICAgICAgICAgICAgIHkyID0gcG9pbnRzW2kgKyAxXTsKCiAgICAgICAgICAgICAgICBpZiAoeDEgPT09IG51bGwgfHwgeDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBteCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbXkgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc05hTih4MSkgfHwgaXNOYU4oeDIpIHx8IGlzTmFOKHkxKSB8fCBpc05hTih5MikpIHsKICAgICAgICAgICAgICAgICAgICBwcmV2eCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgcHJldnkgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKHN0ZXBzKXsKICAgICAgICAgICAgICAgICAgICBpZiAobXggIT09IG51bGwgJiYgbXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbWlkZGxlIHBvaW50IGV4aXN0cywgdHJhbnNmZXIgcDIgLT4gcDEgYW5kIHAxIC0+IG1wCiAgICAgICAgICAgICAgICAgICAgICAgIHgyID0geDE7CiAgICAgICAgICAgICAgICAgICAgICAgIHkyID0geTE7CiAgICAgICAgICAgICAgICAgICAgICAgIHgxID0gbXg7CiAgICAgICAgICAgICAgICAgICAgICAgIHkxID0gbXk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyAncmVtb3ZlJyBtaWRkbGUgcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgbXggPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBteSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdWJ0cmFjdCBwb2ludHNpemUgZnJvbSBpIHRvIGhhdmUgY3VycmVudCBwb2ludCBwMSBoYW5kbGVkIGFnYWluCiAgICAgICAgICAgICAgICAgICAgICAgIGkgLT0gcHM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5MSAhPT0geTIgJiYgeDEgIT09IHgyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBhIG1pZGRsZSBwb2ludAogICAgICAgICAgICAgICAgICAgICAgICB5MiA9IHkxOwogICAgICAgICAgICAgICAgICAgICAgICBteCA9IHgyOwogICAgICAgICAgICAgICAgICAgICAgICBteSA9IHkxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjbGlwIHdpdGggeW1pbgogICAgICAgICAgICAgICAgaWYgKHkxIDw9IHkyICYmIHkxIDwgYXhpc3kubWluKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkyIDwgYXhpc3kubWluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpbmUgc2VnbWVudCBpcyBvdXRzaWRlCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBjb21wdXRlIG5ldyBpbnRlcnNlY3Rpb24gcG9pbnQKICAgICAgICAgICAgICAgICAgICB4MSA9IChheGlzeS5taW4gLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICB5MSA9IGF4aXN5Lm1pbjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeTIgPD0geTEgJiYgeTIgPCBheGlzeS5taW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeTEgPCBheGlzeS5taW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB4MiA9IChheGlzeS5taW4gLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICB5MiA9IGF4aXN5Lm1pbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjbGlwIHdpdGggeW1heAogICAgICAgICAgICAgICAgaWYgKHkxID49IHkyICYmIHkxID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkyID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgeDEgPSAoYXhpc3kubWF4IC0geTEpIC8gKHkyIC0geTEpICogKHgyIC0geDEpICsgeDE7CiAgICAgICAgICAgICAgICAgICAgeTEgPSBheGlzeS5tYXg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHkyID49IHkxICYmIHkyID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkxID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgeDIgPSAoYXhpc3kubWF4IC0geTEpIC8gKHkyIC0geTEpICogKHgyIC0geDEpICsgeDE7CiAgICAgICAgICAgICAgICAgICAgeTIgPSBheGlzeS5tYXg7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gY2xpcCB3aXRoIHhtaW4KICAgICAgICAgICAgICAgIGlmICh4MSA8PSB4MiAmJiB4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgIGlmICh4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHkxID0gKGF4aXN4Lm1pbiAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgIHgxID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4MiA8PSB4MSAmJiB4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgIGlmICh4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1pbiAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgIHgyID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNsaXAgd2l0aCB4bWF4CiAgICAgICAgICAgICAgICBpZiAoeDEgPj0geDIgJiYgeDEgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB5MSA9IChheGlzeC5tYXggLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgICAgICAgICB4MSA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeDIgPj0geDEgJiYgeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB5MiA9IChheGlzeC5tYXggLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgICAgICAgICB4MiA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoeDEgIT09IHByZXZ4IHx8IHkxICE9PSBwcmV2eSkgewogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oYXhpc3gucDJjKHgxKSArIHhvZmZzZXQsIGF4aXN5LnAyYyh5MSkgKyB5b2Zmc2V0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBwcmV2eCA9IHgyOwogICAgICAgICAgICAgICAgcHJldnkgPSB5MjsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgyKSArIHhvZmZzZXQsIGF4aXN5LnAyYyh5MikgKyB5b2Zmc2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwbG90TGluZUFyZWEoZGF0YXBvaW50cywgYXhpc3gsIGF4aXN5LCBmaWxsVG93YXJkcywgY3R4LCBzdGVwcykgewogICAgICAgICAgICB2YXIgcG9pbnRzID0gZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgICAgICBwcyA9IGRhdGFwb2ludHMucG9pbnRzaXplLAogICAgICAgICAgICAgICAgYm90dG9tID0gZmlsbFRvd2FyZHMgPiBheGlzeS5taW4gPyBNYXRoLm1pbihheGlzeS5tYXgsIGZpbGxUb3dhcmRzKSA6IGF4aXN5Lm1pbiwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgeXBvcyA9IDEsCiAgICAgICAgICAgICAgICBhcmVhT3BlbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgc2VnbWVudFN0YXJ0ID0gMCwKICAgICAgICAgICAgICAgIHNlZ21lbnRFbmQgPSAwLAogICAgICAgICAgICAgICAgbXggPSBudWxsLAogICAgICAgICAgICAgICAgbXkgPSBudWxsOwoKICAgICAgICAgICAgLy8gd2UgcHJvY2VzcyBlYWNoIHNlZ21lbnQgaW4gdHdvIHR1cm5zLCBmaXJzdCBmb3J3YXJkCiAgICAgICAgICAgIC8vIGRpcmVjdGlvbiB0byBza2V0Y2ggb3V0IHRvcCwgdGhlbiBvbmNlIHdlIGhpdCB0aGUKICAgICAgICAgICAgLy8gZW5kIHdlIGdvIGJhY2t3YXJkcyB0byBza2V0Y2ggdGhlIGJvdHRvbQogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHBzID4gMCAmJiBpID4gcG9pbnRzLmxlbmd0aCArIHBzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaSArPSBwczsgLy8gcHMgaXMgbmVnYXRpdmUgaWYgZ29pbmcgYmFja3dhcmRzCgogICAgICAgICAgICAgICAgdmFyIHgxID0gcG9pbnRzW2kgLSBwc10sCiAgICAgICAgICAgICAgICAgICAgeTEgPSBwb2ludHNbaSAtIHBzICsgeXBvc10sCiAgICAgICAgICAgICAgICAgICAgeDIgPSBwb2ludHNbaV0sCiAgICAgICAgICAgICAgICAgICAgeTIgPSBwb2ludHNbaSArIHlwb3NdOwoKICAgICAgICAgICAgICAgIGlmIChwcyA9PT0gLTIpIHsKICAgICAgICAgICAgICAgICAgICAvKiBnb2luZyBiYWNrd2FyZHMgYW5kIG5vIHZhbHVlIGZvciB0aGUgYm90dG9tIHByb3ZpZGVkIGluIHRoZSBzZXJpZXMqLwogICAgICAgICAgICAgICAgICAgIHkxID0geTIgPSBib3R0b207CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGFyZWFPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBzID4gMCAmJiB4MSAhPSBudWxsICYmIHgyID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXQgdHVybmluZyBwb2ludAogICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50RW5kID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgcHMgPSAtcHM7CiAgICAgICAgICAgICAgICAgICAgICAgIHlwb3MgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChwcyA8IDAgJiYgaSA9PT0gc2VnbWVudFN0YXJ0ICsgcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG9uZSB3aXRoIHRoZSByZXZlcnNlIHN3ZWVwCiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZWFPcGVuID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHBzID0gLXBzOwogICAgICAgICAgICAgICAgICAgICAgICB5cG9zID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHNlZ21lbnRTdGFydCA9IHNlZ21lbnRFbmQgKyBwczsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh4MSA9PSBudWxsIHx8IHgyID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBteCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbXkgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKHN0ZXBzKXsKICAgICAgICAgICAgICAgICAgICBpZiAobXggIT09IG51bGwgJiYgbXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbWlkZGxlIHBvaW50IGV4aXN0cywgdHJhbnNmZXIgcDIgLT4gcDEgYW5kIHAxIC0+IG1wCiAgICAgICAgICAgICAgICAgICAgICAgIHgyID0geDE7CiAgICAgICAgICAgICAgICAgICAgICAgIHkyID0geTE7CiAgICAgICAgICAgICAgICAgICAgICAgIHgxID0gbXg7CiAgICAgICAgICAgICAgICAgICAgICAgIHkxID0gbXk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyAncmVtb3ZlJyBtaWRkbGUgcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgbXggPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBteSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdWJ0cmFjdCBwb2ludHNpemUgZnJvbSBpIHRvIGhhdmUgY3VycmVudCBwb2ludCBwMSBoYW5kbGVkIGFnYWluCiAgICAgICAgICAgICAgICAgICAgICAgIGkgLT0gcHM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5MSAhPT0geTIgJiYgeDEgIT09IHgyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBhIG1pZGRsZSBwb2ludAogICAgICAgICAgICAgICAgICAgICAgICB5MiA9IHkxOwogICAgICAgICAgICAgICAgICAgICAgICBteCA9IHgyOwogICAgICAgICAgICAgICAgICAgICAgICBteSA9IHkxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjbGlwIHggdmFsdWVzCgogICAgICAgICAgICAgICAgLy8gY2xpcCB3aXRoIHhtaW4KICAgICAgICAgICAgICAgIGlmICh4MSA8PSB4MiAmJiB4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgIGlmICh4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHkxID0gKGF4aXN4Lm1pbiAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgIHgxID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4MiA8PSB4MSAmJiB4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgIGlmICh4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1pbiAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgIHgyID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNsaXAgd2l0aCB4bWF4CiAgICAgICAgICAgICAgICBpZiAoeDEgPj0geDIgJiYgeDEgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB5MSA9IChheGlzeC5tYXggLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgICAgICAgICB4MSA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeDIgPj0geDEgJiYgeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB5MiA9IChheGlzeC5tYXggLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgICAgICAgICB4MiA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWFyZWFPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gb3BlbiBhcmVhCiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oYXhpc3gucDJjKHgxKSwgYXhpc3kucDJjKGJvdHRvbSkpOwogICAgICAgICAgICAgICAgICAgIGFyZWFPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBub3cgZmlyc3QgY2hlY2sgdGhlIGNhc2Ugd2hlcmUgYm90aCBpcyBvdXRzaWRlCiAgICAgICAgICAgICAgICBpZiAoeTEgPj0gYXhpc3kubWF4ICYmIHkyID49IGF4aXN5Lm1heCkgewogICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgxKSwgYXhpc3kucDJjKGF4aXN5Lm1heCkpOwogICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgyKSwgYXhpc3kucDJjKGF4aXN5Lm1heCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5MSA8PSBheGlzeS5taW4gJiYgeTIgPD0gYXhpc3kubWluKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDEpLCBheGlzeS5wMmMoYXhpc3kubWluKSk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpLCBheGlzeS5wMmMoYXhpc3kubWluKSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gZWxzZSBpdCdzIGEgYml0IG1vcmUgY29tcGxpY2F0ZWQsIHRoZXJlIG1pZ2h0CiAgICAgICAgICAgICAgICAvLyBiZSBhIGZsYXQgbWF4ZWQgb3V0IHJlY3RhbmdsZSBmaXJzdCwgdGhlbiBhCiAgICAgICAgICAgICAgICAvLyB0cmlhbmd1bGFyIGN1dG91dCBvciByZXZlcnNlOyB0byBmaW5kIHRoZXNlCiAgICAgICAgICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHRoZSBjdXJyZW50IHggdmFsdWVzCiAgICAgICAgICAgICAgICB2YXIgeDFvbGQgPSB4MSwKICAgICAgICAgICAgICAgICAgICB4Mm9sZCA9IHgyOwoKICAgICAgICAgICAgICAgIC8vIGNsaXAgdGhlIHkgdmFsdWVzLCB3aXRob3V0IHNob3J0Y3V0dGluZywgd2UKICAgICAgICAgICAgICAgIC8vIGdvIHRocm91Z2ggYWxsIGNhc2VzIGluIHR1cm4KCiAgICAgICAgICAgICAgICAvLyBjbGlwIHdpdGggeW1pbgogICAgICAgICAgICAgICAgaWYgKHkxIDw9IHkyICYmIHkxIDwgYXhpc3kubWluICYmIHkyID49IGF4aXN5Lm1pbikgewogICAgICAgICAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICAgICAgICAgIHkxID0gYXhpc3kubWluOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5MiA8PSB5MSAmJiB5MiA8IGF4aXN5Lm1pbiAmJiB5MSA+PSBheGlzeS5taW4pIHsKICAgICAgICAgICAgICAgICAgICB4MiA9IChheGlzeS5taW4gLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICB5MiA9IGF4aXN5Lm1pbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjbGlwIHdpdGggeW1heAogICAgICAgICAgICAgICAgaWYgKHkxID49IHkyICYmIHkxID4gYXhpc3kubWF4ICYmIHkyIDw9IGF4aXN5Lm1heCkgewogICAgICAgICAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1heCAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICAgICAgICAgIHkxID0gYXhpc3kubWF4OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5MiA+PSB5MSAmJiB5MiA+IGF4aXN5Lm1heCAmJiB5MSA8PSBheGlzeS5tYXgpIHsKICAgICAgICAgICAgICAgICAgICB4MiA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICB5MiA9IGF4aXN5Lm1heDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgeCB2YWx1ZSB3YXMgY2hhbmdlZCB3ZSBnb3QgYSByZWN0YW5nbGUKICAgICAgICAgICAgICAgIC8vIHRvIGZpbGwKICAgICAgICAgICAgICAgIGlmICh4MSAhPT0geDFvbGQpIHsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MW9sZCksIGF4aXN5LnAyYyh5MSkpOwogICAgICAgICAgICAgICAgICAgIC8vIGl0IGdvZXMgdG8gKHgxLCB5MSksIGJ1dCB3ZSBmaWxsIHRoYXQgYmVsb3cKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBmaWxsIHRyaWFuZ3VsYXIgc2VjdGlvbiwgdGhpcyBzb21ldGltZXMgcmVzdWx0CiAgICAgICAgICAgICAgICAvLyBpbiByZWR1bmRhbnQgcG9pbnRzIGlmICh4MSwgeTEpIGhhc24ndCBjaGFuZ2VkCiAgICAgICAgICAgICAgICAvLyBmcm9tIHByZXZpb3VzIGxpbmUgdG8sIGJ1dCB3ZSBqdXN0IGlnbm9yZSB0aGF0CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MSksIGF4aXN5LnAyYyh5MSkpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpLCBheGlzeS5wMmMoeTIpKTsKCiAgICAgICAgICAgICAgICAvLyBmaWxsIHRoZSBvdGhlciByZWN0YW5nbGUgaWYgaXQncyB0aGVyZQogICAgICAgICAgICAgICAgaWYgKHgyICE9PSB4Mm9sZCkgewogICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgyKSwgYXhpc3kucDJjKHkyKSk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDJvbGQpLCBheGlzeS5wMmMoeTIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgLSBkcmF3U2VyaWVzTGluZXMoc2VyaWVzLCBjdHgsIHBsb3RPZmZzZXQsIHBsb3RXaWR0aCwgcGxvdEhlaWdodCwgZHJhd1N5bWJvbCwgZ2V0Q29sb3JPckdyYWRpZW50KQoKICAgICAgICAgVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBkcmF3aW5nIGxpbmVzIG9yIGFyZWEgZmlsbC4gIEluIGNhc2UgdGhlIHNlcmllcyBoYXMgbGluZSBkZWNpbWF0aW9uIGZ1bmN0aW9uCiAgICAgICAgIGF0dGFjaGVkLCBiZWZvcmUgc3RhcnRpbmcgdG8gZHJhdywgYXMgYW4gb3B0aW1pemF0aW9uIHRoZSBwb2ludHMgd2lsbCBmaXJzdCBiZSBkZWNpbWF0ZWQuCgogICAgICAgICBUaGUgc2VyaWVzIHBhcmFtZXRlciBjb250YWlucyB0aGUgc2VyaWVzIHRvIGJlIGRyYXduIG9uIGN0eCBjb250ZXh0LiBUaGUgcGxvdE9mZnNldCwgcGxvdFdpZHRoIGFuZAogICAgICAgICBwbG90SGVpZ2h0IGFyZSB0aGUgY29ycmVzcG9uZGluZyBwYXJhbWV0ZXJzIG9mIGZsb3QgdXNlZCB0byBkZXRlcm1pbmUgdGhlIGRyYXdpbmcgc3VyZmFjZS4KICAgICAgICAgVGhlIGZ1bmN0aW9uIGdldENvbG9yT3JHcmFkaWVudCBpcyB1c2VkIHRvIGNvbXB1dGUgdGhlIGZpbGwgc3R5bGUgb2YgbGluZXMgYW5kIGFyZWEuCiAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBkcmF3U2VyaWVzTGluZXMoc2VyaWVzLCBjdHgsIHBsb3RPZmZzZXQsIHBsb3RXaWR0aCwgcGxvdEhlaWdodCwgZHJhd1N5bWJvbCwgZ2V0Q29sb3JPckdyYWRpZW50KSB7CiAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgIGN0eC50cmFuc2xhdGUocGxvdE9mZnNldC5sZWZ0LCBwbG90T2Zmc2V0LnRvcCk7CiAgICAgICAgICAgIGN0eC5saW5lSm9pbiA9ICJyb3VuZCI7CgogICAgICAgICAgICBpZiAoc2VyaWVzLmxpbmVzLmRhc2hlcyAmJiBjdHguc2V0TGluZURhc2gpIHsKICAgICAgICAgICAgICAgIGN0eC5zZXRMaW5lRGFzaChzZXJpZXMubGluZXMuZGFzaGVzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGFwb2ludHMgPSB7CiAgICAgICAgICAgICAgICBmb3JtYXQ6IHNlcmllcy5kYXRhcG9pbnRzLmZvcm1hdCwKICAgICAgICAgICAgICAgIHBvaW50czogc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICAgICAgcG9pbnRzaXplOiBzZXJpZXMuZGF0YXBvaW50cy5wb2ludHNpemUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChzZXJpZXMuZGVjaW1hdGUpIHsKICAgICAgICAgICAgICAgIGRhdGFwb2ludHMucG9pbnRzID0gc2VyaWVzLmRlY2ltYXRlKHNlcmllcywgc2VyaWVzLnhheGlzLm1pbiwgc2VyaWVzLnhheGlzLm1heCwgcGxvdFdpZHRoLCBzZXJpZXMueWF4aXMubWluLCBzZXJpZXMueWF4aXMubWF4LCBwbG90SGVpZ2h0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGx3ID0gc2VyaWVzLmxpbmVzLmxpbmVXaWR0aDsKCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBsdzsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gc2VyaWVzLmNvbG9yOwogICAgICAgICAgICB2YXIgZmlsbFN0eWxlID0gZ2V0RmlsbFN0eWxlKHNlcmllcy5saW5lcywgc2VyaWVzLmNvbG9yLCAwLCBwbG90SGVpZ2h0LCBnZXRDb2xvck9yR3JhZGllbnQpOwogICAgICAgICAgICBpZiAoZmlsbFN0eWxlKSB7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZmlsbFN0eWxlOwogICAgICAgICAgICAgICAgcGxvdExpbmVBcmVhKGRhdGFwb2ludHMsIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzLCBzZXJpZXMubGluZXMuZmlsbFRvd2FyZHMgfHwgMCwgY3R4LCBzZXJpZXMubGluZXMuc3RlcHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobHcgPiAwKSB7CiAgICAgICAgICAgICAgICBwbG90TGluZShkYXRhcG9pbnRzLCAwLCAwLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgY3R4LCBzZXJpZXMubGluZXMuc3RlcHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgLSBkcmF3U2VyaWVzUG9pbnRzKHNlcmllcywgY3R4LCBwbG90T2Zmc2V0LCBwbG90V2lkdGgsIHBsb3RIZWlnaHQsIGRyYXdTeW1ib2wsIGdldENvbG9yT3JHcmFkaWVudCkKCiAgICAgICAgIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgZHJhd2luZyBwb2ludHMgdXNpbmcgYSBnaXZlbiBzeW1ib2wuIEluIGNhc2UgdGhlIHNlcmllcyBoYXMgcG9pbnRzIGRlY2ltYXRpb24KICAgICAgICAgZnVuY3Rpb24gYXR0YWNoZWQsIGJlZm9yZSBzdGFydGluZyB0byBkcmF3LCBhcyBhbiBvcHRpbWl6YXRpb24gdGhlIHBvaW50cyB3aWxsIGZpcnN0IGJlIGRlY2ltYXRlZC4KCiAgICAgICAgIFRoZSBzZXJpZXMgcGFyYW1ldGVyIGNvbnRhaW5zIHRoZSBzZXJpZXMgdG8gYmUgZHJhd24gb24gY3R4IGNvbnRleHQuIFRoZSBwbG90T2Zmc2V0LCBwbG90V2lkdGggYW5kCiAgICAgICAgIHBsb3RIZWlnaHQgYXJlIHRoZSBjb3JyZXNwb25kaW5nIHBhcmFtZXRlcnMgb2YgZmxvdCB1c2VkIHRvIGRldGVybWluZSB0aGUgZHJhd2luZyBzdXJmYWNlLgogICAgICAgICBUaGUgZnVuY3Rpb24gZHJhd1N5bWJvbCBpcyB1c2VkIHRvIGNvbXB1dGUgYW5kIGRyYXcgdGhlIHN5bWJvbCBjaG9zZW4gZm9yIHRoZSBwb2ludHMuCiAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBkcmF3U2VyaWVzUG9pbnRzKHNlcmllcywgY3R4LCBwbG90T2Zmc2V0LCBwbG90V2lkdGgsIHBsb3RIZWlnaHQsIGRyYXdTeW1ib2wsIGdldENvbG9yT3JHcmFkaWVudCkgewogICAgICAgICAgICBmdW5jdGlvbiBkcmF3Q2lyY2xlKGN0eCwgeCwgeSwgcmFkaXVzLCBzaGFkb3csIGZpbGwpIHsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCArIHJhZGl1cywgeSk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgc2hhZG93ID8gTWF0aC5QSSA6IE1hdGguUEkgKiAyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZHJhd0NpcmNsZS5maWxsID0gdHJ1ZTsKICAgICAgICAgICAgZnVuY3Rpb24gcGxvdFBvaW50cyhkYXRhcG9pbnRzLCByYWRpdXMsIGZpbGwsIG9mZnNldCwgc2hhZG93LCBheGlzeCwgYXhpc3ksIGRyYXdTeW1ib2xGbikgewogICAgICAgICAgICAgICAgdmFyIHBvaW50cyA9IGRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICAgICAgICAgIHBzID0gZGF0YXBvaW50cy5wb2ludHNpemU7CgogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb2ludHMubGVuZ3RoOyBpICs9IHBzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHggPSBwb2ludHNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBwb2ludHNbaSArIDFdOwogICAgICAgICAgICAgICAgICAgIGlmICh4ID09IG51bGwgfHwgeCA8IGF4aXN4Lm1pbiB8fCB4ID4gYXhpc3gubWF4IHx8IHkgPCBheGlzeS5taW4gfHwgeSA+IGF4aXN5Lm1heCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHggPSBheGlzeC5wMmMoeCk7CiAgICAgICAgICAgICAgICAgICAgeSA9IGF4aXN5LnAyYyh5KSArIG9mZnNldDsKCiAgICAgICAgICAgICAgICAgICAgZHJhd1N5bWJvbEZuKGN0eCwgeCwgeSwgcmFkaXVzLCBzaGFkb3csIGZpbGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRyYXdTeW1ib2xGbi5maWxsICYmICFzaGFkb3cpIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwoKICAgICAgICAgICAgdmFyIGRhdGFwb2ludHMgPSB7CiAgICAgICAgICAgICAgICBmb3JtYXQ6IHNlcmllcy5kYXRhcG9pbnRzLmZvcm1hdCwKICAgICAgICAgICAgICAgIHBvaW50czogc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICAgICAgcG9pbnRzaXplOiBzZXJpZXMuZGF0YXBvaW50cy5wb2ludHNpemUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChzZXJpZXMuZGVjaW1hdGVQb2ludHMpIHsKICAgICAgICAgICAgICAgIGRhdGFwb2ludHMucG9pbnRzID0gc2VyaWVzLmRlY2ltYXRlUG9pbnRzKHNlcmllcywgc2VyaWVzLnhheGlzLm1pbiwgc2VyaWVzLnhheGlzLm1heCwgcGxvdFdpZHRoLCBzZXJpZXMueWF4aXMubWluLCBzZXJpZXMueWF4aXMubWF4LCBwbG90SGVpZ2h0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGx3ID0gc2VyaWVzLnBvaW50cy5saW5lV2lkdGgsCiAgICAgICAgICAgICAgICByYWRpdXMgPSBzZXJpZXMucG9pbnRzLnJhZGl1cywKICAgICAgICAgICAgICAgIHN5bWJvbCA9IHNlcmllcy5wb2ludHMuc3ltYm9sLAogICAgICAgICAgICAgICAgZHJhd1N5bWJvbEZuOwoKICAgICAgICAgICAgaWYgKHN5bWJvbCA9PT0gJ2NpcmNsZScpIHsKICAgICAgICAgICAgICAgIGRyYXdTeW1ib2xGbiA9IGRyYXdDaXJjbGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN5bWJvbCA9PT0gJ3N0cmluZycgJiYgZHJhd1N5bWJvbCAmJiBkcmF3U3ltYm9sW3N5bWJvbF0pIHsKICAgICAgICAgICAgICAgIGRyYXdTeW1ib2xGbiA9IGRyYXdTeW1ib2xbc3ltYm9sXTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZHJhd1N5bWJvbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgZHJhd1N5bWJvbEZuID0gZHJhd1N5bWJvbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgdGhlIHVzZXIgc2V0cyB0aGUgbGluZSB3aWR0aCB0byAwLCB3ZSBjaGFuZ2UgaXQgdG8gYSB2ZXJ5CiAgICAgICAgICAgIC8vIHNtYWxsIHZhbHVlLiBBIGxpbmUgd2lkdGggb2YgMCBzZWVtcyB0byBmb3JjZSB0aGUgZGVmYXVsdCBvZiAxLgoKICAgICAgICAgICAgaWYgKGx3ID09PSAwKSB7CiAgICAgICAgICAgICAgICBsdyA9IDAuMDAwMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGx3OwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ2V0RmlsbFN0eWxlKHNlcmllcy5wb2ludHMsIHNlcmllcy5jb2xvciwgbnVsbCwgbnVsbCwgZ2V0Q29sb3JPckdyYWRpZW50KTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gc2VyaWVzLmNvbG9yOwogICAgICAgICAgICBwbG90UG9pbnRzKGRhdGFwb2ludHMsIHJhZGl1cywKICAgICAgICAgICAgICAgIHRydWUsIDAsIGZhbHNlLAogICAgICAgICAgICAgICAgc2VyaWVzLnhheGlzLCBzZXJpZXMueWF4aXMsIGRyYXdTeW1ib2xGbik7CiAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3QmFyKHgsIHksIGIsIGJhckxlZnQsIGJhclJpZ2h0LCBmaWxsU3R5bGVDYWxsYmFjaywgYXhpc3gsIGF4aXN5LCBjLCBob3Jpem9udGFsLCBsaW5lV2lkdGgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSB4ICsgYmFyTGVmdCwKICAgICAgICAgICAgICAgIHJpZ2h0ID0geCArIGJhclJpZ2h0LAogICAgICAgICAgICAgICAgYm90dG9tID0gYiwgdG9wID0geSwKICAgICAgICAgICAgICAgIGRyYXdMZWZ0LCBkcmF3UmlnaHQsIGRyYXdUb3AsIGRyYXdCb3R0b20gPSBmYWxzZSwKICAgICAgICAgICAgICAgIHRtcDsKCiAgICAgICAgICAgIGRyYXdMZWZ0ID0gZHJhd1JpZ2h0ID0gZHJhd1RvcCA9IHRydWU7CgogICAgICAgICAgICAvLyBpbiBob3Jpem9udGFsIG1vZGUsIHdlIHN0YXJ0IHRoZSBiYXIgZnJvbSB0aGUgbGVmdAogICAgICAgICAgICAvLyBpbnN0ZWFkIG9mIGZyb20gdGhlIGJvdHRvbSBzbyBpdCBhcHBlYXJzIHRvIGJlCiAgICAgICAgICAgIC8vIGhvcml6b250YWwgcmF0aGVyIHRoYW4gdmVydGljYWwKICAgICAgICAgICAgaWYgKGhvcml6b250YWwpIHsKICAgICAgICAgICAgICAgIGRyYXdCb3R0b20gPSBkcmF3UmlnaHQgPSBkcmF3VG9wID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRyYXdMZWZ0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYjsKICAgICAgICAgICAgICAgIHJpZ2h0ID0geDsKICAgICAgICAgICAgICAgIHRvcCA9IHkgKyBiYXJMZWZ0OwogICAgICAgICAgICAgICAgYm90dG9tID0geSArIGJhclJpZ2h0OwoKICAgICAgICAgICAgICAgIC8vIGFjY291bnQgZm9yIG5lZ2F0aXZlIGJhcnMKICAgICAgICAgICAgICAgIGlmIChyaWdodCA8IGxlZnQpIHsKICAgICAgICAgICAgICAgICAgICB0bXAgPSByaWdodDsKICAgICAgICAgICAgICAgICAgICByaWdodCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IHRtcDsKICAgICAgICAgICAgICAgICAgICBkcmF3TGVmdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZHJhd1JpZ2h0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBkcmF3TGVmdCA9IGRyYXdSaWdodCA9IGRyYXdUb3AgPSB0cnVlOwogICAgICAgICAgICAgICAgZHJhd0JvdHRvbSA9IGZhbHNlOwogICAgICAgICAgICAgICAgbGVmdCA9IHggKyBiYXJMZWZ0OwogICAgICAgICAgICAgICAgcmlnaHQgPSB4ICsgYmFyUmlnaHQ7CiAgICAgICAgICAgICAgICBib3R0b20gPSBiOwogICAgICAgICAgICAgICAgdG9wID0geTsKCiAgICAgICAgICAgICAgICAvLyBhY2NvdW50IGZvciBuZWdhdGl2ZSBiYXJzCiAgICAgICAgICAgICAgICBpZiAodG9wIDwgYm90dG9tKSB7CiAgICAgICAgICAgICAgICAgICAgdG1wID0gdG9wOwogICAgICAgICAgICAgICAgICAgIHRvcCA9IGJvdHRvbTsKICAgICAgICAgICAgICAgICAgICBib3R0b20gPSB0bXA7CiAgICAgICAgICAgICAgICAgICAgZHJhd0JvdHRvbSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZHJhd1RvcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjbGlwCiAgICAgICAgICAgIGlmIChyaWdodCA8IGF4aXN4Lm1pbiB8fCBsZWZ0ID4gYXhpc3gubWF4IHx8CiAgICAgICAgICAgICAgICB0b3AgPCBheGlzeS5taW4gfHwgYm90dG9tID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChsZWZ0IDwgYXhpc3gubWluKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgZHJhd0xlZnQgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJpZ2h0ID4gYXhpc3gubWF4KSB7CiAgICAgICAgICAgICAgICByaWdodCA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgIGRyYXdSaWdodCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYm90dG9tIDwgYXhpc3kubWluKSB7CiAgICAgICAgICAgICAgICBib3R0b20gPSBheGlzeS5taW47CiAgICAgICAgICAgICAgICBkcmF3Qm90dG9tID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0b3AgPiBheGlzeS5tYXgpIHsKICAgICAgICAgICAgICAgIHRvcCA9IGF4aXN5Lm1heDsKICAgICAgICAgICAgICAgIGRyYXdUb3AgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGVmdCA9IGF4aXN4LnAyYyhsZWZ0KTsKICAgICAgICAgICAgYm90dG9tID0gYXhpc3kucDJjKGJvdHRvbSk7CiAgICAgICAgICAgIHJpZ2h0ID0gYXhpc3gucDJjKHJpZ2h0KTsKICAgICAgICAgICAgdG9wID0gYXhpc3kucDJjKHRvcCk7CgogICAgICAgICAgICAvLyBmaWxsIHRoZSBiYXIKICAgICAgICAgICAgaWYgKGZpbGxTdHlsZUNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBjLmZpbGxTdHlsZSA9IGZpbGxTdHlsZUNhbGxiYWNrKGJvdHRvbSwgdG9wKTsKICAgICAgICAgICAgICAgIGMuZmlsbFJlY3QobGVmdCwgdG9wLCByaWdodCAtIGxlZnQsIGJvdHRvbSAtIHRvcCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZHJhdyBvdXRsaW5lCiAgICAgICAgICAgIGlmIChsaW5lV2lkdGggPiAwICYmIChkcmF3TGVmdCB8fCBkcmF3UmlnaHQgfHwgZHJhd1RvcCB8fCBkcmF3Qm90dG9tKSkgewogICAgICAgICAgICAgICAgYy5iZWdpblBhdGgoKTsKCiAgICAgICAgICAgICAgICAvLyBGSVhNRTogaW5saW5lIG1vdmVUbyBpcyBidWdneSB3aXRoIGV4Y2FudmFzCiAgICAgICAgICAgICAgICBjLm1vdmVUbyhsZWZ0LCBib3R0b20pOwogICAgICAgICAgICAgICAgaWYgKGRyYXdMZWZ0KSB7CiAgICAgICAgICAgICAgICAgICAgYy5saW5lVG8obGVmdCwgdG9wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYy5tb3ZlVG8obGVmdCwgdG9wKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZHJhd1RvcCkgewogICAgICAgICAgICAgICAgICAgIGMubGluZVRvKHJpZ2h0LCB0b3ApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjLm1vdmVUbyhyaWdodCwgdG9wKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZHJhd1JpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgYy5saW5lVG8ocmlnaHQsIGJvdHRvbSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGMubW92ZVRvKHJpZ2h0LCBib3R0b20pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkcmF3Qm90dG9tKSB7CiAgICAgICAgICAgICAgICAgICAgYy5saW5lVG8obGVmdCwgYm90dG9tKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYy5tb3ZlVG8obGVmdCwgYm90dG9tKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjLnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAtIGRyYXdTZXJpZXNCYXJzKHNlcmllcywgY3R4LCBwbG90T2Zmc2V0LCBwbG90V2lkdGgsIHBsb3RIZWlnaHQsIGRyYXdTeW1ib2wsIGdldENvbG9yT3JHcmFkaWVudCkKCiAgICAgICAgIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgZHJhd2luZyBzZXJpZXMgcmVwcmVzZW50ZWQgYXMgYmFycy4gSW4gY2FzZSB0aGUgc2VyaWVzIGhhcyBkZWNpbWF0aW9uCiAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaGVkLCBiZWZvcmUgc3RhcnRpbmcgdG8gZHJhdywgYXMgYW4gb3B0aW1pemF0aW9uIHRoZSBwb2ludHMgd2lsbCBmaXJzdCBiZSBkZWNpbWF0ZWQuCgogICAgICAgICBUaGUgc2VyaWVzIHBhcmFtZXRlciBjb250YWlucyB0aGUgc2VyaWVzIHRvIGJlIGRyYXduIG9uIGN0eCBjb250ZXh0LiBUaGUgcGxvdE9mZnNldCwgcGxvdFdpZHRoIGFuZAogICAgICAgICBwbG90SGVpZ2h0IGFyZSB0aGUgY29ycmVzcG9uZGluZyBwYXJhbWV0ZXJzIG9mIGZsb3QgdXNlZCB0byBkZXRlcm1pbmUgdGhlIGRyYXdpbmcgc3VyZmFjZS4KICAgICAgICAgVGhlIGZ1bmN0aW9uIGdldENvbG9yT3JHcmFkaWVudCBpcyB1c2VkIHRvIGNvbXB1dGUgdGhlIGZpbGwgc3R5bGUgb2YgYmFycy4KICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGRyYXdTZXJpZXNCYXJzKHNlcmllcywgY3R4LCBwbG90T2Zmc2V0LCBwbG90V2lkdGgsIHBsb3RIZWlnaHQsIGRyYXdTeW1ib2wsIGdldENvbG9yT3JHcmFkaWVudCkgewogICAgICAgICAgICBmdW5jdGlvbiBwbG90QmFycyhkYXRhcG9pbnRzLCBiYXJMZWZ0LCBiYXJSaWdodCwgZmlsbFN0eWxlQ2FsbGJhY2ssIGF4aXN4LCBheGlzeSkgewogICAgICAgICAgICAgICAgdmFyIHBvaW50cyA9IGRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICAgICAgICAgIHBzID0gZGF0YXBvaW50cy5wb2ludHNpemUsCiAgICAgICAgICAgICAgICAgICAgZmlsbFRvd2FyZHMgPSBzZXJpZXMuYmFycy5maWxsVG93YXJkcyB8fCAwLAogICAgICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWRCb3R0b20gPSBmaWxsVG93YXJkcyA+IGF4aXN5Lm1pbiA/IE1hdGgubWluKGF4aXN5Lm1heCwgZmlsbFRvd2FyZHMpIDogYXhpc3kubWluOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSArPSBwcykgewogICAgICAgICAgICAgICAgICAgIGlmIChwb2ludHNbaV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFVzZSB0aGlyZCBwb2ludCBhcyBib3R0b20gaWYgcG9pbnRzaXplIGlzIDMKICAgICAgICAgICAgICAgICAgICB2YXIgYm90dG9tID0gcHMgPT09IDMgPyBwb2ludHNbaSArIDJdIDogY2FsY3VsYXRlZEJvdHRvbTsKICAgICAgICAgICAgICAgICAgICBkcmF3QmFyKHBvaW50c1tpXSwgcG9pbnRzW2kgKyAxXSwgYm90dG9tLCBiYXJMZWZ0LCBiYXJSaWdodCwgZmlsbFN0eWxlQ2FsbGJhY2ssIGF4aXN4LCBheGlzeSwgY3R4LCBzZXJpZXMuYmFycy5ob3Jpem9udGFsLCBzZXJpZXMuYmFycy5saW5lV2lkdGgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwoKICAgICAgICAgICAgdmFyIGRhdGFwb2ludHMgPSB7CiAgICAgICAgICAgICAgICBmb3JtYXQ6IHNlcmllcy5kYXRhcG9pbnRzLmZvcm1hdCwKICAgICAgICAgICAgICAgIHBvaW50czogc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICAgICAgcG9pbnRzaXplOiBzZXJpZXMuZGF0YXBvaW50cy5wb2ludHNpemUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChzZXJpZXMuZGVjaW1hdGUpIHsKICAgICAgICAgICAgICAgIGRhdGFwb2ludHMucG9pbnRzID0gc2VyaWVzLmRlY2ltYXRlKHNlcmllcywgc2VyaWVzLnhheGlzLm1pbiwgc2VyaWVzLnhheGlzLm1heCwgcGxvdFdpZHRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IHNlcmllcy5iYXJzLmxpbmVXaWR0aDsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gc2VyaWVzLmNvbG9yOwoKICAgICAgICAgICAgdmFyIGJhckxlZnQ7CiAgICAgICAgICAgIHZhciBiYXJXaWR0aCA9IHNlcmllcy5iYXJzLmJhcldpZHRoWzBdIHx8IHNlcmllcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgICBzd2l0Y2ggKHNlcmllcy5iYXJzLmFsaWduKSB7CiAgICAgICAgICAgICAgICBjYXNlICJsZWZ0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLWJhcldpZHRoOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLWJhcldpZHRoIC8gMjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGZpbGxTdHlsZUNhbGxiYWNrID0gc2VyaWVzLmJhcnMuZmlsbCA/IGZ1bmN0aW9uKGJvdHRvbSwgdG9wKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RmlsbFN0eWxlKHNlcmllcy5iYXJzLCBzZXJpZXMuY29sb3IsIGJvdHRvbSwgdG9wLCBnZXRDb2xvck9yR3JhZGllbnQpOwogICAgICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgICAgIHBsb3RCYXJzKGRhdGFwb2ludHMsIGJhckxlZnQsIGJhckxlZnQgKyBiYXJXaWR0aCwgZmlsbFN0eWxlQ2FsbGJhY2ssIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldEZpbGxTdHlsZShmaWxsb3B0aW9ucywgc2VyaWVzQ29sb3IsIGJvdHRvbSwgdG9wLCBnZXRDb2xvck9yR3JhZGllbnQpIHsKICAgICAgICAgICAgdmFyIGZpbGwgPSBmaWxsb3B0aW9ucy5maWxsOwogICAgICAgICAgICBpZiAoIWZpbGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZmlsbG9wdGlvbnMuZmlsbENvbG9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29sb3JPckdyYWRpZW50KGZpbGxvcHRpb25zLmZpbGxDb2xvciwgYm90dG9tLCB0b3AsIHNlcmllc0NvbG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGMgPSAkLmNvbG9yLnBhcnNlKHNlcmllc0NvbG9yKTsKICAgICAgICAgICAgYy5hID0gdHlwZW9mIGZpbGwgPT09ICJudW1iZXIiID8gZmlsbCA6IDAuNDsKICAgICAgICAgICAgYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcmV0dXJuIGMudG9TdHJpbmcoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZHJhd1Nlcmllc0xpbmVzID0gZHJhd1Nlcmllc0xpbmVzOwogICAgICAgIHRoaXMuZHJhd1Nlcmllc1BvaW50cyA9IGRyYXdTZXJpZXNQb2ludHM7CiAgICAgICAgdGhpcy5kcmF3U2VyaWVzQmFycyA9IGRyYXdTZXJpZXNCYXJzOwogICAgICAgIHRoaXMuZHJhd0JhciA9IGRyYXdCYXI7CiAgICB9OwoKICAgICQucGxvdC5kcmF3U2VyaWVzID0gbmV3IERyYXdTZXJpZXMoKTsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,KGZ1bmN0aW9uICgkKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICAkLnBsb3QudWlDb25zdGFudHMgPSB7CiAgICAgICAgU05BUFBJTkdfQ09OU1RBTlQ6IDIwLAogICAgICAgIFBBTkhJTlRfTEVOR1RIX0NPTlNUQU5UOiAxMCwKICAgICAgICBNSU5PUl9USUNLU19DT1VOVF9DT05TVEFOVDogNCwKICAgICAgICBUSUNLX0xFTkdUSF9DT05TVEFOVDogMTAsCiAgICAgICAgWk9PTV9ESVNUQU5DRV9NQVJHSU46IDI1CiAgICB9Owp9KShqUXVlcnkpOwo="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogZXNsaW50LWRpc2FibGUgKi8KLyogRmxvdCBwbHVnaW4gZm9yIGF1dG9tYXRpY2FsbHkgcmVkcmF3aW5nIHBsb3RzIGFzIHRoZSBwbGFjZWhvbGRlciByZXNpemVzLgoKQ29weXJpZ2h0IChjKSAyMDA3LTIwMTQgSU9MQSBhbmQgT2xlIExhdXJzZW4uCkxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCkl0IHdvcmtzIGJ5IGxpc3RlbmluZyBmb3IgY2hhbmdlcyBvbiB0aGUgcGxhY2Vob2xkZXIgZGl2ICh0aHJvdWdoIHRoZSBqUXVlcnkKcmVzaXplIGV2ZW50IHBsdWdpbikgLSBpZiB0aGUgc2l6ZSBjaGFuZ2VzLCBpdCB3aWxsIHJlZHJhdyB0aGUgcGxvdC4KClRoZXJlIGFyZSBubyBvcHRpb25zLiBJZiB5b3UgbmVlZCB0byBkaXNhYmxlIHRoZSBwbHVnaW4gZm9yIHNvbWUgcGxvdHMsIHlvdQpjYW4ganVzdCBmaXggdGhlIHNpemUgb2YgdGhlaXIgcGxhY2Vob2xkZXJzLgoKKi8KCi8qIElubGluZSBkZXBlbmRlbmN5OgogKiBqUXVlcnkgcmVzaXplIGV2ZW50IC0gdjEuMSAtIDMvMTQvMjAxMAogKiBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1yZXNpemUtcGx1Z2luLwogKgogKiBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgogKiBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCiAqLwooZnVuY3Rpb24oJCxlLHQpeyIkOm5vbXVuZ2UiO3ZhciBpPVtdLG49JC5yZXNpemU9JC5leHRlbmQoJC5yZXNpemUse30pLGEscj1mYWxzZSxzPSJzZXRUaW1lb3V0Iix1PSJyZXNpemUiLG09dSsiLXNwZWNpYWwtZXZlbnQiLG89InBlbmRpbmdEZWxheSIsbD0iYWN0aXZlRGVsYXkiLGY9InRocm90dGxlV2luZG93IjtuW29dPTIwMDtuW2xdPTIwO25bZl09dHJ1ZTskLmV2ZW50LnNwZWNpYWxbdV09e3NldHVwOmZ1bmN0aW9uKCl7aWYoIW5bZl0mJnRoaXNbc10pe3JldHVybiBmYWxzZX12YXIgZT0kKHRoaXMpO2kucHVzaCh0aGlzKTtlLmRhdGEobSx7dzplLndpZHRoKCksaDplLmhlaWdodCgpfSk7aWYoaS5sZW5ndGg9PT0xKXthPXQ7aCgpfX0sdGVhcmRvd246ZnVuY3Rpb24oKXtpZighbltmXSYmdGhpc1tzXSl7cmV0dXJuIGZhbHNlfXZhciBlPSQodGhpcyk7Zm9yKHZhciB0PWkubGVuZ3RoLTE7dD49MDt0LS0pe2lmKGlbdF09PXRoaXMpe2kuc3BsaWNlKHQsMSk7YnJlYWt9fWUucmVtb3ZlRGF0YShtKTtpZighaS5sZW5ndGgpe2lmKHIpe2NhbmNlbEFuaW1hdGlvbkZyYW1lKGEpfWVsc2V7Y2xlYXJUaW1lb3V0KGEpfWE9bnVsbH19LGFkZDpmdW5jdGlvbihlKXtpZighbltmXSYmdGhpc1tzXSl7cmV0dXJuIGZhbHNlfXZhciBpO2Z1bmN0aW9uIGEoZSxuLGEpe3ZhciByPSQodGhpcykscz1yLmRhdGEobSl8fHt9O3Mudz1uIT09dD9uOnIud2lkdGgoKTtzLmg9YSE9PXQ/YTpyLmhlaWdodCgpO2kuYXBwbHkodGhpcyxhcmd1bWVudHMpfWlmKCQuaXNGdW5jdGlvbihlKSl7aT1lO3JldHVybiBhfWVsc2V7aT1lLmhhbmRsZXI7ZS5oYW5kbGVyPWF9fX07ZnVuY3Rpb24gaCh0KXtpZihyPT09dHJ1ZSl7cj10fHwxfWZvcih2YXIgcz1pLmxlbmd0aC0xO3M+PTA7cy0tKXt2YXIgbD0kKGlbc10pO2lmKGxbMF09PWV8fGwuaXMoIjp2aXNpYmxlIikpe3ZhciBmPWwud2lkdGgoKSxjPWwuaGVpZ2h0KCksZD1sLmRhdGEobSk7aWYoZCYmKGYhPT1kLnd8fGMhPT1kLmgpKXtsLnRyaWdnZXIodSxbZC53PWYsZC5oPWNdKTtyPXR8fHRydWV9fWVsc2V7ZD1sLmRhdGEobSk7ZC53PTA7ZC5oPTB9fWlmKGEhPT1udWxsKXtpZihyJiYodD09bnVsbHx8dC1yPDFlMykpe2E9ZS5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoaCl9ZWxzZXthPXNldFRpbWVvdXQoaCxuW29dKTtyPWZhbHNlfX19aWYoIWUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKXtlLnJlcXVlc3RBbmltYXRpb25GcmFtZT1mdW5jdGlvbigpe3JldHVybiBlLndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZXx8ZS5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWV8fGUub1JlcXVlc3RBbmltYXRpb25GcmFtZXx8ZS5tc1JlcXVlc3RBbmltYXRpb25GcmFtZXx8ZnVuY3Rpb24odCxpKXtyZXR1cm4gZS5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7dCgobmV3IERhdGUpLmdldFRpbWUoKSl9LG5bbF0pfX0oKX1pZighZS5jYW5jZWxBbmltYXRpb25GcmFtZSl7ZS5jYW5jZWxBbmltYXRpb25GcmFtZT1mdW5jdGlvbigpe3JldHVybiBlLndlYmtpdENhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZXx8ZS5tb3pDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWV8fGUub0NhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZXx8ZS5tc0NhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZXx8Y2xlYXJUaW1lb3V0fSgpfX0pKGpRdWVyeSx0aGlzKTsKCi8qIGVzbGludC1lbmFibGUgKi8KKGZ1bmN0aW9uICgkKSB7CiAgICB2YXIgb3B0aW9ucyA9IHsgfTsgLy8gbm8gb3B0aW9ucwoKICAgIGZ1bmN0aW9uIGluaXQocGxvdCkgewogICAgICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgICAgICB2YXIgcGxhY2Vob2xkZXIgPSBwbG90LmdldFBsYWNlaG9sZGVyKCk7CgogICAgICAgICAgICAvLyBzb21lYm9keSBtaWdodCBoYXZlIGhpZGRlbiB1cyBhbmQgd2UgY2FuJ3QgcGxvdAogICAgICAgICAgICAvLyB3aGVuIHdlIGRvbid0IGhhdmUgdGhlIGRpbWVuc2lvbnMKICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLndpZHRoKCkgPT09IDAgfHwgcGxhY2Vob2xkZXIuaGVpZ2h0KCkgPT09IDApIHJldHVybjsKCiAgICAgICAgICAgIHBsb3QucmVzaXplKCk7CiAgICAgICAgICAgIHBsb3Quc2V0dXBHcmlkKCk7CiAgICAgICAgICAgIHBsb3QuZHJhdygpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmluZEV2ZW50cyhwbG90LCBldmVudEhvbGRlcikgewogICAgICAgICAgICBwbG90LmdldFBsYWNlaG9sZGVyKCkucmVzaXplKG9uUmVzaXplKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNodXRkb3duKHBsb3QsIGV2ZW50SG9sZGVyKSB7CiAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS51bmJpbmQoInJlc2l6ZSIsIG9uUmVzaXplKTsKICAgICAgICB9CgogICAgICAgIHBsb3QuaG9va3MuYmluZEV2ZW50cy5wdXNoKGJpbmRFdmVudHMpOwogICAgICAgIHBsb3QuaG9va3Muc2h1dGRvd24ucHVzaChzaHV0ZG93bik7CiAgICB9CgogICAgJC5wbG90LnBsdWdpbnMucHVzaCh7CiAgICAgICAgaW5pdDogaW5pdCwKICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgIG5hbWU6ICdyZXNpemUnLAogICAgICAgIHZlcnNpb246ICcxLjAnCiAgICB9KTsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogRmxvdCBwbHVnaW4gZm9yIGRyYXdpbmcgbGVnZW5kcy4KCiovCgooZnVuY3Rpb24oJCkgewogICAgdmFyIGRlZmF1bHRPcHRpb25zID0gewogICAgICAgIGxlZ2VuZDogewogICAgICAgICAgICBzaG93OiBmYWxzZSwKICAgICAgICAgICAgbm9Db2x1bW5zOiAxLAogICAgICAgICAgICBsYWJlbEZvcm1hdHRlcjogbnVsbCwgLy8gZm46IHN0cmluZyAtPiBzdHJpbmcKICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLCAvLyBjb250YWluZXIgKGFzIGpRdWVyeSBvYmplY3QpIHRvIHB1dCBsZWdlbmQgaW4sIG51bGwgbWVhbnMgZGVmYXVsdCBvbiB0b3Agb2YgZ3JhcGgKICAgICAgICAgICAgcG9zaXRpb246ICduZScsIC8vIHBvc2l0aW9uIG9mIGRlZmF1bHQgbGVnZW5kIGNvbnRhaW5lciB3aXRoaW4gcGxvdAogICAgICAgICAgICBtYXJnaW46IDUsIC8vIGRpc3RhbmNlIGZyb20gZ3JpZCBlZGdlIHRvIGRlZmF1bHQgbGVnZW5kIGNvbnRhaW5lciB3aXRoaW4gcGxvdAogICAgICAgICAgICBzb3J0ZWQ6IG51bGwgLy8gZGVmYXVsdCB0byBubyBsZWdlbmQgc29ydGluZwogICAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gaW5zZXJ0TGVnZW5kKHBsb3QsIG9wdGlvbnMsIHBsYWNlaG9sZGVyLCBsZWdlbmRFbnRyaWVzKSB7CiAgICAgICAgLy8gY2xlYXIgYmVmb3JlIHJlZHJhdwogICAgICAgIGlmIChvcHRpb25zLmxlZ2VuZC5jb250YWluZXIgIT0gbnVsbCkgewogICAgICAgICAgICAkKG9wdGlvbnMubGVnZW5kLmNvbnRhaW5lcikuaHRtbCgnJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGxhY2Vob2xkZXIuZmluZCgnLmxlZ2VuZCcpLnJlbW92ZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFvcHRpb25zLmxlZ2VuZC5zaG93KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIFNhdmUgdGhlIGxlZ2VuZCBlbnRyaWVzIGluIGxlZ2VuZCBvcHRpb25zCiAgICAgICAgdmFyIGVudHJpZXMgPSBvcHRpb25zLmxlZ2VuZC5sZWdlbmRFbnRyaWVzID0gbGVnZW5kRW50cmllcywKICAgICAgICAgICAgcGxvdE9mZnNldCA9IG9wdGlvbnMubGVnZW5kLnBsb3RPZmZzZXQgPSBwbG90LmdldFBsb3RPZmZzZXQoKSwKICAgICAgICAgICAgaHRtbCA9IFtdLAogICAgICAgICAgICBlbnRyeSwgbGFiZWxIdG1sLCBpY29uSHRtbCwKICAgICAgICAgICAgaiA9IDAsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIHBvcyA9ICIiLAogICAgICAgICAgICBwID0gb3B0aW9ucy5sZWdlbmQucG9zaXRpb24sCiAgICAgICAgICAgIG0gPSBvcHRpb25zLmxlZ2VuZC5tYXJnaW4sCiAgICAgICAgICAgIHNoYXBlID0gewogICAgICAgICAgICAgICAgbmFtZTogJycsCiAgICAgICAgICAgICAgICBsYWJlbDogJycsCiAgICAgICAgICAgICAgICB4UG9zOiAnJywKICAgICAgICAgICAgICAgIHlQb3M6ICcnCiAgICAgICAgICAgIH07CgogICAgICAgIGh0bWxbaisrXSA9ICc8c3ZnIGNsYXNzPSJsZWdlbmRMYXllciIgc3R5bGU9IndpZHRoOmluaGVyaXQ7aGVpZ2h0OmluaGVyaXQ7Ij4nOwogICAgICAgIGh0bWxbaisrXSA9ICc8cmVjdCBjbGFzcz0iYmFja2dyb3VuZCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIvPic7CiAgICAgICAgaHRtbFtqKytdID0gc3ZnU2hhcGVEZWZzOwoKICAgICAgICB2YXIgbGVmdCA9IDA7CiAgICAgICAgdmFyIGNvbHVtbldpZHRocyA9IFtdOwogICAgICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGVudHJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIGNvbHVtbkluZGV4ID0gaSAlIG9wdGlvbnMubGVnZW5kLm5vQ29sdW1uczsKICAgICAgICAgICAgZW50cnkgPSBlbnRyaWVzW2ldOwogICAgICAgICAgICBzaGFwZS5sYWJlbCA9IGVudHJ5LmxhYmVsOwogICAgICAgICAgICB2YXIgaW5mbyA9IHBsb3QuZ2V0U3VyZmFjZSgpLmdldFRleHRJbmZvKCcnLCBzaGFwZS5sYWJlbCwgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlLmZvbnRTdHlsZSwKICAgICAgICAgICAgICAgIHZhcmlhbnQ6IHN0eWxlLmZvbnRWYXJpYW50LAogICAgICAgICAgICAgICAgd2VpZ2h0OiBzdHlsZS5mb250V2VpZ2h0LAogICAgICAgICAgICAgICAgc2l6ZTogcGFyc2VJbnQoc3R5bGUuZm9udFNpemUpLAogICAgICAgICAgICAgICAgbGluZUhlaWdodDogcGFyc2VJbnQoc3R5bGUubGluZUhlaWdodCksCiAgICAgICAgICAgICAgICBmYW1pbHk6IHN0eWxlLmZvbnRGYW1pbHkKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBsYWJlbFdpZHRoID0gaW5mby53aWR0aDsKICAgICAgICAgICAgLy8gMzZweCA9IDEuNWVtICsgNnB4IG1hcmdpbgogICAgICAgICAgICB2YXIgaWNvbldpZHRoID0gNDg7CiAgICAgICAgICAgIGlmIChjb2x1bW5XaWR0aHNbY29sdW1uSW5kZXhdKSB7CiAgICAgICAgICAgICAgICBpZiAobGFiZWxXaWR0aCA+IGNvbHVtbldpZHRoc1tjb2x1bW5JbmRleF0pIHsKICAgICAgICAgICAgICAgICAgICBjb2x1bW5XaWR0aHNbY29sdW1uSW5kZXhdID0gbGFiZWxXaWR0aCArIGljb25XaWR0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbHVtbldpZHRoc1tjb2x1bW5JbmRleF0gPSBsYWJlbFdpZHRoICsgaWNvbldpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBHZW5lcmF0ZSBodG1sIGZvciBpY29ucyBhbmQgbGFiZWxzIGZyb20gYSBsaXN0IG9mIGVudHJpZXMKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZW50cmllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICB2YXIgY29sdW1uSW5kZXggPSBpICUgb3B0aW9ucy5sZWdlbmQubm9Db2x1bW5zOwogICAgICAgICAgICBlbnRyeSA9IGVudHJpZXNbaV07CiAgICAgICAgICAgIGljb25IdG1sID0gJyc7CiAgICAgICAgICAgIHNoYXBlLmxhYmVsID0gZW50cnkubGFiZWw7CiAgICAgICAgICAgIHNoYXBlLnhQb3MgPSAobGVmdCArIDMpICsgJ3B4JzsKICAgICAgICAgICAgbGVmdCArPSBjb2x1bW5XaWR0aHNbY29sdW1uSW5kZXhdOwogICAgICAgICAgICBpZiAoKGkgKyAxKSAlIG9wdGlvbnMubGVnZW5kLm5vQ29sdW1ucyA9PT0gMCkgewogICAgICAgICAgICAgICAgbGVmdCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2hhcGUueVBvcyA9IE1hdGguZmxvb3IoaSAvIG9wdGlvbnMubGVnZW5kLm5vQ29sdW1ucykgKiAxLjUgKyAnZW0nOwogICAgICAgICAgICAvLyBhcmVhCiAgICAgICAgICAgIGlmIChlbnRyeS5vcHRpb25zLmxpbmVzLnNob3cgJiYgZW50cnkub3B0aW9ucy5saW5lcy5maWxsKSB7CiAgICAgICAgICAgICAgICBzaGFwZS5uYW1lID0gJ2FyZWEnOwogICAgICAgICAgICAgICAgc2hhcGUuZmlsbENvbG9yID0gZW50cnkuY29sb3I7CiAgICAgICAgICAgICAgICBpY29uSHRtbCArPSBnZXRFbnRyeUljb25IdG1sKHNoYXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBiYXJzCiAgICAgICAgICAgIGlmIChlbnRyeS5vcHRpb25zLmJhcnMuc2hvdykgewogICAgICAgICAgICAgICAgc2hhcGUubmFtZSA9ICdiYXInOwogICAgICAgICAgICAgICAgc2hhcGUuZmlsbENvbG9yID0gZW50cnkuY29sb3I7CiAgICAgICAgICAgICAgICBpY29uSHRtbCArPSBnZXRFbnRyeUljb25IdG1sKHNoYXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBsaW5lcwogICAgICAgICAgICBpZiAoZW50cnkub3B0aW9ucy5saW5lcy5zaG93ICYmICFlbnRyeS5vcHRpb25zLmxpbmVzLmZpbGwpIHsKICAgICAgICAgICAgICAgIHNoYXBlLm5hbWUgPSAnbGluZSc7CiAgICAgICAgICAgICAgICBzaGFwZS5zdHJva2VDb2xvciA9IGVudHJ5LmNvbG9yOwogICAgICAgICAgICAgICAgc2hhcGUuc3Ryb2tlV2lkdGggPSBlbnRyeS5vcHRpb25zLmxpbmVzLmxpbmVXaWR0aDsKICAgICAgICAgICAgICAgIGljb25IdG1sICs9IGdldEVudHJ5SWNvbkh0bWwoc2hhcGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHBvaW50cwogICAgICAgICAgICBpZiAoZW50cnkub3B0aW9ucy5wb2ludHMuc2hvdykgewogICAgICAgICAgICAgICAgc2hhcGUubmFtZSA9IGVudHJ5Lm9wdGlvbnMucG9pbnRzLnN5bWJvbDsKICAgICAgICAgICAgICAgIHNoYXBlLnN0cm9rZUNvbG9yID0gZW50cnkuY29sb3I7CiAgICAgICAgICAgICAgICBzaGFwZS5maWxsQ29sb3IgPSBlbnRyeS5vcHRpb25zLnBvaW50cy5maWxsQ29sb3I7CiAgICAgICAgICAgICAgICBzaGFwZS5zdHJva2VXaWR0aCA9IGVudHJ5Lm9wdGlvbnMucG9pbnRzLmxpbmVXaWR0aDsKICAgICAgICAgICAgICAgIGljb25IdG1sICs9IGdldEVudHJ5SWNvbkh0bWwoc2hhcGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsYWJlbEh0bWwgPSAnPHRleHQgeD0iJyArIHNoYXBlLnhQb3MgKyAnIiB5PSInICsgc2hhcGUueVBvcyArICciIHRleHQtYW5jaG9yPSJzdGFydCI+PHRzcGFuIGR4PSIyZW0iIGR5PSIxLjJlbSI+JyArIHNoYXBlLmxhYmVsICsgJzwvdHNwYW4+PC90ZXh0PicKICAgICAgICAgICAgaHRtbFtqKytdID0gJzxnPicgKyBpY29uSHRtbCArIGxhYmVsSHRtbCArICc8L2c+JzsKICAgICAgICB9CgogICAgICAgIGh0bWxbaisrXSA9ICc8L3N2Zz4nOwogICAgICAgIGlmIChtWzBdID09IG51bGwpIHsKICAgICAgICAgICAgbSA9IFttLCBtXTsKICAgICAgICB9CgogICAgICAgIGlmIChwLmNoYXJBdCgwKSA9PT0gJ24nKSB7CiAgICAgICAgICAgIHBvcyArPSAndG9wOicgKyAobVsxXSArIHBsb3RPZmZzZXQudG9wKSArICdweDsnOwogICAgICAgIH0gZWxzZSBpZiAocC5jaGFyQXQoMCkgPT09ICdzJykgewogICAgICAgICAgICBwb3MgKz0gJ2JvdHRvbTonICsgKG1bMV0gKyBwbG90T2Zmc2V0LmJvdHRvbSkgKyAncHg7JzsKICAgICAgICB9CgogICAgICAgIGlmIChwLmNoYXJBdCgxKSA9PT0gJ2UnKSB7CiAgICAgICAgICAgIHBvcyArPSAncmlnaHQ6JyArIChtWzBdICsgcGxvdE9mZnNldC5yaWdodCkgKyAncHg7JzsKICAgICAgICB9IGVsc2UgaWYgKHAuY2hhckF0KDEpID09PSAndycpIHsKICAgICAgICAgICAgcG9zICs9ICdsZWZ0OicgKyAobVswXSArIHBsb3RPZmZzZXQubGVmdCkgKyAncHg7JzsKICAgICAgICB9CgogICAgICAgIHZhciB3aWR0aCA9IDY7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbHVtbldpZHRocy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICB3aWR0aCArPSBjb2x1bW5XaWR0aHNbaV07CiAgICAgICAgfQoKICAgICAgICB2YXIgbGVnZW5kRWwsCiAgICAgICAgICAgIGhlaWdodCA9IE1hdGguY2VpbChlbnRyaWVzLmxlbmd0aCAvIG9wdGlvbnMubGVnZW5kLm5vQ29sdW1ucykgKiAxLjY7CiAgICAgICAgaWYgKCFvcHRpb25zLmxlZ2VuZC5jb250YWluZXIpIHsKICAgICAgICAgICAgbGVnZW5kRWwgPSAkKCc8ZGl2IGNsYXNzPSJsZWdlbmQiIHN0eWxlPSJwb3NpdGlvbjphYnNvbHV0ZTsnICsgcG9zICsgJyI+JyArIGh0bWwuam9pbignJykgKyAnPC9kaXY+JykuYXBwZW5kVG8ocGxhY2Vob2xkZXIpOwogICAgICAgICAgICBsZWdlbmRFbC5jc3MoJ3dpZHRoJywgd2lkdGggKyAncHgnKTsKICAgICAgICAgICAgbGVnZW5kRWwuY3NzKCdoZWlnaHQnLCBoZWlnaHQgKyAnZW0nKTsKICAgICAgICAgICAgbGVnZW5kRWwuY3NzKCdwb2ludGVyRXZlbnRzJywgJ25vbmUnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZWdlbmRFbCA9ICQoaHRtbC5qb2luKCcnKSkuYXBwZW5kVG8ob3B0aW9ucy5sZWdlbmQuY29udGFpbmVyKVswXTsKICAgICAgICAgICAgb3B0aW9ucy5sZWdlbmQuY29udGFpbmVyLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICAgICAgICBvcHRpb25zLmxlZ2VuZC5jb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ2VtJzsKICAgICAgICB9CiAgICB9CgogICAgLy8gR2VuZXJhdGUgaHRtbCBmb3IgYSBzaGFwZQogICAgZnVuY3Rpb24gZ2V0RW50cnlJY29uSHRtbChzaGFwZSkgewogICAgICAgIHZhciBodG1sID0gJycsCiAgICAgICAgICAgIG5hbWUgPSBzaGFwZS5uYW1lLAogICAgICAgICAgICB4ID0gc2hhcGUueFBvcywKICAgICAgICAgICAgeSA9IHNoYXBlLnlQb3MsCiAgICAgICAgICAgIGZpbGwgPSBzaGFwZS5maWxsQ29sb3IsCiAgICAgICAgICAgIHN0cm9rZSA9IHNoYXBlLnN0cm9rZUNvbG9yLAogICAgICAgICAgICB3aWR0aCA9IHNoYXBlLnN0cm9rZVdpZHRoOwogICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICBjYXNlICdjaXJjbGUnOgogICAgICAgICAgICAgICAgaHRtbCA9ICc8dXNlIHhsaW5rOmhyZWY9IiNjaXJjbGUiIGNsYXNzPSJsZWdlbmRJY29uIiAnICsKICAgICAgICAgICAgICAgICAgICAneD0iJyArIHggKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAneT0iJyArIHkgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnZmlsbD0iJyArIGZpbGwgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnc3Ryb2tlPSInICsgc3Ryb2tlICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3N0cm9rZS13aWR0aD0iJyArIHdpZHRoICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoPSIxLjVlbSIgaGVpZ2h0PSIxLjVlbSInICsKICAgICAgICAgICAgICAgICAgICAnLz4nOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2RpYW1vbmQnOgogICAgICAgICAgICAgICAgaHRtbCA9ICc8dXNlIHhsaW5rOmhyZWY9IiNkaWFtb25kIiBjbGFzcz0ibGVnZW5kSWNvbiIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3g9IicgKyB4ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3k9IicgKyB5ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ2ZpbGw9IicgKyBmaWxsICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3N0cm9rZT0iJyArIHN0cm9rZSArICciICcgKwogICAgICAgICAgICAgICAgICAgICdzdHJva2Utd2lkdGg9IicgKyB3aWR0aCArICciICcgKwogICAgICAgICAgICAgICAgICAgICd3aWR0aD0iMS41ZW0iIGhlaWdodD0iMS41ZW0iJyArCiAgICAgICAgICAgICAgICAgICAgJy8+JzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdjcm9zcyc6CiAgICAgICAgICAgICAgICBodG1sID0gJzx1c2UgeGxpbms6aHJlZj0iI2Nyb3NzIiBjbGFzcz0ibGVnZW5kSWNvbiIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3g9IicgKyB4ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3k9IicgKyB5ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgLy8gJ2ZpbGw9IicgKyBmaWxsICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3N0cm9rZT0iJyArIHN0cm9rZSArICciICcgKwogICAgICAgICAgICAgICAgICAgICdzdHJva2Utd2lkdGg9IicgKyB3aWR0aCArICciICcgKwogICAgICAgICAgICAgICAgICAgICd3aWR0aD0iMS41ZW0iIGhlaWdodD0iMS41ZW0iJyArCiAgICAgICAgICAgICAgICAgICAgJy8+JzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdyZWN0YW5nbGUnOgogICAgICAgICAgICAgICAgaHRtbCA9ICc8dXNlIHhsaW5rOmhyZWY9IiNyZWN0YW5nbGUiIGNsYXNzPSJsZWdlbmRJY29uIiAnICsKICAgICAgICAgICAgICAgICAgICAneD0iJyArIHggKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAneT0iJyArIHkgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnZmlsbD0iJyArIGZpbGwgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnc3Ryb2tlPSInICsgc3Ryb2tlICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3N0cm9rZS13aWR0aD0iJyArIHdpZHRoICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoPSIxLjVlbSIgaGVpZ2h0PSIxLjVlbSInICsKICAgICAgICAgICAgICAgICAgICAnLz4nOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3BsdXMnOgogICAgICAgICAgICAgICAgaHRtbCA9ICc8dXNlIHhsaW5rOmhyZWY9IiNwbHVzIiBjbGFzcz0ibGVnZW5kSWNvbiIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3g9IicgKyB4ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3k9IicgKyB5ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgLy8gJ2ZpbGw9IicgKyBmaWxsICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3N0cm9rZT0iJyArIHN0cm9rZSArICciICcgKwogICAgICAgICAgICAgICAgICAgICdzdHJva2Utd2lkdGg9IicgKyB3aWR0aCArICciICcgKwogICAgICAgICAgICAgICAgICAgICd3aWR0aD0iMS41ZW0iIGhlaWdodD0iMS41ZW0iJyArCiAgICAgICAgICAgICAgICAgICAgJy8+JzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdiYXInOgogICAgICAgICAgICAgICAgaHRtbCA9ICc8dXNlIHhsaW5rOmhyZWY9IiNiYXJzIiBjbGFzcz0ibGVnZW5kSWNvbiIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3g9IicgKyB4ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3k9IicgKyB5ICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ2ZpbGw9IicgKyBmaWxsICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgLy8gJ3N0cm9rZT0iJyArIHN0cm9rZSArICciICcgKwogICAgICAgICAgICAgICAgICAgIC8vICdzdHJva2Utd2lkdGg9IicgKyB3aWR0aCArICciICcgKwogICAgICAgICAgICAgICAgICAgICd3aWR0aD0iMS41ZW0iIGhlaWdodD0iMS41ZW0iJyArCiAgICAgICAgICAgICAgICAgICAgJy8+JzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdhcmVhJzoKICAgICAgICAgICAgICAgIGh0bWwgPSAnPHVzZSB4bGluazpocmVmPSIjYXJlYSIgY2xhc3M9ImxlZ2VuZEljb24iICcgKwogICAgICAgICAgICAgICAgICAgICd4PSInICsgeCArICciICcgKwogICAgICAgICAgICAgICAgICAgICd5PSInICsgeSArICciICcgKwogICAgICAgICAgICAgICAgICAgICdmaWxsPSInICsgZmlsbCArICciICcgKwogICAgICAgICAgICAgICAgICAgIC8vICdzdHJva2U9IicgKyBzdHJva2UgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAvLyAnc3Ryb2tlLXdpZHRoPSInICsgd2lkdGggKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnd2lkdGg9IjEuNWVtIiBoZWlnaHQ9IjEuNWVtIicgKwogICAgICAgICAgICAgICAgICAgICcvPic7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnbGluZSc6CiAgICAgICAgICAgICAgICBodG1sID0gJzx1c2UgeGxpbms6aHJlZj0iI2xpbmUiIGNsYXNzPSJsZWdlbmRJY29uIiAnICsKICAgICAgICAgICAgICAgICAgICAneD0iJyArIHggKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAneT0iJyArIHkgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAvLyAnZmlsbD0iJyArIGZpbGwgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnc3Ryb2tlPSInICsgc3Ryb2tlICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3N0cm9rZS13aWR0aD0iJyArIHdpZHRoICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoPSIxLjVlbSIgaGVpZ2h0PSIxLjVlbSInICsKICAgICAgICAgICAgICAgICAgICAnLz4nOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0IGlzIGNpcmNsZQogICAgICAgICAgICAgICAgaHRtbCA9ICc8dXNlIHhsaW5rOmhyZWY9IiNjaXJjbGUiIGNsYXNzPSJsZWdlbmRJY29uIiAnICsKICAgICAgICAgICAgICAgICAgICAneD0iJyArIHggKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAneT0iJyArIHkgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnZmlsbD0iJyArIGZpbGwgKyAnIiAnICsKICAgICAgICAgICAgICAgICAgICAnc3Ryb2tlPSInICsgc3Ryb2tlICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3N0cm9rZS13aWR0aD0iJyArIHdpZHRoICsgJyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoPSIxLjVlbSIgaGVpZ2h0PSIxLjVlbSInICsKICAgICAgICAgICAgICAgICAgICAnLz4nOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGh0bWw7CiAgICB9CgogICAgLy8gRGVmaW5lIHN2ZyBzeW1ib2xzIGZvciBzaGFwZXMKICAgIHZhciBzdmdTaGFwZURlZnMgPSAnJyArCiAgICAgICAgJzxkZWZzPicgKwogICAgICAgICAgICAnPHN5bWJvbCBpZD0ibGluZSIgZmlsbD0ibm9uZSIgdmlld0JveD0iLTUgLTUgMjUgMjUiPicgKwogICAgICAgICAgICAgICAgJzxwb2x5bGluZSBwb2ludHM9IjAsMTUgNSw1IDEwLDEwIDE1LDAiLz4nICsKICAgICAgICAgICAgJzwvc3ltYm9sPicgKwoKICAgICAgICAgICAgJzxzeW1ib2wgaWQ9ImFyZWEiIHN0cm9rZS13aWR0aD0iMSIgdmlld0JveD0iLTUgLTUgMjUgMjUiPicgKwogICAgICAgICAgICAgICAgJzxwb2x5bGluZSBwb2ludHM9IjAsMTUgNSw1IDEwLDEwIDE1LDAsIDE1LDE1LCAwLDE1Ii8+JyArCiAgICAgICAgICAgICc8L3N5bWJvbD4nICsKCiAgICAgICAgICAgICc8c3ltYm9sIGlkPSJiYXJzIiBzdHJva2Utd2lkdGg9IjEiIHZpZXdCb3g9Ii01IC01IDI1IDI1Ij4nICsKICAgICAgICAgICAgICAgICc8cG9seWxpbmUgcG9pbnRzPSIxLjUsMTUuNSAxLjUsMTIuNSwgNC41LDEyLjUgNC41LDE1LjUgNi41LDE1LjUgNi41LDMuNSwgOS41LDMuNSA5LjUsMTUuNSAxMS41LDE1LjUgMTEuNSw3LjUgMTQuNSw3LjUgMTQuNSwxNS41IDEuNSwxNS41Ii8+JyArCiAgICAgICAgICAgICc8L3N5bWJvbD4nICsKCiAgICAgICAgICAgICc8c3ltYm9sIGlkPSJjaXJjbGUiIHZpZXdCb3g9Ii01IC01IDI1IDI1Ij4nICsKICAgICAgICAgICAgICAgICc8Y2lyY2xlIGN4PSIwIiBjeT0iMTUiIHI9IjIuNSIvPicgKwogICAgICAgICAgICAgICAgJzxjaXJjbGUgY3g9IjUiIGN5PSI1IiByPSIyLjUiLz4nICsKICAgICAgICAgICAgICAgICc8Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIyLjUiLz4nICsKICAgICAgICAgICAgICAgICc8Y2lyY2xlIGN4PSIxNSIgY3k9IjAiIHI9IjIuNSIvPicgKwogICAgICAgICAgICAnPC9zeW1ib2w+JyArCgogICAgICAgICAgICAnPHN5bWJvbCBpZD0icmVjdGFuZ2xlIiB2aWV3Qm94PSItNSAtNSAyNSAyNSI+JyArCiAgICAgICAgICAgICAgICAnPHJlY3QgeD0iLTIuMSIgeT0iMTIuOSIgd2lkdGg9IjQuMiIgaGVpZ2h0PSI0LjIiLz4nICsKICAgICAgICAgICAgICAgICc8cmVjdCB4PSIyLjkiIHk9IjIuOSIgd2lkdGg9IjQuMiIgaGVpZ2h0PSI0LjIiLz4nICsKICAgICAgICAgICAgICAgICc8cmVjdCB4PSI3LjkiIHk9IjcuOSIgd2lkdGg9IjQuMiIgaGVpZ2h0PSI0LjIiLz4nICsKICAgICAgICAgICAgICAgICc8cmVjdCB4PSIxMi45IiB5PSItMi4xIiB3aWR0aD0iNC4yIiBoZWlnaHQ9IjQuMiIvPicgKwogICAgICAgICAgICAnPC9zeW1ib2w+JyArCgogICAgICAgICAgICAnPHN5bWJvbCBpZD0iZGlhbW9uZCIgdmlld0JveD0iLTUgLTUgMjUgMjUiPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik0tMywxNSBMMCwxMiBMMywxNSwgTDAsMTggWiIvPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik0yLDUgTDUsMiBMOCw1LCBMNSw4IFoiLz4nICsKICAgICAgICAgICAgICAgICc8cGF0aCBkPSJNNywxMCBMMTAsNyBMMTMsMTAsIEwxMCwxMyBaIi8+JyArCiAgICAgICAgICAgICAgICAnPHBhdGggZD0iTTEyLDAgTDE1LC0zIEwxOCwwLCBMMTUsMyBaIi8+JyArCiAgICAgICAgICAgICc8L3N5bWJvbD4nICsKCiAgICAgICAgICAgICc8c3ltYm9sIGlkPSJjcm9zcyIgZmlsbD0ibm9uZSIgdmlld0JveD0iLTUgLTUgMjUgMjUiPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik0tMi4xLDEyLjkgTDIuMSwxNy4xLCBNMi4xLDEyLjkgTC0yLjEsMTcuMSBaIi8+JyArCiAgICAgICAgICAgICAgICAnPHBhdGggZD0iTTIuOSwyLjkgTDcuMSw3LjEgTTcuMSwyLjkgTDIuOSw3LjEgWiIvPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik03LjksNy45IEwxMi4xLDEyLjEgTTEyLjEsNy45IEw3LjksMTIuMSBaIi8+JyArCiAgICAgICAgICAgICAgICAnPHBhdGggZD0iTTEyLjksLTIuMSBMMTcuMSwyLjEgTTE3LjEsLTIuMSBMMTIuOSwyLjEgWiIvPicgKwogICAgICAgICAgICAnPC9zeW1ib2w+JyArCgogICAgICAgICAgICAnPHN5bWJvbCBpZD0icGx1cyIgZmlsbD0ibm9uZSIgdmlld0JveD0iLTUgLTUgMjUgMjUiPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik0wLDEyIEwwLDE4LCBNLTMsMTUgTDMsMTUgWiIvPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik01LDIgTDUsOCBNMiw1IEw4LDUgWiIvPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik0xMCw3IEwxMCwxMyBNNywxMCBMMTMsMTAgWiIvPicgKwogICAgICAgICAgICAgICAgJzxwYXRoIGQ9Ik0xNSwtMyBMMTUsMyBNMTIsMCBMMTgsMCBaIi8+JyArCiAgICAgICAgICAgICc8L3N5bWJvbD4nICsKICAgICAgICAnPC9kZWZzPic7CgogICAgLy8gR2VuZXJhdGUgYSBsaXN0IG9mIGxlZ2VuZCBlbnRyaWVzIGluIHRoZWlyIGZpbmFsIG9yZGVyCiAgICBmdW5jdGlvbiBnZXRMZWdlbmRFbnRyaWVzKHNlcmllcywgbGFiZWxGb3JtYXR0ZXIsIHNvcnRlZCkgewogICAgICAgIHZhciBsZiA9IGxhYmVsRm9ybWF0dGVyLAogICAgICAgICAgICBsZWdlbmRFbnRyaWVzID0gc2VyaWVzLnJlZHVjZShmdW5jdGlvbih2YWxpZEVudHJpZXMsIHMsIGkpIHsKICAgICAgICAgICAgICAgIHZhciBsYWJlbEV2YWwgPSAobGYgPyBsZihzLmxhYmVsLCBzKSA6IHMubGFiZWwpCiAgICAgICAgICAgICAgICBpZiAocy5oYXNPd25Qcm9wZXJ0eSgibGFiZWwiKSA/IGxhYmVsRXZhbCA6IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZW50cnkgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBsYWJlbEV2YWwgfHwgJ1Bsb3QgJyArIChpICsgMSksCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBzLmNvbG9yLAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lczogcy5saW5lcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50czogcy5wb2ludHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYXJzOiBzLmJhcnMKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YWxpZEVudHJpZXMucHVzaChlbnRyeSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2YWxpZEVudHJpZXM7CiAgICAgICAgICAgIH0sIFtdKTsKCiAgICAgICAgLy8gU29ydCB0aGUgbGVnZW5kIHVzaW5nIGVpdGhlciB0aGUgZGVmYXVsdCBvciBhIGN1c3RvbSBjb21wYXJhdG9yCiAgICAgICAgaWYgKHNvcnRlZCkgewogICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKHNvcnRlZCkpIHsKICAgICAgICAgICAgICAgIGxlZ2VuZEVudHJpZXMuc29ydChzb3J0ZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNvcnRlZCA9PT0gJ3JldmVyc2UnKSB7CiAgICAgICAgICAgICAgICBsZWdlbmRFbnRyaWVzLnJldmVyc2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBhc2NlbmRpbmcgPSAoc29ydGVkICE9PSAnZGVzY2VuZGluZycpOwogICAgICAgICAgICAgICAgbGVnZW5kRW50cmllcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5sYWJlbCA9PT0gYi5sYWJlbAogICAgICAgICAgICAgICAgICAgICAgICA/IDAKICAgICAgICAgICAgICAgICAgICAgICAgOiAoKGEubGFiZWwgPCBiLmxhYmVsKSAhPT0gYXNjZW5kaW5nID8gMSA6IC0xIC8vIExvZ2ljYWwgWE9SCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxlZ2VuZEVudHJpZXM7CiAgICB9CgogICAgLy8gcmV0dXJuIGZhbHNlIGlmIG9wdHMxIHNhbWUgYXMgb3B0czIKICAgIGZ1bmN0aW9uIGNoZWNrT3B0aW9ucyhvcHRzMSwgb3B0czIpIHsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9wdHMxKSB7CiAgICAgICAgICAgIGlmIChvcHRzMS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgICAgICAgaWYgKG9wdHMxW3Byb3BdICE9PSBvcHRzMltwcm9wXSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBDb21wYXJlIHR3byBsaXN0cyBvZiBsZWdlbmQgZW50cmllcwogICAgZnVuY3Rpb24gc2hvdWxkUmVkcmF3KG9sZEVudHJpZXMsIG5ld0VudHJpZXMpIHsKICAgICAgICBpZiAoIW9sZEVudHJpZXMgfHwgIW5ld0VudHJpZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAob2xkRW50cmllcy5sZW5ndGggIT09IG5ld0VudHJpZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICB2YXIgaSwgbmV3RW50cnksIG9sZEVudHJ5LCBuZXdPcHRzLCBvbGRPcHRzOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBuZXdFbnRyaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG5ld0VudHJ5ID0gbmV3RW50cmllc1tpXTsKICAgICAgICAgICAgb2xkRW50cnkgPSBvbGRFbnRyaWVzW2ldOwoKICAgICAgICAgICAgaWYgKG5ld0VudHJ5LmxhYmVsICE9PSBvbGRFbnRyeS5sYWJlbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChuZXdFbnRyeS5jb2xvciAhPT0gb2xkRW50cnkuY29sb3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjaGVjayBmb3IgY2hhbmdlcyBpbiBsaW5lcyBvcHRpb25zCiAgICAgICAgICAgIG5ld09wdHMgPSBuZXdFbnRyeS5vcHRpb25zLmxpbmVzOwogICAgICAgICAgICBvbGRPcHRzID0gb2xkRW50cnkub3B0aW9ucy5saW5lczsKICAgICAgICAgICAgaWYgKGNoZWNrT3B0aW9ucyhuZXdPcHRzLCBvbGRPcHRzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNoZWNrIGZvciBjaGFuZ2VzIGluIHBvaW50cyBvcHRpb25zCiAgICAgICAgICAgIG5ld09wdHMgPSBuZXdFbnRyeS5vcHRpb25zLnBvaW50czsKICAgICAgICAgICAgb2xkT3B0cyA9IG9sZEVudHJ5Lm9wdGlvbnMucG9pbnRzOwogICAgICAgICAgICBpZiAoY2hlY2tPcHRpb25zKG5ld09wdHMsIG9sZE9wdHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGNoYW5nZXMgaW4gYmFycyBvcHRpb25zCiAgICAgICAgICAgIG5ld09wdHMgPSBuZXdFbnRyeS5vcHRpb25zLmJhcnM7CiAgICAgICAgICAgIG9sZE9wdHMgPSBvbGRFbnRyeS5vcHRpb25zLmJhcnM7CiAgICAgICAgICAgIGlmIChjaGVja09wdGlvbnMobmV3T3B0cywgb2xkT3B0cykpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdChwbG90KSB7CiAgICAgICAgcGxvdC5ob29rcy5zZXR1cEdyaWQucHVzaChmdW5jdGlvbiAocGxvdCkgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHBsb3QuZ2V0T3B0aW9ucygpOwogICAgICAgICAgICB2YXIgc2VyaWVzID0gcGxvdC5nZXREYXRhKCksCiAgICAgICAgICAgICAgICBsYWJlbEZvcm1hdHRlciA9IG9wdGlvbnMubGVnZW5kLmxhYmVsRm9ybWF0dGVyLAogICAgICAgICAgICAgICAgb2xkRW50cmllcyA9IG9wdGlvbnMubGVnZW5kLmxlZ2VuZEVudHJpZXMsCiAgICAgICAgICAgICAgICBvbGRQbG90T2Zmc2V0ID0gb3B0aW9ucy5sZWdlbmQucGxvdE9mZnNldCwKICAgICAgICAgICAgICAgIG5ld0VudHJpZXMgPSBnZXRMZWdlbmRFbnRyaWVzKHNlcmllcywgbGFiZWxGb3JtYXR0ZXIsIG9wdGlvbnMubGVnZW5kLnNvcnRlZCksCiAgICAgICAgICAgICAgICBuZXdQbG90T2Zmc2V0ID0gcGxvdC5nZXRQbG90T2Zmc2V0KCk7CgogICAgICAgICAgICBpZiAoc2hvdWxkUmVkcmF3KG9sZEVudHJpZXMsIG5ld0VudHJpZXMpIHx8CiAgICAgICAgICAgICAgICBjaGVja09wdGlvbnMob2xkUGxvdE9mZnNldCwgbmV3UGxvdE9mZnNldCkpIHsKICAgICAgICAgICAgICAgIGluc2VydExlZ2VuZChwbG90LCBvcHRpb25zLCBwbG90LmdldFBsYWNlaG9sZGVyKCksIG5ld0VudHJpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgJC5wbG90LnBsdWdpbnMucHVzaCh7CiAgICAgICAgaW5pdDogaW5pdCwKICAgICAgICBvcHRpb25zOiBkZWZhdWx0T3B0aW9ucywKICAgICAgICBuYW1lOiAnbGVnZW5kJywKICAgICAgICB2ZXJzaW9uOiAnMS4wJwogICAgfSk7Cn0pKGpRdWVyeSk7Cg=="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogRmxvdCBwbHVnaW4gZm9yIGFkZGluZyB0aGUgYWJpbGl0eSB0byBwYW4gYW5kIHpvb20gdGhlIHBsb3QuCgpDb3B5cmlnaHQgKGMpIDIwMDctMjAxNCBJT0xBIGFuZCBPbGUgTGF1cnNlbi4KQ29weXJpZ2h0IChjKSAyMDE2IENpcHJpYW4gQ2V0ZXJhcy4KQ29weXJpZ2h0IChjKSAyMDE3IFJhbHVjYSBQb3J0YXNlLgpMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgoqLwoKLyoqCiMjIGpxdWVyeS5mbG90Lm5hdmlnYXRlLmpzCgpUaGlzIGZsb3QgcGx1Z2luIGlzIHVzZWQgZm9yIGFkZGluZyB0aGUgYWJpbGl0eSB0byBwYW4gYW5kIHpvb20gdGhlIHBsb3QuCkEgaGlnaGVyIGxldmVsIG92ZXJ2aWV3IGlzIGF2YWlsYWJsZSBhdCBbaW50ZXJhY3Rpb25zXShpbnRlcmFjdGlvbnMubWQpIGRvY3VtZW50YXRpb24uCgpUaGUgZGVmYXVsdCBiZWhhdmlvdXIgaXMgc2Nyb2xsd2hlZWwgdXAvZG93biB0byB6b29tIGluLCBkcmFnCnRvIHBhbi4gVGhlIHBsdWdpbiBkZWZpbmVzIHBsb3Quem9vbSh7IGNlbnRlciB9KSwgcGxvdC56b29tT3V0KCkgYW5kCnBsb3QucGFuKCBvZmZzZXQgKSBzbyB5b3UgZWFzaWx5IGNhbiBhZGQgY3VzdG9tIGNvbnRyb2xzLiBJdCBhbHNvIGZpcmVzCiJwbG90cGFuIiBhbmQgInBsb3R6b29tIiBldmVudHMsIHVzZWZ1bCBmb3Igc3luY2hyb25pemluZyBwbG90cy4KClRoZSBwbHVnaW4gc3VwcG9ydHMgdGhlc2Ugb3B0aW9uczoKYGBganMKICAgIHpvb206IHsKICAgICAgICBpbnRlcmFjdGl2ZTogZmFsc2UsCiAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICBhbW91bnQ6IDEuNSAgICAgICAgIC8vIDIgPSAyMDAlICh6b29tIGluKSwgMC41ID0gNTAlICh6b29tIG91dCkKICAgIH0KCiAgICBwYW46IHsKICAgICAgICBpbnRlcmFjdGl2ZTogZmFsc2UsCiAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICBjdXJzb3I6ICJtb3ZlIiwgICAgIC8vIENTUyBtb3VzZSBjdXJzb3IgdmFsdWUgdXNlZCB3aGVuIGRyYWdnaW5nLCBlLmcuICJwb2ludGVyIgogICAgICAgIGZyYW1lUmF0ZTogNjAsCiAgICAgICAgbW9kZTogInNtYXJ0IiAgICAgICAvLyBlbmFibGUgc21hcnQgcGFuIG1vZGUKICAgIH0KCiAgICB4YXhpczogewogICAgICAgIGF4aXNab29tOiB0cnVlLCAvL3pvb20gYXhpcyB3aGVuIG1vdXNlIG92ZXIgaXQgaXMgYWxsb3dlZAogICAgICAgIHBsb3Rab29tOiB0cnVlLCAvL3pvb20gYXhpcyBpcyBhbGxvd2VkIGZvciBwbG90IHpvb20KICAgICAgICBheGlzUGFuOiB0cnVlLCAvL3BhbiBheGlzIHdoZW4gbW91c2Ugb3ZlciBpdCBpcyBhbGxvd2VkCiAgICAgICAgcGxvdFBhbjogdHJ1ZSAvL3BhbiBheGlzIGlzIGFsbG93ZWQgZm9yIHBsb3QgcGFuCiAgICB9CgogICAgeWF4aXM6IHsKICAgICAgICBheGlzWm9vbTogdHJ1ZSwgLy96b29tIGF4aXMgd2hlbiBtb3VzZSBvdmVyIGl0IGlzIGFsbG93ZWQKICAgICAgICBwbG90Wm9vbTogdHJ1ZSwgLy96b29tIGF4aXMgaXMgYWxsb3dlZCBmb3IgcGxvdCB6b29tCiAgICAgICAgYXhpc1BhbjogdHJ1ZSwgLy9wYW4gYXhpcyB3aGVuIG1vdXNlIG92ZXIgaXQgaXMgYWxsb3dlZAogICAgICAgIHBsb3RQYW46IHRydWUgLy9wYW4gYXhpcyBpcyBhbGxvd2VkIGZvciBwbG90IHBhbgogICAgfQpgYGAKKippbnRlcmFjdGl2ZSoqIGVuYWJsZXMgdGhlIGJ1aWx0LWluIGRyYWcvY2xpY2sgYmVoYXZpb3VyLiBJZiB5b3UgZW5hYmxlCmludGVyYWN0aXZlIGZvciBwYW4sIHRoZW4geW91J2xsIGhhdmUgYSBiYXNpYyBwbG90IHRoYXQgc3VwcG9ydHMgbW92aW5nCmFyb3VuZDsgdGhlIHNhbWUgZm9yIHpvb20uCgoqKmFjdGl2ZSoqIGlzIHRydWUgYWZ0ZXIgYSB0b3VjaCB0YXAgb24gcGxvdC4gVGhpcyBlbmFibGVzIHBsb3QgbmF2aWdhdGlvbi4KT25jZSBhY3RpdmF0ZWQsIHpvb20gYW5kIHBhbiBjYW5ub3QgYmUgZGVhY3RpdmF0ZWQuIFdoZW4gdGhlIHBsb3QgYmVjb21lcyBhY3RpdmUsCiJwbG90YWN0aXZhdGVkIiBldmVudCBpcyB0cmlnZ2VyZWQuCgoqKmFtb3VudCoqIHNwZWNpZmllcyB0aGUgZGVmYXVsdCBhbW91bnQgdG8gem9vbSBpbiAoc28gMS41ID0gMTUwJSkgcmVsYXRpdmUgdG8KdGhlIGN1cnJlbnQgdmlld3BvcnQuCgoqKmN1cnNvcioqIGlzIGEgc3RhbmRhcmQgQ1NTIG1vdXNlIGN1cnNvciBzdHJpbmcgdXNlZCBmb3IgdmlzdWFsIGZlZWRiYWNrIHRvIHRoZQp1c2VyIHdoZW4gZHJhZ2dpbmcuCgoqKmZyYW1lUmF0ZSoqIHNwZWNpZmllcyB0aGUgbWF4aW11bSBudW1iZXIgb2YgdGltZXMgcGVyIHNlY29uZCB0aGUgcGxvdCB3aWxsCnVwZGF0ZSBpdHNlbGYgd2hpbGUgdGhlIHVzZXIgaXMgcGFubmluZyBhcm91bmQgb24gaXQgKHNldCB0byBudWxsIHRvIGRpc2FibGUKaW50ZXJtZWRpYXRlIHBhbnMsIHRoZSBwbG90IHdpbGwgdGhlbiBub3QgdXBkYXRlIHVudGlsIHRoZSBtb3VzZSBidXR0b24gaXMKcmVsZWFzZWQpLgoKKiptb2RlKiogYSBzdHJpbmcgc3BlY2lmaWVzIHRoZSBwYW4gbW9kZSBmb3IgbW91c2UgaW50ZXJhY3Rpb24uIEFjY2VwdGVkIHZhbHVlczoKJ21hbnVhbCc6IG5vIHBhbiBoaW50IG9yIGRpcmVjdGlvbiBzbmFwcGluZzsKJ3NtYXJ0JzogVGhlIGdyYXBoIHNob3dzIHBhbiBoaW50IGJhciBhbmQgdGhlIHBhbiBtb3ZlbWVudCB3aWxsIHNuYXAKdG8gb25lIGRpcmVjdGlvbiB3aGVuIHRoZSBkcmFnIGRpcmVjdGlvbiBpcyBjbG9zZSB0byBpdDsKJ3NtYXJ0TG9jaycuIFRoZSBncmFwaCBzaG93cyBwYW4gaGludCBiYXIgYW5kIHRoZSBwYW4gbW92ZW1lbnQgd2lsbCBhbHdheXMKc25hcCB0byBhIGRpcmVjdGlvbiB0aGF0IHRoZSBkcmFnIGRpb3JlY3Rpb24gc3RhcnRlZCB3aXRoLgoKRXhhbXBsZSBBUEkgdXNhZ2U6CmBgYGpzCiAgICBwbG90ID0gJC5wbG90KC4uLik7CgogICAgLy8gem9vbSBkZWZhdWx0IGFtb3VudCBpbiBvbiB0aGUgcGl4ZWwgKCAxMCwgMjAgKQogICAgcGxvdC56b29tKHsgY2VudGVyOiB7IGxlZnQ6IDEwLCB0b3A6IDIwIH0gfSk7CgogICAgLy8gem9vbSBvdXQgYWdhaW4KICAgIHBsb3Quem9vbU91dCh7IGNlbnRlcjogeyBsZWZ0OiAxMCwgdG9wOiAyMCB9IH0pOwoKICAgIC8vIHpvb20gMjAwJSBpbiBvbiB0aGUgcGl4ZWwgKDEwLCAyMCkKICAgIHBsb3Quem9vbSh7IGFtb3VudDogMiwgY2VudGVyOiB7IGxlZnQ6IDEwLCB0b3A6IDIwIH0gfSk7CgogICAgLy8gcGFuIDEwMCBwaXhlbHMgdG8gdGhlIGxlZnQgKGNoYW5naW5nIHgtcmFuZ2UgaW4gYSBwb3NpdGl2ZSB3YXkpIGFuZCAyMCBkb3duCiAgICBwbG90LnBhbih7IGxlZnQ6IC0xMDAsIHRvcDogMjAgfSkKYGBgCgpIZXJlLCAiY2VudGVyIiBzcGVjaWZpZXMgd2hlcmUgdGhlIGNlbnRlciBvZiB0aGUgem9vbWluZyBzaG91bGQgaGFwcGVuLiBOb3RlCnRoYXQgdGhpcyBpcyBkZWZpbmVkIGluIHBpeGVsIHNwYWNlLCBub3QgdGhlIHNwYWNlIG9mIHRoZSBkYXRhIHBvaW50cyAoeW91IGNhbgp1c2UgdGhlIHAyYyBoZWxwZXJzIG9uIHRoZSBheGVzIGluIEZsb3QgdG8gaGVscCB5b3UgY29udmVydCBiZXR3ZWVuIHRoZXNlKS4KCioqYW1vdW50KiogaXMgdGhlIGFtb3VudCB0byB6b29tIHRoZSB2aWV3cG9ydCByZWxhdGl2ZSB0byB0aGUgY3VycmVudCByYW5nZSwgc28KMSBpcyAxMDAlIChpLmUuIG5vIGNoYW5nZSksIDEuNSBpcyAxNTAlICh6b29tIGluKSwgMC43IGlzIDcwJSAoem9vbSBvdXQpLiBZb3UKY2FuIHNldCB0aGUgZGVmYXVsdCBpbiB0aGUgb3B0aW9ucy4KKi8KCi8qIGVzbGludC1lbmFibGUgKi8KKGZ1bmN0aW9uKCQpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICB6b29tOiB7CiAgICAgICAgICAgIGludGVyYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYW1vdW50OiAxLjUgLy8gaG93IG11Y2ggdG8gem9vbSByZWxhdGl2ZSB0byBjdXJyZW50IHBvc2l0aW9uLCAyID0gMjAwJSAoem9vbSBpbiksIDAuNSA9IDUwJSAoem9vbSBvdXQpCiAgICAgICAgfSwKICAgICAgICBwYW46IHsKICAgICAgICAgICAgaW50ZXJhY3RpdmU6IGZhbHNlLAogICAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgICBjdXJzb3I6ICJtb3ZlIiwKICAgICAgICAgICAgZnJhbWVSYXRlOiA2MCwKICAgICAgICAgICAgbW9kZTogJ3NtYXJ0JwogICAgICAgIH0sCiAgICAgICAgcmVjZW50ZXI6IHsKICAgICAgICAgICAgaW50ZXJhY3RpdmU6IHRydWUKICAgICAgICB9LAogICAgICAgIHhheGlzOiB7CiAgICAgICAgICAgIGF4aXNab29tOiB0cnVlLCAvL3pvb20gYXhpcyB3aGVuIG1vdXNlIG92ZXIgaXQgaXMgYWxsb3dlZAogICAgICAgICAgICBwbG90Wm9vbTogdHJ1ZSwgLy96b29tIGF4aXMgaXMgYWxsb3dlZCBmb3IgcGxvdCB6b29tCiAgICAgICAgICAgIGF4aXNQYW46IHRydWUsIC8vcGFuIGF4aXMgd2hlbiBtb3VzZSBvdmVyIGl0IGlzIGFsbG93ZWQKICAgICAgICAgICAgcGxvdFBhbjogdHJ1ZSAvL3BhbiBheGlzIGlzIGFsbG93ZWQgZm9yIHBsb3QgcGFuCiAgICAgICAgfSwKICAgICAgICB5YXhpczogewogICAgICAgICAgICBheGlzWm9vbTogdHJ1ZSwKICAgICAgICAgICAgcGxvdFpvb206IHRydWUsCiAgICAgICAgICAgIGF4aXNQYW46IHRydWUsCiAgICAgICAgICAgIHBsb3RQYW46IHRydWUKICAgICAgICB9CiAgICB9OwoKICAgIHZhciBzYXR1cmF0ZWQgPSAkLnBsb3Quc2F0dXJhdGVkOwogICAgdmFyIGJyb3dzZXIgPSAkLnBsb3QuYnJvd3NlcjsKICAgIHZhciBTTkFQUElOR19DT05TVEFOVCA9ICQucGxvdC51aUNvbnN0YW50cy5TTkFQUElOR19DT05TVEFOVDsKICAgIHZhciBQQU5ISU5UX0xFTkdUSF9DT05TVEFOVCA9ICQucGxvdC51aUNvbnN0YW50cy5QQU5ISU5UX0xFTkdUSF9DT05TVEFOVDsKCiAgICBmdW5jdGlvbiBpbml0KHBsb3QpIHsKICAgICAgICBwbG90Lmhvb2tzLnByb2Nlc3NPcHRpb25zLnB1c2goaW5pdE5ldmlnYXRpb24pOwogICAgfQoKICAgIGZ1bmN0aW9uIGluaXROZXZpZ2F0aW9uKHBsb3QsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgcGFuQXhlcyA9IG51bGw7CiAgICAgICAgdmFyIGNhbkRyYWcgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlTWFudWFsUGFuID0gb3B0aW9ucy5wYW4ubW9kZSA9PT0gJ21hbnVhbCcsCiAgICAgICAgICAgIHNtYXJ0UGFuTG9jayA9IG9wdGlvbnMucGFuLm1vZGUgPT09ICdzbWFydExvY2snLAogICAgICAgICAgICB1c2VTbWFydFBhbiA9IHNtYXJ0UGFuTG9jayB8fCBvcHRpb25zLnBhbi5tb2RlID09PSAnc21hcnQnOwoKICAgICAgICBmdW5jdGlvbiBvblpvb21DbGljayhlLCB6b29tT3V0LCBhbW91bnQpIHsKICAgICAgICAgICAgdmFyIHBhZ2UgPSBicm93c2VyLmdldFBhZ2VYWShlKTsKCiAgICAgICAgICAgIHZhciBjID0gcGxvdC5vZmZzZXQoKTsKICAgICAgICAgICAgYy5sZWZ0ID0gcGFnZS5YIC0gYy5sZWZ0OwogICAgICAgICAgICBjLnRvcCA9IHBhZ2UuWSAtIGMudG9wOwoKICAgICAgICAgICAgdmFyIGVjID0gcGxvdC5nZXRQbGFjZWhvbGRlcigpLm9mZnNldCgpOwogICAgICAgICAgICBlYy5sZWZ0ID0gcGFnZS5YIC0gZWMubGVmdDsKICAgICAgICAgICAgZWMudG9wID0gcGFnZS5ZIC0gZWMudG9wOwoKICAgICAgICAgICAgdmFyIGF4ZXMgPSBwbG90LmdldFhBeGVzKCkuY29uY2F0KHBsb3QuZ2V0WUF4ZXMoKSkuZmlsdGVyKGZ1bmN0aW9uIChheGlzKSB7CiAgICAgICAgICAgICAgICB2YXIgYm94ID0gYXhpcy5ib3g7CiAgICAgICAgICAgICAgICBpZiAoYm94ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGVjLmxlZnQgPiBib3gubGVmdCkgJiYgKGVjLmxlZnQgPCBib3gubGVmdCArIGJveC53aWR0aCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKGVjLnRvcCA+IGJveC50b3ApICYmIChlYy50b3AgPCBib3gudG9wICsgYm94LmhlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGF4ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBheGVzID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoem9vbU91dCkgewogICAgICAgICAgICAgICAgcGxvdC56b29tT3V0KHsKICAgICAgICAgICAgICAgICAgICBjZW50ZXI6IGMsCiAgICAgICAgICAgICAgICAgICAgYXhlczogYXhlcywKICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtb3VudAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwbG90Lnpvb20oewogICAgICAgICAgICAgICAgICAgIGNlbnRlcjogYywKICAgICAgICAgICAgICAgICAgICBheGVzOiBheGVzLAogICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHByZXZDdXJzb3IgPSAnZGVmYXVsdCcsCiAgICAgICAgICAgIHBhbkhpbnQgPSBudWxsLAogICAgICAgICAgICBwYW5UaW1lb3V0ID0gbnVsbCwKICAgICAgICAgICAgcGxvdFN0YXRlLAogICAgICAgICAgICBwcmV2RHJhZ1Bvc2l0aW9uID0geyB4OiAwLCB5OiAwIH0sCiAgICAgICAgICAgIGlzUGFuQWN0aW9uID0gZmFsc2U7CgogICAgICAgIGZ1bmN0aW9uIG9uTW91c2VXaGVlbChlLCBkZWx0YSkgewogICAgICAgICAgICB2YXIgbWF4QWJzb2x1dGVEZWx0YU9uTWFjID0gMSwKICAgICAgICAgICAgICAgIGlzTWFjU2Nyb2xsID0gTWF0aC5hYnMoZS5vcmlnaW5hbEV2ZW50LmRlbHRhWSkgPD0gbWF4QWJzb2x1dGVEZWx0YU9uTWFjLAogICAgICAgICAgICAgICAgZGVmYXVsdE5vbk1hY1Njcm9sbEFtb3VudCA9IG51bGwsCiAgICAgICAgICAgICAgICBtYWNNYWdpY1JhdGlvID0gNTAsCiAgICAgICAgICAgICAgICBhbW91bnQgPSBpc01hY1Njcm9sbCA/IDEgKyBNYXRoLmFicyhlLm9yaWdpbmFsRXZlbnQuZGVsdGFZKSAvIG1hY01hZ2ljUmF0aW8gOiBkZWZhdWx0Tm9uTWFjU2Nyb2xsQW1vdW50OwoKICAgICAgICAgICAgaWYgKGlzUGFuQWN0aW9uKSB7CiAgICAgICAgICAgICAgICBvbkRyYWdFbmQoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwbG90LmdldE9wdGlvbnMoKS56b29tLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgb25ab29tQ2xpY2soZSwgZGVsdGEgPCAwLCBhbW91bnQpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwbG90Lm5hdmlnYXRpb25TdGF0ZSA9IGZ1bmN0aW9uKHN0YXJ0UGFnZVgsIHN0YXJ0UGFnZVkpIHsKICAgICAgICAgICAgdmFyIGF4ZXMgPSB0aGlzLmdldEF4ZXMoKTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICBPYmplY3Qua2V5cyhheGVzKS5mb3JFYWNoKGZ1bmN0aW9uKGF4aXNOYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgYXhpcyA9IGF4ZXNbYXhpc05hbWVdOwogICAgICAgICAgICAgICAgcmVzdWx0W2F4aXNOYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICBuYXZpZ2F0aW9uT2Zmc2V0OiB7IGJlbG93OiBheGlzLm9wdGlvbnMub2Zmc2V0LmJlbG93IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGFib3ZlOiBheGlzLm9wdGlvbnMub2Zmc2V0LmFib3ZlIHx8IDB9LAogICAgICAgICAgICAgICAgICAgIGF4aXNNaW46IGF4aXMubWluLAogICAgICAgICAgICAgICAgICAgIGF4aXNNYXg6IGF4aXMubWF4LAogICAgICAgICAgICAgICAgICAgIGRpYWdNb2RlOiBmYWxzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJlc3VsdC5zdGFydFBhZ2VYID0gc3RhcnRQYWdlWCB8fCAwOwogICAgICAgICAgICByZXN1bHQuc3RhcnRQYWdlWSA9IHN0YXJ0UGFnZVkgfHwgMDsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uTW91c2VEb3duKGUpIHsKICAgICAgICAgICAgY2FuRHJhZyA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbk1vdXNlVXAoZSkgewogICAgICAgICAgICBjYW5EcmFnID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc0xlZnRNb3VzZUJ1dHRvblByZXNzZWQoZSkgewogICAgICAgICAgICByZXR1cm4gZS5idXR0b24gPT09IDA7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkRyYWdTdGFydChlKSB7CiAgICAgICAgICAgIGlmICghY2FuRHJhZyB8fCAhaXNMZWZ0TW91c2VCdXR0b25QcmVzc2VkKGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlzUGFuQWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHBhZ2UgPSBicm93c2VyLmdldFBhZ2VYWShlKTsKCiAgICAgICAgICAgIHZhciBlYyA9IHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS5vZmZzZXQoKTsKICAgICAgICAgICAgZWMubGVmdCA9IHBhZ2UuWCAtIGVjLmxlZnQ7CiAgICAgICAgICAgIGVjLnRvcCA9IHBhZ2UuWSAtIGVjLnRvcDsKCiAgICAgICAgICAgIHBhbkF4ZXMgPSBwbG90LmdldFhBeGVzKCkuY29uY2F0KHBsb3QuZ2V0WUF4ZXMoKSkuZmlsdGVyKGZ1bmN0aW9uIChheGlzKSB7CiAgICAgICAgICAgICAgICB2YXIgYm94ID0gYXhpcy5ib3g7CiAgICAgICAgICAgICAgICBpZiAoYm94ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGVjLmxlZnQgPiBib3gubGVmdCkgJiYgKGVjLmxlZnQgPCBib3gubGVmdCArIGJveC53aWR0aCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKGVjLnRvcCA+IGJveC50b3ApICYmIChlYy50b3AgPCBib3gudG9wICsgYm94LmhlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHBhbkF4ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBwYW5BeGVzID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYyA9IHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS5jc3MoJ2N1cnNvcicpOwogICAgICAgICAgICBpZiAoYykgewogICAgICAgICAgICAgICAgcHJldkN1cnNvciA9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS5jc3MoJ2N1cnNvcicsIHBsb3QuZ2V0T3B0aW9ucygpLnBhbi5jdXJzb3IpOwoKICAgICAgICAgICAgaWYgKHVzZVNtYXJ0UGFuKSB7CiAgICAgICAgICAgICAgICBwbG90U3RhdGUgPSBwbG90Lm5hdmlnYXRpb25TdGF0ZShwYWdlLlgsIHBhZ2UuWSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlTWFudWFsUGFuKSB7CiAgICAgICAgICAgICAgICBwcmV2RHJhZ1Bvc2l0aW9uLnggPSBwYWdlLlg7CiAgICAgICAgICAgICAgICBwcmV2RHJhZ1Bvc2l0aW9uLnkgPSBwYWdlLlk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gb25EcmFnKGUpIHsKICAgICAgICAgICAgaWYgKCFpc1BhbkFjdGlvbikgeyAKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwYWdlID0gYnJvd3Nlci5nZXRQYWdlWFkoZSk7CiAgICAgICAgICAgIHZhciBmcmFtZVJhdGUgPSBwbG90LmdldE9wdGlvbnMoKS5wYW4uZnJhbWVSYXRlOwoKICAgICAgICAgICAgaWYgKGZyYW1lUmF0ZSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGlmICh1c2VTbWFydFBhbikgewogICAgICAgICAgICAgICAgICAgIHBsb3Quc21hcnRQYW4oewogICAgICAgICAgICAgICAgICAgICAgICB4OiBwbG90U3RhdGUuc3RhcnRQYWdlWCAtIHBhZ2UuWCwKICAgICAgICAgICAgICAgICAgICAgICAgeTogcGxvdFN0YXRlLnN0YXJ0UGFnZVkgLSBwYWdlLlkKICAgICAgICAgICAgICAgICAgICB9LCBwbG90U3RhdGUsIHBhbkF4ZXMsIGZhbHNlLCBzbWFydFBhbkxvY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1c2VNYW51YWxQYW4pIHsKICAgICAgICAgICAgICAgICAgICBwbG90LnBhbih7CiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IHByZXZEcmFnUG9zaXRpb24ueCAtIHBhZ2UuWCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBwcmV2RHJhZ1Bvc2l0aW9uLnkgLSBwYWdlLlksCiAgICAgICAgICAgICAgICAgICAgICAgIGF4ZXM6IHBhbkF4ZXMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBwcmV2RHJhZ1Bvc2l0aW9uLnggPSBwYWdlLlg7CiAgICAgICAgICAgICAgICAgICAgcHJldkRyYWdQb3NpdGlvbi55ID0gcGFnZS5ZOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGFuVGltZW91dCB8fCAhZnJhbWVSYXRlKSByZXR1cm47CgogICAgICAgICAgICBwYW5UaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh1c2VTbWFydFBhbikgewogICAgICAgICAgICAgICAgICAgIHBsb3Quc21hcnRQYW4oewogICAgICAgICAgICAgICAgICAgICAgICB4OiBwbG90U3RhdGUuc3RhcnRQYWdlWCAtIHBhZ2UuWCwKICAgICAgICAgICAgICAgICAgICAgICAgeTogcGxvdFN0YXRlLnN0YXJ0UGFnZVkgLSBwYWdlLlkKICAgICAgICAgICAgICAgICAgICB9LCBwbG90U3RhdGUsIHBhbkF4ZXMsIGZhbHNlLCBzbWFydFBhbkxvY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1c2VNYW51YWxQYW4pIHsKICAgICAgICAgICAgICAgICAgICBwbG90LnBhbih7CiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IHByZXZEcmFnUG9zaXRpb24ueCAtIHBhZ2UuWCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBwcmV2RHJhZ1Bvc2l0aW9uLnkgLSBwYWdlLlksCiAgICAgICAgICAgICAgICAgICAgICAgIGF4ZXM6IHBhbkF4ZXMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBwcmV2RHJhZ1Bvc2l0aW9uLnggPSBwYWdlLlg7CiAgICAgICAgICAgICAgICAgICAgcHJldkRyYWdQb3NpdGlvbi55ID0gcGFnZS5ZOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHBhblRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9LCAxIC8gZnJhbWVSYXRlICogMTAwMCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkRyYWdFbmQoZSkgewogICAgICAgICAgICBpZiAoIWlzUGFuQWN0aW9uKSB7IAogICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBhblRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChwYW5UaW1lb3V0KTsKICAgICAgICAgICAgICAgIHBhblRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpc1BhbkFjdGlvbiA9IGZhbHNlOwogICAgICAgICAgICB2YXIgcGFnZSA9IGJyb3dzZXIuZ2V0UGFnZVhZKGUpOwoKICAgICAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlcigpLmNzcygnY3Vyc29yJywgcHJldkN1cnNvcik7CgogICAgICAgICAgICBpZiAodXNlU21hcnRQYW4pIHsKICAgICAgICAgICAgICAgIHBsb3Quc21hcnRQYW4oewogICAgICAgICAgICAgICAgICAgIHg6IHBsb3RTdGF0ZS5zdGFydFBhZ2VYIC0gcGFnZS5YLAogICAgICAgICAgICAgICAgICAgIHk6IHBsb3RTdGF0ZS5zdGFydFBhZ2VZIC0gcGFnZS5ZCiAgICAgICAgICAgICAgICB9LCBwbG90U3RhdGUsIHBhbkF4ZXMsIGZhbHNlLCBzbWFydFBhbkxvY2spOwogICAgICAgICAgICAgICAgcGxvdC5zbWFydFBhbi5lbmQoKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh1c2VNYW51YWxQYW4pIHsKICAgICAgICAgICAgICAgIHBsb3QucGFuKHsKICAgICAgICAgICAgICAgICAgICBsZWZ0OiBwcmV2RHJhZ1Bvc2l0aW9uLnggLSBwYWdlLlgsCiAgICAgICAgICAgICAgICAgICAgdG9wOiBwcmV2RHJhZ1Bvc2l0aW9uLnkgLSBwYWdlLlksCiAgICAgICAgICAgICAgICAgICAgYXhlczogcGFuQXhlcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBwcmV2RHJhZ1Bvc2l0aW9uLnggPSAwOwogICAgICAgICAgICAgICAgcHJldkRyYWdQb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25EYmxDbGljayhlKSB7CiAgICAgICAgICAgIHBsb3QuYWN0aXZhdGUoKTsKICAgICAgICAgICAgdmFyIG8gPSBwbG90LmdldE9wdGlvbnMoKQoKICAgICAgICAgICAgaWYgKCFvLnJlY2VudGVyLmludGVyYWN0aXZlKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgdmFyIGF4ZXMgPSBwbG90LmdldFRvdWNoZWRBeGlzKGUuY2xpZW50WCwgZS5jbGllbnRZKSwKICAgICAgICAgICAgICAgIGV2ZW50OwoKICAgICAgICAgICAgcGxvdC5yZWNlbnRlcih7IGF4ZXM6IGF4ZXNbMF0gPyBheGVzIDogbnVsbCB9KTsKCiAgICAgICAgICAgIGlmIChheGVzWzBdKSB7CiAgICAgICAgICAgICAgICBldmVudCA9IG5ldyAkLkV2ZW50KCdyZS1jZW50ZXInLCB7IGRldGFpbDogewogICAgICAgICAgICAgICAgICAgIGF4aXNUb3VjaGVkOiBheGVzWzBdCiAgICAgICAgICAgICAgICB9fSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldmVudCA9IG5ldyAkLkV2ZW50KCdyZS1jZW50ZXInLCB7IGRldGFpbDogZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwbG90LmdldFBsYWNlaG9sZGVyKCkudHJpZ2dlcihldmVudCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkNsaWNrKGUpIHsKICAgICAgICAgICAgcGxvdC5hY3RpdmF0ZSgpOwoKICAgICAgICAgICAgaWYgKGlzUGFuQWN0aW9uKSB7CiAgICAgICAgICAgICAgICBvbkRyYWdFbmQoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHBsb3QuYWN0aXZhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG8gPSBwbG90LmdldE9wdGlvbnMoKTsKICAgICAgICAgICAgaWYgKCFvLnBhbi5hY3RpdmUgfHwgIW8uem9vbS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIG8ucGFuLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBvLnpvb20uYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS50cmlnZ2VyKCJwbG90YWN0aXZhdGVkIiwgW3Bsb3RdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmluZEV2ZW50cyhwbG90LCBldmVudEhvbGRlcikgewogICAgICAgICAgICB2YXIgbyA9IHBsb3QuZ2V0T3B0aW9ucygpOwogICAgICAgICAgICBpZiAoby56b29tLmludGVyYWN0aXZlKSB7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlci5tb3VzZXdoZWVsKG9uTW91c2VXaGVlbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvLnBhbi5pbnRlcmFjdGl2ZSkgewogICAgICAgICAgICAgICAgcGxvdC5hZGRFdmVudEhhbmRsZXIoImRyYWdzdGFydCIsIG9uRHJhZ1N0YXJ0LCBldmVudEhvbGRlciwgMCk7CiAgICAgICAgICAgICAgICBwbG90LmFkZEV2ZW50SGFuZGxlcigiZHJhZyIsIG9uRHJhZywgZXZlbnRIb2xkZXIsIDApOwogICAgICAgICAgICAgICAgcGxvdC5hZGRFdmVudEhhbmRsZXIoImRyYWdlbmQiLCBvbkRyYWdFbmQsIGV2ZW50SG9sZGVyLCAwKTsKICAgICAgICAgICAgICAgIGV2ZW50SG9sZGVyLmJpbmQoIm1vdXNlZG93biIsIG9uTW91c2VEb3duKTsKICAgICAgICAgICAgICAgIGV2ZW50SG9sZGVyLmJpbmQoIm1vdXNldXAiLCBvbk1vdXNlVXApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBldmVudEhvbGRlci5kYmxjbGljayhvbkRibENsaWNrKTsKICAgICAgICAgICAgZXZlbnRIb2xkZXIuY2xpY2sob25DbGljayk7CiAgICAgICAgfQoKICAgICAgICBwbG90Lnpvb21PdXQgPSBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgICAgIGlmICghYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFyZ3MuYW1vdW50KSB7CiAgICAgICAgICAgICAgICBhcmdzLmFtb3VudCA9IHBsb3QuZ2V0T3B0aW9ucygpLnpvb20uYW1vdW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBhcmdzLmFtb3VudCA9IDEgLyBhcmdzLmFtb3VudDsKICAgICAgICAgICAgcGxvdC56b29tKGFyZ3MpOwogICAgICAgIH07CgogICAgICAgIHBsb3Quem9vbSA9IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAgICAgaWYgKCFhcmdzKSB7CiAgICAgICAgICAgICAgICBhcmdzID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBjID0gYXJncy5jZW50ZXIsCiAgICAgICAgICAgICAgICBhbW91bnQgPSBhcmdzLmFtb3VudCB8fCBwbG90LmdldE9wdGlvbnMoKS56b29tLmFtb3VudCwKICAgICAgICAgICAgICAgIHcgPSBwbG90LndpZHRoKCksCiAgICAgICAgICAgICAgICBoID0gcGxvdC5oZWlnaHQoKSwKICAgICAgICAgICAgICAgIGF4ZXMgPSBhcmdzLmF4ZXMgfHwgcGxvdC5nZXRBeGVzKCk7CgogICAgICAgICAgICBpZiAoIWMpIHsKICAgICAgICAgICAgICAgIGMgPSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogdyAvIDIsCiAgICAgICAgICAgICAgICAgICAgdG9wOiBoIC8gMgogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHhmID0gYy5sZWZ0IC8gdywKICAgICAgICAgICAgICAgIHlmID0gYy50b3AgLyBoLAogICAgICAgICAgICAgICAgbWlubWF4ID0gewogICAgICAgICAgICAgICAgICAgIHg6IHsKICAgICAgICAgICAgICAgICAgICAgICAgbWluOiBjLmxlZnQgLSB4ZiAqIHcgLyBhbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgIG1heDogYy5sZWZ0ICsgKDEgLSB4ZikgKiB3IC8gYW1vdW50CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB5OiB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbjogYy50b3AgLSB5ZiAqIGggLyBhbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgIG1heDogYy50b3AgKyAoMSAtIHlmKSAqIGggLyBhbW91bnQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGF4ZXMpIHsKICAgICAgICAgICAgICAgIGlmICghYXhlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGF4aXMgPSBheGVzW2tleV0sCiAgICAgICAgICAgICAgICAgICAgb3B0cyA9IGF4aXMub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICBtaW4gPSBtaW5tYXhbYXhpcy5kaXJlY3Rpb25dLm1pbiwKICAgICAgICAgICAgICAgICAgICBtYXggPSBtaW5tYXhbYXhpcy5kaXJlY3Rpb25dLm1heCwKICAgICAgICAgICAgICAgICAgICBuYXZpZ2F0aW9uT2Zmc2V0ID0gYXhpcy5vcHRpb25zLm9mZnNldDsKCiAgICAgICAgICAgICAgICAvL3NraXAgYXhpcyB3aXRob3V0IGF4aXNab29tIHdoZW4gem9vbWluZyBvbmx5IG9uIGNlcnRhaW4gYXhpcyBvciBheGlzIHdpdGhvdXQgcGxvdFpvb20gZm9yIHpvb20gb24gZW50aXJlIHBsb3QKICAgICAgICAgICAgICAgIGlmICgoIW9wdHMuYXhpc1pvb20gJiYgYXJncy5heGVzKSB8fCAoIWFyZ3MuYXhlcyAmJiAhb3B0cy5wbG90Wm9vbSkpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBtaW4gPSAkLnBsb3Quc2F0dXJhdGVkLnNhdHVyYXRlKGF4aXMuYzJwKG1pbikpOwogICAgICAgICAgICAgICAgbWF4ID0gJC5wbG90LnNhdHVyYXRlZC5zYXR1cmF0ZShheGlzLmMycChtYXgpKTsKICAgICAgICAgICAgICAgIGlmIChtaW4gPiBtYXgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgbWluIDwgbWF4CiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IG1pbjsKICAgICAgICAgICAgICAgICAgICBtaW4gPSBtYXg7CiAgICAgICAgICAgICAgICAgICAgbWF4ID0gdG1wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBvZmZzZXRCZWxvdyA9ICQucGxvdC5zYXR1cmF0ZWQuc2F0dXJhdGUobmF2aWdhdGlvbk9mZnNldC5iZWxvdyAtIChheGlzLm1pbiAtIG1pbikpOwogICAgICAgICAgICAgICAgdmFyIG9mZnNldEFib3ZlID0gJC5wbG90LnNhdHVyYXRlZC5zYXR1cmF0ZShuYXZpZ2F0aW9uT2Zmc2V0LmFib3ZlIC0gKGF4aXMubWF4IC0gbWF4KSk7CiAgICAgICAgICAgICAgICBvcHRzLm9mZnNldCA9IHsgYmVsb3c6IG9mZnNldEJlbG93LCBhYm92ZTogb2Zmc2V0QWJvdmUgfTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHBsb3Quc2V0dXBHcmlkKHRydWUpOwogICAgICAgICAgICBwbG90LmRyYXcoKTsKCiAgICAgICAgICAgIGlmICghYXJncy5wcmV2ZW50RXZlbnQpIHsKICAgICAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS50cmlnZ2VyKCJwbG90em9vbSIsIFtwbG90LCBhcmdzXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBwbG90LnBhbiA9IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAgICAgdmFyIGRlbHRhID0gewogICAgICAgICAgICAgICAgeDogK2FyZ3MubGVmdCwKICAgICAgICAgICAgICAgIHk6ICthcmdzLnRvcAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGlzTmFOKGRlbHRhLngpKSBkZWx0YS54ID0gMDsKICAgICAgICAgICAgaWYgKGlzTmFOKGRlbHRhLnkpKSBkZWx0YS55ID0gMDsKCiAgICAgICAgICAgICQuZWFjaChhcmdzLmF4ZXMgfHwgcGxvdC5nZXRBeGVzKCksIGZ1bmN0aW9uKF8sIGF4aXMpIHsKICAgICAgICAgICAgICAgIHZhciBvcHRzID0gYXhpcy5vcHRpb25zLAogICAgICAgICAgICAgICAgICAgIGQgPSBkZWx0YVtheGlzLmRpcmVjdGlvbl07CgogICAgICAgICAgICAgICAgLy9za2lwIGF4aXMgd2l0aG91dCBheGlzUGFuIHdoZW4gcGFubmluZyBvbmx5IG9uIGNlcnRhaW4gYXhpcyBvciBheGlzIHdpdGhvdXQgcGxvdFBhbiBmb3IgcGFuIHRoZSBlbnRpcmUgcGxvdAogICAgICAgICAgICAgICAgaWYgKCghb3B0cy5heGlzUGFuICYmIGFyZ3MuYXhlcykgfHwgKCFvcHRzLnBsb3RQYW4gJiYgIWFyZ3MuYXhlcykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGQgIT09IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmF2aWdhdGlvbk9mZnNldEJlbG93ID0gc2F0dXJhdGVkLnNhdHVyYXRlKGF4aXMuYzJwKGF4aXMucDJjKGF4aXMubWluKSArIGQpIC0gYXhpcy5jMnAoYXhpcy5wMmMoYXhpcy5taW4pKSksCiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmlnYXRpb25PZmZzZXRBYm92ZSA9IHNhdHVyYXRlZC5zYXR1cmF0ZShheGlzLmMycChheGlzLnAyYyhheGlzLm1heCkgKyBkKSAtIGF4aXMuYzJwKGF4aXMucDJjKGF4aXMubWF4KSkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRmluaXRlKG5hdmlnYXRpb25PZmZzZXRCZWxvdykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF2aWdhdGlvbk9mZnNldEJlbG93ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghaXNGaW5pdGUobmF2aWdhdGlvbk9mZnNldEFib3ZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBuYXZpZ2F0aW9uT2Zmc2V0QWJvdmUgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgb3B0cy5vZmZzZXQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJlbG93OiBzYXR1cmF0ZWQuc2F0dXJhdGUobmF2aWdhdGlvbk9mZnNldEJlbG93ICsgKG9wdHMub2Zmc2V0LmJlbG93IHx8IDApKSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJvdmU6IHNhdHVyYXRlZC5zYXR1cmF0ZShuYXZpZ2F0aW9uT2Zmc2V0QWJvdmUgKyAob3B0cy5vZmZzZXQuYWJvdmUgfHwgMCkpCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBwbG90LnNldHVwR3JpZCh0cnVlKTsKICAgICAgICAgICAgcGxvdC5kcmF3KCk7CiAgICAgICAgICAgIGlmICghYXJncy5wcmV2ZW50RXZlbnQpIHsKICAgICAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS50cmlnZ2VyKCJwbG90cGFuIiwgW3Bsb3QsIGFyZ3NdKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHBsb3QucmVjZW50ZXIgPSBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgICAgICQuZWFjaChhcmdzLmF4ZXMgfHwgcGxvdC5nZXRBeGVzKCksIGZ1bmN0aW9uKF8sIGF4aXMpIHsKICAgICAgICAgICAgICAgIGlmIChhcmdzLmF4ZXMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXJlY3Rpb24gPT09ICd4JykgewogICAgICAgICAgICAgICAgICAgICAgICBheGlzLm9wdGlvbnMub2Zmc2V0ID0geyBiZWxvdzogMCB9OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5kaXJlY3Rpb24gPT09ICd5JykgewogICAgICAgICAgICAgICAgICAgICAgICBheGlzLm9wdGlvbnMub2Zmc2V0ID0geyBhYm92ZTogMCB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYXhpcy5vcHRpb25zLm9mZnNldCA9IHsgYmVsb3c6IDAsIGFib3ZlOiAwIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwbG90LnNldHVwR3JpZCh0cnVlKTsKICAgICAgICAgICAgcGxvdC5kcmF3KCk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHNob3VsZFNuYXAgPSBmdW5jdGlvbihkZWx0YSkgewogICAgICAgICAgICByZXR1cm4gKE1hdGguYWJzKGRlbHRhLnkpIDwgU05BUFBJTkdfQ09OU1RBTlQgJiYgTWF0aC5hYnMoZGVsdGEueCkgPj0gU05BUFBJTkdfQ09OU1RBTlQpIHx8CiAgICAgICAgICAgICAgICAoTWF0aC5hYnMoZGVsdGEueCkgPCBTTkFQUElOR19DT05TVEFOVCAmJiBNYXRoLmFicyhkZWx0YS55KSA+PSBTTkFQUElOR19DT05TVEFOVCk7CiAgICAgICAgfQoKICAgICAgICAvLyBhZGp1c3QgZGVsdGEgc28gdGhlIHBhbiBhY3Rpb24gaXMgY29uc3RyYWluZWQgb24gdGhlIHZlcnRpY2FsIG9yIGhvcml6b250YWwgZGlyZWN0aW9uCiAgICAgICAgLy8gaXQgdGhlIG1vdmVtZW50cyBpbiB0aGUgb3RoZXIgZGlyZWN0aW9uIGFyZSBzbWFsbAogICAgICAgIHZhciBhZGp1c3REZWx0YVRvU25hcCA9IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgICAgIGlmIChNYXRoLmFicyhkZWx0YS54KSA8IFNOQVBQSU5HX0NPTlNUQU5UICYmIE1hdGguYWJzKGRlbHRhLnkpID49IFNOQVBQSU5HX0NPTlNUQU5UKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ge3g6IDAsIHk6IGRlbHRhLnl9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGVsdGEueSkgPCBTTkFQUElOR19DT05TVEFOVCAmJiBNYXRoLmFicyhkZWx0YS54KSA+PSBTTkFQUElOR19DT05TVEFOVCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHt4OiBkZWx0YS54LCB5OiAwfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxvY2tlZERpcmVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIGxvY2tEZWx0YURpcmVjdGlvbiA9IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgICAgIGlmICghbG9ja2VkRGlyZWN0aW9uICYmIE1hdGgubWF4KE1hdGguYWJzKGRlbHRhLngpLCBNYXRoLmFicyhkZWx0YS55KSkgPj0gU05BUFBJTkdfQ09OU1RBTlQpIHsKICAgICAgICAgICAgICAgIGxvY2tlZERpcmVjdGlvbiA9IE1hdGguYWJzKGRlbHRhLngpIDwgTWF0aC5hYnMoZGVsdGEueSkgPyAneScgOiAneCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAobG9ja2VkRGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICd4JzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyB4OiBkZWx0YS54LCB5OiAwIH07CiAgICAgICAgICAgICAgICBjYXNlICd5JzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyB4OiAwLCB5OiBkZWx0YS55IH07CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7IHg6IDAsIHk6IDAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGlzRGlhZ29uYWxNb2RlID0gZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRlbHRhLngpID4gMCAmJiBNYXRoLmFicyhkZWx0YS55KSA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciByZXN0b3JlQXhpc09mZnNldCA9IGZ1bmN0aW9uKGF4ZXMsIGluaXRpYWxTdGF0ZSwgZGVsdGEpIHsKICAgICAgICAgICAgdmFyIGF4aXM7CiAgICAgICAgICAgIE9iamVjdC5rZXlzKGF4ZXMpLmZvckVhY2goZnVuY3Rpb24oYXhpc05hbWUpIHsKICAgICAgICAgICAgICAgIGF4aXMgPSBheGVzW2F4aXNOYW1lXTsKICAgICAgICAgICAgICAgIGlmIChkZWx0YVtheGlzLmRpcmVjdGlvbl0gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBheGlzLm9wdGlvbnMub2Zmc2V0LmJlbG93ID0gaW5pdGlhbFN0YXRlW2F4aXNOYW1lXS5uYXZpZ2F0aW9uT2Zmc2V0LmJlbG93OwogICAgICAgICAgICAgICAgICAgIGF4aXMub3B0aW9ucy5vZmZzZXQuYWJvdmUgPSBpbml0aWFsU3RhdGVbYXhpc05hbWVdLm5hdmlnYXRpb25PZmZzZXQuYWJvdmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIHByZXZEZWx0YSA9IHsgeDogMCwgeTogMCB9OwogICAgICAgIHBsb3Quc21hcnRQYW4gPSBmdW5jdGlvbihkZWx0YSwgaW5pdGlhbFN0YXRlLCBwYW5BeGVzLCBwcmV2ZW50RXZlbnQsIHNtYXJ0TG9jaykgewogICAgICAgICAgICB2YXIgc25hcCA9IHNtYXJ0TG9jayA/IHRydWUgOiBzaG91bGRTbmFwKGRlbHRhKSwKICAgICAgICAgICAgICAgIGF4ZXMgPSBwbG90LmdldEF4ZXMoKSwKICAgICAgICAgICAgICAgIG9wdHM7CiAgICAgICAgICAgIGRlbHRhID0gc21hcnRMb2NrID8gbG9ja0RlbHRhRGlyZWN0aW9uKGRlbHRhKSA6IGFkanVzdERlbHRhVG9TbmFwKGRlbHRhKTsKCiAgICAgICAgICAgIGlmIChpc0RpYWdvbmFsTW9kZShkZWx0YSkpIHsKICAgICAgICAgICAgICAgIGluaXRpYWxTdGF0ZS5kaWFnTW9kZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzbmFwICYmIGluaXRpYWxTdGF0ZS5kaWFnTW9kZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgaW5pdGlhbFN0YXRlLmRpYWdNb2RlID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXN0b3JlQXhpc09mZnNldChheGVzLCBpbml0aWFsU3RhdGUsIGRlbHRhKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNuYXApIHsKICAgICAgICAgICAgICAgIHBhbkhpbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgeDogaW5pdGlhbFN0YXRlLnN0YXJ0UGFnZVggLSBwbG90Lm9mZnNldCgpLmxlZnQgKyBwbG90LmdldFBsb3RPZmZzZXQoKS5sZWZ0LAogICAgICAgICAgICAgICAgICAgICAgICB5OiBpbml0aWFsU3RhdGUuc3RhcnRQYWdlWSAtIHBsb3Qub2Zmc2V0KCkudG9wICsgcGxvdC5nZXRQbG90T2Zmc2V0KCkudG9wCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBlbmQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgeDogaW5pdGlhbFN0YXRlLnN0YXJ0UGFnZVggLSBkZWx0YS54IC0gcGxvdC5vZmZzZXQoKS5sZWZ0ICsgcGxvdC5nZXRQbG90T2Zmc2V0KCkubGVmdCwKICAgICAgICAgICAgICAgICAgICAgICAgeTogaW5pdGlhbFN0YXRlLnN0YXJ0UGFnZVkgLSBkZWx0YS55IC0gcGxvdC5vZmZzZXQoKS50b3AgKyBwbG90LmdldFBsb3RPZmZzZXQoKS50b3AKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYW5IaW50ID0gewogICAgICAgICAgICAgICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHg6IGluaXRpYWxTdGF0ZS5zdGFydFBhZ2VYIC0gcGxvdC5vZmZzZXQoKS5sZWZ0ICsgcGxvdC5nZXRQbG90T2Zmc2V0KCkubGVmdCwKICAgICAgICAgICAgICAgICAgICAgICAgeTogaW5pdGlhbFN0YXRlLnN0YXJ0UGFnZVkgLSBwbG90Lm9mZnNldCgpLnRvcCArIHBsb3QuZ2V0UGxvdE9mZnNldCgpLnRvcAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZW5kOiBmYWxzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNOYU4oZGVsdGEueCkpIGRlbHRhLnggPSAwOwogICAgICAgICAgICBpZiAoaXNOYU4oZGVsdGEueSkpIGRlbHRhLnkgPSAwOwoKICAgICAgICAgICAgaWYgKHBhbkF4ZXMpIHsKICAgICAgICAgICAgICAgIGF4ZXMgPSBwYW5BeGVzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYXhpcywgYXhpc01pbiwgYXhpc01heCwgcCwgZDsKICAgICAgICAgICAgT2JqZWN0LmtleXMoYXhlcykuZm9yRWFjaChmdW5jdGlvbihheGlzTmFtZSkgewogICAgICAgICAgICAgICAgYXhpcyA9IGF4ZXNbYXhpc05hbWVdOwogICAgICAgICAgICAgICAgYXhpc01pbiA9IGF4aXMubWluOwogICAgICAgICAgICAgICAgYXhpc01heCA9IGF4aXMubWF4OwogICAgICAgICAgICAgICAgb3B0cyA9IGF4aXMub3B0aW9uczsKCiAgICAgICAgICAgICAgICBkID0gZGVsdGFbYXhpcy5kaXJlY3Rpb25dOwogICAgICAgICAgICAgICAgcCA9IHByZXZEZWx0YVtheGlzLmRpcmVjdGlvbl07CgogICAgICAgICAgICAgICAgLy9za2lwIGF4aXMgd2l0aG91dCBheGlzUGFuIHdoZW4gcGFubmluZyBvbmx5IG9uIGNlcnRhaW4gYXhpcyBvciBheGlzIHdpdGhvdXQgcGxvdFBhbiBmb3IgcGFuIHRoZSBlbnRpcmUgcGxvdAogICAgICAgICAgICAgICAgaWYgKCghb3B0cy5heGlzUGFuICYmIHBhbkF4ZXMpIHx8ICghcGFuQXhlcyAmJiAhb3B0cy5wbG90UGFuKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYXZpZ2F0aW9uT2Zmc2V0QmVsb3cgPSBzYXR1cmF0ZWQuc2F0dXJhdGUoYXhpcy5jMnAoYXhpcy5wMmMoYXhpc01pbikgLSAocCAtIGQpKSAtIGF4aXMuYzJwKGF4aXMucDJjKGF4aXNNaW4pKSksCiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmlnYXRpb25PZmZzZXRBYm92ZSA9IHNhdHVyYXRlZC5zYXR1cmF0ZShheGlzLmMycChheGlzLnAyYyhheGlzTWF4KSAtIChwIC0gZCkpIC0gYXhpcy5jMnAoYXhpcy5wMmMoYXhpc01heCkpKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Zpbml0ZShuYXZpZ2F0aW9uT2Zmc2V0QmVsb3cpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmlnYXRpb25PZmZzZXRCZWxvdyA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRmluaXRlKG5hdmlnYXRpb25PZmZzZXRBYm92ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF2aWdhdGlvbk9mZnNldEFib3ZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGF4aXMub3B0aW9ucy5vZmZzZXQuYmVsb3cgPSBzYXR1cmF0ZWQuc2F0dXJhdGUobmF2aWdhdGlvbk9mZnNldEJlbG93ICsgKGF4aXMub3B0aW9ucy5vZmZzZXQuYmVsb3cgfHwgMCkpOwogICAgICAgICAgICAgICAgICAgIGF4aXMub3B0aW9ucy5vZmZzZXQuYWJvdmUgPSBzYXR1cmF0ZWQuc2F0dXJhdGUobmF2aWdhdGlvbk9mZnNldEFib3ZlICsgKGF4aXMub3B0aW9ucy5vZmZzZXQuYWJvdmUgfHwgMCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHByZXZEZWx0YSA9IGRlbHRhOwogICAgICAgICAgICBwbG90LnNldHVwR3JpZCh0cnVlKTsKICAgICAgICAgICAgcGxvdC5kcmF3KCk7CgogICAgICAgICAgICBpZiAoIXByZXZlbnRFdmVudCkgewogICAgICAgICAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlcigpLnRyaWdnZXIoInBsb3RwYW4iLCBbcGxvdCwgZGVsdGEsIHBhbkF4ZXMsIGluaXRpYWxTdGF0ZV0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcGxvdC5zbWFydFBhbi5lbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcGFuSGludCA9IG51bGw7CiAgICAgICAgICAgIGxvY2tlZERpcmVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHByZXZEZWx0YSA9IHsgeDogMCwgeTogMCB9OwogICAgICAgICAgICBwbG90LnRyaWdnZXJSZWRyYXdPdmVybGF5KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzaHV0ZG93bihwbG90LCBldmVudEhvbGRlcikgewogICAgICAgICAgICBldmVudEhvbGRlci51bmJpbmQoIm1vdXNld2hlZWwiLCBvbk1vdXNlV2hlZWwpOwogICAgICAgICAgICBldmVudEhvbGRlci51bmJpbmQoIm1vdXNlZG93biIsIG9uTW91c2VEb3duKTsKICAgICAgICAgICAgZXZlbnRIb2xkZXIudW5iaW5kKCJtb3VzZXVwIiwgb25Nb3VzZVVwKTsKICAgICAgICAgICAgZXZlbnRIb2xkZXIudW5iaW5kKCJkcmFnc3RhcnQiLCBvbkRyYWdTdGFydCk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgiZHJhZyIsIG9uRHJhZyk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgiZHJhZ2VuZCIsIG9uRHJhZ0VuZCk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgiZGJsY2xpY2siLCBvbkRibENsaWNrKTsKICAgICAgICAgICAgZXZlbnRIb2xkZXIudW5iaW5kKCJjbGljayIsIG9uQ2xpY2spOwoKICAgICAgICAgICAgaWYgKHBhblRpbWVvdXQpIGNsZWFyVGltZW91dChwYW5UaW1lb3V0KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdPdmVybGF5KHBsb3QsIGN0eCkgewogICAgICAgICAgICBpZiAocGFuSGludCkgewogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoOTYsIDE2MCwgMjA4LCAwLjcpJzsKICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAyOwogICAgICAgICAgICAgICAgY3R4LmxpbmVKb2luID0gInJvdW5kIjsKICAgICAgICAgICAgICAgIHZhciBzdGFydHggPSBNYXRoLnJvdW5kKHBhbkhpbnQuc3RhcnQueCksCiAgICAgICAgICAgICAgICAgICAgc3RhcnR5ID0gTWF0aC5yb3VuZChwYW5IaW50LnN0YXJ0LnkpLAogICAgICAgICAgICAgICAgICAgIGVuZHgsIGVuZHk7CgogICAgICAgICAgICAgICAgaWYgKHBhbkF4ZXMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFuQXhlc1swXS5kaXJlY3Rpb24gPT09ICd4JykgewogICAgICAgICAgICAgICAgICAgICAgICBlbmR5ID0gTWF0aC5yb3VuZChwYW5IaW50LnN0YXJ0LnkpOwogICAgICAgICAgICAgICAgICAgICAgICBlbmR4ID0gTWF0aC5yb3VuZChwYW5IaW50LmVuZC54KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBhbkF4ZXNbMF0uZGlyZWN0aW9uID09PSAneScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW5keCA9IE1hdGgucm91bmQocGFuSGludC5zdGFydC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgZW5keSA9IE1hdGgucm91bmQocGFuSGludC5lbmQueSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbmR4ID0gTWF0aC5yb3VuZChwYW5IaW50LmVuZC54KTsKICAgICAgICAgICAgICAgICAgICBlbmR5ID0gTWF0aC5yb3VuZChwYW5IaW50LmVuZC55KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CgogICAgICAgICAgICAgICAgaWYgKHBhbkhpbnQuZW5kID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oc3RhcnR4LCBzdGFydHkgLSBQQU5ISU5UX0xFTkdUSF9DT05TVEFOVCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhzdGFydHgsIHN0YXJ0eSArIFBBTkhJTlRfTEVOR1RIX0NPTlNUQU5UKTsKCiAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyhzdGFydHggKyBQQU5ISU5UX0xFTkdUSF9DT05TVEFOVCwgc3RhcnR5KTsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKHN0YXJ0eCAtIFBBTkhJTlRfTEVOR1RIX0NPTlNUQU5ULCBzdGFydHkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlyWCA9IHN0YXJ0eSA9PT0gZW5keTsKCiAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyhzdGFydHggLSAoZGlyWCA/IDAgOiBQQU5ISU5UX0xFTkdUSF9DT05TVEFOVCksIHN0YXJ0eSAtIChkaXJYID8gUEFOSElOVF9MRU5HVEhfQ09OU1RBTlQgOiAwKSk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhzdGFydHggKyAoZGlyWCA/IDAgOiBQQU5ISU5UX0xFTkdUSF9DT05TVEFOVCksIHN0YXJ0eSArIChkaXJYID8gUEFOSElOVF9MRU5HVEhfQ09OU1RBTlQgOiAwKSk7CgogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oc3RhcnR4LCBzdGFydHkpOwogICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oZW5keCwgZW5keSk7CgogICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oZW5keCAtIChkaXJYID8gMCA6IFBBTkhJTlRfTEVOR1RIX0NPTlNUQU5UKSwgZW5keSAtIChkaXJYID8gUEFOSElOVF9MRU5HVEhfQ09OU1RBTlQgOiAwKSk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhlbmR4ICsgKGRpclggPyAwIDogUEFOSElOVF9MRU5HVEhfQ09OU1RBTlQpLCBlbmR5ICsgKGRpclggPyBQQU5ISU5UX0xFTkdUSF9DT05TVEFOVCA6IDApKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsb3QuZ2V0VG91Y2hlZEF4aXMgPSBmdW5jdGlvbih0b3VjaFBvaW50WCwgdG91Y2hQb2ludFkpIHsKICAgICAgICAgICAgdmFyIGVjID0gcGxvdC5nZXRQbGFjZWhvbGRlcigpLm9mZnNldCgpOwogICAgICAgICAgICBlYy5sZWZ0ID0gdG91Y2hQb2ludFggLSBlYy5sZWZ0OwogICAgICAgICAgICBlYy50b3AgPSB0b3VjaFBvaW50WSAtIGVjLnRvcDsKCiAgICAgICAgICAgIHZhciBheGlzID0gcGxvdC5nZXRYQXhlcygpLmNvbmNhdChwbG90LmdldFlBeGVzKCkpLmZpbHRlcihmdW5jdGlvbiAoYXhpcykgewogICAgICAgICAgICAgICAgdmFyIGJveCA9IGF4aXMuYm94OwogICAgICAgICAgICAgICAgaWYgKGJveCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlYy5sZWZ0ID4gYm94LmxlZnQpICYmIChlYy5sZWZ0IDwgYm94LmxlZnQgKyBib3gud2lkdGgpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZWMudG9wID4gYm94LnRvcCkgJiYgKGVjLnRvcCA8IGJveC50b3AgKyBib3guaGVpZ2h0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gYXhpczsKICAgICAgICB9CgogICAgICAgIHBsb3QuaG9va3MuZHJhd092ZXJsYXkucHVzaChkcmF3T3ZlcmxheSk7CiAgICAgICAgcGxvdC5ob29rcy5iaW5kRXZlbnRzLnB1c2goYmluZEV2ZW50cyk7CiAgICAgICAgcGxvdC5ob29rcy5zaHV0ZG93bi5wdXNoKHNodXRkb3duKTsKICAgIH0KCiAgICAkLnBsb3QucGx1Z2lucy5wdXNoKHsKICAgICAgICBpbml0OiBpbml0LAogICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgbmFtZTogJ25hdmlnYXRlJywKICAgICAgICB2ZXJzaW9uOiAnMS4zJwogICAgfSk7Cn0pKGpRdWVyeSk7Cg=="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogZ2xvYmFsIGpRdWVyeSAqLwoKLyoqCiMjIGpxdWVyeS5mbG90LmhvdmVyLmpzCgpUaGlzIHBsdWdpbiBpcyB1c2VkIGZvciBtb3VzZSBob3ZlciBhbmQgdGFwIG9uIGEgcG9pbnQgb2YgcGxvdCBzZXJpZXMuCkl0IHN1cHBvcnRzIHRoZSBmb2xsb3dpbmcgb3B0aW9uczoKYGBganMKZ3JpZDogewogICAgaG92ZXJhYmxlOiBmYWxzZSwgLy90byB0cmlnZ2VyIHBsb3Rob3ZlciBldmVudCBvbiBtb3VzZSBob3ZlciBvciB0YXAgb24gYSBwb2ludAogICAgY2xpY2thYmxlOiBmYWxzZSAvL3RvIHRyaWdnZXIgcGxvdGNsaWNrIGV2ZW50IG9uIG1vdXNlIGhvdmVyCn0KYGBgCgpJdCBsaXN0ZW5zIHRvIG5hdGl2ZSBtb3VzZSBtb3ZlIGV2ZW50IG9yIGNsaWNrLCBhcyB3ZWxsIGFzIGFydGlmaWNpYWwgZ2VuZXJhdGVkCnRhcCBhbmQgdG91Y2hldmVudC4KCldoZW4gdGhlIG1vdXNlIGlzIG92ZXIgYSBwb2ludCBvciBhIHRhcCBvbiBhIHBvaW50IGlzIHBlcmZvcm1lZCwgdGhhdCBwb2ludCBvcgp0aGUgY29ycmVzY3BvbmRpbmcgYmFyIHdpbGwgYmUgaGlnaGxpZ2h0ZWQgYW5kIGEgInBsb3Rob3ZlciIgZXZlbnQgd2lsbCBiZSBnZW5lcmF0ZWQuCgpDdXN0b20gInRvdWNoZXZlbnQiIGlzIHRyaWdnZXJlZCB3aGVuIGFueSB0b3VjaCBpbnRlcmFjdGlvbiBpcyBtYWRlLiBIb3ZlciBwbHVnaW4KaGFuZGxlcyB0aGlzIGV2ZW50cyBieSB1bmhpZ2hsaWdodGluZyBhbGwgb2YgdGhlIHByZXZpb3VzbHkgaGlnaGxpZ2h0ZWQgcG9pbnRzIGFuZCBnZW5lcmF0ZXMKInBsb3Rob3ZlcmNsZWFudXAiIGV2ZW50IHRvIG5vdGlmeSBhbnkgcGFydCB0aGF0IGlzIGhhbmRsaW5nIHBsb3Rob3ZlciAoZm9yIGV4ZW1wbGUgdG8gY2xlYW51cAp0aGUgdG9vbHRpcCBmcm9tIHdlYmNoYXJ0cykuCiovCgooZnVuY3Rpb24oJCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIHZhciBvcHRpb25zID0gewogICAgICAgIGdyaWQ6IHsKICAgICAgICAgICAgaG92ZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgY2xpY2thYmxlOiBmYWxzZQogICAgICAgIH0KICAgIH07CgogICAgdmFyIGJyb3dzZXIgPSAkLnBsb3QuYnJvd3NlcjsKCiAgICB2YXIgZXZlbnRUeXBlID0gewogICAgICAgIGNsaWNrOiAnY2xpY2snLAogICAgICAgIGhvdmVyOiAnaG92ZXInCiAgICB9CgogICAgZnVuY3Rpb24gaW5pdChwbG90KSB7CiAgICAgICAgdmFyIGxhc3RNb3VzZU1vdmVFdmVudDsKICAgICAgICB2YXIgaGlnaGxpZ2h0cyA9IFtdOwoKICAgICAgICBmdW5jdGlvbiBiaW5kRXZlbnRzKHBsb3QsIGV2ZW50SG9sZGVyKSB7CiAgICAgICAgICAgIHZhciBvID0gcGxvdC5nZXRPcHRpb25zKCk7CgogICAgICAgICAgICBpZiAoby5ncmlkLmhvdmVyYWJsZSB8fCBvLmdyaWQuY2xpY2thYmxlKSB7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlclswXS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGV2ZW50JywgdHJpZ2dlckNsZWFudXBFdmVudCwgZmFsc2UpOwogICAgICAgICAgICAgICAgZXZlbnRIb2xkZXJbMF0uYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgZ2VuZXJhdGVQbG90aG92ZXJFdmVudCwgZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoby5ncmlkLmNsaWNrYWJsZSkgewogICAgICAgICAgICAgICAgZXZlbnRIb2xkZXIuYmluZCgiY2xpY2siLCBvbkNsaWNrKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG8uZ3JpZC5ob3ZlcmFibGUpIHsKICAgICAgICAgICAgICAgIGV2ZW50SG9sZGVyLmJpbmQoIm1vdXNlbW92ZSIsIG9uTW91c2VNb3ZlKTsKCiAgICAgICAgICAgICAgICAvLyBVc2UgYmluZCwgcmF0aGVyIHRoYW4gLm1vdXNlbGVhdmUsIGJlY2F1c2Ugd2Ugb2ZmaWNpYWxseQogICAgICAgICAgICAgICAgLy8gc3RpbGwgc3VwcG9ydCBqUXVlcnkgMS4yLjYsIHdoaWNoIGRvZXNuJ3QgZGVmaW5lIGEgc2hvcnRjdXQKICAgICAgICAgICAgICAgIC8vIGZvciBtb3VzZWVudGVyIG9yIG1vdXNlbGVhdmUuICBUaGlzIHdhcyBhIGJ1Zy9vdmVyc2lnaHQgdGhhdAogICAgICAgICAgICAgICAgLy8gd2FzIGZpeGVkIHNvbWV3aGVyZSBhcm91bmQgMS4zLnguICBXZSBjYW4gcmV0dXJuIHRvIHVzaW5nCiAgICAgICAgICAgICAgICAvLyAubW91c2VsZWF2ZSB3aGVuIHdlIGRyb3Agc3VwcG9ydCBmb3IgMS4yLjYuCgogICAgICAgICAgICAgICAgZXZlbnRIb2xkZXIuYmluZCgibW91c2VsZWF2ZSIsIG9uTW91c2VMZWF2ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNodXRkb3duKHBsb3QsIGV2ZW50SG9sZGVyKSB7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RhcCcsIGdlbmVyYXRlUGxvdGhvdmVyRXZlbnQpOwogICAgICAgICAgICBldmVudEhvbGRlclswXS5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGV2ZW50JywgdHJpZ2dlckNsZWFudXBFdmVudCk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgibW91c2Vtb3ZlIiwgb25Nb3VzZU1vdmUpOwogICAgICAgICAgICBldmVudEhvbGRlci51bmJpbmQoIm1vdXNlbGVhdmUiLCBvbk1vdXNlTGVhdmUpOwogICAgICAgICAgICBldmVudEhvbGRlci51bmJpbmQoImNsaWNrIiwgb25DbGljayk7CiAgICAgICAgICAgIGhpZ2hsaWdodHMgPSBbXTsKICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBnZW5lcmF0ZVBsb3Rob3ZlckV2ZW50KGUpIHsKICAgICAgICAgICAgdmFyIG8gPSBwbG90LmdldE9wdGlvbnMoKSwKICAgICAgICAgICAgICAgIG5ld0V2ZW50ID0gbmV3IEN1c3RvbUV2ZW50KCdtb3VzZWV2ZW50Jyk7CgogICAgICAgICAgICAvL3RyYW5zZm9ybSBmcm9tIHRvdWNoIGV2ZW50IHRvIG1vdXNlIGV2ZW50IGZvcm1hdAogICAgICAgICAgICBuZXdFdmVudC5wYWdlWCA9IGUuZGV0YWlsLmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYOwogICAgICAgICAgICBuZXdFdmVudC5wYWdlWSA9IGUuZGV0YWlsLmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZOwogICAgICAgICAgICBuZXdFdmVudC5jbGllbnRYID0gZS5kZXRhaWwuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WDsKICAgICAgICAgICAgbmV3RXZlbnQuY2xpZW50WSA9IGUuZGV0YWlsLmNoYW5nZWRUb3VjaGVzWzBdLmNsaWVudFk7CgogICAgICAgICAgICBpZiAoby5ncmlkLmhvdmVyYWJsZSkgewogICAgICAgICAgICAgICAgZG9UcmlnZ2VyQ2xpY2tIb3ZlckV2ZW50KG5ld0V2ZW50LCBldmVudFR5cGUuaG92ZXIsIDMwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkb1RyaWdnZXJDbGlja0hvdmVyRXZlbnQoZXZlbnQsIGV2ZW50VHlwZSwgc2VhcmNoRGlzdGFuY2UpIHsKICAgICAgICAgICAgdmFyIHNlcmllcyA9IHBsb3QuZ2V0RGF0YSgpOwogICAgICAgICAgICBpZiAoZXZlbnQgIT09IHVuZGVmaW5lZAogICAgICAgICAgICAgICAgJiYgc2VyaWVzLmxlbmd0aCA+IDAKICAgICAgICAgICAgICAgICYmIHNlcmllc1swXS54YXhpcy5jMnAgIT09IHVuZGVmaW5lZAogICAgICAgICAgICAgICAgJiYgc2VyaWVzWzBdLnlheGlzLmMycCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUb1RyaWdnZXIgPSAicGxvdCIgKyBldmVudFR5cGU7CiAgICAgICAgICAgICAgICB2YXIgc2VyaWVzRmxhZyA9IGV2ZW50VHlwZSArICJhYmxlIjsKICAgICAgICAgICAgICAgIHRyaWdnZXJDbGlja0hvdmVyRXZlbnQoZXZlbnRUb1RyaWdnZXIsIGV2ZW50LAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlcmllc1tpXVtzZXJpZXNGbGFnXSAhPT0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfSwgc2VhcmNoRGlzdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbk1vdXNlTW92ZShlKSB7CiAgICAgICAgICAgIGxhc3RNb3VzZU1vdmVFdmVudCA9IGU7CiAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKVswXS5sYXN0TW91c2VNb3ZlRXZlbnQgPSBlOwogICAgICAgICAgICBkb1RyaWdnZXJDbGlja0hvdmVyRXZlbnQoZSwgZXZlbnRUeXBlLmhvdmVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uTW91c2VMZWF2ZShlKSB7CiAgICAgICAgICAgIGxhc3RNb3VzZU1vdmVFdmVudCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlcigpWzBdLmxhc3RNb3VzZU1vdmVFdmVudCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdHJpZ2dlckNsaWNrSG92ZXJFdmVudCgicGxvdGhvdmVyIiwgZSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uQ2xpY2soZSkgewogICAgICAgICAgICBkb1RyaWdnZXJDbGlja0hvdmVyRXZlbnQoZSwgZXZlbnRUeXBlLmNsaWNrKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRyaWdnZXJDbGVhbnVwRXZlbnQoKSB7CiAgICAgICAgICAgIHBsb3QudW5oaWdobGlnaHQoKTsKICAgICAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlcigpLnRyaWdnZXIoJ3Bsb3Rob3ZlcmNsZWFudXAnKTsKICAgICAgICB9CgogICAgICAgIC8vIHRyaWdnZXIgY2xpY2sgb3IgaG92ZXIgZXZlbnQgKHRoZXkgc2VuZCB0aGUgc2FtZSBwYXJhbWV0ZXJzCiAgICAgICAgLy8gc28gd2Ugc2hhcmUgdGhlaXIgY29kZSkKICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyQ2xpY2tIb3ZlckV2ZW50KGV2ZW50bmFtZSwgZXZlbnQsIHNlcmllc0ZpbHRlciwgc2VhcmNoRGlzdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBwbG90LmdldE9wdGlvbnMoKSwKICAgICAgICAgICAgICAgIG9mZnNldCA9IHBsb3Qub2Zmc2V0KCksCiAgICAgICAgICAgICAgICBwYWdlID0gYnJvd3Nlci5nZXRQYWdlWFkoZXZlbnQpLAogICAgICAgICAgICAgICAgY2FudmFzWCA9IHBhZ2UuWCAtIG9mZnNldC5sZWZ0LAogICAgICAgICAgICAgICAgY2FudmFzWSA9IHBhZ2UuWSAtIG9mZnNldC50b3AsCiAgICAgICAgICAgICAgICBwb3MgPSBwbG90LmMycCh7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogY2FudmFzWCwKICAgICAgICAgICAgICAgICAgICB0b3A6IGNhbnZhc1kKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZGlzdGFuY2UgPSBzZWFyY2hEaXN0YW5jZSAhPT0gdW5kZWZpbmVkID8gc2VhcmNoRGlzdGFuY2UgOiBvcHRpb25zLmdyaWQubW91c2VBY3RpdmVSYWRpdXM7CgogICAgICAgICAgICBwb3MucGFnZVggPSBwYWdlLlg7CiAgICAgICAgICAgIHBvcy5wYWdlWSA9IHBhZ2UuWTsKCiAgICAgICAgICAgIHZhciBpdGVtID0gcGxvdC5maW5kTmVhcmJ5SXRlbShjYW52YXNYLCBjYW52YXNZLCBzZXJpZXNGaWx0ZXIsIGRpc3RhbmNlKTsKCiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICAvLyBmaWxsIGluIG1vdXNlIHBvcyBmb3IgYW55IGxpc3RlbmVycyBvdXQgdGhlcmUKICAgICAgICAgICAgICAgIGl0ZW0ucGFnZVggPSBwYXJzZUludChpdGVtLnNlcmllcy54YXhpcy5wMmMoaXRlbS5kYXRhcG9pbnRbMF0pICsgb2Zmc2V0LmxlZnQsIDEwKTsKICAgICAgICAgICAgICAgIGl0ZW0ucGFnZVkgPSBwYXJzZUludChpdGVtLnNlcmllcy55YXhpcy5wMmMoaXRlbS5kYXRhcG9pbnRbMV0pICsgb2Zmc2V0LnRvcCwgMTApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5ncmlkLmF1dG9IaWdobGlnaHQpIHsKICAgICAgICAgICAgICAgIC8vIGNsZWFyIGF1dG8taGlnaGxpZ2h0cwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoaWdobGlnaHRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGggPSBoaWdobGlnaHRzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICgoaC5hdXRvID09PSBldmVudG5hbWUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgIShpdGVtICYmIGguc2VyaWVzID09PSBpdGVtLnNlcmllcyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaC5wb2ludFswXSA9PT0gaXRlbS5kYXRhcG9pbnRbMF0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGgucG9pbnRbMV0gPT09IGl0ZW0uZGF0YXBvaW50WzFdKSkgfHwgIWl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdW5oaWdobGlnaHQoaC5zZXJpZXMsIGgucG9pbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodChpdGVtLnNlcmllcywgaXRlbS5kYXRhcG9pbnQsIGV2ZW50bmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS50cmlnZ2VyKGV2ZW50bmFtZSwgW3BvcywgaXRlbV0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaGlnaGxpZ2h0KHMsIHBvaW50LCBhdXRvKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHMgPSBwbG90LmdldERhdGEoKVtzXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBwb2ludCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHZhciBwcyA9IHMuZGF0YXBvaW50cy5wb2ludHNpemU7CiAgICAgICAgICAgICAgICBwb2ludCA9IHMuZGF0YXBvaW50cy5wb2ludHMuc2xpY2UocHMgKiBwb2ludCwgcHMgKiAocG9pbnQgKyAxKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpID0gaW5kZXhPZkhpZ2hsaWdodChzLCBwb2ludCk7CiAgICAgICAgICAgIGlmIChpID09PSAtMSkgewogICAgICAgICAgICAgICAgaGlnaGxpZ2h0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBzZXJpZXM6IHMsCiAgICAgICAgICAgICAgICAgICAgcG9pbnQ6IHBvaW50LAogICAgICAgICAgICAgICAgICAgIGF1dG86IGF1dG8KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHBsb3QudHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghYXV0bykgewogICAgICAgICAgICAgICAgaGlnaGxpZ2h0c1tpXS5hdXRvID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVuaGlnaGxpZ2h0KHMsIHBvaW50KSB7CiAgICAgICAgICAgIGlmIChzID09IG51bGwgJiYgcG9pbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaGlnaGxpZ2h0cyA9IFtdOwogICAgICAgICAgICAgICAgcGxvdC50cmlnZ2VyUmVkcmF3T3ZlcmxheSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIHMgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBzID0gcGxvdC5nZXREYXRhKClbc107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgcG9pbnQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICB2YXIgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgICAgICAgICAgcG9pbnQgPSBzLmRhdGFwb2ludHMucG9pbnRzLnNsaWNlKHBzICogcG9pbnQsIHBzICogKHBvaW50ICsgMSkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaSA9IGluZGV4T2ZIaWdobGlnaHQocywgcG9pbnQpOwogICAgICAgICAgICBpZiAoaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIGhpZ2hsaWdodHMuc3BsaWNlKGksIDEpOwoKICAgICAgICAgICAgICAgIHBsb3QudHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5kZXhPZkhpZ2hsaWdodChzLCBwKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGlnaGxpZ2h0cy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIGggPSBoaWdobGlnaHRzW2ldOwogICAgICAgICAgICAgICAgaWYgKGguc2VyaWVzID09PSBzICYmCiAgICAgICAgICAgICAgICAgICAgaC5wb2ludFswXSA9PT0gcFswXSAmJgogICAgICAgICAgICAgICAgICAgIGgucG9pbnRbMV0gPT09IHBbMV0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0RhdGFwb2ludHMoKSB7CiAgICAgICAgICAgIHRyaWdnZXJDbGVhbnVwRXZlbnQoKTsKICAgICAgICAgICAgZG9UcmlnZ2VyQ2xpY2tIb3ZlckV2ZW50KGxhc3RNb3VzZU1vdmVFdmVudCwgZXZlbnRUeXBlLmhvdmVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldHVwR3JpZCgpIHsKICAgICAgICAgICAgZG9UcmlnZ2VyQ2xpY2tIb3ZlckV2ZW50KGxhc3RNb3VzZU1vdmVFdmVudCwgZXZlbnRUeXBlLmhvdmVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdPdmVybGF5KHBsb3QsIG9jdHgsIG92ZXJsYXkpIHsKICAgICAgICAgICAgdmFyIHBsb3RPZmZzZXQgPSBwbG90LmdldFBsb3RPZmZzZXQoKSwKICAgICAgICAgICAgICAgIGksIGhpOwoKICAgICAgICAgICAgb2N0eC5zYXZlKCk7CiAgICAgICAgICAgIG9jdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaGlnaGxpZ2h0cy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgaGkgPSBoaWdobGlnaHRzW2ldOwoKICAgICAgICAgICAgICAgIGlmIChoaS5zZXJpZXMuYmFycy5zaG93KSBkcmF3QmFySGlnaGxpZ2h0KGhpLnNlcmllcywgaGkucG9pbnQsIG9jdHgpOwogICAgICAgICAgICAgICAgZWxzZSBkcmF3UG9pbnRIaWdobGlnaHQoaGkuc2VyaWVzLCBoaS5wb2ludCwgb2N0eCwgcGxvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2N0eC5yZXN0b3JlKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3UG9pbnRIaWdobGlnaHQoc2VyaWVzLCBwb2ludCwgb2N0eCwgcGxvdCkgewogICAgICAgICAgICB2YXIgeCA9IHBvaW50WzBdLAogICAgICAgICAgICAgICAgeSA9IHBvaW50WzFdLAogICAgICAgICAgICAgICAgYXhpc3ggPSBzZXJpZXMueGF4aXMsCiAgICAgICAgICAgICAgICBheGlzeSA9IHNlcmllcy55YXhpcywKICAgICAgICAgICAgICAgIGhpZ2hsaWdodENvbG9yID0gKHR5cGVvZiBzZXJpZXMuaGlnaGxpZ2h0Q29sb3IgPT09ICJzdHJpbmciKSA/IHNlcmllcy5oaWdobGlnaHRDb2xvciA6ICQuY29sb3IucGFyc2Uoc2VyaWVzLmNvbG9yKS5zY2FsZSgnYScsIDAuNSkudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIGlmICh4IDwgYXhpc3gubWluIHx8IHggPiBheGlzeC5tYXggfHwgeSA8IGF4aXN5Lm1pbiB8fCB5ID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwb2ludFJhZGl1cyA9IHNlcmllcy5wb2ludHMucmFkaXVzICsgc2VyaWVzLnBvaW50cy5saW5lV2lkdGggLyAyOwogICAgICAgICAgICBvY3R4LmxpbmVXaWR0aCA9IHBvaW50UmFkaXVzOwogICAgICAgICAgICBvY3R4LnN0cm9rZVN0eWxlID0gaGlnaGxpZ2h0Q29sb3I7CiAgICAgICAgICAgIHZhciByYWRpdXMgPSAxLjUgKiBwb2ludFJhZGl1czsKICAgICAgICAgICAgeCA9IGF4aXN4LnAyYyh4KTsKICAgICAgICAgICAgeSA9IGF4aXN5LnAyYyh5KTsKCiAgICAgICAgICAgIG9jdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIHZhciBzeW1ib2wgPSBzZXJpZXMucG9pbnRzLnN5bWJvbDsKICAgICAgICAgICAgaWYgKHN5bWJvbCA9PT0gJ2NpcmNsZScpIHsKICAgICAgICAgICAgICAgIG9jdHguYXJjKHgsIHksIHJhZGl1cywgMCwgMiAqIE1hdGguUEksIGZhbHNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3ltYm9sID09PSAnc3RyaW5nJyAmJiBwbG90LmRyYXdTeW1ib2wgJiYgcGxvdC5kcmF3U3ltYm9sW3N5bWJvbF0pIHsKICAgICAgICAgICAgICAgIHBsb3QuZHJhd1N5bWJvbFtzeW1ib2xdKG9jdHgsIHgsIHksIHJhZGl1cywgZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBvY3R4LnN0cm9rZSgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZHJhd0JhckhpZ2hsaWdodChzZXJpZXMsIHBvaW50LCBvY3R4KSB7CiAgICAgICAgICAgIHZhciBoaWdobGlnaHRDb2xvciA9ICh0eXBlb2Ygc2VyaWVzLmhpZ2hsaWdodENvbG9yID09PSAic3RyaW5nIikgPyBzZXJpZXMuaGlnaGxpZ2h0Q29sb3IgOiAkLmNvbG9yLnBhcnNlKHNlcmllcy5jb2xvcikuc2NhbGUoJ2EnLCAwLjUpLnRvU3RyaW5nKCksCiAgICAgICAgICAgICAgICBmaWxsU3R5bGUgPSBoaWdobGlnaHRDb2xvciwKICAgICAgICAgICAgICAgIGJhckxlZnQ7CgogICAgICAgICAgICB2YXIgYmFyV2lkdGggPSBzZXJpZXMuYmFycy5iYXJXaWR0aFswXSB8fCBzZXJpZXMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgICAgc3dpdGNoIChzZXJpZXMuYmFycy5hbGlnbikgewogICAgICAgICAgICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgICAgICAgICAgICAgYmFyTGVmdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICAgICAgICAgICAgYmFyTGVmdCA9IC1iYXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgYmFyTGVmdCA9IC1iYXJXaWR0aCAvIDI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9jdHgubGluZVdpZHRoID0gc2VyaWVzLmJhcnMubGluZVdpZHRoOwogICAgICAgICAgICBvY3R4LnN0cm9rZVN0eWxlID0gaGlnaGxpZ2h0Q29sb3I7CgogICAgICAgICAgICB2YXIgZmlsbFRvd2FyZHMgPSBzZXJpZXMuYmFycy5maWxsVG93YXJkcyB8fCAwLAogICAgICAgICAgICAgICAgYm90dG9tID0gZmlsbFRvd2FyZHMgPiBzZXJpZXMueWF4aXMubWluID8gTWF0aC5taW4oc2VyaWVzLnlheGlzLm1heCwgZmlsbFRvd2FyZHMpIDogc2VyaWVzLnlheGlzLm1pbjsKCiAgICAgICAgICAgICQucGxvdC5kcmF3U2VyaWVzLmRyYXdCYXIocG9pbnRbMF0sIHBvaW50WzFdLCBwb2ludFsyXSB8fCBib3R0b20sIGJhckxlZnQsIGJhckxlZnQgKyBiYXJXaWR0aCwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWxsU3R5bGU7CiAgICAgICAgICAgICAgICB9LCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgb2N0eCwgc2VyaWVzLmJhcnMuaG9yaXpvbnRhbCwgc2VyaWVzLmJhcnMubGluZVdpZHRoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGluaXRIb3ZlcihwbG90LCBvcHRpb25zKSB7CiAgICAgICAgICAgIHBsb3QuaGlnaGxpZ2h0ID0gaGlnaGxpZ2h0OwogICAgICAgICAgICBwbG90LnVuaGlnaGxpZ2h0ID0gdW5oaWdobGlnaHQ7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmdyaWQuaG92ZXJhYmxlIHx8IG9wdGlvbnMuZ3JpZC5jbGlja2FibGUpIHsKICAgICAgICAgICAgICAgIHBsb3QuaG9va3MuZHJhd092ZXJsYXkucHVzaChkcmF3T3ZlcmxheSk7CiAgICAgICAgICAgICAgICBwbG90Lmhvb2tzLnByb2Nlc3NEYXRhcG9pbnRzLnB1c2gocHJvY2Vzc0RhdGFwb2ludHMpOwogICAgICAgICAgICAgICAgcGxvdC5ob29rcy5zZXR1cEdyaWQucHVzaChzZXR1cEdyaWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsYXN0TW91c2VNb3ZlRXZlbnQgPSBwbG90LmdldFBsYWNlaG9sZGVyKClbMF0ubGFzdE1vdXNlTW92ZUV2ZW50OwogICAgICAgIH0KCiAgICAgICAgcGxvdC5ob29rcy5iaW5kRXZlbnRzLnB1c2goYmluZEV2ZW50cyk7CiAgICAgICAgcGxvdC5ob29rcy5zaHV0ZG93bi5wdXNoKHNodXRkb3duKTsKICAgICAgICBwbG90Lmhvb2tzLnByb2Nlc3NPcHRpb25zLnB1c2goaW5pdEhvdmVyKTsKICAgIH0KCiAgICAkLnBsb3QucGx1Z2lucy5wdXNoKHsKICAgICAgICBpbml0OiBpbml0LAogICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgbmFtZTogJ2hvdmVyJywKICAgICAgICB2ZXJzaW9uOiAnMC4xJwogICAgfSk7Cn0pKGpRdWVyeSk7Cg=="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,Ci8qIGdsb2JhbCBqUXVlcnkgKi8KCihmdW5jdGlvbigkKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgcHJvcGFnYXRlU3VwcG9ydGVkR2VzdHVyZTogZmFsc2UKICAgIH07CgogICAgZnVuY3Rpb24gaW5pdChwbG90KSB7CiAgICAgICAgcGxvdC5ob29rcy5wcm9jZXNzT3B0aW9ucy5wdXNoKGluaXRUb3VjaE5hdmlnYXRpb24pOwogICAgfQoKICAgIGZ1bmN0aW9uIGluaXRUb3VjaE5hdmlnYXRpb24ocGxvdCwgb3B0aW9ucykgewogICAgICAgIHZhciBnZXN0dXJlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICB0d29Ub3VjaGVzOiBmYWxzZSwKICAgICAgICAgICAgICAgIGN1cnJlbnRUYXBTdGFydDogeyB4OiAwLCB5OiAwIH0sCiAgICAgICAgICAgICAgICBjdXJyZW50VGFwRW5kOiB7IHg6IDAsIHk6IDAgfSwKICAgICAgICAgICAgICAgIHByZXZUYXA6IHsgeDogMCwgeTogMCB9LAogICAgICAgICAgICAgICAgY3VycmVudFRhcDogeyB4OiAwLCB5OiAwIH0sCiAgICAgICAgICAgICAgICBpbnRlcmNlcHRlZExvbmdUYXA6IGZhbHNlLAogICAgICAgICAgICAgICAgaXNVbnN1cHBvcnRlZEdlc3R1cmU6IGZhbHNlLAogICAgICAgICAgICAgICAgcHJldlRhcFRpbWU6IG51bGwsCiAgICAgICAgICAgICAgICB0YXBTdGFydFRpbWU6IG51bGwsCiAgICAgICAgICAgICAgICBsb25nVGFwVHJpZ2dlcklkOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1heERpc3RhbmNlQmV0d2VlblRhcHMgPSAyMCwKICAgICAgICAgICAgbWF4SW50ZXJ2YWxCZXR3ZWVuVGFwcyA9IDUwMCwKICAgICAgICAgICAgbWF4TG9uZ1RhcERpc3RhbmNlID0gMjAsCiAgICAgICAgICAgIG1pbkxvbmdUYXBEdXJhdGlvbiA9IDE1MDAsCiAgICAgICAgICAgIHByZXNzZWRUYXBEdXJhdGlvbiA9IDEyNSwKICAgICAgICAgICAgbWFpbkV2ZW50SG9sZGVyOwoKICAgICAgICBmdW5jdGlvbiBpbnRlcnByZXRHZXN0dXJlcyhlKSB7CiAgICAgICAgICAgIHZhciBvID0gcGxvdC5nZXRPcHRpb25zKCk7CgogICAgICAgICAgICBpZiAoIW8ucGFuLmFjdGl2ZSAmJiAhby56b29tLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB1cGRhdGVPbk11bHRpcGxlVG91Y2hlcyhlKTsKICAgICAgICAgICAgbWFpbkV2ZW50SG9sZGVyLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd0b3VjaGV2ZW50JywgeyBkZXRhaWw6IGUgfSkpOwoKICAgICAgICAgICAgaWYgKGlzUGluY2hFdmVudChlKSkgewogICAgICAgICAgICAgICAgZXhlY3V0ZUFjdGlvbihlLCAncGluY2gnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV4ZWN1dGVBY3Rpb24oZSwgJ3BhbicpOwogICAgICAgICAgICAgICAgaWYgKCF3YXNQaW5jaEV2ZW50KGUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRG91YmxlVGFwKGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dGVBY3Rpb24oZSwgJ2RvdWJsZVRhcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleGVjdXRlQWN0aW9uKGUsICd0YXAnKTsKICAgICAgICAgICAgICAgICAgICBleGVjdXRlQWN0aW9uKGUsICdsb25nVGFwJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVBY3Rpb24oZSwgZ2VzdHVyZSkgewogICAgICAgICAgICBzd2l0Y2ggKGdlc3R1cmUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ3Bhbic6CiAgICAgICAgICAgICAgICAgICAgcGFuW2UudHlwZV0oZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdwaW5jaCc6CiAgICAgICAgICAgICAgICAgICAgcGluY2hbZS50eXBlXShlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2RvdWJsZVRhcCc6CiAgICAgICAgICAgICAgICAgICAgZG91YmxlVGFwLm9uRG91YmxlVGFwKGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnbG9uZ1RhcCc6CiAgICAgICAgICAgICAgICAgICAgbG9uZ1RhcFtlLnR5cGVdKGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAndGFwJzoKICAgICAgICAgICAgICAgICAgICB0YXBbZS50eXBlXShlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmluZEV2ZW50cyhwbG90LCBldmVudEhvbGRlcikgewogICAgICAgICAgICBtYWluRXZlbnRIb2xkZXIgPSBldmVudEhvbGRlclswXTsKICAgICAgICAgICAgZXZlbnRIb2xkZXJbMF0uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGludGVycHJldEdlc3R1cmVzLCBmYWxzZSk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGludGVycHJldEdlc3R1cmVzLCBmYWxzZSk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaW50ZXJwcmV0R2VzdHVyZXMsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNodXRkb3duKHBsb3QsIGV2ZW50SG9sZGVyKSB7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBpbnRlcnByZXRHZXN0dXJlcyk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGludGVycHJldEdlc3R1cmVzKTsKICAgICAgICAgICAgZXZlbnRIb2xkZXJbMF0ucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBpbnRlcnByZXRHZXN0dXJlcyk7CiAgICAgICAgICAgIGlmIChnZXN0dXJlU3RhdGUubG9uZ1RhcFRyaWdnZXJJZCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGdlc3R1cmVTdGF0ZS5sb25nVGFwVHJpZ2dlcklkKTsKICAgICAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS5sb25nVGFwVHJpZ2dlcklkID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHBhbiA9IHsKICAgICAgICAgICAgdG91Y2hzdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdXBkYXRlUHJldkZvckRvdWJsZVRhcCgpOwogICAgICAgICAgICAgICAgdXBkYXRlQ3VycmVudEZvckRvdWJsZVRhcChlKTsKICAgICAgICAgICAgICAgIHVwZGF0ZVN0YXRlRm9yTG9uZ1RhcFN0YXJ0KGUpOwoKICAgICAgICAgICAgICAgIG1haW5FdmVudEhvbGRlci5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgncGFuc3RhcnQnLCB7IGRldGFpbDogZSB9KSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b3VjaG1vdmU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHByZXZlbnRFdmVudEJlaGF2aW9ycyhlKTsKCiAgICAgICAgICAgICAgICB1cGRhdGVDdXJyZW50Rm9yRG91YmxlVGFwKGUpOwogICAgICAgICAgICAgICAgdXBkYXRlU3RhdGVGb3JMb25nVGFwRW5kKGUpOwoKICAgICAgICAgICAgICAgIGlmICghZ2VzdHVyZVN0YXRlLmlzVW5zdXBwb3J0ZWRHZXN0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgbWFpbkV2ZW50SG9sZGVyLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdwYW5kcmFnJywgeyBkZXRhaWw6IGUgfSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG91Y2hlbmQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHByZXZlbnRFdmVudEJlaGF2aW9ycyhlKTsKCiAgICAgICAgICAgICAgICBpZiAod2FzUGluY2hFdmVudChlKSkgewogICAgICAgICAgICAgICAgICAgIG1haW5FdmVudEhvbGRlci5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgncGluY2hlbmQnLCB7IGRldGFpbDogZSB9KSk7CiAgICAgICAgICAgICAgICAgICAgbWFpbkV2ZW50SG9sZGVyLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdwYW5zdGFydCcsIHsgZGV0YWlsOiBlIH0pKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9Ub3VjaEFjdGl2ZShlKSkgewogICAgICAgICAgICAgICAgICAgIG1haW5FdmVudEhvbGRlci5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgncGFuZW5kJywgeyBkZXRhaWw6IGUgfSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHBpbmNoID0gewogICAgICAgICAgICB0b3VjaHN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBtYWluRXZlbnRIb2xkZXIuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3BpbmNoc3RhcnQnLCB7IGRldGFpbDogZSB9KSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b3VjaG1vdmU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHByZXZlbnRFdmVudEJlaGF2aW9ycyhlKTsKICAgICAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS50d29Ub3VjaGVzID0gaXNQaW5jaEV2ZW50KGUpOwogICAgICAgICAgICAgICAgaWYgKCFnZXN0dXJlU3RhdGUuaXNVbnN1cHBvcnRlZEdlc3R1cmUpIHsKICAgICAgICAgICAgICAgICAgICBtYWluRXZlbnRIb2xkZXIuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3BpbmNoZHJhZycsIHsgZGV0YWlsOiBlIH0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvdWNoZW5kOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBwcmV2ZW50RXZlbnRCZWhhdmlvcnMoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgZG91YmxlVGFwID0gewogICAgICAgICAgICBvbkRvdWJsZVRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcHJldmVudEV2ZW50QmVoYXZpb3JzKGUpOwogICAgICAgICAgICAgICAgbWFpbkV2ZW50SG9sZGVyLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdkb3VibGV0YXAnLCB7IGRldGFpbDogZSB9KSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgbG9uZ1RhcCA9IHsKICAgICAgICAgICAgdG91Y2hzdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgbG9uZ1RhcC53YWl0Rm9yTG9uZ1RhcChlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvdWNobW92ZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG91Y2hlbmQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmIChnZXN0dXJlU3RhdGUubG9uZ1RhcFRyaWdnZXJJZCkgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChnZXN0dXJlU3RhdGUubG9uZ1RhcFRyaWdnZXJJZCk7CiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLmxvbmdUYXBUcmlnZ2VySWQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXNMb25nVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgICAgICAgICAgICAgICAgICB0YXBEdXJhdGlvbiA9IGN1cnJlbnRUaW1lIC0gZ2VzdHVyZVN0YXRlLnRhcFN0YXJ0VGltZTsKICAgICAgICAgICAgICAgIGlmICh0YXBEdXJhdGlvbiA+PSBtaW5Mb25nVGFwRHVyYXRpb24gJiYgIWdlc3R1cmVTdGF0ZS5pbnRlcmNlcHRlZExvbmdUYXApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UoZ2VzdHVyZVN0YXRlLmN1cnJlbnRUYXBTdGFydC54LCBnZXN0dXJlU3RhdGUuY3VycmVudFRhcFN0YXJ0LnksIGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwRW5kLngsIGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwRW5kLnkpIDwgbWF4TG9uZ1RhcERpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS5pbnRlcmNlcHRlZExvbmdUYXAgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB3YWl0Rm9yTG9uZ1RhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIGxvbmdUYXBUcmlnZ2VyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvbmdUYXAuaXNMb25nVGFwKGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1haW5FdmVudEhvbGRlci5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnbG9uZ3RhcCcsIHsgZGV0YWlsOiBlIH0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLmxvbmdUYXBUcmlnZ2VySWQgPSBudWxsOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmICghZ2VzdHVyZVN0YXRlLmxvbmdUYXBUcmlnZ2VySWQpIHsKICAgICAgICAgICAgICAgICAgICBnZXN0dXJlU3RhdGUubG9uZ1RhcFRyaWdnZXJJZCA9IHNldFRpbWVvdXQobG9uZ1RhcFRyaWdnZXIsIG1pbkxvbmdUYXBEdXJhdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgdGFwID0gewogICAgICAgICAgICB0b3VjaHN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBnZXN0dXJlU3RhdGUudGFwU3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b3VjaG1vdmU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvdWNoZW5kOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAodGFwLmlzVGFwKGUpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFpbkV2ZW50SG9sZGVyLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd0YXAnLCB7IGRldGFpbDogZSB9KSk7CiAgICAgICAgICAgICAgICAgICAgcHJldmVudEV2ZW50QmVoYXZpb3JzKGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXNUYXA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgICAgICAgICAgICAgIHRhcER1cmF0aW9uID0gY3VycmVudFRpbWUgLSBnZXN0dXJlU3RhdGUudGFwU3RhcnRUaW1lOwogICAgICAgICAgICAgICAgaWYgKHRhcER1cmF0aW9uIDw9IHByZXNzZWRUYXBEdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0YW5jZShnZXN0dXJlU3RhdGUuY3VycmVudFRhcFN0YXJ0LngsIGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwU3RhcnQueSwgZ2VzdHVyZVN0YXRlLmN1cnJlbnRUYXBFbmQueCwgZ2VzdHVyZVN0YXRlLmN1cnJlbnRUYXBFbmQueSkgPCBtYXhMb25nVGFwRGlzdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9wdGlvbnMucGFuLmVuYWJsZVRvdWNoID09PSB0cnVlIHx8IG9wdGlvbnMuem9vbS5lbmFibGVUb3VjaCkgewogICAgICAgICAgICBwbG90Lmhvb2tzLmJpbmRFdmVudHMucHVzaChiaW5kRXZlbnRzKTsKICAgICAgICAgICAgcGxvdC5ob29rcy5zaHV0ZG93bi5wdXNoKHNodXRkb3duKTsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVQcmV2Rm9yRG91YmxlVGFwKCkgewogICAgICAgICAgICBnZXN0dXJlU3RhdGUucHJldlRhcCA9IHsKICAgICAgICAgICAgICAgIHg6IGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwLngsCiAgICAgICAgICAgICAgICB5OiBnZXN0dXJlU3RhdGUuY3VycmVudFRhcC55CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ3VycmVudEZvckRvdWJsZVRhcChlKSB7CiAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwID0gewogICAgICAgICAgICAgICAgeDogZS50b3VjaGVzWzBdLnBhZ2VYLAogICAgICAgICAgICAgICAgeTogZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdGF0ZUZvckxvbmdUYXBTdGFydChlKSB7CiAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS50YXBTdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLmludGVyY2VwdGVkTG9uZ1RhcCA9IGZhbHNlOwogICAgICAgICAgICBnZXN0dXJlU3RhdGUuY3VycmVudFRhcFN0YXJ0ID0gewogICAgICAgICAgICAgICAgeDogZS50b3VjaGVzWzBdLnBhZ2VYLAogICAgICAgICAgICAgICAgeTogZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwRW5kID0gewogICAgICAgICAgICAgICAgeDogZS50b3VjaGVzWzBdLnBhZ2VYLAogICAgICAgICAgICAgICAgeTogZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RhdGVGb3JMb25nVGFwRW5kKGUpIHsKICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLmN1cnJlbnRUYXBFbmQgPSB7CiAgICAgICAgICAgICAgICB4OiBlLnRvdWNoZXNbMF0ucGFnZVgsCiAgICAgICAgICAgICAgICB5OiBlLnRvdWNoZXNbMF0ucGFnZVkKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBpc0RvdWJsZVRhcChlKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgICAgICAgICAgaW50ZXJ2YWxCZXR3ZWVuVGFwcyA9IGN1cnJlbnRUaW1lIC0gZ2VzdHVyZVN0YXRlLnByZXZUYXBUaW1lOwoKICAgICAgICAgICAgaWYgKGludGVydmFsQmV0d2VlblRhcHMgPj0gMCAmJiBpbnRlcnZhbEJldHdlZW5UYXBzIDwgbWF4SW50ZXJ2YWxCZXR3ZWVuVGFwcykgewogICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlKGdlc3R1cmVTdGF0ZS5wcmV2VGFwLngsIGdlc3R1cmVTdGF0ZS5wcmV2VGFwLnksIGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwLngsIGdlc3R1cmVTdGF0ZS5jdXJyZW50VGFwLnkpIDwgbWF4RGlzdGFuY2VCZXR3ZWVuVGFwcykgewogICAgICAgICAgICAgICAgICAgIGUuZmlyc3RUb3VjaCA9IGdlc3R1cmVTdGF0ZS5wcmV2VGFwOwogICAgICAgICAgICAgICAgICAgIGUuc2Vjb25kVG91Y2ggPSBnZXN0dXJlU3RhdGUuY3VycmVudFRhcDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBnZXN0dXJlU3RhdGUucHJldlRhcFRpbWUgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHJldmVudEV2ZW50QmVoYXZpb3JzKGUpIHsKICAgICAgICAgICAgaWYgKCFnZXN0dXJlU3RhdGUuaXNVbnN1cHBvcnRlZEdlc3R1cmUpIHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGlmICghcGxvdC5nZXRPcHRpb25zKCkucHJvcGFnYXRlU3VwcG9ydGVkR2VzdHVyZSkgewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRpc3RhbmNlKHgxLCB5MSwgeDIsIHkyKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLnNxcnQoKHgxIC0geDIpICogKHgxIC0geDIpICsgKHkxIC0geTIpICogKHkxIC0geTIpKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG5vVG91Y2hBY3RpdmUoZSkgewogICAgICAgICAgICByZXR1cm4gKGUudG91Y2hlcyAmJiBlLnRvdWNoZXMubGVuZ3RoID09PSAwKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdhc1BpbmNoRXZlbnQoZSkgewogICAgICAgICAgICByZXR1cm4gKGdlc3R1cmVTdGF0ZS50d29Ub3VjaGVzICYmIGUudG91Y2hlcy5sZW5ndGggPT09IDEpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlT25NdWx0aXBsZVRvdWNoZXMoZSkgewogICAgICAgICAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAgICAgICBnZXN0dXJlU3RhdGUuaXNVbnN1cHBvcnRlZEdlc3R1cmUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLmlzVW5zdXBwb3J0ZWRHZXN0dXJlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzUGluY2hFdmVudChlKSB7CiAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgZS50b3VjaGVzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzWzBdLnRhcmdldCA9PT0gcGxvdC5nZXRFdmVudEhvbGRlcigpICYmCiAgICAgICAgICAgICAgICAgICAgZS50b3VjaGVzWzFdLnRhcmdldCA9PT0gcGxvdC5nZXRFdmVudEhvbGRlcigpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAkLnBsb3QucGx1Z2lucy5wdXNoKHsKICAgICAgICBpbml0OiBpbml0LAogICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgbmFtZTogJ25hdmlnYXRlVG91Y2gnLAogICAgICAgIHZlcnNpb246ICcwLjMnCiAgICB9KTsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogZ2xvYmFsIGpRdWVyeSAqLwoKKGZ1bmN0aW9uKCQpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICB6b29tOiB7CiAgICAgICAgICAgIGVuYWJsZVRvdWNoOiBmYWxzZQogICAgICAgIH0sCiAgICAgICAgcGFuOiB7CiAgICAgICAgICAgIGVuYWJsZVRvdWNoOiBmYWxzZSwKICAgICAgICAgICAgdG91Y2hNb2RlOiAnbWFudWFsJwogICAgICAgIH0sCiAgICAgICAgcmVjZW50ZXI6IHsKICAgICAgICAgICAgZW5hYmxlVG91Y2g6IHRydWUKICAgICAgICB9CiAgICB9OwoKICAgIHZhciBaT09NX0RJU1RBTkNFX01BUkdJTiA9ICQucGxvdC51aUNvbnN0YW50cy5aT09NX0RJU1RBTkNFX01BUkdJTjsKCiAgICBmdW5jdGlvbiBpbml0KHBsb3QpIHsKICAgICAgICBwbG90Lmhvb2tzLnByb2Nlc3NPcHRpb25zLnB1c2goaW5pdFRvdWNoTmF2aWdhdGlvbik7CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdFRvdWNoTmF2aWdhdGlvbihwbG90LCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGdlc3R1cmVTdGF0ZSA9IHsKICAgICAgICAgICAgICAgIHpvb21FbmFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgcHJldkRpc3RhbmNlOiBudWxsLAogICAgICAgICAgICAgICAgcHJldlRhcFRpbWU6IDAsCiAgICAgICAgICAgICAgICBwcmV2UGFuUG9zaXRpb246IHsgeDogMCwgeTogMCB9LAogICAgICAgICAgICAgICAgcHJldlRhcFBvc2l0aW9uOiB7IHg6IDAsIHk6IDAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBuYXZpZ2F0aW9uU3RhdGUgPSB7CiAgICAgICAgICAgICAgICBwcmV2VG91Y2hlZEF4aXM6ICdub25lJywKICAgICAgICAgICAgICAgIGN1cnJlbnRUb3VjaGVkQXhpczogJ25vbmUnLAogICAgICAgICAgICAgICAgdG91Y2hlZEF4aXM6IG51bGwsCiAgICAgICAgICAgICAgICBuYXZpZ2F0aW9uQ29uc3RyYWludDogJ3VuY29uc3RyYWluZWQnLAogICAgICAgICAgICAgICAgaW5pdGlhbFN0YXRlOiBudWxsLAogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNYW51YWxQYW4gPSBvcHRpb25zLnBhbi5pbnRlcmFjdGl2ZSAmJiBvcHRpb25zLnBhbi50b3VjaE1vZGUgPT09ICdtYW51YWwnLAogICAgICAgICAgICBzbWFydFBhbkxvY2sgPSBvcHRpb25zLnBhbi50b3VjaE1vZGUgPT09ICdzbWFydExvY2snLAogICAgICAgICAgICB1c2VTbWFydFBhbiA9IG9wdGlvbnMucGFuLmludGVyYWN0aXZlICYmIChzbWFydFBhbkxvY2sgfHwgb3B0aW9ucy5wYW4udG91Y2hNb2RlID09PSAnc21hcnQnKSwKICAgICAgICAgICAgcGFuLCBwaW5jaCwgZG91YmxlVGFwOwoKICAgICAgICBmdW5jdGlvbiBiaW5kRXZlbnRzKHBsb3QsIGV2ZW50SG9sZGVyKSB7CiAgICAgICAgICAgIHZhciBvID0gcGxvdC5nZXRPcHRpb25zKCk7CgogICAgICAgICAgICBpZiAoby56b29tLmludGVyYWN0aXZlICYmIG8uem9vbS5lbmFibGVUb3VjaCkgewogICAgICAgICAgICAgICAgZXZlbnRIb2xkZXJbMF0uYWRkRXZlbnRMaXN0ZW5lcigncGluY2hzdGFydCcsIHBpbmNoLnN0YXJ0LCBmYWxzZSk7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlclswXS5hZGRFdmVudExpc3RlbmVyKCdwaW5jaGRyYWcnLCBwaW5jaC5kcmFnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlclswXS5hZGRFdmVudExpc3RlbmVyKCdwaW5jaGVuZCcsIHBpbmNoLmVuZCwgZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoby5wYW4uaW50ZXJhY3RpdmUgJiYgby5wYW4uZW5hYmxlVG91Y2gpIHsKICAgICAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLmFkZEV2ZW50TGlzdGVuZXIoJ3BhbnN0YXJ0JywgcGFuLnN0YXJ0LCBmYWxzZSk7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlclswXS5hZGRFdmVudExpc3RlbmVyKCdwYW5kcmFnJywgcGFuLmRyYWcsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLmFkZEV2ZW50TGlzdGVuZXIoJ3BhbmVuZCcsIHBhbi5lbmQsIGZhbHNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKChvLnJlY2VudGVyLmludGVyYWN0aXZlICYmIG8ucmVjZW50ZXIuZW5hYmxlVG91Y2gpKSB7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlclswXS5hZGRFdmVudExpc3RlbmVyKCdkb3VibGV0YXAnLCBkb3VibGVUYXAucmVjZW50ZXJQbG90LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNodXRkb3duKHBsb3QsIGV2ZW50SG9sZGVyKSB7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BhbnN0YXJ0JywgcGFuLnN0YXJ0KTsKICAgICAgICAgICAgZXZlbnRIb2xkZXJbMF0ucmVtb3ZlRXZlbnRMaXN0ZW5lcigncGFuZHJhZycsIHBhbi5kcmFnKTsKICAgICAgICAgICAgZXZlbnRIb2xkZXJbMF0ucmVtb3ZlRXZlbnRMaXN0ZW5lcigncGFuZW5kJywgcGFuLmVuZCk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BpbmNoc3RhcnQnLCBwaW5jaC5zdGFydCk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BpbmNoZHJhZycsIHBpbmNoLmRyYWcpOwogICAgICAgICAgICBldmVudEhvbGRlclswXS5yZW1vdmVFdmVudExpc3RlbmVyKCdwaW5jaGVuZCcsIHBpbmNoLmVuZCk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyWzBdLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2RvdWJsZXRhcCcsIGRvdWJsZVRhcC5yZWNlbnRlclBsb3QpOwogICAgICAgIH0KCiAgICAgICAgcGFuID0gewogICAgICAgICAgICBzdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcHJlc2V0TmF2aWdhdGlvblN0YXRlKGUsICdwYW4nLCBnZXN0dXJlU3RhdGUpOwogICAgICAgICAgICAgICAgdXBkYXRlRGF0YShlLCAncGFuJywgZ2VzdHVyZVN0YXRlLCBuYXZpZ2F0aW9uU3RhdGUpOwoKICAgICAgICAgICAgICAgIGlmICh1c2VTbWFydFBhbikgewogICAgICAgICAgICAgICAgICAgIHZhciBwb2ludCA9IGdldFBvaW50KGUsICdwYW4nKTsKICAgICAgICAgICAgICAgICAgICBuYXZpZ2F0aW9uU3RhdGUuaW5pdGlhbFN0YXRlID0gcGxvdC5uYXZpZ2F0aW9uU3RhdGUocG9pbnQueCwgcG9pbnQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBkcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBwcmVzZXROYXZpZ2F0aW9uU3RhdGUoZSwgJ3BhbicsIGdlc3R1cmVTdGF0ZSk7CgogICAgICAgICAgICAgICAgaWYgKHVzZVNtYXJ0UGFuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBvaW50ID0gZ2V0UG9pbnQoZSwgJ3BhbicpOwogICAgICAgICAgICAgICAgICAgIHBsb3Quc21hcnRQYW4oewogICAgICAgICAgICAgICAgICAgICAgICB4OiBuYXZpZ2F0aW9uU3RhdGUuaW5pdGlhbFN0YXRlLnN0YXJ0UGFnZVggLSBwb2ludC54LAogICAgICAgICAgICAgICAgICAgICAgICB5OiBuYXZpZ2F0aW9uU3RhdGUuaW5pdGlhbFN0YXRlLnN0YXJ0UGFnZVkgLSBwb2ludC55CiAgICAgICAgICAgICAgICAgICAgfSwgbmF2aWdhdGlvblN0YXRlLmluaXRpYWxTdGF0ZSwgbmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzLCBmYWxzZSwgc21hcnRQYW5Mb2NrKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlTWFudWFsUGFuKSB7CiAgICAgICAgICAgICAgICAgICAgcGxvdC5wYW4oewogICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiAtZGVsdGEoZSwgJ3BhbicsIGdlc3R1cmVTdGF0ZSkueCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAtZGVsdGEoZSwgJ3BhbicsIGdlc3R1cmVTdGF0ZSkueSwKICAgICAgICAgICAgICAgICAgICAgICAgYXhlczogbmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUHJldlBhblBvc2l0aW9uKGUsICdwYW4nLCBnZXN0dXJlU3RhdGUsIG5hdmlnYXRpb25TdGF0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlbmQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHByZXNldE5hdmlnYXRpb25TdGF0ZShlLCAncGFuJywgZ2VzdHVyZVN0YXRlKTsKCiAgICAgICAgICAgICAgICBpZiAodXNlU21hcnRQYW4pIHsKICAgICAgICAgICAgICAgICAgICBwbG90LnNtYXJ0UGFuLmVuZCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh3YXNQaW5jaEV2ZW50KGUsIGdlc3R1cmVTdGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVwcmV2UGFuUG9zaXRpb24oZSwgJ3BhbicsIGdlc3R1cmVTdGF0ZSwgbmF2aWdhdGlvblN0YXRlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBwaW5jaERyYWdUaW1lb3V0OwogICAgICAgIHBpbmNoID0gewogICAgICAgICAgICBzdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYgKHBpbmNoRHJhZ1RpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocGluY2hEcmFnVGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgcGluY2hEcmFnVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmVzZXROYXZpZ2F0aW9uU3RhdGUoZSwgJ3BpbmNoJywgZ2VzdHVyZVN0YXRlKTsKICAgICAgICAgICAgICAgIHNldFByZXZEaXN0YW5jZShlLCBnZXN0dXJlU3RhdGUpOwogICAgICAgICAgICAgICAgdXBkYXRlRGF0YShlLCAncGluY2gnLCBnZXN0dXJlU3RhdGUsIG5hdmlnYXRpb25TdGF0ZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBkcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAocGluY2hEcmFnVGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpbmNoRHJhZ1RpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHByZXNldE5hdmlnYXRpb25TdGF0ZShlLCAncGluY2gnLCBnZXN0dXJlU3RhdGUpOwogICAgICAgICAgICAgICAgICAgIHBsb3QucGFuKHsKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogLWRlbHRhKGUsICdwaW5jaCcsIGdlc3R1cmVTdGF0ZSkueCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAtZGVsdGEoZSwgJ3BpbmNoJywgZ2VzdHVyZVN0YXRlKS55LAogICAgICAgICAgICAgICAgICAgICAgICBheGVzOiBuYXZpZ2F0aW9uU3RhdGUudG91Y2hlZEF4aXMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVQcmV2UGFuUG9zaXRpb24oZSwgJ3BpbmNoJywgZ2VzdHVyZVN0YXRlLCBuYXZpZ2F0aW9uU3RhdGUpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlzdCA9IHBpbmNoRGlzdGFuY2UoZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChnZXN0dXJlU3RhdGUuem9vbUVuYWJsZSB8fCBNYXRoLmFicyhkaXN0IC0gZ2VzdHVyZVN0YXRlLnByZXZEaXN0YW5jZSkgPiBaT09NX0RJU1RBTkNFX01BUkdJTikgewogICAgICAgICAgICAgICAgICAgICAgICB6b29tUGxvdChwbG90LCBlLCBnZXN0dXJlU3RhdGUsIG5hdmlnYXRpb25TdGF0ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvL2FjdGl2YXRlIHpvb20gbW9kZQogICAgICAgICAgICAgICAgICAgICAgICBnZXN0dXJlU3RhdGUuem9vbUVuYWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBpbmNoRHJhZ1RpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgfSwgMTAwMCAvIDYwKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGVuZDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYgKHBpbmNoRHJhZ1RpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocGluY2hEcmFnVGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgcGluY2hEcmFnVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmVzZXROYXZpZ2F0aW9uU3RhdGUoZSwgJ3BpbmNoJywgZ2VzdHVyZVN0YXRlKTsKICAgICAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS5wcmV2RGlzdGFuY2UgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZG91YmxlVGFwID0gewogICAgICAgICAgICByZWNlbnRlclBsb3Q6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmIChlICYmIGUuZGV0YWlsICYmIGUuZGV0YWlsLnR5cGUgPT09ICd0b3VjaHN0YXJ0JykgewogICAgICAgICAgICAgICAgICAgIC8vIG9ubHkgZG8gbm90IHJlY2VudGVyIGZvciB0b3VjaCBzdGFydDsKICAgICAgICAgICAgICAgICAgICByZWNlbnRlclBsb3RPbkRvdWJsZVRhcChwbG90LCBlLCBnZXN0dXJlU3RhdGUsIG5hdmlnYXRpb25TdGF0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAob3B0aW9ucy5wYW4uZW5hYmxlVG91Y2ggPT09IHRydWUgfHwgb3B0aW9ucy56b29tLmVuYWJsZVRvdWNoID09PSB0cnVlKSB7CiAgICAgICAgICAgIHBsb3QuaG9va3MuYmluZEV2ZW50cy5wdXNoKGJpbmRFdmVudHMpOwogICAgICAgICAgICBwbG90Lmhvb2tzLnNodXRkb3duLnB1c2goc2h1dGRvd24pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHJlc2V0TmF2aWdhdGlvblN0YXRlKGUsIGdlc3R1cmUsIGdlc3R1cmVTdGF0ZSkgewogICAgICAgICAgICBuYXZpZ2F0aW9uU3RhdGUudG91Y2hlZEF4aXMgPSBnZXRBeGlzKHBsb3QsIGUsIGdlc3R1cmUsIG5hdmlnYXRpb25TdGF0ZSk7CiAgICAgICAgICAgIGlmIChub0F4aXNUb3VjaGVkKG5hdmlnYXRpb25TdGF0ZSkpIHsKICAgICAgICAgICAgICAgIG5hdmlnYXRpb25TdGF0ZS5uYXZpZ2F0aW9uQ29uc3RyYWludCA9ICd1bmNvbnN0cmFpbmVkJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hdmlnYXRpb25TdGF0ZS5uYXZpZ2F0aW9uQ29uc3RyYWludCA9ICdheGlzQ29uc3RyYWluZWQnOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgICQucGxvdC5wbHVnaW5zLnB1c2goewogICAgICAgIGluaXQ6IGluaXQsCiAgICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgICBuYW1lOiAnbmF2aWdhdGVUb3VjaCcsCiAgICAgICAgdmVyc2lvbjogJzAuMycKICAgIH0pOwoKICAgIGZ1bmN0aW9uIHJlY2VudGVyUGxvdE9uRG91YmxlVGFwKHBsb3QsIGUsIGdlc3R1cmVTdGF0ZSwgbmF2aWdhdGlvblN0YXRlKSB7CiAgICAgICAgY2hlY2tBeGVzRm9yRG91YmxlVGFwKHBsb3QsIGUsIG5hdmlnYXRpb25TdGF0ZSk7CiAgICAgICAgaWYgKChuYXZpZ2F0aW9uU3RhdGUuY3VycmVudFRvdWNoZWRBeGlzID09PSAneCcgJiYgbmF2aWdhdGlvblN0YXRlLnByZXZUb3VjaGVkQXhpcyA9PT0gJ3gnKSB8fAogICAgICAgICAgICAobmF2aWdhdGlvblN0YXRlLmN1cnJlbnRUb3VjaGVkQXhpcyA9PT0gJ3knICYmIG5hdmlnYXRpb25TdGF0ZS5wcmV2VG91Y2hlZEF4aXMgPT09ICd5JykgfHwKICAgICAgICAgICAgKG5hdmlnYXRpb25TdGF0ZS5jdXJyZW50VG91Y2hlZEF4aXMgPT09ICdub25lJyAmJiBuYXZpZ2F0aW9uU3RhdGUucHJldlRvdWNoZWRBeGlzID09PSAnbm9uZScpKSB7CiAgICAgICAgICAgIHZhciBldmVudDsKCiAgICAgICAgICAgIHBsb3QucmVjZW50ZXIoeyBheGVzOiBuYXZpZ2F0aW9uU3RhdGUudG91Y2hlZEF4aXMgfSk7CgogICAgICAgICAgICBpZiAobmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzKSB7CiAgICAgICAgICAgICAgICBldmVudCA9IG5ldyAkLkV2ZW50KCdyZS1jZW50ZXInLCB7IGRldGFpbDogeyBheGlzVG91Y2hlZDogbmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzIH0gfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldmVudCA9IG5ldyAkLkV2ZW50KCdyZS1jZW50ZXInLCB7IGRldGFpbDogZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwbG90LmdldFBsYWNlaG9sZGVyKCkudHJpZ2dlcihldmVudCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrQXhlc0ZvckRvdWJsZVRhcChwbG90LCBlLCBuYXZpZ2F0aW9uU3RhdGUpIHsKICAgICAgICB2YXIgYXhpcyA9IHBsb3QuZ2V0VG91Y2hlZEF4aXMoZS5kZXRhaWwuZmlyc3RUb3VjaC54LCBlLmRldGFpbC5maXJzdFRvdWNoLnkpOwogICAgICAgIGlmIChheGlzWzBdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgbmF2aWdhdGlvblN0YXRlLnByZXZUb3VjaGVkQXhpcyA9IGF4aXNbMF0uZGlyZWN0aW9uOwogICAgICAgIH0KCiAgICAgICAgYXhpcyA9IHBsb3QuZ2V0VG91Y2hlZEF4aXMoZS5kZXRhaWwuc2Vjb25kVG91Y2gueCwgZS5kZXRhaWwuc2Vjb25kVG91Y2gueSk7CiAgICAgICAgaWYgKGF4aXNbMF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBuYXZpZ2F0aW9uU3RhdGUudG91Y2hlZEF4aXMgPSBheGlzOwogICAgICAgICAgICBuYXZpZ2F0aW9uU3RhdGUuY3VycmVudFRvdWNoZWRBeGlzID0gYXhpc1swXS5kaXJlY3Rpb247CiAgICAgICAgfQoKICAgICAgICBpZiAobm9BeGlzVG91Y2hlZChuYXZpZ2F0aW9uU3RhdGUpKSB7CiAgICAgICAgICAgIG5hdmlnYXRpb25TdGF0ZS50b3VjaGVkQXhpcyA9IG51bGw7CiAgICAgICAgICAgIG5hdmlnYXRpb25TdGF0ZS5wcmV2VG91Y2hlZEF4aXMgPSAnbm9uZSc7CiAgICAgICAgICAgIG5hdmlnYXRpb25TdGF0ZS5jdXJyZW50VG91Y2hlZEF4aXMgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHpvb21QbG90KHBsb3QsIGUsIGdlc3R1cmVTdGF0ZSwgbmF2aWdhdGlvblN0YXRlKSB7CiAgICAgICAgdmFyIG9mZnNldCA9IHBsb3Qub2Zmc2V0KCksCiAgICAgICAgICAgIGNlbnRlciA9IHsKICAgICAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgICAgICB0b3A6IDAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgem9vbUFtb3VudCA9IHBpbmNoRGlzdGFuY2UoZSkgLyBnZXN0dXJlU3RhdGUucHJldkRpc3RhbmNlLAogICAgICAgICAgICBkaXN0ID0gcGluY2hEaXN0YW5jZShlKTsKCiAgICAgICAgY2VudGVyLmxlZnQgPSBnZXRQb2ludChlLCAncGluY2gnKS54IC0gb2Zmc2V0LmxlZnQ7CiAgICAgICAgY2VudGVyLnRvcCA9IGdldFBvaW50KGUsICdwaW5jaCcpLnkgLSBvZmZzZXQudG9wOwoKICAgICAgICAvLyBzZW5kIHRoZSBjb21wdXRlZCB0b3VjaGVkIGF4aXMgdG8gdGhlIHpvb20gZnVuY3Rpb24gc28gdGhhdCBpdCBvbmx5IHpvb21zIG9uIHRoYXQgb25lCiAgICAgICAgcGxvdC56b29tKHsKICAgICAgICAgICAgY2VudGVyOiBjZW50ZXIsCiAgICAgICAgICAgIGFtb3VudDogem9vbUFtb3VudCwKICAgICAgICAgICAgYXhlczogbmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzCiAgICAgICAgfSk7CiAgICAgICAgZ2VzdHVyZVN0YXRlLnByZXZEaXN0YW5jZSA9IGRpc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gd2FzUGluY2hFdmVudChlLCBnZXN0dXJlU3RhdGUpIHsKICAgICAgICByZXR1cm4gKGdlc3R1cmVTdGF0ZS56b29tRW5hYmxlICYmIGUuZGV0YWlsLnRvdWNoZXMubGVuZ3RoID09PSAxKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRBeGlzKHBsb3QsIGUsIGdlc3R1cmUsIG5hdmlnYXRpb25TdGF0ZSkgewogICAgICAgIGlmIChlLnR5cGUgPT09ICdwaW5jaHN0YXJ0JykgewogICAgICAgICAgICB2YXIgYXhpc1RvdWNoMSA9IHBsb3QuZ2V0VG91Y2hlZEF4aXMoZS5kZXRhaWwudG91Y2hlc1swXS5wYWdlWCwgZS5kZXRhaWwudG91Y2hlc1swXS5wYWdlWSk7CiAgICAgICAgICAgIHZhciBheGlzVG91Y2gyID0gcGxvdC5nZXRUb3VjaGVkQXhpcyhlLmRldGFpbC50b3VjaGVzWzFdLnBhZ2VYLCBlLmRldGFpbC50b3VjaGVzWzFdLnBhZ2VZKTsKCiAgICAgICAgICAgIGlmIChheGlzVG91Y2gxLmxlbmd0aCA9PT0gYXhpc1RvdWNoMi5sZW5ndGggJiYgYXhpc1RvdWNoMS50b1N0cmluZygpID09PSBheGlzVG91Y2gyLnRvU3RyaW5nKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBheGlzVG91Y2gxOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChlLnR5cGUgPT09ICdwYW5zdGFydCcpIHsKICAgICAgICAgICAgcmV0dXJuIHBsb3QuZ2V0VG91Y2hlZEF4aXMoZS5kZXRhaWwudG91Y2hlc1swXS5wYWdlWCwgZS5kZXRhaWwudG91Y2hlc1swXS5wYWdlWSk7CiAgICAgICAgfSBlbHNlIGlmIChlLnR5cGUgPT09ICdwaW5jaGVuZCcpIHsKICAgICAgICAgICAgLy91cGRhdGUgYXhpcyBzaW5jZSBpbnN0ZWFkIG9uIHBpbmNoLCBhIHBhbiBldmVudCBpcyBtYWRlCiAgICAgICAgICAgIHJldHVybiBwbG90LmdldFRvdWNoZWRBeGlzKGUuZGV0YWlsLnRvdWNoZXNbMF0ucGFnZVgsIGUuZGV0YWlsLnRvdWNoZXNbMF0ucGFnZVkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBuYXZpZ2F0aW9uU3RhdGUudG91Y2hlZEF4aXM7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG5vQXhpc1RvdWNoZWQobmF2aWdhdGlvblN0YXRlKSB7CiAgICAgICAgcmV0dXJuICghbmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzIHx8IG5hdmlnYXRpb25TdGF0ZS50b3VjaGVkQXhpcy5sZW5ndGggPT09IDApOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFByZXZEaXN0YW5jZShlLCBnZXN0dXJlU3RhdGUpIHsKICAgICAgICBnZXN0dXJlU3RhdGUucHJldkRpc3RhbmNlID0gcGluY2hEaXN0YW5jZShlKTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVEYXRhKGUsIGdlc3R1cmUsIGdlc3R1cmVTdGF0ZSwgbmF2aWdhdGlvblN0YXRlKSB7CiAgICAgICAgdmFyIGF4aXNEaXIsCiAgICAgICAgICAgIHBvaW50ID0gZ2V0UG9pbnQoZSwgZ2VzdHVyZSk7CgogICAgICAgIHN3aXRjaCAobmF2aWdhdGlvblN0YXRlLm5hdmlnYXRpb25Db25zdHJhaW50KSB7CiAgICAgICAgICAgIGNhc2UgJ3VuY29uc3RyYWluZWQnOgogICAgICAgICAgICAgICAgbmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzID0gbnVsbDsKICAgICAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS5wcmV2VGFwUG9zaXRpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgeDogZ2VzdHVyZVN0YXRlLnByZXZQYW5Qb3NpdGlvbi54LAogICAgICAgICAgICAgICAgICAgIHk6IGdlc3R1cmVTdGF0ZS5wcmV2UGFuUG9zaXRpb24ueQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGdlc3R1cmVTdGF0ZS5wcmV2UGFuUG9zaXRpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgeDogcG9pbnQueCwKICAgICAgICAgICAgICAgICAgICB5OiBwb2ludC55CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2F4aXNDb25zdHJhaW5lZCc6CiAgICAgICAgICAgICAgICBheGlzRGlyID0gbmF2aWdhdGlvblN0YXRlLnRvdWNoZWRBeGlzWzBdLmRpcmVjdGlvbjsKICAgICAgICAgICAgICAgIG5hdmlnYXRpb25TdGF0ZS5jdXJyZW50VG91Y2hlZEF4aXMgPSBheGlzRGlyOwogICAgICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLnByZXZUYXBQb3NpdGlvbltheGlzRGlyXSA9IGdlc3R1cmVTdGF0ZS5wcmV2UGFuUG9zaXRpb25bYXhpc0Rpcl07CiAgICAgICAgICAgICAgICBnZXN0dXJlU3RhdGUucHJldlBhblBvc2l0aW9uW2F4aXNEaXJdID0gcG9pbnRbYXhpc0Rpcl07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkaXN0YW5jZSh4MSwgeTEsIHgyLCB5MikgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoKHgxIC0geDIpICogKHgxIC0geDIpICsgKHkxIC0geTIpICogKHkxIC0geTIpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwaW5jaERpc3RhbmNlKGUpIHsKICAgICAgICB2YXIgdDEgPSBlLmRldGFpbC50b3VjaGVzWzBdLAogICAgICAgICAgICB0MiA9IGUuZGV0YWlsLnRvdWNoZXNbMV07CiAgICAgICAgcmV0dXJuIGRpc3RhbmNlKHQxLnBhZ2VYLCB0MS5wYWdlWSwgdDIucGFnZVgsIHQyLnBhZ2VZKTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVQcmV2UGFuUG9zaXRpb24oZSwgZ2VzdHVyZSwgZ2VzdHVyZVN0YXRlLCBuYXZpZ2F0aW9uU3RhdGUpIHsKICAgICAgICB2YXIgcG9pbnQgPSBnZXRQb2ludChlLCBnZXN0dXJlKTsKCiAgICAgICAgc3dpdGNoIChuYXZpZ2F0aW9uU3RhdGUubmF2aWdhdGlvbkNvbnN0cmFpbnQpIHsKICAgICAgICAgICAgY2FzZSAndW5jb25zdHJhaW5lZCc6CiAgICAgICAgICAgICAgICBnZXN0dXJlU3RhdGUucHJldlBhblBvc2l0aW9uLnggPSBwb2ludC54OwogICAgICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLnByZXZQYW5Qb3NpdGlvbi55ID0gcG9pbnQueTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdheGlzQ29uc3RyYWluZWQnOgogICAgICAgICAgICAgICAgZ2VzdHVyZVN0YXRlLnByZXZQYW5Qb3NpdGlvbltuYXZpZ2F0aW9uU3RhdGUuY3VycmVudFRvdWNoZWRBeGlzXSA9CiAgICAgICAgICAgICAgICBwb2ludFtuYXZpZ2F0aW9uU3RhdGUuY3VycmVudFRvdWNoZWRBeGlzXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRlbHRhKGUsIGdlc3R1cmUsIGdlc3R1cmVTdGF0ZSkgewogICAgICAgIHZhciBwb2ludCA9IGdldFBvaW50KGUsIGdlc3R1cmUpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBwb2ludC54IC0gZ2VzdHVyZVN0YXRlLnByZXZQYW5Qb3NpdGlvbi54LAogICAgICAgICAgICB5OiBwb2ludC55IC0gZ2VzdHVyZVN0YXRlLnByZXZQYW5Qb3NpdGlvbi55CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldFBvaW50KGUsIGdlc3R1cmUpIHsKICAgICAgICBpZiAoZ2VzdHVyZSA9PT0gJ3BpbmNoJykgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgeDogKGUuZGV0YWlsLnRvdWNoZXNbMF0ucGFnZVggKyBlLmRldGFpbC50b3VjaGVzWzFdLnBhZ2VYKSAvIDIsCiAgICAgICAgICAgICAgICB5OiAoZS5kZXRhaWwudG91Y2hlc1swXS5wYWdlWSArIGUuZGV0YWlsLnRvdWNoZXNbMV0ucGFnZVkpIC8gMgogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHg6IGUuZGV0YWlsLnRvdWNoZXNbMF0ucGFnZVgsCiAgICAgICAgICAgICAgICB5OiBlLmRldGFpbC50b3VjaGVzWzBdLnBhZ2VZCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0pKGpRdWVyeSk7Cg=="></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogRmxvdCBwbHVnaW4gZm9yIHNlbGVjdGluZyByZWdpb25zIG9mIGEgcGxvdC4KCkNvcHlyaWdodCAoYykgMjAwNy0yMDE0IElPTEEgYW5kIE9sZSBMYXVyc2VuLgpMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgpUaGUgcGx1Z2luIHN1cHBvcnRzIHRoZXNlIG9wdGlvbnM6CgpzZWxlY3Rpb246IHsKICAgIG1vZGU6IG51bGwgb3IgIngiIG9yICJ5IiBvciAieHkiIG9yICJzbWFydCIsCiAgICBjb2xvcjogY29sb3IsCiAgICBzaGFwZTogInJvdW5kIiBvciAibWl0ZXIiIG9yICJiZXZlbCIsCiAgICB2aXN1YWxpemF0aW9uOiAiZmlsbCIgb3IgImZvY3VzIiwKICAgIG1pblNpemU6IG51bWJlciBvZiBwaXhlbHMKfQoKU2VsZWN0aW9uIHN1cHBvcnQgaXMgZW5hYmxlZCBieSBzZXR0aW5nIHRoZSBtb2RlIHRvIG9uZSBvZiAieCIsICJ5IiBvciAieHkiLgpJbiAieCIgbW9kZSwgdGhlIHVzZXIgd2lsbCBvbmx5IGJlIGFibGUgdG8gc3BlY2lmeSB0aGUgeCByYW5nZSwgc2ltaWxhcmx5IGZvcgoieSIgbW9kZS4gRm9yICJ4eSIsIHRoZSBzZWxlY3Rpb24gYmVjb21lcyBhIHJlY3RhbmdsZSB3aGVyZSBib3RoIHJhbmdlcyBjYW4gYmUKc3BlY2lmaWVkLiAiY29sb3IiIGlzIGNvbG9yIG9mIHRoZSBzZWxlY3Rpb24gKGlmIHlvdSBuZWVkIHRvIGNoYW5nZSB0aGUgY29sb3IKbGF0ZXIgb24sIHlvdSBjYW4gZ2V0IHRvIGl0IHdpdGggcGxvdC5nZXRPcHRpb25zKCkuc2VsZWN0aW9uLmNvbG9yKS4gInNoYXBlIgppcyB0aGUgc2hhcGUgb2YgdGhlIGNvcm5lcnMgb2YgdGhlIHNlbGVjdGlvbi4KClRoZSB3YXkgaG93IHRoZSBzZWxlY3Rpb24gaXMgdmlzdWFsaXplZCwgY2FuIGJlIGNoYW5nZWQgYnkgdXNpbmcgdGhlIG9wdGlvbgoidmlzdWFsaXphdGlvbiIuIEZsb3QgY3VycmVudGx5IHN1cHBvcnRzIHR3byBtb2RlczogImZvY3VzIiBhbmQgImZpbGwiLiBUaGUKb3B0aW9uICJmb2N1cyIgZHJhd3MgYSBjb2xvcmVkIGJlemVsIGFyb3VuZCB0aGUgc2VsZWN0ZWQgYXJlYSB3aGlsZSBrZWVwaW5nCnRoZSBzZWxlY3RlZCBhcmVhIGNsZWFyLiBUaGUgb3B0aW9uICJmaWxsIiBoaWdobGlnaHRzIChpLmUuLCBmaWxscykgdGhlCnNlbGVjdGVkIGFyZWEgd2l0aCBhIGNvbG9yZWQgaGlnaGxpZ2h0LgoKIm1pblNpemUiIGlzIHRoZSBtaW5pbXVtIHNpemUgYSBzZWxlY3Rpb24gY2FuIGJlIGluIHBpeGVscy4gVGhpcyB2YWx1ZSBjYW4KYmUgY3VzdG9taXplZCB0byBkZXRlcm1pbmUgdGhlIHNtYWxsZXN0IHNpemUgYSBzZWxlY3Rpb24gY2FuIGJlIGFuZCBzdGlsbApoYXZlIHRoZSBzZWxlY3Rpb24gcmVjdGFuZ2xlIGJlIGRpc3BsYXllZC4gV2hlbiBjdXN0b21pemluZyB0aGlzIHZhbHVlLCB0aGUKZmFjdCB0aGF0IGl0IHJlZmVycyB0byBwaXhlbHMsIG5vdCBheGlzIHVuaXRzIG11c3QgYmUgdGFrZW4gaW50byBhY2NvdW50LgpUaHVzLCBmb3IgZXhhbXBsZSwgaWYgdGhlcmUgaXMgYSBiYXIgZ3JhcGggaW4gdGltZSBtb2RlIHdpdGggQmFyV2lkdGggc2V0IHRvIDEKbWludXRlLCBzZXR0aW5nICJtaW5TaXplIiB0byAxIHdpbGwgbm90IG1ha2UgdGhlIG1pbmltdW0gc2VsZWN0aW9uIHNpemUgMQptaW51dGUsIGJ1dCByYXRoZXIgMSBwaXhlbC4gTm90ZSBhbHNvIHRoYXQgc2V0dGluZyAibWluU2l6ZSIgdG8gMCB3aWxsIHByZXZlbnQKInBsb3R1bnNlbGVjdGVkIiBldmVudHMgZnJvbSBiZWluZyBmaXJlZCB3aGVuIHRoZSB1c2VyIGNsaWNrcyB0aGUgbW91c2Ugd2l0aG91dApkcmFnZ2luZy4KCldoZW4gc2VsZWN0aW9uIHN1cHBvcnQgaXMgZW5hYmxlZCwgYSAicGxvdHNlbGVjdGVkIiBldmVudCB3aWxsIGJlIGVtaXR0ZWQgb24KdGhlIERPTSBlbGVtZW50IHlvdSBwYXNzZWQgaW50byB0aGUgcGxvdCBmdW5jdGlvbi4gVGhlIGV2ZW50IGhhbmRsZXIgZ2V0cyBhCnBhcmFtZXRlciB3aXRoIHRoZSByYW5nZXMgc2VsZWN0ZWQgb24gdGhlIGF4ZXMsIGxpa2UgdGhpczoKCiAgICBwbGFjZWhvbGRlci5iaW5kKCAicGxvdHNlbGVjdGVkIiwgZnVuY3Rpb24oIGV2ZW50LCByYW5nZXMgKSB7CiAgICAgICAgYWxlcnQoIllvdSBzZWxlY3RlZCAiICsgcmFuZ2VzLnhheGlzLmZyb20gKyAiIHRvICIgKyByYW5nZXMueGF4aXMudG8pCiAgICAgICAgLy8gc2ltaWxhciBmb3IgeWF4aXMgLSB3aXRoIG11bHRpcGxlIGF4ZXMsIHRoZSBleHRyYSBvbmVzIGFyZSBpbgogICAgICAgIC8vIHgyYXhpcywgeDNheGlzLCAuLi4KICAgIH0pOwoKVGhlICJwbG90c2VsZWN0ZWQiIGV2ZW50IGlzIG9ubHkgZmlyZWQgd2hlbiB0aGUgdXNlciBoYXMgZmluaXNoZWQgbWFraW5nIHRoZQpzZWxlY3Rpb24uIEEgInBsb3RzZWxlY3RpbmciIGV2ZW50IGlzIGZpcmVkIGR1cmluZyB0aGUgcHJvY2VzcyB3aXRoIHRoZSBzYW1lCnBhcmFtZXRlcnMgYXMgdGhlICJwbG90c2VsZWN0ZWQiIGV2ZW50LCBpbiBjYXNlIHlvdSB3YW50IHRvIGtub3cgd2hhdCdzCmhhcHBlbmluZyB3aGlsZSBpdCdzIGhhcHBlbmluZywKCkEgInBsb3R1bnNlbGVjdGVkIiBldmVudCB3aXRoIG5vIGFyZ3VtZW50cyBpcyBlbWl0dGVkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIHRoZQptb3VzZSB0byByZW1vdmUgdGhlIHNlbGVjdGlvbi4gQXMgc3RhdGVkIGFib3ZlLCBzZXR0aW5nICJtaW5TaXplIiB0byAwIHdpbGwKZGVzdHJveSB0aGlzIGJlaGF2aW9yLgoKVGhlIHBsdWdpbiBhbGxzbyBhZGRzIHRoZSBmb2xsb3dpbmcgbWV0aG9kcyB0byB0aGUgcGxvdCBvYmplY3Q6CgotIHNldFNlbGVjdGlvbiggcmFuZ2VzLCBwcmV2ZW50RXZlbnQgKQoKICBTZXQgdGhlIHNlbGVjdGlvbiByZWN0YW5nbGUuIFRoZSBwYXNzZWQgaW4gcmFuZ2VzIGlzIG9uIHRoZSBzYW1lIGZvcm0gYXMKICByZXR1cm5lZCBpbiB0aGUgInBsb3RzZWxlY3RlZCIgZXZlbnQuIElmIHRoZSBzZWxlY3Rpb24gbW9kZSBpcyAieCIsIHlvdQogIHNob3VsZCBwdXQgaW4gZWl0aGVyIGFuIHhheGlzIHJhbmdlLCBpZiB0aGUgbW9kZSBpcyAieSIgeW91IG5lZWQgdG8gcHV0IGluCiAgYW4geWF4aXMgcmFuZ2UgYW5kIGJvdGggeGF4aXMgYW5kIHlheGlzIGlmIHRoZSBzZWxlY3Rpb24gbW9kZSBpcyAieHkiLCBsaWtlCiAgdGhpczoKCiAgICBzZXRTZWxlY3Rpb24oeyB4YXhpczogeyBmcm9tOiAwLCB0bzogMTAgfSwgeWF4aXM6IHsgZnJvbTogNDAsIHRvOiA2MCB9IH0pOwoKICBzZXRTZWxlY3Rpb24gd2lsbCB0cmlnZ2VyIHRoZSAicGxvdHNlbGVjdGVkIiBldmVudCB3aGVuIGNhbGxlZC4gSWYgeW91IGRvbid0CiAgd2FudCB0aGF0IHRvIGhhcHBlbiwgZS5nLiBpZiB5b3UncmUgaW5zaWRlIGEgInBsb3RzZWxlY3RlZCIgaGFuZGxlciwgcGFzcwogIHRydWUgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIuIElmIHlvdSBhcmUgdXNpbmcgbXVsdGlwbGUgYXhlcywgeW91IGNhbgogIHNwZWNpZnkgdGhlIHJhbmdlcyBvbiBhbnkgb2YgdGhvc2UsIGUuZy4gYXMgeDJheGlzL3gzYXhpcy8uLi4gaW5zdGVhZCBvZgogIHhheGlzLCB0aGUgcGx1Z2luIHBpY2tzIHRoZSBmaXJzdCBvbmUgaXQgc2Vlcy4KCi0gY2xlYXJTZWxlY3Rpb24oIHByZXZlbnRFdmVudCApCgogIENsZWFyIHRoZSBzZWxlY3Rpb24gcmVjdGFuZ2xlLiBQYXNzIGluIHRydWUgdG8gYXZvaWQgZ2V0dGluZyBhCiAgInBsb3R1bnNlbGVjdGVkIiBldmVudC4KCi0gZ2V0U2VsZWN0aW9uKCkKCiAgUmV0dXJucyB0aGUgY3VycmVudCBzZWxlY3Rpb24gaW4gdGhlIHNhbWUgZm9ybWF0IGFzIHRoZSAicGxvdHNlbGVjdGVkIgogIGV2ZW50LiBJZiB0aGVyZSdzIGN1cnJlbnRseSBubyBzZWxlY3Rpb24sIHRoZSBmdW5jdGlvbiByZXR1cm5zIG51bGwuCgoqLwoKKGZ1bmN0aW9uICgkKSB7CiAgICBmdW5jdGlvbiBpbml0KHBsb3QpIHsKICAgICAgICB2YXIgc2VsZWN0aW9uID0gewogICAgICAgICAgICBmaXJzdDoge3g6IC0xLCB5OiAtMX0sCiAgICAgICAgICAgIHNlY29uZDoge3g6IC0xLCB5OiAtMX0sCiAgICAgICAgICAgIHNob3c6IGZhbHNlLAogICAgICAgICAgICBjdXJyZW50TW9kZTogJ3h5JywKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZQogICAgICAgIH07CgogICAgICAgIHZhciBTTkFQUElOR19DT05TVEFOVCA9ICQucGxvdC51aUNvbnN0YW50cy5TTkFQUElOR19DT05TVEFOVDsKCiAgICAgICAgLy8gRklYTUU6IFRoZSBkcmFnIGhhbmRsaW5nIGltcGxlbWVudGVkIGhlcmUgc2hvdWxkIGJlCiAgICAgICAgLy8gYWJzdHJhY3RlZCBvdXQsIHRoZXJlJ3Mgc29tZSBzaW1pbGFyIGNvZGUgZnJvbSBhIGxpYnJhcnkgaW4KICAgICAgICAvLyB0aGUgbmF2aWdhdGlvbiBwbHVnaW4sIHRoaXMgc2hvdWxkIGJlIG1hc3NhZ2VkIGEgYml0IHRvIGZpdAogICAgICAgIC8vIHRoZSBGbG90IGNhc2VzIGhlcmUgYmV0dGVyIGFuZCByZXVzZWQuIERvaW5nIHRoaXMgd291bGQKICAgICAgICAvLyBtYWtlIHRoaXMgcGx1Z2luIG11Y2ggc2xpbW1lci4KICAgICAgICB2YXIgc2F2ZWRoYW5kbGVycyA9IHt9OwoKICAgICAgICB2YXIgbW91c2VVcEhhbmRsZXIgPSBudWxsOwoKICAgICAgICBmdW5jdGlvbiBvbk1vdXNlTW92ZShlKSB7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24uYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVTZWxlY3Rpb24oZSk7CgogICAgICAgICAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlcigpLnRyaWdnZXIoInBsb3RzZWxlY3RpbmciLCBbIGdldFNlbGVjdGlvbigpIF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbk1vdXNlRG93bihlKSB7CiAgICAgICAgICAgIHZhciBvID0gcGxvdC5nZXRPcHRpb25zKCk7CiAgICAgICAgICAgIC8vIG9ubHkgYWNjZXB0IGxlZnQtY2xpY2sKICAgICAgICAgICAgaWYgKGUud2hpY2ggIT09IDEgfHwgby5zZWxlY3Rpb24ubW9kZSA9PT0gbnVsbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gcmVpbml0aWFsaXplIGN1cnJlbnRNb2RlCiAgICAgICAgICAgIHNlbGVjdGlvbi5jdXJyZW50TW9kZSA9ICd4eSc7CgogICAgICAgICAgICAvLyBjYW5jZWwgb3V0IGFueSB0ZXh0IHNlbGVjdGlvbnMKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5mb2N1cygpOwoKICAgICAgICAgICAgLy8gcHJldmVudCB0ZXh0IHNlbGVjdGlvbiBhbmQgZHJhZyBpbiBvbGQtc2Nob29sIGJyb3dzZXJzCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5vbnNlbGVjdHN0YXJ0ICE9PSB1bmRlZmluZWQgJiYgc2F2ZWRoYW5kbGVycy5vbnNlbGVjdHN0YXJ0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNhdmVkaGFuZGxlcnMub25zZWxlY3RzdGFydCA9IGRvY3VtZW50Lm9uc2VsZWN0c3RhcnQ7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5vbnNlbGVjdHN0YXJ0ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gZmFsc2U7IH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRvY3VtZW50Lm9uZHJhZyAhPT0gdW5kZWZpbmVkICYmIHNhdmVkaGFuZGxlcnMub25kcmFnID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNhdmVkaGFuZGxlcnMub25kcmFnID0gZG9jdW1lbnQub25kcmFnOwogICAgICAgICAgICAgICAgZG9jdW1lbnQub25kcmFnID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gZmFsc2U7IH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFNlbGVjdGlvblBvcyhzZWxlY3Rpb24uZmlyc3QsIGUpOwoKICAgICAgICAgICAgc2VsZWN0aW9uLmFjdGl2ZSA9IHRydWU7CgogICAgICAgICAgICAvLyB0aGlzIGlzIGEgYml0IHNpbGx5LCBidXQgd2UgaGF2ZSB0byB1c2UgYSBjbG9zdXJlIHRvIGJlCiAgICAgICAgICAgIC8vIGFibGUgdG8gd2hhY2sgdGhlIHNhbWUgaGFuZGxlciBhZ2FpbgogICAgICAgICAgICBtb3VzZVVwSGFuZGxlciA9IGZ1bmN0aW9uIChlKSB7IG9uTW91c2VVcChlKTsgfTsKCiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uZSgibW91c2V1cCIsIG1vdXNlVXBIYW5kbGVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uTW91c2VVcChlKSB7CiAgICAgICAgICAgIG1vdXNlVXBIYW5kbGVyID0gbnVsbDsKCiAgICAgICAgICAgIC8vIHJldmVydCBkcmFnIHN0dWZmIGZvciBvbGQtc2Nob29sIGJyb3dzZXJzCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5vbnNlbGVjdHN0YXJ0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50Lm9uc2VsZWN0c3RhcnQgPSBzYXZlZGhhbmRsZXJzLm9uc2VsZWN0c3RhcnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5vbmRyYWcgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQub25kcmFnID0gc2F2ZWRoYW5kbGVycy5vbmRyYWc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG5vIG1vcmUgZHJhZ2dpbmcKICAgICAgICAgICAgc2VsZWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB1cGRhdGVTZWxlY3Rpb24oZSk7CgogICAgICAgICAgICBpZiAoc2VsZWN0aW9uSXNTYW5lKCkpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJTZWxlY3RlZEV2ZW50KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyB0aGlzIGNvdW50cyBhcyBhIGNsZWFyCiAgICAgICAgICAgICAgICBwbG90LmdldFBsYWNlaG9sZGVyKCkudHJpZ2dlcigicGxvdHVuc2VsZWN0ZWQiLCBbIF0pOwogICAgICAgICAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlcigpLnRyaWdnZXIoInBsb3RzZWxlY3RpbmciLCBbIG51bGwgXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFzZWxlY3Rpb25Jc1NhbmUoKSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBpZiAoIXNlbGVjdGlvbi5zaG93KSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgIHZhciByID0ge30sCiAgICAgICAgICAgICAgICBjMSA9IHt4OiBzZWxlY3Rpb24uZmlyc3QueCwgeTogc2VsZWN0aW9uLmZpcnN0Lnl9LAogICAgICAgICAgICAgICAgYzIgPSB7eDogc2VsZWN0aW9uLnNlY29uZC54LCB5OiBzZWxlY3Rpb24uc2Vjb25kLnl9OwoKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbkRpcmVjdGlvbihwbG90KSA9PT0gJ3gnKSB7CiAgICAgICAgICAgICAgICBjMS55ID0gMDsKICAgICAgICAgICAgICAgIGMyLnkgPSBwbG90LmhlaWdodCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VsZWN0aW9uRGlyZWN0aW9uKHBsb3QpID09PSAneScpIHsKICAgICAgICAgICAgICAgIGMxLnggPSAwOwogICAgICAgICAgICAgICAgYzIueCA9IHBsb3Qud2lkdGgoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5lYWNoKHBsb3QuZ2V0QXhlcygpLCBmdW5jdGlvbiAobmFtZSwgYXhpcykgewogICAgICAgICAgICAgICAgaWYgKGF4aXMudXNlZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwMSA9IGF4aXMuYzJwKGMxW2F4aXMuZGlyZWN0aW9uXSksIHAyID0gYXhpcy5jMnAoYzJbYXhpcy5kaXJlY3Rpb25dKTsKICAgICAgICAgICAgICAgICAgICByW25hbWVdID0geyBmcm9tOiBNYXRoLm1pbihwMSwgcDIpLCB0bzogTWF0aC5tYXgocDEsIHAyKSB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyU2VsZWN0ZWRFdmVudCgpIHsKICAgICAgICAgICAgdmFyIHIgPSBnZXRTZWxlY3Rpb24oKTsKCiAgICAgICAgICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIoKS50cmlnZ2VyKCJwbG90c2VsZWN0ZWQiLCBbIHIgXSk7CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMtY29tcGF0IHN0dWZmLCB0byBiZSByZW1vdmVkIGluIGZ1dHVyZQogICAgICAgICAgICBpZiAoci54YXhpcyAmJiByLnlheGlzKSB7CiAgICAgICAgICAgICAgICBwbG90LmdldFBsYWNlaG9sZGVyKCkudHJpZ2dlcigic2VsZWN0ZWQiLCBbIHsgeDE6IHIueGF4aXMuZnJvbSwgeTE6IHIueWF4aXMuZnJvbSwgeDI6IHIueGF4aXMudG8sIHkyOiByLnlheGlzLnRvIH0gXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNsYW1wKG1pbiwgdmFsdWUsIG1heCkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPCBtaW4gPyBtaW4gOiAodmFsdWUgPiBtYXggPyBtYXggOiB2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZWxlY3Rpb25EaXJlY3Rpb24ocGxvdCkgewogICAgICAgICAgICB2YXIgbyA9IHBsb3QuZ2V0T3B0aW9ucygpOwoKICAgICAgICAgICAgaWYgKG8uc2VsZWN0aW9uLm1vZGUgPT09ICdzbWFydCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24uY3VycmVudE1vZGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gby5zZWxlY3Rpb24ubW9kZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW9kZShwb3MpIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5maXJzdCkgewogICAgICAgICAgICAgICAgdmFyIGRlbHRhID0gewogICAgICAgICAgICAgICAgICAgIHg6IHBvcy54IC0gc2VsZWN0aW9uLmZpcnN0LngsCiAgICAgICAgICAgICAgICAgICAgeTogcG9zLnkgLSBzZWxlY3Rpb24uZmlyc3QueQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGVsdGEueCkgPCBTTkFQUElOR19DT05TVEFOVCkgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5jdXJyZW50TW9kZSA9ICd5JzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoTWF0aC5hYnMoZGVsdGEueSkgPCBTTkFQUElOR19DT05TVEFOVCkgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5jdXJyZW50TW9kZSA9ICd4JzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uLmN1cnJlbnRNb2RlID0gJ3h5JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uUG9zKHBvcywgZSkgewogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gcGxvdC5nZXRQbGFjZWhvbGRlcigpLm9mZnNldCgpOwogICAgICAgICAgICB2YXIgcGxvdE9mZnNldCA9IHBsb3QuZ2V0UGxvdE9mZnNldCgpOwogICAgICAgICAgICBwb3MueCA9IGNsYW1wKDAsIGUucGFnZVggLSBvZmZzZXQubGVmdCAtIHBsb3RPZmZzZXQubGVmdCwgcGxvdC53aWR0aCgpKTsKICAgICAgICAgICAgcG9zLnkgPSBjbGFtcCgwLCBlLnBhZ2VZIC0gb2Zmc2V0LnRvcCAtIHBsb3RPZmZzZXQudG9wLCBwbG90LmhlaWdodCgpKTsKCiAgICAgICAgICAgIGlmIChwb3MgIT09IHNlbGVjdGlvbi5maXJzdCkgdXBkYXRlTW9kZShwb3MpOwoKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbkRpcmVjdGlvbihwbG90KSA9PT0gInkiKSB7CiAgICAgICAgICAgICAgICBwb3MueCA9IHBvcyA9PT0gc2VsZWN0aW9uLmZpcnN0ID8gMCA6IHBsb3Qud2lkdGgoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbkRpcmVjdGlvbihwbG90KSA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICBwb3MueSA9IHBvcyA9PT0gc2VsZWN0aW9uLmZpcnN0ID8gMCA6IHBsb3QuaGVpZ2h0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNlbGVjdGlvbihwb3MpIHsKICAgICAgICAgICAgaWYgKHBvcy5wYWdlWCA9PSBudWxsKSByZXR1cm47CgogICAgICAgICAgICBzZXRTZWxlY3Rpb25Qb3Moc2VsZWN0aW9uLnNlY29uZCwgcG9zKTsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbklzU2FuZSgpKSB7CiAgICAgICAgICAgICAgICBzZWxlY3Rpb24uc2hvdyA9IHRydWU7CiAgICAgICAgICAgICAgICBwbG90LnRyaWdnZXJSZWRyYXdPdmVybGF5KCk7CiAgICAgICAgICAgIH0gZWxzZSBjbGVhclNlbGVjdGlvbih0cnVlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNsZWFyU2VsZWN0aW9uKHByZXZlbnRFdmVudCkgewogICAgICAgICAgICBpZiAoc2VsZWN0aW9uLnNob3cpIHsKICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5zaG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzZWxlY3Rpb24uY3VycmVudE1vZGUgPSAnJzsKICAgICAgICAgICAgICAgIHBsb3QudHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgICAgICAgICAgIGlmICghcHJldmVudEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlcigpLnRyaWdnZXIoInBsb3R1bnNlbGVjdGVkIiwgWyBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gZnVuY3Rpb24gdGFrZW4gZnJvbSBtYXJraW5ncyBzdXBwb3J0IGluIEZsb3QKICAgICAgICBmdW5jdGlvbiBleHRyYWN0UmFuZ2UocmFuZ2VzLCBjb29yZCkgewogICAgICAgICAgICB2YXIgYXhpcywgZnJvbSwgdG8sIGtleSwgYXhlcyA9IHBsb3QuZ2V0QXhlcygpOwoKICAgICAgICAgICAgZm9yICh2YXIgayBpbiBheGVzKSB7CiAgICAgICAgICAgICAgICBheGlzID0gYXhlc1trXTsKICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gY29vcmQpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBjb29yZCArIGF4aXMubiArICJheGlzIjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJhbmdlc1trZXldICYmIGF4aXMubiA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdXBwb3J0IHgxYXhpcyBhcyB4YXhpcwogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBjb29yZCArICJheGlzIjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChyYW5nZXNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gcmFuZ2VzW2tleV0uZnJvbTsKICAgICAgICAgICAgICAgICAgICAgICAgdG8gPSByYW5nZXNba2V5XS50bzsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMtY29tcGF0IHN0dWZmIC0gdG8gYmUgcmVtb3ZlZCBpbiBmdXR1cmUKICAgICAgICAgICAgaWYgKCFyYW5nZXNba2V5XSkgewogICAgICAgICAgICAgICAgYXhpcyA9IGNvb3JkID09PSAieCIgPyBwbG90LmdldFhBeGVzKClbMF0gOiBwbG90LmdldFlBeGVzKClbMF07CiAgICAgICAgICAgICAgICBmcm9tID0gcmFuZ2VzW2Nvb3JkICsgIjEiXTsKICAgICAgICAgICAgICAgIHRvID0gcmFuZ2VzW2Nvb3JkICsgIjIiXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYXV0by1yZXZlcnNlIGFzIGFuIGFkZGVkIGJvbnVzCiAgICAgICAgICAgIGlmIChmcm9tICE9IG51bGwgJiYgdG8gIT0gbnVsbCAmJiBmcm9tID4gdG8pIHsKICAgICAgICAgICAgICAgIHZhciB0bXAgPSBmcm9tOwogICAgICAgICAgICAgICAgZnJvbSA9IHRvOwogICAgICAgICAgICAgICAgdG8gPSB0bXA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7IGZyb206IGZyb20sIHRvOiB0bywgYXhpczogYXhpcyB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uKHJhbmdlcywgcHJldmVudEV2ZW50KSB7CiAgICAgICAgICAgIHZhciByYW5nZTsKCiAgICAgICAgICAgIGlmIChzZWxlY3Rpb25EaXJlY3Rpb24ocGxvdCkgPT09ICJ5IikgewogICAgICAgICAgICAgICAgc2VsZWN0aW9uLmZpcnN0LnggPSAwOwogICAgICAgICAgICAgICAgc2VsZWN0aW9uLnNlY29uZC54ID0gcGxvdC53aWR0aCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmFuZ2UgPSBleHRyYWN0UmFuZ2UocmFuZ2VzLCAieCIpOwogICAgICAgICAgICAgICAgc2VsZWN0aW9uLmZpcnN0LnggPSByYW5nZS5heGlzLnAyYyhyYW5nZS5mcm9tKTsKICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5zZWNvbmQueCA9IHJhbmdlLmF4aXMucDJjKHJhbmdlLnRvKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbkRpcmVjdGlvbihwbG90KSA9PT0gIngiKSB7CiAgICAgICAgICAgICAgICBzZWxlY3Rpb24uZmlyc3QueSA9IDA7CiAgICAgICAgICAgICAgICBzZWxlY3Rpb24uc2Vjb25kLnkgPSBwbG90LmhlaWdodCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmFuZ2UgPSBleHRyYWN0UmFuZ2UocmFuZ2VzLCAieSIpOwogICAgICAgICAgICAgICAgc2VsZWN0aW9uLmZpcnN0LnkgPSByYW5nZS5heGlzLnAyYyhyYW5nZS5mcm9tKTsKICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5zZWNvbmQueSA9IHJhbmdlLmF4aXMucDJjKHJhbmdlLnRvKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VsZWN0aW9uLnNob3cgPSB0cnVlOwogICAgICAgICAgICBwbG90LnRyaWdnZXJSZWRyYXdPdmVybGF5KCk7CiAgICAgICAgICAgIGlmICghcHJldmVudEV2ZW50ICYmIHNlbGVjdGlvbklzU2FuZSgpKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyU2VsZWN0ZWRFdmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZWxlY3Rpb25Jc1NhbmUoKSB7CiAgICAgICAgICAgIHZhciBtaW5TaXplID0gcGxvdC5nZXRPcHRpb25zKCkuc2VsZWN0aW9uLm1pblNpemU7CiAgICAgICAgICAgIHJldHVybiBNYXRoLmFicyhzZWxlY3Rpb24uc2Vjb25kLnggLSBzZWxlY3Rpb24uZmlyc3QueCkgPj0gbWluU2l6ZSAmJgogICAgICAgICAgICAgICAgTWF0aC5hYnMoc2VsZWN0aW9uLnNlY29uZC55IC0gc2VsZWN0aW9uLmZpcnN0LnkpID49IG1pblNpemU7CiAgICAgICAgfQoKICAgICAgICBwbG90LmNsZWFyU2VsZWN0aW9uID0gY2xlYXJTZWxlY3Rpb247CiAgICAgICAgcGxvdC5zZXRTZWxlY3Rpb24gPSBzZXRTZWxlY3Rpb247CiAgICAgICAgcGxvdC5nZXRTZWxlY3Rpb24gPSBnZXRTZWxlY3Rpb247CgogICAgICAgIHBsb3QuaG9va3MuYmluZEV2ZW50cy5wdXNoKGZ1bmN0aW9uKHBsb3QsIGV2ZW50SG9sZGVyKSB7CiAgICAgICAgICAgIHZhciBvID0gcGxvdC5nZXRPcHRpb25zKCk7CiAgICAgICAgICAgIGlmIChvLnNlbGVjdGlvbi5tb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50SG9sZGVyLm1vdXNlbW92ZShvbk1vdXNlTW92ZSk7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlci5tb3VzZWRvd24ob25Nb3VzZURvd24pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIGRyYXdTZWxlY3Rpb25EZWNvcmF0aW9ucyhjdHgsIHgsIHksIHcsIGgsIG9YLCBvWSwgbW9kZSkgewogICAgICAgICAgICB2YXIgc3BhY2luZyA9IDM7CiAgICAgICAgICAgIHZhciBmdWxsRWFyV2lkdGggPSAxNTsKICAgICAgICAgICAgdmFyIGVhcldpZHRoID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oZnVsbEVhcldpZHRoLCB3IC8gMiAtIDIsIGggLyAyIC0gMikpOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwoKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICd4eScpIHsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSArIGVhcldpZHRoKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCAtIDMsIHkgKyBlYXJXaWR0aCk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggLSAzLCB5IC0gMyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggKyBlYXJXaWR0aCwgeSAtIDMpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgZWFyV2lkdGgsIHkpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgsIHkgKyBoIC0gZWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4IC0gMywgeSArIGggLSBlYXJXaWR0aCk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggLSAzLCB5ICsgaCArIDMpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgZWFyV2lkdGgsIHkgKyBoICsgMyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggKyBlYXJXaWR0aCwgeSArIGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5ICsgaCk7CiAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CgogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4ICsgdywgeSArIGVhcldpZHRoKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHcgKyAzLCB5ICsgZWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgdyArIDMsIHkgLSAzKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHcgLSBlYXJXaWR0aCwgeSAtIDMpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgdyAtIGVhcldpZHRoLCB5KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHcsIHkpOwogICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwoKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCArIHcsIHkgKyBoIC0gZWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgdyArIDMsIHkgKyBoIC0gZWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgdyArIDMsIHkgKyBoICsgMyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggKyB3IC0gZWFyV2lkdGgsIHkgKyBoICsgMyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggKyB3IC0gZWFyV2lkdGgsIHkgKyBoKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHcsIHkgKyBoKTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKCiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB4ID0gb1g7CiAgICAgICAgICAgIHkgPSBvWTsKCiAgICAgICAgICAgIGlmIChtb2RlID09PSAneCcpIHsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSArIGZ1bGxFYXJXaWR0aCk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHgsIHkgLSBmdWxsRWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4IC0gc3BhY2luZywgeSAtIGZ1bGxFYXJXaWR0aCk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggLSBzcGFjaW5nLCB5ICsgZnVsbEVhcldpZHRoKTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHggKyB3LCB5ICsgZnVsbEVhcldpZHRoKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHcsIHkgLSBmdWxsRWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgdyArIHNwYWNpbmcsIHkgLSBmdWxsRWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgdyArIHNwYWNpbmcsIHkgKyBmdWxsRWFyV2lkdGgpOwogICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICd5JykgewogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwoKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCAtIGZ1bGxFYXJXaWR0aCwgeSk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggKyBmdWxsRWFyV2lkdGgsIHkpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgZnVsbEVhcldpZHRoLCB5IC0gc3BhY2luZyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggLSBmdWxsRWFyV2lkdGgsIHkgLSBzcGFjaW5nKTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHggLSBmdWxsRWFyV2lkdGgsIHkgKyBoKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIGZ1bGxFYXJXaWR0aCwgeSArIGgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgZnVsbEVhcldpZHRoLCB5ICsgaCArIHNwYWNpbmcpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4IC0gZnVsbEVhcldpZHRoLCB5ICsgaCArIHNwYWNpbmcpOwogICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxvdC5ob29rcy5kcmF3T3ZlcmxheS5wdXNoKGZ1bmN0aW9uIChwbG90LCBjdHgpIHsKICAgICAgICAgICAgLy8gZHJhdyBzZWxlY3Rpb24KICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5zaG93ICYmIHNlbGVjdGlvbklzU2FuZSgpKSB7CiAgICAgICAgICAgICAgICB2YXIgcGxvdE9mZnNldCA9IHBsb3QuZ2V0UGxvdE9mZnNldCgpOwogICAgICAgICAgICAgICAgdmFyIG8gPSBwbG90LmdldE9wdGlvbnMoKTsKCiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsKCiAgICAgICAgICAgICAgICB2YXIgYyA9ICQuY29sb3IucGFyc2Uoby5zZWxlY3Rpb24uY29sb3IpOwogICAgICAgICAgICAgICAgdmFyIHZpc3VhbGl6YXRpb24gPSBvLnNlbGVjdGlvbi52aXN1YWxpemF0aW9uOwoKICAgICAgICAgICAgICAgIHZhciBzY2FsaW5nRmFjdG9yID0gMTsKCiAgICAgICAgICAgICAgICAvLyB1c2UgYSBkaW1tZXIgc2NhbGluZyBmYWN0b3IgaWYgdmlzdWFsaXphdGlvbiBpcyAiZmlsbCIKICAgICAgICAgICAgICAgIGlmICh2aXN1YWxpemF0aW9uID09PSAiZmlsbCIpIHsKICAgICAgICAgICAgICAgICAgICBzY2FsaW5nRmFjdG9yID0gMC44OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGMuc2NhbGUoJ2EnLCBzY2FsaW5nRmFjdG9yKS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDE7CiAgICAgICAgICAgICAgICBjdHgubGluZUpvaW4gPSBvLnNlbGVjdGlvbi5zaGFwZTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBjLnNjYWxlKCdhJywgMC40KS50b1N0cmluZygpOwoKICAgICAgICAgICAgICAgIHZhciB4ID0gTWF0aC5taW4oc2VsZWN0aW9uLmZpcnN0LngsIHNlbGVjdGlvbi5zZWNvbmQueCkgKyAwLjUsCiAgICAgICAgICAgICAgICAgICAgb1ggPSB4LAogICAgICAgICAgICAgICAgICAgIHkgPSBNYXRoLm1pbihzZWxlY3Rpb24uZmlyc3QueSwgc2VsZWN0aW9uLnNlY29uZC55KSArIDAuNSwKICAgICAgICAgICAgICAgICAgICBvWSA9IHksCiAgICAgICAgICAgICAgICAgICAgdyA9IE1hdGguYWJzKHNlbGVjdGlvbi5zZWNvbmQueCAtIHNlbGVjdGlvbi5maXJzdC54KSAtIDEsCiAgICAgICAgICAgICAgICAgICAgaCA9IE1hdGguYWJzKHNlbGVjdGlvbi5zZWNvbmQueSAtIHNlbGVjdGlvbi5maXJzdC55KSAtIDE7CgogICAgICAgICAgICAgICAgaWYgKHNlbGVjdGlvbkRpcmVjdGlvbihwbG90KSA9PT0gJ3gnKSB7CiAgICAgICAgICAgICAgICAgICAgaCArPSB5OwogICAgICAgICAgICAgICAgICAgIHkgPSAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rpb25EaXJlY3Rpb24ocGxvdCkgPT09ICd5JykgewogICAgICAgICAgICAgICAgICAgIHcgKz0geDsKICAgICAgICAgICAgICAgICAgICB4ID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodmlzdWFsaXphdGlvbiA9PT0gImZpbGwiKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHgsIHksIHcsIGgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KHgsIHksIHcsIGgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgcGxvdC53aWR0aCgpLCBwbG90LmhlaWdodCgpKTsKICAgICAgICAgICAgICAgICAgICBjdHguY2xlYXJSZWN0KHgsIHksIHcsIGgpOwogICAgICAgICAgICAgICAgICAgIGRyYXdTZWxlY3Rpb25EZWNvcmF0aW9ucyhjdHgsIHgsIHksIHcsIGgsIG9YLCBvWSwgc2VsZWN0aW9uRGlyZWN0aW9uKHBsb3QpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHBsb3QuaG9va3Muc2h1dGRvd24ucHVzaChmdW5jdGlvbiAocGxvdCwgZXZlbnRIb2xkZXIpIHsKICAgICAgICAgICAgZXZlbnRIb2xkZXIudW5iaW5kKCJtb3VzZW1vdmUiLCBvbk1vdXNlTW92ZSk7CiAgICAgICAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgibW91c2Vkb3duIiwgb25Nb3VzZURvd24pOwoKICAgICAgICAgICAgaWYgKG1vdXNlVXBIYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS51bmJpbmQoIm1vdXNldXAiLCBtb3VzZVVwSGFuZGxlcik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICAkLnBsb3QucGx1Z2lucy5wdXNoKHsKICAgICAgICBpbml0OiBpbml0LAogICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgc2VsZWN0aW9uOiB7CiAgICAgICAgICAgICAgICBtb2RlOiBudWxsLCAvLyBvbmUgb2YgbnVsbCwgIngiLCAieSIgb3IgInh5IgogICAgICAgICAgICAgICAgdmlzdWFsaXphdGlvbjogImZvY3VzIiwgLy8gImZvY3VzIiBvciAiZmlsbCIKICAgICAgICAgICAgICAgIGNvbG9yOiAiIzg4ODg4OCIsCiAgICAgICAgICAgICAgICBzaGFwZTogInJvdW5kIiwgLy8gb25lIG9mICJyb3VuZCIsICJtaXRlciIsIG9yICJiZXZlbCIKICAgICAgICAgICAgICAgIG1pblNpemU6IDUgLy8gbWluaW11bSBudW1iZXIgb2YgcGl4ZWxzCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG5hbWU6ICdzZWxlY3Rpb24nLAogICAgICAgIHZlcnNpb246ICcxLjEnCiAgICB9KTsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogRmxvdCBwbHVnaW4gdGhhdCBhZGRzIHNvbWUgZXh0cmEgc3ltYm9scyBmb3IgcGxvdHRpbmcgcG9pbnRzLgoKQ29weXJpZ2h0IChjKSAyMDA3LTIwMTQgSU9MQSBhbmQgT2xlIExhdXJzZW4uCkxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KClRoZSBzeW1ib2xzIGFyZSBhY2Nlc3NlZCBhcyBzdHJpbmdzIHRocm91Z2ggdGhlIHN0YW5kYXJkIHN5bWJvbCBvcHRpb25zOgoKICAgIHNlcmllczogewogICAgICAgIHBvaW50czogewogICAgICAgICAgICBzeW1ib2w6ICJzcXVhcmUiIC8vIG9yICJkaWFtb25kIiwgInRyaWFuZ2xlIiwgImNyb3NzIiwgInBsdXMiLCAiZWxsaXBzZSIsICJyZWN0YW5nbGUiCiAgICAgICAgfQogICAgfQoKKi8KCihmdW5jdGlvbiAoJCkgewogICAgLy8gd2Ugbm9ybWFsaXplIHRoZSBhcmVhIG9mIGVhY2ggc3ltYm9sIHNvIGl0IGlzIGFwcHJveGltYXRlbHkgdGhlCiAgICAvLyBzYW1lIGFzIGEgY2lyY2xlIG9mIHRoZSBnaXZlbiByYWRpdXMKCiAgICB2YXIgc3F1YXJlID0gZnVuY3Rpb24gKGN0eCwgeCwgeSwgcmFkaXVzLCBzaGFkb3cpIHsKICAgICAgICAgICAgLy8gcGkgKiByXjIgPSAoMnMpXjIgID0+ICBzID0gciAqIHNxcnQocGkpLzIKICAgICAgICAgICAgdmFyIHNpemUgPSByYWRpdXMgKiBNYXRoLnNxcnQoTWF0aC5QSSkgLyAyOwogICAgICAgICAgICBjdHgucmVjdCh4IC0gc2l6ZSwgeSAtIHNpemUsIHNpemUgKyBzaXplLCBzaXplICsgc2l6ZSk7CiAgICAgICAgfSwKICAgICAgICByZWN0YW5nbGUgPSBmdW5jdGlvbiAoY3R4LCB4LCB5LCByYWRpdXMsIHNoYWRvdykgewogICAgICAgICAgICAvLyBwaSAqIHJeMiA9ICgycyleMiAgPT4gIHMgPSByICogc3FydChwaSkvMgogICAgICAgICAgICB2YXIgc2l6ZSA9IHJhZGl1cyAqIE1hdGguc3FydChNYXRoLlBJKSAvIDI7CiAgICAgICAgICAgIGN0eC5yZWN0KHggLSBzaXplLCB5IC0gc2l6ZSwgc2l6ZSArIHNpemUsIHNpemUgKyBzaXplKTsKICAgICAgICB9LAogICAgICAgIGRpYW1vbmQgPSBmdW5jdGlvbiAoY3R4LCB4LCB5LCByYWRpdXMsIHNoYWRvdykgewogICAgICAgICAgICAvLyBwaSAqIHJeMiA9IDJzXjIgID0+ICBzID0gciAqIHNxcnQocGkvMikKICAgICAgICAgICAgdmFyIHNpemUgPSByYWRpdXMgKiBNYXRoLnNxcnQoTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjdHgubW92ZVRvKHggLSBzaXplLCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5IC0gc2l6ZSk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHNpemUsIHkpOwogICAgICAgICAgICBjdHgubGluZVRvKHgsIHkgKyBzaXplKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4IC0gc2l6ZSwgeSk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSAtIHNpemUpOwogICAgICAgIH0sCiAgICAgICAgdHJpYW5nbGUgPSBmdW5jdGlvbiAoY3R4LCB4LCB5LCByYWRpdXMsIHNoYWRvdykgewogICAgICAgICAgICAvLyBwaSAqIHJeMiA9IDEvMiAqIHNeMiAqIHNpbiAocGkgLyAzKSAgPT4gIHMgPSByICogc3FydCgyICogcGkgLyBzaW4ocGkgLyAzKSkKICAgICAgICAgICAgdmFyIHNpemUgPSByYWRpdXMgKiBNYXRoLnNxcnQoMiAqIE1hdGguUEkgLyBNYXRoLnNpbihNYXRoLlBJIC8gMykpOwogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gc2l6ZSAqIE1hdGguc2luKE1hdGguUEkgLyAzKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyh4IC0gc2l6ZSAvIDIsIHkgKyBoZWlnaHQgLyAyKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgc2l6ZSAvIDIsIHkgKyBoZWlnaHQgLyAyKTsKICAgICAgICAgICAgaWYgKCFzaGFkb3cpIHsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSAtIGhlaWdodCAvIDIpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4IC0gc2l6ZSAvIDIsIHkgKyBoZWlnaHQgLyAyKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHNpemUgLyAyLCB5ICsgaGVpZ2h0IC8gMik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNyb3NzID0gZnVuY3Rpb24gKGN0eCwgeCwgeSwgcmFkaXVzLCBzaGFkb3cpIHsKICAgICAgICAgICAgLy8gcGkgKiByXjIgPSAoMnMpXjIgID0+ICBzID0gciAqIHNxcnQocGkpLzIKICAgICAgICAgICAgdmFyIHNpemUgPSByYWRpdXMgKiBNYXRoLnNxcnQoTWF0aC5QSSkgLyAyOwogICAgICAgICAgICBjdHgubW92ZVRvKHggLSBzaXplLCB5IC0gc2l6ZSk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHNpemUsIHkgKyBzaXplKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyh4IC0gc2l6ZSwgeSArIHNpemUpOwogICAgICAgICAgICBjdHgubGluZVRvKHggKyBzaXplLCB5IC0gc2l6ZSk7CiAgICAgICAgfSwKICAgICAgICBlbGxpcHNlID0gZnVuY3Rpb24oY3R4LCB4LCB5LCByYWRpdXMsIHNoYWRvdywgZmlsbCkgewogICAgICAgICAgICBpZiAoIXNoYWRvdykgewogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4ICsgcmFkaXVzLCB5KTsKICAgICAgICAgICAgICAgIGN0eC5hcmMoeCwgeSwgcmFkaXVzLCAwLCBNYXRoLlBJICogMiwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBwbHVzID0gZnVuY3Rpb24gKGN0eCwgeCwgeSwgcmFkaXVzLCBzaGFkb3cpIHsKICAgICAgICAgICAgdmFyIHNpemUgPSByYWRpdXMgKiBNYXRoLnNxcnQoTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjdHgubW92ZVRvKHggLSBzaXplLCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4ICsgc2l6ZSwgeSk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSArIHNpemUpOwogICAgICAgICAgICBjdHgubGluZVRvKHgsIHkgLSBzaXplKTsKICAgICAgICB9LAogICAgICAgIGhhbmRsZXJzID0gewogICAgICAgICAgICBzcXVhcmU6IHNxdWFyZSwKICAgICAgICAgICAgcmVjdGFuZ2xlOiByZWN0YW5nbGUsCiAgICAgICAgICAgIGRpYW1vbmQ6IGRpYW1vbmQsCiAgICAgICAgICAgIHRyaWFuZ2xlOiB0cmlhbmdsZSwKICAgICAgICAgICAgY3Jvc3M6IGNyb3NzLAogICAgICAgICAgICBlbGxpcHNlOiBlbGxpcHNlLAogICAgICAgICAgICBwbHVzOiBwbHVzCiAgICAgICAgfTsKCiAgICBzcXVhcmUuZmlsbCA9IHRydWU7CiAgICByZWN0YW5nbGUuZmlsbCA9IHRydWU7CiAgICBkaWFtb25kLmZpbGwgPSB0cnVlOwogICAgdHJpYW5nbGUuZmlsbCA9IHRydWU7CiAgICBlbGxpcHNlLmZpbGwgPSB0cnVlOwoKICAgIGZ1bmN0aW9uIGluaXQocGxvdCkgewogICAgICAgIHBsb3QuZHJhd1N5bWJvbCA9IGhhbmRsZXJzOwogICAgfQoKICAgICQucGxvdC5wbHVnaW5zLnB1c2goewogICAgICAgIGluaXQ6IGluaXQsCiAgICAgICAgbmFtZTogJ3N5bWJvbHMnLAogICAgICAgIHZlcnNpb246ICcxLjAnCiAgICB9KTsKfSkoalF1ZXJ5KTsK"></script>
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,LyogRmxvdCBwbHVnaW4gZm9yIHBsb3R0aW5nIGltYWdlcy4KCkNvcHlyaWdodCAoYykgMjAwNy0yMDE0IElPTEEgYW5kIE9sZSBMYXVyc2VuLgpMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgpUaGUgZGF0YSBzeW50YXggaXMgWyBbIGltYWdlLCB4MSwgeTEsIHgyLCB5MiBdLCAuLi4gXSB3aGVyZSAoeDEsIHkxKSBhbmQKKHgyLCB5MikgYXJlIHdoZXJlIHlvdSBpbnRlbmQgdGhlIHR3byBvcHBvc2l0ZSBjb3JuZXJzIG9mIHRoZSBpbWFnZSB0byBlbmQgdXAKaW4gdGhlIHBsb3QuIEltYWdlIG11c3QgYmUgYSBmdWxseSBsb2FkZWQgSmF2YXNjcmlwdCBpbWFnZSAoeW91IGNhbiBtYWtlIG9uZQp3aXRoIG5ldyBJbWFnZSgpKS4gSWYgdGhlIGltYWdlIGlzIG5vdCBjb21wbGV0ZSwgaXQncyBza2lwcGVkIHdoZW4gcGxvdHRpbmcuCgpUaGVyZSBhcmUgdHdvIGhlbHBlcnMgaW5jbHVkZWQgZm9yIHJldHJpZXZpbmcgaW1hZ2VzLiBUaGUgZWFzaWVzdCB3b3JrIHRoZSB3YXkKdGhhdCB5b3UgcHV0IGluIFVSTHMgaW5zdGVhZCBvZiBpbWFnZXMgaW4gdGhlIGRhdGEsIGxpa2UgdGhpczoKCiAgICBbICJteWltYWdlLnBuZyIsIDAsIDAsIDEwLCAxMCBdCgpUaGVuIGNhbGwgJC5wbG90LmltYWdlLmxvYWREYXRhKCBkYXRhLCBvcHRpb25zLCBjYWxsYmFjayApIHdoZXJlIGRhdGEgYW5kCm9wdGlvbnMgYXJlIHRoZSBzYW1lIGFzIHlvdSBwYXNzIGluIHRvICQucGxvdC4gVGhpcyBsb2FkcyB0aGUgaW1hZ2VzLCByZXBsYWNlcwp0aGUgVVJMcyBpbiB0aGUgZGF0YSB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGltYWdlcyBhbmQgY2FsbHMgImNhbGxiYWNrIiB3aGVuCmFsbCBpbWFnZXMgYXJlIGxvYWRlZCAob3IgZmFpbGVkIGxvYWRpbmcpLiBJbiB0aGUgY2FsbGJhY2ssIHlvdSBjYW4gdGhlbiBjYWxsCiQucGxvdCB3aXRoIHRoZSBkYXRhIHNldC4gU2VlIHRoZSBpbmNsdWRlZCBleGFtcGxlLgoKQSBtb3JlIGxvdy1sZXZlbCBoZWxwZXIsICQucGxvdC5pbWFnZS5sb2FkKHVybHMsIGNhbGxiYWNrKSBpcyBhbHNvIGluY2x1ZGVkLgpHaXZlbiBhIGxpc3Qgb2YgVVJMcywgaXQgY2FsbHMgY2FsbGJhY2sgd2l0aCBhbiBvYmplY3QgbWFwcGluZyBmcm9tIFVSTCB0bwpJbWFnZSBvYmplY3Qgd2hlbiBhbGwgaW1hZ2VzIGFyZSBsb2FkZWQgb3IgaGF2ZSBmYWlsZWQgbG9hZGluZy4KClRoZSBwbHVnaW4gc3VwcG9ydHMgdGhlc2Ugb3B0aW9uczoKCiAgICBzZXJpZXM6IHsKICAgICAgICBpbWFnZXM6IHsKICAgICAgICAgICAgc2hvdzogYm9vbGVhbgogICAgICAgICAgICBhbmNob3I6ICJjb3JuZXIiIG9yICJjZW50ZXIiCiAgICAgICAgICAgIGFscGhhOiBbIDAsIDEgXQogICAgICAgIH0KICAgIH0KClRoZXkgY2FuIGJlIHNwZWNpZmllZCBmb3IgYSBzcGVjaWZpYyBzZXJpZXM6CgogICAgJC5wbG90KCAkKCIjcGxhY2Vob2xkZXIiKSwgW3sKICAgICAgICBkYXRhOiBbIC4uLiBdLAogICAgICAgIGltYWdlczogeyAuLi4gfQogICAgXSkKCk5vdGUgdGhhdCBiZWNhdXNlIHRoZSBkYXRhIGZvcm1hdCBpcyBkaWZmZXJlbnQgZnJvbSB1c3VhbCBkYXRhIHBvaW50cywgeW91CmNhbid0IHVzZSBpbWFnZXMgd2l0aCBhbnl0aGluZyBlbHNlIGluIGEgc3BlY2lmaWMgZGF0YSBzZXJpZXMuCgpTZXR0aW5nICJhbmNob3IiIHRvICJjZW50ZXIiIGNhdXNlcyB0aGUgcGl4ZWxzIGluIHRoZSBpbWFnZSB0byBiZSBhbmNob3JlZCBhdAp0aGUgY29ybmVyIHBpeGVsIGNlbnRlcnMgaW5zaWRlIG9mIGF0IHRoZSBwaXhlbCBjb3JuZXJzLCBlZmZlY3RpdmVseSBsZXR0aW5nCmhhbGYgYSBwaXhlbCBzdGljayBvdXQgdG8gZWFjaCBzaWRlIGluIHRoZSBwbG90LgoKQSBwb3NzaWJsZSBmdXR1cmUgZGlyZWN0aW9uIGNvdWxkIGJlIHN1cHBvcnQgZm9yIHRpbGluZyBmb3IgbGFyZ2UgaW1hZ2VzIChsaWtlCkdvb2dsZSBNYXBzKS4KCiovCgooZnVuY3Rpb24gKCQpIHsKICAgIHZhciBvcHRpb25zID0gewogICAgICAgIHNlcmllczogewogICAgICAgICAgICBpbWFnZXM6IHsKICAgICAgICAgICAgICAgIHNob3c6IGZhbHNlLAogICAgICAgICAgICAgICAgYWxwaGE6IDEsCiAgICAgICAgICAgICAgICBhbmNob3I6ICJjb3JuZXIiIC8vIG9yICJjZW50ZXIiCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgICQucGxvdC5pbWFnZSA9IHt9OwoKICAgICQucGxvdC5pbWFnZS5sb2FkRGF0YUltYWdlcyA9IGZ1bmN0aW9uIChzZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHVybHMgPSBbXSwgcG9pbnRzID0gW107CgogICAgICAgIHZhciBkZWZhdWx0U2hvdyA9IG9wdGlvbnMuc2VyaWVzLmltYWdlcy5zaG93OwoKICAgICAgICAkLmVhY2goc2VyaWVzLCBmdW5jdGlvbiAoaSwgcykgewogICAgICAgICAgICBpZiAoIShkZWZhdWx0U2hvdyB8fCBzLmltYWdlcy5zaG93KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocy5kYXRhKSB7CiAgICAgICAgICAgICAgICBzID0gcy5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkLmVhY2gocywgZnVuY3Rpb24gKGksIHApIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcFswXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB1cmxzLnB1c2gocFswXSk7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRzLnB1c2gocCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAkLnBsb3QuaW1hZ2UubG9hZCh1cmxzLCBmdW5jdGlvbiAobG9hZGVkSW1hZ2VzKSB7CiAgICAgICAgICAgICQuZWFjaChwb2ludHMsIGZ1bmN0aW9uIChpLCBwKSB7CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gcFswXTsKICAgICAgICAgICAgICAgIGlmIChsb2FkZWRJbWFnZXNbdXJsXSkgewogICAgICAgICAgICAgICAgICAgIHBbMF0gPSBsb2FkZWRJbWFnZXNbdXJsXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgfQoKICAgICQucGxvdC5pbWFnZS5sb2FkID0gZnVuY3Rpb24gKHVybHMsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIG1pc3NpbmcgPSB1cmxzLmxlbmd0aCwgbG9hZGVkID0ge307CiAgICAgICAgaWYgKG1pc3NpbmcgPT09IDApIHsKICAgICAgICAgICAgY2FsbGJhY2soe30pOwogICAgICAgIH0KCiAgICAgICAgJC5lYWNoKHVybHMsIGZ1bmN0aW9uIChpLCB1cmwpIHsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAtLW1pc3Npbmc7CiAgICAgICAgICAgICAgICBsb2FkZWRbdXJsXSA9IHRoaXM7CgogICAgICAgICAgICAgICAgaWYgKG1pc3NpbmcgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhsb2FkZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJCgnPGltZyAvPicpLmxvYWQoaGFuZGxlcikuZXJyb3IoaGFuZGxlcikuYXR0cignc3JjJywgdXJsKTsKICAgICAgICB9KTsKICAgIH07CgogICAgZnVuY3Rpb24gZHJhd1NlcmllcyhwbG90LCBjdHgsIHNlcmllcykgewogICAgICAgIHZhciBwbG90T2Zmc2V0ID0gcGxvdC5nZXRQbG90T2Zmc2V0KCk7CgogICAgICAgIGlmICghc2VyaWVzLmltYWdlcyB8fCAhc2VyaWVzLmltYWdlcy5zaG93KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBwb2ludHMgPSBzZXJpZXMuZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgIHBzID0gc2VyaWVzLmRhdGFwb2ludHMucG9pbnRzaXplOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvaW50cy5sZW5ndGg7IGkgKz0gcHMpIHsKICAgICAgICAgICAgdmFyIGltZyA9IHBvaW50c1tpXSwKICAgICAgICAgICAgICAgIHgxID0gcG9pbnRzW2kgKyAxXSwgeTEgPSBwb2ludHNbaSArIDJdLAogICAgICAgICAgICAgICAgeDIgPSBwb2ludHNbaSArIDNdLCB5MiA9IHBvaW50c1tpICsgNF0sCiAgICAgICAgICAgICAgICB4YXhpcyA9IHNlcmllcy54YXhpcywgeWF4aXMgPSBzZXJpZXMueWF4aXMsCiAgICAgICAgICAgICAgICB0bXA7CgogICAgICAgICAgICAvLyBhY3R1YWxseSB3ZSBzaG91bGQgY2hlY2sgaW1nLmNvbXBsZXRlLCBidXQgaXQKICAgICAgICAgICAgLy8gYXBwZWFycyB0byBiZSBhIHNvbWV3aGF0IHVucmVsaWFibGUgaW5kaWNhdG9yIGluCiAgICAgICAgICAgIC8vIElFNiAoZmFsc2UgZXZlbiBhZnRlciBsb2FkIGV2ZW50KQogICAgICAgICAgICBpZiAoIWltZyB8fCBpbWcud2lkdGggPD0gMCB8fCBpbWcuaGVpZ2h0IDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoeDEgPiB4MikgewogICAgICAgICAgICAgICAgdG1wID0geDI7CiAgICAgICAgICAgICAgICB4MiA9IHgxOwogICAgICAgICAgICAgICAgeDEgPSB0bXA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHkxID4geTIpIHsKICAgICAgICAgICAgICAgIHRtcCA9IHkyOwogICAgICAgICAgICAgICAgeTIgPSB5MTsKICAgICAgICAgICAgICAgIHkxID0gdG1wOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB0aGUgYW5jaG9yIGlzIGF0IHRoZSBjZW50ZXIgb2YgdGhlIHBpeGVsLCBleHBhbmQgdGhlCiAgICAgICAgICAgIC8vIGltYWdlIGJ5IDEvMiBwaXhlbCBpbiBlYWNoIGRpcmVjdGlvbgogICAgICAgICAgICBpZiAoc2VyaWVzLmltYWdlcy5hbmNob3IgPT09ICJjZW50ZXIiKSB7CiAgICAgICAgICAgICAgICB0bXAgPSAwLjUgKiAoeDIgLSB4MSkgLyAoaW1nLndpZHRoIC0gMSk7CiAgICAgICAgICAgICAgICB4MSAtPSB0bXA7CiAgICAgICAgICAgICAgICB4MiArPSB0bXA7CiAgICAgICAgICAgICAgICB0bXAgPSAwLjUgKiAoeTIgLSB5MSkgLyAoaW1nLmhlaWdodCAtIDEpOwogICAgICAgICAgICAgICAgeTEgLT0gdG1wOwogICAgICAgICAgICAgICAgeTIgKz0gdG1wOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjbGlwCiAgICAgICAgICAgIGlmICh4MSA9PT0geDIgfHwgeTEgPT09IHkyIHx8CiAgICAgICAgICAgICAgICB4MSA+PSB4YXhpcy5tYXggfHwgeDIgPD0geGF4aXMubWluIHx8CiAgICAgICAgICAgICAgICB5MSA+PSB5YXhpcy5tYXggfHwgeTIgPD0geWF4aXMubWluKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHN4MSA9IDAsIHN5MSA9IDAsIHN4MiA9IGltZy53aWR0aCwgc3kyID0gaW1nLmhlaWdodDsKICAgICAgICAgICAgaWYgKHgxIDwgeGF4aXMubWluKSB7CiAgICAgICAgICAgICAgICBzeDEgKz0gKHN4MiAtIHN4MSkgKiAoeGF4aXMubWluIC0geDEpIC8gKHgyIC0geDEpOwogICAgICAgICAgICAgICAgeDEgPSB4YXhpcy5taW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh4MiA+IHhheGlzLm1heCkgewogICAgICAgICAgICAgICAgc3gyICs9IChzeDIgLSBzeDEpICogKHhheGlzLm1heCAtIHgyKSAvICh4MiAtIHgxKTsKICAgICAgICAgICAgICAgIHgyID0geGF4aXMubWF4OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoeTEgPCB5YXhpcy5taW4pIHsKICAgICAgICAgICAgICAgIHN5MiArPSAoc3kxIC0gc3kyKSAqICh5YXhpcy5taW4gLSB5MSkgLyAoeTIgLSB5MSk7CiAgICAgICAgICAgICAgICB5MSA9IHlheGlzLm1pbjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHkyID4geWF4aXMubWF4KSB7CiAgICAgICAgICAgICAgICBzeTEgKz0gKHN5MSAtIHN5MikgKiAoeWF4aXMubWF4IC0geTIpIC8gKHkyIC0geTEpOwogICAgICAgICAgICAgICAgeTIgPSB5YXhpcy5tYXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHgxID0geGF4aXMucDJjKHgxKTsKICAgICAgICAgICAgeDIgPSB4YXhpcy5wMmMoeDIpOwogICAgICAgICAgICB5MSA9IHlheGlzLnAyYyh5MSk7CiAgICAgICAgICAgIHkyID0geWF4aXMucDJjKHkyKTsKCiAgICAgICAgICAgIC8vIHRoZSB0cmFuc2Zvcm1hdGlvbiBtYXkgaGF2ZSBzd2FwcGVkIHVzCiAgICAgICAgICAgIGlmICh4MSA+IHgyKSB7CiAgICAgICAgICAgICAgICB0bXAgPSB4MjsKICAgICAgICAgICAgICAgIHgyID0geDE7CiAgICAgICAgICAgICAgICB4MSA9IHRtcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoeTEgPiB5MikgewogICAgICAgICAgICAgICAgdG1wID0geTI7CiAgICAgICAgICAgICAgICB5MiA9IHkxOwogICAgICAgICAgICAgICAgeTEgPSB0bXA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRtcCA9IGN0eC5nbG9iYWxBbHBoYTsKICAgICAgICAgICAgY3R4Lmdsb2JhbEFscGhhICo9IHNlcmllcy5pbWFnZXMuYWxwaGE7CiAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLAogICAgICAgICAgICAgICAgICAgICAgICAgIHN4MSwgc3kxLCBzeDIgLSBzeDEsIHN5MiAtIHN5MSwKICAgICAgICAgICAgICAgICAgICAgICAgICB4MSArIHBsb3RPZmZzZXQubGVmdCwgeTEgKyBwbG90T2Zmc2V0LnRvcCwKICAgICAgICAgICAgICAgICAgICAgICAgICB4MiAtIHgxLCB5MiAtIHkxKTsKICAgICAgICAgICAgY3R4Lmdsb2JhbEFscGhhID0gdG1wOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwcm9jZXNzUmF3RGF0YShwbG90LCBzZXJpZXMsIGRhdGEsIGRhdGFwb2ludHMpIHsKICAgICAgICBpZiAoIXNlcmllcy5pbWFnZXMuc2hvdykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBmb3JtYXQgaXMgSW1hZ2UsIHgxLCB5MSwgeDIsIHkyIChvcHBvc2l0ZSBjb3JuZXJzKQogICAgICAgIGRhdGFwb2ludHMuZm9ybWF0ID0gWwogICAgICAgICAgICB7IHJlcXVpcmVkOiB0cnVlIH0sCiAgICAgICAgICAgIHsgeDogdHJ1ZSwgbnVtYmVyOiB0cnVlLCByZXF1aXJlZDogdHJ1ZSB9LAogICAgICAgICAgICB7IHk6IHRydWUsIG51bWJlcjogdHJ1ZSwgcmVxdWlyZWQ6IHRydWUgfSwKICAgICAgICAgICAgeyB4OiB0cnVlLCBudW1iZXI6IHRydWUsIHJlcXVpcmVkOiB0cnVlIH0sCiAgICAgICAgICAgIHsgeTogdHJ1ZSwgbnVtYmVyOiB0cnVlLCByZXF1aXJlZDogdHJ1ZSB9CiAgICAgICAgXTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbml0KHBsb3QpIHsKICAgICAgICBwbG90Lmhvb2tzLnByb2Nlc3NSYXdEYXRhLnB1c2gocHJvY2Vzc1Jhd0RhdGEpOwogICAgICAgIHBsb3QuaG9va3MuZHJhd1Nlcmllcy5wdXNoKGRyYXdTZXJpZXMpOwogICAgfQoKICAgICQucGxvdC5wbHVnaW5zLnB1c2goewogICAgICAgIGluaXQ6IGluaXQsCiAgICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgICBuYW1lOiAnaW1hZ2UnLAogICAgICAgIHZlcnNpb246ICcxLjEnCiAgICB9KTsKfSkoalF1ZXJ5KTsK"></script>
  <link rel="stylesheet" type="text/css" href="data:text/css,%2Eflot%2D1%2D1%20%7B%0Aposition%3A%20relative%3B%0Awidth%3A%20100%25%3B%0Abox%2Dsizing%3A%20content%2Dbox%20%21important%3B%0Apadding%2Dtop%3A%20100%25%20%21important%3B%0A%7D%0A%2Eflot%2D4%2D3%20%7B%0Aposition%3A%20relative%3B%0Awidth%3A%20100%25%3B%0Abox%2Dsizing%3A%20content%2Dbox%20%21important%3B%0Apadding%2Dtop%3A%2075%25%20%21important%3B%0A%7D%0A%2Eflot%2D3%2D2%20%7B%0Aposition%3A%20relative%3B%0Awidth%3A%20100%25%3B%0Abox%2Dsizing%3A%20content%2Dbox%20%21important%3B%0Apadding%2Dtop%3A%2066%2E66%25%20%21important%3B%0A%7D%0A%2Eflot%2D8%2D5%20%7B%0Aposition%3A%20relative%3B%0Awidth%3A%20100%25%3B%0Abox%2Dsizing%3A%20content%2Dbox%20%21important%3B%0Apadding%2Dtop%3A%2062%2E5%25%20%21important%3B%0A%7D%0A%2Eflot%2D16%2D9%20%7B%0Aposition%3A%20relative%3B%0Awidth%3A%20100%25%3B%0Abox%2Dsizing%3A%20content%2Dbox%20%21important%3B%0Apadding%2Dtop%3A%2056%2E25%25%20%21important%3B%0A%7D%0A%2Eflot%2Dplot%20%7B%0Awidth%3A%20100%25%3B%0Aheight%3A%20100%25%3B%0Aposition%3A%20absolute%3B%0Atop%3A%200%3B%0Aleft%3A%200%3B%0Abottom%3A%200%3B%0Aright%3A%200%3B%0A%7D%0A%2Eflot%2Dlegend%20%2ElegendLayer%20%2Ebackground%20%7B%0Afill%3A%20rgba%28255%2C%20255%2C%20255%2C%200%2E85%29%3B%0Astroke%3A%20rgba%280%2C%200%2C%200%2C%200%2E85%29%3B%0Astroke%2Dwidth%3A%201%3B%0A%7D%0A%2Elegend%20%2ElegendLayer%20%2Ebackground%20%7B%0Afill%3A%20rgba%28255%2C%20255%2C%20255%2C%200%2E85%29%3B%0Astroke%3A%20rgba%280%2C%200%2C%200%2C%200%2E85%29%3B%0Astroke%2Dwidth%3A%201%3B%0A%7D%0A%2Eflot%2Dchoice%20%7B%0A%7D%0A">
  <script language="javascript" type="text/javascript" src="data:application/javascript;base64,ZnVuY3Rpb24gZmxvdF9wbG90KGlkLCBkYXRhKQp7CglpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpKSBwaWQgPSBpZDsKCWVsc2UgcGlkID0gaWQgKyAiLWR1bW15IjsKCWlmIChkYXRhKSAkWyJwbG90XyIgKyBpZF0gPSAkLnBsb3QoIiMiICsgcGlkLCBkYXRhLCAkWyJvcHRfIiArIGlkXSk7CgllbHNlICRbInBsb3RfIiArIGlkXSA9ICQucGxvdCgiIyIgKyBwaWQsICRbImRhdGFfIiArIGlkXSwgJFsib3B0XyIgKyBpZF0pOwoJJCgiIyIgKyBpZCArICItZHVtbXkiKS5jc3MoeyJkaXNwbGF5IjogIm5vbmUifSk7Cn0KCmZ1bmN0aW9uIGZsb3RfaW5pdChpZCwgZGF0YSwgbHBvcywgbGNvbHMsIHh0aWNrcykKewoJJFsiZGF0YV8iICsgaWRdID0gZGF0YTsKCSRbIm9wdF8iICsgaWRdID0gewoJCQl6b29tOntpbnRlcmFjdGl2ZTp0cnVlfSwKCQkJcGFuOntpbnRlcmFjdGl2ZTp0cnVlLGVuYWJsZVRvdWNoOnRydWV9LAoJCQlncmlkOntob3ZlcmFibGU6dHJ1ZSxjbGlja2FibGU6dHJ1ZX0sCgkJCXhheGlzOnt0aWNrczp4dGlja3N9LAoJfTsKCglpZiAobHBvcyA9PSBudWxsKSAkWyJvcHRfIiArIGlkXVsibGVnZW5kIl0gPSB7c2hvdzpmYWxzZX07CgllbHNlIGlmICgibncgbmUgc3cgc2UiLmluZGV4T2YobHBvcykgPiAtMSkgJFsib3B0XyIgKyBpZF1bImxlZ2VuZCJdID0ge3Nob3c6dHJ1ZSxwb3NpdGlvbjpscG9zLG5vQ29sdW1uczpsY29sc307CgllbHNlICRbIm9wdF8iICsgaWRdWyJsZWdlbmQiXSA9IHtzaG93OnRydWUsY29udGFpbmVyOiQoIiMiICsgaWQgKyAiLWxlZ2VuZCIpLmdldCgwKSxub0NvbHVtbnM6bGNvbHN9OwoKCWxldCBjYyA9ICQoIiMiICsgaWQgKyAiLWNob2ljZSIpOwoJaWYgKGNjKQoJewoJCXRleHQgPSAiIjsKCQkkLmVhY2goJFsiZGF0YV8iICsgaWRdLCBmdW5jdGlvbihrZXksIHZhbCkgewoJCQljYy5hcHBlbmQoIjxpbnB1dCB0eXBlPSdjaGVja2JveCcgbmFtZT0nIiArIGlkICsgIi0iICsga2V5ICsKCQkJIicgY2hlY2tlZD0nY2hlY2tlZCcgaWQ9JyIgKyBpZCArICItIiArIGtleSArICInPjwvaW5wdXQ+IiArCgkJCSI8bGFiZWwgZm9yPSciICsgaWQgKyAiLSIgKyBrZXkgKyAiJz4iICsgdmFsLmxhYmVsICsgIjwvbGFiZWw+Iik7CgkJfSk7CgkJY2MuZmluZCgiaW5wdXQiKS5jbGljayhmdW5jdGlvbiAoKSB7IGZsb3RfY2hvaWNlKGlkKTsgfSk7Cgl9CgoJZmxvdF9wbG90KGlkKTsKfQoKZnVuY3Rpb24gZmxvdF9jaG9pY2UoaWQpCnsKCWxldCBkYXRhID0gJFsiZGF0YV8iICsgaWRdOwoJbGV0IG5ld2QgPSBbXTsKCWxldCBjYyA9ICQoIiMiICsgaWQgKyAiLWNob2ljZSIpOwoJY2MuZmluZCgiaW5wdXQ6Y2hlY2tlZCIpLmVhY2goZnVuY3Rpb24gKCkgewoJCWxldCBrZXkgPSAkKHRoaXMpLmF0dHIoIm5hbWUiKS5zcGxpdCgiLSIpLmF0KC0xKTsKCQlpZiAoa2V5ICYmIGRhdGFba2V5XSkgbmV3ZC5wdXNoKGRhdGFba2V5XSk7Cgl9KTsKCWlmIChuZXdkLmxlbmd0aCA+IDApIGZsb3RfcGxvdChpZCwgbmV3ZCk7Cn0K"></script>
</head>
<body>
<header id="title-block-header">
<h1 class="title"><code>fmtplot</code>: Format Code for Plots in <code>pdf</code> and <code>html</code> Output</h1>
<p class="author">lehmann7</p>
<p class="date">2021-09-07</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#prerequirements"><span class="toc-section-number">1</span> Prerequirements</a></li>
<li><a href="#plot-generation"><span class="toc-section-number">2</span> Plot Generation</a></li>
<li><a href="#plot-legend"><span class="toc-section-number">3</span> Plot Legend</a></li>
<li><a href="#plot-example"><span class="toc-section-number">4</span> Plot Example</a></li>
<li><a href="#html-choice-placement"><span class="toc-section-number">5</span> HTML Choice Placement</a></li>
<li><a href="#java-script-placement"><span class="toc-section-number">6</span> Java Script Placement</a></li>
</ul>
</nav>
<hr />
<blockquote>
<p><strong>Abstract</strong>– <code>fmtplot</code> is a format code, which produces interactive plots for <code>html</code> using <a href="https://www.flotcharts.org"><code>flot</code></a> and static plots for <code>pdf</code> using <a href="https://www.matplotlib.org/"><code>matplotlib</code></a>. Plots are generated using a <code>marky</code> format code with a class <code>fmtplot</code> which implements plot and code generation for both cases. The plots which are generated using <code>fmtplot</code> can be referenced using <code>pandoc-fignos</code>.</p>
</blockquote>
<hr />
<h1 data-number="1" id="prerequirements"><span class="header-section-number">1</span> Prerequirements</h1>
<p>In order to the <code>fmtplot</code> with <code>html</code> output, JavaScript libraries have to be downloaded using.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">cd</span> data</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">./get_fmtplotjs</span></span></code></pre></div>
<p>The script download the following files:</p>
<pre class="text"><code>    jquery.canvaswrapper.js
    jquery.colorhelpers.js
    jquery.event.drag.js
    jquery.flot.browser.js
    jquery.flot.drawSeries.js
    jquery.flot.hover.js
    jquery.flot.image.js
    jquery.flot.js
    jquery.flot.legend.js
    jquery.flot.navigate.js
    jquery.flot.resize.js
    jquery.flot.saturated.js
    jquery.flot.selection.js
    jquery.flot.symbol.js
    jquery.flot.touch.js
    jquery.flot.touchNavigate.js
    jquery.flot.uiConstants.js
    jquery.js
    jquery.mousewheel.js</code></pre>
<hr />
<h1 data-number="2" id="plot-generation"><span class="header-section-number">2</span> Plot Generation</h1>
<p>Plots are prepared by calling the class <code>fmtplot</code> together with for the classes <code>fmtplot_flot</code> for <code>html</code> and <code>fmtplot_mplt</code> for <code>pdf</code>. The format code has the following arguments.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>    pltdat <span class="op">=</span> fmtplot(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>        html<span class="op">=</span>fmtplot_flot(aspect<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">9</span>)),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        pdf<span class="op">=</span>fmtplot_mplt(figdir<span class="op">=</span><span class="st">&quot;data&quot;</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">9</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>            figdpi<span class="op">=</span><span class="dv">200</span>, fontsize<span class="op">=</span><span class="st">&quot;11pt&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p><code>aspect</code> specifies the aspect of a full-width plot for <code>html</code> output. for <code>pdf</code> output <code>figdir</code> specifies the directory for figure output <code>build/&lt;figdir&gt;/</code>, <code>fisize</code> is the size of the figure in <code>cm</code> and <code>figdpi</code> and <code>fontsize</code> specify DPI number and the font size in <code>pt</code>.</p>
<p>In order to init Fig. <a href="#fig:plot1">1</a> for output, the format code</p>
<blockquote>
<p><code>setup(figid, data, label, style, color)</code></p>
</blockquote>
<p>is called with the corresponding arguments.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>    _(pltdat.setup(<span class="st">&quot;plot1&quot;</span>, data<span class="op">=</span>data, label<span class="op">=</span>label,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        style<span class="op">=</span>style, color<span class="op">=</span>color))</span></code></pre></div>
<p><strong>Figure Identifier</strong></p>
<p><code>figid</code> is the identifier of the figure, used for internal referencing and referencing inside the document. For <code>pdf</code> documents the <code>figid</code> also is used for the image filename <code>build/&lt;figdir&gt;/&lt;figid&gt;.png</code>.</p>
<p><strong>Plot Data</strong></p>
<p>Plot <code>data</code> is specified in two sequences containing <code>x</code> and <code>y</code> values of point coordinates.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    x1 <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">0</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    x2 <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    x3 <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    x4 <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    x5 <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">5</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    x6 <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">6</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    y1 <span class="op">=</span> <span class="dv">40</span><span class="op">*</span>np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">4</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    y2 <span class="op">=</span> <span class="dv">30</span><span class="op">*</span>np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">5</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    y3 <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">6</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    y4 <span class="op">=</span> <span class="dv">10</span><span class="op">*</span>np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">7</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    y5 <span class="op">=</span> <span class="dv">10</span><span class="op">*</span>np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">8</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    y6 <span class="op">=</span> <span class="dv">10</span><span class="op">*</span>np.array(<span class="bu">range</span>(<span class="dv">10</span>)) <span class="op">+</span> <span class="dv">9</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>[</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        (x1, y1),</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        (x2, y2),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        (x3, y3),</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        (x4, y4),</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        (x5, y5),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        (x6, y6)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
<p><strong>Plot Labels</strong></p>
<p>For each data sequence <code>(x, y)</code> the label is specified in a list. A sequence with the label <code>None</code> does not appear in the legend and in the <code>html</code> choices.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span>[</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Label for (x1, y1)&quot;</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Label for (x2, y2)&quot;</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Label for (x3, y3)&quot;</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Label for (x4, y4)&quot;</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Label for (x5, y5)&quot;</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Label for (x6, y6)&quot;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
<p><strong>Plot Style</strong></p>
<p>For each data sequence <code>(x, y)</code> the style is specified in a list. The style for one sequence is a tuple where the first element is the <code>styleid</code> identifier string and the other elements are arguments <code>argN</code> for the <code>styleid</code>s in the order of the identifiers in the string.</p>
<ul>
<li><code>(&quot;&lt;styleid&gt;&quot;, &lt;arg1&gt;)</code></li>
<li><code>(&quot;&lt;styleid&gt;&lt;styleid&gt;&quot;, &lt;arg1&gt;, &lt;arg2&gt;)</code></li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>    style<span class="op">=</span>[</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>        ( <span class="st">&quot;^&quot;</span>, <span class="dv">11</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        ( <span class="st">&quot;o&quot;</span>, <span class="dv">11</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        ( <span class="st">&quot;s&quot;</span>, <span class="dv">11</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;DL&quot;</span>, <span class="dv">11</span>, <span class="dv">2</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;+L&quot;</span>, <span class="dv">11</span>, <span class="dv">2</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;xB&quot;</span>, <span class="dv">11</span>, <span class="fl">0.5</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
<p>The styles can be combined <code>Lo</code>, <code>^B</code>, <code>DLB</code> in order to annotate lines and bars with points. There are as many arguments as chars in the <code>&lt;styleid&gt;</code> string. The following markers <code>^osD+x</code> can be used for points in <code>&lt;styleid&gt;</code>. Ths is a subset of the <a href="https://matplotlib.org/stable/api/markers_api.html"><code>matplotlib</code> markers</a>. which is supported by <code>flot</code>. <code>lines</code> and <code>bars</code> are specified using <code>B</code> and <code>L</code>. Table <a href="#tbl:styleid">1</a> summarizes the style specification.</p>
<div id="tbl:styleid" class="tablenos">
<table id="tbl:styleid">
<caption><span>Table 1:</span> List of style identifier strings <code>&lt;styleid&gt;</code> and corresponding arguments. The bar width is specified relative to the minimum distance between neighbouring <code>x</code> points in the data sequence. </caption>
<colgroup>
<col style="width: 30%" />
<col style="width: 47%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>&lt;styleid&gt;</code></th>
<th style="text-align: center;">shape (symbol)</th>
<th>argumet</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>o</code></td>
<td style="text-align: center;">points (circle)</td>
<td>point size in <code>pt</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>s</code></td>
<td style="text-align: center;">points (square)</td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>D</code></td>
<td style="text-align: center;">points (diamond)</td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>^</code></td>
<td style="text-align: center;">points (triangle)</td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>x</code></td>
<td style="text-align: center;">points (cross)</td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;">points (plus)</td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>L</code></td>
<td style="text-align: center;">lines</td>
<td>line width in <code>pt</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>B</code></td>
<td style="text-align: center;">bars</td>
<td>relative bar width</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Plot Color</strong></p>
<p>For each data sequence <code>(x, y)</code> the color for lines and points is specified in a list.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>[</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#ff0000&quot;</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#00ff00&quot;</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#0000ff&quot;</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#ff00ff&quot;</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#00ffff&quot;</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#000000&quot;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
<p><strong>Plot Output in Document</strong></p>
<p>The format code <code>show(figid, caption=&quot;...&quot;)</code> places Fig. <a href="#fig:plot1">1</a> in the document using the settings decribed above. Additionally the argument <code>caption=&quot;...&quot;</code> is used for setting the figure caption. The figure Fig. <a href="#fig:plot1">1</a> is referenced by appending <code>fig:</code> to the <code>figid</code> using the keyword @<code>fig:plot1</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    _(pltdat.setup(<span class="st">&quot;plot1&quot;</span>, data, label<span class="op">=</span>label, style<span class="op">=</span>style, color<span class="op">=</span>color))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    _(pltdat.show(<span class="st">&quot;plot1&quot;</span>, <span class="st">&quot;&quot;&quot;This figure is generated using the format code</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">    fmtplot.plot(...) with the arguments data, label, style, color</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="st">    described above. The figure caption is set using the argument caption.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span>))</span></code></pre></div>
<div id="flot-plot1-dummy" class="flot-plot">

</div>
<div id="fig:plot1" class="fignos">
<figure>
<div class="flot-16-9">
<div id="flot-plot1" class="flot-plot">

</div>
</div>
<figcaption>
<p><span>Figure 1:</span> This figure is generated using the format code fmtplot.plot(…) with the arguments data, label, style, color described above. The figure caption is set using the argument caption.</p>
</figcaption>
</figure>
</div>
<hr />
<h1 data-number="3" id="plot-legend"><span class="header-section-number">3</span> Plot Legend</h1>
<p>By default <code>fmtplot</code> hides the legend. The legend can be placed outside of the plot in a separate canvas/image or inside the plot. In order to configure the legend the arguments <code>legpos</code> and <code>legcols</code> of the format code constructor are used. <code>legcols</code> specifies the number of columns in the legend and <code>legpos</code> specifies the legend position using the following values.</p>
<ul>
<li><code>None</code>: do not show legend</li>
<li><code>&quot;out&quot;</code>: show legend in separate image using <code>fmtplot.legend(figid)</code></li>
<li><code>&quot;nw&quot;</code>: show legend in upper left corner</li>
<li><code>&quot;ne&quot;</code>: show legend in upper right corner</li>
<li><code>&quot;sw&quot;</code>: show legend in lower left corner</li>
<li><code>&quot;se&quot;</code>: show legend in lower right corner</li>
</ul>
<p><strong>Legend In Plot</strong></p>
<p>A legend in figures is specified using one of the keywords <code>nw</code>, <code>ne</code>, <code>sw</code> or <code>se</code> for <code>legpos</code>. In Fig. <a href="#fig:plot2">2</a>, the legendis placed in the upper right corner using <code>nw</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    legin <span class="op">=</span> fmtplot(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>        html<span class="op">=</span>fmtplot_flot(legpos<span class="op">=</span><span class="st">&quot;nw&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        pdf<span class="op">=</span>fmtplot_mplt(legpos<span class="op">=</span><span class="st">&quot;nw&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    _(legin.setup(<span class="st">&quot;plot2&quot;</span>, data, label<span class="op">=</span>label, style<span class="op">=</span>style, color<span class="op">=</span>color))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    _(legin.show(<span class="st">&quot;plot2&quot;</span>, <span class="st">&quot;&quot;&quot;This plot is generated with legend inside</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">    the plot using legpos as one of nw, ne, sw, se and with 2 columns</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="st">    using legcols=2.&quot;&quot;&quot;</span>))</span></code></pre></div>
<div id="flot-plot2-dummy" class="flot-plot">

</div>
<div id="fig:plot2" class="fignos">
<figure>
<div class="flot-16-9">
<div id="flot-plot2" class="flot-plot">

</div>
</div>
<figcaption>
<span>Figure 2:</span> This plot is generated with legend inside the plot using legpos as one of nw, ne, sw, se and with 2 columns using legcols=2.
</figcaption>
</figure>
</div>
<p><strong>Separate Legend</strong></p>
<p>A legend in a separate image is specified using the keyword <code>out</code>. Fig. <a href="#fig:plot3">3</a> has a separate legend given in Fig. <a href="#fig:plot3-legend">4</a>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>    legout <span class="op">=</span> fmtplot(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>        html<span class="op">=</span>fmtplot_flot(legpos<span class="op">=</span><span class="st">&quot;out&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        pdf<span class="op">=</span>fmtplot_mplt(legpos<span class="op">=</span><span class="st">&quot;out&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    _(legout.setup(<span class="st">&quot;plot3&quot;</span>, data, label<span class="op">=</span>label, style<span class="op">=</span>style, color<span class="op">=</span>color))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    _(legout.show(<span class="st">&quot;plot3&quot;</span>, <span class="st">&quot;&quot;&quot;This plot is generated with separate legend</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">    using legpos=out and with 2 columns using legcols=2.&quot;&quot;&quot;</span>))</span></code></pre></div>
<div id="flot-plot3-dummy" class="flot-plot">

</div>
<div id="fig:plot3" class="fignos">
<figure>
<div class="flot-16-9">
<div id="flot-plot3" class="flot-plot">

</div>
</div>
<figcaption>
<span>Figure 3:</span> This plot is generated with separate legend using legpos=out and with 2 columns using legcols=2.
</figcaption>
</figure>
</div>
<p><strong>Placement of Separate Legend</strong></p>
<p>In order to place the separate legend for Fig. <a href="#fig:plot3">3</a>, the <code>legend(figid, caption=&quot;...&quot;)</code> format code is called. The figure Fig. <a href="#fig:plot3">3</a> is referenced by appending <code>fig:</code> to the <code>figid</code> using the keyword @<code>fig:plot3</code>. The legend in Fig. <a href="#fig:plot3-legend">4</a> is referenced by additionally appending <code>-legend</code> using the keyword @<code>fig:plot3-legend</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>    _(legout.legend(<span class="st">&quot;plot3&quot;</span>, caption<span class="op">=</span><span class="st">&quot;&quot;&quot;This is the legend for @fig:plot3.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="st">    It was placed using the format code fmtplot.legend(figid, caption).&quot;&quot;&quot;</span>))</span></code></pre></div>
<div id="fig:plot3-legend" class="fignos">
<figure>
<div id="flot-plot3-legend" class="flot-legend">

</div>
<figcaption>
<span>Figure 4:</span> This is the legend for Fig. <a href="#fig:plot3">3</a>. It was placed using the format code fmtplot.legend(figid, caption).
</figcaption>
</figure>
</div>
<hr />
<h1 data-number="4" id="plot-example"><span class="header-section-number">4</span> Plot Example</h1>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>    ex <span class="op">=</span> fmtplot(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>        html<span class="op">=</span>fmtplot_flot(legpos<span class="op">=</span><span class="st">&quot;out&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        pdf<span class="op">=</span>fmtplot_mplt(legpos<span class="op">=</span><span class="st">&quot;out&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    _(ex.setup(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;plotex&quot;</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            (x1, y1), (x2, y2),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>            (x3, y3), (x4, y4)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span>[</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Label for (x1, y1)&quot;</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Label for (x2, y2)&quot;</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Label for (x3, y3)&quot;</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">None</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        style<span class="op">=</span>[</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;o&quot;</span>, <span class="dv">11</span>),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;L&quot;</span>, <span class="dv">2</span>),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;LD&quot;</span>, <span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;Bo&quot;</span>, <span class="fl">0.5</span>, <span class="dv">10</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>[</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;#ff0000&quot;</span>,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;#00ff00&quot;</span>,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;#0000ff&quot;</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;#000000&quot;</span>,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    ))</span></code></pre></div>
<div id="flot-plotex-dummy" class="flot-plot">

</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>    _(ex.show(<span class="st">&quot;plotex&quot;</span>, <span class="st">&quot;&quot;&quot;This plot is generated.&quot;&quot;&quot;</span>))</span></code></pre></div>
<div id="fig:plotex" class="fignos">
<figure>
<div class="flot-16-9">
<div id="flot-plotex" class="flot-plot">

</div>
</div>
<figcaption>
<span>Figure 5:</span> This plot is generated.
</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>    _(ex.legend(<span class="st">&quot;plotex&quot;</span>, caption<span class="op">=</span><span class="st">&quot;&quot;&quot;This is the legend for @fig:plotex.&quot;&quot;&quot;</span>))</span></code></pre></div>
<div id="fig:plotex-legend" class="fignos">
<figure>
<div id="flot-plotex-legend" class="flot-legend">

</div>
<figcaption>
<span>Figure 6:</span> This is the legend for Fig. <a href="#fig:plotex">5</a>.
</figcaption>
</figure>
</div>
<hr />
<h1 data-number="5" id="html-choice-placement"><span class="header-section-number">5</span> HTML Choice Placement</h1>
<p><code>html</code> output supports interactive plots with zooming and paning and enabling and disabling the plot entities using checkboxes. The is feature is demonstrated in Fig. <a href="#fig:plot4">7</a>. The checkboxes are located below the figure.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>    choice <span class="op">=</span> fmtplot(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>        html<span class="op">=</span>fmtplot_flot(legpos<span class="op">=</span><span class="st">&quot;ne&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        pdf<span class="op">=</span>fmtplot_mplt(legpos<span class="op">=</span><span class="st">&quot;ne&quot;</span>, legcols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    _(choice.setup(<span class="st">&quot;plot4&quot;</span>, data, label<span class="op">=</span>label, style<span class="op">=</span>style, color<span class="op">=</span>color))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    _(choice.show(<span class="st">&quot;plot4&quot;</span>, <span class="st">&quot;&quot;&quot;This plot is used together with the format</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">    code fmtplot.choice(figid). For html output, a list of checkboxes is</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="st">    generated inside a div-tag. For pdf no output is generated.&quot;&quot;&quot;</span>))</span></code></pre></div>
<div id="flot-plot4-dummy" class="flot-plot">

</div>
<div id="fig:plot4" class="fignos">
<figure>
<div class="flot-16-9">
<div id="flot-plot4" class="flot-plot">

</div>
</div>
<figcaption>
<span>Figure 7:</span> This plot is used together with the format code fmtplot.choice(figid). For html output, a list of checkboxes is generated inside a div-tag. For pdf no output is generated.
</figcaption>
</figure>
</div>
<p>In order to place the choice checkboxes for Fig. <a href="#fig:plot4">7</a>, the <code>choice(figid)</code> format code is used. The checkboxes are placed inside a <code>&lt;div&gt;</code> tag. For <code>pdf</code> output there no choice is displayed.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>    _(choice.choice(<span class="st">&quot;plot4&quot;</span>))</span></code></pre></div>
<div id="flot-plot4-choice" class="flot-choice">

</div>
<hr />
<h1 data-number="6" id="java-script-placement"><span class="header-section-number">6</span> Java Script Placement</h1>
<p><code>html</code> requires the placement of JavaScript which contains the plot data and setup code for the plots. The JavaScript is inserted into <code>html</code> documents using the the format code <code>fmtplot.script()</code>. JavaScripts have to be placed at the end of the document. For <code>pdf</code> no output is generated.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>    _(pltdat.script())</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    _(ex.script())</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    _(legin.script())</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    _(legout.script())</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    _(choice.script())</span></code></pre></div>
<script>flot_init("flot-plot1", [{data:[[0.000000e+00,4.000000e+00],[1.000000e+00,4.400000e+01],[2.000000e+00,8.400000e+01],[3.000000e+00,1.240000e+02],[4.000000e+00,1.640000e+02],[5.000000e+00,2.040000e+02],[6.000000e+00,2.440000e+02],[7.000000e+00,2.840000e+02],[8.000000e+00,3.240000e+02],[9.000000e+00,3.640000e+02]],points:{show:true,radius:5.500000e+00,symbol:'triangle'},label:'Label for (x1, y1)',color:'#ff0000',},{data:[[1.000000e+00,5.000000e+00],[2.000000e+00,3.500000e+01],[3.000000e+00,6.500000e+01],[4.000000e+00,9.500000e+01],[5.000000e+00,1.250000e+02],[6.000000e+00,1.550000e+02],[7.000000e+00,1.850000e+02],[8.000000e+00,2.150000e+02],[9.000000e+00,2.450000e+02],[1.000000e+01,2.750000e+02]],points:{show:true,radius:5.500000e+00,symbol:'circle'},label:'Label for (x2, y2)',color:'#00ff00',},{data:[[2.000000e+00,6.000000e+00],[3.000000e+00,2.600000e+01],[4.000000e+00,4.600000e+01],[5.000000e+00,6.600000e+01],[6.000000e+00,8.600000e+01],[7.000000e+00,1.060000e+02],[8.000000e+00,1.260000e+02],[9.000000e+00,1.460000e+02],[1.000000e+01,1.660000e+02],[1.100000e+01,1.860000e+02]],points:{show:true,radius:5.500000e+00,symbol:'square'},label:'Label for (x3, y3)',color:'#0000ff',},{data:[[3.000000e+00,7.000000e+00],[4.000000e+00,1.700000e+01],[5.000000e+00,2.700000e+01],[6.000000e+00,3.700000e+01],[7.000000e+00,4.700000e+01],[8.000000e+00,5.700000e+01],[9.000000e+00,6.700000e+01],[1.000000e+01,7.700000e+01],[1.100000e+01,8.700000e+01],[1.200000e+01,9.700000e+01]],points:{show:true,radius:5.500000e+00,symbol:'diamond'},lines:{show:true,lineWidth:2},label:'Label for (x4, y4)',color:'#ff00ff',},{data:[[5.000000e+00,8.000000e+00],[6.000000e+00,1.800000e+01],[7.000000e+00,2.800000e+01],[8.000000e+00,3.800000e+01],[9.000000e+00,4.800000e+01],[1.000000e+01,5.800000e+01],[1.100000e+01,6.800000e+01],[1.200000e+01,7.800000e+01],[1.300000e+01,8.800000e+01],[1.400000e+01,9.800000e+01]],points:{show:true,radius:5.500000e+00,symbol:'plus'},lines:{show:true,lineWidth:2},label:'Label for (x5, y5)',color:'#00ffff',},{data:[[6.000000e+00,9.000000e+00],[7.000000e+00,1.900000e+01],[8.000000e+00,2.900000e+01],[9.000000e+00,3.900000e+01],[1.000000e+01,4.900000e+01],[1.100000e+01,5.900000e+01],[1.200000e+01,6.900000e+01],[1.300000e+01,7.900000e+01],[1.400000e+01,8.900000e+01],[1.500000e+01,9.900000e+01]],points:{show:true,radius:5.500000e+00,symbol:'cross'},bars:{show:true,barWidth:0.5,align:'center'},label:'Label for (x6, y6)',color:'#000000',},], null, 1, null);
</script>
<script>flot_init("flot-plotex", [{data:[[0.000000e+00,4.000000e+00],[1.000000e+00,4.400000e+01],[2.000000e+00,8.400000e+01],[3.000000e+00,1.240000e+02],[4.000000e+00,1.640000e+02],[5.000000e+00,2.040000e+02],[6.000000e+00,2.440000e+02],[7.000000e+00,2.840000e+02],[8.000000e+00,3.240000e+02],[9.000000e+00,3.640000e+02]],points:{show:true,radius:5.500000e+00,symbol:'circle'},label:'Label for (x1, y1)',color:'#ff0000',},{data:[[1.000000e+00,5.000000e+00],[2.000000e+00,3.500000e+01],[3.000000e+00,6.500000e+01],[4.000000e+00,9.500000e+01],[5.000000e+00,1.250000e+02],[6.000000e+00,1.550000e+02],[7.000000e+00,1.850000e+02],[8.000000e+00,2.150000e+02],[9.000000e+00,2.450000e+02],[1.000000e+01,2.750000e+02]],lines:{show:true,lineWidth:2},label:'Label for (x2, y2)',color:'#00ff00',},{data:[[2.000000e+00,6.000000e+00],[3.000000e+00,2.600000e+01],[4.000000e+00,4.600000e+01],[5.000000e+00,6.600000e+01],[6.000000e+00,8.600000e+01],[7.000000e+00,1.060000e+02],[8.000000e+00,1.260000e+02],[9.000000e+00,1.460000e+02],[1.000000e+01,1.660000e+02],[1.100000e+01,1.860000e+02]],lines:{show:true,lineWidth:1},points:{show:true,radius:2.500000e+00,symbol:'diamond'},label:'Label for (x3, y3)',color:'#0000ff',},{data:[[3.000000e+00,7.000000e+00],[4.000000e+00,1.700000e+01],[5.000000e+00,2.700000e+01],[6.000000e+00,3.700000e+01],[7.000000e+00,4.700000e+01],[8.000000e+00,5.700000e+01],[9.000000e+00,6.700000e+01],[1.000000e+01,7.700000e+01],[1.100000e+01,8.700000e+01],[1.200000e+01,9.700000e+01]],bars:{show:true,barWidth:0.5,align:'center'},points:{show:true,radius:5.000000e+00,symbol:'circle'},label:null,color:'#000000',},], 'out', 2, null);
</script>
<script>flot_init("flot-plot2", [{data:[[0.000000e+00,4.000000e+00],[1.000000e+00,4.400000e+01],[2.000000e+00,8.400000e+01],[3.000000e+00,1.240000e+02],[4.000000e+00,1.640000e+02],[5.000000e+00,2.040000e+02],[6.000000e+00,2.440000e+02],[7.000000e+00,2.840000e+02],[8.000000e+00,3.240000e+02],[9.000000e+00,3.640000e+02]],points:{show:true,radius:5.500000e+00,symbol:'triangle'},label:'Label for (x1, y1)',color:'#ff0000',},{data:[[1.000000e+00,5.000000e+00],[2.000000e+00,3.500000e+01],[3.000000e+00,6.500000e+01],[4.000000e+00,9.500000e+01],[5.000000e+00,1.250000e+02],[6.000000e+00,1.550000e+02],[7.000000e+00,1.850000e+02],[8.000000e+00,2.150000e+02],[9.000000e+00,2.450000e+02],[1.000000e+01,2.750000e+02]],points:{show:true,radius:5.500000e+00,symbol:'circle'},label:'Label for (x2, y2)',color:'#00ff00',},{data:[[2.000000e+00,6.000000e+00],[3.000000e+00,2.600000e+01],[4.000000e+00,4.600000e+01],[5.000000e+00,6.600000e+01],[6.000000e+00,8.600000e+01],[7.000000e+00,1.060000e+02],[8.000000e+00,1.260000e+02],[9.000000e+00,1.460000e+02],[1.000000e+01,1.660000e+02],[1.100000e+01,1.860000e+02]],points:{show:true,radius:5.500000e+00,symbol:'square'},label:'Label for (x3, y3)',color:'#0000ff',},{data:[[3.000000e+00,7.000000e+00],[4.000000e+00,1.700000e+01],[5.000000e+00,2.700000e+01],[6.000000e+00,3.700000e+01],[7.000000e+00,4.700000e+01],[8.000000e+00,5.700000e+01],[9.000000e+00,6.700000e+01],[1.000000e+01,7.700000e+01],[1.100000e+01,8.700000e+01],[1.200000e+01,9.700000e+01]],points:{show:true,radius:5.500000e+00,symbol:'diamond'},lines:{show:true,lineWidth:2},label:'Label for (x4, y4)',color:'#ff00ff',},{data:[[5.000000e+00,8.000000e+00],[6.000000e+00,1.800000e+01],[7.000000e+00,2.800000e+01],[8.000000e+00,3.800000e+01],[9.000000e+00,4.800000e+01],[1.000000e+01,5.800000e+01],[1.100000e+01,6.800000e+01],[1.200000e+01,7.800000e+01],[1.300000e+01,8.800000e+01],[1.400000e+01,9.800000e+01]],points:{show:true,radius:5.500000e+00,symbol:'plus'},lines:{show:true,lineWidth:2},label:'Label for (x5, y5)',color:'#00ffff',},{data:[[6.000000e+00,9.000000e+00],[7.000000e+00,1.900000e+01],[8.000000e+00,2.900000e+01],[9.000000e+00,3.900000e+01],[1.000000e+01,4.900000e+01],[1.100000e+01,5.900000e+01],[1.200000e+01,6.900000e+01],[1.300000e+01,7.900000e+01],[1.400000e+01,8.900000e+01],[1.500000e+01,9.900000e+01]],points:{show:true,radius:5.500000e+00,symbol:'cross'},bars:{show:true,barWidth:0.5,align:'center'},label:'Label for (x6, y6)',color:'#000000',},], 'nw', 2, null);
</script>
<script>flot_init("flot-plot3", [{data:[[0.000000e+00,4.000000e+00],[1.000000e+00,4.400000e+01],[2.000000e+00,8.400000e+01],[3.000000e+00,1.240000e+02],[4.000000e+00,1.640000e+02],[5.000000e+00,2.040000e+02],[6.000000e+00,2.440000e+02],[7.000000e+00,2.840000e+02],[8.000000e+00,3.240000e+02],[9.000000e+00,3.640000e+02]],points:{show:true,radius:5.500000e+00,symbol:'triangle'},label:'Label for (x1, y1)',color:'#ff0000',},{data:[[1.000000e+00,5.000000e+00],[2.000000e+00,3.500000e+01],[3.000000e+00,6.500000e+01],[4.000000e+00,9.500000e+01],[5.000000e+00,1.250000e+02],[6.000000e+00,1.550000e+02],[7.000000e+00,1.850000e+02],[8.000000e+00,2.150000e+02],[9.000000e+00,2.450000e+02],[1.000000e+01,2.750000e+02]],points:{show:true,radius:5.500000e+00,symbol:'circle'},label:'Label for (x2, y2)',color:'#00ff00',},{data:[[2.000000e+00,6.000000e+00],[3.000000e+00,2.600000e+01],[4.000000e+00,4.600000e+01],[5.000000e+00,6.600000e+01],[6.000000e+00,8.600000e+01],[7.000000e+00,1.060000e+02],[8.000000e+00,1.260000e+02],[9.000000e+00,1.460000e+02],[1.000000e+01,1.660000e+02],[1.100000e+01,1.860000e+02]],points:{show:true,radius:5.500000e+00,symbol:'square'},label:'Label for (x3, y3)',color:'#0000ff',},{data:[[3.000000e+00,7.000000e+00],[4.000000e+00,1.700000e+01],[5.000000e+00,2.700000e+01],[6.000000e+00,3.700000e+01],[7.000000e+00,4.700000e+01],[8.000000e+00,5.700000e+01],[9.000000e+00,6.700000e+01],[1.000000e+01,7.700000e+01],[1.100000e+01,8.700000e+01],[1.200000e+01,9.700000e+01]],points:{show:true,radius:5.500000e+00,symbol:'diamond'},lines:{show:true,lineWidth:2},label:'Label for (x4, y4)',color:'#ff00ff',},{data:[[5.000000e+00,8.000000e+00],[6.000000e+00,1.800000e+01],[7.000000e+00,2.800000e+01],[8.000000e+00,3.800000e+01],[9.000000e+00,4.800000e+01],[1.000000e+01,5.800000e+01],[1.100000e+01,6.800000e+01],[1.200000e+01,7.800000e+01],[1.300000e+01,8.800000e+01],[1.400000e+01,9.800000e+01]],points:{show:true,radius:5.500000e+00,symbol:'plus'},lines:{show:true,lineWidth:2},label:'Label for (x5, y5)',color:'#00ffff',},{data:[[6.000000e+00,9.000000e+00],[7.000000e+00,1.900000e+01],[8.000000e+00,2.900000e+01],[9.000000e+00,3.900000e+01],[1.000000e+01,4.900000e+01],[1.100000e+01,5.900000e+01],[1.200000e+01,6.900000e+01],[1.300000e+01,7.900000e+01],[1.400000e+01,8.900000e+01],[1.500000e+01,9.900000e+01]],points:{show:true,radius:5.500000e+00,symbol:'cross'},bars:{show:true,barWidth:0.5,align:'center'},label:'Label for (x6, y6)',color:'#000000',},], 'out', 2, null);
</script>
<script>flot_init("flot-plot4", [{data:[[0.000000e+00,4.000000e+00],[1.000000e+00,4.400000e+01],[2.000000e+00,8.400000e+01],[3.000000e+00,1.240000e+02],[4.000000e+00,1.640000e+02],[5.000000e+00,2.040000e+02],[6.000000e+00,2.440000e+02],[7.000000e+00,2.840000e+02],[8.000000e+00,3.240000e+02],[9.000000e+00,3.640000e+02]],points:{show:true,radius:5.500000e+00,symbol:'triangle'},label:'Label for (x1, y1)',color:'#ff0000',},{data:[[1.000000e+00,5.000000e+00],[2.000000e+00,3.500000e+01],[3.000000e+00,6.500000e+01],[4.000000e+00,9.500000e+01],[5.000000e+00,1.250000e+02],[6.000000e+00,1.550000e+02],[7.000000e+00,1.850000e+02],[8.000000e+00,2.150000e+02],[9.000000e+00,2.450000e+02],[1.000000e+01,2.750000e+02]],points:{show:true,radius:5.500000e+00,symbol:'circle'},label:'Label for (x2, y2)',color:'#00ff00',},{data:[[2.000000e+00,6.000000e+00],[3.000000e+00,2.600000e+01],[4.000000e+00,4.600000e+01],[5.000000e+00,6.600000e+01],[6.000000e+00,8.600000e+01],[7.000000e+00,1.060000e+02],[8.000000e+00,1.260000e+02],[9.000000e+00,1.460000e+02],[1.000000e+01,1.660000e+02],[1.100000e+01,1.860000e+02]],points:{show:true,radius:5.500000e+00,symbol:'square'},label:'Label for (x3, y3)',color:'#0000ff',},{data:[[3.000000e+00,7.000000e+00],[4.000000e+00,1.700000e+01],[5.000000e+00,2.700000e+01],[6.000000e+00,3.700000e+01],[7.000000e+00,4.700000e+01],[8.000000e+00,5.700000e+01],[9.000000e+00,6.700000e+01],[1.000000e+01,7.700000e+01],[1.100000e+01,8.700000e+01],[1.200000e+01,9.700000e+01]],points:{show:true,radius:5.500000e+00,symbol:'diamond'},lines:{show:true,lineWidth:2},label:'Label for (x4, y4)',color:'#ff00ff',},{data:[[5.000000e+00,8.000000e+00],[6.000000e+00,1.800000e+01],[7.000000e+00,2.800000e+01],[8.000000e+00,3.800000e+01],[9.000000e+00,4.800000e+01],[1.000000e+01,5.800000e+01],[1.100000e+01,6.800000e+01],[1.200000e+01,7.800000e+01],[1.300000e+01,8.800000e+01],[1.400000e+01,9.800000e+01]],points:{show:true,radius:5.500000e+00,symbol:'plus'},lines:{show:true,lineWidth:2},label:'Label for (x5, y5)',color:'#00ffff',},{data:[[6.000000e+00,9.000000e+00],[7.000000e+00,1.900000e+01],[8.000000e+00,2.900000e+01],[9.000000e+00,3.900000e+01],[1.000000e+01,4.900000e+01],[1.100000e+01,5.900000e+01],[1.200000e+01,6.900000e+01],[1.300000e+01,7.900000e+01],[1.400000e+01,8.900000e+01],[1.500000e+01,9.900000e+01]],points:{show:true,radius:5.500000e+00,symbol:'cross'},bars:{show:true,barWidth:0.5,align:'center'},label:'Label for (x6, y6)',color:'#000000',},], 'ne', 2, null);
</script>
<hr />
<p><em>Thanks for reading, please try <code>fmtplot</code>.</em></p>
<hr />
</body>
</html>
